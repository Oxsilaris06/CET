<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Retour d'Expérience</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
        label { display: block; margin: 20px 0 5px 0; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        textarea { min-height: 100px; }
        button[type="submit"] { background-color: var(--accent-blue); color: white; padding: 15px; border: none; border-radius: 5px; cursor: pointer; width: 100%; font-size: 1.2em; font-weight: bold; margin-top: 20px; }
        button[type="submit"]:hover { background-color: var(--accent-hover); }
        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; text-decoration: none; }
        #statusMessage { margin-top: 20px; text-align: center; font-size: 1.1em; font-weight: bold; }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
    </div>

    <div class="container">
        <h1>Formulaire de Retour d'Expérience (RETEX)</h1>
        <form id="retexForm">
            <input type="hidden" id="oiId" name="Identifiant_Unique_de_l_OI">

            <label for="date_op">Date de l'opération</label>
            <input type="date" id="date_op" name="Date_de_l_operation" required>

            <label for="type_op">Type d'opération</label>
            <select id="type_op" name="Type_d_operation" required>
                <option value="" disabled selected>Sélectionner un type</option>
                <option value="Forcené">Forcené</option>
                <option value="Domiciliaire">Domiciliaire</option>
                <option value="Milieu ouvert">Milieu ouvert</option>
                <option value="MO">MO</option>
                <option value="Autre">Autre</option>
            </select>
            
            <label for="role">Votre Rôle</label>
            <select id="role" name="Votre_Role" required>
                <option value="" disabled selected>Sélectionner un rôle</option>
                <option value="Commandement">Commandement</option>
                <option value="India">India</option>
                <option value="Effrac">Effrac</option>
                <option value="Appui Observation">Appui Observation</option>
                <option value="GD">GD</option>
                <option value="Tenue civile">Tenue civile</option>
                <option value="Cyno">Cyno</option>
                <option value="Enqueteur">Enquêteur</option>
            </select>

            <label for="q1">1. Les objectifs de la mission étaient-ils clairs et compris par tous ?</label>
            <textarea id="q1" name="Objectifs_Clairs" required></textarea>

            <label for="q2">2. Quelle était la qualité et la précision du renseignement avant l'action ?</label>
            <textarea id="q2" name="Qualite_Renseignement" required></textarea>

            <label for="q3">3. La planification tactique était-elle adaptée à la situation ?</label>
            <textarea id="q3" name="Planification_Tactique_Adaptee" required></textarea>

            <label for="q4">4. Votre préparation individuelle était-elle suffisante ?</label>
            <textarea id="q4" name="Preparation_Individuelle_Suffisante" required></textarea>

            <label for="q5">5. L'équipement individuel et collectif était-il adapté et fonctionnel ?</label>
            <textarea id="q5" name="Equipement_Adapte" required></textarea>

            <label for="q6">6. Quels ont été les points forts de l'exécution de l'action ?</label>
            <textarea id="q6" name="Points_Forts_Execution" required></textarea>

            <label for="q7">7. Quels ont été les points faibles de l'exécution de l'action ?</label>
            <textarea id="q7" name="Points_Faibles_Execution" required></textarea>

            <label for="q8">8. Avez-vous rencontré des imprévus majeurs ? Comment l'équipe s'est-elle adaptée ?</label>
            <textarea id="q8" name="Imprevus_Majeurs" required></textarea>

            <label for="q9">9. Évaluez l'efficacité de la communication interne à l'équipe.</label>
            <textarea id="q9" name="Communication_Interne" required></textarea>

            <label for="q10">10. Évaluez l'efficacité de la communication externe (commandement, autres unités...).</label>
            <textarea id="q10" name="Communication_Externe" required></textarea>

            <label for="q11">11. L'usage de la force ou des moyens d'interpellation a-t-il été pertinent et efficace ?</label>
            <textarea id="q11" name="Usage_Force_Pertinent" required></textarea>

            <label for="q12">12. Comment la prise de décision tactique a-t-elle été gérée sur le terrain ?</label>
            <textarea id="q12" name="Prise_Decision_Tactique" required></textarea>

            <label for="q13">13. La gestion des risques et de la sécurité du personnel a-t-elle été suffisante ?</label>
            <textarea id="q13" name="Gestion_Risques_Securite" required></textarea>

            <label for="q14">14. Les objectifs initiaux de la mission ont-ils été atteints ?</label>
            <textarea id="q14" name="Objectifs_Atteints" required></textarea>

            <label for="q15">15. Quel bilan matériel et humain dressez-vous ?</label>
            <textarea id="q15" name="Bilan_Materiel_Humain" placeholder="Blessures, équipement endommagé, perdu..."></textarea>

            <label for="q16">16. Quelles recommandations concrètes proposez-vous pour améliorer nos futures opérations ?</label>
            <textarea id="q16" name="Recommandations_Concretes" placeholder="Formation, équipement, procédures, doctrine..." required></textarea>

            <button type="submit">Envoyer le Retour d'Expérience</button>
            <p id="statusMessage"></p>
        </form>
    </div>

    <script>
        // --- GESTION DU THÈME ET DU DOCK MENU ---
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.replace('dark-mode', 'light-mode');
            document.getElementById('darkModeIcon').textContent = 'clear_day';
        }

        // --- GESTION DU FORMULAIRE ---
        const form = document.getElementById('retexForm');
        const statusMessage = document.getElementById('statusMessage');
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyF0CJ_B9U4Izn6ieZG4lfIq23oScE6cFvd1SoUXvVUBRqk_Ce1R8TJpRRnuamcdJH-/exec"; 

        // Récupère l'ID de l'OI depuis l'URL et le place dans le champ caché
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const oiId = urlParams.get('oiId');
            if (oiId) {
                document.getElementById('oiId').value = oiId;
            } else {
                statusMessage.textContent = "ATTENTION : Identifiant d'opération manquant dans l'URL. Le rapport ne pourra pas être lié.";
                statusMessage.style.color = 'var(--danger-red)';
            }
        });

        form.addEventListener('submit', e => {
            e.preventDefault();
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            statusMessage.textContent = "Envoi en cours...";
            statusMessage.style.color = 'var(--text-secondary)';

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    statusMessage.textContent = "Retour d'expérience envoyé avec succès.";
                    statusMessage.style.color = '#27ae60';
                    form.reset();
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                statusMessage.textContent = "Erreur lors de la soumission : " + error.message;
                statusMessage.style.color = 'var(--danger-red)';
            })
            .finally(() => {
                submitButton.disabled = false;
                // Rétablit l'ID de l'OI dans le champ caché après un reset
                const urlParams = new URLSearchParams(window.location.search);
                document.getElementById('oiId').value = urlParams.get('oiId') || '';
            });
        });
    </script>
</body>
</html>
