<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire de Retour d'Expérience</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="icon" href="favicon.ico" sizes="any" type="image/png">
    <link rel="icon" href="favicon.ico" type="image/svg+xml">
    <link rel="apple-touch-icon" href="favicon.ico">
    <link rel="manifest" href="site.webmanifest">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. VARIABLES & THEME TACTICAL GLASS --- */
        :root {
            /* Couleurs de base (PC TAC) */
            --bg-body: #050505;
            --bg-glass: rgba(22, 22, 25, 0.7); 
            --bg-glass-heavy: rgba(15, 15, 20, 0.95);
            --bg-input: rgba(0, 0, 0, 0.4);
            --bg-element: rgba(255, 255, 255, 0.03); 
            --border-glass: rgba(255, 255, 255, 0.08);
            
            /* Typographie */
            --font-ui: 'Oswald', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
            --font-title: 'Saira Stencil One', cursive;

            /* Couleurs Interactives */
            --accent-blue: #3b82f6;
            --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --text-primary: #e0e0e0;
            --text-secondary: #94a3b8;
            
            /* Status */
            --danger-red: #ef4444; 
            --success-green: #22c55e;
            --trash-color: #64748b;

            /* Espacement */
            --radius-md: 12px;
            --radius-sm: 6px;
            
            /* Compatibilité RETEX */
            --bg-container: var(--bg-glass);
            --bg-interactive: var(--bg-input);
            --border-color: var(--border-glass);
        }

        body.light-mode {
            --bg-body: #f1f5f9;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --bg-glass-heavy: #ffffff;
            --bg-input: rgba(255, 255, 255, 0.6);
            --bg-element: rgba(0, 0, 0, 0.03);
            --border-glass: rgba(0, 0, 0, 0.1);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-blue: #0f4c9c;
            --border-color: var(--border-glass);
            --bg-container: var(--bg-glass);
            --bg-interactive: var(--bg-input);
            --trash-color: #64748b;
        }

        /* --- 2. RESET & LAYOUT GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        html { font-size: 16px; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--text-primary);
            /* Texture tactique (Grille) */
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            padding: 20px 10px 120px 10px; /* Padding bottom augmenté pour le dock */
            transition: background 0.3s ease;
            line-height: 1.6;
        }

        /* Conteneur principal Glassmorphism */
        .container {
            width: 100%; max-width: 900px; margin: auto;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-md);
            padding: 30px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        /* --- 3. TYPOGRAPHIE --- */
        h1 {
            font-family: var(--font-title);
            font-size: 2.2em;
            color: var(--accent-blue);
            text-align: center;
            text-shadow: 0 0 20px var(--accent-glow);
            letter-spacing: 2px;
            margin-bottom: 30px;
            font-weight: 400;
            text-transform: uppercase;
        }

        label { 
            display: block; 
            margin: 25px 0 8px 0; 
            font-weight: bold; 
            color: var(--accent-blue); /* Couleur accentuée pour les questions */
            font-size: 1.1em;
            letter-spacing: 0.5px;
        }

        /* --- 4. FORMULAIRES & INPUTS --- */
        input, textarea, select {
            width: 100%; background: var(--bg-input); 
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-sm); 
            padding: 12px; 
            color: var(--text-primary);
            font-family: var(--font-data); /* JetBrains Mono pour les données */
            font-size: 0.95rem; 
            transition: all 0.2s;
            margin-bottom: 10px;
        }
        
        textarea { min-height: 120px; line-height: 1.5; }
        
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-blue);
            background: rgba(0,0,0,0.6);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* --- 5. BOUTONS D'ACTION --- */
        .action-buttons {
            display: flex; gap: 15px; margin-top: 30px;
        }
        .action-buttons button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 1.1em;
            font-family: var(--font-ui);
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s;
            letter-spacing: 1px;
        }
        
        #downloadButton { 
            background-color: var(--success-green); 
            color: white; 
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }
        #downloadButton:hover { 
            background-color: #16a34a; 
            transform: translateY(-2px);
        }

        #statusMessage { 
            margin-top: 20px; 
            text-align: center; 
            font-size: 1em; 
            font-weight: bold; 
            font-family: var(--font-data);
            padding: 10px;
            border-radius: var(--radius-sm);
            background: var(--bg-element);
            border: 1px solid var(--border-glass);
        }

        /* --- 6. DOCK MENU (Style PC TAC Standardisé) --- */
        .dock-menu {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--bg-glass-heavy); backdrop-filter: blur(15px);
            border: 1px solid var(--border-glass); border-radius: 30px;
            padding: 8px 15px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 1000;
            transition: width 0.3s, padding 0.3s;
            max-width: 90vw; width: auto; overflow-x: auto; scrollbar-width: none;
        }
        .dock-menu::-webkit-scrollbar { display: none; }

        .dock-menu.collapsed { 
            width: 50px; height: 50px; padding: 0; justify-content: center; overflow: hidden; 
            border-radius: 50%; 
        }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { display: none; }
        
        .dock-menu-item {
            width: 42px; height: 42px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); text-decoration: none; cursor: pointer;
            transition: all 0.2s; background: transparent; border: none; box-shadow: none;
        }
        .dock-menu-item span, .dock-menu-item .material-icons { font-size: 24px; }
        .dock-menu-item:hover { color: var(--text-primary); background: rgba(255,255,255,0.1); transform: none; }
        
        #dockToggleBtn { color: var(--accent-blue); }
        #dockToggleBtn .material-icons { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-icons { transform: rotate(180deg); }

        /* --- RESPONSIVE --- */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8em; }
            .action-buttons { flex-direction: column; }
            .dock-menu:not(.collapsed) {
                width: 95%; padding: 5px; gap: 5px; justify-content: center; flex-wrap: wrap;
            }
            .dock-menu:not(.collapsed) .dock-menu-item { width: 45px; height: 45px; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="Réduire"><span class="material-icons">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire"><span class="material-icons">refresh</span></div>
    </div>

    <div class="container">
        <h1>Retour d'Expérience (RETEX)</h1>
        <form id="retexForm">
            <input type="hidden" id="oiId" name="Identifiant_Unique_de_l_OI">

            <label for="date_op">Date de l'opération</label>
            <input type="date" id="date_op" name="Date_de_l_operation">

            <label for="type_op">Type d'opération</label>
            <select id="type_op" name="Type_d_operation">
                <option value="" disabled selected>Sélectionner un type</option>
                <option value="Forcené">Forcené</option>
                <option value="Domiciliaire">Domiciliaire</option>
                <option value="Milieu ouvert">Milieu ouvert</option>
                <option value="MO">MO</option>
                <option value="Autre">Autre</option>
            </select>
            
            <label for="role">Votre Rôle</label>
            <select id="role" name="Votre_Role">
                <option value="" disabled selected>Sélectionner un rôle</option>
                <option value="Commandement">Commandement</option>
                <option value="India">India</option>
                <option value="Effrac">Effrac</option>
                <option value="Appui Observation">Appui Observation</option>
                <option value="GD">GD</option>
                <option value="Tenue civile">Tenue civile</option>
                <option value="Cyno">Cyno</option>
                <option value="Enqueteur">Enquêteur</option>
            </select>

            <label for="q1">1. Les objectifs de la mission étaient-ils clairs et compris par tous ?</label>
            <textarea id="q1" name="Objectifs_Clairs"></textarea>

            <label for="q2">2. Quelle était la qualité et la précision du renseignement avant l'action ?</label>
            <textarea id="q2" name="Qualite_Renseignement"></textarea>

            <label for="q3">3. La planification tactique était-elle adaptée à la situation ?</label>
            <textarea id="q3" name="Planification_Tactique_Adaptee"></textarea>

            <label for="q4">4. Votre préparation individuelle était-elle suffisante ?</label>
            <textarea id="q4" name="Preparation_Individuelle_Suffisante"></textarea>

            <label for="q5">5. L'équipement individuel et collectif était-il adapté et fonctionnel ?</label>
            <textarea id="q5" name="Equipement_Adapte"></textarea>

            <label for="q6">6. Quels ont été les points forts de l'exécution de l'action ?</label>
            <textarea id="q6" name="Points_Forts_Execution"></textarea>

            <label for="q7">7. Quels ont été les points faibles de l'exécution de l'action ?</label>
            <textarea id="q7" name="Points_Faibles_Execution"></textarea>

            <label for="q8">8. Avez-vous rencontré des imprévus majeurs ? Comment l'équipe s'est-elle adaptée ?</label>
            <textarea id="q8" name="Imprevus_Majeurs"></textarea>

            <label for="q9">9. Évaluez l'efficacité de la communication interne à l'équipe.</label>
            <textarea id="q9" name="Communication_Interne"></textarea>

            <label for="q10">10. Évaluez l'efficacité de la communication externe (commandement, autres unités...).</label>
            <textarea id="q10" name="Communication_Externe"></textarea>

            <label for="q11">11. L'usage de la force ou des moyens d'interpellation a-t-il été pertinent et efficace ?</label>
            <textarea id="q11" name="Usage_Force_Pertinent"></textarea>

            <label for="q12">12. Comment la prise de décision tactique a-t-elle été gérée sur le terrain ?</label>
            <textarea id="q12" name="Prise_Decision_Tactique"></textarea>

            <label for="q13">13. La gestion des risques et de la sécurité du personnel a-t-elle été suffisante ?</label>
            <textarea id="q13" name="Gestion_Risques_Securite"></textarea>

            <label for="q14">14. Les objectifs initiaux de la mission ont-ils été atteints ?</label>
            <textarea id="q14" name="Objectifs_Atteints"></textarea>

            <label for="q15">15. Quel bilan matériel et humain dressez-vous ?</label>
            <textarea id="q15" name="Bilan_Materiel_Humain" placeholder="Blessures, équipement endommagé, perdu..."></textarea>

            <label for="q16">16. Quelles recommandations concrètes proposez-vous pour améliorer nos futures opérations ?</label>
            <textarea id="q16" name="Recommandations_Concretes" placeholder="Formation, équipement, procédures, doctrine..."></textarea>

            <div class="action-buttons">
                 <button type="button" id="downloadButton"><span class="material-icons" style="vertical-align: bottom; margin-right: 5px;">file_download</span> Télécharger le JSON</button>
            </div>
            
            <p id="statusMessage"></p>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        const form = document.getElementById('retexForm');
        const statusMessage = document.getElementById('statusMessage');
        const downloadButton = document.getElementById('downloadButton');
        const oiIdField = document.getElementById('oiId');

        // --- GESTION DU THÈME ET DU DOCK MENU ---
        document.addEventListener('DOMContentLoaded', () => {
            // Thème
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('light-mode');
                    document.body.classList.toggle('dark-mode');
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                    document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
                });
            }
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.replace('dark-mode', 'light-mode');
                if (document.getElementById('darkModeIcon')) {
                    document.getElementById('darkModeIcon').textContent = 'clear_day';
                }
            }

            // Dock
            const dockMenu = document.getElementById('dockMenu');
            const dockToggleBtn = document.getElementById('dockToggleBtn');
            if (dockToggleBtn) {
                dockToggleBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    dockMenu.classList.toggle('collapsed');
                    localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
                });
            }
            if (localStorage.getItem('dockCollapsed') === 'true' && dockMenu) {
                dockMenu.classList.add('collapsed');
            }
            
            // Bouton Reset
            const resetBtn = document.getElementById('resetBtn');
            if(resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm("Voulez-vous vraiment réinitialiser le formulaire ?")) {
                        form.reset();
                        statusMessage.textContent = '';
                    }
                });
            }

            // Logique de chargement de l'oiId depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const oiId = urlParams.get('oiId');
            if (oiId) {
                oiIdField.value = oiId;
                statusMessage.textContent = "Identifiant d'opération détecté : " + oiId;
                statusMessage.style.color = 'var(--accent-blue)';
            } else {
                statusMessage.textContent = "ATTENTION : Aucun identifiant d'opération n'a été trouvé dans l'URL. Veuillez le renseigner manuellement si vous en avez un.";
                statusMessage.style.color = 'var(--danger-red)';
            }
        });

        // --- NOUVELLE FONCTIONNALITÉ : TÉLÉCHARGEMENT DU FICHIER JSON ---
        downloadButton.addEventListener('click', () => {
            const formData = {};
            const formElements = form.elements;
            for (let i = 0; i < formElements.length; i++) {
                const element = formElements[i];
                if (element.name) {
                    formData[element.name] = element.value;
                }
            }

            // Nettoyage des champs vides
            for (const key in formData) {
                if (formData[key] === '' || formData[key] === null) {
                    delete formData[key];
                }
            }

            const jsonString = JSON.stringify(formData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            // Nom de fichier par défaut basé sur l'oiId ou la date
            const fileName = (oiIdField.value ? `Retex_${oiIdField.value}` : `Retex_${new Date().toISOString().slice(0, 10)}`) + '.json';
            a.download = fileName;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            statusMessage.textContent = `Fichier "${fileName}" généré et téléchargé avec succès !`;
            statusMessage.style.color = 'var(--success-green)';
        });
    </script>
</body>
</html>
