<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurateur Équipement</title> <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Saira+Stencil+One&family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1E1E1E; --bg-interactive: #2A2A2A;
            --text-primary: #E0E0E0; --text-secondary: #95A5A6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; }
        .container { display: flex; flex-direction: column; max-width: 1400px; margin: auto; gap: 20px; }
        .main-content { flex: 3; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        .sidebar { flex: 1; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; }
        h1, h2 { font-family: 'Saira Stencil One', sans-serif; font-weight: 400; color: var(--accent-blue); text-transform: uppercase; }
        h1 { text-align: center; margin-bottom: 20px; font-size: 2.5em; }
        h2 { font-size: 1.5em; margin-top: 10px; margin-bottom: 15px; border-bottom: 2px solid var(--accent-blue); padding-bottom: 5px; }
        .presets { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .preset-btn { background-color: var(--bg-interactive); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
        .preset-btn:hover, .preset-btn.active { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .category { margin-bottom: 25px; }
        .item-list { display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        .item { background-color: var(--bg-interactive); padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: space-between; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .item-name { font-size: 1.2em; font-weight: 500; }
        .item-price { font-size: 1.1em; color: var(--accent-blue); }
        .item-note { font-size: 0.9em; color: var(--text-secondary); }
        .item-description { font-size: 0.9em; margin: 10px 0; color: var(--text-secondary); }
        .item-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .item-link { color: var(--accent-blue); text-decoration: none; font-size: 1.5em; }
        .item-toggle { display: flex; align-items: center; gap: 10px; }
        .item-toggle label { font-size: 1.1em; }
        .summary-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .summary-item-name { flex-grow: 1; }
        .summary-item-price { margin-left: 15px; }
        #total-price { font-size: 1.8em; text-align: right; margin-top: 20px; font-weight: 500; color: var(--accent-blue); }
        .dock-menu { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s; text-decoration: none; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-green); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1001; opacity: 0; transition: opacity 0.5s; }
        .notification.show { opacity: 1; }
        @media (max-width: 900px) {
            .container { flex-direction: column-reverse; }
            .sidebar { position: static; max-height: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1>Configurateur Équipement</h1>
            <div id="presets" class="presets"></div>
            <div id="categories"></div>
        </div>
        <aside class="sidebar">
            <h2>Récapitulatif</h2>
            <div id="summary"></div>
            <div id="total-price">Total: 0.00 €</div>
        </aside>
    </div>

    <div class="dock-menu">
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="share-btn" title="Partager la configuration"><span class="material-icons">share</span></div>
    </div>
    <div id="notification" class="notification">Lien copié dans le presse-papiers !</div>

    <script>
        let siteConfig;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('all.json');
                if (!response.ok) throw new Error('Network response was not ok.');
                siteConfig = await response.json();
                initializeApp();
            } catch (error) {
                document.body.innerHTML = `<div style="color: white; text-align: center; padding: 50px;"><h1>Erreur de Configuration</h1><p>Le fichier <code>all.json</code> est introuvable ou invalide. Veuillez configurer le site via la page <code>setup.html</code>.</p></div>`;
                console.error("Failed to load all.json:", error);
            }
        });

        function initializeApp() {
            // --- INJECTION DE LA CONFIGURATION ---
            document.title = `Configurateur | ${siteConfig.global?.pwaShortName || 'Config'}`;
            // Le h1 reste spécifique à la page
            
            const db = siteConfig.configurateurDatabase?.database;
            if (!db) {
                document.getElementById('categories').innerHTML = '<h2>Erreur: Base de données de matériel non trouvée dans all.json.</h2>';
                return;
            }
            const presets = siteConfig.configurateurDatabase?.presets || {};

            // --- LOGIQUE DE L'APPLICATION ---
            const categoriesContainer = document.getElementById('categories');
            const summaryContainer = document.getElementById('summary');
            const totalPriceEl = document.getElementById('total-price');
            const presetsContainer = document.getElementById('presets');
            const shareBtn = document.getElementById('share-btn');
            const notification = document.getElementById('notification');

            let selectedItems = {};

            function render() {
                categoriesContainer.innerHTML = '';
                for (const categoryKey in db) {
                    if (!db[categoryKey].length) continue;
                    const category = db[categoryKey];
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'category';
                    const categoryTitle = categoryKey.replace(/-/g, ' ').replace(/(^\w|\s\w)/g, m => m.toUpperCase());
                    categoryEl.innerHTML = `<h2>${categoryTitle}</h2>`;
                    const itemListEl = document.createElement('div');
                    itemListEl.className = 'item-list';

                    category.forEach(item => {
                        const isSelected = selectedItems[item.id];
                        const itemEl = document.createElement('div');
                        itemEl.className = 'item';
                        itemEl.innerHTML = `
                            <div class="item-header">
                                <span class="item-name">${item.name}</span>
                                <span class="item-price">${item.price.toFixed(2)} €</span>
                            </div>
                            ${item.note ? `<div class="item-note">Note: ${'⭐'.repeat(item.note)}</div>` : ''}
                            <div class="item-description">${item.description}</div>
                            <div class="item-actions">
                                <a href="${item.link}" target="_blank" class="item-link"><span class="material-icons">shopping_cart</span></a>
                                <div class="item-toggle">
                                    <label for="item-${item.id}">Ajouter</label>
                                    <input type="checkbox" id="item-${item.id}" data-id="${item.id}" ${isSelected ? 'checked' : ''}>
                                </div>
                            </div>
                        `;
                        itemListEl.appendChild(itemEl);
                    });

                    categoryEl.appendChild(itemListEl);
                    categoriesContainer.appendChild(categoryEl);
                }
                updateSummary();
            }

            function updateSummary() {
                summaryContainer.innerHTML = '';
                let total = 0;
                for (const categoryKey in db) {
                    db[categoryKey].forEach(item => {
                        if (selectedItems[item.id]) {
                            const summaryItemEl = document.createElement('div');
                            summaryItemEl.className = 'summary-item';
                            summaryItemEl.innerHTML = `<span class="summary-item-name">${item.name}</span> <span class="summary-item-price">${item.price.toFixed(2)} €</span>`;
                            summaryContainer.appendChild(summaryItemEl);
                            total += item.price;
                        }
                    });
                }
                totalPriceEl.textContent = `Total: ${total.toFixed(2)} €`;
            }
            
            function loadPreset(presetName) {
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                const preset = presets[presetName];
                if (!preset) return;
                
                document.querySelector(`.preset-btn[data-preset="${presetName}"]`).classList.add('active');
                
                selectedItems = {};
                for (const categoryKey in preset) {
                    const items = Array.isArray(preset[categoryKey]) ? preset[categoryKey] : [preset[categoryKey]];
                    items.forEach(itemId => {
                        selectedItems[itemId] = true;
                    });
                }
                render();
            }

            categoriesContainer.addEventListener('change', e => {
                if (e.target.type === 'checkbox') {
                    const itemId = e.target.dataset.id;
                    selectedItems[itemId] = e.target.checked;
                    document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                    updateSummary();
                }
            });
            
            for (const presetName in presets) {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = presetName.replace(/_/g, ' ');
                btn.dataset.preset = presetName;
                btn.addEventListener('click', () => loadPreset(presetName));
                presetsContainer.appendChild(btn);
            }

            shareBtn.addEventListener('click', () => {
                const ids = Object.keys(selectedItems).filter(id => selectedItems[id]).join(',');
                const url = new URL(window.location.href);
                url.searchParams.set('config', ids);
                navigator.clipboard.writeText(url.href).then(() => {
                    notification.classList.add('show');
                    setTimeout(() => notification.classList.remove('show'), 2000);
                });
            });

            function loadFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const configIds = urlParams.get('config');
                if (configIds) {
                    selectedItems = {};
                    configIds.split(',').forEach(id => {
                        if(id) selectedItems[id] = true;
                    });
                }
            }
            
            loadFromUrl();
            render();
        }
    </script>
</body>
</html>
