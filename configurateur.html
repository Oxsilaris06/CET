<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="favicon.ico" sizes="any" type="image/png">
    <link rel="icon" href="favicon.ico" type="image/svg+xml">
    <link rel="apple-touch-icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Configurateur Equipement Tactique</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Fonts mises √† jour -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Oswald:wght@300;400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME TACTICAL GLASS --- */
        :root {
            --bg-body: #050505;
            --bg-container: rgba(20, 20, 23, 0.85);
            --bg-glass: rgba(22, 22, 25, 0.7);
            --bg-interactive: rgba(255, 255, 255, 0.03);
            --bg-interactive-hover: rgba(255, 255, 255, 0.08);
            
            --text-primary: #e0e0e0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            --border-color: rgba(255, 255, 255, 0.08);
            --border-active: rgba(59, 130, 246, 0.5);

            --accent-blue: #3b82f6;
            --accent-hover: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.3);
            
            --danger-red: #ef4444;
            --success-green: #22c55e;
            --collective-accent: #eab308; /* Jaune tactique */
            
            --radius-md: 12px;
            --radius-sm: 6px;
            
            --font-ui: 'Oswald', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
            --font-title: 'Saira Stencil One', cursive;
        }

        body.light-mode {
            --bg-body: #f1f5f9;
            --bg-container: #ffffff;
            --bg-interactive: #f8f9fa;
            --bg-interactive-hover: #e9ecef;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-blue: #0f4c9c;
            --border-color: #cbd5e1;
            --text-muted: #94a3b8;
            --collective-accent: #d97706;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-ui); 
            background-color: var(--bg-body); 
            color: var(--text-primary); 
            line-height: 1.6; 
            padding: 15px; 
            /* Texture tactique */
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            min-height: 100vh;
            transition: background 0.3s ease;
            /* Padding gauche pour laisser place au dock lat√©ral sur PC */
            padding-left: 80px; 
        }

        .container { 
            max-width: 1400px; /* Plus large pour le configurateur */
            margin: auto; 
            background: var(--bg-container); 
            padding: 25px; 
            border-radius: var(--radius-md); 
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 { 
            text-align: center; 
            font-family: var(--font-title); 
            font-size: 2.5em; 
            margin-bottom: 30px; 
            color: var(--accent-blue); 
            text-transform: uppercase; 
            font-weight: 400; 
            text-shadow: 0 0 20px var(--accent-glow);
        }

        /* --- LAYOUT CONFIGURATEUR --- */
        .main-layout { display: flex; align-items: flex-start; gap: 30px; }
        .config-column { flex: 3; min-width: 0; } /* Colonne principale plus large */
        .sidebar-column { flex: 1; position: sticky; top: 20px; min-width: 300px; }
        
        .tab-content { 
            overflow-y: visible; 
            padding-right: 0; 
        }

        /* --- NAVIGATION TABS --- */
        .tab-nav { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 25px; 
            justify-content: center; border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }
        .tab-button { 
            padding: 10px 18px; cursor: pointer; 
            border: 1px solid var(--border-color); 
            background-color: var(--bg-interactive); 
            font-family: var(--font-ui); font-size: 1em; 
            color: var(--text-secondary); border-radius: var(--radius-sm); 
            transition: all 0.2s ease-in-out; 
            text-transform: uppercase; font-weight: 500; letter-spacing: 0.5px;
        }
        .tab-button:hover { 
            background-color: var(--bg-interactive-hover); 
            color: var(--text-primary); 
            border-color: var(--text-primary);
        }
        .tab-button.active { 
            color: white; 
            background-color: rgba(59, 130, 246, 0.15); 
            border-color: var(--accent-blue); 
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); 
        }
        
        .tab-panel { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PRESETS BUTTONS --- */
        .preset-buttons { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 25px; gap: 15px; }
        .preset-button { 
            flex-grow: 1; padding: 15px; 
            background-color: var(--bg-interactive); 
            color: var(--text-primary); 
            border: 1px solid var(--accent-blue); 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-family: var(--font-title); font-size: 1.1em; 
            min-width: 150px; 
            transition: all 0.2s;
        }
        .preset-button:hover { 
            background-color: var(--accent-blue); 
            color: white; 
            box-shadow: 0 0 20px var(--accent-glow);
        }

        /* --- SELECTORS & INPUTS --- */
        .item-selector-wrapper { margin-bottom: 20px; }
        .item-selector-display {
            display: flex; align-items: center; gap: 15px;
            background: var(--bg-interactive); padding: 15px;
            border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            margin-bottom: 10px; transition: border-color 0.2s;
        }
        .item-selector-display:hover { border-color: var(--text-secondary); }
        
        .selector-label { 
            flex-grow: 1; font-family: var(--font-ui); font-size: 1.1em; 
            color: var(--text-primary); font-weight: 500; 
        }
        
        select { 
            width: 100%; flex-basis: 60%; padding: 10px; 
            border: 1px solid var(--border-color); border-radius: var(--radius-sm); 
            font-size: 1em; font-family: var(--font-data); 
            background-color: var(--bg-body); color: var(--text-primary); 
            cursor: pointer; appearance: none; 
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 10px center; padding-right: 35px;
        }
        select:focus { border-color: var(--accent-blue); box-shadow: 0 0 10px var(--accent-glow); }

        .selector-image {
            width: 70px; height: 70px; object-fit: contain;
            border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            padding: 5px; background-color: var(--bg-body); flex-shrink: 0;
            cursor: zoom-in; transition: transform 0.2s;
        }
        .selector-image:hover { transform: scale(1.05); border-color: var(--accent-blue); }

        .description-box { 
            font-size: 0.9em; color: var(--text-secondary); 
            background-color: rgba(59, 130, 246, 0.05); 
            padding: 10px 15px; margin-top: 5px; 
            border-radius: var(--radius-sm); border-left: 3px solid var(--accent-blue); 
            display: none; font-family: var(--font-data);
        }

        /* --- TOGGLES GRID (Airsoft Style) --- */
        .toggles-container { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 15px; justify-items: stretch; 
        }
        .toggle-item {
            display: flex; flex-direction: column; align-items: center;
            background: var(--bg-interactive); padding: 15px;
            border: 1px solid var(--border-color); border-radius: var(--radius-sm);
            text-align: center; transition: all 0.2s;
        }
        .toggle-item:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        
        .item-image-wrapper {
            margin-bottom: 10px; width: 100%; height: 120px;
            display: flex; align-items: center; justify-content: center;
            background-color: var(--bg-body); border-radius: var(--radius-sm);
            border: 1px solid var(--border-color); overflow: hidden;
        }
        .item-thumbnail {
            max-width: 100%; max-height: 100%; object-fit: contain;
            transition: transform 0.3s;
        }
        .item-image-wrapper:hover .item-thumbnail { transform: scale(1.1); }

        .item-name { 
            color: var(--text-primary); font-family: var(--font-ui); font-size: 1em; margin-bottom: 10px; 
            line-height: 1.3; min-height: 2.6em; display: flex; align-items: center; justify-content: center;
        }
        .item-name a { color: inherit; text-decoration: none; border-bottom: 1px dotted var(--text-secondary); }
        .star-rating { color: var(--collective-accent); font-size: 0.8em; margin-left: 5px; }

        /* Custom Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { 
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: var(--bg-body); border: 1px solid var(--border-color); 
            transition: .4s; border-radius: 24px; 
        }
        .slider:before { 
            position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; 
            background-color: var(--text-secondary); transition: .4s; border-radius: 50%; 
        }
        input:checked + .slider { background-color: rgba(34, 197, 94, 0.2); border-color: var(--success-green); }
        input:checked + .slider:before { transform: translateX(20px); background-color: var(--success-green); }

        .info-button { 
            background: none; border: none; color: var(--accent-blue); 
            font-size: 1.1em; cursor: pointer; margin-left: 5px; 
        }

        /* --- CONTEXT CONTAINERS --- */
        .context-container { 
            background-color: rgba(255,255,255,0.02); 
            border: 1px dashed var(--border-color); 
            padding: 0; border-radius: var(--radius-sm); margin-top: 15px; 
        }
        .context-container-header { 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; 
            padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid transparent;
        }
        .context-container-header h3 { margin: 0; font-family: var(--font-title); font-size: 1.1em; color: var(--text-secondary); }
        .context-container-content { 
            display: none; padding: 15px; 
            border-top: 1px solid var(--border-color);
        }
        .context-container-content.visible { display: block; animation: fadeIn 0.3s; }

        /* --- SIDEBAR & RECAP --- */
        #recap, #share-container, #recap-collectif { 
            margin-bottom: 20px; padding: 20px; 
            background-color: var(--bg-interactive); 
            border-radius: var(--radius-md); 
            border: 1px solid var(--border-color);
            position: relative;
        }
        #recap { border-color: var(--accent-blue); box-shadow: 0 0 20px rgba(59, 130, 246, 0.05); }
        #recap-collectif { border-color: var(--collective-accent); }
        
        #recap h2, #share-container h3, #recap-collectif h3 { 
            text-align: center; margin-bottom: 15px; margin-top: 0;
            font-family: var(--font-title); font-weight: 400; font-size: 1.5em;
        }
        #recap h2 { color: var(--accent-blue); }
        #recap-collectif h3 { color: var(--collective-accent); }

        #selected-items-list, #collective-items-list { list-style-type: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        #selected-items-list li, #collective-items-list li { 
            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 12px; background-color: var(--bg-body); border-radius: var(--radius-sm); 
            border: 1px solid var(--border-color); font-size: 0.9em; font-family: var(--font-data);
        }
        .item-price { font-weight: bold; color: var(--text-primary); }
        
        .total-price { 
            font-size: 1.5em; font-weight: 700; text-align: right; 
            color: var(--accent-blue); margin-top: 15px; 
            padding-top: 15px; border-top: 1px dashed var(--border-color); font-family: var(--font-data);
        }
        .total-price.collective { color: var(--collective-accent); }

        #reset-btn, #reset-collective-btn { 
            display: block; width: 100%; padding: 12px; margin-top: 15px; 
            font-family: var(--font-ui); font-size: 1em; font-weight: 500; color: white; 
            border: none; border-radius: var(--radius-sm); cursor: pointer; text-transform: uppercase;
        }
        #reset-btn { background-color: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger-red); color: var(--danger-red); }
        #reset-btn:hover { background-color: rgba(239, 68, 68, 0.4); }
        #reset-collective-btn { background-color: rgba(234, 179, 8, 0.2); border: 1px solid var(--collective-accent); color: var(--collective-accent); }
        
        #share-url-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); background-color: var(--bg-body); color: var(--text-primary); border-radius: var(--radius-sm); margin: 10px 0; font-family: var(--font-data); font-size: 0.8em; }
        #copy-url-btn { width: 100%; padding: 10px; background-color: var(--accent-blue); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-family: var(--font-ui); text-transform: uppercase; }

        /* --- DOCK MENU (Lateral Fixed) --- */
        .dock-menu { 
            position: fixed; top: 50%; left: 20px; transform: translateY(-50%); 
            display: flex; flex-direction: column; gap: 15px; padding: 15px 10px; 
            background-color: rgba(15, 15, 20, 0.9); 
            border: 1px solid var(--border-color); border-radius: 30px; 
            backdrop-filter: blur(15px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .dock-menu-item { 
            display: flex; align-items: center; justify-content: center; 
            background-color: transparent; color: var(--text-muted); 
            border: 1px solid transparent; border-radius: 50%; 
            width: 45px; height: 45px; font-size: 24px; cursor: pointer; 
            transition: all 0.2s; text-decoration: none;
        }
        .dock-menu-item:hover { 
            color: var(--text-primary); background: rgba(255,255,255,0.1); transform: scale(1.1); 
        }
        
        /* Styles pour le mode "collapsed" du Dock */
        .dock-menu.collapsed { 
            padding: 15px 5px; /* R√©duit le padding horizontal */
        }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { 
            display: none; /* Cache tout sauf le bouton toggle */
        }
        #dockToggleBtn { color: var(--accent-blue); }

        /* --- MODALS & POPUPS --- */
        .item-description-popup { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 90%; max-width: 400px; background-color: var(--bg-container); 
            border: 1px solid var(--accent-blue); border-radius: var(--radius-md); 
            padding: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 3000; 
            display: none; text-align: left; font-family: var(--font-data); font-size: 0.9em;
            white-space: pre-wrap;
        }
        #lightbox-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.95); display: none;
            justify-content: center; align-items: center; z-index: 4000; cursor: zoom-out;
        }
        #lightbox-image { max-width: 95%; max-height: 95%; object-fit: contain; border: 2px solid var(--accent-blue); border-radius: var(--radius-sm); }

        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 3500; display: flex; justify-content: center; align-items: center; }
        .popup-content { background: var(--bg-container); padding: 30px; border-radius: var(--radius-md); border: 1px solid var(--accent-blue); max-width: 500px; text-align: center; }
        
        #main-footer { margin-top: 40px; text-align: center; color: var(--text-muted); font-size: 0.8em; opacity: 0.7; }

        /* --- RESPONSIVE --- */
        @media (max-width: 992px) { 
            .main-layout { flex-direction: column; } 
            .sidebar-column { position: static; width: 100%; margin-top: 20px; } 
            .config-column { width: 100%; }
            body { padding-left: 15px; padding-bottom: 80px; } /* Reset padding for dock */
            
            /* Dock Horizontal en bas sur Mobile */
            .dock-menu { 
                top: auto; bottom: 20px; left: 50%; transform: translateX(-50%);
                flex-direction: row; width: auto; padding: 10px 20px;
            }
            .dock-menu.collapsed {
                width: auto; padding: 10px;
            }
        }
        
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8em; }
            .toggles-container { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
            .item-selector-display { flex-wrap: wrap; }
            .selector-label { flex-basis: 100%; }
            select { flex-basis: 100%; }
            .selector-image { display: none; } /* Cache image selecteur sur petit √©cran pour gain place */
            
            /* R√©duction de 50% du bouton dock r√©duit sur mobile */
            .dock-menu.collapsed { padding: 5px; }
            .dock-menu.collapsed #dockToggleBtn {
                width: 24px;
                height: 24px;
            }
            .dock-menu.collapsed #dockToggleBtn .material-symbols-outlined {
                font-size: 18px; /* Icone r√©duite */
            }
        }
    </style>
</head>
<body>
    
    <!-- DOCK MENU -->
    <div class="dock-menu" id="dockMenu">
        <!-- Bouton Toggle ajout√© -->
        <div class="dock-menu-item" id="dockToggleBtn" title="R√©duire"><span class="material-symbols-outlined">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Mode Jour/Nuit"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" onclick="document.getElementById('recap').scrollIntoView({ behavior: 'smooth' });" title="Voir Panier"><span class="material-icons">shopping_cart</span></div>
    </div>

    <!-- POPUP INFO -->
    <div id="popup-container" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <div class="popup-header"><h2 style="color:var(--accent-blue); margin-top:0;">Bienvenue</h2></div>
            <p>Ce configurateur permet de simuler votre √©quipement tactique individuel et collectif.</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <div class="popup-checkbox" style="font-size:0.9em; color:var(--text-secondary);"><input type="checkbox" id="do-not-show-again"> <label for="do-not-show-again" style="display:inline;">Ne plus afficher</label></div>
                <button onclick="closePopup()" style="background:var(--accent-blue); color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Acc√©der</button>
            </div>
        </div>
    </div>
    
    <!-- LIGHTBOX -->
    <div id="lightbox-overlay" onclick="closeLightbox()">
        <img id="lightbox-image" src="" alt="Image zoom√©e">
    </div>

    <div class="container">
        <h1>Configurateur Equipement</h1>
        
        <div class="main-layout">
            <!-- COLONNE GAUCHE : CONFIGURATION -->
            <div class="config-column">
                <div class="tab-nav">
                    <button class="tab-button active" data-tab-target="#tab-presets">Presets üéöÔ∏è</button>
                    <button class="tab-button" data-tab-target="#tab-essentiels">Essentiels ‚öîÔ∏è</button>
                    <button class="tab-button" data-tab-target="#tab-lampes">Lampes üî¶</button>
                    <button class="tab-button" data-tab-target="#tab-vetements">V√™tements ü™ñ</button>
                    <button class="tab-button" data-tab-target="#tab-tete">T√™te üë§</button>
                    <button class="tab-button" data-tab-target="#tab-accessoires">Accessoires üñáÔ∏è</button>
                    <button class="tab-button" data-tab-target="#tab-psig">Kit PSIG ü•∑üèª</button>
                    <button class="tab-button" data-tab-target="#tab-nr">NR üá´üá∑</button>
                    <button class="tab-button" data-tab-target="#tab-civil">En Civil üö∂üèª</button>
                    <button class="tab-button" data-tab-target="#tab-eor">EOR üí•</button>
                    <button class="tab-button" data-tab-target="#tab-collectif" style="color:var(--collective-accent); border-color:var(--collective-accent);">Collectif ü§ôüèª</button>
                    <button class="tab-button" data-tab-target="#tab-patchs">Patchs ‚ô†Ô∏è</button>
                </div>
                
                <div class="tab-content">
                    <div id="tab-presets" class="tab-panel active">
                         <div class="preset-buttons">
                             <button class="preset-button" data-preset="psig">Config PSIG ü•∑üèª</button>
                             <button class="preset-button" data-preset="bt">Config BT üëÆüèª‚Äç‚ôÇÔ∏è</button>
                             <button class="preset-button" data-preset="premium">Config Premium üíé</button>
                             <button class="preset-button" data-preset="essentielle">Config Essentielle ‚úîÔ∏è</button>
                         </div>
                    </div>
                    
                    <div id="tab-essentiels" class="tab-panel">
                        <div id="systeme-ceinture-display" class="item-selector-display"><label for="systeme-ceinture" class="selector-label">Ceinturon</label><select id="systeme-ceinture"></select><img id="systeme-ceinture-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="systeme-ceinture-desc"></div></div>
                        
                        <div id="housse-gpb-display" class="item-selector-display"><label for="housse-gpb" class="selector-label">GPB / Chest Rig üõ°Ô∏è</label><select id="housse-gpb"></select><img id="housse-gpb-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="housse-gpb-desc"></div></div>

                        <div id="atr-options-container" class="context-container">
                            <div class="context-container-header"><h3>Options ATR GEN 2</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content"><div id="gpb-addons-toggles" class="toggles-container"></div></div>
                        </div>
                        <div id="mat-v1-options-container" class="context-container">
                            <div class="context-container-header"><h3>Options MAT V.1</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content"><div id="mat-v1-toggles" class="toggles-container"></div></div>
                        </div>
                        <div id="poches-container" class="context-container">
                            <div class="context-container-header"><h3>Ajouter des poches</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content"><div id="poches-toggles" class="toggles-container"></div></div>
                        </div>
                        <div id="panels-container" class="context-container">
                            <div class="context-container-header"><h3>Panneaux</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content">
                                <h4>Panneaux Avant</h4><div id="frontPanels-toggles" class="toggles-container"></div>
                                <h4 style="margin-top: 20px;">Panneaux Arri√®re</h4><div id="backPanels-toggles" class="toggles-container"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-lampes" class="tab-panel"><div id="lampes-toggles" class="toggles-container"></div></div>
                    
                    <div id="tab-vetements" class="tab-panel">
                        <div id="haut-display" class="item-selector-display"><label for="haut" class="selector-label">Haut üëï</label><select id="haut"></select><img id="haut-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="haut-desc"></div></div>
                        
                        <div id="bas-display" class="item-selector-display"><label for="bas" class="selector-label">Bas üëñ</label><select id="bas"></select><img id="bas-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="bas-desc"></div></div>

                        <div id="utp-protection-container" class="item-selector-wrapper">
                            <div id="protection-bas-display" class="item-selector-display"><label for="protection-bas" class="selector-label">Protection üõ°Ô∏è (Optionnel)</label><select id="protection-bas"></select><img id="protection-bas-img" class="selector-image"></div>
                            <div class="item-selector-wrapper"><div class="description-box" id="protection-bas-desc"></div></div>
                        </div>

                        <div id="chaussures-display" class="item-selector-display"><label for="chaussures" class="selector-label">Chaussures ü•æ</label><select id="chaussures"></select><img id="chaussures-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="chaussures-desc"></div></div>
                    </div>
                    
                    <div id="tab-tete" class="tab-panel">
                         <div id="casque-display" class="item-selector-display"><label for="casque" class="selector-label">Casque üõ°Ô∏è</label><select id="casque"></select><img id="casque-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="casque-desc"></div></div>
                         
                        <div id="headset-display" class="item-selector-display"><label for="headset" class="selector-label">Communication üì°</label><select id="headset"></select><img id="headset-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="headset-desc"></div></div>

                        <div id="gants-display" class="item-selector-display"><label for="gants" class="selector-label">Gants üß§</label><select id="gants"></select><img id="gants-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="gants-desc"></div></div>

                        <div id="lunettes-display" class="item-selector-display"><label for="lunettes" class="selector-label">Lunettes üï∂Ô∏è</label><select id="lunettes"></select><img id="lunettes-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="lunettes-desc"></div></div>
                    </div>
                    
                    <div id="tab-accessoires" class="tab-panel"><div id="accessoires-toggles" class="toggles-container"></div></div>
                    
                    <div id="tab-psig" class="tab-panel">
                         <div id="lampeArme-display" class="item-selector-display"><label for="lampeArme" class="selector-label">Lampe d'Arme üî¶</label><select id="lampeArme"></select><img id="lampeArme-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="lampeArme-desc"></div></div>
                         
                        <div id="sangle-display" class="item-selector-display"><label for="sangle" class="selector-label">Sangle üî´</label><select id="sangle"></select><img id="sangle-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="sangle-desc"></div></div>

                         <div id="psig-toggles" class="toggles-container" style="margin-top:20px;"></div>
                    </div>
                    
                    <div id="tab-nr" class="tab-panel"><div id="garantie-vie-toggles" class="toggles-container"></div></div>
                    <div id="tab-civil" class="tab-panel"><div id="en-civil-toggles" class="toggles-container"></div></div>
                    
                    <div id="tab-eor" class="tab-panel">
                        <h4>Reco üî≠</h4>
                        <div id="telemetre-display" class="item-selector-display"><label for="telemetre" class="selector-label">T√©l√©m√®tre</label><select id="telemetre"></select><img id="telemetre-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="telemetre-desc"></div></div>

                        <div id="drone-4k-display" class="item-selector-display"><label for="drone-4k" class="selector-label">Pack DJI Mini 4K</label><select id="drone-4k"></select><img id="drone-4k-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="drone-4k-desc"></div></div>

                        <div id="drone-4k-container" class="context-container">
                            <div class="context-container-header"><h3>Options Drone</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content"><div id="drone-4k-toggles" class="toggles-container"></div></div>
                        </div>
                        <h4 style="margin-top: 20px;">Marquage ‚ùå</h4>
                        <div id="marquage-toggles" class="toggles-container"></div>
                    </div>
                    
                    <div id="tab-collectif" class="tab-panel">
                        <h4>V√©hicule üöì</h4>
                        <div id="dossier-vl-display" class="item-selector-display"><label for="dossier-vl" class="selector-label">Dossier VL</label><select id="dossier-vl" data-collective="true"></select><img id="dossier-vl-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="dossier-vl-desc"></div></div>

                        <div id="dossier-vl-container" class="context-container">
                            <div class="context-container-header"><h3>Options Dossier VL</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content"><div id="dossier-vl-toggles" class="toggles-container"></div></div>
                        </div>
                        <h4 style="margin-top: 20px;">√âquipement collectif ü§ù</h4>
                        <div id="lot-front-panel-display" class="item-selector-display"><label for="lot-front-panel" class="selector-label">Lot Front Panel</label><select id="lot-front-panel" data-collective="true"></select><img id="lot-front-panel-img" class="selector-image"></div>
                        <div class="item-selector-wrapper"><div class="description-box" id="lot-front-panel-desc"></div></div>

                        <div id="lot-front-panel-container" class="context-container">
                            <div class="context-container-header"><h3>Options Lot Front Panel</h3><span class="toggle-arrow">‚ñº</span></div>
                            <div class="context-container-content"><div id="lot-front-panel-toggles" class="toggles-container"></div></div>
                        </div>
                    </div>
                    
                    <div id="tab-patchs" class="tab-panel"><div id="patchs-toggles" class="toggles-container"></div></div>
                </div>
            </div>
            
            <!-- COLONNE DROITE : RECAP -->
            <div class="sidebar-column">
                <div id="recap">
                    <h2>Panier Individuel</h2> 
                    <ul id="selected-items-list"><li>S√©lectionnez des √©l√©ments...</li></ul>
                    <div class="total-price">Total : <span id="total-price">0.00 ‚Ç¨</span></div>
                    <button id="reset-btn">R√©initialiser</button>
                </div>
                <div id="recap-collectif">
                    <h3>Panier Collectif ü§ù</h3>
                    <ul id="collective-items-list"><li>Aucun article collectif.</li></ul>
                    <div class="total-price collective">Total Collectif : <span id="collective-total-price">0.00 ‚Ç¨</span></div>
                    <button id="reset-collective-btn">R√©initialiser</button>
                </div>
                <div id="share-container">
                    <h3>Partager üîó</h3>
                    <input type="text" id="share-url-input" readonly onclick="this.select()">
                    <button id="copy-url-btn">Copier le lien</button>
                    <div id="copy-notification"></div>
                </div>
            </div>
        </div>
        
        <footer id="main-footer">¬© G/ Maheux ‚Ä¢ v5.0 Tactical</footer>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        let siteConfig;

        try {
            const response = await fetch('all.json');
            if (!response.ok) throw new Error('Network response was not ok.');
            siteConfig = await response.json();
            
            // --- THEME & DOCK LOGIC ---
            const body = document.body;
            const toggleButton = document.getElementById('darkModeToggle');
            const toggleIcon = document.getElementById('darkModeIcon');
            
            function setInitialTheme() {
                const savedTheme = localStorage.getItem('themeCheck');
                const isDark = savedTheme !== 'light';
                body.classList.toggle('dark-mode', isDark);
                body.classList.toggle('light-mode', !isDark);
                toggleIcon.textContent = isDark ? 'nightlight' : 'clear_day';
            }
            
            function toggleDarkMode() {
                const isLight = body.classList.toggle('light-mode');
                body.classList.toggle('dark-mode', !isLight);
                localStorage.setItem('themeCheck', isLight ? 'light' : 'dark');
                toggleIcon.textContent = isLight ? 'clear_day' : 'nightlight';
            }
            
            toggleButton.addEventListener('click', toggleDarkMode);
            setInitialTheme();

            const popupContainer = document.getElementById('popup-container');
            const doNotShowAgainCheckbox = document.getElementById('do-not-show-again');
            const showPopup = localStorage.getItem('showPopupConfigurator');

            if (showPopup !== 'false') {
                popupContainer.style.display = 'flex';
            }

            window.closePopup = function() {
                popupContainer.style.display = 'none';
                if (doNotShowAgainCheckbox.checked) {
                    localStorage.setItem('showPopupConfigurator', 'false');
                }
            }
            
            // --- DOCK COLLAPSE LOGIC ---
            const dockMenu = document.getElementById('dockMenu');
            const dockToggleBtn = document.getElementById('dockToggleBtn');
            const dockToggleIcon = dockToggleBtn.querySelector('.material-symbols-outlined');

            function updateDockState() {
                const isCollapsed = dockMenu.classList.contains('collapsed');
                dockToggleIcon.textContent = isCollapsed ? 'expand_less' : 'expand_more';
                // Rotation visuelle optionnelle en plus du changement d'ic√¥ne si souhait√© par CSS
            }

            if (localStorage.getItem('dockCollapsed') === 'true') {
                dockMenu.classList.add('collapsed');
            }
            updateDockState(); // Set initial icon

            dockToggleBtn.addEventListener('click', e => {
                e.stopPropagation();
                dockMenu.classList.toggle('collapsed');
                localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
                updateDockState();
            });

            // Fermer le dock si on clique ailleurs (uniquement sur mobile si besoin, ou d√©sactiv√© pour mode PC fixe)
            // Pour ce configurateur complexe, on garde le dock fixe ouvert/ferm√© par l'utilisateur.

            
            // --- LIGHTBOX LOGIC ---
            const lightboxOverlay = document.getElementById('lightbox-overlay');
            const lightboxImage = document.getElementById('lightbox-image');

            window.openLightbox = function(src) {
                lightboxImage.src = src;
                lightboxOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            window.closeLightbox = function() {
                lightboxOverlay.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            
            lightboxImage.addEventListener('click', function(e) {
                e.stopPropagation();
            });

            initializeApp(siteConfig);

        } catch (error) {
            document.body.innerHTML = `<div style="color: white; text-align: center; padding: 50px;"><h1>Erreur</h1><p>Impossible de charger la configuration (all.json).</p></div>`;
            console.error("Failed to load all.json:", error);
        }
    });

    function initializeApp(configData) {
        const database = configData.configurateurDatabase?.database;
        const presets = configData.configurateurDatabase?.presets;
        
        if (!database || !presets) return;

        let popup = null;
        
        function isDirectImage(url) {
            return url && !url.includes('google.com/imgres');
        }

        function updateSelectorImage(selectId) {
            const s = document.getElementById(selectId);
            const imgElement = document.getElementById(`${selectId}-img`);
            if (!s || !imgElement) return;

            const selectedItem = database[selectId]?.find(item => item.id === parseInt(s.value));
            const imageUrl = selectedItem?.imageUrl;
            
            if (isDirectImage(imageUrl)) {
                imgElement.src = imageUrl;
                imgElement.style.display = 'block';
                imgElement.onclick = () => openLightbox(imageUrl);
            } else {
                imgElement.style.display = 'none';
            }
        }

        function populateSelectors() {
            const visualSelectIds = ['systeme-ceinture', 'housse-gpb', 'haut', 'bas', 'protection-bas', 'chaussures', 'casque', 'headset', 'gants', 'lunettes', 'lampeArme', 'sangle', 'telemetre', 'drone-4k', 'dossier-vl', 'lot-front-panel'];

            visualSelectIds.forEach(selectId => {
                const s = document.getElementById(selectId);
                if (!s) return;
                
                const categoryItems = database[s.id] || [];
                s.innerHTML = '';
                
                const aucunItem = categoryItems.find(item => item.id === 0);
                if (aucunItem) {
                    const o = document.createElement('option');
                    o.value = '0';
                    o.textContent = aucunItem.name;
                    s.appendChild(o);
                }
                
                categoryItems.filter(item => item.id !== 0).forEach(item => {
                    const o = document.createElement('option');
                    o.value = item.id;
                    o.textContent = item.name + (item.note ? `  ${'‚òÖ'.repeat(item.note)}` : '');
                    s.appendChild(o);
                });
                
                updateSelectorImage(selectId);
                s.addEventListener('change', () => updateSelectorImage(selectId));
                
                if (s.id in database && database[s.id].some(item => item.collective)) {
                    s.setAttribute('data-collective', 'true');
                } else {
                    s.removeAttribute('data-collective');
                }
            });
        }

        function createToggles(cat, contId) {
            const cont = document.getElementById(contId);
            if (!cont) return;
            cont.innerHTML = '';
            const itemsToCreate = database[cat]?.filter(item => item.id !== 0) || [];
            
            itemsToCreate.forEach(item => {
                const div = document.createElement('div');
                div.className = 'toggle-item';
                div.dataset.category = cat;
                if (item.collective) { div.dataset.collective = 'true'; }
                
                if (isDirectImage(item.imageUrl)) {
                    const imgWrapper = document.createElement('a');
                    imgWrapper.className = 'item-image-wrapper';
                    const thumbnail = document.createElement('img');
                    thumbnail.className = 'item-thumbnail';
                    thumbnail.src = item.imageUrl;
                    thumbnail.onclick = (e) => { e.preventDefault(); openLightbox(item.imageUrl); };
                    imgWrapper.appendChild(thumbnail);
                    div.appendChild(imgWrapper);
                }

                const nameContainer = document.createElement('div');
                nameContainer.className = 'item-name';
                
                const nameLink = document.createElement('span');
                nameLink.textContent = item.name;
                if (item.link && item.link !== '#') {
                    const a = document.createElement('a');
                    a.href = item.link;
                    a.target = '_blank';
                    a.textContent = item.name;
                    nameLink.innerHTML = '';
                    nameLink.appendChild(a);
                }

                nameContainer.appendChild(nameLink);
                
                if (item.note) {
                    const star = document.createElement('span');
                    star.className = 'star-rating';
                    star.textContent = '‚òÖ'.repeat(item.note);
                    nameContainer.appendChild(star);
                }

                if (item.description) {
                    const info = document.createElement('button');
                    info.className = 'info-button';
                    info.textContent = '‚ìò';
                    info.onclick = (e) => {
                        e.stopPropagation();
                        showDescription(item.description);
                    };
                    nameContainer.appendChild(info);
                }
                
                const toggleWrapper = document.createElement('div');
                toggleWrapper.style.display = 'flex';
                toggleWrapper.style.alignItems = 'center';
                toggleWrapper.style.gap = '10px';

                const toggle = document.createElement('label');
                toggle.className = 'toggle-switch';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = `${cat}-${item.id}`;
                cb.value = item.id;
                const slider = document.createElement('span');
                slider.className = 'slider';
                
                toggle.appendChild(cb);
                toggle.appendChild(slider);
                toggleWrapper.appendChild(toggle);

                div.appendChild(nameContainer);
                div.appendChild(toggleWrapper);
                cont.appendChild(div);
            });
        }

        function showDescription(description) {
            if (popup) popup.remove();
            if (!description) return;
            popup = document.createElement('div');
            popup.className = 'item-description-popup';
            popup.textContent = description;
            document.body.appendChild(popup);
            popup.style.display = 'block';
        }

        function updateRecap() {
            let totalPrice = 0;
            let collectivePrice = 0;
            const list = document.getElementById('selected-items-list');
            const collectiveList = document.getElementById('collective-items-list');
            list.innerHTML = '';
            collectiveList.innerHTML = '';
            const allSelected = [];
            const allCollectiveSelected = [];
            
            document.querySelectorAll('select').forEach(s => {
                const id = parseInt(s.value);
                if (!isNaN(id) && id !== 0) {
                    const item = database[s.id]?.find(i => i.id === id);
                    if (item) {
                        if (item.collective) { allCollectiveSelected.push(item); } else { allSelected.push(item); }
                    }
                }
            });
            
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const parent = cb.closest('.toggle-item');
                if (parent) {
                    const cat = parent.dataset.category;
                    const isCollective = parent.dataset.collective === 'true';
                    const id = parseInt(cb.value);
                    const item = database[cat]?.find(i => i.id === id);
                    if (item) {
                        if (isCollective) { allCollectiveSelected.push(item); } else { allSelected.push(item); }
                    }
                }
            });
            
            if (allSelected.length === 0) list.innerHTML = '<li>S√©lectionnez des √©l√©ments...</li>';
            else {
                allSelected.forEach(item => {
                    totalPrice += item.price;
                    const li = document.createElement('li');
                    const link = (item.link && item.link !== '#') ? `<a href="${item.link}" target="_blank">${item.name}</a>` : item.name;
                    li.innerHTML = `<span>${link}</span> <span class="item-price">${item.price.toFixed(2)} ‚Ç¨</span>`;
                    list.appendChild(li);
                });
            }
            
            document.getElementById('total-price').textContent = `${totalPrice.toFixed(2)} ‚Ç¨`;
            
            if (allCollectiveSelected.length === 0) collectiveList.innerHTML = '<li>Aucun article collectif.</li>';
            else {
                allCollectiveSelected.forEach(item => {
                    collectivePrice += item.price;
                    const li = document.createElement('li');
                    const link = (item.link && item.link !== '#') ? `<a href="${item.link}" target="_blank">${item.name}</a>` : item.name;
                    li.innerHTML = `<span>${link}</span> <span class="item-price">${item.price.toFixed(2)} ‚Ç¨</span>`;
                    collectiveList.appendChild(li);
                });
            }
            document.getElementById('collective-total-price').textContent = `${collectivePrice.toFixed(2)} ‚Ç¨`;
        }

        function handleContextualChanges() {
            const gpbVal = parseInt(document.getElementById('housse-gpb').value);
            const isPlateCarrier = [1, 2, 3, 5].includes(gpbVal);
            const isCeinture = parseInt(document.getElementById('systeme-ceinture').value) > 0;
            const basVal = parseInt(document.getElementById('bas').value);
            const droneVal = parseInt(document.getElementById('drone-4k').value);
            const lotFpVal = parseInt(document.getElementById('lot-front-panel').value);
            const dossierVlVal = parseInt(document.getElementById('dossier-vl').value);
            
            document.getElementById('atr-options-container').style.display = (gpbVal === 5) ? 'block' : 'none';
            document.getElementById('mat-v1-options-container').style.display = (gpbVal === 1) ? 'block' : 'none';
            document.getElementById('poches-container').style.display = (isPlateCarrier || isCeinture) ? 'block' : 'none';
            document.getElementById('panels-container').style.display = isPlateCarrier ? 'block' : 'none';
            document.getElementById('utp-protection-container').style.display = basVal === 1 ? 'block' : 'none';
            document.getElementById('drone-4k-container').style.display = droneVal === 7002 ? 'block' : 'none';
            document.getElementById('lot-front-panel-container').style.display = lotFpVal === 9001 ? 'block' : 'none';
            document.getElementById('dossier-vl-container').style.display = dossierVlVal !== 0 ? 'block' : 'none';

            document.querySelectorAll('select').forEach(selector => {
                const descBox = document.getElementById(`${selector.id}-desc`);
                if (descBox) {
                    const selectedItem = database[selector.id]?.find(item => item.id === parseInt(selector.value));
                    const desc = selectedItem?.description;
                    descBox.textContent = desc || '';
                    descBox.style.display = desc ? 'block' : 'none';
                }
            });
        }

        function updateUrlParameters() {
            const params = new URLSearchParams();
            document.querySelectorAll('select').forEach(s => {
                const item = database[s.id]?.find(i => i.id === parseInt(s.value));
                if (s.value !== '0' && s.value && !item?.collective) {
                    params.set(s.id, s.value);
                }
            });
            const checkedToggles = {};
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const parent = cb.closest('.toggle-item');
                const cat = parent?.dataset.category;
                const isCollective = parent?.dataset.collective === 'true';
                if (cat && !isCollective) {
                    if (!checkedToggles[cat]) checkedToggles[cat] = [];
                    checkedToggles[cat].push(cb.value);
                }
            });
            for (const cat in checkedToggles) {
                params.set(cat, checkedToggles[cat].join(','));
            }
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.replaceState({}, '', newUrl);
            document.getElementById('share-url-input').value = window.location.href;
        }

        function applyUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            params.forEach((value, key) => {
                const el = document.getElementById(key);
                if (el && el.tagName === 'SELECT') {
                    el.value = value;
                } else {
                    const ids = value.split(',');
                    ids.forEach(id => {
                        const cb = document.getElementById(`${key}-${id}`);
                        if (cb) cb.checked = true;
                    });
                }
            });
        }

        function triggerAllChanges() { 
            handleContextualChanges(); 
            updateRecap(); 
            updateUrlParameters(); 
            ['systeme-ceinture', 'housse-gpb', 'haut', 'bas', 'protection-bas', 'chaussures', 'casque', 'headset', 'gants', 'lunettes', 'lampeArme', 'sangle', 'telemetre', 'drone-4k', 'dossier-vl', 'lot-front-panel'].forEach(updateSelectorImage);
        }
        
        function resetAll() { 
            const url = new URL(window.location); 
            url.search = ''; 
            window.history.replaceState({}, '', url); 
            document.querySelectorAll('select:not([data-collective="true"])').forEach(s => s.selectedIndex = 0); 
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const parent = cb.closest('.toggle-item');
                if (!parent || parent.dataset.collective !== 'true') { cb.checked = false; }
            });
            triggerAllChanges(); 
        }

        function resetCollective() {
            document.querySelectorAll('select[data-collective="true"]').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const parent = cb.closest('.toggle-item');
                if (parent && parent.dataset.collective === 'true') { cb.checked = false; }
            });
            triggerAllChanges();
        }

        function setupTabs() {
            const buttons = document.querySelectorAll('.tab-button'); 
            const panels = document.querySelectorAll('.tab-panel');
            buttons.forEach(button => { 
                button.addEventListener('click', () => { 
                    const targetId = button.dataset.tabTarget; 
                    buttons.forEach(b => b.classList.remove('active')); 
                    button.classList.add('active'); 
                    panels.forEach(p => p.classList.toggle('active', '#' + p.id === targetId)); 
                    
                    if (window.innerWidth <= 600) {
                        document.querySelector('.tab-content').scrollIntoView({ behavior: 'smooth' });
                    }
                }); 
            });
        }

        function applyPreset(name) {
            resetAll(); 
            const config = presets[name]; 
            if (!config) return;
            for (const cat in config) { 
                const val = config[cat]; 
                const el = document.getElementById(cat); 
                if (el) { el.value = val; } 
                else if (Array.isArray(val)) { 
                    val.forEach(id => { 
                        const cb = document.getElementById(`${cat}-${id}`); 
                        if (cb) cb.checked = true; 
                    }); 
                } 
            }
            triggerAllChanges();
        }
        
        function setupCollapsibleContainers() {
            document.querySelectorAll('.context-container-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const arrow = header.querySelector('.toggle-arrow');
                    const isVisible = content.classList.contains('visible');
                    content.classList.toggle('visible', !isVisible);
                    arrow.textContent = isVisible ? '‚ñº' : '‚ñ≤';
                });
            });
        }
        
        const toggleConfigs = {
            'gpb-addons':'gpb-addons-toggles', 'mat-v1-toggles':'mat-v1-toggles', 'poches':'poches-toggles', 'accessoires':'accessoires-toggles', 
            'frontPanels':'frontPanels-toggles', 'backPanels':'backPanels-toggles', 'psig-toggles':'psig-toggles', 
            'garantie-vie':'garantie-vie-toggles', 'patchs':'patchs-toggles', 'lampes':'lampes-toggles', 
            'en-civil':'en-civil-toggles', 'etuiTenue':'psig-toggles', 'effraction':'psig-toggles',
            'drone-4k-toggles':'drone-4k-toggles', 'marquage-toggles':'marquage-toggles',
            'dossier-vl-toggles': 'dossier-vl-toggles', 'lot-front-panel-toggles': 'lot-front-panel-toggles'
        };
        
        populateSelectors();
        
        for(const [cat, id] of Object.entries(toggleConfigs)) { 
            createToggles(cat, id); 
        }

        setupTabs();
        applyUrlParameters();
        triggerAllChanges();
        setupCollapsibleContainers();
        
        document.querySelector('.config-column').addEventListener('change', e => {
            const target = e.target;
            if (target.type === 'checkbox' && target.checked) {
                const parentContainer = target.closest('.toggles-container');
                if (!parentContainer) return;
                const parentId = parentContainer.id;
                const currentId = parseInt(target.value);
                const zipMolleId = 601;
                if (parentId === 'backPanels-toggles' && currentId !== zipMolleId) { 
                    parentContainer.querySelectorAll('input').forEach(other => { 
                        if (other !== target && parseInt(other.value) !== zipMolleId) other.checked = false; 
                    }); 
                }
            }
            triggerAllChanges();
        });
        
        document.getElementById('reset-btn').addEventListener('click', resetAll);
        document.getElementById('reset-collective-btn').addEventListener('click', resetCollective);
        document.querySelectorAll('.preset-button').forEach(b => b.addEventListener('click', e => applyPreset(e.target.dataset.preset)));
        
        document.getElementById('copy-url-btn').addEventListener('click', () => {
            const input = document.getElementById('share-url-input');
            input.select();
            input.setSelectionRange(0, 99999); 
            document.execCommand("copy"); // Fallback for iframe restrictions
            const notif = document.getElementById('copy-notification');
            notif.textContent = 'Copi√© !';
            setTimeout(() => { notif.textContent = ''; }, 2000);
        });
        
        window.addEventListener('click', (e) => { 
            if (popup && !popup.contains(e.target) && !e.target.classList.contains('info-button')) { 
                popup.remove(); 
                popup = null; 
            } 
        });
    }
</script>
</body>
</html>
