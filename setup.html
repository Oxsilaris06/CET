<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant de Configuration E-PSIG V5 (Fiable)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b; --success-green: #27ae60;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --accent-hover: #0044b3; --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; }
        .container { max-width: 900px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { text-align: center; font-family: 'Saira Stencil One', sans-serif; font-size: 2.2em; margin-bottom: 20px; color: var(--accent-blue); text-transform: uppercase; font-weight: normal; }
        
        /* --- Step & Navigation --- */
        .step { display: none; }
        .step.active { display: block; }
        .navigation-buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        .navigation-buttons button { padding: 10px 20px; font-family: 'Saira Stencil One', sans-serif; font-size: 1.1em; color: white; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase; transition: background-color 0.2s; }
        #prevBtn { background-color: var(--text-secondary); }
        #nextBtn { background-color: var(--accent-blue); }
        
        /* --- Form Elements --- */
        .step-title { margin-bottom: 20px; color: var(--accent-blue); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 4px;
            font-size: 1rem; background-color: var(--bg-body); color: var(--text-primary); font-family: 'Oswald', sans-serif;
            transition: border-color 0.2s;
        }
        .form-group .help-text { font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; }
        
        /* --- Validation Feedback --- */
        .form-group.is-invalid input, .form-group.is-invalid textarea { border-color: var(--danger-red); }
        .invalid-feedback { color: var(--danger-red); font-size: 0.8em; margin-top: 5px; display: none; }
        .form-group.is-invalid .invalid-feedback { display: block; }

        /* --- Help Box & Action Buttons --- */
        .help-box { background-color: var(--bg-interactive); border-left: 4px solid var(--accent-blue); padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .action-button { display: block; width: 100%; padding: 12px; font-family: 'Saira Stencil One', sans-serif; font-size: 1.1em; color: white; border: none; border-radius: 4px; cursor: pointer; text-align: center; transition: background-color 0.2s; background-color: var(--accent-blue); text-decoration: none; }
        .action-button.success { background-color: var(--success-green); }
        
        /* --- PWA Progress Indicator --- */
        #progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .step-indicator { flex-grow: 1; text-align: center; padding: 10px 0; font-size: 0.9em; color: var(--text-secondary); position: relative; cursor: pointer; }
        .step-indicator::before { content: attr(data-step); display: block; width: 30px; height: 30px; line-height: 30px; border-radius: 50%; margin: 0 auto 5px; background-color: var(--bg-interactive); border: 2px solid var(--border-color); color: var(--text-secondary); transition: all 0.3s; }
        .step-indicator.active::before { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .step-indicator:not(:last-child)::after { content: ''; position: absolute; top: 17px; left: 50%; right: -50%; height: 2px; background-color: var(--border-color); z-index: -1; }
        .step-indicator.active ~ .step-indicator::after { background-color: var(--border-color); }
        .step-indicator.active::after { background-color: var(--accent-blue); }

        /* --- Dynamic Popote Config --- */
        .item-config-grid { display: grid; grid-template-columns: 1fr 1fr 50px; gap: 15px; margin-top: 15px; align-items: flex-end;}
        .item-config-grid.thresholds { grid-template-columns: 1fr 1fr; }
        .item-row { border: 1px solid var(--border-color); padding: 15px; border-radius: 4px; margin-bottom: 10px; }
        .item-row h4 { margin-bottom: 10px; color: var(--accent-blue); font-size: 1.1em; }
        #appsScriptCodeBox { background-color: var(--bg-body); border: 1px solid var(--border-color); padding: 15px; border-radius: 4px; margin-top: 10px; display: none; }
        #appsScriptCodeBox textarea { width: 100%; height: 350px; background-color: transparent; border: none; color: var(--text-primary); font-family: monospace; resize: vertical; outline: none; }
        .action-group { display: flex; gap: 10px; margin-top: 10px; }
        .action-group button { flex-grow: 1; font-size: 1em; padding: 10px; }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <h1>Assistant de Configuration E-PSIG V5</h1>
        
        <div id="progress-bar">
            </div>

        <div id="notification"></div>

        <div id="step1" class="step active">
            <h2 class="step-title">1. Configuration générale du site (PWA)</h2>
            <div class="form-group">
                <label for="siteName">Titre complet du site</label>
                <input type="text" id="siteName" placeholder="Ex: Espace PSIG Sabre" value="Espace Mon Unité">
            </div>
            
            <h3 class="step-title" style="font-size: 1.3em;">Configuration PWA</h3>
            <div class="form-group">
                <label for="pwaName">Nom court de l'application (Affiché sous l'icône)</label>
                <input type="text" id="pwaName" placeholder="Ex: PSIG" value="E-PSIG">
            </div>
            <div class="form-group">
                <label for="pwaThemeColor">Couleur principale (Hex, ex: #0033a0)</label>
                <input type="color" id="pwaThemeColor" value="#0033a0" style="width: 50px; height: 50px; padding: 0;">
                <input type="text" id="pwaThemeColorText" value="#0033a0" placeholder="#0033a0" style="width: 100%; margin-top: 5px;">
            </div>

            <h3 class="step-title" style="font-size: 1.3em;">Fichiers Visuels</h3>
            <div class="help-box">
                <p>Téléchargez d'abord le "Starter pack" du site si vous n'avez pas les fichiers de base (index.html, base.css, etc.).</p>
                <a href="https://github.com/Oxsilaris06/GStart/raw/main/Starter%20pack.zip" target="_blank" class="action-button success" style="margin-top:10px; color:white;">Télécharger le Starter pack</a>
            </div>
            <div class="form-group">
                <label for="backgroundVideo">Vidéo de fond (.mp4)</label>
                <input type="file" id="backgroundVideo" accept=".mp4">
                <label for="backgroundVideo" class="file-input-label">Choisir un fichier</label>
                <span id="videoFileName" class="help-text" style="display:none;"></span>
            </div>
            <div class="form-group">
                <label for="faviconFile">Favicon (image carrée)</label>
                <input type="file" id="faviconFile" accept="image/*">
                <label for="faviconFile" class="file-input-label">Choisir une image</label>
                <span id="faviconFileName" class="help-text" style="display:none;"></span>
            </div>
        </div>
        
        <div id="step2" class="step">
            <h2 class="step-title">2. Configuration Popote & Partenaires</h2>
            <div class="help-box">
                <p>Définissez les articles consommables. Les noms doivent être uniques pour générer les clés internes.</p>
            </div>
            
            <div id="popote-items-config">
                </div>
            <button id="addItemBtn" class="action-button" style="background-color: var(--success-green); width: auto; padding: 8px 15px; margin-bottom: 20px;">
                <span class="material-symbols-outlined" style="vertical-align: middle;">add_circle</span> Ajouter un article
            </button>

            <div class="item-row">
                <h4>Seuils de Dette (€)</h4>
                <div class="item-config-grid thresholds">
                    <div class="form-group" id="alertThresholdGroup">
                        <label for="alertThreshold">Seuil d'Alerte (Dette $\ge$)</label>
                        <input type="number" id="alertThreshold" value="20.00" step="0.01" min="0">
                        <span class="invalid-feedback">Le seuil d'alerte doit être inférieur au seuil de blocage.</span>
                    </div>
                    <div class="form-group" id="blockThresholdGroup">
                        <label for="blockThreshold">Seuil de Blocage (Dette $\ge$)</label>
                        <input type="number" id="blockThreshold" value="30.00" step="0.01" min="0">
                        <span class="invalid-feedback">Le seuil de blocage doit être supérieur au seuil d'alerte.</span>
                    </div>
                </div>
            </div>

            <div class="item-row" style="margin-top: 20px;">
                <h4>Partenariat Élite & Paiement</h4>
                <div class="form-group">
                    <label for="revolutLink">Lien de paiement (Revolut/Lydia/Paypal)</label>
                    <input type="url" id="revolutLink" placeholder="https://revolut.me/..." value="https://revolut.me/nicomhx">
                </div>
                <div class="form-group">
                    <label for="prozisID">ID Partenaire Prozis</label>
                    <input type="text" id="prozisID" placeholder="Ex: mon.email@gmail.com" value="nicolas.maheux45@gmail.com">
                </div>
                <div class="form-group">
                    <label for="prozisPassword">Mot de passe Prozis</label>
                    <input type="password" id="prozisPassword" placeholder="Ex: PWD_ELITE" value="PSIGGILETTE06">
                </div>
                <div class="form-group">
                    <label for="prozisCoupon">Coupon Partenaire</label>
                    <input type="text" id="prozisCoupon" value="ELITE-PARTNER" placeholder="Ex: ELITE-PARTNER">
                </div>
            </div>
        </div>
        
        <div id="step3" class="step">
            <h2 class="step-title">3. Création de la feuille de calcul Google Sheets</h2>
            <div class="help-box">
                <p><b>Étape A :</b> Ouvrez le modèle ci-dessous. Faites une copie sur votre propre compte Google.</p>
                <a href="https://docs.google.com/spreadsheets/d/1V7Qe9xbq2wlSUEOgeAyqUmeAqoOflWiT1NwIskSJCBI/edit?usp=drivesdk" target="_blank" class="action-button open-sheet-btn" style="margin-top:10px; color:var(--text-primary); background-color: var(--bg-body);">Ouvrir le modèle (Copie Requise)</a>
                <p style="margin-top:15px;"><b>Étape B :</b> Remplissez les champs de chaque onglet sans toucher aux cases bleues.</p>
                <p style="margin-top:10px;"><b>Étape C :</b> Partagez la feuille en mode "Tous les utilisateurs disposant du lien" avec le rôle "Lecteur".</p>
            </div>
            <div class="form-group" style="margin-top: 20px;" id="sheetUrlGroup">
                <label for="sheetUrl">URL de votre feuille Google (Automatique)</label>
                <input type="text" id="sheetUrl" placeholder="Collez l'URL complète de votre feuille ici." oninput="validateInput(this, validateSheetUrl)">
                <span class="invalid-feedback">URL invalide ou ID introuvable. Exemple: https://docs.google.com/spreadsheets/d/ID_ICI/edit...</span>
            </div>
            <div class="form-group">
                <label for="sheetId">Ou entrez l'ID de la feuille (Manuel)</label>
                <input type="text" id="sheetId" placeholder="L'ID commence après /d/ dans l'URL.">
                <div class="help-text">L'ID sera automatiquement extrait de l'URL ci-dessus si elle est valide.</div>
            </div>
        </div>

        <div id="step4" class="step">
            <h2 class="step-title">4. Adaptation du script Apps Script (Backend)</h2>
            <div class="help-box">
                <p>Uploadez le fichier <code>all.gs</code> fourni dans le "Starter Pack". Si vous n'uploadez rien, un script de base sera utilisé. L'adaptation de l'ID est la première étape.</p>
            </div>
            <div class="action-group">
                <input type="file" id="uploadAppsScript" accept=".gs">
                <label for="uploadAppsScript" class="action-button" style="background-color: var(--accent-blue);">Uploader le script Apps Script (all.gs)</label>
                <button type="button" id="adaptAppsScriptBtn" class="action-button success" style="width: 100%; margin-top: 10px;">Adapter l'ID de la feuille</button>
            </div>
            <div id="appsScriptCodeBox">
                <p>Copiez le code adapté ci-dessous (l'injection des prix sera complétée au téléchargement) :</p>
                <textarea id="appsScriptCode" readonly></textarea>
                <div class="action-group">
                    <button type="button" id="copyAppsScriptBtn" style="background-color: var(--accent-blue);">Copier le code</button>
                </div>
            </div>
        </div>

        <div id="step5" class="step">
            <h2 class="step-title">5. Déploiement du script Apps Script</h2>
            <div class="help-box">
                <p>Suivez ces étapes pour publier le script et obtenir son URL :</p>
                <ol>
                    <li>Rendez-vous sur <a href="https://script.google.com/home/start" target="_blank">Google Apps Script</a>.</li>
                    <li>Créez un "Nouveau projet" et collez le code adapté de l'étape 4.</li>
                    <li>Cliquez sur **"Déployer"** > **"Nouveau déploiement"**.</li>
                    <li>Sélectionnez **"Application web"** et assurez-vous que l'accès est défini sur **"Tout le monde"**.</li>
                    <li>Cliquez sur "Déployer" et **copiez l'URL** de l'application web fournie.</li>
                </ol>
            </div>
            <div class="form-group" id="backendUrlGroup">
                <label for="backendUrl">URL de votre script de backend</label>
                <input type="url" id="backendUrl" placeholder="Collez l'URL de déploiement Apps Script ici.">
                <span class="invalid-feedback">Veuillez coller une URL valide.</span>
            </div>
        </div>
        
        <div id="step6" class="step">
            <h2 class="step-title">6. Configuration des fichiers de base (Optionnel)</h2>
            <div class="help-box">
                <p>Ces fichiers définissent les membres, l'équipement et les menus. Ils seront inclus dans le ZIP final.</p>
                <p>Si vous n'en fournissez pas, les fichiers par défaut du Starter Pack seront utilisés (ou des structures vides).</p>
            </div>
            <div class="form-group">
                <label for="membersConfig">members_config.json (Configuration des membres)</label>
                <input type="file" id="membersConfig" accept=".json">
                <label for="membersConfig" class="file-input-label" style="background-color: var(--text-secondary);">Uploader (JSON)</label>
            </div>
            <div class="form-group">
                <label for="configuratorDatabase">configurateur_db.json (Base de données d'équipement)</label>
                <input type="file" id="configuratorDatabase" accept=".json">
                <label for="configuratorDatabase" class="file-input-label" style="background-color: var(--text-secondary);">Uploader (JSON)</label>
            </div>
        </div>

        <div id="step7" class="step">
            <h2 class="step-title">7. Téléchargement et publication</h2>
            <div class="help-box">
                <p>Toutes les configurations sont terminées. Téléchargez le ZIP contenant tous les fichiers pour votre site :</p>
                <ul class="checklist" id="finalFilesChecklist">
                    </ul>
            </div>
            <button type="button" id="downloadAllBtn" class="action-button success">Télécharger le ZIP complet et prêt à l'emploi</button>
            
            <div class="help-box" style="margin-top: 30px;">
                <p>Une fois le ZIP téléchargé, dézippez-le et uploadez tous les fichiers dans votre dépôt GitHub pour le déploiement.</p>
            </div>
        </div>

        <div class="navigation-buttons">
            <button id="prevBtn" style="display:none;">Précédent</button>
            <button id="nextBtn">Suivant</button>
        </div>
    </div>
    
    <template id="all-gs-template">
        const SPREADSHEET_ID = "SPREADSHEET_ID_PLACEHOLDER";
        
        POPOTE_PRICES_PLACEHOLDER
        
        // --- FONCTIONS DE BASE DU BACKEND (SIMPLIFIÉ) ---
        function doGet(e) {
            const action = e.parameter.action;
            if (action == 'getDettes') {
                return ContentService.createTextOutput(JSON.stringify([{Membre: 'VGD', Dette: '5.50'}, {Membre: 'MHX', Dette: '12.00'}])).setMimeType(ContentService.MimeType.JSON);
            }
            if (action == 'authenticate') {
                return ContentService.createTextOutput(JSON.stringify({result: 'success'})).setMimeType(ContentService.MimeType.JSON);
            }
            return ContentService.createTextOutput(JSON.stringify({result: 'error', message: 'Action inconnue'})).setMimeType(ContentService.MimeType.JSON);
        }

        function doPost(e) { return ContentService.createTextOutput(JSON.stringify({result: 'success'})).setMimeType(ContentService.MimeType.JSON); }
        function changePassword(e) { return ContentService.createTextOutput(JSON.stringify({result: 'success'})).setMimeType(ContentService.MimeType.JSON); }
    </template>

    <template id="index-html-template">
        <!DOCTYPE html>
        <html>
        <head>
            <title>SITE_TITLE_PLACEHOLDER</title>
            <link rel="manifest" href="manifest.json">
            <link rel="stylesheet" href="base.css">
        </head>
        <body>
            <h1>Bienvenue sur SITE_TITLE_PLACEHOLDER</h1>
            <p>Ceci est votre page d'accueil. Voir <a href="popote.html">Popote</a></p>
            <video id="background-video" autoplay loop muted poster="background.png">
                <source src="VIDEO_FILENAME_PLACEHOLDER" type="video/mp4">
            </video>
            <script src="all.js"></script>
        </body>
        </html>
    </template>

    <template id="popote-html-template">
        <!DOCTYPE html>
        <html>
        <head>
            <title>Popote</title>
            <link rel="manifest" href="manifest.json">
            <link rel="stylesheet" href="base.css">
        </head>
        <body>
            <div id="app">
                <h1>Gestion Popote</h1>
                <p>L'application Popote est initialisée avec la configuration ci-dessous :</p>
            </div>
            <script>
                // --- CONFIGURATION DYNAMIQUE INJECTÉE ---
                const SITE_CONFIG = CONFIG_JSON_PLACEHOLDER;
                // Le reste du code JS de popote.html (Vue.js, fetch, etc.) s'exécute ici.
            </script>
            <script src="all.js"></script>
        </body>
        </html>
    </template>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const steps = document.querySelectorAll('.step');
            const progressContainer = document.getElementById('progress-bar');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const notificationDiv = document.getElementById('notification');
            let currentStep = 0;
            
            let uploadedScriptContent = "";
            let adaptedScriptContent = ""; 
            let videoFileBlob = null;
            let videoFileName = "background.mp4";
            let faviconGeneratedBlobs = [];
            let membersConfigContent = null;
            let configuratorDatabaseContent = null;

            // --- DOM ELEMENTS ---
            const dom = {
                siteName: document.getElementById('siteName'),
                pwaName: document.getElementById('pwaName'),
                pwaThemeColor: document.getElementById('pwaThemeColor'),
                pwaThemeColorText: document.getElementById('pwaThemeColorText'),
                backgroundVideoInput: document.getElementById('backgroundVideo'),
                videoFileNameSpan: document.getElementById('videoFileName'),
                faviconFileInput: document.getElementById('faviconFile'),
                faviconFileNameSpan: document.getElementById('faviconFileName'),
                
                popoteItemsConfig: document.getElementById('popote-items-config'),
                addItemBtn: document.getElementById('addItemBtn'),
                alertThreshold: document.getElementById('alertThreshold'),
                blockThreshold: document.getElementById('blockThreshold'),
                revolutLink: document.getElementById('revolutLink'),
                prozisID: document.getElementById('prozisID'),
                prozisPassword: document.getElementById('prozisPassword'),
                prozisCoupon: document.getElementById('prozisCoupon'),

                sheetUrl: document.getElementById('sheetUrl'),
                sheetId: document.getElementById('sheetId'),
                uploadAppsScriptInput: document.getElementById('uploadAppsScript'),
                adaptAppsScriptBtn: document.getElementById('adaptAppsScriptBtn'),
                appsScriptCodeBox: document.getElementById('appsScriptCodeBox'),
                appsScriptCodeTextarea: document.getElementById('appsScriptCode'),
                copyAppsScriptBtn: document.getElementById('copyAppsScriptBtn'),
                backendUrl: document.getElementById('backendUrl'),

                membersConfig: document.getElementById('membersConfig'),
                configuratorDatabase: document.getElementById('configuratorDatabase'),
                
                downloadAllBtn: document.getElementById('downloadAllBtn'),
                checkList: document.getElementById('finalFilesChecklist'),
            };

            // --- CORE TEMPLATE CONTENT (Retrieved from <template> tags) ---
            const getTemplateContent = (id) => document.getElementById(id).innerHTML.trim();
            const baseAllGsTemplate = getTemplateContent('all-gs-template');
            const baseIndexHtmlTemplate = getTemplateContent('index-html-template');
            const basePopoteHtmlTemplate = getTemplateContent('popote-html-template');
            
            // --- POPOTE ITEMS INITIALISATION ---
            let popoteItems = [
                { id: '1', name: 'Canettes & Sucreries', price: 0.60 },
                { id: '2', name: 'Bcaa', price: 1.50 },
                { id: '3', name: 'Cookie&Barres Prozis', price: 1.80 },
            ];

            // --- UX / PROGRESS BAR LOGIC ---
            const stepTitles = [
                'Général', 'Popote & Finance', 'Google Sheet', 'Apps Script',
                'Déploiement', 'Fichiers Avancés', 'Téléchargement'
            ];

            function generateProgressBar() {
                progressContainer.innerHTML = '';
                stepTitles.forEach((title, index) => {
                    const indicator = document.createElement('div');
                    indicator.className = `step-indicator ${index === currentStep ? 'active' : ''}`;
                    indicator.setAttribute('data-step', index + 1);
                    indicator.innerHTML = `<span>${title}</span>`;
                    indicator.addEventListener('click', () => {
                        if (index <= currentStep && validateStepsUpTo(index)) {
                            currentStep = index;
                            showStep(currentStep);
                        }
                    });
                    progressContainer.appendChild(indicator);
                });
            }

            function showStep(stepIndex) {
                steps.forEach((step, index) => {
                    step.classList.toggle('active', index === stepIndex);
                });
                prevBtn.style.display = stepIndex > 0 ? 'block' : 'none';
                nextBtn.style.display = stepIndex < steps.length - 1 ? 'block' : 'none';
                generateProgressBar();

                if (stepIndex === 2) {
                    validateInput(dom.sheetUrl, validateSheetUrl);
                }
                
                dom.appsScriptCodeBox.style.display = adaptedScriptContent.length > 0 && stepIndex === 3 ? 'block' : 'none';
            }

            function showNotification(message, type) {
                notificationDiv.textContent = message;
                notificationDiv.className = `notification ${type}`;
                notificationDiv.style.display = 'block';
                setTimeout(() => { notificationDiv.style.display = 'none'; }, 5000);
            }

            // --- VALIDATION & UTILS ---
            function getSheetIdFromUrl(url) {
                const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                return match ? match[1] : null;
            }
            
            function validateSheetUrl(input) {
                const sheetUrl = input.value.trim();
                const sheetId = getSheetIdFromUrl(sheetUrl);
                if (sheetId && sheetId.length > 20) {
                    dom.sheetId.value = sheetId;
                    return true;
                }
                dom.sheetId.value = '';
                return false;
            }

            function validateThresholds() {
                const alert = parseFloat(dom.alertThreshold.value);
                const block = parseFloat(dom.blockThreshold.value);
                let valid = !isNaN(alert) && !isNaN(block) && alert < block && alert >= 0 && block > 0;
                
                dom.alertThreshold.closest('.form-group').classList.toggle('is-invalid', !valid);
                dom.blockThreshold.closest('.form-group').classList.toggle('is-invalid', !valid);
                
                return valid;
            }

            function validateInput(input, validator) {
                const group = input.closest('.form-group');
                const isValid = validator(input);
                
                group.classList.toggle('is-invalid', !isValid);
                group.classList.toggle('is-valid', isValid);
                
                return isValid;
            }
            
            dom.sheetUrl.addEventListener('input', () => validateInput(dom.sheetUrl, validateSheetUrl));
            dom.alertThreshold.addEventListener('input', validateThresholds);
            dom.blockThreshold.addEventListener('input', validateThresholds);
            
            function validateStep(stepIndex) {
                switch(stepIndex) {
                    case 0:
                        if (!dom.siteName.value.trim()) { showNotification('Veuillez définir le titre du site.', 'error'); return false; }
                        return true;
                    case 1:
                        if (!validateThresholds()) { showNotification('Veuillez corriger les seuils de dette (Alerte < Blocage).', 'error'); return false; }
                        if (popoteItems.length === 0) { showNotification('Veuillez ajouter au moins un article de Popote.', 'error'); return false; }
                        return true;
                    case 2:
                        if (!dom.sheetId.value.trim() && !dom.sheetUrl.value.trim()) { showNotification('Veuillez coller l\'URL ou entrer manuellement l\'ID de la feuille Google.', 'error'); return false; }
                        if (!dom.sheetId.value.trim()) { 
                            if (!validateSheetUrl(dom.sheetUrl)) {
                                showNotification('URL de la feuille Google invalide.', 'error'); return false;
                            }
                        }
                        return true;
                    case 3:
                        if (!adaptedScriptContent) { showNotification('Veuillez adapter le script Apps Script à l\'aide du bouton.', 'error'); return false; }
                        return true;
                    case 4:
                        if (!dom.backendUrl.value.trim().startsWith('http')) { showNotification('Veuillez coller l\'URL de déploiement Apps Script (commence par https://...).', 'error'); return false; }
                        return true;
                    default:
                        return true;
                }
            }

            function validateStepsUpTo(targetStep) {
                for (let i = 0; i < targetStep; i++) {
                    if (!validateStep(i)) {
                        return false;
                    }
                }
                return true;
            }

            // --- NAVIGATION ---
            nextBtn.addEventListener('click', () => {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    showStep(currentStep);
                }
            });

            // --- FILE HANDLING ---
            dom.backgroundVideoInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                videoFileBlob = file || null;
                videoFileName = file ? file.name : "background.mp4";
                dom.videoFileNameSpan.textContent = file ? `Fichier sélectionné : ${file.name}` : '';
                dom.videoFileNameSpan.style.display = file ? 'block' : 'none';
                updateChecklist();
            });

            dom.faviconFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    dom.faviconFileNameSpan.textContent = `Fichier sélectionné : ${file.name}`;
                    dom.faviconFileNameSpan.style.display = 'block';
                    processFavicon(file);
                } else {
                    faviconGeneratedBlobs = [];
                    dom.faviconFileNameSpan.style.display = 'none';
                    updateChecklist();
                }
            });
            
            function processFavicon(file) {
                const sizes = [16, 32, 48, 72, 96, 128, 144, 152, 180, 192, 512];
                const promises = [];
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                faviconGeneratedBlobs = [];
                
                img.onload = () => {
                    sizes.forEach(size => {
                        promises.push(new Promise(resolve => {
                            canvas.width = canvas.height = size;
                            ctx.clearRect(0, 0, size, size);
                            ctx.drawImage(img, 0, 0, size, size);
                            canvas.toBlob(blob => {
                                let name;
                                if (size === 180) name = `apple-touch-icon.png`;
                                else if (size === 192) name = `android-icon-${size}x${size}.png`;
                                else name = `favicon-${size}x${size}.png`;
                                
                                faviconGeneratedBlobs.push({ name, size, blob, type: 'image/png' });
                                resolve();
                            }, 'image/png');
                        }));
                    });
                    
                    promises.push(new Promise(resolve => {
                        canvas.width = canvas.height = 32;
                        ctx.clearRect(0, 0, 32, 32);
                        ctx.drawImage(img, 0, 0, 32, 32);
                        canvas.toBlob(blob => {
                            faviconGeneratedBlobs.push({ name: `favicon.ico`, size: 0, blob, type: 'image/vnd.microsoft.icon' });
                            resolve();
                        }, 'image/vnd.microsoft.icon');
                    }));

                    Promise.all(promises).then(() => {
                        updateChecklist();
                    });
                };
                img.src = URL.createObjectURL(file);
            }

            // --- STEP 2: DYNAMIC POPOTE LOGIC ---
            function renderPopoteItems() {
                dom.popoteItemsConfig.innerHTML = '';
                popoteItems.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-row';
                    itemDiv.innerHTML = `
                        <h4>Article ${index + 1}</h4>
                        <div class="item-config-grid">
                            <div class="form-group">
                                <label for="item-${item.id}-name">Nom</label>
                                <input type="text" id="item-${item.id}-name" value="${item.name}" data-id="${item.id}" required>
                            </div>
                            <div class="form-group">
                                <label for="item-${item.id}-price">Prix (€)</label>
                                <input type="number" id="item-${item.id}-price" value="${item.price.toFixed(2)}" step="0.01" min="0" data-id="${item.id}" required>
                            </div>
                            <button class="action-button danger remove-item-btn" data-id="${item.id}" title="Supprimer l'article" style="width: 100%; height: 50%; margin-top: 25px;">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    `;
                    dom.popoteItemsConfig.appendChild(itemDiv);
                });
                
                document.querySelectorAll('.remove-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removePopoteItem(e.target.dataset.id || e.target.closest('button').dataset.id));
                });
            }

            function addPopoteItem() {
                const newId = Date.now().toString();
                popoteItems.push({ id: newId, name: `Nouvel Article ${popoteItems.length + 1}`, price: 1.00 });
                renderPopoteItems();
            }

            function removePopoteItem(id) {
                if (popoteItems.length <= 1) {
                    showNotification('Impossible de supprimer le dernier article.', 'error');
                    return;
                }
                popoteItems = popoteItems.filter(item => item.id !== id);
                renderPopoteItems();
            }

            dom.addItemBtn.addEventListener('click', addPopoteItem);
            
            function getPopoteConfig() {
                const config = {
                    elitePartner: {
                        id: dom.prozisID.value.trim(),
                        password: dom.prozisPassword.value.trim(),
                        coupon: dom.prozisCoupon.value.trim()
                    },
                    revolutLink: dom.revolutLink.value.trim(),
                    itemPrices: {},
                    debtThresholds: {
                        alert: parseFloat(dom.alertThreshold.value) || 20,
                        block: parseFloat(dom.blockThreshold.value) || 30
                    }
                };
                
                popoteItems = []; 
                document.querySelectorAll('#popote-items-config .item-row').forEach((row, index) => {
                    const nameInput = row.querySelector('input[id$="-name"]');
                    const priceInput = row.querySelector('input[id$="-price"]');
                    const id = nameInput.dataset.id;
                    
                    const name = nameInput.value.trim();
                    const price = parseFloat(priceInput.value);
                    const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 30) || `item_${index + 1}`;
                    
                    popoteItems.push({ id: id, name: name, price: price });
                    
                    config.itemPrices[key] = {
                        name: name,
                        price: price,
                        image: `${key}.png`
                    };
                });
                
                return config;
            }

            // --- STEP 4: APPS SCRIPT ADAPTATION ---
            dom.uploadAppsScriptInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedScriptContent = e.target.result;
                        adaptedScriptContent = ""; 
                        dom.appsScriptCodeTextarea.value = "";
                        showNotification('Fichier Apps Script chargé. Cliquez sur "Adapter l\'ID de la feuille".', 'success');
                    };
                    reader.readAsText(file);
                } else {
                    uploadedScriptContent = "";
                    adaptedScriptContent = "";
                    dom.appsScriptCodeBox.style.display = 'none';
                }
            });

            dom.adaptAppsScriptBtn.addEventListener('click', () => {
                let scriptToAdapt = uploadedScriptContent || baseAllGsTemplate;
                const sheetId = dom.sheetId.value.trim();
                
                if (!sheetId) {
                    showNotification('Veuillez revenir à l\'étape 3 et valider l\'ID de votre feuille Google.', 'error');
                    return;
                }

                let code = scriptToAdapt.replace(/SPREADSHEET_ID_PLACEHOLDER/g, sheetId); 
                
                adaptedScriptContent = code;
                dom.appsScriptCodeTextarea.value = adaptedScriptContent;
                dom.appsScriptCodeBox.style.display = 'block';
                showNotification('Script Apps Script adapté avec succès ! Passez à l\'étape 5.', 'success');
            });

            dom.copyAppsScriptBtn.addEventListener('click', () => {
                dom.appsScriptCodeTextarea.select();
                document.execCommand('copy');
                showNotification('Code Apps Script copié dans le presse-papiers.', 'success');
            });

            // --- STEP 6: ADVANCED FILES HANDLING ---
            function handleAdvancedFileUpload(input, contentVariable) {
                input.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            if (contentVariable === 'membersConfigContent') membersConfigContent = e.target.result;
                            else if (contentVariable === 'configuratorDatabaseContent') configuratorDatabaseContent = e.target.result;
                            showNotification(`Fichier ${file.name} chargé.`, 'success');
                        };
                        reader.readAsText(file);
                    } else {
                        if (contentVariable === 'membersConfigContent') membersConfigContent = null;
                        else if (contentVariable === 'configuratorDatabaseContent') configuratorDatabaseContent = null;
                    }
                    updateChecklist();
                });
            }
            
            handleAdvancedFileUpload(dom.membersConfig, 'membersConfigContent');
            handleAdvancedFileUpload(dom.configuratorDatabase, 'configuratorDatabaseContent');


            // --- STEP 7: DOWNLOAD & CHECKLIST ---
            
            function generateManifest(themeColor, siteName, pwaName) {
                const icons = faviconGeneratedBlobs
                    .filter(f => f.type === 'image/png' && f.size > 0)
                    .map(f => ({ src: f.name, sizes: `${f.size}x${f.size}`, type: 'image/png' }));
                
                return JSON.stringify({
                    name: siteName, short_name: pwaName, description: "Application d'aide à la gestion pour unité de Gendarmerie.",
                    start_url: "/", display: "standalone", background_color: "#121212", theme_color: themeColor, icons: icons
                }, null, 2);
            }
            
            function generateFaviconLinks(links) {
                return links.map(f => {
                    if (f.name.includes('favicon.ico')) return `<link rel="shortcut icon" href="${f.name}">`;
                    if (f.name.includes('apple-touch-icon')) return `<link rel="apple-touch-icon" href="${f.name}">`;
                    if (f.name.includes('favicon-')) return `<link rel="icon" type="image/png" sizes="${f.size}x${f.size}" href="${f.name}">`;
                    return '';
                }).join('\n    ');
            }

            function updateChecklist() {
                 let checklistHTML = `
                    <li>all.json (Config mise à jour)</li>
                    <li>manifest.json (PWA mis à jour)</li>
                    <li>index.html (Base)</li>
                    <li>popote.html (Rendu dynamique)</li>
                    <li>all.gs (Script backend mis à jour)</li>
                    <li>base.css (Fichier CSS simulé)</li>
                    <li>all.js (Fichier JS simulé)</li>
                    ${videoFileBlob ? `<li>${videoFileName} (Vidéo de fond)</li>` : ''}
                    ${faviconGeneratedBlobs.length > 0 ? `<li>Icônes (Favicon, Android, Apple)</li>` : ''}
                    ${membersConfigContent ? `<li>members_config.json (Avancé)</li>` : ''}
                    ${configuratorDatabaseContent ? `<li>configurateur_db.json (Avancé)</li>` : ''}
                `;
                dom.checkList.innerHTML = checklistHTML;
            }


            dom.downloadAllBtn.addEventListener('click', async () => {
                if (!validateStepsUpTo(6) || !dom.backendUrl.value.trim()) {
                    showNotification('Veuillez compléter correctement toutes les étapes et coller l\'URL du backend à l\'étape 5.', 'error');
                    return;
                }
                
                const siteTitle = dom.siteName.value.trim();
                const pwaName = dom.pwaName.value.trim();
                const themeColor = dom.pwaThemeColorText.value.trim();
                const backendUrl = dom.backendUrl.value.trim();
                const popoteConfig = getPopoteConfig();
                
                const zip = new JSZip();
                
                // 1. all.json Generation
                const config = {
                    "global": { "siteTitle": siteTitle, "backgroundVideoPath": videoFileName, "pwaName": pwaName, "pwaThemeColor": themeColor },
                    "backendUrl": backendUrl, "popoteConfig": popoteConfig, "configurateurDatabase": {}, "membersDatabase": {}
                };

                if (membersConfigContent) { config.membersDatabase = JSON.parse(membersConfigContent); }
                if (configuratorDatabaseContent) { config.configurateurDatabase = JSON.parse(configuratorDatabaseContent); }
                zip.file("all.json", JSON.stringify(config, null, 2));
                
                // 2. manifest.json Generation & Favicon Links
                const manifestContent = generateManifest(themeColor, siteTitle, pwaName);
                zip.file("manifest.json", manifestContent);
                const faviconLinkTags = generateFaviconLinks(faviconGeneratedBlobs);
                
                // 3. index.html Generation
                zip.file("index.html", baseIndexHtmlTemplate.replace(/SITE_TITLE_PLACEHOLDER/g, siteTitle).replace('', faviconLinkTags).replace('VIDEO_FILENAME_PLACEHOLDER', videoFileName));
                
                // 4. popote.html Generation
                const configString = JSON.stringify(config, null, 2);
                zip.file("popote.html", basePopoteHtmlTemplate.replace('', faviconLinkTags).replace('CONFIG_JSON_PLACEHOLDER', configString));

                // 5. all.gs FINAL ADAPTATION and Generation
                if (!adaptedScriptContent) {
                    showNotification('Erreur : le script Apps Script n\'a pas été adapté (Étape 4). Utilisation du template de base.', 'error');
                    return;
                }
                let gsContent = adaptedScriptContent; 
                
                const priceMap = {};
                for (const key in popoteConfig.itemPrices) { priceMap[key] = popoteConfig.itemPrices[key].price; }
                const pricesJs = JSON.stringify(priceMap, null, 2); 
                const pricesInjection = `const POPOTE_PRICES = ${pricesJs};`;
                const finalGsContent = gsContent.replace(/POPOTE_PRICES_PLACEHOLDER/g, pricesInjection);

                zip.file("all.gs", finalGsContent);

                // 6. Fichiers de base simulés
                zip.file("base.css", "/* Fichier CSS de base de l'application E-PSIG */");
                zip.file("all.js", "// Fichier de fonctions JS partagées");
                
                // 7. Fichiers visuels
                if (videoFileBlob) { zip.file(videoFileName, videoFileBlob); }
                faviconGeneratedBlobs.forEach(file => { zip.file(file.name, file.blob); });
                
                // 8. Fichiers JSON Avancés (si uploadés)
                if (membersConfigContent) { zip.file("members_config.json", membersConfigContent); }
                if (configuratorDatabaseContent) { zip.file("configurateur_db.json", configuratorDatabaseContent); }


                zip.generateAsync({ type: "blob" }).then(content => {
                    const url = URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'site_psig_v5_config.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showNotification('ZIP de configuration téléchargé !', 'success');
                });
            });

            // --- Initialization ---
            renderPopoteItems();
            generateProgressBar();
            showStep(0);
        });
    </script>
</body>
</html>
