<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur d'Ordre Initial - Wizard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
        h2 { font-size: 1.5em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        h3 { font-size: 1.2em; color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; }
        h4 { font-size: 1.0em; color: var(--text-secondary); margin-top: 10px; margin-bottom: 5px; }
        .wizard-progress { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 25px; list-style-type: none; padding: 0; }
        .wizard-progress-step {
            flex-grow: 1; padding: 8px 12px; text-align: center; font-size: 0.85em;
            color: var(--text-secondary); background-color: var(--bg-interactive);
            border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .wizard-progress-step:hover { background-color: var(--bg-body); }
        .wizard-progress-step.completed { border-color: var(--accent-blue); color: var(--accent-blue); }
        .wizard-progress-step.active {
            color: white; background-color: var(--accent-blue);
            border-color: var(--accent-blue); font-weight: 500;
        }
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .wizard-nav { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .wizard-nav-btn { width: 100%; margin-top: 10px; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; }
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); order: 1; }
        #nextBtn { background-color: var(--accent-blue); color: white; order: 2; }
        #previewBtn { background-color: #6c757d; color: white; order: 3; }
        #generatePdfBtn { background-color: #27ae60; color: white; order: 4; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        textarea { min-height: 120px; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .dynamic-list-item > *:not(button) { flex-grow: 1; margin-bottom: 0; }
        button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
        button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px 15px; }
        .collapsible-header h3 { margin: 0; font-size: 1.2em; }
        .collapsible-header .material-icons { transition: transform 0.3s; }
        .collapsible-container.open .collapsible-header .material-icons { transform: rotate(180deg); }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible-container.open .collapsible-content { max-height: 4000px; padding-top: 10px; padding-bottom: 15px; }
        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; border: none; background-color: transparent; }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
        #dockToggleBtn .material-icons { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-icons { transform: rotate(180deg); }
        
        .photo-input { display: none; }
        .file-upload-label { background-color: var(--accent-blue); color: white !important; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-family: 'Oswald', sans-serif; font-weight: normal; display: inline-block; text-align: center; flex-shrink: 0; }
        .file-upload-label:hover { background-color: var(--accent-hover); }
        .file-name-display { color: var(--text-secondary); font-style: italic; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        .image-preview { max-width: 150px; max-height: 100px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); }
        
        .draggable { cursor: move; user-select: none; }
        .draggable.dragging { opacity: 0.5; }

        .patracdvr-members-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0; }
        .patracdvr-member-btn {
            background-color: var(--bg-body); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 8px 12px; border-radius: 5px;
            text-align: center; font-family: 'Oswald', sans-serif;
        }
        .patracdvr-member-btn:hover { border-color: var(--accent-blue); }
        .patracdvr-member-btn .trigramme { font-weight: bold; }
        .patracdvr-member-btn .fonction { font-size: 0.8em; color: var(--text-secondary); display: block; }
        
        #editMemberModal {
            background: var(--bg-container); color: var(--text-primary);
            border: 1px solid var(--border-color); border-radius: 8px;
            width: 90%; max-width: 500px;
        }
        #editMemberModal::backdrop { background: rgba(0, 0, 0, 0.7); }
        #editMemberModal label { margin-top: 10px; }
        #editMemberModal .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }

        @media (min-width: 600px) {
            .wizard-nav-btn { width: auto; margin-top: 0; }
            #prevBtn { order: 1; } #nextBtn { order: 2; }
            #previewBtn { order: 3; } #generatePdfBtn { order: 4; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="R√©duire"><span class="material-icons">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le th√®me"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="R√©initialiser le formulaire"><span class="material-icons">refresh</span></div>
    </div>

    <dialog id="editMemberModal">
        <form id="editMemberForm">
            <h3>√âditer le membre</h3>
            <label for="modal_trigramme">Trigramme:</label>
            <input type="text" id="modal_trigramme" placeholder="Trigramme">
            
            <label for="modal_fonction">Fonction:</label>
            <select id="modal_fonction"></select>
            
            <label for="modal_armement">Armement:</label>
            <select id="modal_armement"></select>
            
            <label for="modal_equipement">√âquipement 1:</label>
            <select id="modal_equipement"></select>

            <label for="modal_equipement2">√âquipement 2:</label>
            <select id="modal_equipement2"></select>

            <label for="modal_tenue">Tenue:</label>
            <select id="modal_tenue"></select>

            <label for="modal_gpb">GPB:</label>
            <select id="modal_gpb"></select>

            <div class="modal-actions">
                <button type="button" id="modal_deleteBtn" class="remove-btn">Supprimer</button>
                <button type="button" id="modal_cancelBtn">Annuler</button>
                <button type="submit" id="modal_saveBtn" class="add-btn">Sauvegarder</button>
            </div>
        </form>
    </dialog>

    <div class="container">
        <h1>G√©n√©rateur d'Ordre Initial</h1>
        
        <ul class="wizard-progress">
            <li class="wizard-progress-step" onclick="goToStep(0)">Situation</li>
            <li class="wizard-progress-step" onclick="goToStep(1)">Adversaire</li>
            <li class="wizard-progress-step" onclick="goToStep(2)">Environnement</li>
            <li class="wizard-progress-step" onclick="goToStep(3)">Mission</li>
            <li class="wizard-progress-step" onclick="goToStep(4)">Ex√©cution</li>
            <li class="wizard-progress-step" onclick="goToStep(5)">Articulation</li>
            <li class="wizard-progress-step" onclick="goToStep(6)">PATRACDVR</li>
            <li class="wizard-progress-step" onclick="goToStep(7)">Photos</li>
            <li class="wizard-progress-step" onclick="goToStep(8)">CAT</li>
            <li class="wizard-progress-step" onclick="goToStep(9)">Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'op√©ration :</label><input type="date" id="date_op">
                    <label for="situation_generale">1.1 G√©n√©rale :</label><textarea id="situation_generale"></textarea>
                    <label for="situation_particuliere">1.2 Particuli√®re :</label><textarea id="situation_particuliere"></textarea>
                </div>

                <div class="wizard-step">
                    <h2>1.3 Adversaire</h2>
                    <label>Photo de l'adversaire :</label>
                    <div id="adversary_photo_container"></div>
                    <label for="nom_adversaire">Nom/Pr√©nom :</label><input type="text" id="nom_adversaire">
                    <label for="domicile_adversaire">Domicile :</label><textarea id="domicile_adversaire" rows="2"></textarea>
                    <label>Moyens Employ√©s :</label><div id="me_container"></div><button type="button" class="add-btn" onclick="addMeField()">‚ûï ME</button>
                    <h3>Informations TO</h3>
                    <h4>Date et lieu de naissance :</h4>
                    <div class="dynamic-list-item"><input type="date" id="date_naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
                    <div class="dynamic-list-item"><input type="text" id="stature_adversaire" placeholder="Stature"><select id="ethnie_adversaire"><option>Caucasien</option><option>Nord africain</option><option>Afro-antillais</option><option>Asiatique</option></select></div>
                    <label for="signes_particuliers">Signes particuliers :</label><input type="text" id="signes_particuliers">
                    <label for="profession_adversaire">Profession :</label><input type="text" id="profession_adversaire">
                    <label for="antecedents_adversaire">Ant√©c√©dents :</label><textarea id="antecedents_adversaire" rows="2"></textarea>
                    <label>√âtat d'esprit :</label><div id="etat_esprit_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'])">‚ûï</button>
                    <label for="attitude_adversaire">Attitude (connue) :</label><textarea id="attitude_adversaire" rows="2"></textarea>
                    <label>Volume (renfort potentiel) :</label><div id="volume_adversaire_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'])">‚ûï</button>
                    <label for="substances_adversaire">Substances :</label><input type="text" id="substances_adversaire">
                    <label>V√©hicules :</label><div id="vehicules_container"></div><button type="button" class="add-btn" onclick="addDynamicField('vehicules_container')">‚ûï</button>
                    <label for="armes_connues">Armes connues :</label><input type="text" id="armes_connues">
                </div>
                
                <div class="wizard-step">
                    <h2>1.4 Environnement</h2>
                     <label>Ami(e)s (Unit√©s en soutien) :</label><input type="text" id="amies">
                     <label>Terrain / M√©t√©o :</label><input type="text" id="terrain_info">
                     <label>Population :</label><input type="text" id="population">
                     <label>Cadre juridique :</label><input type="text" id="cadre_juridique">
                </div>

                <div class="wizard-step">
                    <h2>2. Mission du PSIG</h2>
                    <textarea id="missions_psig" rows="8"></textarea>
                </div>

                <div class="wizard-step">
                     <h2>3. Ex√©cution</h2>
                     <label>Date d'ex√©cution :</label><input type="date" id="date_execution">
                     <label>Heure d'ex√©cution (H) :</label><input type="time" id="heure_execution" value="06:00">
                     <label>Type d'action :</label><input type="text" id="type_action">
                     <h3>Chronologie</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">‚ûï</button>
                     <h3>Hypoth√®ses</h3>
                     <label>H1 :</label><input type="text" id="hypothese_h1" value="Target pr√©sente LE1">
                     <label>H2 :</label><input type="text" id="hypothese_h2" value="Target pr√©sente LE2">
                     <label>H3 :</label><input type="text" id="hypothese_h3" value="Target absente LE 1 et 2">
                </div>

                <div class="wizard-step">
                     <h2>4. Articulation (MOIPC/ZMSPCP)</h2>
                     <label>Place du Chef (G√©n√©rale) :</label><input type="text" id="place_chef">
                     <div class="collapsible-container">
                        <div class="collapsible-header"><h3>√âquipe INDIA (INTER)</h3><span class="material-icons">expand_more</span></div>
                        <div class="collapsible-content">
                             <label for="india_mission">Mission :</label><textarea id="india_mission" rows="3">RECONNA√éTRE LE DOMICILE EN VUE D'APPR√âHENDER L'OBJECTIF</textarea>
                             <label for="india_objectif">Objectif :</label><input type="text" id="india_objectif">
                             <label for="india_itineraire">Itin√©raire :</label><textarea id="india_itineraire" rows="3"></textarea>
                             
                             <h3>Photos - Itin√©raire</h3>
                             <h4>Itin√©raire Ext√©rieur</h4>
                             <div id="photo_container_itineraire_exterieur"></div>
                             <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_exterieur')">Ajouter Photo ‚ûï</button>
                             <h4>Itin√©raire Int√©rieur</h4>
                             <div id="photo_container_itineraire_interieur"></div>
                             <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_interieur')">Ajouter Photo ‚ûï</button>

                             <label for="india_points_particuliers">Points Particuliers :</label><textarea id="india_points_particuliers" rows="3"></textarea>
                             <label for="india_cat">Conduite √† Tenir :</label><textarea id="india_cat" rows="6">- Si d√©cel√©, dynamiser jusqu'au domicile.
- Si pr√©sence tierce personne lors de la progression, contr√¥ler.
- Si fuite, CR direction fuite + interpellation.
- Si r√©bellion, usage du strict niveau de force n√©cessaire.
- Si retranchement, CR + r√©articulation pour fixer l'adversaire.</textarea>
                        </div>
                     </div>
                     <div class="collapsible-container">
                        <div class="collapsible-header"><h3>√âquipe Appui/Observation (AO) - ZMSPCP</h3><span class="material-icons">expand_more</span></div>
                        <div class="collapsible-content">
                             <label for="ao_zone_installation">Zone d'installation (Z) :</label><textarea id="ao_zone_installation" rows="3"></textarea>
                             <h3>Photos - Zone d'installation</h3>
                             <h4>Bapt√™me terrain</h4>
                             <div id="photo_container_bapteme_terrain"></div>
                             <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_bapteme_terrain')">Ajouter Photo ‚ûï</button>
                             <h4>Emplacement AO</h4>
                             <div id="photo_container_emplacement_ao"></div>
                             <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_emplacement_ao')">Ajouter Photo ‚ûï</button>

                             <label for="ao_mission">Mission (M) :</label><textarea id="ao_mission" rows="3">BOUCLER - SURVEILLER - INTERDIRE TOUTE FUITE</textarea>
                             <label for="ao_secteur_surveillance">Secteur de surveillance (S) :</label><textarea id="ao_secteur_surveillance" rows="3"></textarea>
                             <label for="ao_points_particuliers">Points Particuliers (P) :</label><textarea id="ao_points_particuliers" rows="3"></textarea>
                             <label for="ao_cat">Conduite √† Tenir (C) :</label><textarea id="ao_cat" rows="6">- Compte rendu de mise en place.
- Renseigner r√©guli√®rement.
- Si d√©cel√©, CR.
- Si fuite, CR direction fuite + interpellation si rapport de force favorable.
- Si r√©bellion, usage du strict minimum de force n√©cessaire.</textarea>
                             <label for="ao_place_chef">Place du Chef (P) :</label><input type="text" id="ao_place_chef">
                        </div>
                     </div>
                </div>
                
                <div class="wizard-step">
                    <h2>5. PATRACDVR</h2>
                    <div id="patracdvr_container"></div>
                    <button type="button" class="add-btn" style="width:100%;" onclick="addPatracdvrRow()">Ajouter un v√©hicule ‚ûï</button>
                </div>

                <div class="wizard-step">
                    <h2>Photos</h2>
                    <p>Ajoutez des photos compl√©mentaires pour le PDF.</p>
                    <div class="form-section">
                        <h3>Transport PSIG vers PR</h3>
                        <div id="photo_container_transport_pr"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_pr')">Ajouter Photo ‚ûï</button>
                    </div>
                     <div class="form-section">
                        <h3>Transport PR vers Domicile</h3>
                        <div id="photo_container_transport_domicile"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_domicile')">Ajouter Photo ‚ûï</button>
                    </div>
                    <div class="form-section">
                        <h3>Cellule Effraction</h3>
                        <div id="photo_container_cellule_effraction"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_cellule_effraction')">Ajouter Photo ‚ûï</button>
                    </div>
                </div>

                <div class="wizard-step">
                    <h2>Conduites √† tenir</h2>
                    <h3>G√©n√©rales</h3>
                    <textarea id="cat_generales" rows="6">- Si r√©bellion, user du strict niveau de force n√©cessaire
- Si retranch√©, alerter en mesure de se r√©-articuler
- Si tente de fuir, alerter en mesure de jalonner/interpeller
- UDA¬†: Article L435-1 du CSI + l√©gitime d√©fense</textarea>
                    
                    <h3>NO GO</h3>
                    <textarea id="no_go" rows="3" placeholder="Saisir les conditions de d√©sengagement..."></textarea>

                    <h3>Liaison</h3>
                    <textarea id="cat_liaison" rows="4">TOM : 
DIR : 
Gestuelle et visuelle entre les √©l√©ments INDIA</textarea>
                </div>
                
                <div class="wizard-step">
                    <h2>Finalisation</h2>
                    <p style="text-align:center;">Vous √™tes pr√™t. Cliquez sur "Aper√ßu" pour v√©rifier ou "G√©n√©rer le PDF" pour cr√©er votre document.</p>
                </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button">Pr√©c√©dent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button">Suivant</button>
            <button class="wizard-nav-btn" id="previewBtn" type="button" style="display:none;">Aper√ßu üîé</button>
            <button class="wizard-nav-btn" id="generatePdfBtn" type="button" style="display:none;">G√©n√©rer le PDF üìÑ</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <script>
        // --- GLOBAL CONFIG ---
        const memberConfig = {
            fonctions: ['Chef inter','Chef dispo','AO','Inter','DE'],
            armements: ['Sans', 'UMP9', 'G36', 'PIE', 'LBD40', 'FAP'],
            equipements: ['Sans', 'BBAL', 'GENL', 'EFFRAC', 'MP7', 'IL'],
            equipements2: ['Sans', '√âchelle', 'Stop stick', 'Lacry', 'Cale'],
            tenues: ['UBAS', '4S', 'Bleu', 'Treillis', 'Civil'],
            gpbs: ['GPBL', 'GPBPD']
        };
        const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Sc√©nic', 'BT'];

        // --- WIZARD & FORM MANAGEMENT ---
        let currentStep = 0;
        let visitedSteps = new Set();
        const steps = Array.from(document.querySelectorAll(".wizard-step"));
        const progressSteps = Array.from(document.querySelectorAll(".wizard-progress-step"));
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const previewBtn = document.getElementById('previewBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');

        function showStep(n) {
            steps.forEach((step, index) => step.classList.toggle('active', index === n));
            progressSteps.forEach((pStep, index) => {
                pStep.classList.toggle('active', index === n);
                if(visitedSteps.has(index) && index !== n) pStep.classList.add('completed');
                else pStep.classList.remove('completed');
            });
            prevBtn.style.display = n === 0 ? "none" : "inline-block";
            const isLastStep = n === (steps.length - 1);
            nextBtn.style.display = isLastStep ? "none" : "inline-block";
            previewBtn.style.display = isLastStep ? "inline-block" : "none";
            generatePdfBtn.style.display = isLastStep ? "inline-block" : "none";
        }
        function goToStep(n) {
            if (n >= 0 && n < steps.length) {
                visitedSteps.add(currentStep);
                saveFormData();
                currentStep = n;
                showStep(n);
            }
        }
        function changeStep(n) { goToStep(currentStep + n); }
        prevBtn.addEventListener('click', () => changeStep(-1));
        nextBtn.addEventListener('click', () => changeStep(1));
        
        // --- DYNAMIC FIELD & PHOTO MANAGEMENT ---
        function addPhotoInput(containerId, isSingle = false) {
            const container = document.getElementById(containerId);
            if (isSingle) container.innerHTML = '';
            const itemWrapper = document.createElement('div');
            itemWrapper.className = 'photo-input-wrapper';
            const uniqueId = 'photo_input_' + Date.now() + Math.random();
            const spanId = 'file_name_' + uniqueId;
            const previewId = 'preview_' + uniqueId;
            itemWrapper.innerHTML = `
                <div class="dynamic-list-item">
                    <input type="file" id="${uniqueId}" class="photo-input" accept="image/png, image/jpeg" onchange="handleFileChange(this, '${spanId}', '${previewId}')">
                    <label for="${uniqueId}" class="file-upload-label">Choisir une photo</label>
                    <span id="${spanId}" class="file-name-display">Aucun fichier choisi</span>
                    ${!isSingle ? '<button type="button" class="remove-btn" onclick="this.closest(\'.photo-input-wrapper\').remove()">‚ùå</button>' : ''}
                </div>
                <img id="${previewId}" class="image-preview" style="display:none;" alt="Aper√ßu"/>`;
            container.appendChild(itemWrapper);
        }
        function handleFileChange(input, spanId, previewId) {
            const fileNameSpan = document.getElementById(spanId);
            const previewImg = document.getElementById(previewId);
            if (input.files.length > 0) {
                fileNameSpan.textContent = input.files[0].name;
                const reader = new FileReader();
                reader.onload = e => {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                fileNameSpan.textContent = 'Aucun fichier choisi';
                previewImg.src = '';
                previewImg.style.display = 'none';
            }
        }
        function addDynamicField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<input type="text" class="dynamic-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">‚ùå</button>`;
            container.appendChild(item);
        }
        function addMeField(value = '') {
            const container = document.getElementById('me_container');
            if (container.children.length >= 3) return;
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<label>ME${container.children.length + 1}:</label><input type="text" class="me-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">‚ùå</button>`;
            container.appendChild(item);
        }

        // --- PATRACDVR & MEMBER MODAL MANAGEMENT ---
        function addPatracdvrRow(vehicle, members = []) {
            const container = document.getElementById('patracdvr_container');
            const row = document.createElement('div');
            row.className = 'collapsible-container';
            const membersContainerId = `patracdvr_members_${Date.now()}`;

            row.innerHTML = `<div class="collapsible-header"><h3>V√©hicule</h3><span class="material-icons">expand_more</span></div>
                             <div class="collapsible-content">
                                 <div class="dynamic-list-item">
                                     <select class="patracdvr-vehicle-select" onchange="saveFormData()">${availableVehicles.map(v => `<option value="${v}" ${v === vehicle ? 'selected':''}>${v}</option>`).join('')}</select>
                                     <button type="button" class="remove-btn">‚ùå</button>
                                 </div>
                                 <div id="${membersContainerId}" class="patracdvr-members-container"></div>
                                 <button type="button" class="add-btn">‚ûï Personnel</button>
                             </div>`;
            container.appendChild(row);

            row.querySelector('.remove-btn').addEventListener('click', () => { row.remove(); saveFormData(); });
            row.querySelector('.collapsible-header').addEventListener('click', e => e.currentTarget.parentElement.classList.toggle('open'));
            
            // CORRECTED: Find the container relative to the clicked button
            row.querySelector('.add-btn').addEventListener('click', (event) => {
                const membersContainer = event.currentTarget.previousElementSibling;
                addPatracdvrMember(membersContainer.id);
            });
            
            enableDragAndDrop(`#${membersContainerId}`);
            members.forEach(m => addPatracdvrMember(membersContainerId, m));
        }

        function addPatracdvrMember(containerId, data = {}) {
            const container = document.getElementById(containerId);
            if (!container) return; // Safety check
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'patracdvr-member-btn draggable';
            btn.id = `member_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            btn.setAttribute('draggable', 'true');

            const memberData = {
                trigramme: data.trigramme || '', fonction: data.fonction || 'Inter', armement: data.armement || 'Sans',
                equipement: data.equipement || 'Sans', equipement2: data.equipement2 || 'Sans',
                tenue: data.tenue || 'Treillis', gpb: data.gpb || 'GPBL'
            };

            Object.keys(memberData).forEach(key => btn.dataset[key] = memberData[key]);
            
            updateMemberButtonVisuals(btn);
            container.appendChild(btn);
            btn.addEventListener('click', () => openMemberModal(btn.id));
        }
        
        function updateMemberButtonVisuals(btn) {
            const trigramme = btn.dataset.trigramme || 'N/A';
            const fonction = btn.dataset.fonction || '';
            btn.innerHTML = `<span class="trigramme">${trigramme}</span><span class="fonction">${fonction}</span>`;
        }

        function openMemberModal(buttonId) {
            const modal = document.getElementById('editMemberModal');
            const form = document.getElementById('editMemberForm');
            const button = document.getElementById(buttonId);
            if (!button) return;

            form.dataset.editingButtonId = buttonId;
            document.getElementById('modal_trigramme').value = button.dataset.trigramme;

            populateSelect('modal_fonction', memberConfig.fonctions, button.dataset.fonction);
            populateSelect('modal_armement', memberConfig.armements, button.dataset.armement);
            populateSelect('modal_equipement', memberConfig.equipements, button.dataset.equipement);
            populateSelect('modal_equipement2', memberConfig.equipements2, button.dataset.equipement2);
            populateSelect('modal_tenue', memberConfig.tenues, button.dataset.tenue);
            populateSelect('modal_gpb', memberConfig.gpbs, button.dataset.gpb);

            modal.showModal();
        }

        function populateSelect(selectId, options, selectedValue) {
            const select = document.getElementById(selectId);
            select.innerHTML = options.map(o => `<option value="${o}" ${o === selectedValue ? 'selected':''}>${o}</option>`).join('');
        }
        
        // --- DATA PERSISTENCE (SAVE/LOAD) ---
        function saveFormData() {
            try {
                const data = {};
                document.querySelectorAll('#oi-form input:not([type="file"]), #oi-form textarea, #oi-form select').forEach(field => {
                    if (field.id) data[field.id] = field.value;
                });
                data.me_list = Array.from(document.querySelectorAll('#me_container .me-input')).map(i => i.value).filter(Boolean);
                data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .collapsible-container')).map(row => ({
                    vehicle: row.querySelector('.patracdvr-vehicle-select').value,
                    members: Array.from(row.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }))
                }));
                localStorage.setItem('oiFormData', JSON.stringify(data));
            } catch (e) { console.error("Save error:", e); }
        }

        function loadFormData() {
            const dataString = localStorage.getItem('oiFormData');
            if (!dataString) return;
            try {
                const data = JSON.parse(dataString);
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && !['object', 'array'].includes(typeof data[key])) el.value = data[key];
                });
                (data.me_list || []).forEach(val => addMeField(val));
                (data.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
            } catch (e) { console.error("Load error:", e); }
        }

        // --- DRAG & DROP ---
        function enableDragAndDrop(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('draggable')) {
                    e.dataTransfer.setData('text/plain', e.target.id);
                    e.dataTransfer.effectAllowed = 'move';
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            container.addEventListener('dragend', e => {
                if (e.target.classList.contains('draggable')) e.target.classList.remove('dragging');
            });
            container.addEventListener('dragover', e => e.preventDefault());
            container.addEventListener('drop', e => {
                e.preventDefault();
                const id = e.dataTransfer.getData('text/plain');
                const draggable = document.getElementById(id);
                if (draggable && draggable.parentElement === container) {
                    const afterElement = getDragAfterElement(container, e.clientY);
                    container.insertBefore(draggable, afterElement);
                    saveFormData();
                }
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Modal Logic
            const modal = document.getElementById('editMemberModal');
            const form = document.getElementById('editMemberForm');
            form.addEventListener('submit', e => {
                e.preventDefault();
                const buttonId = form.dataset.editingButtonId;
                const button = document.getElementById(buttonId);
                if (button) {
                    button.dataset.trigramme = document.getElementById('modal_trigramme').value;
                    button.dataset.fonction = document.getElementById('modal_fonction').value;
                    button.dataset.armement = document.getElementById('modal_armement').value;
                    button.dataset.equipement = document.getElementById('modal_equipement').value;
                    button.dataset.equipement2 = document.getElementById('modal_equipement2').value;
                    button.dataset.tenue = document.getElementById('modal_tenue').value;
                    button.dataset.gpb = document.getElementById('modal_gpb').value;
                    updateMemberButtonVisuals(button);
                    saveFormData();
                }
                modal.close();
            });
            document.getElementById('modal_cancelBtn').addEventListener('click', () => modal.close());
            document.getElementById('modal_deleteBtn').addEventListener('click', () => {
                const buttonId = form.dataset.editingButtonId;
                const button = document.getElementById(buttonId);
                if(button && confirm(`Supprimer le membre ${button.dataset.trigramme} ?`)) {
                    button.remove();
                    saveFormData();
                    modal.close();
                }
            });

            // Dock Menu Logic
            const dockMenu = document.getElementById('dockMenu');
            const dockToggleBtn = document.getElementById('dockToggleBtn');
            dockToggleBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // CORRECTED: Prevents unwanted closing
                dockMenu.classList.toggle('collapsed');
                localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
            });

            // Initial setup
            addPhotoInput('adversary_photo_container', true);
            enableDragAndDrop('#time_events_container');
            document.querySelectorAll('.collapsible-header').forEach(header => header.addEventListener('click', () => header.parentElement.classList.toggle('open')));
            loadFormData();
            showStep(currentStep);
        });
        
        // --- PDF GENERATION (Unchanged from original functional version) ---
        async function buildPdf() {
            // ... (The entire buildPdf function from the previous response goes here)
        }
        async function handlePdfAction(isPreview) {
            // ... (The entire handlePdfAction function from the previous response goes here)
        }
        previewBtn.addEventListener('click', () => handlePdfAction(true));
        generatePdfBtn.addEventListener('click', () => handlePdfAction(false));
    </script>
</body>
</html>
