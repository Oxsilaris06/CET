<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial</title>
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Arial', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 10px; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 2px; font-weight: 400; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        h3 { color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; font-weight: 400; }
        .form-section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: var(--bg-interactive); color: var(--text-primary);
        }
        button {
            background-color: var(--accent-blue); color: white; padding: 12px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px; margin-top: 20px; width: 100%;
        }
        button.add-btn, button.remove-btn {
             width: auto; padding: 5px 10px; font-size: 14px; margin-top: 5px;
        }
        button.add-btn { background-color: #27ae60; }
        button.add-btn:hover { background-color: #229954; }
        button.remove-btn { background-color: #c0392b; }
        button.remove-btn:hover { background-color: #a93226; }
        
        .dynamic-list-item { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 5px; }
        .dynamic-list-item > * { flex: 1 1 auto; }
        .dynamic-list-item select, .dynamic-list-item input { min-width: 150px; }
        .dynamic-list-item button { flex-grow: 0; }
       
        .patracdvr-member-item, .time-item {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 5px;
        }
        .patracdvr-member-item > *, .time-item > * {
            flex: 1;
            margin-bottom: 0;
        }
        
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .dynamic-list-item, .patracdvr-member-item, .time-item { flex-direction: column; align-items: stretch; }
            .dynamic-list-item > *, .patracdvr-member-item > *, .time-item > * { width: 100%; margin-bottom: 10px; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Générateur d'Ordre Initial</h1>
    <button type="button" onclick="resetForm()" style="background-color: #c0392b; margin-bottom: 20px;">Réinitialiser le formulaire</button>

    <div class="form-section">
        <h2>1. SITUATION</h2>
        <label for="date_op">Date de l'opération :</label>
        <input type="text" id="date_op" placeholder="ex: 14/01/2025" oninput="saveFormData()">
        <label for="situation_generale">1.1 Générale :</label>
        <textarea id="situation_generale" rows="4" placeholder="Décrivez les faits et l'enquête..." oninput="saveFormData()"></textarea>
        <label for="situation_particuliere">1.2 Particulière :</label>
        <textarea id="situation_particuliere" rows="2" placeholder="ex: L'interpellation du mis en cause est programmée le 14/01/2025 à ANTIBES" oninput="saveFormData()"></textarea>
    </div>

    <div class="form-section">
        <h2>1.3 ADVERSAIRE(S)</h2>
        <label for="nom_adversaire">Nom/Prénom :</label>
        <input type="text" id="nom_adversaire" placeholder="Nom/Prénom" oninput="saveFormData()">
        <label for="domicile_adversaire">Domicile et Adresse de repli :</label>
        <textarea id="domicile_adversaire" rows="2" placeholder="Adresse complète..." oninput="saveFormData()"></textarea>
        <div class="dynamic-list-item">
            <label for="date_naissance">Date de naissance :</label>
            <input type="date" id="date_naissance" onchange="saveFormData()">
            <label for="lieu_naissance">Lieu de naissance :</label>
            <input type="text" id="lieu_naissance" placeholder="Ville" oninput="saveFormData()">
        </div>
        
        <label for="stature_adversaire">Description (Stature) :</label>
        <input type="text" id="stature_adversaire" placeholder="Taille (ex: 1.72m)" oninput="saveFormData()">
        <label for="ethnie_adversaire">Description (Ethnie) :</label>
        <select id="ethnie_adversaire" onchange="saveFormData()">
            <option value="Caucasien">Caucasien</option>
            <option value="Nord africain">Nord africain</option>
            <option value="Afro-antillais">Afro-antillais</option>
            <option value="Asiatique">Asiatique</option>
        </select>
        <label for="signes_particuliers_adversaire">Description (Signes particuliers) :</label>
        <input type="text" id="signes_particuliers_adversaire" placeholder="Cicatrice, tatouage..." oninput="saveFormData()">
        
        <label for="profession_adversaire">Profession :</label>
        <input type="text" id="profession_adversaire" placeholder="Profession" oninput="saveFormData()">
        <label for="antecedents_adversaire">Antécédents :</label>
        <textarea id="antecedents_adversaire" rows="2" placeholder="TAJ: BT:" oninput="saveFormData()"></textarea>
        
        <label>État d'esprit :</label>
        <div id="etat_esprit_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', 'État d\'esprit', ['Serein', 'Hostile', 'Conciliant'])">➕ Ajouter</button>
        
        <label>Attitude (Interpellations précédentes) :</label>
        <textarea id="attitude_adversaire" rows="2" placeholder="Réactions lors des précédentes interpellations" oninput="saveFormData()"></textarea>
        
        <label>Volume (Renfort) :</label>
        <div id="volume_adversaire_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', 'Volume', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕ Ajouter</button>
        
        <label>Substances :</label>
        <input type="text" id="substances_adversaire" placeholder="Alcool/Drogues..." oninput="saveFormData()">
        
        <label>Véhicules :</label>
        <div id="vehicules_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur')">➕ Ajouter</button>
        
        <label>Armes :</label>
        <div id="armes_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS')">➕ Ajouter</button>
        
        <label>Mode d'action : ME1 (+ probable)</label>
        <textarea id="mode_action_me1" rows="1" placeholder="Fuite" oninput="saveFormData()"></textarea>
        <label>Mode d'action : ME2</label>
        <textarea id="mode_action_me2" rows="1" placeholder="Rébellion" oninput="saveFormData()"></textarea>
        <label>Mode d'action : ME3</label>
        <textarea id="mode_action_me3" rows="1" placeholder="Retranchement" oninput="saveFormData()"></textarea>
        
        <label>Photos de l'adversaire :</label>
        <div id="adversaire_photos_container"></div>
        <button type="button" class="add-btn" onclick="addPhotoField('adversaire_photos_container', 'adversaire-photo-input')">➕ Ajouter</button>
    </div>

    <div class="form-section">
        <h2>1.4 ENVIRONNEMENT</h2>
        <label for="amies">Ami(e)s :</label>
        <input type="text" id="amies" placeholder="Équipes en soutien..." oninput="saveFormData()">
        <label for="terrain_info">Terrain / Environnement :</label>
        <input type="text" id="terrain_info" placeholder="Météo / Relief / Milieu..." oninput="saveFormData()">
        <label for="population">Population :</label>
        <input type="text" id="population" placeholder="Neutre" oninput="saveFormData()">
        <label for="cadre_juridique">Cadre juridique :</label>
        <input type="text" id="cadre_juridique" placeholder="Préliminaire / Flag..." oninput="saveFormData()">
    </div>

    <div class="form-section">
        <h2>2. MISSIONS du PSIG</h2>
        <textarea id="missions_psig" rows="4" placeholder="INTERPELLER L'OBJECTIF..." oninput="saveFormData()"></textarea>
    </div>

    <div class="form-section">
        <h2>3. EXÉCUTION</h2>
        <label for="date_execution">Date d'exécution :</label>
        <input type="date" id="date_execution" onchange="saveFormData()">
        <label for="heure_execution">Heure d'exécution :</label>
        <input type="time" id="heure_execution" value="06:00" onchange="saveFormData()">
        <label>Type d'action :</label>
        <div id="type_action_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('type_action_container', 'Type d\'action', ['en force', 'en souplesse'])">➕ Ajouter</button>

    </div>

    <div class="form-section">
        <h2>4. ARTICULATION</h2>
        <label for="place_chef">Place du Chef :</label>
        <input type="text" id="place_chef" placeholder="En INDIA / Avec élément interpellation..." oninput="saveFormData()">
        
        <h3>Temps d'opération (T0 - T5)</h3>
        <div id="time_events_container"></div>
        <button type="button" class="add-btn" onclick="addTimeEvent()">➕ Ajouter</button>
    </div>

    <div class="form-section">
        <h2>PATRACDVR</h2>
        <div id="patracdvr_container"></div>
        <button type="button" class="add-btn" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
    </div>
    
    <div class="form-section">
        <h2>Photos de l'opération</h2>
        <div id="operation_photos_container"></div>
        <button type="button" class="add-btn" onclick="addCustomPhotoField('operation_photos_container')">➕ Ajouter une photo</button>
    </div>

    <button id="generatePdf">Générer le PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script>
    const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', () => {
        loadFormData();
    });
    
    // Fonctions de sauvegarde et de chargement des données
    function saveFormData() {
        try {
            const data = {};
            document.querySelectorAll('input, textarea, select').forEach(field => {
                if (field.type !== 'file' && field.id) {
                    data[field.id] = field.value;
                }
            });
            
            // Sauvegarde des listes dynamiques
            ['vehicules', 'armes', 'etat_esprit', 'volume', 'type_action'].forEach(key => {
                const containerId = (document.getElementById(`${key}_adversaire_container`) ? `${key}_adversaire_container` : `${key}_container`);
                const container = document.getElementById(containerId);
                data[`${key}_list`] = Array.from(container.querySelectorAll('.dynamic-input')).map(input => input.value);
            });
            
            // Sauvegarde PATRACDVR et Temps d'opération
            data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .form-section')).map(section => ({
                vehicle: section.querySelector('.patracdvr-vehicle-select').value,
                members: Array.from(section.querySelectorAll('.patracdvr-member-item')).map(item => ({
                    trigramme: item.querySelector('.patracdvr-member-input').value,
                    equipement: item.querySelector('.patracdvr-equipement-select').value,
                    fonction: item.querySelector('.patracdvr-fonction-select').value
                }))
            }));
            
            data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
                type: item.querySelector('.time-type-select').value,
                hour: item.querySelector('.time-hour-input').value,
                description: item.querySelector('.time-description-input').value
            }));

            localStorage.setItem('oiFormData', JSON.stringify(data));
        } catch (error) {
            console.error("Erreur lors de la sauvegarde des données:", error);
        }
    }

    function loadFormData() {
        const savedData = localStorage.getItem('oiFormData');
        if (!savedData) {
            // Initialiser les champs par défaut si aucune donnée n'est sauvegardée
            addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS');
            addDynamicFieldWithSelect('etat_esprit_container', 'État d\'esprit', ['Serein', 'Hostile', 'Conciliant'], 'Serein');
            addPatracdvrRow();
            addTimeEvent('T0', '05:30', 'Déplacement tous moyens réunis...');
            addPhotoField('adversaire_photos_container', 'adversaire-photo-input');
            addCustomPhotoField('operation_photos_container', 'Cheminement');
            return;
        }

        try {
            const data = JSON.parse(savedData);
            for (const key in data) {
                const field = document.getElementById(key);
                if (field && typeof data[key] === 'string') {
                    field.value = data[key];
                }
            }

            // Chargement des listes dynamiques
            Object.keys(data).filter(k => k.endsWith('_list')).forEach(key => {
                const listName = key.replace('_list', '');
                const containerId = (document.getElementById(`${listName}_adversaire_container`) ? `${listName}_adversaire_container` : `${listName}_container`);
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                
                if (listName.match(/etat_esprit|volume|type_action/)) {
                    const options = { etat_esprit: ['Serein', 'Hostile', 'Conciliant'], volume: ['Seul', 'Famille', 'BO', 'Conjointe'], type_action: ['en force', 'en souplesse'] }[listName];
                    (data[key] || []).forEach(val => addDynamicFieldWithSelect(containerId, listName, options, val));
                } else {
                     (data[key] || []).forEach(val => addDynamicField(containerId, `${listName.slice(0, -1)}-input`, '...', val));
                }
            });

            // Chargement PATRACDVR et Temps d'opération
            document.getElementById('patracdvr_container').innerHTML = '';
            (data.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
            document.getElementById('time_events_container').innerHTML = '';
            (data.time_events || []).forEach(event => addTimeEvent(event.type, event.hour, event.description));
            
            // Initialiser les champs de photo vides car on ne peut pas sauvegarder les fichiers
            document.getElementById('adversaire_photos_container').innerHTML = '';
            addPhotoField('adversaire_photos_container', 'adversaire-photo-input');
            document.getElementById('operation_photos_container').innerHTML = '';
            addCustomPhotoField('operation_photos_container', 'Cheminement');
            addCustomPhotoField('operation_photos_container', 'Terrain');
            addCustomPhotoField('operation_photos_container', 'Porte');
        } catch (error) {
             console.error("Erreur lors du chargement des données:", error);
             resetForm();
        }
    }
    
    function resetForm() {
        if (confirm('Voulez-vous vraiment réinitialiser tout le formulaire ? Les données actuelles seront perdues.')) {
            localStorage.removeItem('oiFormData');
            // Vider les conteneurs dynamiques avant de recharger pour éviter les duplications
            ['etat_esprit_container', 'volume_adversaire_container', 'vehicules_container', 'armes_container', 'type_action_container', 'time_events_container', 'patracdvr_container', 'adversaire_photos_container', 'operation_photos_container'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
            document.querySelector('form') ? document.querySelector('form').reset() : location.reload();
            loadFormData(); // Recharger les valeurs par défaut
        }
    }
    
    // Fonctions pour ajouter des champs dynamiques
    function addDynamicFieldWithSelect(containerId, placeholder, options, value = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        const selectId = `select_${containerId}_${Math.random()}`;
        const inputId = `input_${containerId}_${Math.random()}`;

        item.innerHTML = `
            <select id="${selectId}" class="dynamic-select" onchange="document.getElementById('${inputId}').value = this.value; saveFormData()">
                <option value="">Sélectionner</option>
                ${options.map(opt => `<option value="${opt}" ${opt === value && options.includes(value) ? 'selected' : ''}>${opt}</option>`).join('')}
            </select>
            <input type="text" id="${inputId}" class="dynamic-input" placeholder="Ou valeur personnalisée" value="${value}" oninput="document.getElementById('${selectId}').value = ''; saveFormData()">
            <button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(item);
    }
    
    function addDynamicField(containerId, inputClass, placeholder, value = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `
            <input type="text" class="dynamic-input ${inputClass}" placeholder="${placeholder}" value="${value}" oninput="saveFormData()">
            <button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(item);
    }

    function addPhotoField(containerId, inputClass) {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `
            <input type="file" class="${inputClass}" data-label="Photo de l'adversaire" accept="image/*">
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">❌</button>
        `;
        container.appendChild(item);
    }
    
    function addCustomPhotoField(containerId, label = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `
            <input type="text" placeholder="Légende de la photo" class="photo-label-input" value="${label}">
            <input type="file" class="photo-input" accept="image/*">
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">❌</button>
        `;
        container.appendChild(item);
    }

    function addPatracdvrRow(vehicle = '', members = []) {
        const container = document.getElementById('patracdvr_container');
        const vehicleId = `v_${Date.now()}`;
        const row = document.createElement('div');
        row.className = 'form-section';
        row.innerHTML = `
            <div class="dynamic-list-item">
                <select class="patracdvr-vehicle-select" onchange="saveFormData()">
                    ${availableVehicles.map(v => `<option value="${v}" ${v === vehicle ? 'selected' : ''}>${v}</option>`).join('')}
                </select>
                <button type="button" class="add-btn" onclick="addPatracdvrMember('${vehicleId}')">➕ Personnel</button>
                <button type="button" class="remove-btn" onclick="this.parentElement.parentElement.remove(); saveFormData()">❌ Véhicule</button>
            </div>
            <div id="patracdvr_members_${vehicleId}"></div>
        `;
        container.appendChild(row);
        if (members.length > 0) {
            members.forEach(m => addPatracdvrMember(vehicleId, m.trigramme, m.equipement, m.fonction));
        } else {
            addPatracdvrMember(vehicleId);
        }
    }

    function addPatracdvrMember(vehicleId, trigramme = '', equipement = 'PIE', fonction = 'Inter') {
        const container = document.getElementById(`patracdvr_members_${vehicleId}`);
        const item = document.createElement('div');
        item.className = 'patracdvr-member-item';
        item.innerHTML = `
            <input type="text" class="patracdvr-member-input" placeholder="Trigramme" value="${trigramme}" oninput="saveFormData()">
            <select class="patracdvr-equipement-select" onchange="saveFormData()">
                ${['PIE', 'EFFRAC', 'LBD', 'UMP', 'G36', 'IL', 'GENL', 'MP7'].map(o => `<option value="${o}" ${o === equipement ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
            <select class="patracdvr-fonction-select" onchange="saveFormData()">
                ${['Chef inter', 'Chef dispo', 'AO', 'Inter', 'DE'].map(o => `<option value="${o}" ${o === fonction ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(item);
    }

    function addTimeEvent(type = 'T0', hour = '', description = '') {
        const container = document.getElementById('time_events_container');
        const item = document.createElement('div');
        item.className = 'time-item';
        item.innerHTML = `
            <select class="time-type-select" onchange="saveFormData()">
                ${['T0', 'T1', 'T2', 'T3', 'T4', 'T5'].map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()">
            <textarea class="time-description-input" placeholder="Description" rows="1" oninput="saveFormData()">${description}</textarea>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(item);
    }
    
    // Génération du PDF
    document.getElementById('generatePdf').addEventListener('click', async () => {
        try {
            const { jsPDF } = jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPos = margin;
            
            // S'assurer que les données sont sauvegardées avant de générer
            saveFormData();
            const formDataString = localStorage.getItem('oiFormData');
            if (!formDataString) {
                alert("Aucune donnée à générer. Veuillez remplir le formulaire.");
                return;
            }
            const formData = JSON.parse(formDataString);
            const getVal = (id) => formData[id] || 'RAS';

            const addHeaderAndFooter = (pageNumber, isLandscape = false) => {
                doc.setPage(pageNumber);
                const width = isLandscape ? pageHeight : pageWidth;
                const height = isLandscape ? pageWidth : pageHeight;
                doc.setFillColor(18, 18, 18);
                doc.rect(0, 0, width, height, 'F');
                doc.setFontSize(10);
                doc.setTextColor('#e0e0e0');
                doc.text(`Page ${pageNumber}`, width - margin, height - 20);
            };
            
            doc.deletePage(1);

            // PAGE DE GARDE
            doc.addPage('a4', 'landscape');
            const landscapeWidth = doc.internal.pageSize.getWidth();
            const landscapeHeight = doc.internal.pageSize.getHeight();
            const titleText = `Opération du ${getVal('date_op')}`;
            doc.setFontSize(70);
            const titleWidth = doc.getStringUnitWidth(titleText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            if (titleWidth > landscapeWidth - margin * 4) {
                 doc.setFontSize((landscapeWidth - margin * 4) * doc.internal.scaleFactor / doc.getStringUnitWidth(titleText));
            }
            doc.setTextColor('#5b9bd5');
            doc.text(titleText, landscapeWidth / 2, landscapeHeight / 2, { align: 'center', baseline: 'middle' });

            // FONCTIONS UTILITAIRES PDF
            const checkYPos = (space) => {
                if (yPos + space > pageHeight - margin) {
                    doc.addPage('a4', 'portrait');
                    yPos = margin;
                    return true;
                }
                return false;
            };

            const addSectionTitle = (title) => {
                doc.addPage('a4', 'portrait');
                yPos = margin;
                doc.setFontSize(27).setFont('helvetica', 'bold').setTextColor('#5b9bd5');
                const splitTitle = doc.splitTextToSize(title, pageWidth - margin * 2);
                doc.text(splitTitle, margin, yPos);
                yPos += splitTitle.length * 27 + 15;
            };

            const addText = (text) => {
                checkYPos(30);
                doc.setFontSize(12).setFont('helvetica', 'normal').setTextColor('#e0e0e0');
                const lines = doc.splitTextToSize(text, pageWidth - margin * 2);
                doc.text(lines, margin, yPos);
                yPos += lines.length * 15 + 10;
            };
            
            const tableConfig = {
                theme: 'grid',
                styles: { fontSize: 15, cellPadding: 5, textColor: [224, 224, 224], fillColor: [30, 30, 30] },
                headStyles: { fontSize: 15, fillColor: [42, 42, 42], textColor: [255, 255, 255], fontStyle: 'bold' },
                didDrawPage: (data) => { yPos = data.cursor.y; },
                margin: { left: margin, right: margin }
            };

            const renderAutoTable = (config) => {
                checkYPos(60); // Hauteur minimale pour un en-tête et une ligne
                doc.autoTable({ startY: yPos, ...tableConfig, ...config });
                yPos = doc.autoTable.previous.finalY + 20;
            };

            // GÉNÉRATION DU CONTENU
            addSectionTitle("1. SITUATION");
            addText(getVal('situation_generale'));
            addText(getVal('situation_particuliere'));
            
            renderAutoTable({
                head: [['ADVERSAIRE', 'DÉTAILS']],
                body: [
                    ['Nom/Prénom', getVal('nom_adversaire')],
                    ['Domicile', getVal('domicile_adversaire')],
                    ['Naissance', `${getVal('date_naissance')} à ${getVal('lieu_naissance')}`],
                    ['Description', [getVal('stature_adversaire'), getVal('ethnie_adversaire'), getVal('signes_particuliers_adversaire')].join(' / ')],
                    ['Profession', getVal('profession_adversaire')],
                    ['Antécédents', getVal('antecedents_adversaire')],
                    ['État d\'esprit', (formData.etat_esprit_list || []).join(', ') || 'RAS'],
                    ['Attitude', getVal('attitude_adversaire')],
                    ['Volume', (formData.volume_list || []).join(', ') || 'RAS'],
                    ['Substances', getVal('substances_adversaire')],
                    ['Véhicules', (formData.vehicules_list || []).join(', ') || 'RAS'],
                    ['Armes', (formData.armes_list || []).join(', ') || 'RAS'],
                    ['Modes d\'action', `ME1: ${getVal('mode_action_me1')}\nME2: ${getVal('mode_action_me2')}\nME3: ${getVal('mode_action_me3')}`],
                ]
            });

            await addImagesFromContainer('adversaire_photos_container');
            
            renderAutoTable({
                head: [['ENVIRONNEMENT', 'DÉTAILS']],
                body: [
                    ['Ami(e)s', getVal('amies')],
                    ['Terrain', getVal('terrain_info')],
                    ['Population', getVal('population')],
                    ['Cadre juridique', getVal('cadre_juridique')],
                ]
            });
            
            addSectionTitle("2. MISSIONS du PSIG");
            addText(getVal('missions_psig'));

            addSectionTitle("3. EXÉCUTION");
            renderAutoTable({ body: [['Date', getVal('date_execution')], ['Heure', getVal('heure_execution')], ['Type d\'action', (formData.type_action_list || []).join(', ') || 'RAS']] });

            addSectionTitle("4. ARTICULATION");
            addText(`Place du Chef: ${getVal('place_chef')}`);
            renderAutoTable({ head: [['Type', 'Heure', 'Description']], body: (formData.time_events || []).map(e => [e.type, e.hour || 'RAS', e.description || 'RAS']) });
            
            addSectionTitle("PATRACDVR");
            (formData.patracdvr_rows || []).forEach(row => {
                const members = row.members.filter(m => m.trigramme);
                if (members.length > 0) {
                    renderAutoTable({ head: [[row.vehicle, 'Équipement', 'Fonction']], body: members.map(m => [m.trigramme, m.equipement, m.fonction]) });
                }
            });

            await addImagesFromContainer('operation_photos_container', true);
            
            // Finalisation des en-têtes/pieds de page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                const isLandscape = doc.getPageInfo(i).pageContext.mediaBox.topRight[0] > doc.getPageInfo(i).pageContext.mediaBox.bottomRight[1];
                addHeaderAndFooter(i, isLandscape);
            }
            
            // Sauvegarde
            const fileName = `OI_${getVal('date_op').replace(/\//g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
            doc.save(fileName);

        } catch (error) {
            console.error("Erreur lors de la génération du PDF:", error);
            alert("Une erreur est survenue lors de la génération du PDF. Vérifiez la console pour plus de détails (touche F12).");
        }

        async function addImagesFromContainer(containerId, newPage = false) {
            const inputs = Array.from(document.querySelectorAll(`#${containerId} input[type="file"]`)).filter(i => i.files.length > 0);
            if (inputs.length === 0) return;

            if (newPage) addSectionTitle("Photos de l'opération");
            
            const imagePromises = inputs.map(input => {
                const label = input.parentElement.querySelector('.photo-label-input')?.value || input.dataset.label || 'Image';
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve({ src: e.target.result, label });
                    reader.readAsDataURL(input.files[0]);
                });
            });
            const images = await Promise.all(imagePromises);

            const drawImageRow = async (rowData) => {
                const padding = 10;
                const availableWidth = pageWidth - margin * 2;
                const imageWidth = (availableWidth - (padding * (rowData.length - 1))) / rowData.length;
                let maxHeightInRow = 0;
                const processed = [];

                for (const data of rowData) {
                    const img = new Image();
                    img.src = data.src;
                    await new Promise(r => img.onload = r);
                    const imageHeight = imageWidth * (img.height / img.width);
                    maxHeightInRow = Math.max(maxHeightInRow, imageHeight);
                    processed.push({ img, ...data, width: imageWidth, height: imageHeight });
                }

                checkYPos(maxHeightInRow + 30);
                let xPos = margin;
                for (const p of processed) {
                    doc.addImage(p.img, 'JPEG', xPos, yPos, p.width, p.height);
                    doc.setFontSize(9).setTextColor('#95a5a6').text(p.label, xPos + p.width / 2, yPos + p.height + 15, { align: 'center' });
                    xPos += p.width + padding;
                }
                yPos += maxHeightInRow + 30;
            };

            for (let i = 0; i < images.length; i += 2) {
                await drawImageRow(images.slice(i, i + 2));
            }
        }
    });
</script>

</body>
</html>
