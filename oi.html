<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial</title>
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Arial', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; transition: background-color 0.5s, color 0.5s; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 10px; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 2px; font-weight: 400; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        h3 { color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; font-weight: 400; }
        .form-section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: var(--bg-interactive); color: var(--text-primary);
        }
        textarea { resize: vertical; }
        button {
            background-color: var(--accent-blue); color: white; padding: 12px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px; margin-top: 20px;
        }
        button.add-btn { background-color: #27ae60; padding: 5px 10px; font-size: 14px; margin-top: 5px; }
        button.add-btn:hover { background-color: #229954; }
        button.remove-btn { background-color: #c0392b; padding: 5px 10px; font-size: 14px; margin-top: 5px; }
        button.remove-btn:hover { background-color: #a93226; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .time-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .time-item select, .time-item input, .time-item textarea { flex-grow: 1; margin: 0; }
        .patracdvr-member-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .patracdvr-member-item select { margin-bottom: 0; }
        .patracdvr-member-item input { margin-bottom: 0; }
        
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .grid-container { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            .dynamic-list-item { flex-direction: column; align-items: stretch; }
            .dynamic-list-item input, .dynamic-list-item select, .dynamic-list-item button { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Générateur d'Ordre Initial</h1>
    <button type="button" onclick="resetForm()">Réinitialiser le formulaire</button>

    <div class="form-section">
        <h2>1. SITUATION</h2>
        <label for="date_op">Date de l'opération :</label>
        <input type="text" id="date_op" placeholder="ex: 14/01/2025">
        <label for="situation_generale">1.1 Générale :</label>
        <textarea id="situation_generale" rows="4" placeholder="Décrivez les faits et l'enquête..."></textarea>
        <label for="situation_particuliere">1.2 Particulière :</label>
        <textarea id="situation_particuliere" rows="2" placeholder="ex: L'interpellation du mis en cause est programmée le 14/01/2025 à ANTIBES"></textarea>
    </div>

    <div class="form-section">
        <h2>1.3 ADVERSAIRE(S)</h2>
        <label for="nom_adversaire">Nom/Prénom :</label>
        <input type="text" id="nom_adversaire" placeholder="Nom/Prénom">
        <label for="domicile_adversaire">Domicile et Adresse de repli :</label>
        <textarea id="domicile_adversaire" rows="2" placeholder="Adresse complète..."></textarea>
        <div class="dynamic-list-item">
            <label for="date_naissance">Date de naissance :</label>
            <input type="date" id="date_naissance">
            <label for="lieu_naissance">Lieu de naissance :</label>
            <input type="text" id="lieu_naissance" placeholder="Ville">
        </div>
        
        <label for="stature_adversaire">Description (Stature) :</label>
        <input type="text" id="stature_adversaire" placeholder="Taille (ex: 1.72m)">
        <label for="ethnie_adversaire">Description (Ethnie) :</label>
        <select id="ethnie_adversaire">
            <option value="Caucasien">Caucasien</option>
            <option value="Nord africain">Nord africain</option>
            <option value="Afro-antillais">Afro-antillais</option>
            <option value="Asiatique">Asiatique</option>
        </select>
        <label for="signes_particuliers_adversaire">Description (Signes particuliers) :</label>
        <input type="text" id="signes_particuliers_adversaire" placeholder="Cicatrice, tatouage...">
        
        <label for="profession_adversaire">Profession :</label>
        <input type="text" id="profession_adversaire" placeholder="Profession">
        <label for="antecedents_adversaire">Antécédents :</label>
        <textarea id="antecedents_adversaire" rows="2" placeholder="TAJ: BT:"></textarea>
        
        <label for="etat_esprit_adversaire_label">État d'esprit :</label>
        <div id="etat_esprit_container">
            <div class="dynamic-list-item">
                <select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
                    <option value="">Sélectionner</option>
                    <option value="Serein">Serein</option>
                    <option value="Hostile">Hostile</option>
                    <option value="Conciliant">Conciliant</option>
                </select>
                <input type="text" class="dynamic-input" placeholder="Ajouter un état d'esprit" onchange="this.previousElementSibling.value=this.value; saveFormData()">
                <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', 'État d\'esprit', ['Serein', 'Hostile', 'Conciliant'])">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        
        <label for="attitude_adversaire">Attitude (Interpellations précédentes) :</label>
        <textarea id="attitude_adversaire" rows="2" placeholder="Réactions lors des précédentes interpellations"></textarea>
        
        <label for="volume_adversaire_label">Volume (Renfort) :</label>
        <div id="volume_adversaire_container">
            <div class="dynamic-list-item">
                <select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
                    <option value="">Sélectionner</option>
                    <option value="Seul">Seul</option>
                    <option value="Famille">Famille</option>
                    <option value="BO">BO</option>
                    <option value="Conjointe">Conjointe</option>
                </select>
                <input type="text" class="dynamic-input" placeholder="Ajouter un volume" onchange="this.previousElementSibling.value=this.value; saveFormData()">
                <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', 'Volume', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        
        <label for="substances_adversaire">Substances :</label>
        <input type="text" id="substances_adversaire" placeholder="Alcool/Drogues...">
        
        <label for="vehicules_container_label">Véhicules :</label>
        <div id="vehicules_container">
            <div class="dynamic-list-item">
                <input type="text" class="vehicule-input" placeholder="Immat modèle couleur">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur')">➕</button>
        
        <label for="armes_container_label">Armes :</label>
        <div id="armes_container">
            <div class="dynamic-list-item">
                <input type="text" class="arme-input" value="RAS" placeholder="Armes (si connue) ou RAS">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS')">➕</button>
        
        <label for="mode_action_me1">Mode d'action : ME1 (+ probable)</label>
        <textarea id="mode_action_me1" rows="1" placeholder="Fuite"></textarea>
        <label for="mode_action_me2">Mode d'action : ME2</label>
        <textarea id="mode_action_me2" rows="1" placeholder="Rébellion"></textarea>
        <label for="mode_action_me3">Mode d'action : ME3</label>
        <textarea id="mode_action_me3" rows="1" placeholder="Retranchement"></textarea>
        
        <label for="adversaire_photos_label">Photos de l'adversaire :</label>
        <div id="adversaire_photos_container">
            <div class="dynamic-list-item">
                <input type="file" class="adversaire-photo-input" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addPhotoField('adversaire_photos_container', 'adversaire-photo-input')">➕</button>
    </div>

    <div class="form-section">
        <h2>1.4 ENVIRONNEMENT</h2>
        <label for="amies">1.4 Ami(e)s :</label>
        <input type="text" id="amies" placeholder="Équipes en soutien...">
        <label for="terrain_info">1.5 Terrain / Environnement :</label>
        <input type="text" id="terrain_info" placeholder="Météo / Relief / Milieu...">
        <label for="population">1.6 Population :</label>
        <input type="text" id="population" placeholder="Neutre">
        <label for="cadre_juridique">1.7 Cadre juridique :</label>
        <input type="text" id="cadre_juridique" placeholder="Préliminaire / Flag...">
    </div>

    <div class="form-section">
        <h2>2. MISSIONS du PSIG</h2>
        <textarea id="missions_psig" rows="4" placeholder="INTERPELLER L'OBJECTIF..."></textarea>
    </div>

    <div class="form-section">
        <h2>3. EXÉCUTION</h2>
        <label for="date_execution">Date d'exécution :</label>
        <input type="date" id="date_execution">
        <label for="heure_execution">Heure d'exécution :</label>
        <input type="time" id="heure_execution" value="06:00">
        <label for="type_action_label">Type d'action :</label>
        <div id="type_action_container">
            <div class="dynamic-list-item">
                <select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
                    <option value="en force">en force</option>
                    <option value="en souplesse">en souplesse</option>
                </select>
                <input type="text" class="dynamic-input" placeholder="Ajouter un type d'action" onchange="this.previousElementSibling.value=this.value; saveFormData()">
                <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('type_action_container', 'Type d\'action', ['en force', 'en souplesse'])">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2>4. ARTICULATION</h2>
        <label for="place_chef">Place du Chef :</label>
        <input type="text" id="place_chef" placeholder="En INDIA / Avec élément interpellation...">
        
        <h3 style="margin-top: 20px;">Temps d'opération (T0 - T5)</h3>
        <div id="time_events_container">
            <div class="time-item">
                <select class="time-type-select" onchange="saveFormData()">
                    <option value="T0">T0</option><option value="T1">T1</option><option value="T2">T2</option><option value="T3">T3</option><option value="T4">T4</option><option value="T5">T5</option>
                </select>
                <input type="time" class="time-hour-input" onchange="saveFormData()">
                <textarea class="time-description-input" placeholder="Description de l'événement" rows="1" onchange="saveFormData()"></textarea>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addTimeEvent()">➕</button>
    </div>

    <div class="form-section">
        <h2>PATRACDVR</h2>
        <div id="patracdvr_container">
        </div>
        <button type="button" class="add-btn" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
    </div>
    
    <div class="form-section">
        <h2>Photos de l'opération</h2>
        <div id="operation_photos_container">
            <div class="dynamic-list-item">
                <label>Cheminement :</label>
                <input type="file" class="photo-input" data-label="Cheminement" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
            <div class="dynamic-list-item">
                <label>Terrain :</label>
                <input type="file" class="photo-input" data-label="Terrain" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
            <div class="dynamic-list-item">
                <label>Porte :</label>
                <input type="file" class="photo-input" data-label="Porte" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addPhotoField('operation_photos_container')">➕</button>
    </div>

    <button id="generatePdf">Générer le PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script>
    const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];

    document.addEventListener('DOMContentLoaded', (event) => {
        loadFormData();
    });

    function saveFormData() {
        const data = {};
        document.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.type !== 'file' && field.id) {
                data[field.id] = field.value;
            }
        });
        
        data['vehicules_list'] = Array.from(document.querySelectorAll('.vehicule-input')).map(input => input.value);
        data['armes_list'] = Array.from(document.querySelectorAll('.arme-input')).map(input => input.value);
        
        data['etat_esprit_list'] = Array.from(document.querySelectorAll('#etat_esprit_container .dynamic-select')).map(s => s.value);
        data['volume_list'] = Array.from(document.querySelectorAll('#volume_adversaire_container .dynamic-select')).map(s => s.value);
        data['type_action_list'] = Array.from(document.querySelectorAll('#type_action_container .dynamic-select')).map(s => s.value);
        
        data['patracdvr_rows'] = [];
        document.querySelectorAll('#patracdvr_container > .form-section').forEach(section => {
            const vehicle = section.querySelector('.patracdvr-vehicle-select').value;
            const members = Array.from(section.querySelectorAll('.patracdvr-member-input')).map(input => {
                const item = input.closest('.patracdvr-member-item');
                return {
                    trigramme: input.value,
                    equipement: item.querySelector('.patracdvr-equipement-select').value,
                    fonction: item.querySelector('.patracdvr-fonction-select').value
                };
            });
            data['patracdvr_rows'].push({ vehicle, members });
        });
        
        data['time_events'] = [];
        document.querySelectorAll('#time_events_container > .time-item').forEach(item => {
            data['time_events'].push({
                type: item.querySelector('.time-type-select').value,
                hour: item.querySelector('.time-hour-input').value,
                description: item.querySelector('.time-description-input').value
            });
        });

        localStorage.setItem('oiFormData', JSON.stringify(data));
    }

    function loadFormData() {
        const savedData = localStorage.getItem('oiFormData');
        if (savedData) {
            const data = JSON.parse(savedData);
            for (const key in data) {
                const field = document.getElementById(key);
                if (field) {
                    field.value = data[key];
                }
            }

            document.getElementById('vehicules_container').innerHTML = '';
            if (data['vehicules_list'] && data['vehicules_list'].length > 0) {
                data['vehicules_list'].forEach(vehicule => addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur', vehicule));
            } else {
                addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur');
            }

            document.getElementById('armes_container').innerHTML = '';
            if (data['armes_list'] && data['armes_list'].length > 0) {
                data['armes_list'].forEach(arme => addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', arme));
            } else {
                addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS');
            }

            loadDynamicSelectField('etat_esprit_container', data['etat_esprit_list'], ['Serein', 'Hostile', 'Conciliant']);
            loadDynamicSelectField('volume_adversaire_container', data['volume_list'], ['Seul', 'Famille', 'BO', 'Conjointe']);
            loadDynamicSelectField('type_action_container', data['type_action_list'], ['en force', 'en souplesse']);

            document.getElementById('patracdvr_container').innerHTML = '';
            if (data['patracdvr_rows'] && data['patracdvr_rows'].length > 0) {
                data['patracdvr_rows'].forEach(row => {
                    addPatracdvrRow(row.vehicle, row.members);
                });
            } else {
                addPatracdvrRow('Sharan', [{trigramme: '', equipement: 'PIE', fonction: 'Inter'}]);
                addPatracdvrRow('Kodiaq', [{trigramme: '', equipement: 'LBD', fonction: 'AO'}]);
            }

            document.getElementById('time_events_container').innerHTML = '';
            if (data['time_events'] && data['time_events'].length > 0) {
                data['time_events'].forEach(event => addTimeEvent(event.type, event.hour, event.description));
            } else {
                addTimeEvent('T0', '05:30', 'Déplacement tous moyens réunis...');
            }

        } else {
            addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur');
            addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS');
            addDynamicFieldWithSelect('etat_esprit_container', 'État d\'esprit', ['Serein', 'Hostile', 'Conciliant']);
            addDynamicFieldWithSelect('volume_adversaire_container', 'Volume', ['Seul', 'Famille', 'BO', 'Conjointe']);
            addDynamicFieldWithSelect('type_action_container', 'Type d\'action', ['en force', 'en souplesse']);
            addPatracdvrRow('Sharan', [{trigramme: '', equipement: 'PIE', fonction: 'Inter'}]);
            addPatracdvrRow('Kodiaq', [{trigramme: '', equipement: 'LBD', fonction: 'AO'}]);
            addTimeEvent('T0', '05:30', 'Déplacement tous moyens réunis...');
        }
    }

    function loadDynamicSelectField(containerId, values, initialOptions) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (values && values.length > 0) {
            values.forEach(val => {
                addDynamicFieldWithSelect(containerId, '', initialOptions, val);
            });
        } else {
            addDynamicFieldWithSelect(containerId, '', initialOptions);
        }
    }

    function resetForm() {
        if (confirm('Voulez-vous vraiment réinitialiser tout le formulaire ?')) {
            localStorage.removeItem('oiFormData');
            location.reload();
        }
    }

    function addDynamicFieldWithSelect(containerId, placeholder, initialOptions, selectedValue = '') {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        
        const selectHtml = `<select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
            <option value="">Sélectionner</option>
            ${initialOptions.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}
        </select>`;
        
        newField.innerHTML = `${selectHtml}
            <input type="text" class="dynamic-input" placeholder="Ajouter un ${placeholder.toLowerCase()}" onchange="this.previousElementSibling.value=this.value; saveFormData()">
            <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('${containerId}', '${placeholder}', ['${initialOptions.join("','")}'])">➕</button>
            <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(newField);
        saveFormData();
    }
    
    function addDynamicField(containerId, inputClass, placeholder, defaultValue = '') {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        newField.innerHTML = `<input type="text" class="${inputClass}" placeholder="${placeholder}" value="${defaultValue}" onchange="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>`;
        container.appendChild(newField);
        saveFormData();
    }
    
    function addPhotoField(containerId) {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        newField.innerHTML = `<input type="file" class="photo-input" data-label="Autre" accept="image/*" onchange="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>`;
        container.appendChild(newField);
        saveFormData();
    }

    function addPatracdvrRow(vehicle = '', membersData = []) {
        const container = document.getElementById('patracdvr_container');
        const vehicleToAdd = vehicle || availableVehicles.find(v => !document.querySelector(`.patracdvr-vehicle-select[value="${v}"]`));

        if (!vehicleToAdd) {
            alert('Tous les véhicules sont déjà utilisés.');
            return;
        }

        const vehicleId = vehicleToAdd.replace(/\s/g, '');
        const row = document.createElement('div');
        row.className = 'form-section';
        const vehicleSelectHtml = `<select class="patracdvr-vehicle-select" onchange="updatePatracdvrRow(this)">` +
                              availableVehicles.map(v => `<option value="${v}" ${v === vehicleToAdd ? 'selected' : ''}>${v}</option>`).join('') + `</select>`;
        row.innerHTML = `
            <div>
                <h3>Véhicule : ${vehicleSelectHtml}</h3>
                <div id="patracdvr_members_${vehicleId}"></div>
                <button type="button" class="add-btn" onclick="addPatracdvrMember('${vehicleId}')">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); updateAllPatracdvrRows(); saveFormData()">❌</button>
            </div>
        `;
        container.appendChild(row);

        if (membersData.length > 0) {
            membersData.forEach(member => addPatracdvrMember(vehicleId, member.trigramme, member.equipement, member.fonction));
        } else {
            addPatracdvrMember(vehicleId, '', 'PIE', 'Inter');
        }
        updateAllPatracdvrRows();
        saveFormData();
    }
    
    function updatePatracdvrRow(selectElement) {
        const newVehicleId = selectElement.value.replace(/\s/g, '');
        selectElement.closest('.form-section').querySelector('[id^="patracdvr_members_"]').id = `patracdvr_members_${newVehicleId}`;
        updateAllPatracdvrRows();
        saveFormData();
    }

    function updateAllPatracdvrRows() {
        const usedVehicles = new Set();
        document.querySelectorAll('.patracdvr-vehicle-select').forEach(select => {
            if (select.value) {
                usedVehicles.add(select.value);
            }
        });
        document.querySelectorAll('.patracdvr-vehicle-select').forEach(select => {
            const currentValue = select.value;
            const newOptions = availableVehicles.map(v => `<option value="${v}" ${v === currentValue ? 'selected' : ''} ${usedVehicles.has(v) && v !== currentValue ? 'disabled' : ''}>${v}</option>`).join('');
            select.innerHTML = newOptions;
        });
    }

    function addPatracdvrMember(vehicleId, trigramme = '', equipement = '', fonction = '') {
        const container = document.getElementById(`patracdvr_members_${vehicleId}`);
        if (!container) return;
        const equipementOptions = ['PIE', 'EFFRAC', 'LBD', 'UMP', 'G36', 'IL', 'GENL', 'MP7'];
        const fonctionOptions = ['Chef inter', 'Chef dispo', 'AO', 'Inter', 'DE'];
        
        const member = document.createElement('div');
        member.className = 'patracdvr-member-item';
        member.innerHTML = `
            <input type="text" class="patracdvr-member-input" placeholder="Trigramme" value="${trigramme}" onchange="saveFormData()">
            <select class="patracdvr-equipement-select" onchange="saveFormData()">
                ${equipementOptions.map(o => `<option value="${o}" ${o === equipement ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
            <select class="patracdvr-fonction-select" onchange="saveFormData()">
                ${fonctionOptions.map(o => `<option value="${o}" ${o === fonction ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
            <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(member);
        saveFormData();
    }

    function addTimeEvent(type = 'T0', hour = '', description = '') {
        const container = document.getElementById('time_events_container');
        const event = document.createElement('div');
        event.className = 'time-item';
        const timeTypes = ['T0', 'T1', 'T2', 'T3', 'T4', 'T5'];
        event.innerHTML = `
            <select class="time-type-select" onchange="saveFormData()">
                ${timeTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()">
            <textarea class="time-description-input" placeholder="Description de l'événement" rows="1" onchange="saveFormData()">${description}</textarea>
            <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(event);
        saveFormData();
    }

    document.getElementById('generatePdf').addEventListener('click', async () => {
        const doc = new jspdf.jsPDF('portrait', 'pt', 'a4');
        const margin = 50;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let yPos = margin;

        const addHeaderAndFooter = () => {
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            doc.setFontSize(10);
            doc.setFont('Helvetica', 'normal');
            doc.setTextColor('#e0e0e0');
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - 70, pageHeight - 20);
        };
        
        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/fonts/lato-regular/lato-regular.ttf', 'Lato', 'normal');
        doc.addFont('https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/fonts/lato-bold/lato-bold.ttf', 'Lato', 'bold');
        
        const addSectionTitle = (title) => {
            if (doc.internal.getNumberOfPages() > 1 || yPos > margin) {
                doc.addPage();
            }
            yPos = margin;
            addHeaderAndFooter();
            doc.setFontSize(18);
            doc.setFont('Lato', 'bold');
            doc.setTextColor('#5b9bd5');
            doc.text(title, margin, yPos);
            yPos += 30;
        };

        const addSubsectionTitle = (title) => {
            if (yPos > margin) {
                doc.addPage();
            }
            yPos = margin;
            addHeaderAndFooter();
            doc.setFontSize(18);
            doc.setFont('Lato', 'bold');
            doc.setTextColor('#5b9bd5');
            doc.text(title, margin, yPos);
            yPos += 30;
        };

        const addText = (label, value) => {
            if (!value) return;

            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = margin;
                addHeaderAndFooter();
            }
            
            doc.setFontSize(14);
            doc.setFont('Lato', 'bold');
            doc.setTextColor('#e0e0e0');
            let labelText = `${label}: `;
            let labelWidth = doc.getStringUnitWidth(labelText) * doc.getFontSize();
            doc.text(labelText, margin, yPos);
            
            doc.setFontSize(14);
            doc.setFont('Lato', 'normal');
            let valueText = value;
            let textWidth = pageWidth - margin * 2 - labelWidth;
            let valueLines = doc.splitTextToSize(valueText, textWidth);
            
            doc.text(valueLines, margin + labelWidth, yPos);
            yPos += (valueLines.length * 15) + 5;
        };
        
        const addPhoto = async (fileInput, title) => {
            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => reader.onload = resolve);
                const img = new Image();
                img.src = reader.result;
                await new Promise(resolve => img.onload = resolve);
                
                const imgWidth = pageWidth - margin * 2;
                const imgHeight = (img.height * imgWidth) / img.width;

                addSubsectionTitle(title);
                
                doc.addImage(reader.result, 'JPEG', margin, yPos, imgWidth, imgHeight);
                yPos += imgHeight + 20;
            }
        };

        addHeaderAndFooter();
        doc.setFontSize(22);
        doc.setFont('Lato', 'bold');
        doc.setTextColor('#5b9bd5');
        doc.text("OPÉRATION DE POLICE JUDICIAIRE", pageWidth / 2, 40, { align: 'center' });
        
        // 1. SITUATION
        addSectionTitle("1. SITUATION");
        addSubsectionTitle("1.1 Générale");
        addText(`Date de l'opération`, document.getElementById('date_op').value);
        addText("Contenu", document.getElementById('situation_generale').value);
        
        addSubsectionTitle("1.2 Particulière");
        addText("Contenu", document.getElementById('situation_particuliere').value);

        // 1.3 ADVERSAIRE
        addSectionTitle("1.3 ADVERSAIRE(S)");
        addText('Nom/Prénom', document.getElementById('nom_adversaire').value);
        addText('Domicile et Adresse de repli', document.getElementById('domicile_adversaire').value);
        addText('Date/Lieu de naissance', `${document.getElementById('date_naissance').value} à ${document.getElementById('lieu_naissance').value}`);
        addText('Description', `${document.getElementById('stature_adversaire').value} / ${document.getElementById('ethnie_adversaire').value} / ${document.getElementById('signes_particuliers_adversaire').value}`);
        addText('Profession', document.getElementById('profession_adversaire').value);
        addText('Antécédents', document.getElementById('antecedents_adversaire').value);
        addText('État d\'esprit', Array.from(document.querySelectorAll('#etat_esprit_container .dynamic-select')).map(s => s.value).filter(val => val).join(', '));
        addText('Attitude', document.getElementById('attitude_adversaire').value);
        addText('Volume', Array.from(document.querySelectorAll('#volume_adversaire_container .dynamic-select')).map(s => s.value).filter(val => val).join(', '));
        addText('Substances', document.getElementById('substances_adversaire').value);
        addText('Véhicules', Array.from(document.querySelectorAll('.vehicule-input')).map(input => input.value).filter(val => val).join(', '));
        addText('Armes', Array.from(document.querySelectorAll('.arme-input')).map(input => input.value).filter(val => val).join(', '));
        addText('Modes d\'actions', `ME1: ${document.getElementById('mode_action_me1').value}`);
        addText('', `ME2: ${document.getElementById('mode_action_me2').value}`);
        addText('', `ME3: ${document.getElementById('mode_action_me3').value}`);
        
        const photoAdversaireInputs = document.querySelectorAll('#adversaire_photos_container input[type="file"]');
        for (const input of photoAdversaireInputs) {
            await addPhoto(input, "Photo de l'adversaire");
        }

        // 1.4 ENVIRONNEMENT
        addSectionTitle("1.4 ENVIRONNEMENT");
        addText("Ami(e)s", document.getElementById('amies').value);
        addText("Terrain / Environnement", document.getElementById('terrain_info').value);
        addText("Population", document.getElementById('population').value);
        addText("Cadre juridique", document.getElementById('cadre_juridique').value);
        
        // 2. MISSIONS du PSIG
        addSectionTitle("2. MISSIONS du PSIG");
        addText("Contenu", document.getElementById('missions_psig').value);

        // 3. EXÉCUTION
        addSectionTitle("3. EXÉCUTION");
        addText("Date d'exécution", document.getElementById('date_execution').value);
        addText("Heure d'exécution", document.getElementById('heure_execution').value);
        addText("Type d'action", Array.from(document.querySelectorAll('#type_action_container .dynamic-select')).map(s => s.value).filter(val => val).join(', '));
        
        // 4. ARTICULATION
        addSectionTitle("4. ARTICULATION");
        addText("Place du Chef", document.getElementById('place_chef').value);
        
        // Temps d'opération
        addSubsectionTitle("Temps d'opération (T0 - T5)");
        const timeEvents = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => {
            return [
                item.querySelector('.time-type-select').value,
                item.querySelector('.time-hour-input').value,
                item.querySelector('.time-description-input').value
            ];
        });
        if (timeEvents.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Type', 'Heure', 'Description']],
                body: timeEvents,
                theme: 'plain',
                styles: { fontSize: 13, cellPadding: 5, textColor: [224, 224, 224], fillColor: [30, 30, 30], font: 'Lato', fontStyle: 'normal' },
                headStyles: { fillColor: [42, 42, 42], textColor: [255, 255, 255], font: 'Lato', fontStyle: 'bold' },
                didDrawPage: (data) => { yPos = data.cursor.y + 10; }
            });
        }

        // PATRACDVR
        addSectionTitle("PATRACDVR");
        const patracdvrData = [];
        document.querySelectorAll('#patracdvr_container > .form-section').forEach(section => {
            const vehicle = section.querySelector('.patracdvr-vehicle-select').value;
            const members = Array.from(section.querySelectorAll('.patracdvr-member-input')).map(input => {
                const item = input.closest('.patracdvr-member-item');
                const equipement = item.querySelector('.patracdvr-equipement-select').value;
                const fonction = item.querySelector('.patracdvr-fonction-select').value;
                return [input.value, equipement, fonction];
            });
            patracdvrData.push({vehicle, members});
        });
        
        for (const row of patracdvrData) {
            if (row.members.some(m => m[0])) {
                if (yPos > pageHeight - 100) {
                     doc.addPage();
                     yPos = margin;
                     addHeaderAndFooter();
                }
                doc.autoTable({
                    startY: yPos,
                    head: [[`${row.vehicle}`, 'Équipement', 'Fonction']],
                    body: row.members,
                    theme: 'plain',
                    styles: { fontSize: 13, cellPadding: 5, textColor: [224, 224, 224], fillColor: [30, 30, 30], font: 'Lato', fontStyle: 'normal' },
                    headStyles: { fillColor: [42, 42, 42], textColor: [255, 255, 255], font: 'Lato', fontStyle: 'bold' },
                    didDrawPage: (data) => { yPos = data.cursor.y + 10; }
                });
                yPos += 10;
            }
        }
        
        const photoInputs = document.querySelectorAll('#operation_photos_container input[type="file"]');
        for (const input of photoInputs) {
            const title = input.getAttribute('data-label') || "Photo d'opération";
            await addPhoto(input, title);
        }

        doc.save('ordre_initial.pdf');
    });
</script>

</body>
</html>
        <label for="situation_particuliere">1.2 Particulière :</label>
        <textarea id="situation_particuliere" rows="2" placeholder="ex: L'interpellation du mis en cause est programmée le 14/01/2025 à ANTIBES"></textarea>
    </div>

    <div class="form-section">
        <h2>1.3 ADVERSAIRE(S)</h2>
        <label for="nom_adversaire">Nom/Prénom :</label>
        <input type="text" id="nom_adversaire" placeholder="Nom/Prénom">
        <label for="domicile_adversaire">Domicile et Adresse de repli :</label>
        <textarea id="domicile_adversaire" rows="2" placeholder="Adresse complète..."></textarea>
        <div class="dynamic-list-item">
            <label for="date_naissance">Date de naissance :</label>
            <input type="date" id="date_naissance">
            <label for="lieu_naissance">Lieu de naissance :</label>
            <input type="text" id="lieu_naissance" placeholder="Ville">
        </div>
        
        <label for="stature_adversaire">Description (Stature) :</label>
        <input type="text" id="stature_adversaire" placeholder="Taille (ex: 1.72m)">
        <label for="ethnie_adversaire">Description (Ethnie) :</label>
        <select id="ethnie_adversaire">
            <option value="Caucasien">Caucasien</option>
            <option value="Nord africain">Nord africain</option>
            <option value="Afro-antillais">Afro-antillais</option>
            <option value="Asiatique">Asiatique</option>
        </select>
        <label for="signes_particuliers_adversaire">Description (Signes particuliers) :</label>
        <input type="text" id="signes_particuliers_adversaire" placeholder="Cicatrice, tatouage...">
        
        <label for="profession_adversaire">Profession :</label>
        <input type="text" id="profession_adversaire" placeholder="Profession">
        <label for="antecedents_adversaire">Antécédents :</label>
        <textarea id="antecedents_adversaire" rows="2" placeholder="TAJ: BT:"></textarea>
        
        <label for="etat_esprit_adversaire_label">État d'esprit :</label>
        <div id="etat_esprit_container">
            <div class="dynamic-list-item">
                <select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
                    <option value="">Sélectionner</option>
                    <option value="Serein">Serein</option>
                    <option value="Hostile">Hostile</option>
                    <option value="Conciliant">Conciliant</option>
                </select>
                <input type="text" class="dynamic-input" placeholder="Ajouter un état d'esprit" onchange="this.previousElementSibling.value=this.value; saveFormData()">
                <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', 'État d\'esprit', ['Serein', 'Hostile', 'Conciliant'])">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        
        <label for="attitude_adversaire">Attitude (Interpellations précédentes) :</label>
        <textarea id="attitude_adversaire" rows="2" placeholder="Réactions lors des précédentes interpellations"></textarea>
        
        <label for="volume_adversaire_label">Volume (Renfort) :</label>
        <div id="volume_adversaire_container">
            <div class="dynamic-list-item">
                <select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
                    <option value="">Sélectionner</option>
                    <option value="Seul">Seul</option>
                    <option value="Famille">Famille</option>
                    <option value="BO">BO</option>
                    <option value="Conjointe">Conjointe</option>
                </select>
                <input type="text" class="dynamic-input" placeholder="Ajouter un volume" onchange="this.previousElementSibling.value=this.value; saveFormData()">
                <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', 'Volume', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        
        <label for="substances_adversaire">Substances :</label>
        <input type="text" id="substances_adversaire" placeholder="Alcool/Drogues...">
        
        <label for="vehicules_container_label">Véhicules :</label>
        <div id="vehicules_container">
            <div class="dynamic-list-item">
                <input type="text" class="vehicule-input" placeholder="Immat modèle couleur">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur')">➕</button>
        
        <label for="armes_container_label">Armes :</label>
        <div id="armes_container">
            <div class="dynamic-list-item">
                <input type="text" class="arme-input" value="RAS" placeholder="Armes (si connue) ou RAS">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS')">➕</button>
        
        <label for="mode_action_me1">Mode d'action : ME1 (+ probable)</label>
        <textarea id="mode_action_me1" rows="1" placeholder="Fuite"></textarea>
        <label for="mode_action_me2">Mode d'action : ME2</label>
        <textarea id="mode_action_me2" rows="1" placeholder="Rébellion"></textarea>
        <label for="mode_action_me3">Mode d'action : ME3</label>
        <textarea id="mode_action_me3" rows="1" placeholder="Retranchement"></textarea>
        
        <label for="adversaire_photos_label">Photos de l'adversaire :</label>
        <div id="adversaire_photos_container">
            <div class="dynamic-list-item">
                <input type="file" class="adversaire-photo-input" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addPhotoField('adversaire_photos_container', 'adversaire-photo-input')">➕</button>
    </div>

    <div class="form-section">
        <h2>1.4 ENVIRONNEMENT</h2>
        <label for="amies">1.4 Ami(e)s :</label>
        <input type="text" id="amies" placeholder="Équipes en soutien...">
        <label for="terrain_info">1.5 Terrain / Environnement :</label>
        <input type="text" id="terrain_info" placeholder="Météo / Relief / Milieu...">
        <label for="population">1.6 Population :</label>
        <input type="text" id="population" placeholder="Neutre">
        <label for="cadre_juridique">1.7 Cadre juridique :</label>
        <input type="text" id="cadre_juridique" placeholder="Préliminaire / Flag...">
    </div>

    <div class="form-section">
        <h2>2. MISSIONS du PSIG</h2>
        <textarea id="missions_psig" rows="4" placeholder="INTERPELLER L'OBJECTIF..."></textarea>
    </div>

    <div class="form-section">
        <h2>3. EXÉCUTION</h2>
        <label for="date_execution">Date d'exécution :</label>
        <input type="date" id="date_execution">
        <label for="heure_execution">Heure d'exécution :</label>
        <input type="time" id="heure_execution" value="06:00">
        <label for="type_action_label">Type d'action :</label>
        <div id="type_action_container">
            <div class="dynamic-list-item">
                <select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
                    <option value="en force">en force</option>
                    <option value="en souplesse">en souplesse</option>
                </select>
                <input type="text" class="dynamic-input" placeholder="Ajouter un type d'action" onchange="this.previousElementSibling.value=this.value; saveFormData()">
                <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('type_action_container', 'Type d\'action', ['en force', 'en souplesse'])">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
    </div>

    <div class="form-section">
        <h2>4. ARTICULATION</h2>
        <label for="place_chef">Place du Chef :</label>
        <input type="text" id="place_chef" placeholder="En INDIA / Avec élément interpellation...">
        
        <h3 style="margin-top: 20px;">Temps d'opération (T0 - T5)</h3>
        <div id="time_events_container">
            <div class="time-item">
                <select class="time-type-select" onchange="saveFormData()">
                    <option value="T0">T0</option><option value="T1">T1</option><option value="T2">T2</option><option value="T3">T3</option><option value="T4">T4</option><option value="T5">T5</option>
                </select>
                <input type="time" class="time-hour-input" onchange="saveFormData()">
                <textarea class="time-description-input" placeholder="Description de l'événement" rows="1" onchange="saveFormData()"></textarea>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addTimeEvent()">➕</button>
    </div>

    <div class="form-section">
        <h2>PATRACDVR</h2>
        <div id="patracdvr_container">
        </div>
        <button type="button" class="add-btn" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
    </div>
    
    <div class="form-section">
        <h2>Photos de l'opération</h2>
        <div id="operation_photos_container">
            <div class="dynamic-list-item">
                <label>Cheminement :</label>
                <input type="file" class="photo-input" data-label="Cheminement" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
            <div class="dynamic-list-item">
                <label>Terrain :</label>
                <input type="file" class="photo-input" data-label="Terrain" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
            <div class="dynamic-list-item">
                <label>Porte :</label>
                <input type="file" class="photo-input" data-label="Porte" accept="image/*">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addPhotoField('operation_photos_container')">➕</button>
    </div>

    <button id="generatePdf">Générer le PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/jspdf-addimage-base64@1.0.1/dist/jspdf-addimage-base64.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.es.min.js"></script>
<script>
    const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];

    document.addEventListener('DOMContentLoaded', (event) => {
        loadFormData();
    });

    function saveFormData() {
        const data = {};
        document.querySelectorAll('input, textarea, select').forEach(field => {
            if (field.type !== 'file' && field.id) {
                data[field.id] = field.value;
            }
        });
        
        data['vehicules_list'] = Array.from(document.querySelectorAll('.vehicule-input')).map(input => input.value);
        data['armes_list'] = Array.from(document.querySelectorAll('.arme-input')).map(input => input.value);
        
        data['etat_esprit_list'] = Array.from(document.querySelectorAll('#etat_esprit_container .dynamic-select')).map(s => s.value);
        data['volume_list'] = Array.from(document.querySelectorAll('#volume_adversaire_container .dynamic-select')).map(s => s.value);
        data['type_action_list'] = Array.from(document.querySelectorAll('#type_action_container .dynamic-select')).map(s => s.value);
        
        data['patracdvr_rows'] = [];
        document.querySelectorAll('#patracdvr_container > .form-section').forEach(section => {
            const vehicle = section.querySelector('.patracdvr-vehicle-select').value;
            const members = Array.from(section.querySelectorAll('.patracdvr-member-input')).map(input => {
                const item = input.closest('.patracdvr-member-item');
                return {
                    trigramme: input.value,
                    equipement: item.querySelector('.patracdvr-equipement-select').value,
                    fonction: item.querySelector('.patracdvr-fonction-select').value
                };
            });
            data['patracdvr_rows'].push({ vehicle, members });
        });
        
        data['time_events'] = [];
        document.querySelectorAll('#time_events_container > .time-item').forEach(item => {
            data['time_events'].push({
                type: item.querySelector('.time-type-select').value,
                hour: item.querySelector('.time-hour-input').value,
                description: item.querySelector('.time-description-input').value
            });
        });

        localStorage.setItem('oiFormData', JSON.stringify(data));
    }

    function loadFormData() {
        const savedData = localStorage.getItem('oiFormData');
        if (savedData) {
            const data = JSON.parse(savedData);
            for (const key in data) {
                const field = document.getElementById(key);
                if (field) {
                    field.value = data[key];
                }
            }

            document.getElementById('vehicules_container').innerHTML = '';
            if (data['vehicules_list'] && data['vehicules_list'].length > 0) {
                data['vehicules_list'].forEach(vehicule => addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur', vehicule));
            } else {
                addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur');
            }

            document.getElementById('armes_container').innerHTML = '';
            if (data['armes_list'] && data['armes_list'].length > 0) {
                data['armes_list'].forEach(arme => addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', arme));
            } else {
                addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS');
            }

            loadDynamicSelectField('etat_esprit_container', data['etat_esprit_list'], ['Serein', 'Hostile', 'Conciliant']);
            loadDynamicSelectField('volume_adversaire_container', data['volume_list'], ['Seul', 'Famille', 'BO', 'Conjointe']);
            loadDynamicSelectField('type_action_container', data['type_action_list'], ['en force', 'en souplesse']);

            document.getElementById('patracdvr_container').innerHTML = '';
            if (data['patracdvr_rows'] && data['patracdvr_rows'].length > 0) {
                data['patracdvr_rows'].forEach(row => {
                    addPatracdvrRow(row.vehicle, row.members);
                });
            } else {
                addPatracdvrRow('Sharan', [{trigramme: '', equipement: 'PIE', fonction: 'Inter'}]);
                addPatracdvrRow('Kodiaq', [{trigramme: '', equipement: 'LBD', fonction: 'AO'}]);
            }

            document.getElementById('time_events_container').innerHTML = '';
            if (data['time_events'] && data['time_events'].length > 0) {
                data['time_events'].forEach(event => addTimeEvent(event.type, event.hour, event.description));
            } else {
                addTimeEvent('T0', '05:30', 'Déplacement tous moyens réunis...');
            }

        } else {
            addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur');
            addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS');
            addDynamicFieldWithSelect('etat_esprit_container', 'État d\'esprit', ['Serein', 'Hostile', 'Conciliant']);
            addDynamicFieldWithSelect('volume_adversaire_container', 'Volume', ['Seul', 'Famille', 'BO', 'Conjointe']);
            addDynamicFieldWithSelect('type_action_container', 'Type d\'action', ['en force', 'en souplesse']);
            addPatracdvrRow('Sharan', [{trigramme: '', equipement: 'PIE', fonction: 'Inter'}]);
            addPatracdvrRow('Kodiaq', [{trigramme: '', equipement: 'LBD', fonction: 'AO'}]);
            addTimeEvent('T0', '05:30', 'Déplacement tous moyens réunis...');
        }
    }

    function loadDynamicSelectField(containerId, values, initialOptions) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (values && values.length > 0) {
            values.forEach(val => {
                addDynamicFieldWithSelect(containerId, '', initialOptions, val);
            });
        } else {
            addDynamicFieldWithSelect(containerId, '', initialOptions);
        }
    }

    function resetForm() {
        if (confirm('Voulez-vous vraiment réinitialiser tout le formulaire ?')) {
            localStorage.removeItem('oiFormData');
            location.reload();
        }
    }

    function addDynamicFieldWithSelect(containerId, placeholder, initialOptions, selectedValue = '') {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        
        const selectHtml = `<select class="dynamic-select" onchange="this.nextElementSibling.value=this.value; saveFormData()">
            <option value="">Sélectionner</option>
            ${initialOptions.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}
        </select>`;
        
        newField.innerHTML = `${selectHtml}
            <input type="text" class="dynamic-input" placeholder="Ajouter un ${placeholder.toLowerCase()}" onchange="this.previousElementSibling.value=this.value; saveFormData()">
            <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('${containerId}', '${placeholder}', ['${initialOptions.join("','")}'])">➕</button>
            <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(newField);
        saveFormData();
    }
    
    function addDynamicField(containerId, inputClass, placeholder, defaultValue = '') {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        newField.innerHTML = `<input type="text" class="${inputClass}" placeholder="${placeholder}" value="${defaultValue}" onchange="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>`;
        container.appendChild(newField);
        saveFormData();
    }
    
    function addPhotoField(containerId) {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        newField.innerHTML = `<input type="file" class="photo-input" data-label="Autre" accept="image/*" onchange="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>`;
        container.appendChild(newField);
        saveFormData();
    }

    function addPatracdvrRow(vehicle = '', membersData = []) {
        const container = document.getElementById('patracdvr_container');
        const vehicleToAdd = vehicle || availableVehicles.find(v => !document.querySelector(`.patracdvr-vehicle-select[value="${v}"]`));

        if (!vehicleToAdd) {
            alert('Tous les véhicules sont déjà utilisés.');
            return;
        }

        const vehicleId = vehicleToAdd.replace(/\s/g, '');
        const row = document.createElement('div');
        row.className = 'form-section';
        const vehicleSelectHtml = `<select class="patracdvr-vehicle-select" onchange="updatePatracdvrRow(this)">` +
                              availableVehicles.map(v => `<option value="${v}" ${v === vehicleToAdd ? 'selected' : ''}>${v}</option>`).join('') + `</select>`;
        row.innerHTML = `
            <div>
                <h3>Véhicule : ${vehicleSelectHtml}</h3>
                <div id="patracdvr_members_${vehicleId}"></div>
                <button type="button" class="add-btn" onclick="addPatracdvrMember('${vehicleId}')">➕</button>
                <button type="button" class="remove-btn" onclick="this.parentNode.remove(); updateAllPatracdvrRows(); saveFormData()">❌</button>
            </div>
        `;
        container.appendChild(row);

        if (membersData.length > 0) {
            membersData.forEach(member => addPatracdvrMember(vehicleId, member.trigramme, member.equipement, member.fonction));
        } else {
            addPatracdvrMember(vehicleId, '', 'PIE', 'Inter');
        }
        updateAllPatracdvrRows();
        saveFormData();
    }
    
    function updatePatracdvrRow(selectElement) {
        const oldVehicleId = selectElement.closest('.form-section').querySelector('[id^="patracdvr_members_"]').id;
        const newVehicleId = selectElement.value.replace(/\s/g, '');
        selectElement.closest('.form-section').querySelector('[id^="patracdvr_members_"]').id = `patracdvr_members_${newVehicleId}`;
        updateAllPatracdvrRows();
        saveFormData();
    }

    function updateAllPatracdvrRows() {
        const usedVehicles = new Set();
        document.querySelectorAll('.patracdvr-vehicle-select').forEach(select => {
            if (select.value) {
                usedVehicles.add(select.value);
            }
        });
        document.querySelectorAll('.patracdvr-vehicle-select').forEach(select => {
            const currentValue = select.value;
            const newOptions = availableVehicles.map(v => `<option value="${v}" ${v === currentValue ? 'selected' : ''} ${usedVehicles.has(v) && v !== currentValue ? 'disabled' : ''}>${v}</option>`).join('');
            select.innerHTML = newOptions;
        });
    }

    function addPatracdvrMember(vehicleId, trigramme = '', equipement = '', fonction = '') {
        const container = document.getElementById(`patracdvr_members_${vehicleId}`);
        if (!container) return;
        const equipementOptions = ['PIE', 'EFFRAC', 'LBD', 'UMP', 'G36', 'IL', 'GENL', 'MP7'];
        const fonctionOptions = ['Chef inter', 'Chef dispo', 'AO', 'Inter', 'DE'];
        
        const member = document.createElement('div');
        member.className = 'patracdvr-member-item';
        member.innerHTML = `
            <input type="text" class="patracdvr-member-input" placeholder="Trigramme" value="${trigramme}" onchange="saveFormData()">
            <select class="patracdvr-equipement-select" onchange="saveFormData()">
                ${equipementOptions.map(o => `<option value="${o}" ${o === equipement ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
            <select class="patracdvr-fonction-select" onchange="saveFormData()">
                ${fonctionOptions.map(o => `<option value="${o}" ${o === fonction ? 'selected' : ''}>${o}</option>`).join('')}
            </select>
            <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(member);
        saveFormData();
    }

    function addTimeEvent(type = 'T0', hour = '', description = '') {
        const container = document.getElementById('time_events_container');
        const event = document.createElement('div');
        event.className = 'time-item';
        const timeTypes = ['T0', 'T1', 'T2', 'T3', 'T4', 'T5'];
        event.innerHTML = `
            <select class="time-type-select" onchange="saveFormData()">
                ${timeTypes.map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
            <input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()">
            <textarea class="time-description-input" placeholder="Description de l'événement" rows="1" onchange="saveFormData()">${description}</textarea>
            <button type="button" class="remove-btn" onclick="this.parentNode.remove(); saveFormData()">❌</button>
        `;
        container.appendChild(event);
        saveFormData();
    }

    document.getElementById('generatePdf').addEventListener('click', async () => {
        const doc = new jspdf.jsPDF('portrait', 'pt', 'a4');
        const margin = 50;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let yPos = margin;

        const addHeaderAndFooter = () => {
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            doc.setFontSize(10);
            doc.setFont('Helvetica', 'normal');
            doc.setTextColor('#e0e0e0');
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - 70, pageHeight - 20);
        };
        
        doc.addFileToVFS('Lato-Regular.ttf', 'AAEAAA...=='); // Replace with base64 encoded font data
        doc.addFileToVFS('Lato-Bold.ttf', 'AAEAAA...=='); // Replace with base64 encoded font data
        doc.addFont('Lato-Regular.ttf', 'Lato', 'normal');
        doc.addFont('Lato-Bold.ttf', 'Lato', 'bold');

        const addSectionTitle = (title) => {
            doc.addPage();
            yPos = margin;
            addHeaderAndFooter();
            doc.setFontSize(18);
            doc.setFont('Lato', 'bold');
            doc.setTextColor('#5b9bd5');
            doc.text(title, margin, yPos);
            yPos += 30;
        };

        const addSubsectionTitle = (title) => {
            doc.addPage();
            yPos = margin;
            addHeaderAndFooter();
            doc.setFontSize(18);
            doc.setFont('Lato', 'bold');
            doc.setTextColor('#5b9bd5');
            doc.text(title, margin, yPos);
            yPos += 30;
        };

        const addText = (label, value) => {
            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = margin;
                addHeaderAndFooter();
            }
            doc.setFontSize(14);
            doc.setFont('Lato', 'normal');
            doc.setTextColor('#e0e0e0');
            let text = `${label}: `;
            let lines = doc.splitTextToSize(text, pageWidth - margin * 2);
            doc.text(lines, margin, yPos);
            
            doc.setFontSize(14);
            doc.setFont('Lato', 'normal');
            const valueLines = doc.splitTextToSize(value, pageWidth - margin * 2 - doc.getStringUnitWidth(text) * 14);
            doc.text(valueLines, margin + doc.getStringUnitWidth(text) * 14, yPos);
            
            yPos += (Math.max(lines.length, valueLines.length) * 15) + 5;
        };
        
        const addPhoto = async (fileInput, title) => {
            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => reader.onload = resolve);
                const img = new Image();
                img.src = reader.result;
                await new Promise(resolve => img.onload = resolve);
                
                const imgWidth = pageWidth - margin * 2;
                const imgHeight = (img.height * imgWidth) / img.width;

                addSubsectionTitle(title);
                
                doc.addImage(reader.result, 'JPEG', margin, yPos, imgWidth, imgHeight);
                yPos += imgHeight + 20;
            }
        };

        addHeaderAndFooter();

        doc.setFontSize(22);
        doc.setFont('Lato', 'bold');
        doc.setTextColor('#5b9bd5');
        doc.text("OPÉRATION DE POLICE JUDICIAIRE", pageWidth / 2, 40, { align: 'center' });
        
        // 1. SITUATION
        addSectionTitle("1. SITUATION");
        yPos = 80;
        addSubsectionTitle("1.1 Générale");
        addText(`Date de l'opération`, document.getElementById('date_op').value);
        addText("Contenu", document.getElementById('situation_generale').value);
        
        addSubsectionTitle("1.2 Particulière");
        addText("Contenu", document.getElementById('situation_particuliere').value);

        // 1.3 ADVERSAIRE
        addSectionTitle("1.3 ADVERSAIRE(S)");
        yPos = 80;
        addText('Nom/Prénom', document.getElementById('nom_adversaire').value);
        addText('Domicile et Adresse de repli', document.getElementById('domicile_adversaire').value);
        addText('Date/Lieu de naissance', `${document.getElementById('date_naissance').value} à ${document.getElementById('lieu_naissance').value}`);
        addText('Description', `${document.getElementById('stature_adversaire').value} / ${document.getElementById('ethnie_adversaire').value} / ${document.getElementById('signes_particuliers_adversaire').value}`);
        addText('Profession', document.getElementById('profession_adversaire').value);
        addText('Antécédents', document.getElementById('antecedents_adversaire').value);
        addText('État d\'esprit', Array.from(document.querySelectorAll('#etat_esprit_container .dynamic-select')).map(s => s.value).filter(val => val).join(', '));
        addText('Attitude', document.getElementById('attitude_adversaire').value);
        addText('Volume', Array.from(document.querySelectorAll('#volume_adversaire_container .dynamic-select')).map(s => s.value).filter(val => val).join(', '));
        addText('Substances', document.getElementById('substances_adversaire').value);
        addText('Véhicules', Array.from(document.querySelectorAll('.vehicule-input')).map(input => input.value).filter(val => val).join(', '));
        addText('Armes', Array.from(document.querySelectorAll('.arme-input')).map(input => input.value).filter(val => val).join(', '));
        addText('Modes d\'actions', `ME1: ${document.getElementById('mode_action_me1').value}`);
        addText('', `ME2: ${document.getElementById('mode_action_me2').value}`);
        addText('', `ME3: ${document.getElementById('mode_action_me3').value}`);
        
        const photoAdversaireInputs = document.querySelectorAll('#adversaire_photos_container input[type="file"]');
        for (const input of photoAdversaireInputs) {
            await addPhoto(input, "Photo de l'adversaire");
        }

        // 1.4 ENVIRONNEMENT
        addSectionTitle("1.4 ENVIRONNEMENT");
        yPos = 80;
        addText("Ami(e)s", document.getElementById('amies').value);
        addText("Terrain / Environnement", document.getElementById('terrain_info').value);
        addText("Population", document.getElementById('population').value);
        addText("Cadre juridique", document.getElementById('cadre_juridique').value);
        
        // 2. MISSIONS du PSIG
        addSectionTitle("2. MISSIONS du PSIG");
        yPos = 80;
        addText("", document.getElementById('missions_psig').value);

        // 3. EXÉCUTION
        addSectionTitle("3. EXÉCUTION");
        yPos = 80;
        addText("Date d'exécution", document.getElementById('date_execution').value);
        addText("Heure d'exécution", document.getElementById('heure_execution').value);
        addText("Type d'action", Array.from(document.querySelectorAll('#type_action_container .dynamic-select')).map(s => s.value).filter(val => val).join(', '));
        
        // 4. ARTICULATION
        addSectionTitle("4. ARTICULATION");
        yPos = 80;
        addText("Place du Chef", document.getElementById('place_chef').value);
        
        // Temps d'opération
        addSubsectionTitle("Temps d'opération (T0 - T5)");
        yPos = 80;
        const timeEvents = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => {
            return [
                item.querySelector('.time-type-select').value,
                item.querySelector('.time-hour-input').value,
                item.querySelector('.time-description-input').value
            ];
        });
        if (timeEvents.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Type', 'Heure', 'Description']],
                body: timeEvents,
                theme: 'plain',
                styles: { fontSize: 13, cellPadding: 5, textColor: [224, 224, 224], fillColor: [30, 30, 30], font: 'Lato', fontStyle: 'normal' },
                headStyles: { fillColor: [42, 42, 42], textColor: [255, 255, 255], font: 'Lato', fontStyle: 'bold' },
                didDrawPage: (data) => { yPos = data.cursor.y + 10; }
            });
        }

        // PATRACDVR
        addSectionTitle("PATRACDVR");
        yPos = 80;
        const patracdvrData = [];
        document.querySelectorAll('#patracdvr_container > .form-section').forEach(section => {
            const vehicle = section.querySelector('.patracdvr-vehicle-select').value;
            const members = Array.from(section.querySelectorAll('.patracdvr-member-input')).map(input => {
                const item = input.closest('.patracdvr-member-item');
                const equipement = item.querySelector('.patracdvr-equipement-select').value;
                const fonction = item.querySelector('.patracdvr-fonction-select').value;
                return [input.value, equipement, fonction];
            });
            patracdvrData.push({vehicle, members});
        });
        
        for (const row of patracdvrData) {
            if (row.members.some(m => m[0])) {
                doc.autoTable({
                    startY: yPos,
                    head: [[`${row.vehicle}`, 'Équipement', 'Fonction']],
                    body: row.members,
                    theme: 'plain',
                    styles: { fontSize: 13, cellPadding: 5, textColor: [224, 224, 224], fillColor: [30, 30, 30], font: 'Lato', fontStyle: 'normal' },
                    headStyles: { fillColor: [42, 42, 42], textColor: [255, 255, 255], font: 'Lato', fontStyle: 'bold' },
                    didDrawPage: (data) => { yPos = data.cursor.y + 10; }
                });
                yPos += 10;
            }
        }
        
        const photoInputs = document.querySelectorAll('#operation_photos_container input[type="file"]');
        for (const input of photoInputs) {
            const title = input.getAttribute('data-label') || "Photo d'opération";
            await addPhoto(input, title);
        }

        doc.save('ordre_initial.pdf');
    });
</script>

</body>
</html>
