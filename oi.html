<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur d'Ordre Initial - Wizard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; /* Espace pour le dock */ transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Saira Stencil One', sans-serif; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        h3 { color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; font-weight: 400; }
        .wizard-nav { display: flex; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .wizard-nav-btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; transition: background-color 0.2s; }
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #nextBtn { background-color: var(--accent-blue); color: white; }
        #generatePdfBtn { background-color: #27ae60; color: white; }
        .dock-menu {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 90%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            z-index: 1000;
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--border-color);
            border-radius: 20px 20px 0 0;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dock-menu-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-container);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            text-decoration: none;
        }
        .dock-menu-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <a href="index.html" class="dock-menu-item" title="Accueil">
            <span class="material-icons">home</span>
        </a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le th√®me">
            <span class="material-symbols-outlined" id="darkModeIcon">nightlight</span>
        </div>
        <div class="dock-menu-item" id="resetBtn" title="R√©initialiser le formulaire">
            <span class="material-icons">refresh</span>
        </div>
    </div>

    <div class="container">
        <h1>G√©n√©rateur d'Ordre Initial</h1>
        <form id="oi-form">
            </form>
        <div class="wizard-nav">
             <button class="wizard-nav-btn" id="prevBtn" type="button" onclick="changeStep(-1)">Pr√©c√©dent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button" onclick="changeStep(1)">Suivant</button>
            <button class="wizard-nav-btn" id="generatePdfBtn" type="button" style="display:none;">G√©n√©rer le PDF üìÑ</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // --- TOUT LE JAVASCRIPT DE GESTION DU FORMULAIRE ET DU WIZARD RESTE INCHANG√â ---
        let currentStep = 0;
        const steps = document.querySelectorAll(".wizard-step");
        // ... etc. (Le reste du JS est omis pour la clart√©, mais est identique au pr√©c√©dent)
        
        async function buildPdf() {
            const { PDFDocument, StandardFonts, rgb, PageSizes } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            saveFormData();
            const formDataString = localStorage.getItem('oiFormData');
            if (!formDataString) { alert("Aucune donn√©e √† g√©n√©rer."); return null; }
            const formData = JSON.parse(formDataString);
            const getVal = (id) => formData[id] || 'RAS';

            const context = {
                pdfDoc, helveticaFont, helveticaBoldFont,
                currentPage: null, y: 0,
                pageWidth: 0, pageHeight: 0, margin: 40,
                colors: {
                    background: rgb(30/255, 30/255, 30/255),
                    text: rgb(1, 1, 1),
                    label: rgb(220/255, 220/255, 220/255),
                    accent: rgb(91/255, 155/255, 213/255),
                }
            };

            const addNewPage = () => {
                context.currentPage = context.pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]); // Toujours en paysage
                const { width, height } = context.currentPage.getSize();
                context.pageWidth = width; context.pageHeight = height;
                context.y = height - context.margin;
                context.currentPage.drawRectangle({ x: 0, y: 0, width, height, color: context.colors.background });
            };

            const checkY = (spaceNeeded) => {
                if (context.y - spaceNeeded < context.margin) {
                    addNewPage();
                }
            };

            const drawTitle = (text) => {
                addNewPage();
                context.y -= 20; // Marge sup√©rieure
                context.currentPage.drawText(text, { x: context.margin, y: context.y, font: context.helveticaBoldFont, size: 18, color: context.colors.accent });
                context.y -= 20;
            };

            const drawSubTitle = (text) => {
                checkY(30);
                context.y -= 30;
                context.currentPage.drawText(text, { x: context.margin, y: context.y, font: context.helveticaBoldFont, size: 16, color: context.colors.accent });
                context.y -= 5;
            };

            const wrapText = (text, font, size, maxWidth) => {
                // ... (inchang√©)
            };
            
            const drawWrappedText = (text, options) => {
                // ... (inchang√©)
            };
            
             const drawList = (items) => {
                for (const item of items) {
                    const value = item.value || 'RAS';
                    drawWrappedText(`- ${item.label}: ${value}`, { font: context.helveticaFont, size: 14, color: context.colors.text, x: context.margin + 15, maxWidth: context.pageWidth - context.margin * 2 - 15 });
                    context.y -= 10;
                }
            };

            const createPhotoPlaceholderPage = (title1, title2) => {
                addNewPage();
                const { pageWidth, pageHeight, margin, colors, helveticaBoldFont } = context;
                const frameWidth = pageWidth - margin * 4;
                const frameHeight = pageHeight - margin * 4;
                const frameX = margin * 2;
                const frameY = margin * 2;
                context.currentPage.drawRectangle({ x: frameX, y: frameY, width: frameWidth, height: frameHeight, borderColor: colors.accent, borderWidth: 2 });
                const title1Width = helveticaBoldFont.widthOfTextAtSize(title1, 24);
                context.currentPage.drawText(title1, { x: pageWidth / 2 - title1Width / 2, y: frameY + frameHeight + 10, font: helveticaBoldFont, size: 24, color: colors.accent });
                const title2Width = helveticaBoldFont.widthOfTextAtSize(title2, 24);
                context.currentPage.drawText(title2, { x: pageWidth / 2 - title2Width / 2, y: frameY - 30, font: helveticaBoldFont, size: 24, color: colors.accent });
            };


            // --- Construction du PDF ---
            addNewPage();
            
            const title = 'ORDRE INITIAL';
            const dateTitle = `Op√©ration du ${getVal('date_op') || 'N/A'}`;
            const titleWidth = helveticaBoldFont.widthOfTextAtSize(title, 40);
            const dateTitleWidth = helveticaFont.widthOfTextAtSize(dateTitle, 20);
            context.currentPage.drawText(title, { x: context.pageWidth / 2 - titleWidth / 2, y: context.pageHeight / 2, font: helveticaBoldFont, size: 40, color: context.colors.accent });
            context.currentPage.drawText(dateTitle, { x: context.pageWidth / 2 - dateTitleWidth / 2, y: context.pageHeight / 2 - 40, font: helveticaFont, size: 20, color: context.colors.text });

            // Section 1: Situation
            drawTitle("1. SITUATION");
            drawSubTitle("1.1 Situation G√©n√©rale");
            drawWrappedText(getVal('situation_generale'), { font: helveticaFont, size: 14, color: context.colors.text, x: context.margin, maxWidth: context.pageWidth - context.margin * 2 });
            context.y -= 20;
            drawSubTitle("1.2 Situation Particuli√®re");
            drawWrappedText(getVal('situation_particuliere'), { font: helveticaFont, size: 14, color: context.colors.text, x: context.margin, maxWidth: context.pageWidth - context.margin * 2 });
            
            // Section 1.3: Adversaire
            drawTitle("1.3 ADVERSAIRE");
            drawList([
                { label: 'Nom/Pr√©nom', value: getVal('nom_adversaire') },
                { label: 'Domicile', value: getVal('domicile_adversaire') },
                { label: 'Naissance', value: `${getVal('date_naissance')} √† ${getVal('lieu_naissance')}` },
                { label: 'Description', value: [getVal('stature_adversaire'), getVal('ethnie_adversaire'), getVal('signes_particuliers_adversaire')].filter(Boolean).join(' / ') || 'RAS' },
                { label: 'Profession', value: getVal('profession_adversaire') },
                { label: 'Ant√©c√©dents', value: getVal('antecedents_adversaire') },
                { label: '√âtat d\'esprit', value: (formData.etat_esprit_list || []).join(', ') || 'RAS' },
                { label: 'Attitude', value: getVal('attitude_adversaire') },
                { label: 'Volume (renfort)', value: (formData.volume_list || []).join(', ') || 'RAS' },
                { label: 'Substances', value: getVal('substances_adversaire') },
                { label: 'V√©hicules', value: (formData.vehicules_list || []).join(', ') || 'RAS' },
                { label: 'Armes', value: (formData.armes_list || []).join(', ') || 'RAS' },
                { label: 'Modes d\'action', value: `ME1: ${getVal('mode_action_me1')}\nME2: ${getVal('mode_action_me2')}\nME3: ${getVal('mode_action_me3')}` },
            ]);

            // Section 1.4: Environnement
            drawTitle("1.4 ENVIRONNEMENT");
            drawList([
                { label: 'Ami(e)s (soutien)', value: getVal('amies') },
                { label: 'Terrain / M√©t√©o', value: getVal('terrain_info') },
                { label: 'Population', value: getVal('population') },
                { label: 'Cadre juridique', value: getVal('cadre_juridique') },
            ]);
            
            // Section 2: Mission
            drawTitle("2. MISSION");
            drawWrappedText(getVal('missions_psig'), { font: helveticaFont, size: 30, color: context.colors.text, x: context.margin, maxWidth: context.pageWidth - context.margin * 2 });

            // Section 3: Ex√©cution
            drawTitle("3. EX√âCUTION");
            drawWrappedText(`Date: ${getVal('date_execution')} | Heure: ${getVal('heure_execution')} | Type: ${(formData.type_action_list || []).join(', ') || 'RAS'}`, { font: helveticaFont, size: 14, color: context.colors.text, x: context.margin, maxWidth: context.pageWidth - context.margin * 2 });
            context.y -= 20;
            drawSubTitle("Tableau des temps");
             (formData.time_events || []).forEach(e => {
                drawWrappedText(`- ${e.type} (${e.hour || 'N/A'}): ${e.description || 'N/A'}`, { font: context.helveticaFont, size: 14, color: context.colors.text, x: context.margin + 15, maxWidth: context.pageWidth - context.margin * 2 - 15 });
            });

            // Section 4: Articulation
            drawTitle("4. ARTICULATION");
            drawWrappedText(`Place du Chef: ${getVal('place_chef')}`, { font: helveticaFont, size: 14, color: context.colors.text, x: context.margin, maxWidth: context.pageWidth - context.margin * 2 });
            createPhotoPlaceholderPage("Cheminement Inter", "Porte");
            createPhotoPlaceholderPage("Cheminement AO", "Bapt√™me terrain");
            
            // Section 5: PATRACDVR
            drawTitle("5. PATRACDVR");
            (formData.patracdvr_rows || []).forEach(row => {
                const members = row.members.filter(m => m.trigramme);
                if (members.length > 0) {
                    drawSubTitle(`V√©hicule: ${row.vehicle}`);
                    members.forEach(m => {
                        drawWrappedText(`- ${m.trigramme}: ${m.fonction} (${m.equipement})`, { font: context.helveticaFont, size: 14, color: context.colors.text, x: context.margin + 15, maxWidth: context.pageWidth - context.margin * 2 - 15 });
                    });
                    context.y -= 15;
                }
            });

            // Final Page
            addNewPage();
            const finalText = "Avez vous des questions?";
            const finalTextWidth = helveticaBoldFont.widthOfTextAtSize(finalText, 48);
            context.currentPage.drawText(finalText, { x: context.pageWidth / 2 - finalTextWidth / 2, y: context.pageHeight / 2, font: helveticaBoldFont, size: 48, color: context.colors.accent });

            const pdfBytes = await pdfDoc.save();
            return { pdfBytes, formData };
        }

        document.getElementById('generatePdfBtn').addEventListener('click', async () => {
            if (typeof PDFLib === 'undefined') {
                alert("Erreur: La biblioth√®que PDF n'est pas encore charg√©e. Veuillez patienter et r√©essayer.");
                return;
            }
            try {
                const result = await buildPdf();
                if (!result) return;
                const { pdfBytes, formData } = result;
                const getVal = (id) => formData[id] || 'RAS';
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `OI_${getVal('date_op').replace(/[\/\\?%*:|"<>]/g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Erreur critique lors de la g√©n√©ration du PDF:", error);
                alert("Une erreur critique est survenue. Consultez la console (F12).");
            }
        });
    </script>
</body>
</html>
