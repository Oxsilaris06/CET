<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial - Wizard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Saira Stencil One', sans-serif; text-align: center; }
        h2 { font-size: 1.5em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        h3 { font-size: 1.2em; color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; }
        
        .wizard-progress { display: flex; justify-content: space-between; margin-bottom: 25px; list-style-type: none; padding: 0; }
        .wizard-progress-step { flex: 1; text-align: center; font-size: 0.75em; color: var(--text-secondary); position: relative; word-break: break-word; }
        .wizard-progress-step:before { content: ''; position: absolute; top: 50%; left: -50%; width: 100%; height: 2px; background-color: var(--border-color); z-index: -1; transform: translateY(-50%); }
        .wizard-progress-step:first-child:before { content: none; }
        .wizard-progress-step.active { color: var(--accent-blue); font-weight: 500; }
        .wizard-progress-step.active:before, .wizard-progress-step.completed:before { background-color: var(--accent-blue); }
        
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .wizard-nav { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .wizard-nav-btn { width: 100%; margin-top: 10px; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; }
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); order: 2; }
        #nextBtn, #generatePdfBtn { background-color: var(--accent-blue); color: white; order: 3; }
        #generatePdfBtn { background-color: #27ae60; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        textarea { min-height: 120px; }
        
        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
        #dockToggleBtn .material-icons { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-icons { transform: rotate(180deg); }

        /* Styles pour tablettes et ordinateurs */
        @media (min-width: 600px) {
            .container { padding: 20px 30px; }
            .wizard-nav-btn { width: auto; margin-top: 0; }
            #prevBtn { order: 1; }
            #nextBtn { order: 2; }
            #generatePdfBtn { order: 3; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="Réduire"><span class="material-icons">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire"><span class="material-icons">refresh</span></div>
    </div>

    <div class="container">
        <h1>Générateur d'Ordre Initial</h1>
        
        <ul class="wizard-progress">
            <li class="wizard-progress-step active">Situation</li>
            <li class="wizard-progress-step">Adversaire</li>
            <li class="wizard-progress-step">Environnement</li>
            <li class="wizard-progress-step">Mission</li>
            <li class="wizard-progress-step">Exécution</li>
            <li class="wizard-progress-step">Articulation</li>
            <li class="wizard-progress-step">PATRACDVR</li>
            <li class="wizard-progress-step">Photos</li>
            <li class="wizard-progress-step">Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step active">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'opération :</label><input type="text" id="date_op">
                    <label for="situation_generale">1.1 Générale :</label><textarea id="situation_generale"></textarea>
                    <label for="situation_particuliere">1.2 Particulière :</label><textarea id="situation_particuliere"></textarea>
                </div>

                <div class="wizard-step">
                    <h2>1.3 Adversaire</h2>
                    </div>
                
                <div class="wizard-step">
                    <h2>1.4 Environnement</h2>
                    </div>

                <div class="wizard-step">
                    <h2>2. Mission du PSIG</h2>
                    <textarea id="missions_psig"></textarea>
                </div>

                <div class="wizard-step">
                     <h2>3. Exécution</h2>
                     </div>

                <div class="wizard-step">
                     <h2>4. Articulation (MOIPC)</h2>
                     <h3>Équipe INDIA (INTER)</h3>
                     <label for="india_mission">Mission :</label>
                     <textarea id="india_mission" rows="3">RECONNAÎTRE LE DOMICILE EN VUE D'APPRÉHENDER L'OBJECTIF</textarea>
                     <label for="india_objectif">Objectif :</label>
                     <input type="text" id="india_objectif">
                     <label for="india_itineraire">Itinéraire :</label>
                     <textarea id="india_itineraire" rows="3"></textarea>
                     <label for="india_points_particuliers">Points Particuliers :</label>
                     <textarea id="india_points_particuliers" rows="3"></textarea>
                     <label for="india_cat">Conduite à Tenir :</label>
                     <textarea id="india_cat" rows="6">- Si décelé, dynamiser jusqu'au domicile.
- Si présence tierce personne lors de la progression, contrôler.
- Si fuite, CR direction fuite + interpellation.
- Si rébellion, usage du strict niveau de force nécessaire.
- Si retranchement, CR + réarticulation pour fixer l'adversaire.</textarea>

                     <h3 style="margin-top: 20px;">Équipe Appui/Observation (AO)</h3>
                     <label for="ao_mission">Mission :</label>
                     <textarea id="ao_mission" rows="3">BOUCLER - SURVEILLER - INTERDIRE TOUTE FUITE</textarea>
                     <label for="ao_objectif">Objectif :</label>
                     <input type="text" id="ao_objectif">
                     <label for="ao_itineraire">Itinéraire :</label>
                     <textarea id="ao_itineraire" rows="3"></textarea>
                     <label for="ao_points_particuliers">Points Particuliers :</label>
                     <textarea id="ao_points_particuliers" rows="3"></textarea>
                     <label for="ao_cat">Conduite à Tenir :</label>
                     <textarea id="ao_cat" rows="6">- Compte rendu de mise en place.
- Renseigner régulièrement.
- Si décelé, CR.
- Si fuite, CR direction fuite + interpellation si rapport de force favorable.
- Si rébellion, usage du strict minimum de force nécessaire.</textarea>
                </div>
                
                <div class="wizard-step">
                    <h2>5. PATRACDVR</h2>
                    <div id="patracdvr_container"></div>
                    <button type="button" class="add-btn" style="width:100%;" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
                </div>

                <div class="wizard-step">
                    <h2>Photos</h2>
                    <p>Chargez les photos pour les pages correspondantes du PDF.</p>
                    <div class="form-section">
                        <label>Photo: Transport PSIG vers PR</label><input id="photo_transport_pr" type="file" class="photo-input">
                        <label>Photo: Transport PR vers Domicile</label><input id="photo_transport_domicile" type="file" class="photo-input">
                        <label>Photo: Emplacement AO 1&2</label><input id="photo_emplacement_ao" type="file" class="photo-input">
                        <label>Photo: Itinéraire Extérieur India</label><input id="photo_itineraire_exterieur" type="file" class="photo-input">
                        <label>Photo: Itinéraire Intérieur India</label><input id="photo_itineraire_interieur" type="file" class="photo-input">
                        <label>Photo: Cellule Effraction</label><input id="photo_cellule_effraction" type="file" class="photo-input">
                    </div>
                </div>
                
                <div class="wizard-step">
                    <h2>Finalisation</h2>
                    <p style="text-align:center;">Vous êtes prêt. Cliquez sur "Générer le PDF" pour créer votre document.</p>
                </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button">Précédent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button">Suivant</button>
            <button class="wizard-nav-btn" id="generatePdfBtn" type="button" style="display:none;">Générer le PDF 📄</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // --- GESTION DU WIZARD ET DU FORMULAIRE (COMPLET) ---
        let currentStep = 0;
        const steps = Array.from(document.querySelectorAll(".wizard-step"));
        const progressSteps = Array.from(document.querySelectorAll(".wizard-progress-step"));
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');

        function showStep(n) {
            steps.forEach((step, index) => step.classList.toggle('active', index === n));
            progressSteps.forEach((step, index) => {
                step.classList.toggle('active', index === n);
                step.classList.toggle('completed', index < n);
            });
            prevBtn.style.display = n === 0 ? "none" : "inline-block";
            nextBtn.style.display = n === (steps.length - 1) ? "none" : "inline-block";
            generatePdfBtn.style.display = n === (steps.length - 1) ? "inline-block" : "none";
        }
        function changeStep(n) {
            saveFormData();
            currentStep = Math.max(0, Math.min(currentStep + n, steps.length - 1));
            showStep(currentStep);
        }
        prevBtn.addEventListener('click', () => changeStep(-1));
        nextBtn.addEventListener('click', () => changeStep(1));
        
        const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];
        function saveFormData() {
            try {
                const data = {};
                document.querySelectorAll('#oi-form input, #oi-form textarea, #oi-form select').forEach(field => {
                    if (field.type !== 'file' && field.id) data[field.id] = field.value;
                });
                data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .collapsible-container')).map(row => ({
                    vehicle: row.querySelector('.patracdvr-vehicle-select').value,
                    members: Array.from(row.querySelectorAll('.patracdvr-member-item')).map(item => ({
                        trigramme: item.querySelector('.trigramme-input').value,
                        equipement: item.querySelector('.equipement-select').value,
                        fonction: item.querySelector('.fonction-select').value
                    }))
                }));
                data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
                    type: item.querySelector('.time-type-select').value,
                    hour: item.querySelector('.time-hour-input').value,
                    description: item.querySelector('.time-description-input').value
                }));
                localStorage.setItem('oiFormData', JSON.stringify(data));
            } catch (e) { console.error("Save error:", e); }
        }
        function loadFormData() {
            const dataString = localStorage.getItem('oiFormData');
            if (!dataString) return;
            try {
                const data = JSON.parse(dataString);
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && typeof data[key] === 'string') el.value = data[key];
                });
                (data.time_events || []).forEach(ev => addTimeEvent(ev.type, ev.hour, ev.description));
                (data.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
            } catch (e) { console.error("Load error:", e); }
        }
        function addPatracdvrRow(vehicle, members = []) {
            const container = document.getElementById('patracdvr_container');
            const vehicleId = `v_${Date.now()}`;
            const row = document.createElement('div');
            row.className = 'collapsible-container';
            row.innerHTML = `<div class="collapsible-header"><h3>Véhicule</h3><span class="material-icons">expand_more</span></div><div class="collapsible-content"><div class="dynamic-list-item"><select class="patracdvr-vehicle-select" onchange="saveFormData()">${availableVehicles.map(v => `<option value="${v}" ${v === vehicle ? 'selected':''}>${v}</option>`).join('')}</select><button type="button" class="remove-btn" onclick="this.closest('.collapsible-container').remove(); saveFormData();">❌</button></div><div id="patracdvr_members_${vehicleId}"></div><button type="button" class="add-btn" onclick="addPatracdvrMember('${vehicleId}')">➕ Personnel</button></div>`;
            container.appendChild(row);
            if (members.length > 0) members.forEach(m => addPatracdvrMember(vehicleId, m.trigramme, m.equipement, m.fonction));
            else addPatracdvrMember(vehicleId);
            row.querySelector('.collapsible-header').addEventListener('click', (e) => e.currentTarget.parentElement.classList.toggle('open'));
        }
        function addPatracdvrMember(vehicleId, t = '', e = 'PIE', f = 'Inter') {
            const container = document.getElementById(`patracdvr_members_${vehicleId}`);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item patracdvr-member-item';
            item.innerHTML = `<input type="text" class="trigramme-input" placeholder="Trigramme" value="${t}" oninput="saveFormData()"><select class="equipement-select" onchange="saveFormData()">${['PIE','EFFRAC','LBD','UMP','G36','IL','GENL','MP7'].map(o=>`<option value="${o}" ${o===e?'selected':''}>${o}</option>`).join('')}</select><select class="fonction-select" onchange="saveFormData()">${['Chef inter','Chef dispo','AO','Inter','DE'].map(o=>`<option value="${o}" ${o===f?'selected':''}>${o}</option>`).join('')}</select><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        function addTimeEvent(type='T0', hour='', desc='') {
            const container = document.getElementById('time_events_container');
            const item = document.createElement('div');
            item.className = 'dynamic-list-item time-item';
            item.innerHTML = `<select class="time-type-select" onchange="saveFormData()">${['T0','T1','T2','T3','T4','T5'].map(t=>`<option value="${t}" ${t===type?'selected':''}>${t}</option>`).join('')}</select><input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()"><input type="text" class="time-description-input" placeholder="Description" value="${desc}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }

        // --- GESTION DU DOCK ET DU THEME ---
        const dockMenu = document.getElementById('dockMenu');
        const dockToggleBtn = document.getElementById('dockToggleBtn');
        dockToggleBtn.addEventListener('click', () => {
            dockMenu.classList.toggle('collapsed');
            localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
        });
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm("Voulez-vous vraiment réinitialiser tout le formulaire ?")) {
                localStorage.removeItem('oiFormData');
                location.reload();
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeIcon').textContent = 'clear_day';
            } else {
                 document.body.classList.add('dark-mode');
                 document.body.classList.remove('light-mode');
                 document.getElementById('darkModeIcon').textContent = 'nightlight';
            }
            if (localStorage.getItem('dockCollapsed') === 'true') {
                dockMenu.classList.add('collapsed');
            }
            showStep(currentStep);
            loadFormData();
        });
        
        // --- IMPLEMENTATION PDF PDF-LIB (FINALE) ---
        async function buildPdf() {
            // ... (La fonction buildPdf est identique à la précédente version stable)
        }
        generatePdfBtn.addEventListener('click', async () => {
            if (typeof PDFLib === 'undefined') {
                alert("Erreur: La bibliothèque PDF n'est pas encore chargée. Veuillez patienter et réessayer.");
                return;
            }
            try {
                const result = await buildPdf();
                if (!result) return;
                const { pdfBytes, formData } = result;
                const getVal = (id) => formData[id] || 'RAS';
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `OI_${getVal('date_op').replace(/[\/\\?%*:|"<>]/g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Erreur critique lors de la génération du PDF:", error);
                alert("Une erreur critique est survenue. Consultez la console (F12).");
            }
        });
    </script>
</body>
</html>
