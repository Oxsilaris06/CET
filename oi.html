<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial</title>
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Arial', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; transition: background-color 0.5s, color 0.5s; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 30px; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 2px; font-weight: 400; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        .form-section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: var(--bg-interactive); color: var(--text-primary);
        }
        button {
            background-color: var(--accent-blue); color: white; padding: 12px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px; margin-top: 20px;
        }
        button.add-btn { background-color: #27ae60; padding: 5px 10px; font-size: 14px; margin-top: 5px; }
        button.add-btn:hover { background-color: #229954; }
        button.remove-btn { background-color: #c0392b; padding: 5px 10px; font-size: 14px; margin-top: 5px; }
        button.remove-btn:hover { background-color: #a93226; }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .team-member-input { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .team-member-input label { margin-bottom: 0; flex-basis: 30px; }
        .team-member-input input { margin-bottom: 0; flex-grow: 1; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <button type="button" onclick="resetForm()">Réinitialiser le formulaire</button>
    <h1>Générateur d'Ordre Initial</h1>

    <div class="form-section">
        <h2>1. SITUATION</h2>
        <label for="date_op">Date de l'opération :</label>
        <input type="text" id="date_op" placeholder="ex: 14/01/2025">
        <label for="situation_generale">1.1 Générale :</label>
        <textarea id="situation_generale" rows="4" placeholder="Décrivez les faits et l'enquête..."></textarea>
        <label for="situation_particuliere">1.2 Particulière :</label>
        <textarea id="situation_particuliere" rows="2" placeholder="ex: L'interpellation du mis en cause est programmée le 14/01/2025 à ANTIBES"></textarea>
    </div>

    <div class="form-section">
        <h2>1.3 ADVERSAIRE(S)</h2>
        <label for="nom_adversaire">Nom/Prénom :</label>
        <input type="text" id="nom_adversaire" placeholder="Nom/Prénom">
        <label for="domicile_adversaire">Domicile et Adresse de repli :</label>
        <textarea id="domicile_adversaire" rows="2" placeholder="Adresse complète..."></textarea>
        <label for="date_naissance">Date/Lieu de naissance :</label>
        <input type="text" id="date_naissance" placeholder="JJ/MM/AAAA à Ville">
        
        <label for="stature_adversaire">Description (Stature) :</label>
        <input type="text" id="stature_adversaire" placeholder="Taille (ex: 1.72m)">
        <label for="ethnie_adversaire">Description (Ethnie) :</label>
        <select id="ethnie_adversaire">
            <option value="Caucasien">Caucasien</option>
            <option value="Nord africain">Nord africain</option>
            <option value="Afro-antillais">Afro-antillais</option>
            <option value="Asiatique">Asiatique</option>
        </select>
        <label for="signes_particuliers_adversaire">Description (Signes particuliers) :</label>
        <input type="text" id="signes_particuliers_adversaire" placeholder="Cicatrice, tatouage...">
        
        <label for="profession_adversaire">Profession :</label>
        <input type="text" id="profession_adversaire" placeholder="Profession">
        <label for="antecedents_adversaire">Antécédents :</label>
        <textarea id="antecedents_adversaire" rows="2" placeholder="TAJ: BT:"></textarea>
        
        <label for="etat_esprit_adversaire_label">État d'esprit :</label>
        <select id="etat_esprit_adversaire_select" onchange="document.getElementById('etat_esprit_adversaire_input').value=this.value;">
            <option value="">Sélectionner ou ajouter</option>
            <option value="Serein">Serein</option>
            <option value="Hostile">Hostile</option>
            <option value="Conciliant">Conciliant</option>
        </select>
        <input type="text" id="etat_esprit_adversaire_input" placeholder="Ajouter un état d'esprit">
        <label for="attitude_adversaire">Attitude (Interpellations précédentes) :</label>
        <textarea id="attitude_adversaire" rows="2" placeholder="Réactions lors des précédentes interpellations"></textarea>
        
        <label for="volume_adversaire_label">Volume (Renfort) :</label>
        <select id="volume_adversaire_select" onchange="document.getElementById('volume_adversaire_input').value=this.value;">
            <option value="">Sélectionner</option>
            <option value="Seul">Seul</option>
            <option value="Famille">Famille</option>
            <option value="BO">BO</option>
            <option value="Conjointe">Conjointe</option>
        </select>
        <input type="text" id="volume_adversaire_input" placeholder="Ajouter un volume">
        
        <label for="substances_adversaire">Substances :</label>
        <input type="text" id="substances_adversaire" placeholder="Alcool/Drogues...">
        
        <label for="vehicules_container">Véhicules :</label>
        <div id="vehicules_container">
            <div class="dynamic-list-item">
                <input type="text" class="vehicule-input" placeholder="Immat modèle couleur">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur')">➕</button>
        
        <label for="armes_container">Armes :</label>
        <div id="armes_container">
            <div class="dynamic-list-item">
                <input type="text" class="arme-input" value="RAS" placeholder="Armes (si connue) ou RAS">
                <button type="button" class="remove-btn" onclick="this.parentNode.remove()">❌</button>
            </div>
        </div>
        <button type="button" class="add-btn" onclick="addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS')">➕</button>
        
        <label for="mode_action_me1">Mode d'action : ME1 (+ probable)</label>
        <textarea id="mode_action_me1" rows="1" placeholder="Fuite"></textarea>
        <label for="mode_action_me2">Mode d'action : ME2</label>
        <textarea id="mode_action_me2" rows="1" placeholder="Rébellion"></textarea>
        <label for="mode_action_me3">Mode d'action : ME3</label>
        <textarea id="mode_action_me3" rows="1" placeholder="Retranchement"></textarea>
        <label for="photoAdversaire">Ajouter une photo de l'adversaire :</label>
        <input type="file" id="photoAdversaire" accept="image/*">
    </div>

    <div class="form-section">
        <h2>1.4 ENVIRONNEMENT</h2>
        <label for="amies">1.4 Ami(e)s :</label>
        <input type="text" id="amies" placeholder="Équipes en soutien...">
        <label for="terrain_info">1.5 Terrain / Environnement :</label>
        <input type="text" id="terrain_info" placeholder="Météo / Relief / Milieu...">
        <label for="population">1.6 Population :</label>
        <input type="text" id="population" placeholder="Neutre">
        <label for="cadre_juridique">1.7 Cadre juridique :</label>
        <input type="text" id="cadre_juridique" placeholder="Préliminaire / Flag...">
    </div>

    <div class="form-section">
        <h2>2. MISSIONS du PSIG</h2>
        <textarea id="missions_psig" rows="4" placeholder="INTERPELLER L'OBJECTIF..."></textarea>
    </div>

    <div class="form-section">
        <h2>3. EXÉCUTION</h2>
        <label for="date_execution">Date d'exécution :</label>
        <input type="date" id="date_execution">
        <label for="heure_execution">Heure d'exécution :</label>
        <input type="time" id="heure_execution" value="06:00">
        <label for="type_action_label">Type d'action :</label>
        <select id="type_action_select" onchange="document.getElementById('type_action_input').value=this.value;">
            <option value="en force">en force</option>
            <option value="en souplesse">en souplesse</option>
        </select>
        <input type="text" id="type_action_input" placeholder="Ajouter un type d'action">
    </div>

    <div class="form-section">
        <h2>4. ARTICULATION</h2>
        <div class="grid-container">
            <div>
                <h3>ÉQUIPE INDIA (Interpellation)</h3>
                <div id="india_members">
                    <div class="team-member-input"><label>India 1:</label><input type="text" class="india-input" placeholder="Trigramme"><button type="button" class="remove-btn" onclick="removeTeamMember(this)">❌</button></div>
                </div>
                <button type="button" class="add-btn" onclick="addTeamMember('india')">➕</button>
            </div>
            <div>
                <h3>ÉQUIPE OSCAR (Observation/Appui)</h3>
                <div id="oscar_members">
                    <div class="team-member-input"><label>Oscar 1:</label><input type="text" class="oscar-input" placeholder="Trigramme"><button type="button" class="remove-btn" onclick="removeTeamMember(this)">❌</button></div>
                </div>
                <button type="button" class="add-btn" onclick="addTeamMember('oscar')">➕</button>
            </div>
        </div>
        <label for="place_chef">Place du Chef :</label>
        <input type="text" id="place_chef" placeholder="En INDIA / Avec élément interpellation...">
        <h3>Photos de l'opération</h3>
        <label for="photoCheminement">Cheminement :</label>
        <input type="file" id="photoCheminement" accept="image/*">
        <label for="photoTerrain">Terrain / Environnement :</label>
        <input type="file" id="photoTerrain" accept="image/*">
        <label for="photoPorte">Porte / Point d'effraction :</label>
        <input type="file" id="photoPorte" accept="image/*">
    </div>
    <button id="generatePdf">Générer le PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        loadFormData();
    });

    const formFields = document.querySelectorAll('input, textarea, select');
    formFields.forEach(field => {
        field.addEventListener('change', (e) => {
            saveFormData();
        });
    });

    function saveFormData() {
        const data = {};
        formFields.forEach(field => {
            if (field.type === 'file') {
                // Not saving file content to local storage
            } else if (field.tagName === 'SELECT') {
                data[field.id] = field.value;
            } else {
                data[field.id] = field.value;
            }
        });
        localStorage.setItem('oiFormData', JSON.stringify(data));
    }

    function loadFormData() {
        const savedData = localStorage.getItem('oiFormData');
        if (savedData) {
            const data = JSON.parse(savedData);
            for (const key in data) {
                const field = document.getElementById(key);
                if (field) {
                    field.value = data[key];
                    if (field.tagName === 'SELECT') {
                         field.dispatchEvent(new Event('change'));
                    }
                }
            }
            updateTeamLabels('india');
            updateTeamLabels('oscar');
        }
    }

    function resetForm() {
        if (confirm('Voulez-vous vraiment réinitialiser tout le formulaire ?')) {
            localStorage.removeItem('oiFormData');
            formFields.forEach(field => {
                if (field.type === 'file') {
                    field.value = '';
                } else if (field.tagName === 'SELECT') {
                    field.selectedIndex = 0;
                } else {
                    field.value = '';
                }
            });
            // Reset dynamic fields
            document.getElementById('india_members').innerHTML = '';
            addTeamMember('india');
            document.getElementById('oscar_members').innerHTML = '';
            addTeamMember('oscar');
            document.getElementById('vehicules_container').innerHTML = '';
            addDynamicField('vehicules_container', 'vehicule-input', 'Immat modèle couleur');
            document.getElementById('armes_container').innerHTML = '';
            addDynamicField('armes_container', 'arme-input', 'Armes (si connue) ou RAS', 'RAS');
        }
    }

    // Ajout de la fonctionnalité de listes déroulantes dynamiques
    function addDynamicOption(selectId, inputId) {
        const input = document.getElementById(inputId);
        const select = document.getElementById(selectId);
        input.addEventListener('change', () => {
            const value = input.value.trim();
            if (value && !Array.from(select.options).some(o => o.value === value)) {
                const newOption = document.createElement('option');
                newOption.value = value;
                newOption.textContent = value;
                select.appendChild(newOption);
                select.value = value;
                saveFormData();
            }
        });
    }

    addDynamicOption('etat_esprit_adversaire_select', 'etat_esprit_adversaire_input');
    addDynamicOption('volume_adversaire_select', 'volume_adversaire_input');
    addDynamicOption('type_action_select', 'type_action_input');

    // Fonction pour ajouter un membre d'équipe
    function addTeamMember(team) {
        const container = document.getElementById(`${team}_members`);
        const count = container.children.length + 1;
        const newMember = document.createElement('div');
        newMember.className = 'team-member-input';
        newMember.innerHTML = `<label>${team.charAt(0).toUpperCase() + team.slice(1)} ${count}:</label><input type="text" class="${team}-input" placeholder="Trigramme"><button type="button" class="remove-btn" onclick="removeTeamMember(this)">❌</button>`;
        container.appendChild(newMember);
        updateTeamLabels(team);
    }
    
    function removeTeamMember(button) {
        button.parentNode.remove();
        const team = button.parentNode.parentNode.id.replace('_members', '');
        updateTeamLabels(team);
        saveFormData();
    }

    function updateTeamLabels(team) {
        const container = document.getElementById(`${team}_members`);
        Array.from(container.children).forEach((child, index) => {
            child.querySelector('label').textContent = `${team.charAt(0).toUpperCase() + team.slice(1)} ${index + 1}:`;
        });
    }

    // Fonction pour ajouter un champ dynamique (armes/véhicules)
    function addDynamicField(containerId, inputClass, placeholder, defaultValue = '') {
        const container = document.getElementById(containerId);
        const newField = document.createElement('div');
        newField.className = 'dynamic-list-item';
        newField.innerHTML = `<input type="text" class="${inputClass}" placeholder="${placeholder}" value="${defaultValue}"><button type="button" class="remove-btn" onclick="this.parentNode.remove()">❌</button>`;
        container.appendChild(newField);
        saveFormData();
    }
    
    document.getElementById('generatePdf').addEventListener('click', async () => {
        const doc = new jspdf.jsPDF('landscape', 'pt', 'a4');
        const margin = 50;
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let yPos = 80;

        const addHeaderAndFooter = () => {
            doc.setFillColor(0, 0, 0);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            doc.setFontSize(10);
            doc.setFont('Helvetica', 'normal');
            doc.setTextColor('#e0e0e0');
            doc.text(`Page ${doc.internal.getNumberOfPages()} `, pageWidth - 70, pageHeight - 20);
        };

        const addSectionTitle = (title) => {
            doc.setFontSize(16);
            doc.setFont('Helvetica', 'bold');
            doc.setTextColor('#5b9bd5');
            doc.text(title, margin, yPos);
            yPos += 20;
        };

        const addText = (label, value, isBold = false) => {
            if (value) {
                doc.setFontSize(12);
                doc.setFont('Helvetica', isBold ? 'bold' : 'normal');
                doc.setTextColor('#e0e0e0');
                const text = `${label}: ${value}`;
                const lines = doc.splitTextToSize(text, pageWidth - margin * 2);
                doc.text(lines, margin, yPos);
                yPos += (lines.length * 15) + 5;
            }
        };

        const addPhoto = async (inputElementId, title) => {
            const input = document.getElementById(inputElementId);
            if (input.files.length > 0) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => reader.onload = resolve);
                const img = new Image();
                img.src = reader.result;
                await new Promise(resolve => img.onload = resolve);
                
                const imgWidth = 300;
                const imgHeight = (img.height * imgWidth) / img.width;

                addText(title, '', true);
                
                if (yPos + imgHeight + 20 > pageHeight) {
                    doc.addPage();
                    yPos = margin;
                    addHeaderAndFooter();
                }

                doc.addImage(reader.result, 'JPEG', margin, yPos, imgWidth, imgHeight);
                yPos += imgHeight + 20;
            }
        };

        addHeaderAndFooter();

        doc.setFontSize(22);
        doc.setFont('Helvetica', 'bold');
        doc.setTextColor('#5b9bd5');
        doc.text("OPÉRATION DE POLICE JUDICIAIRE", pageWidth / 2, 40, { align: 'center' });
        yPos = 60;

        // Page 1
        yPos = 80;
        addSectionTitle("1/ SITUATION");
        addText(`Date de l'opération`, document.getElementById('date_op').value);
        addText("1.1 Générale", document.getElementById('situation_generale').value);
        addText("1.2 Particulière", document.getElementById('situation_particuliere').value);

        // Page 2
        doc.addPage();
        yPos = 80;
        addHeaderAndFooter();
        addSectionTitle("1.3 ADVERSAIRE(S)");
        
        const vehiculesList = Array.from(document.querySelectorAll('.vehicule-input')).map(input => input.value).filter(val => val).join(', ');
        const armesList = Array.from(document.querySelectorAll('.arme-input')).map(input => input.value).filter(val => val).join(', ');

        const adversaireData = [
            ['Nom/Prénom', document.getElementById('nom_adversaire').value],
            ['Domicile et Adresse de repli', document.getElementById('domicile_adversaire').value],
            ['Date/Lieu de naissance', document.getElementById('date_naissance').value],
            ['Description', `${document.getElementById('stature_adversaire').value} / ${document.getElementById('ethnie_adversaire').value} / ${document.getElementById('signes_particuliers_adversaire').value}`],
            ['Profession', document.getElementById('profession_adversaire').value],
            ['Antécédents', document.getElementById('antecedents_adversaire').value],
            ['État d\'esprit', document.getElementById('etat_esprit_adversaire_input').value || document.getElementById('etat_esprit_adversaire_select').value],
            ['Attitude', document.getElementById('attitude_adversaire').value],
            ['Volume', document.getElementById('volume_adversaire_input').value || document.getElementById('volume_adversaire_select').value],
            ['Substances', document.getElementById('substances_adversaire').value],
            ['Véhicules', vehiculesList],
            ['Armes', armesList],
            ['Modes d\'actions', `ME1: ${document.getElementById('mode_action_me1').value}`],
            ['', `ME2: ${document.getElementById('mode_action_me2').value}`],
            ['', `ME3: ${document.getElementById('mode_action_me3').value}`]
        ].filter(row => row[1]);

        doc.autoTable({
            startY: yPos,
            head: [['Position', 'Détails']],
            body: adversaireData,
            theme: 'plain',
            styles: { fontSize: 10, cellPadding: 5, textColor: [224, 224, 224] },
            headStyles: { fillColor: [42, 42, 42], textColor: [255, 255, 255] },
            didDrawPage: (data) => { yPos = data.cursor.y + 10; }
        });
        
        await addPhoto('photoAdversaire', 'Signes particuliers');

        // Page 3
        doc.addPage();
        yPos = 80;
        addHeaderAndFooter();
        addSectionTitle("1.4 ENVIRONNEMENT");
        addText("1.4 Ami(e)s", document.getElementById('amies').value);
        addText("1.5 Terrain / Environnement", document.getElementById('terrain_info').value);
        addText("1.6 Population", document.getElementById('population').value);
        addText("1.7 Cadre juridique", document.getElementById('cadre_juridique').value);
        
        // Page 4
        doc.addPage();
        yPos = 80;
        addHeaderAndFooter();
        addSectionTitle("2. MISSIONS du PSIG");
        addText("", document.getElementById('missions_psig').value);

        addSectionTitle("3. EXÉCUTION");
        addText("Date d'exécution", document.getElementById('date_execution').value);
        addText("Heure d'exécution", document.getElementById('heure_execution').value);
        addText("Type d'action", document.getElementById('type_action_input').value || document.getElementById('type_action_select').value);
        
        // ARTICULATION
        doc.addPage();
        yPos = 80;
        addHeaderAndFooter();
        addSectionTitle("4. ARTICULATION");

        const indiaMembers = Array.from(document.querySelectorAll('.india-input')).map(input => input.value).filter(val => val).join(', ');
        addText("ÉQUIPE INDIA (Interpellation)", indiaMembers);

        const oscarMembers = Array.from(document.querySelectorAll('.oscar-input')).map(input => input.value).filter(val => val).join(', ');
        addText("ÉQUIPE OSCAR (Observation/Appui)", oscarMembers);
        
        addText("Place du Chef", document.getElementById('place_chef').value);

        await addPhoto('photoCheminement', 'Itinéraire extérieur India');
        await addPhoto('photoTerrain', 'Baptême terrain');
        await addPhoto('photoPorte', 'Porte / Point d\'effraction');

        doc.save('ordre_initial.pdf');
    });
</script>

</body>
</html>
