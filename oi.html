<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 2em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
        h2 { font-size: 1.5em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        h3 { font-size: 1.2em; color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; }
        h4 { font-size: 1.0em; color: var(--text-secondary); margin-top: 10px; margin-bottom: 5px; }
        .wizard-progress { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 25px; list-style-type: none; padding: 0; }
        .wizard-progress-step {
            flex-grow: 1; padding: 8px 12px; text-align: center; font-size: 0.85em;
            color: var(--text-secondary); background-color: var(--bg-interactive);
            border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .wizard-progress-step:hover { background-color: var(--bg-body); }
        .wizard-progress-step.completed { border-color: var(--accent-blue); color: var(--accent-blue); }
        .wizard-progress-step.active {
            color: white; background-color: var(--accent-blue);
            border-color: var(--accent-blue); font-weight: 500;
        }
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .wizard-nav { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .wizard-nav-btn { width: 100%; margin-top: 10px; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; }
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); order: 1; }
        #nextBtn { background-color: var(--accent-blue); color: white; order: 2; }
        #previewBtn { background-color: #6c757d; color: white; order: 3; }
        #generatePdfBtn { background-color: #27ae60; color: white; order: 4; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        textarea { min-height: 120px; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .dynamic-list-item > *:not(button) { flex-grow: 1; margin-bottom: 0; }
        button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
        button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px 15px; }
        .collapsible-header h3 { margin: 0; font-size: 1.2em; }
        .collapsible-header .material-icons { transition: transform 0.3s; }
        .collapsible-container.open .collapsible-header .material-icons { transform: rotate(180deg); }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible-container.open .collapsible-content { max-height: 4000px; padding-top: 10px; padding-bottom: 15px; }
        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 45px; height: 45px; font-size: 24px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; border: none; background-color: transparent; }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
        #dockToggleBtn .material-icons { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-icons { transform: rotate(180deg); }
        .photo-input { display: none; }
        .file-upload-label { background-color: var(--accent-blue); color: white !important; padding: 8px 12px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-family: 'Oswald', sans-serif; font-weight: normal; display: inline-block; text-align: center; flex-shrink: 0; }
        .file-upload-label:hover { background-color: var(--accent-hover); }
        .file-name-display { color: var(--text-secondary); font-style: italic; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px; }
        .image-preview { max-width: 150px; max-height: 100px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); }
        .draggable { cursor: move; user-select: none; }
        .draggable.dragging { opacity: 0.5; }
        .patracdvr-members-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0; min-height: 50px; }
        .patracdvr-member-btn {
            background-color: var(--bg-body); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 8px 12px; border-radius: 5px;
            text-align: center; font-family: 'Oswald', sans-serif; cursor: pointer;
        }
        .patracdvr-member-btn:hover { border-color: var(--accent-blue); }
        .patracdvr-member-btn .trigramme { font-weight: bold; }
        .patracdvr-member-btn .fonction { font-size: 0.8em; color: var(--text-secondary); display: block; }
        #editMemberModal {
            color: var(--text-primary); background: var(--bg-container);
            width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh;
            margin: 0; border: none; border-radius: 0; padding: 15px;
        }
        #editMemberModal::backdrop { background: rgba(0, 0, 0, 0.85); }
        #editMemberModal #editMemberForm { display: flex; flex-direction: column; height: 100%; }
        #editMemberModal .modal-content { flex: 1 1 auto; overflow-y: auto; padding: 0 5px; }
        #editMemberModal .modal-actions { flex-shrink: 0; display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        #modal_cancelBtn { background-color: var(--bg-interactive); border: 1px solid var(--border-color); color: var(--text-primary); }
        #modal_deleteBtn { background-color: var(--danger-red); color: white; flex-grow: 0; }
        #modal_saveBtn { flex-grow: 1; }
        #modal_cancelBtn { flex-grow: 1; }
        @media (min-width: 600px) {
            #editMemberModal { width: 90%; max-width: 500px; height: auto; max-height: 90vh; margin: auto; border: 1px solid var(--border-color); border-radius: 8px; }
            .wizard-nav-btn { width: auto; margin-top: 0; }
            #prevBtn { order: 1; } #nextBtn { order: 2; }
            #previewBtn { order: 3; } #generatePdfBtn { order: 4; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="Réduire"><span class="material-icons">expand_more</span></div>
        <a href="#" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire"><span class="material-icons">refresh</span></div>
    </div>

    <dialog id="editMemberModal">
        <form id="editMemberForm" onsubmit="return false;">
            <h3>Éditer le membre</h3>
            <div class="modal-content">
                <label for="modal_trigramme">Trigramme:</label>
                <input type="text" id="modal_trigramme" placeholder="Trigramme">
                <label for="modal_fonction">Fonction:</label>
                <select id="modal_fonction"></select>
                <label for="modal_armement">Armement:</label>
                <select id="modal_armement"></select>
                <label for="modal_equipement">Équipement 1:</label>
                <select id="modal_equipement"></select>
                <label for="modal_equipement2">Équipement 2:</label>
                <select id="modal_equipement2"></select>
                <label for="modal_tenue">Tenue:</label>
                <select id="modal_tenue"></select>
                <label for="modal_gpb">GPB:</label>
                <select id="modal_gpb"></select>
            </div>
            <div class="modal-actions">
                <button type="button" id="modal_deleteBtn" class="remove-btn">Supprimer</button>
                <button type="button" id="modal_cancelBtn">Annuler</button>
                <button type="submit" id="modal_saveBtn" class="add-btn">Sauvegarder</button>
            </div>
        </form>
    </dialog>

    <div class="container">
        <h1>Générateur d'Ordre Initial</h1>
        
        <ul class="wizard-progress">
            <li class="wizard-progress-step" onclick="goToStep(0)">Situation</li>
            <li class="wizard-progress-step" onclick="goToStep(1)">Adversaire</li>
            <li class="wizard-progress-step" onclick="goToStep(2)">Environnement</li>
            <li class="wizard-progress-step" onclick="goToStep(3)">Mission</li>
            <li class="wizard-progress-step" onclick="goToStep(4)">Exécution</li>
            <li class="wizard-progress-step" onclick="goToStep(5)">Articulation</li>
            <li class="wizard-progress-step" onclick="goToStep(6)">PATRACDVR</li>
            <li class="wizard-progress-step" onclick="goToStep(7)">Photos</li>
            <li class="wizard-progress-step" onclick="goToStep(8)">CAT</li>
            <li class="wizard-progress-step" onclick="goToStep(9)">Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'opération :</label><input type="date" id="date_op">
                    <label for="situation_generale">1.1 Générale :</label><textarea id="situation_generale"></textarea>
                    <label for="situation_particuliere">1.2 Particulière :</label><textarea id="situation_particuliere"></textarea>
                </div>

                <div class="wizard-step">
                    <h2>1.3 Adversaire</h2>
                    <label>Photo de l'adversaire :</label>
                    <div id="adversary_photo_container"></div>
                    <label for="nom_adversaire">Nom/Prénom :</label><input type="text" id="nom_adversaire">
                    <label for="domicile_adversaire">Domicile :</label><textarea id="domicile_adversaire" rows="2"></textarea>
                    <label>Moyens Employés :</label><div id="me_container"></div><button type="button" class="add-btn" onclick="addMeField()">➕ ME</button>
                    <h3>Informations TO</h3>
                    <h4>Date et lieu de naissance :</h4>
                    <div class="dynamic-list-item"><input type="date" id="date_naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
                    <div class="dynamic-list-item"><input type="text" id="stature_adversaire" placeholder="Stature"><select id="ethnie_adversaire"><option>Caucasien</option><option>Nord africain</option><option>Afro-antillais</option><option>Asiatique</option></select></div>
                    <label for="signes_particuliers">Signes particuliers :</label><input type="text" id="signes_particuliers">
                    <label for="profession_adversaire">Profession :</label><input type="text" id="profession_adversaire">
                    <label for="antecedents_adversaire">Antécédents :</label><textarea id="antecedents_adversaire" rows="2"></textarea>
                    <label>État d'esprit :</label><div id="etat_esprit_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'])">➕</button>
                    <label for="attitude_adversaire">Attitude (connue) :</label><textarea id="attitude_adversaire" rows="2"></textarea>
                    <label>Volume (renfort potentiel) :</label><div id="volume_adversaire_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕</button>
                    <label for="substances_adversaire">Substances :</label><input type="text" id="substances_adversaire">
                    <label>Véhicules :</label><div id="vehicules_container"></div><button type="button" class="add-btn" onclick="addDynamicField('vehicules_container')">➕</button>
                    <label for="armes_connues">Armes connues :</label><input type="text" id="armes_connues">
                </div>
                
                <div class="wizard-step">
                    <h2>1.4 Environnement</h2>
                     <label>Ami(e)s (Unités en soutien) :</label><input type="text" id="amies">
                     <label>Terrain / Météo :</label><input type="text" id="terrain_info">
                     <label>Population :</label><input type="text" id="population">
                     <label>Cadre juridique :</label><input type="text" id="cadre_juridique">
                </div>

                <div class="wizard-step">
                    <h2>2. Mission du PSIG</h2>
                    <textarea id="missions_psig" rows="8">INTERPELLER L'OBJECTIF.

ASSISTER LORS DE LA PERQUISITION.

CONDUITE AU LIEU DE GAV.</textarea>
                </div>

                <div class="wizard-step">
                     <h2>3. Exécution</h2>
                     <label>Date d'exécution :</label><input type="date" id="date_execution">
                     <label>Heure d'exécution (H) :</label><input type="time" id="heure_execution" value="06:00">
                     <label>Type d'action :</label><input type="text" id="type_action">
                     <h3>Chronologie</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">➕</button>
                     <h3>Hypothèses</h3>
                     <label>H1 :</label><input type="text" id="hypothese_h1" value="Target présente LE1">
                     <label>H2 :</label><input type="text" id="hypothese_h2" value="Target présente LE2">
                     <label>H3 :</label><input type="text" id="hypothese_h3" value="Target absente LE 1 et 2">
                </div>

                <div class="wizard-step">
                     <h2>4. Articulation (MOIPC/ZMSPCP)</h2>
                     <label>Place du Chef (Générale) :</label><input type="text" id="place_chef">
                     <div class="collapsible-container">
                        <div class="collapsible-header"><h3>Équipe INDIA (INTER)</h3><span class="material-icons">expand_more</span></div>
                        <div class="collapsible-content">
                             <label for="india_mission">Mission :</label><textarea id="india_mission" rows="3">RECONNAÎTRE LE DOMICILE EN VUE D'APPRÉHENDER L'OBJECTIF</textarea>
                             <label for="india_objectif">Objectif :</label><input type="text" id="india_objectif">
                             <label for="india_itineraire">Itinéraire :</label><textarea id="india_itineraire" rows="3"></textarea>
                             <label for="india_points_particuliers">Points Particuliers :</label><textarea id="india_points_particuliers" rows="3"></textarea>
                             <label for="india_cat">Conduite à Tenir :</label><textarea id="india_cat" rows="6">- Si décelé, dynamiser jusqu'au domicile.
- Si présence tierce personne lors de la progression, contrôler.
- Si fuite, CR direction fuite + interpellation.
- Si rébellion, usage du strict niveau de force nécessaire.
- Si retranchement, CR + réarticulation pour fixer l'adversaire.</textarea>
                        </div>
                     </div>
                     <div class="collapsible-container">
                        <div class="collapsible-header"><h3>Équipe Appui/Observation (AO) - ZMSPCP</h3><span class="material-icons">expand_more</span></div>
                        <div class="collapsible-content">
                             <label for="ao_zone_installation">Zone d'installation (Z) :</label><textarea id="ao_zone_installation" rows="3"></textarea>
                             <label for="ao_mission">Mission (M) :</label><textarea id="ao_mission" rows="3">BOUCLER - SURVEILLER - INTERDIRE TOUTE FUITE</textarea>
                             <label for="ao_secteur_surveillance">Secteur de surveillance (S) :</label><textarea id="ao_secteur_surveillance" rows="3"></textarea>
                             <label for="ao_points_particuliers">Points Particuliers (P) :</label><textarea id="ao_points_particuliers" rows="3"></textarea>
                             <label for="ao_cat">Conduite à Tenir (C) :</label><textarea id="ao_cat" rows="6">- Compte rendu de mise en place.
- Renseigner régulièrement.
- Si décelé, CR.
- Si fuite, CR direction fuite + interpellation si rapport de force favorable.
- Si rébellion, usage du strict minimum de force nécessaire.</textarea>
                             <label for="ao_place_chef">Place du Chef (P) :</label><input type="text" id="ao_place_chef">
                        </div>
                     </div>
                </div>
                
                <div class="wizard-step">
                    <h2>5. PATRACDVR</h2>
                    <div id="patracdvr_container"></div>
                    <button type="button" class="add-btn" style="width:100%;" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
                </div>

                <div class="wizard-step">
                    <h2>Photos</h2>
                    <p>Ajoutez des photos complémentaires pour le PDF.</p>
                    <div class="form-section">
                        <h3>Transport PSIG vers PR</h3>
                        <div id="photo_container_transport_pr"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_pr')">Ajouter Photo ➕</button>
                    </div>
                     <div class="form-section">
                        <h3>Transport PR vers Domicile</h3>
                        <div id="photo_container_transport_domicile"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_domicile')">Ajouter Photo ➕</button>
                    </div>
                    <div class="form-section">
                         <h3>Baptême terrain</h3>
                        <div id="photo_container_bapteme_terrain"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_bapteme_terrain')">Ajouter Photo ➕</button>
                    </div>
                    <div class="form-section">
                        <h3>Emplacement AO</h3>
                        <div id="photo_container_emplacement_ao"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_emplacement_ao')">Ajouter Photo ➕</button>
                    </div>
                     <div class="form-section">
                        <h3>Itinéraire Extérieur</h3>
                        <div id="photo_container_itineraire_exterieur"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_exterieur')">Ajouter Photo ➕</button>
                    </div>
                     <div class="form-section">
                        <h3>Itinéraire Intérieur</h3>
                        <div id="photo_container_itineraire_interieur"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_interieur')">Ajouter Photo ➕</button>
                    </div>
                    <div class="form-section">
                        <h3>Cellule Effraction</h3>
                        <div id="photo_container_cellule_effraction"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_cellule_effraction')">Ajouter Photo ➕</button>
                    </div>
                </div>

                <div class="wizard-step">
                    <h2>Conduites à tenir</h2>
                    <h3>Générales</h3>
                    <textarea id="cat_generales" rows="6">- Si rébellion, user du strict niveau de force nécessaire
- Si retranché, alerter en mesure de se ré-articuler
- Si tente de fuir, alerter en mesure de jalonner/interpeller
- UDA : Article L435-1 du CSI + légitime défense</textarea>
                    
                    <h3>NO GO</h3>
                    <textarea id="no_go" rows="3" placeholder="Saisir les conditions de désengagement..."></textarea>

                    <h3>Liaison</h3>
                    <textarea id="cat_liaison" rows="4">TOM : 
DIR : 
Gestuelle et visuelle entre les éléments INDIA</textarea>
                </div>
                
                <div class="wizard-step">
                    <h2>Finalisation</h2>
                    <p style="text-align:center;">Vous êtes prêt. Cliquez sur "Aperçu" pour vérifier ou "Générer le PDF" pour créer votre document.</p>
                </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button">Précédent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button">Suivant</button>
            <button class="wizard-nav-btn" id="previewBtn" type="button" style="display:none;">Aperçu 🔎</button>
            <button class="wizard-nav-btn" id="generatePdfBtn" type="button" style="display:none;">Générer le PDF 📄</button>
        </div>
    </div>

    <script>
    /* pdf-lib@1.17.1 */
    !function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).pdfLib={})}(this,(function(t){"use strict";class e{constructor(t){this.array=t}}static from(t){return new e(t)}get(t){return this.array[t]}}class i{constructor(t){this.map=t}static from(t,i){return new i(t)}get(t){return this.map.get(i.isInstance(t)?t.toString():t)}}var s,r;!function(t){t.butt="butt",t.round="round",t.square="square"}(s||(s={})),function(t){t.miter="miter",t.round="round",t.bevel="bevel"}(r||(r={}));class h extends Uint8Array{static of(...t){return new h(t)}}var n;!function(t){t.AcroForm="AcroForm",t.Catalog="Catalog",t.EmbeddedFile="EmbeddedFile",t.Font="Font",t.FontDescriptor="FontDescriptor",t.Group="Group",t.Halftone="Halftone",t.ICCBased="ICCBased",t.Metadata="Metadata",t.ObjStm="ObjStm",t.OPI="OPI",t.Outlines="Outlines",t.OutputIntent="OutputIntent",t.Page="Page",t.Pages="Pages",t.Sig="Sig",t.StructElem="StructElem",t.StructTreeRoot="StructTreeRoot",t.XObject="XObject"}(n||(n={}));class a extends i{static from(t,i){return new a(new Map(Object.entries(t)),i)}constructor(t,i){super(t),this.pdfDoc=i}get(t){return this.map.get(t)}set(t,e){this.map.set(t,e)}has(t){return this.map.has(t)}keys(){return this.map.keys()}values(){return this.map.values()}entries(){return this.map.entries()}forEach(t){this.map.forEach(t)}clone(t){const e=new a(new Map(this.map),t||this.pdfDoc);if(e.set(l.Type,this.get(l.Type)),this.has(l.Subtype))e.set(l.Subtype,this.get(l.Subtype));return e}toString(){let t="<<\n";const e=Array.from(this.map.entries());for(let i=0,s=e.length;i<s;i++){const[s,r]=e[i];t+=`${s.toString()} ${r.toString()}`.concat("\n")}return t+=">>"}sizeInBytes(){let t=5;const e=Array.from(this.map.entries());for(let i=0,s=e.length;i<s;i++){const[s,r]=e[i];t+=s.sizeInBytes()+r.sizeInBytes()+1}return t}copyBytesInto(t,e){e+=this.pdfDoc.context.copyBytesInto(h.of(60,60,10),t,e);const i=Array.from(this.map.entries());for(let s=0,r=i.length;s<r;s++){const[r,h]=i[s];e=r.copyBytesInto(t,e),t[e]=32,e+=1,e=h.copyBytesInto(t,e),t[e]=10,e+=1}return e+=this.pdfDoc.context.copyBytesInto(h.of(62,62),t,e)}}var o;!function(t){t.Application="Application",t.Audio="Audio",t.Image="Image",t.Message="Message",t.Text="Text",t.Video="Video"}(o||(o={}));var c;!function(t){t.CreationDate="CreationDate",t.Creator="Creator",t.ModDate="ModDate",t.Producer="Producer",t.Subject="Subject",t.Title="Title"}(c||(c={}));var l;!function(t){t.Type="Type",t.Subtype="Subtype",t.Filter="Filter",t.Length="Length",t.First="First",t.N="N",t.FT="FT",t.EF="EF",t.F="F",t.UF="UF",t.DOS="DOS",t.Mac="Mac",t.Unix="Unix",t.ID="ID",t.Encrypt="Encrypt",t.Size="Size",t.Root="Root",t.Info="Info",t.Prev="Prev",t.DocChecksum="DocChecksum",t.DecodeParms="DecodeParms",t.Predictor="Predictor",t.Colors="Colors",t.BitsPerComponent="BitsPerComponent",t.Columns="Columns",t.EarlyChange="EarlyChange",t.Name="Name",t.ASCIIHexDecode="ASCIIHexDecode",t.ASCII85Decode="ASCII85Decode",t.LZWDecode="LZWDecode",t.FlateDecode="FlateDecode",t.RunLengthDecode="RunLengthDecode",t.CCITTFaxDecode="CCITTFaxDecode",t.JBIG2Decode="JBIG2Decode",t.DCTDecode="DCTDecode",t.JPXDecode="JPXDecode",t.Crypt="Crypt",t.Index="Index",t.W="W",t.Parent="Parent",t.Kids="Kids",t.Count="Count",t.MediaBox="MediaBox",t.CropBox="CropBox",t.BleedBox="BleedBox",t.TrimBox="TrimBox",t.ArtBox="ArtBox",t.Rotate="Rotate",t.Contents="Contents",t.Resources="Resources",t.XObject="XObject",t.Font="Font",t.ProcSet="ProcSet",t.Annots="Annots",t.PieceInfo="PieceInfo",t.LastModified="LastModified",t.Private="Private",t.StructParents="StructParents",t.StructTreeRoot="StructTreeRoot",t.ExtGState="ExtGState",t.ColorSpace="ColorSpace",t.Pattern="Pattern",t.Shading="Shading",t.FontDescriptor="FontDescriptor",t.FontName="FontName",t.Flags="Flags",t.FontBBox="FontBBox",t.ItalicAngle="ItalicAngle",t.Ascent="Ascent",t.Descent="Descent",t.CapHeight="CapHeight",t.XHeight="XHeight",t.StemV="StemV",t.StemH="StemH",t.AvgWidth="AvgWidth",t.MaxWidth="MaxWidth",t.MissingWidth="MissingWidth",t.FontFile="FontFile",t.FontFile2="FontFile2",t.FontFile3="FontFile3",t.CharSet="CharSet",t.BaseFont="BaseFont",t.FirstChar="FirstChar",t.LastChar="LastChar",t.Widths="Widths",t.Encoding="Encoding",t.MacRomanEncoding="MacRomanEncoding",t.WinAnsiEncoding="WinAnsiEncoding",t.Differences="Differences",t.BaseEncoding="BaseEncoding",t.ToUnicode="ToUnicode",t.DescendantFonts="DescendantFonts",t.DW="DW",t.CIDSystemInfo="CIDSystemInfo",t.Registry="Registry",t.Ordering="Ordering",t.Supplement="Supplement",t.CIDToGIDMap="CIDToGIDMap",t.Identity="Identity",t.Length1="Length1",t.Length2="Length2",t.Length3="Length3",t.Stream="stream",t.EndStream="endstream",t.Obj="obj",t.EndObj="endobj",t.PDF="PDF",t.Text="Text",t.ImageB="ImageB",t.ImageC="ImageC",t.ImageI="ImageI",t.MacExpertEncoding="MacExpertEncoding",t.PDFDocEncoding="PDFDocEncoding",t.StandardEncoding="StandardEncoding",t.SymbolEncoding="SymbolEncoding",t.ZapfDingbatsEncoding="ZapfDingbatsEncoding"}(l||(l={}));class d{constructor(t,e){this.dict=t,this.content=e}clone(t){const e=this.dict.clone(t);return new d(e,this.content.slice())}get(t){return this.dict.get(t)}set(t,e){this.dict.set(t,e)}has(t){return this.dict.has(t)}}class u{constructor(t){this.value=t}static from(t){return new u(t)}clone(){return u.from(this.value)}toString(){return this.value}sizeInBytes(){return this.value.length}copyBytesInto(t,e){const i=h.of(...this.value.split("").map(t=>t.charCodeAt(0)));return this.copyBytesInto=function(t,e){return i.copyBytesInto(t,e)},i.copyBytesInto(t,e)}}const m=u.from,g=u.from,p=u.from,f=u.from;class y{constructor(){this.lookup=new Map,this.reverseLookup=new Map}set(t,e){this.lookup.set(t,e),this.reverseLookup.set(e,t)}lookup(t){return this.lookup.get(t)}reverseLookup(t){return this.reverseLookup.get(t)}evolve(t,e){return t.set(l.Encoding,e),new w(t,this.lookup,this.reverseLookup)}}class w extends y{constructor(t,e,i){super(),this.fontObject=t,this.lookup=e,this.reverseLookup=i}}const b=new y;b.set(32,"space"),b.set(33,"exclam"),b.set(34,"quotedbl"),b.set(35,"numbersign"),b.set(36,"dollar"),b.set(37,"percent"),b.set(38,"ampersand"),b.set(39,"quotesingle"),b.set(40,"parenleft"),b.set(41,"parenright"),b.set(42,"asterisk"),b.set(43,"plus"),b.set(44,"comma"),b.set(45,"hyphen"),b.set(46,"period"),b.set(47,"slash"),b.set(48,"zero"),b.set(49,"one"),b.set(50,"two"),b.set(51,"three"),b.set(52,"four"),b.set(53,"five"),b.set(54,"six"),b.set(55,"seven"),b.set(56,"eight"),b.set(57,"nine"),b.set(58,"colon"),b.set(59,"semicolon"),b.set(60,"less"),b.set(61,"equal"),b.set(62,"greater"),b.set(63,"question"),b.set(64,"at"),b.set(65,"A"),b.set(66,"B"),b.set(67,"C"),b.set(68,"D"),b.set(69,"E"),b.set(70,"F"),b.set(71,"G"),b.set(72,"H"),b.set(73,"I"),b.set(74,"J"),b.set(75,"K"),b.set(76,"L"),b.set(77,"M"),b.set(78,"N"),b.set(79,"O"),b.set(80,"P"),b.set(81,"Q"),b.set(82,"R"),b.set(83,"S"),b.set(84,"T"),b.set(85,"U"),b.set(86,"V"),b.set(87,"W"),b.set(88,"X"),b.set(89,"Y"),b.set(90,"Z"),b.set(91,"bracketleft"),b.set(92,"backslash"),b.set(93,"bracketright"),b.set(94,"asciicircum"),b.set(95,"underscore"),b.set(96,"grave"),b.set(97,"a"),b.set(98,"b"),b.set(99,"c"),b.set(100,"d"),b.set(101,"e"),b.set(102,"f"),b.set(103,"g"),b.set(104,"h"),b.set(105,"i"),b.set(106,"j"),b.set(107,"k"),b.set(108,"l"),b.set(109,"m"),b.set(110,"n"),b.set(111,"o"),b.set(112,"p"),b.set(113,"q"),b.set(114,"r"),b.set(115,"s"),b.set(116,"t"),b.set(117,"u"),b.set(118,"v"),b.set(119,"w"),b.set(120,"x"),b.set(121,"y"),b.set(122,"z"),b.set(123,"braceleft"),b.set(124,"bar"),b.set(125,"braceright"),b.set(126,"asciitilde"),b.set(127,".notdef"),b.set(128,"Euro"),b.set(129,".notdef"),b.set(130,"quotesinglbase"),b.set(131,"florin"),b.set(132,"quotedblbase"),b.set(133,"ellipsis"),b.set(134,"dagger"),b.set(135,"daggerdbl"),b.set(136,"circumflex"),b.set(137,"perthousand"),b.set(138,"Scaron"),b.set(139,"guilsinglleft"),b.set(140,"OE"),b.set(141,".notdef"),b.set(142,"Zcaron"),b.set(143,".notdef"),b.set(144,".notdef"),b.set(145,"quoteleft"),b.set(146,"quoteright"),b.set(147,"quotedblleft"),b.set(148,"quotedblright"),b.set(149,"bullet"),b.set(150,"endash"),b.set(151,"emdash"),b.set(152,"tilde"),b.set(153,"trademark"),b.set(154,"scaron"),b.set(155,"guilsinglright"),b.set(156,"oe"),b.set(157,".notdef"),b.set(158,"zcaron"),b.set(159,"Ydieresis"),b.set(160,"space"),b.set(161,"exclamdown"),b.set(162,"cent"),b.set(163,"sterling"),b.set(164,"currency"),b.set(165,"yen"),b.set(166,"brokenbar"),b.set(167,"section"),b.set(168,"dieresis"),b.set(169,"copyright"),b.set(170,"ordfeminine"),b.set(171,"guillemotleft"),b.set(172,"logicalnot"),b.set(173,"hyphen"),b.set(174,"registered"),b.set(175,"macron"),b.set(176,"degree"),b.set(177,"plusminus"),b.set(178,"twosuperior"),b.set(179,"threesuperior"),b.set(180,"acute"),b.set(181,"mu"),b.set(182,"paragraph"),b.set(183,"periodcentered"),b.set(184,"cedilla"),b.set(185,"onesuperior"),b.set(186,"ordmasculine"),b.set(187,"guillemotright"),b.set(188,"onequarter"),b.set(189,"onehalf"),b.set(190,"threequarters"),b.set(191,"questiondown"),b.set(192,"Agrave"),b.set(193,"Aacute"),b.set(194,"Acircumflex"),b.set(195,"Atilde"),b.set(196,"Adieresis"),b.set(197,"Aring"),b.set(198,"AE"),b.set(199,"Ccedilla"),b.set(200,"Egrave"),b.set(201,"Eacute"),b.set(202,"Ecircumflex"),b.set(203,"Edieresis"),b.set(204,"Igrave"),b.set(205,"Iacute"),b.set(206,"Icircumflex"),b.set(207,"Idieresis"),b.set(208,"Eth"),b.set(209,"Ntilde"),b.set(210,"Ograve"),b.set(211,"Oacute"),b.set(212,"Ocircumflex"),b.set(213,"Otilde"),b.set(214,"Odieresis"),b.set(215,"multiply"),b.set(216,"Oslash"),b.set(217,"Ugrave"),b.set(218,"Uacute"),b.set(219,"Ucircumflex"),b.set(220,"Udieresis"),b.set(221,"Yacute"),b.set(222,"Thorn"),b.set(223,"germandbls"),b.set(224,"agrave"),b.set(225,"aacute"),b.set(226,"acircumflex"),b.set(227,"atilde"),b.set(228,"adieresis"),b.set(229,"aring"),b.set(230,"ae"),b.set(231,"ccedilla"),b.set(232,"egrave"),b.set(233,"eacute"),b.set(234,"ecircumflex"),b.set(235,"edieresis"),b.set(236,"igrave"),b.set(237,"iacute"),b.set(238,"icircumflex"),b.set(239,"idieresis"),b.set(240,"eth"),b.set(241,"ntilde"),b.set(242,"ograve"),b.set(243,"oacute"),b.set(244,"ocircumflex"),b.set(245,"otilde"),b.set(246,"odieresis"),b.set(247,"divide"),b.set(248,"oslash"),b.set(249,"ugrave"),b.set(250,"uacute"),b.set(251,"ucircumflex"),b.set(252,"udieresis"),b.set(253,"yacute"),b.set(254,"thorn"),b.set(255,"ydieresis");const v=new y;v.set(32,"space"),v.set(33,"exclam"),v.set(34,"quotedbl"),v.set(35,"numbersign"),v.set(36,"dollar"),v.set(37,"percent"),v.set(38,"ampersand"),v.set(39,"quotesingle"),v.set(40,"parenleft"),v.set(41,"parenright"),v.set(42,"asterisk"),v.set(43,"plus"),v.set(44,"comma"),v.set(45,"hyphen"),v.set(46,"period"),v.set(47,"slash"),v.set(48,"zero"),v.set(49,"one"),v.set(50,"two"),v.set(51,"three"),v.set(52,"four"),v.set(53,"five"),v.set(54,"six"),v.set(55,"seven"),v.set(56,"eight"),v.set(57,"nine"),v.set(58,"colon"),v.set(59,"semicolon"),v.set(60,"less"),v.set(61,"equal"),v.set(62,"greater"),v.set(63,"question"),v.set(64,"at"),v.set(65,"A"),v.set(66,"B"),v.set(67,"C"),v.set(68,"D"),v.set(69,"E"),v.set(70,"F"),v.set(71,"G"),v.set(72,"H"),v.set(73,"I"),v.set(74,"J"),v.set(75,"K"),v.set(76,"L"),v.set(77,"M"),v.set(78,"N"),v.set(79,"O"),v.set(80,"P"),v.set(81,"Q"),v.set(82,"R"),v.set(83,"S"),v.set(84,"T"),v.set(85,"U"),v.set(86,"V"),v.set(87,"W"),v.set(88,"X"),v.set(89,"Y"),v.set(90,"Z"),v.set(91,"bracketleft"),v.set(92,"backslash"),v.set(93,"bracketright"),v.set(94,"asciicircum"),v.set(95,"underscore"),v.set(96,"grave"),v.set(97,"a"),v.set(98,"b"),v.set(99,"c"),v.set(100,"d"),v.set(101,"e"),v.set(102,"f"),v.set(103,"g"),v.set(104,"h"),v.set(105,"i"),v.set(106,"j"),v.set(107,"k"),v.set(108,"l"),v.set(109,"m"),v.set(110,"n"),v.set(111,"o"),v.set(112,"p"),v.set(113,"q"),v.set(114,"r"),v.set(115,"s"),v.set(116,"t"),v.set(117,"u"),v.set(118,"v"),v.set(119,"w"),v.set(120,"x"),v.set(121,"y"),v.set(122,"z"),v.set(123,"braceleft"),v.set(124,"bar"),v.set(125,"braceright"),v.set(126,"asciitilde"),v.set(127,".notdef"),v.set(128,".notdef"),v.set(129,".notdef"),v.set(130,".notdef"),v.set(131,".notdef"),v.set(132,".notdef"),v.set(133,".notdef"),v.set(134,".notdef"),v.set(135,".notdef"),v.set(136,".notdef"),v.set(137,".notdef"),v.set(138,".notdef"),v.set(139,".notdef"),v.set(140,".notdef"),v.set(141,".notdef"),v.set(142,".notdef"),v.set(143,".notdef"),v.set(144,".notdef"),v.set(145,".notdef"),v.set(146,".notdef"),v.set(147,".notdef"),v.set(148,".notdef"),v.set(149,".notdef"),v.set(150,".notdef"),v.set(151,".notdef"),v.set(152,".notdef"),v.set(153,".notdef"),v.set(154,".notdef"),v.set(155,".notdef"),v.set(156,".notdef"),v.set(157,".notdef"),v.set(158,".notdef"),v.set(159,".notdef"),v.set(160,".notdef"),v.set(161,"exclamdown"),v.set(162,"cent"),v.set(163,"sterling"),v.set(164,"fraction"),v.set(165,"yen"),v.set(166,"florin"),v.set(167,"section"),v.set(168,"currency"),v.set(169,"quotesingle"),v.set(170,"quotedblleft"),v.set(171,"guillemotleft"),v.set(172,"guilsinglleft"),v.set(173,"guilsinglright"),v.set(174,"fi"),v.set(175,"fl"),v.set(176,".notdef"),v.set(177,"endash"),v.set(178,"dagger"),v.set(179,"daggerdbl"),v.set(180,"periodcentered"),v.set(181,".notdef"),v.set(182,"paragraph"),v.set(183,"bullet"),v.set(184,"quotesinglbase"),v.set(185,"quotedblbase"),v.set(186,"quotedblright"),v.set(187,"guillemotright"),v.set(188,"ellipsis"),v.set(189,"perthousand"),v.set(190,".notdef"),v.set(191,"questiondown"),v.set(192,".notdef"),v.set(193,"grave"),v.set(194,"acute"),v.set(195,"circumflex"),v.set(196,"tilde"),v.set(197,"macron"),v.set(198,"breve"),v.set(199,"dotaccent"),v.set(200,"dieresis"),v.set(201,".notdef"),v.set(202,"ring"),v.set(203,"cedilla"),v.set(204,".notdef"),v.set(205,"hungarumlaut"),v.set(206,"ogonek"),v.set(207,"caron"),v.set(208,"emdash"),v.set(209,".notdef"),v.set(210,".notdef"),v.set(211,".notdef"),v.set(212,".notdef"),v.set(213,".notdef"),v.set(214,".notdef"),v.set(215,".notdef"),v.set(216,".notdef"),v.set(217,".notdef"),v.set(218,".notdef"),v.set(219,".notdef"),v.set(220,".notdef"),v.set(221,".notdef"),v.set(222,".notdef"),v.set(223,".notdef"),v.set(224,"AE"),v.set(225,".notdef"),v.set(226,"Aacute"),v.set(227,"Acircumflex"),v.set(228,"Adieresis"),v.set(229,"Agrave"),v.set(230,"Aring"),v.set(231,"Ccedilla"),v.set(232,"Eacute"),v.set(233,"Ecircumflex"),v.set(234,"Edieresis"),v.set(235,"Egrave"),v.set(236,"Iacute"),v.set(237,"Icircumflex"),v.set(238,"Idieresis"),v.set(239,"Igrave"),v.set(240,"Ntilde"),v.set(241,"Oacute"),v.set(242,"Ocircumflex"),v.set(243,"Odieresis"),v.set(244,"Ograve"),v.set(245,"Oslash"),v.set(246,"Otilde"),v.set(247,"Uacute"),v.set(248,"Ucircumflex"),v.set(249,"Udieresis"),v.set(250,"Ugrave"),v.set(251,"dotlessi"),v.set(252,".notdef"),v.set(253,".notdef"),v.set(254,".notdef"),v.set(255,"germandbls");class S{constructor(t,e,i,s,r){this.x=t,this.y=e,this.width=i,this.height=s,this.color=r}clone(){const{x:t,y:e,width:i,height:s,color:h}=this;return new S(t,e,i,s,h.clone())}}class x{constructor(t,e,i,s,r,h,n,a,o){this.x=t,this.y=e,this.width=i,this.height=s,this.xSkew=r,this.ySkew=h,this.xScale=n,this.yScale=a,this.color=o}clone(){const{x:t,y:e,width:i,height:s,xSkew:h,ySkew:n,xScale:a,yScale:o,color:c}=this;return new x(t,e,i,s,h,n,a,o,c.clone())}}class C{constructor(t,e,i,s,r,h){this.x=t,this.y=e,this.font=i,this.size=s,this.text=r,this.color=h}clone(){const{x:t,y:e,font:i,size:s,text:h,color:n}=this;return new C(t,e,i,s,h,n.clone())}}class F{constructor(t,e,i,s,r,h,n){this.path=t,this.x=e,this.y=i,this.xScale=s,this.yScale=r,this.color=h,this.lineCap=n}clone(){const{path:t,x:e,y:i,xScale:s,yScale:r,color:h,lineCap:n}=this;return new F(t,e,i,s,r,h.clone(),n)}}class E{constructor(t,e,i,s,r,h,n,a,o){this.x=t,this.y=e,this.width=i,this.height=s,this.image=r,this.opacity=h,this.xSkew=n,this.ySkew=a,this.xScale=o}clone(){const{x:t,y:e,width:i,height:s,image:h,opacity:n,xSkew:a,ySkew:o,xScale:c}=this;return new E(t,e,i,s,h.clone(),n,a,o,c)}}class P{constructor(t,e,i,s,r,h,n,a,o,c,l){this.x=t,this.y=e,this.width=i,this.height=s,this.page=r,this.xSkew=h,this.ySkew=n,this.xScale=a,this.yScale=o,this.rotate=c,this.opacity=l}clone(){const{x:t,y:e,width:i,height:s,page:h,xSkew:n,ySkew:a,xScale:o,yScale:c,rotate:l,opacity:d}=this;return new P(t,e,i,s,h.clone(),n,a,o,c,l,d)}}class I{constructor(t,e,i,s,r){this.x=t,this.y=e,this.width=i,this.height=s,this.color=r}clone(){const{x:t,y:e,width:i,height:s,color:h}=this;return new I(t,e,i,s,h.clone())}}class k{constructor(t){this.operators=t}clone(){const t=new Array(this.operators.length);for(let e=0,i=this.operators.length;e<i;e++)t[e]=this.operators[e].clone();return new k(t)}toString(){let t="";for(let e=0,i=this.operators.length;e<i;e++)t+=this.operators[e].toString()+"\n";return t}sizeInBytes(){let t=0;for(let e=0,i=this.operators.length;e<i;e++)t+=this.operators[e].sizeInBytes()+1;return t}copyBytesInto(t,e){for(let i=0,s=this.operators.length;i<s;i++){e=this.operators[i].copyBytesInto(t,e),t[e]=10,e+=1}return e}}class A{constructor(t,e){this.name=t,this.args=e}toString(){let t="";for(let e=0,i=this.args.length;e<i;e++)t+=this.args[e].toString()+" ";return t+this.name}sizeInBytes(){let t=this.name.length;for(let e=0,i=this.args.length;e<i;e++)t+=this.args[e].sizeInBytes()+1;return t}copyBytesInto(t,e){for(let i=0,s=this.args.length;i<s;i++)e=(t[e]=32,this.args[i].copyBytesInto(t,e+1));return t[e]=32,this.pdfDoc.context.copyBytesInto(this.name,t,e+1)}}}));
    </script>
    <script>
        // --- SCRIPT PRINCIPAL DE L'APPLICATION ---

        // --- GESTION DU WIZARD ET DU FORMULAIRE (COMPLET ET STABLE) ---
        let currentStep = 0;
        let visitedSteps = new Set();
        const steps = Array.from(document.querySelectorAll(".wizard-step"));
        const progressSteps = Array.from(document.querySelectorAll(".wizard-progress-step"));
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const previewBtn = document.getElementById('previewBtn');
        const generatePdfBtn = document.getElementById('generatePdfBtn');

        function showStep(n) {
            steps.forEach((step, index) => step.classList.toggle('active', index === n));
            progressSteps.forEach((pStep, index) => {
                pStep.classList.toggle('active', index === n);
                if(visitedSteps.has(index) && index !== n) pStep.classList.add('completed');
                else pStep.classList.remove('completed');
            });
            prevBtn.style.display = n === 0 ? "none" : "inline-block";
            const isLastStep = n === (steps.length - 1);
            nextBtn.style.display = isLastStep ? "none" : "inline-block";
            previewBtn.style.display = isLastStep ? "inline-block" : "none";
            generatePdfBtn.style.display = isLastStep ? "inline-block" : "none";
        }
        function goToStep(n) {
            if (n >= 0 && n < steps.length) {
                visitedSteps.add(currentStep);
                saveFormData();
                currentStep = n;
                showStep(n);
            }
        }
        function changeStep(n) { goToStep(currentStep + n); }
        prevBtn.addEventListener('click', () => changeStep(-1));
        nextBtn.addEventListener('click', () => changeStep(1));
        
        // --- GESTION DES CHAMPS DYNAMIQUES ET DES PHOTOS ---
        function addPhotoInput(containerId, isSingle = false) {
            const container = document.getElementById(containerId);
            if (isSingle) container.innerHTML = '';
            const itemWrapper = document.createElement('div');
            itemWrapper.className = 'photo-input-wrapper';
            const uniqueId = `photo_${Date.now()}_${Math.random()}`;
            itemWrapper.innerHTML = `
                <div class="dynamic-list-item">
                    <input type="file" id="${uniqueId}" class="photo-input" accept="image/png, image/jpeg" onchange="handleFileChange(this, 'span_${uniqueId}', 'preview_${uniqueId}')">
                    <label for="${uniqueId}" class="file-upload-label">Choisir une photo</label>
                    <span id="span_${uniqueId}" class="file-name-display">Aucun fichier choisi</span>
                    ${!isSingle ? '<button type="button" class="remove-btn" onclick="this.closest(\'.photo-input-wrapper\').remove()">❌</button>' : ''}
                </div>
                <img id="preview_${uniqueId}" class="image-preview" style="display:none;" alt="Aperçu"/>`;
            container.appendChild(itemWrapper);
        }
        function handleFileChange(input, spanId, previewId) {
            const fileNameSpan = document.getElementById(spanId);
            const previewImg = document.getElementById(previewId);
            if (input.files.length > 0) {
                fileNameSpan.textContent = input.files[0].name;
                const reader = new FileReader();
                reader.onload = e => {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                fileNameSpan.textContent = 'Aucun fichier choisi';
                previewImg.src = '';
                previewImg.style.display = 'none';
            }
        }
        function addDynamicField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<input type="text" class="dynamic-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        function addDynamicFieldWithSelect(containerId, options, value = '') {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            const selectId = `select_${containerId}_${Math.random()}`;
            const inputId = `input_${containerId}_${Math.random()}`;
            item.innerHTML = `<select id="${selectId}" onchange="document.getElementById('${inputId}').value = this.value; saveFormData();"><option value="">Sélection</option>${options.map(o => `<option value="${o}" ${o === value ? 'selected':''}>${o}</option>`).join('')}</select><input type="text" id="${inputId}" class="dynamic-input" placeholder="Ou personnalisé" value="${value}" oninput="document.getElementById('${selectId}').value = ''; saveFormData();"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        function addMeField(value = '') {
            const container = document.getElementById('me_container');
            if (container.children.length >= 3) return;
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<label>ME${container.children.length + 1}:</label><input type="text" class="me-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        
        function addTimeEvent(type_from_load, hour_from_load = '', desc_from_load) {
            const container = document.getElementById('time_events_container');
            const isLoadingFromFile = type_from_load !== undefined;

            let type, hour = hour_from_load, desc;

            if (isLoadingFromFile) {
                type = type_from_load;
                desc = desc_from_load;
            } else {
                const currentEventCount = container.children.length;
                const prefilledData = [
                    { type: 'T0', desc: 'Rasso PSIG' },
                    { type: 'T1', desc: 'Départ PR' },
                    { type: 'T2', desc: 'Départ LE' },
                    { type: 'T3', desc: 'MEP TERMINÉ' },
                    { type: 'T4', desc: 'TOP ACTION' },
                ];
                const defaultValues = prefilledData[currentEventCount] || { type: `T${currentEventCount}`, desc: ''};
                type = defaultValues.type;
                desc = defaultValues.desc;
            }

            const item = document.createElement('div');
            item.className = 'dynamic-list-item time-item draggable';
            item.id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            item.setAttribute('draggable', 'true');
            const optionsHtml = ['T0','T1','T2','T3','T4','T5'].map(t => 
                `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`
            ).join('');
            item.innerHTML = `<select class="time-type-select" onchange="saveFormData()">${optionsHtml}</select><input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()"><input type="text" class="time-description-input" placeholder="Description" value="${desc || ''}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }


        // --- GESTION DU PATRACDVR AVEC MODAL ---
        const memberConfig = {
            fonctions: ['Chef inter','Chef dispo','AO','Inter','DE'],
            armements: ['Sans', 'UMP9', 'G36', 'PIE', 'LBD40', 'FAP'],
            equipements: ['Sans', 'BBAL', 'GENL', 'EFFRAC', 'MP7', 'IL'],
            equipements2: ['Sans', 'Échelle', 'Stop stick', 'Lacry', 'Cale'],
            tenues: ['UBAS', '4S', 'Bleu', 'Treillis', 'Civil'],
            gpbs: ['GPBL', 'GPBPD']
        };
        const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];

        function addPatracdvrRow(vehicle = availableVehicles[0], members = []) {
            const container = document.getElementById('patracdvr_container');
            const row = document.createElement('div');
            row.className = 'collapsible-container';

            row.innerHTML = `<div class="collapsible-header"><h3>Véhicule</h3><span class="material-icons">expand_more</span></div>
                             <div class="collapsible-content">
                                 <div class="dynamic-list-item">
                                     <select class="patracdvr-vehicle-select" onchange="saveFormData()">${availableVehicles.map(v => `<option value="${v}" ${v === vehicle ? 'selected':''}>${v}</option>`).join('')}</select>
                                     <button type="button" class="remove-btn">❌ Véhicule</button>
                                 </div>
                                 <div class="patracdvr-members-container"></div>
                                 <button type="button" class="add-btn">➕ Personnel</button>
                             </div>`;
            container.appendChild(row);
            
            const membersContainer = row.querySelector('.patracdvr-members-container');
            const addMemberButton = row.querySelector('.add-btn');

            row.querySelector('.remove-btn').addEventListener('click', () => { row.remove(); saveFormData(); });
            
            addMemberButton.addEventListener('click', () => {
                addPatracdvrMember(membersContainer);
            });
            
            enableDragAndDrop(membersContainer);
            if (members && members.length > 0) {
                 members.forEach(m => addPatracdvrMember(membersContainer, m));
            }
        }

        function addPatracdvrMember(containerElement, data = {}) {
            if (!containerElement) return;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'patracdvr-member-btn draggable';
            btn.id = `member_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            btn.setAttribute('draggable', 'true');

            const memberData = {
                trigramme: data.trigramme || 'N/A', fonction: data.fonction || 'Inter', armement: data.armement || 'Sans',
                equipement: data.equipement || 'Sans', equipement2: data.equipement2 || 'Sans',
                tenue: data.tenue || 'Treillis', gpb: data.gpb || 'GPBL'
            };
            Object.keys(memberData).forEach(key => btn.dataset[key] = memberData[key]);
            
            updateMemberButtonVisuals(btn);
            containerElement.appendChild(btn);
            btn.addEventListener('click', () => openMemberModal(btn.id));
        }
        
        function updateMemberButtonVisuals(btn) {
            const trigramme = btn.dataset.trigramme || 'N/A';
            const fonction = btn.dataset.fonction || '';
            btn.innerHTML = `<span class="trigramme">${trigramme}</span><span class="fonction">${fonction}</span>`;
        }

        function openMemberModal(buttonId) {
            const modal = document.getElementById('editMemberModal');
            const form = document.getElementById('editMemberForm');
            const button = document.getElementById(buttonId);
            if (!button) return;

            form.dataset.editingButtonId = buttonId;
            document.getElementById('modal_trigramme').value = button.dataset.trigramme;

            populateSelect('modal_fonction', memberConfig.fonctions, button.dataset.fonction);
            populateSelect('modal_armement', memberConfig.armements, button.dataset.armement);
            populateSelect('modal_equipement', memberConfig.equipements, button.dataset.equipement);
            populateSelect('modal_equipement2', memberConfig.equipements2, button.dataset.equipement2);
            populateSelect('modal_tenue', memberConfig.tenues, button.dataset.tenue);
            populateSelect('modal_gpb', memberConfig.gpbs, button.dataset.gpb);

            modal.showModal();
        }

        function populateSelect(selectId, options, selectedValue) {
            const select = document.getElementById(selectId);
            select.innerHTML = options.map(o => `<option value="${o}" ${o === selectedValue ? 'selected':''}>${o}</option>`).join('');
        }

        // --- PERSISTANCE DES DONNEES (SAVE/LOAD) ---
        function saveFormData() {
            try {
                const data = {};
                document.querySelectorAll('#oi-form input:not([type="file"]), #oi-form textarea, #oi-form select').forEach(field => {
                    if (field.id) data[field.id] = field.value;
                });
                data.me_list = Array.from(document.querySelectorAll('#me_container .me-input')).map(i => i.value).filter(Boolean);
                data.etat_esprit_list = Array.from(document.querySelectorAll(`#etat_esprit_container .dynamic-input`)).map(i => i.value).filter(Boolean);
                data.volume_list = Array.from(document.querySelectorAll(`#volume_adversaire_container .dynamic-input`)).map(i => i.value).filter(Boolean);
                data.vehicules_list = Array.from(document.querySelectorAll(`#vehicules_container .dynamic-input`)).map(i => i.value).filter(Boolean);
                data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .collapsible-container')).map(row => ({
                    vehicle: row.querySelector('.patracdvr-vehicle-select').value,
                    members: Array.from(row.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }))
                }));
                data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
                    type: item.querySelector('.time-type-select').value,
                    hour: item.querySelector('.time-hour-input').value,
                    description: item.querySelector('.time-description-input').value
                }));
                localStorage.setItem('oiFormData', JSON.stringify(data));
            } catch (e) { console.error("Save error:", e); }
        }

        function loadFormData() {
            const dataString = localStorage.getItem('oiFormData');
            if (!dataString) return;
            try {
                const data = JSON.parse(dataString);
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && !Array.isArray(data[key]) && typeof data[key] !== 'object') {
                        el.value = data[key];
                    }
                });
                (data.me_list || []).forEach(val => addMeField(val));
                (data.etat_esprit_list || []).forEach(val => addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'], val));
                (data.volume_list || []).forEach(val => addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'], val));
                (data.vehicules_list || []).forEach(val => addDynamicField('vehicules_container', val));
                (data.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
                (data.time_events || []).forEach(ev => addTimeEvent(ev.type, ev.hour, ev.description));
            } catch (e) { console.error("Load error:", e); }
        }

        // --- GLISSER-DEPOSER (DRAG & DROP) ---
        function enableDragAndDrop(container) {
            if (!container) return;
            let draggedItem = null;
            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('draggable')) {
                    draggedItem = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', e.target.id);
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            container.addEventListener('dragend', e => {
                if(draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (draggedItem) {
                    if (afterElement == null) {
                        container.appendChild(draggedItem);
                    } else {
                        container.insertBefore(draggedItem, afterElement);
                    }
                }
            });
            container.addEventListener('drop', e => {
                e.preventDefault();
                if(draggedItem) {
                    saveFormData();
                }
            });
        }
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- INITIALISATION ET ECOUTEURS D'EVENEMENTS ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.container').addEventListener('click', (event) => {
                const header = event.target.closest('.collapsible-header');
                if (header) {
                    const container = header.parentElement;
                    if (container && container.classList.contains('collapsible-container')) {
                        container.classList.toggle('open');
                    }
                }
            });
            
            const modal = document.getElementById('editMemberModal');
            const form = document.getElementById('editMemberForm');
            document.getElementById('modal_saveBtn').addEventListener('click', () => {
                const buttonId = form.dataset.editingButtonId;
                const button = document.getElementById(buttonId);
                if (button) {
                    button.dataset.trigramme = document.getElementById('modal_trigramme').value;
                    button.dataset.fonction = document.getElementById('modal_fonction').value;
                    button.dataset.armement = document.getElementById('modal_armement').value;
                    button.dataset.equipement = document.getElementById('modal_equipement').value;
                    button.dataset.equipement2 = document.getElementById('modal_equipement2').value;
                    button.dataset.tenue = document.getElementById('modal_tenue').value;
                    button.dataset.gpb = document.getElementById('modal_gpb').value;
                    updateMemberButtonVisuals(button);
                    saveFormData();
                }
                modal.close();
            });
            document.getElementById('modal_cancelBtn').addEventListener('click', () => modal.close());
            document.getElementById('modal_deleteBtn').addEventListener('click', () => {
                const buttonId = form.dataset.editingButtonId;
                const button = document.getElementById(buttonId);
                if(button && confirm(`Supprimer le membre ${button.dataset.trigramme || ''} ?`)) {
                    button.remove();
                    saveFormData();
                    modal.close();
                }
            });

            const dockMenu = document.getElementById('dockMenu');
            const dockToggleBtn = document.getElementById('dockToggleBtn');
            dockToggleBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                dockMenu.classList.toggle('collapsed');
                localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed'));
            });

            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                if (confirm("Voulez-vous vraiment réinitialiser tout le formulaire ?")) {
                    localStorage.removeItem('oiFormData');
                    location.reload();
                }
            });

            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.replace('dark-mode', 'light-mode');
                document.getElementById('darkModeIcon').textContent = 'clear_day';
            }
            if (localStorage.getItem('dockCollapsed') === 'true') {
                dockMenu.classList.add('collapsed');
            }

            addPhotoInput('adversary_photo_container', true);
            enableDragAndDrop(document.querySelector('#time_events_container'));
            loadFormData();
            showStep(currentStep);
        });
        
        // --- IMPLEMENTATION PDF PDF-LIB (FINALE ET FUSIONNÉE) ---
        async function processImage(file, maxWidth = 1280, quality = 0.85) {
            // Cette fonction est maintenant corrigée pour gérer correctement les promesses.
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        let { width, height } = img;
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(blob => {
                            const blobReader = new FileReader();
                            blobReader.onloadend = () => resolve(blobReader.result);
                            blobReader.onerror = reject;
                            blobReader.readAsArrayBuffer(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function buildPdf() {
            const { PDFDocument, StandardFonts, rgb, PageSizes } = pdfLib;
            const pdfDoc = await PDFDocument.create();
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            saveFormData();
            const formDataString = localStorage.getItem('oiFormData');
            if (!formDataString) { alert("Aucune donnée à générer."); return null; }
            const formData = JSON.parse(formDataString);
            const getVal = (id) => formData[id] || '';

            const isDarkMode = document.body.classList.contains('dark-mode');
            const context = {
                pdfDoc, helveticaFont, helveticaBoldFont,
                currentPage: null, y: 0,
                pageWidth: 0, pageHeight: 0, margin: 40,
                colors: isDarkMode ? {
                    background: rgb(30/255, 30/255, 30/255),
                    text: rgb(0.9, 0.9, 0.9),
                    accent: rgb(91/255, 155/255, 213/255)
                } : {
                    background: rgb(1, 1, 1),
                    text: rgb(0, 0, 0),
                    accent: rgb(0, 51/255, 160/255)
                }
            };
            
            let backgroundImage = null;
            try {
                const bgImageUrl = 'Fd.png';
                const bgImageBytes = await fetch(bgImageUrl).then(res => res.arrayBuffer());
                backgroundImage = await pdfDoc.embedPng(bgImageBytes);
            } catch (e) {
                console.warn("L'image de fond 'Fd.png' n'a pas pu être chargée.", e);
            }
            
            const addNewPage = () => {
                context.currentPage = context.pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]); // Paysage
                const { width, height } = context.currentPage.getSize();
                context.pageWidth = width; context.pageHeight = height;
                context.y = height - context.margin;
                context.currentPage.drawRectangle({ x: 0, y: 0, width, height, color: context.colors.background });
            };

            const checkY = (spaceNeeded) => {
                if (context.y - spaceNeeded < context.margin) {
                    addNewPage();
                    return true;
                }
                return false;
            };

            const drawTitle = (text) => {
                checkY(30);
                context.currentPage.drawText(text, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 18, color: context.colors.accent });
                context.y -= 30;
            };

            const drawSubTitle = (text) => {
                if (checkY(25)) { context.y -= 10; }
                context.currentPage.drawText(text, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 14, color: context.colors.accent });
                context.y -= 25;
            };
            
            const wrapText = (text, font, size, maxWidth) => {
                const words = String(text || '').replace(/\n/g, ' \n ').split(' ');
                let lines = []; let currentLine = '';
                for (const word of words) {
                    if (word === '\n') { lines.push(currentLine); currentLine = ''; continue; }
                    const lineWithWord = currentLine === '' ? word : `${currentLine} ${word}`;
                    if (font.widthOfTextAtSize(lineWithWord, size) > maxWidth && currentLine !== '') {
                        lines.push(currentLine);
                        currentLine = word;
                    } else { currentLine = lineWithWord; }
                }
                lines.push(currentLine);
                return lines;
            };

            const drawWrappedText = (text, options = {}) => {
                const { font = helveticaFont, size = 12, color = context.colors.text, x = context.margin + 15, lineHeight = 4 } = options;
                if (!text || text.trim() === '') return;
                const maxWidth = context.pageWidth - x - context.margin;
                const lines = wrapText(text, font, size, maxWidth);
                const totalHeight = lines.length * (size + lineHeight);
                if (checkY(totalHeight + 10)) {
                    context.y -= (size + lineHeight); 
                }
                lines.forEach((line, index) => {
                    context.currentPage.drawText(line, { x, y: context.y - (index * (size + lineHeight)), font, size, color });
                });
                context.y -= (totalHeight + 10);
            };
            
            const drawTable = (headers, rows, columnWidths, startX) => {
                let currentY = context.y;
                const rowPadding = 5; const headerFontSize = 10; const contentFontSize = 10;
                
                const drawRow = (rowData, isHeader) => {
                    const font = isHeader ? helveticaBoldFont : helveticaFont;
                    const size = isHeader ? headerFontSize : contentFontSize;
                    const cellContents = rowData.map((text, i) => wrapText(text, font, size, columnWidths[i] - 2 * rowPadding));
                    const maxLines = Math.max(...cellContents.map(lines => lines.length || 1));
                    const rowHeight = maxLines * (size + 2) + 2 * rowPadding;
                    if (currentY - rowHeight < context.margin) {
                        addNewPage(); currentY = context.y;
                        drawRow(headers, true);
                        currentY = context.y;
                    }
                    currentY -= rowHeight;
                    let currentX = startX;
                    rowData.forEach((_, i) => {
                        context.currentPage.drawRectangle({ x: currentX, y: currentY, width: columnWidths[i], height: rowHeight, borderColor: context.colors.accent, borderWidth: 0.5 });
                        const lines = cellContents[i];
                        lines.forEach((line, lineIndex) => {
                            context.currentPage.drawText(line, { x: currentX + rowPadding, y: currentY + rowHeight - rowPadding - (lineIndex + 1) * (size + 2) + 2, font, size, color: context.colors.text });
                        });
                        currentX += columnWidths[i];
                    });
                    if (isHeader) context.y = currentY;
                };
                drawRow(headers, true);
                rows.forEach(row => drawRow(row, false));
                context.y = currentY - 20;
            };

            const drawImagesFromContainer = async (containerId, title) => {
                const inputs = Array.from(document.querySelectorAll(`#${containerId} .photo-input`)).filter(i => i.files.length > 0);
                for (const input of inputs) {
                    addNewPage();
                    const file = input.files[0];
                    try {
                        const imageBytes = await processImage(file);
                        const image = await pdfDoc.embedJpg(imageBytes);
                        const { width, height } = context.currentPage.getSize();
                        const paddedW = width - context.margin * 2;
                        const paddedH = height - context.margin * 2 - 30;
                        const scaled = image.scaleToFit(paddedW, paddedH);
                        const x = (width - scaled.width) / 2;
                        const y = (height - scaled.height) / 2 + 15;
                        context.currentPage.drawImage(image, { x, y, width: scaled.width, height: scaled.height });
                        const textWidth = helveticaBoldFont.widthOfTextAtSize(title, 14);
                        context.currentPage.drawText(title, { x: width / 2 - textWidth / 2, y: y - 20, font: helveticaBoldFont, size: 14, color: context.colors.text });
                    } catch(e) { console.error("Could not process or embed image:", e); }
                }
            };
            
            // --- Construction du PDF ---
            addNewPage();
            if (backgroundImage) {
                context.currentPage.drawImage(backgroundImage, { x: 0, y: 0, width: context.pageWidth, height: context.pageHeight });
            }
            const mainTitle = "OPÉRATION DE POLICE JUDICIAIRE";
            const dateTitle = `DU ${getVal('date_op') || '(DATE)'}`;
            const titleWidth = helveticaBoldFont.widthOfTextAtSize(mainTitle, 24);
            const dateTitleWidth = helveticaBoldFont.widthOfTextAtSize(dateTitle, 18);
            context.currentPage.drawText(mainTitle, { x: context.pageWidth / 2 - titleWidth / 2, y: context.pageHeight / 2 + 10, font: helveticaBoldFont, size: 24, color: context.colors.accent });
            context.currentPage.drawText(dateTitle, { x: context.pageWidth / 2 - dateTitleWidth / 2, y: context.pageHeight / 2 - 20, font: helveticaBoldFont, size: 18, color: context.colors.text });

            addNewPage();
            drawTitle("1. SITUATION");
            drawSubTitle("1.1 Situation Générale");
            drawWrappedText(getVal('situation_generale'), { size: 14 });
            drawSubTitle("1.2 Situation Particulière");
            drawWrappedText(getVal('situation_particuliere'), { size: 14 });
            
            addNewPage();
            drawTitle("1.3 ADVERSAIRE");
            
            const initialAdversaireY = context.y;
            let photoBottomY = initialAdversaireY;
            const photoInput = document.querySelector('#adversary_photo_container .photo-input');

            if (photoInput && photoInput.files.length > 0) {
                const photoBoxWidth = 200;
                const photoBoxX = context.pageWidth - context.margin - photoBoxWidth;
                const file = photoInput.files[0];
                const imageBytes = await processImage(file);
                const image = await pdfDoc.embedJpg(imageBytes);
                const scaled = image.scaleToFit(photoBoxWidth - 10, context.pageHeight);
                const photoBoxHeight = scaled.height + 10;
                const frameY = initialAdversaireY - photoBoxHeight;
                if (frameY >= context.margin) {
                    context.currentPage.drawRectangle({ x: photoBoxX, y: frameY, width: photoBoxWidth, height: photoBoxHeight, borderColor: context.colors.accent, borderWidth: 1 });
                    context.currentPage.drawImage(image, { x: photoBoxX + 5, y: frameY + 5, width: scaled.width, height: scaled.height });
                    photoBottomY = frameY;
                }
            }
            const adversaireHeaders = ["Information", "Détail"];
            const meText = (formData.me_list || []).map((me, i) => `ME${i+1}: ${me}`).join(' | ');

            const adversaireRows = [
                ['Nom/Prénom', getVal('nom_adversaire')], ['Domicile', getVal('domicile_adversaire')],
                ['Naissance', `${getVal('date_naissance')} à ${getVal('lieu_naissance')}`],
                ['Description', `${getVal('stature_adversaire')} / ${getVal('ethnie_adversaire')}`],
                ['Signes particuliers', getVal('signes_particuliers')], ['Profession', getVal('profession_adversaire')],
                ['Antécédents', getVal('antecedents_adversaire')], ['État d\'esprit', (formData.etat_esprit_list || []).join(', ')],
                ['Attitude', getVal('attitude_adversaire')], ['Volume (renfort)', (formData.volume_list || []).join(', ')],
                ['Substances', getVal('substances_adversaire')], ['Véhicules', (formData.vehicules_list || []).join(', ')],
                ['Armes', getVal('armes_connues')],
                ['Moyens Employés', meText],
            ].filter(r => r[1] && r[1].replace(/à/g, '').trim() !== '' && r[1].trim() !== '/');
            
            const tableWidth = context.pageWidth - context.margin * 2 - (photoInput.files.length > 0 ? 210 : 0);
            context.y = initialAdversaireY;
            drawTable(adversaireHeaders, adversaireRows, [150, tableWidth - 150], context.margin);
            context.y = Math.min(context.y, photoBottomY);

            addNewPage();
            drawTitle("1.4 ENVIRONNEMENT");
            drawSubTitle("Ami(e)s (soutien)"); drawWrappedText(getVal('amies'));
            drawSubTitle("Terrain / Météo"); drawWrappedText(getVal('terrain_info'));
            drawSubTitle("Population"); drawWrappedText(getVal('population'));
            drawSubTitle("Cadre juridique"); drawWrappedText(getVal('cadre_juridique'));
            
            addNewPage();
            drawTitle("2. MISSION");
            drawWrappedText(getVal('missions_psig'), { font: helveticaBoldFont, size: 30, x: context.margin });
            
            await drawImagesFromContainer('photo_container_transport_pr', 'Transport PSIG vers PR');
            await drawImagesFromContainer('photo_container_transport_domicile', 'Transport PR vers Domicile');
            await drawImagesFromContainer('photo_container_bapteme_terrain', 'Baptême terrain');

            addNewPage();
            drawTitle("3. EXÉCUTION");
            const execText = `En vue d'appréhender le mis en cause et empêcher la déperdition des preuves,\nJe veux, le ${getVal('date_execution') || '(date)'} à partir de ${getVal('heure_execution') || '(heure)'}, pour une action ${getVal('type_action') || '(type d\'action)'} investir le domicile\nprésumé de ${getVal('nom_adversaire') || '(nom de l\'adversaire)'} après avoir bouclé celui-ci.`;
            drawWrappedText(execText, { size: 16, x: context.margin, lineHeight: 8 });

            drawSubTitle("Chronologie des temps");
            const chronoHeaders = ["Type", "Heure", "Description"];
            const chronoRows = (formData.time_events || []).map(e => [e.type, e.hour, e.description]);
            if(chronoRows.length > 0) drawTable(chronoHeaders, chronoRows, [80, 120, 550], context.margin);
            
            drawSubTitle("Hypothèses");
            drawWrappedText(`H1: ${getVal('hypothese_h1')}\nH2: ${getVal('hypothese_h2')}\nH3: ${getVal('hypothese_h3')}`);

            addNewPage();
            drawTitle("4. ARTICULATION");
            drawSubTitle("Place du Chef (Générale)"); drawWrappedText(getVal('place_chef'));
            
            drawSubTitle("Équipe INDIA (INTER)");
            drawWrappedText(`Mission: ${getVal('india_mission')}`);
            drawWrappedText(`Objectif: ${getVal('india_objectif')}`);
            drawWrappedText(`Itinéraire: ${getVal('india_itineraire')}`);
            drawWrappedText(`Points Particuliers: ${getVal('india_points_particuliers')}`);
            drawWrappedText(`Conduite à Tenir: \n${getVal('india_cat')}`);
            
            await drawImagesFromContainer('photo_container_itineraire_exterieur', 'Itinéraire Extérieur');
            await drawImagesFromContainer('photo_container_itineraire_interieur', 'Itinéraire Intérieur');
            
            addNewPage();
            drawTitle("4. ARTICULATION (Suite)");
            drawSubTitle("Équipe Appui/Observation (AO)");
            drawWrappedText(`Zone d'installation (Z): ${getVal('ao_zone_installation')}`);
            drawWrappedText(`Mission (M): ${getVal('ao_mission')}`);
            drawWrappedText(`Secteur de surveillance (S): ${getVal('ao_secteur_surveillance')}`);
            drawWrappedText(`Points Particuliers (P): ${getVal('ao_points_particuliers')}`);
            drawWrappedText(`Place du Chef (P): ${getVal('ao_place_chef')}`);
            drawWrappedText(`Conduite à Tenir (C): \n${getVal('ao_cat')}`);

            await drawImagesFromContainer('photo_container_emplacement_ao', 'Emplacement AO');
            await drawImagesFromContainer('photo_container_cellule_effraction', 'Cellule Effraction');
            
            addNewPage();
            drawTitle("5. PATRACDVR");
            const patracHeaders = ["Trigramme", "Fonction", "Armement", "Équip. 1", "Équip. 2", "Tenue", "GPB"];
            for (const row of (formData.patracdvr_rows || [])) {
                if(row.vehicle) {
                    drawSubTitle(`Véhicule: ${row.vehicle}`);
                    const patracRows = row.members.filter(m => m.trigramme && m.trigramme !== 'N/A').map(m => [m.trigramme, m.fonction, m.armement, m.equipement, m.equipement2, m.tenue, m.gpb]);
                    if (patracRows.length > 0) {
                        drawTable(patracHeaders, patracRows, [90, 100, 90, 100, 100, 90, 90], context.margin);
                    }
                }
            }
            
            addNewPage();
            drawTitle("Conduites à tenir");
            drawSubTitle("Générales");
            drawWrappedText(getVal('cat_generales'), {x: context.margin, font: helveticaBoldFont});

            const noGoText = getVal('no_go');
            if (noGoText) {
                drawSubTitle("NO GO");
                drawWrappedText(noGoText, { x: context.margin, font: helveticaBoldFont, size: 14.4, color: rgb(1, 0.2, 0.2) });
            }

            drawSubTitle("Liaison");
            drawWrappedText(getVal('cat_liaison'), {x: context.margin, font: helveticaBoldFont});

            addNewPage();
            if (backgroundImage) {
                context.currentPage.drawImage(backgroundImage, { x: 0, y: 0, width: context.pageWidth, height: context.pageHeight });
            }
            const finalText = "Avez vous des questions ?";
            const finalTextWidth = helveticaBoldFont.widthOfTextAtSize(finalText, 48);
            context.currentPage.drawText(finalText, { x: context.pageWidth / 2 - finalTextWidth / 2, y: context.pageHeight / 2, font: helveticaBoldFont, size: 48, color: context.colors.accent });

            const pdfBytes = await pdfDoc.save();
            return { pdfBytes, formData };
        }

        async function handlePdfAction(isPreview) {
            const btn = isPreview ? previewBtn : generatePdfBtn;
            const originalText = btn.textContent;
            btn.textContent = 'Génération...';
            btn.disabled = true;

            try {
                const result = await buildPdf();
                if (!result) {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    return;
                }
                
                const { pdfBytes, formData } = result;
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                if (isPreview) {
                    window.open(url, '_blank');
                } else {
                    const getVal = (id) => formData[id] || 'RAS';
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `OI_${getVal('date_op').replace(/[\/\\?%*:|"<>]/g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                }
            } catch (error) {
                console.error("Erreur critique lors de la génération du PDF:", error);
                alert("Erreur: " + error.toString() + "\n\nStack Trace:\n" + error.stack);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        previewBtn.addEventListener('click', () => handlePdfAction(true));
        generatePdfBtn.addEventListener('click', () => handlePdfAction(false));
    </script>
</body>
</html>
