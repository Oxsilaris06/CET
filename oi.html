<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial</title>
    <link rel="icon" href="maskable_icon(2).png" sizes="any" type="image/png">
    <link rel="icon" href="maskable_icon(2).png" type="image/svg+xml">
    <link rel="apple-touch-icon" href="maskable_icon(2).png">
    <link rel="manifest" href="site.webmanifest">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
            --success-green: #27ae60;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 10px; padding-bottom: 90px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 1.8em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
        h2 { font-size: 1.4em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        h3 { font-size: 1.1em; color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; }
        h4 { font-size: 1.0em; color: var(--text-secondary); margin-top: 10px; margin-bottom: 5px; }
        
        .wizard-progress { 
            display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; 
            margin-bottom: 25px; list-style-type: none; padding: 0; 
        }
        .wizard-progress-step {
            flex-grow: 1; padding: 8px 12px; text-align: center; font-size: 0.85em;
            color: var(--text-secondary); background-color: var(--bg-interactive);
            border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }

        .wizard-progress-step:hover { background-color: var(--bg-body); }
        .wizard-progress-step.completed { border-color: var(--accent-blue); color: var(--accent-blue); }
        .wizard-progress-step.active {
            color: white; background-color: var(--accent-blue);
            border-color: var(--accent-blue); font-weight: 500;
        }
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .wizard-nav { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; gap: 10px; }
        .wizard-nav-btn { flex-grow: 1; padding: 14px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; min-height: 48px;}

        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #nextBtn { background-color: var(--accent-blue); color: white; }
        #previewBtn { background-color: #6c757d; color: white; }
        #generatePdfBtn { background-color: #27ae60; color: white; }
        #retexReportBtn { background-color: #008080; color: white; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1.1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; min-height: 48px;}
        textarea { min-height: 120px; }
        
        .dynamic-list-item { 
            display: flex; flex-direction: column; align-items: stretch;
            gap: 10px; margin-bottom: 10px; 
        }
        .dynamic-list-item > *:not(button) { flex-grow: 1; margin-bottom: 0; }
        
        button.add-btn, button.remove-btn { min-height: 44px; }
        
        button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
        button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 15px; }
        .collapsible-header h3 { margin: 0; font-size: 1.2em; }
        .collapsible-header .material-symbols-outlined { transition: transform 0.3s; }
        .collapsible-container.open .collapsible-header .material-symbols-outlined { transform: rotate(180deg); }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible-container.open .collapsible-content { max-height: 4000px; padding-top: 10px; padding-bottom: 15px; }
        .articulation-composition-display p { margin-bottom: 5px; }
        .articulation-composition-display strong { color: var(--accent-blue); }

        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; border: none; background-color: transparent; }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
        #dockToggleBtn .material-symbols-outlined { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-symbols-outlined { transform: rotate(180deg); }
        .photo-input, #sessionFileInput, #jsonConfigInput { display: none; }
        .file-upload-label { background-color: var(--accent-blue); color: white !important; padding: 10px 14px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-family: 'Oswald', sans-serif; font-weight: normal; display: inline-block; text-align: center; flex-shrink: 0; }
        .file-upload-label:hover { background-color: var(--accent-hover); }
        .file-name-display { color: var(--text-secondary); font-style: italic; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .image-preview { max-width: 150px; max-height: 100px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); }
        .draggable { cursor: move; user-select: none; }
        .draggable.dragging { opacity: 0.5; }
        
        /* --- STYLES PATRACDVR (Mobile First) --- */
        #patracdvr_container, #unassigned_members_container { 
            display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; min-height: 70px; 
            border: 1px dashed var(--border-color); border-radius: 5px; align-content: flex-start;
        }
        .patracdvr-members-container, #unassigned_members_container {
            transition: border-color 0.2s;
        }

        .patracdvr-member-btn { 
            background-color: var(--bg-body); border: 2px solid var(--border-color); color: var(--text-primary); 
            padding: 8px 12px; border-radius: 5px; text-align: center; font-family: 'Oswald', sans-serif; 
            cursor: pointer; transition: all 0.2s; min-height: 56px; display: flex; flex-direction: column; justify-content: center;
        }
        .patracdvr-member-btn:hover { border-color: var(--accent-hover); }
        .patracdvr-member-btn.member-active { border-color: var(--accent-blue); box-shadow: 0 0 8px var(--accent-blue); }
        .patracdvr-member-btn .trigramme { font-weight: bold; }
        .patracdvr-member-btn .fonction { font-size: 0.8em; color: var(--text-secondary); display: block; }
        
        .patracdvr-vehicle-row {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            padding-top: 28px; /* Espace pour le nom et le bouton */
            border: 1px solid var(--border-color);
            background-color: var(--bg-body);
            border-radius: 5px;
            min-height: 56px; /* Hauteur de base, comme un bouton membre */
            min-width: 100px; /* Largeur de base */
            width: auto; /* S'adapte au contenu */
            align-items: flex-start;
            justify-content: flex-start;
        }
        .patracdvr-vehicle-row .patracdvr-members-container {
            border: 1px dashed var(--border-color);
            border-radius: 4px;
            min-height: 40px;
            width: 100%;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-content: flex-start;
        }
        .vehicle-header {
            position: absolute;
            top: 4px;
            left: 8px;
            right: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vehicle-name {
            font-size: 0.9em;
            font-weight: bold;
            color: var(--accent-blue);
        }
        .vehicle-header .remove-btn {
            padding: 2px 5px;
            min-height: unset;
            font-size: 12px;
        }
        #vehicle_creation_buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 5px; }
        .add-vehicle-btn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        
        #editMemberModal, #quickEditModal { color: var(--text-primary); background: var(--bg-container); width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; margin: 0; border: none; border-radius: 0; padding: 15px; }
        #editMemberModal::backdrop, #quickEditModal::backdrop { background: rgba(0, 0, 0, 0.85); }
        #editMemberModal #editMemberForm, #quickEditModal .modal-form { display: flex; flex-direction: column; height: 100%; }
        #editMemberModal .modal-content, #quickEditModal .modal-content { flex: 1 1 auto; overflow-y: auto; padding: 0 5px; }
        #editMemberModal .modal-actions, #quickEditModal .modal-actions { flex-shrink: 0; display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        #editMemberModal .modal-actions button, #quickEditModal .modal-actions button { flex: 1; }
        #modal_cancelBtn, #quick_modal_closeBtn { background-color: var(--bg-interactive); border: 1px solid var(--border-color); color: var(--text-primary); }
        #modal_deleteBtn { background-color: var(--danger-red); color: white; }

        /* --- STYLES PANNEAU D'ÉDITION RAPIDE --- */
        #quickEditPanel { display: none; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 20px; background-color: var(--bg-body); }
        #quickEditPanel h4 { margin-top: 0; }
        #quickEditPanel h4 #selectedMemberTrigramme { color: var(--accent-blue); }
        .quick-edit-content .quick-edit-tab-panel { display: none; }
        .quick-edit-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .quick-edit-btn { background-color: var(--bg-interactive); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 0.9em; transition: all 0.2s; }
        .quick-edit-btn:hover { border-color: var(--accent-hover); color: var(--text-primary); }
        .quick-edit-btn.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        #quickEditModal .quick-edit-category { margin-bottom: 20px; }
        #quickEditModal .quick-edit-category h5 { font-size: 1.1em; color: var(--text-secondary); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

        /* --- STYLES ANNOTATION --- */
        #annotationModal { width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; background: var(--bg-container); color: var(--text-primary); border: none; border-radius: 0; padding: 0; overflow: hidden; }
        #annotationModal::backdrop { background: rgba(0,0,0,0.85); }
        .annotation-wrapper { display: flex; flex-direction: column; height: 100%; }
        .annotation-toolbar { order: 2; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: var(--bg-body); border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .toolbar-main-tools, .toolbar-contextual-tools { display: flex; flex-wrap: wrap; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .toolbar-main-tools::-webkit-scrollbar, .toolbar-contextual-tools::-webkit-scrollbar { height: 4px; }
        .toolbar-main-tools::-webkit-scrollbar-thumb, .toolbar-contextual-tools::-webkit-scrollbar-thumb { background: var(--border-color); }
        .tool-btn { padding: 10px; font-family: 'Oswald', sans-serif; border: 1px solid var(--border-color); background: var(--bg-interactive); color: var(--text-primary); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 4px; flex-shrink: 0; min-width: 70px; }
        .tool-btn .material-symbols-outlined { font-size: 28px; }
        .tool-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .tool-controls, #contextual_tools { display: none; }
        .tool-controls.active, #contextual_tools.active { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 4px; }
        .tool-controls label { margin-bottom: 0; }
        .tool-controls input { margin-bottom: 0; padding: 8px; }
        #edit_text_btn { display: none; }
        #contextual_tools.active.location-selected #edit_text_btn { display: flex; }
        .annotation-actions { display: flex; justify-content: space-around; gap: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); margin-top: 10px;}
        .annotation-actions button { flex: 1; justify-content: center; }
        .annotation-canvas-container { order: 1; flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; padding: 5px; overflow: auto; min-height: 0; }
        #annotationCanvas { max-width: 100%; max-height: 100%; object-fit: contain; }

        @media (min-width: 768px) {
            body { padding: 15px; padding-bottom: 80px; }
            .dynamic-list-item { flex-direction: row; }
            #editMemberModal, #quickEditModal { width: 90%; max-width: 500px; height: auto; max-height: 90vh; margin: auto; border: 1px solid var(--border-color); border-radius: 8px; }
            #quickEditPanel { display: block; }
            .wizard-nav { flex-wrap: nowrap; }
            .wizard-nav-btn { width: auto; margin-top: 0; }
            #annotationModal { width: 95vw; max-width: 1400px; height: 95vh; border: 1px solid var(--border-color); border-radius: 8px;}
            .annotation-wrapper { flex-direction: row; }
            .annotation-toolbar { order: 1; flex-direction: column; width: 250px; border-top: none; border-right: 1px solid var(--border-color); }
            .toolbar-main-tools, .toolbar-contextual-tools { flex-direction: column; overflow-x: hidden; }
            .tool-btn { flex-direction: row; justify-content: flex-start; }
            .annotation-actions { flex-direction: column; margin-top: auto; padding-top: 20px; }
            .annotation-actions button { justify-content: flex-start; }
            .annotation-canvas-container { order: 2; padding: 10px; }
            
            /* Styles desktop pour le panneau d'édition */
            .quick-edit-tabs { display: none; } /* On cache les onglets */
            .quick-edit-content .quick-edit-tab-panel.active { display: block !important; } /* On affiche tous les panneaux */
            .quick-edit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
            .quick-edit-content h5 { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        }

        /* --- STYLES DU TUTORIEL --- */
        .tutorial-popup { position: absolute; background: var(--bg-container); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.35); z-index: 1001; width: 300px; display: none; flex-direction: column; gap: 10px; }
        .tutorial-popup p { margin-bottom: 0; }
        .tutorial-popup button { background-color: var(--accent-blue); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        .tutorial-popup .close-btn { position: absolute; top: 5px; right: 10px; font-size: 20px; cursor: pointer; color: var(--text-secondary); }
        .highlight-element { box-shadow: 0 0 0 5px var(--accent-blue) !important; transition: box-shadow 0.3s ease-in-out; position: relative; z-index: 1002; }

        @media (max-width: 600px) {
            .dock-menu:not(.collapsed) {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
                gap: 5px; 
                padding: 5px;
                width: 95%; 
                border: 1px solid var(--border-color);
                background-color: rgba(30, 30, 30, 0.7);
                backdrop-filter: blur(10px);
            }
            .dock-menu:not(.collapsed) .dock-menu-item {
                width: 100%; 
                height: 45px; 
                font-size: 24px;
                margin: 0; 
            }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="Réduire"><span class="material-symbols-outlined">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-symbols-outlined">home</span></a>
        <div class="dock-menu-item" id="importSessionBtn" title="Importer une session"><span class="material-symbols-outlined">file_upload</span></div>
        <div class="dock-menu-item" id="exportSessionBtn" title="Exporter la session"><span class="material-symbols-outlined">file_download</span></div>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire"><span class="material-symbols-outlined">refresh</span></div>
        <div class="dock-menu-item" id="tutorialBtn" title="Lancer le tutoriel"><span class="material-symbols-outlined">school</span></div>
    </div>
    <input type="file" id="sessionFileInput" accept=".json" />
    <input type="file" id="jsonConfigInput" accept=".json"/>

    <div id="tutorial-popup" class="tutorial-popup">
        <span class="close-btn">&times;</span>
        <p id="popup-text"></p>
        <button id="next-popup-btn">Suivant</button>
    </div>

    <dialog id="editMemberModal">
        <form id="editMemberForm" onsubmit="return false;">
            <h3>Éditer le membre</h3>
            <div class="modal-content">
                <label for="modal_trigramme">Trigramme:</label>
                <input type="text" id="modal_trigramme" placeholder="Trigramme">
                <label for="modal_fonction">Fonction:</label>
                <select id="modal_fonction"></select>
                <label for="modal_cellule">Cellule:</label>
                <select id="modal_cellule"></select>
                <label for="modal_armement">Armement:</label>
                <select id="modal_armement"></select>
                <label for="modal_equipement">Équipement 1:</label>
                <select id="modal_equipement"></select>
                <label for="modal_equipement2">Équipement 2:</label>
                <select id="modal_equipement2"></select>
                <label for="modal_tenue">Tenue:</label>
                <select id="modal_tenue"></select>
                <label for="modal_gpb">GPB:</label>
                <select id="modal_gpb"></select>
            </div>
            <div class="modal-actions">
                <button type="button" id="modal_deleteBtn" class="remove-btn">Renvoyer en Attente</button>
                <button type="button" id="modal_cancelBtn">Annuler</button>
                <button type="submit" id="modal_saveBtn" class="add-btn">Sauvegarder</button>
            </div>
        </form>
    </dialog>
    
    <dialog id="quickEditModal">
        <div class="modal-form">
            <h3 id="quick_modal_title">Édition rapide</h3>
            <div id="quick_modal_content" class="modal-content"></div>
            <div class="modal-actions">
                <button type="button" id="quick_modal_closeBtn">Fermer</button>
            </div>
        </div>
    </dialog>

    <dialog id="annotationModal">
        <div class="annotation-wrapper">
            <div class="annotation-toolbar">
                 <div id="contextual_tools">
                     <div class="toolbar-contextual-tools">
                         <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                             <label for="rotation_input" style="font-size: 0.8em; margin:0;">Rotation (Degrés)</label>
                             <input type="number" id="rotation_input" min="0" max="360" step="1" value="0" style="max-width: 80px; text-align: center; padding: 5px; height: 35px; margin: 0;" onchange="updateAnnotationRotation()">
                         </div>
                         <button id="edit_text_btn" class="tool-btn"><span class="material-symbols-outlined">edit</span>Texte</button>
                         <button id="delete_btn" class="tool-btn" style="background-color: var(--danger-red); color: white;"><span class="material-symbols-outlined">delete</span>Supprimer</button>
                    </div>
                 </div>
                 <div class="toolbar-main-tools">
                     <button id="tool_move" class="tool-btn active"><span class="material-symbols-outlined">open_with</span>Déplacer/Redim.</button>
                     <button id="tool_location" class="tool-btn"><span class="material-symbols-outlined">place</span>Emplacement</button>
                     <button id="tool_arrow" class="tool-btn"><span class="material-symbols-outlined">arrow_right_alt</span>Désigner</button>
                     <button id="tool_box" class="tool-btn"><span class="material-symbols-outlined">crop_square</span>Encadrer</button>
                 </div>
                 <div id="controls_location" class="tool-controls">
                     <label for="circle_text">Texte:</label>
                     <input type="text" id="circle_text" value="Zone">
                     <label for="circle_opacity">Transparence:</label>
                     <input type="range" id="circle_opacity" min="0.1" max="1" step="0.1" value="0.5">
                 </div>
                 <div id="controls_arrow" class="tool-controls">
                     <label for="arrow_thickness">Épaisseur:</label>
                     <input type="range" id="arrow_thickness" min="1" max="25" step="1" value="5">
                 </div>
                 <div id="controls_box" class="tool-controls">
                     <label for="box_thickness">Épaisseur:</label>
                     <input type="range" id="box_thickness" min="1" max="20" step="1" value="5">
                 </div>
                 <div class="annotation-actions">
                     <button id="tool_reset" class="tool-btn"><span class="material-symbols-outlined">delete_sweep</span></button>
                     <button id="annotation_cancel" class="tool-btn">Annuler</button>
                     <button id="annotation_save" class="tool-btn" style="background-color: #27ae60; color: white;"><span class="material-symbols-outlined">save</span></button>
                 </div>
            </div>
            <div class="annotation-canvas-container">
                <canvas id="annotationCanvas"></canvas>
            </div>
        </div>
    </dialog>

    <div class="container">
        <h1>Générateur d'Ordre Initial</h1>
        
        <ul class="wizard-progress">
            <li class="wizard-progress-step" onclick="goToStep(0)">Situation</li>
            <li class="wizard-progress-step" onclick="goToStep(1)">Adversaire</li>
            <li class="wizard-progress-step" onclick="goToStep(2)">Environnement</li>
            <li class="wizard-progress-step" onclick="goToStep(3)">Mission</li>
            <li class="wizard-progress-step" onclick="goToStep(4)">Exécution</li>
            <li class="wizard-progress-step" onclick="goToStep(5)">Articulation</li>
            <li class="wizard-progress-step" onclick="goToStep(6)">PATRACDVR</li>
            <li class="wizard-progress-step" onclick="goToStep(7)">Photos</li>
            <li class="wizard-progress-step" onclick="goToStep(8)">CAT</li>
            <li class="wizard-progress-step" onclick="goToStep(9)">Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'opération:</label><input type="date" id="date_op">
                    <label for="situation_generale">1.1 Générale:</label><textarea id="situation_generale"></textarea>
                    <label for="situation_particuliere">1.2 Particulière:</label><textarea id="situation_particuliere"></textarea>
                </div>

                <div class="wizard-step">
                    <h2>1.3 Adversaire</h2>
                    <label>Photo principale de l'adversaire:</label>
                    <div id="adversary_photo_container"></div>
                    <label for="nom_adversaire">Nom/Prénom:</label><input type="text" id="nom_adversaire">
                    <label for="domicile_adversaire">Domicile:</label><textarea id="domicile_adversaire" rows="2"></textarea>
                    <label>Moyens Employés:</label><div id="me_container"></div><button type="button" class="add-btn" onclick="addMeField()">➕ ME</button>
                    <h3>Informations TO</h3>
                    <h4>Date et lieu de naissance:</h4>
                    <div class="dynamic-list-item"><input type="date" id="date_naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
                    <div class="dynamic-list-item"><input type="text" id="stature_adversaire" placeholder="Stature"><select id="ethnie_adversaire"><option>Caucasien</option><option>Nord africain</option><option>Afro-antillais</option><option>Asiatique</option></select></div>
                    <label for="signes_particuliers">Signes particuliers:</label><input type="text" id="signes_particuliers">
                    <label for="profession_adversaire">Profession:</label><input type="text" id="profession_adversaire">
                    <label for="antecedents_adversaire">Antécédents:</label><textarea id="antecedents_adversaire" rows="2"></textarea>
                    <label>État d'esprit:</label><div id="etat_esprit_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'])">➕</button>
                    <label for="attitude_adversaire">Attitude (connue):</label><textarea id="attitude_adversaire" rows="2"></textarea>
                    <label>Volume (renfort potentiel):</label><div id="volume_adversaire_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕</button>
                    
                    <h3>Photos des renforts potentiels</h3>
                    <div id="renforts_photo_container"></div>
                    <button type="button" class="add-btn" onclick="addPhotoInput('renforts_photo_container')">Ajouter Photo Renfort ➕</button>
                    
                    <h3 style="margin-top: 20px;">Photos supplémentaires de l'adversaire</h3>
                    <div id="adversary_extra_photos_container"></div>
                    <button type="button" class="add-btn" onclick="addPhotoInput('adversary_extra_photos_container')">Ajouter Photo Adversaire ➕</button>
                    <label for="substances_adversaire">Substances:</label><input type="text" id="substances_adversaire">
                    <label>Véhicules:</label><div id="vehicules_container"></div><button type="button" class="add-btn" onclick="addDynamicField('vehicules_container')">➕</button>
                    <label for="armes_connues">Armes connues:</label><input type="text" id="armes_connues">
                </div>
                
                <div class="wizard-step">
                    <h2>1.4 Environnement</h2>
                    <label>Ami(e)s (Unités en soutien):</label><input type="text" id="amies">
                    <label>Terrain / Météo:</label><input type="text" id="terrain_info">
                    <label>Population:</label><input type="text" id="population">
                    <label for="cadre_juridique">Cadre juridique:</label><input type="text" id="cadre_juridique">
                </div>

                <div class="wizard-step">
                    <h2>2. Mission du PSIG</h2>
                    <textarea id="missions_psig" rows="8">

INTERPELLER L'OBJECTIF.

ASSISTER LORS DE LA PERQUISITION.

CONDUITE AU LIEU DE GAV.</textarea>
                </div>

                <div class="wizard-step">
                    <h2>3. Exécution</h2>
                    <label for="date_execution">Date d'exécution:</label><input type="date" id="date_execution">
                    <label for="heure_execution">Heure d'exécution (H):</label><input type="time" id="heure_execution" value="06:00">
                    <label for="type_action">Type d'action:</label><input type="text" id="type_action">
                    <h3>Chronologie</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">➕</button>
                    <h3>Hypothèses</h3>
                    <label for="hypothese_h1">H1:</label><input type="text" id="hypothese_h1" value="Target présente LE1">
                    <label for="hypothese_h2">H2:</label><input type="text" id="hypothese_h2" value="Target présente LE2">
                    <label for="hypothese_h3">H3:</label><input type="text" id="hypothese_h3" value="Target absente LE 1 et 2">
                </div>

                <div class="wizard-step">
                    <h2>4. Articulation (MOIPC/ZMSPCP)</h2>
                    <label for="place_chef">Place du Chef (Générale):</label><input type="text" id="place_chef">
                    <div class="collapsible-container">
                        <div class="collapsible-header"><h3>Équipe INDIA (INTER)</h3><span class="material-symbols-outlined">expand_more</span></div>
                        <div class="collapsible-content">
                            <label for="india_mission">Mission:</label><textarea id="india_mission" rows="3">RECONNAÎTRE LE DOMICILE EN VUE D'APPRÉHENDER L'OBJECTIF</textarea>
                            
                            <h3>Composition</h3>
                            <div id="india_composition_display" class="articulation-composition-display">
                                <p><i>La composition sera affichée ici après configuration dans l'onglet PATRACDVR.</i></p>
                            </div>

                            <label for="india_objectif">Objectif:</label><input type="text" id="india_objectif">
                            <label for="india_itineraire">Itinéraire:</label><textarea id="india_itineraire" rows="3"></textarea>
                            
                            <h3>Photos - Itinéraire</h3>
                            <h4>Itinéraire Extérieur</h4>
                            <div id="photo_container_itineraire_exterieur"></div>
                            <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_exterieur')">Ajouter Photo ➕</button>
                            <h4>Itinéraire Intérieur</h4>
                            <div id="photo_container_itineraire_interieur"></div>
                            <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_interieur')">Ajouter Photo ➕</button>

                            <label for="india_points_particuliers">Points Particuliers:</label><textarea id="india_points_particuliers" rows="3"></textarea>
                            <label for="india_cat">Conduite à Tenir:</label><textarea id="india_cat" rows="6">- Si décelé, dynamiser jusqu'au domicile.
- Si présence tierce personne lors de la progression, contrôler.
- Si fuite, CR direction fuite + interpellation.
- Si rébellion, usage du strict niveau de force nécessaire.
- Si retranchement, CR + réarticulation pour fixer l'adversaire.</textarea>
                        </div>
                    </div>
                    <div class="collapsible-container">
                        <div class="collapsible-header"><h3>Équipe Appui/Observation (AO) - ZMSPCP</h3><span class="material-symbols-outlined">expand_more</span></div>
                        <div class="collapsible-content">
                            
                            <h3>Composition</h3>
                            <div id="ao_composition_display" class="articulation-composition-display">
                                <p><i>La composition sera affichée ici après configuration dans l'onglet PATRACDVR.</i></p>
                            </div>

                            <label for="ao_zone_installation">Zone d'installation (Z):</label><textarea id="ao_zone_installation" rows="3"></textarea>
                            <h3>Photos - Zone d'installation</h3>
                            <h4>Baptême terrain</h4>
                            <div id="photo_container_bapteme_terrain"></div>
                            <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_bapteme_terrain')">Ajouter Photo ➕</button>
                            <h4>Emplacement AO</h4>
                            <div id="photo_container_emplacement_ao"></div>
                            <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_emplacement_ao')">Ajouter Photo ➕</button>

                            <label for="ao_mission">Mission (M):</label><textarea id="ao_mission" rows="3">BOUCLER - SURVEILLER - INTERDIRE TOUTE FUITE</textarea>
                            <label for="ao_secteur_surveillance">Secteur de surveillance (S):</label><textarea id="ao_secteur_surveillance" rows="3"></textarea>
                            <label for="ao_points_particuliers">Points Particuliers (P):</label><textarea id="ao_points_particuliers" rows="3"></textarea>
                            <label for="ao_cat">Conduite à Tenir (C):</label><textarea id="ao_cat" rows="6">- Compte rendu de mise en place.
- Renseigner régulièrement.
- Si décelé, CR.
- Si fuite, CR direction fuite + interpellation si rapport de force favorable.
- Si rébellion, usage du strict minimum de force nécessaire.
- Si retranchement, CR + réarticulation pour fixer l'adversaire.</textarea>
                            <label for="ao_place_chef">Place du Chef (P):</label><input type="text" id="ao_place_chef">
                        </div>
                    </div>
                </div>
                
                <div class="wizard-step">
                    <h2>5. PATRACDVR</h2>
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px;">
                        
                        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px;">
                            <button type="button" id="importJsonConfigBtn" class="add-btn" style="background-color: var(--success-green); flex-grow: 1;">Importer Configuration Membres (.json) 📤</button>
                            <button type="button" id="resetPatracdvrBtn" class="remove-btn" style="flex-grow: 1;">Réinitialiser PATRACDVR</button>
                        </div>
                    </div>

                    <div id="quickEditPanel">
                        <h4>Membre: <span id="selectedMemberTrigramme">Aucun</span>
                            <button type="button" id="fullEditBtn" class="add-btn" style="font-size: 0.8em; padding: 5px 8px; margin-left: 15px;">Édition Complète</button>
                        </h4>
                        <div class="quick-edit-content"></div>
                    </div>

                    <h4 style="margin-top: 20px;">Ajouter un véhicule ou un membre</h4>
                    <div id="vehicle_creation_buttons">
                        <button type="button" class="add-btn add-vehicle-btn" id="addManualVehicleBtn">➕ Véhicule Manuel</button>
                        <button type="button" class="add-btn add-vehicle-btn" id="addManualMemberBtn">➕ Membre Manuel</button>
                    </div>

                    <h4 style="margin-top: 20px;">Composition des véhicules</h4>
                    <div id="patracdvr_container"></div>
                    
                    <h4 style="margin-top: 20px;">Personnel à attribuer</h4>
                    <div id="unassigned_members_container"></div>
                </div>

                <div class="wizard-step">
                    <h2>Photos</h2>
                    <p>Ajoutez des photos complémentaires pour le PDF.</p>
                    <div class="form-section">
                        <h3>Transport PSIG vers PR</h3>
                        <div id="photo_container_transport_pr"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_pr')">Ajouter Photo ➕</button>
                    </div>
                     <div class="form-section">
                        <h3>Transport PR vers Domicile</h3>
                        <div id="photo_container_transport_domicile"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_domicile')">Ajouter Photo ➕</button>
                    </div>
                    <div class="form-section">
                        <h3>Cellule Effraction</h3>
                        <div id="photo_container_cellule_effraction"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_cellule_effraction')">Ajouter Photo ➕</button>
                    </div>
                </div>

                <div class="wizard-step">
                    <h2>Conduites à tenir</h2>
                    <h3>Générales</h3>
                    <textarea id="cat_generales" rows="6">- Si rébellion, user du strict niveau de force nécessaire
- Si retranché, alerter en mesure de se ré-articuler
- Si tente de fuir, alerter en mesure de jalonner/interpeller
- UDA : Article L435-1 du CSI + légitime défense</textarea>
                    
                    <h3>NO GO</h3>
                    <textarea id="no_go" rows="3" placeholder="Saisir les conditions de désengagement..."></textarea>
                    <h3>Liaison</h3>
                    <textarea id="cat_liaison" rows="4">TOM: 
DIR: 
Gestuelle et visuelle entre les éléments INDIA</textarea>
                </div>
                
                <div class="wizard-step">
                    <h2>Finalisation</h2>
                    <p style="text-align:center;">Vous êtes prêt. Cliquez sur "Aperçu" pour vérifier ou "Générer le PDF" pour créer votre document.</p>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                        <button class="wizard-nav-btn" id="previewBtn" type="button">Aperçu 🔎</button>
                        <button class="wizard-nav-btn" id="generatePdfBtn" type="button">Générer le PDF 📄</button>
                        <button class="wizard-nav-btn" id="retexReportBtn" type="button">Consulter Rapport RETEX 🧠</button>
                    </div>
                </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button">Précédent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button">Suivant</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
    // --- NOUVELLE CONFIGURATION & VARIABLES GLOBALES ---
    const RETEX_BASE_URL = "https://oxsilaris06.github.io/CET/retex.html";
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyF0CJ_B9U4Izn6ieZG4lfIq23oScE6cFvd1SoUXvVUBRqk_Ce1R8TJpRRnuamcdJH-/exec";
    
    // --- GLOBAL CONFIG (Défaut interne, mutable pour le chargement) ---
    let memberConfig = { 
        fonctions: ['Chef inter', 'Chef dispo', 'DE', 'Sans', 'Inter', 'AO'],
        cellules: ['AO1','AO2','AO3','AO4','AO5','AO6','India 1','India 2','India 3','India 4','India 5', 'Sans'],
        armements: ['Sans', 'UMP9', 'G36', 'PIE', 'LBD40', 'FAP'],
        equipements: ['Sans', 'BBAL', 'GENL', 'EFFRAC', 'MP7', 'IL'],
        equipements2: ['Sans', 'Échelle', 'Stop stick', 'Lacry', 'Cale'],
        tenues: ['UBAS', '4S', 'Bleu', 'Treillis', 'Civil'],
        gpbs: ['GPBL', 'GPBPD']
    };
    const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];
    const DEFAULT_CONFIG_FILE = 'members_config.json'; // Fichier à charger par défaut si pas de localStorage
    
    // --- GLOBAL STATE ---
    let activeMemberId = null;

    // --- WIZARD & FORM MANAGEMENT ---
    let currentStep = 0;
    let visitedSteps = new Set();
    const steps = Array.from(document.querySelectorAll(".wizard-step"));
    const progressSteps = Array.from(document.querySelectorAll(".wizard-progress-step"));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const previewBtn = document.getElementById('previewBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    const retexReportBtn = document.getElementById('retexReportBtn');
    const patracdvrContainer = document.getElementById('patracdvr_container');
    const unassignedContainer = document.getElementById('unassigned_members_container');
    const jsonConfigInput = document.getElementById('jsonConfigInput');
    const resetPatracdvrBtn = document.getElementById('resetPatracdvrBtn');
    const importJsonConfigBtn = document.getElementById('importJsonConfigBtn');

    function showStep(n) {
        steps.forEach((step, index) => step.classList.toggle('active', index === n));
        progressSteps.forEach((pStep, index) => {
            pStep.classList.toggle('active', index === n);
            if(visitedSteps.has(index) && index !== n) pStep.classList.add('completed');
            else pStep.classList.remove('completed');
        });
        prevBtn.style.display = n === 0 ? "none" : "inline-block";
        const isLastStep = n === (steps.length - 1);
        nextBtn.style.display = isLastStep ? "none" : "inline-block";
        
        previewBtn.style.display = isLastStep ? "inline-block" : "none";
        generatePdfBtn.style.display = isLastStep ? "inline-block" : "none";
        retexReportBtn.style.display = isLastStep ? "inline-block" : "none";
    }
    function goToStep(n) {
        if (n >= 0 && n < steps.length) {
            visitedSteps.add(currentStep);
            saveFormData();
            currentStep = n;

            if (n === 6) {
                if (activeMemberId) {
                    const oldActive = document.getElementById(activeMemberId);
                    if (oldActive) oldActive.classList.remove('member-active');
                    activeMemberId = null;
                }
                if (window.innerWidth >= 768) {
                    document.getElementById('quickEditPanel').style.display = 'none';
                }
            }

            showStep(n);
        }
    }
    function changeStep(n) { goToStep(currentStep + n); }
    prevBtn.addEventListener('click', () => changeStep(-1));
    nextBtn.addEventListener('click', () => changeStep(1));
    
    // --- DYNAMIC FIELD & PHOTO MANAGEMENT ---
    function addPhotoInput(containerId, isSingle = false) {
        const container = document.getElementById(containerId);
        if (isSingle) container.innerHTML = '';
        const itemWrapper = document.createElement('div');
        itemWrapper.className = 'photo-input-wrapper';
        const uniqueId = `photo_${Date.now()}_${Math.random()}`;
        const previewId = `preview_${uniqueId}`;
        itemWrapper.innerHTML = `
            <div class="dynamic-list-item">
                <input type="file" id="${uniqueId}" class="photo-input" accept="image/png, image/jpeg" onchange="handleFileChange(this, 'span_${uniqueId}', '${previewId}')">
                <label for="${uniqueId}" class="file-upload-label">Choisir une photo</label>
                <span id="span_${uniqueId}" class="file-name-display">Aucun fichier</span>
                <button type="button" class="add-btn annotate-btn" style="display:none; margin-left:5px; background-color: var(--accent-blue);" onclick="openAnnotationModal('${previewId}')">Annoter</button>
                ${!isSingle ? '<button type="button" class="remove-btn" onclick="this.closest(\'.photo-input-wrapper\').remove()">❌</button>' : ''}
            </div>
            <img id="${previewId}" class="image-preview" style="display:none;" alt="Aperçu"/>`;
        container.appendChild(itemWrapper);
    }
    function handleFileChange(input, spanId, previewId) {
        const fileNameSpan = document.getElementById(spanId);
        const previewImg = document.getElementById(previewId);
        const annotateBtn = input.parentElement.querySelector('.annotate-btn');

        if (input.files.length > 0) {
            fileNameSpan.textContent = input.files[0].name;
            const reader = new FileReader();
            reader.onload = e => {
                previewImg.src = e.target.result;
                previewImg.dataset.originalSrc = e.target.result; 
                previewImg.dataset.annotations = '[]'; 
                previewImg.style.display = 'block';
                if (annotateBtn) annotateBtn.style.display = 'inline-block';
            }
            reader.readAsDataURL(input.files[0]);
        } else {
            fileNameSpan.textContent = 'Aucun fichier';
            previewImg.src = '';
            previewImg.dataset.originalSrc = '';
            previewImg.dataset.annotations = '[]';
            previewImg.style.display = 'none';
            if (annotateBtn) annotateBtn.style.display = 'none';
        }
    }
    function addDynamicField(containerId, value = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="text" class="dynamic-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
        container.appendChild(item);
    }
    function addDynamicFieldWithSelect(containerId, options, value = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        const selectId = `select_${containerId}_${Math.random().toString(36).substr(2, 9)}`;
        const inputId = `input_${containerId}_${Math.random().toString(36).substr(2, 9)}`;
        item.innerHTML = `<select id="${selectId}" onchange="document.getElementById('${inputId}').value = this.value; saveFormData();"><option value="">Sélection</option>${options.map(o => `<option value="${o}" ${o === value ? 'selected':''}>${o}</option>`).join('')}</select><input type="text" id="${inputId}" class="dynamic-input" placeholder="Ou personnalisé" value="${value}" oninput="document.getElementById('${selectId}').value = ''; saveFormData();"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
        container.appendChild(item);
    }
    function addMeField(value = '') {
        const container = document.getElementById('me_container');
        if (container.children.length >= 3) return;
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `<label>ME${container.children.length + 1}:</label><input type="text" class="me-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
        container.appendChild(item);
    }
    
    function addTimeEvent(type_from_load, hour_from_load = '', desc_from_load) {
        const container = document.getElementById('time_events_container');
        const isLoadingFromFile = type_from_load !== undefined;

        let type, hour = hour_from_load, desc;

        if (isLoadingFromFile) {
            type = type_from_load;
            desc = desc_from_load;
        } else {
            const currentEventCount = container.children.length;
            const prefilledData = [
                { type: 'T0', desc: 'Rasso PSIG' }, { type: 'T1', desc: 'Départ PR' },
                { type: 'T2', desc: 'Départ LE' }, { type: 'T3', desc: 'MEP TERMINÉ' },
                { type: 'T4', desc: 'TOP ACTION' },
            ];
            const defaultValues = prefilledData[currentEventCount] || { type: `T${currentEventCount}`, desc: ''};
            type = defaultValues.type;
            desc = defaultValues.desc;
        }

        const item = document.createElement('div');
        item.className = 'dynamic-list-item time-item draggable';
        item.id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        item.setAttribute('draggable', 'true');
        const optionsHtml = ['T0','T1','T2','T3','T4','T5'].map(t => 
            `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`
        ).join('');
        item.innerHTML = `<select class="time-type-select" onchange="saveFormData()">${optionsHtml}</select><input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()"><input type="text" class="time-description-input" placeholder="Description" value="${desc || ''}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
        container.appendChild(item);
    }

    // --- PATRACDVR & MEMBER MANAGEMENT ---
    function addPatracdvrRow(vehicleName, members = []) {
        const container = document.getElementById('patracdvr_container');
        if (container.querySelector(`[data-vehicle-name="${vehicleName}"]`)) {
            alert(`Le véhicule "${vehicleName}" existe déjà. Veuillez choisir un nom unique.`);
            return;
        }
        const row = document.createElement('div');
        row.className = 'patracdvr-vehicle-row';
        row.dataset.vehicleName = vehicleName;

        row.innerHTML = `
            <div class="vehicle-header">
                <span class="vehicle-name">${vehicleName}</span>
                <button type="button" class="remove-btn" title="Supprimer le véhicule">❌</button>
            </div>
            <div class="patracdvr-members-container"></div>`;
        
        container.appendChild(row);

        const membersContainer = row.querySelector('.patracdvr-members-container');
        row.querySelector('.remove-btn').addEventListener('click', () => {
            const confirmation = confirm(`Voulez-vous vraiment supprimer le véhicule "${vehicleName}" et désattribuer ses membres ?`);
            if (confirmation) {
                membersContainer.querySelectorAll('.patracdvr-member-btn').forEach(memberBtn => {
                    memberBtn.dataset.cellule = 'Sans';
                    memberBtn.dataset.fonction = 'Sans';
                    updateMemberButtonVisuals(memberBtn);
                    unassignedContainer.appendChild(memberBtn);
                });
                row.remove();
                saveFormData();
            }
        });
        
        membersContainer.addEventListener('dragenter', handleDragEnter);
        membersContainer.addEventListener('dragleave', handleDragLeave);
        membersContainer.addEventListener('dragover', handleDragOver);
        membersContainer.addEventListener('drop', handleDrop);

        members.forEach(memberData => addPatracdvrMember(membersContainer, memberData));
        saveFormData();
    }
    
    function addManualVehicle() {
        let vehicleName = prompt("Veuillez saisir le nom du nouveau véhicule (ex: VW-Golf, VTC):");
        if (vehicleName) {
            vehicleName = vehicleName.trim();
            if (vehicleName.length > 0) {
                addPatracdvrRow(vehicleName);
            }
        }
    }
    
    function addManualMember() {
        let trigramme = prompt("Veuillez saisir le trigramme du nouveau membre (ex: ABC):");
        if (trigramme) {
            trigramme = trigramme.trim().toUpperCase();
            const existingMember = document.querySelector(`.patracdvr-member-btn[data-trigramme="${trigramme}"]`);
            if (existingMember) {
                alert(`Le membre avec le trigramme "${trigramme}" existe déjà. Veuillez en choisir un autre.`);
                return;
            }
            
            if (trigramme.length >= 2 && trigramme.length <= 4) {
                addPatracdvrMember(unassignedContainer, { trigramme: trigramme, cellule: 'Sans', fonction: 'Sans' });
                const newMemberBtn = unassignedContainer.lastChild;
                if (newMemberBtn) {
                    openMemberModal(newMemberBtn.id);
                }
                saveFormData();
            } else {
                alert("Le trigramme doit contenir entre 2 et 4 caractères.");
            }
        }
    }
    
    function addPatracdvrMember(containerElement, data = {}) {
        if (!containerElement) return;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'patracdvr-member-btn draggable';
        btn.id = `member_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        btn.setAttribute('draggable', 'true');
        
        const memberData = {
            trigramme: 'N/A', fonction: 'Sans', cellule: 'India 1', armement: 'Sans',
            equipement: 'Sans', equipement2: 'Sans',
            tenue: 'UBAS', gpb: 'GPBL', ...data
        };
        
        for (const key in memberConfig) {
            const attrName = key.replace(/s$/, ''); 
            if (memberData[attrName] === undefined) {
                memberData[attrName] = memberConfig[key][0] || 'Sans'; 
            }
        }
        
        Object.keys(memberData).forEach(key => btn.dataset[key] = memberData[key]);
        updateMemberButtonVisuals(btn);
        containerElement.appendChild(btn);
    }

    function updateMemberButtonVisuals(btn) {
        const trigramme = btn.dataset.trigramme || 'N/A';
        const fonction = btn.dataset.fonction || '';
        const cellule = btn.dataset.cellule || '';
        const cellDisplay = cellule !== 'Sans' ? cellule : '';
        const functionDisplay = fonction !== 'Sans' ? ` / ${fonction}` : '';
        
        btn.innerHTML = `<span class="trigramme">${trigramme}</span><span class="fonction">${cellDisplay}${functionDisplay}</span>`;
        
        if (btn.closest('#unassigned_members_container')) {
            btn.innerHTML = `<span class="trigramme">${trigramme}</span>`;
        }
    }

    function openMemberModal(buttonId) {
        const modal = document.getElementById('editMemberModal');
        const form = document.getElementById('editMemberForm');
        const button = document.getElementById(buttonId);
        const deleteBtn = document.getElementById('modal_deleteBtn');
        
        if (!button) return;
        form.dataset.editingButtonId = buttonId;
        
        const isUnassigned = button.closest('#unassigned_members_container');
        
        if (isUnassigned) {
            deleteBtn.textContent = 'Supprimer Définitivement';
            deleteBtn.style.backgroundColor = '#FF0000';
        } else {
            deleteBtn.textContent = 'Renvoyer en Attente';
            deleteBtn.style.backgroundColor = 'var(--danger-red)';
        }
        
        document.getElementById('modal_trigramme').value = button.dataset.trigramme;
        
        for (const key in memberConfig) {
             const attrName = key.replace(/s$/, '');
             const selectId = 'modal_' + attrName;
             const select = document.getElementById(selectId);
             if (select) {
                 select.innerHTML = memberConfig[key].map(option => {
                    const selected = (button.dataset[attrName] === option) ? 'selected' : '';
                    return `<option value="${option}" ${selected}>${option}</option>`;
                }).join('');
             }
        }
        
        modal.showModal();
    }
    
    function updateArticulationDisplay() {
        const indiaContainer = document.getElementById('india_composition_display');
        const aoContainer = document.getElementById('ao_composition_display');
        
        const indiaMembersByCell = {};
        const aoMembersByCell = {};

        document.querySelectorAll('.patracdvr-member-btn').forEach(btn => {
            const trigramme = btn.dataset.trigramme;
            const cellule = btn.dataset.cellule;
            if (!trigramme || !cellule || cellule.toLowerCase() === 'sans') return;

            if (cellule.toLowerCase().startsWith('india')) {
                if (!indiaMembersByCell[cellule]) indiaMembersByCell[cellule] = [];
                indiaMembersByCell[cellule].push(trigramme);
            } else if (cellule.toLowerCase().startsWith('ao')) {
                if (!aoMembersByCell[cellule]) aoMembersByCell[cellule] = [];
                aoMembersByCell[cellule].push(trigramme);
            }
        });

        const naturalSort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
        
        const sortedIndiaKeys = Object.keys(indiaMembersByCell).sort(naturalSort);
        indiaContainer.innerHTML = sortedIndiaKeys.map(cell => 
            `<p><strong>${cell}:</strong> ${indiaMembersByCell[cell].join(', ')}</p>`
        ).join('') || `<p><i>Aucun membre assigné aux cellules India.</i></p>`;

        const sortedAoKeys = Object.keys(aoMembersByCell).sort(naturalSort);
        aoContainer.innerHTML = sortedAoKeys.map(cell => 
            `<p><strong>${cell}:</strong> ${aoMembersByCell[cell].join(', ')}</p>`
        ).join('') || `<p><i>Aucun membre assigné aux cellules AO.</i></p>`;
    }

    // --- PANNEAU D'ÉDITION RAPIDE & MODALE LOGIC ---
    function setupQuickEditPanel() {
        const contentContainer = document.querySelector('#quickEditPanel .quick-edit-content');
        contentContainer.innerHTML = ''; 
        
        for (const key in memberConfig) {
            if (!memberConfig.hasOwnProperty(key) || !Array.isArray(memberConfig[key])) continue;

            const attributeName = key.replace(/s$/, '');
            const title = key.charAt(0).toUpperCase() + key.slice(1);

            const tabPanel = document.createElement('div');
            tabPanel.className = 'quick-edit-tab-panel active'; 
            
            const panelTitle = document.createElement('h5');
            panelTitle.textContent = title;
            tabPanel.appendChild(panelTitle);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'quick-edit-options';
            
            memberConfig[key].forEach(option => { 
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'quick-edit-btn';
                btn.textContent = option;
                btn.dataset.attribute = attributeName; 
                btn.dataset.value = option;
                optionsContainer.appendChild(btn);
            });
            
            tabPanel.appendChild(optionsContainer);
            contentContainer.appendChild(tabPanel);
        }
        updateEditModalSelects(); 
    }
    
    function updateEditModalSelects() {
         for (const key in memberConfig) {
            if (memberConfig.hasOwnProperty(key) && Array.isArray(memberConfig[key])) {
                const selectId = 'modal_' + key.replace(/s$/, '');
                const selectElement = document.getElementById(selectId);
                if (selectElement) {
                    selectElement.innerHTML = memberConfig[key].map(option => `<option value="${option}">${option}</option>`).join('');
                }
            }
        }
    }
    
    function handleMemberSelection(event) {
        const clickedButton = event.target.closest('.patracdvr-member-btn');
        if (!clickedButton) return;

        if (activeMemberId === clickedButton.id) {
            clickedButton.classList.remove('member-active');
            activeMemberId = null;
            document.getElementById('quickEditPanel').style.display = 'none';
            return;
        }

        if (activeMemberId) {
            const oldActive = document.getElementById(activeMemberId);
            if (oldActive) oldActive.classList.remove('member-active');
        }
        
        activeMemberId = clickedButton.id;
        clickedButton.classList.add('member-active');
        
        if (window.innerWidth < 768) {
            openQuickEditModal(activeMemberId);
        } else {
            populateQuickEditPanel(activeMemberId);
            document.getElementById('quickEditPanel').style.display = 'block';
        }
    }
    
    function populateQuickEditPanel(memberId) {
        const member = document.getElementById(memberId);
        if (!member) return;
        document.getElementById('selectedMemberTrigramme').textContent = member.dataset.trigramme || 'N/A';
        document.querySelectorAll('#quickEditPanel .quick-edit-btn').forEach(btn => {
            btn.classList.toggle('selected', member.dataset[btn.dataset.attribute] === btn.dataset.value);
        });
    }

    function openQuickEditModal(memberId) {
        const modal = document.getElementById('quickEditModal');
        const title = document.getElementById('quick_modal_title');
        const content = document.getElementById('quick_modal_content');
        const member = document.getElementById(memberId);

        if (!member) return;

        title.textContent = `Édition Rapide: ${member.dataset.trigramme || 'N/A'}`;
        content.innerHTML = '';
        
        for (const key in memberConfig) {
            if (!memberConfig.hasOwnProperty(key) || !Array.isArray(memberConfig[key])) continue;
            
            const attributeName = key.replace(/s$/, '');
            const categoryTitleText = key.charAt(0).toUpperCase() + key.slice(1);

            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'quick-edit-category';
            
            const categoryTitle = document.createElement('h5');
            categoryTitle.textContent = categoryTitleText;
            categoryDiv.appendChild(categoryTitle);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'quick-edit-options';
            
            memberConfig[key].forEach(option => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'quick-edit-btn';
                btn.textContent = option;
                btn.dataset.attribute = attributeName;
                btn.dataset.value = option;
                if (member.dataset[attributeName] === option) {
                    btn.classList.add('selected');
                }
                optionsContainer.appendChild(btn);
            });
            
            categoryDiv.appendChild(optionsContainer);
            content.appendChild(categoryDiv);
        }
        
        modal.showModal();
    }

    // --- DATA PERSISTENCE (SAVE/LOAD) ---
    function saveFormData() {
        try {
            const data = {};
            document.querySelectorAll('#oi-form input:not([type="file"]), #oi-form textarea, #oi-form select').forEach(field => {
                if (field.id) data[field.id] = field.value;
            });
            document.querySelectorAll('.image-preview').forEach(img => {
                if(img.id && img.src.startsWith('data:image')) {
                    data[img.id + '_src'] = img.src;
                    data[img.id + '_original_src'] = img.dataset.originalSrc;
                    data[img.id + '_annotations'] = img.dataset.annotations || '[]';
                }
            });
            data.me_list = Array.from(document.querySelectorAll('#me_container .me-input')).map(i => i.value).filter(Boolean);
            data.etat_esprit_list = Array.from(document.querySelectorAll(`#etat_esprit_container .dynamic-input`)).map(i => i.value).filter(Boolean);
            data.volume_list = Array.from(document.querySelectorAll(`#volume_adversaire_container .dynamic-input`)).map(i => i.value).filter(Boolean);
            data.vehicules_list = Array.from(document.querySelectorAll(`#vehicules_container .dynamic-input`)).map(i => i.value).filter(Boolean);
            data.patracdvr_unassigned = Array.from(unassignedContainer.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }));
            data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .patracdvr-vehicle-row')).map(row => ({
                vehicle: row.dataset.vehicleName,
                members: Array.from(row.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }))
            }));
            data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
                type: item.querySelector('.time-type-select').value,
                hour: item.querySelector('.time-hour-input').value,
                description: item.querySelector('.time-description-input').value
            }));
            data.member_options = memberConfig;
            
            localStorage.setItem('oiFormData', JSON.stringify(data));
            
            updateArticulationDisplay();
        } catch (e) { console.error("Save error:", e); }
    }
    
    function loadFormData() {
        const dataString = localStorage.getItem('oiFormData');
        if (!dataString) return false;
        
        try {
            const data = JSON.parse(dataString);
            
            if (data.member_options) {
                Object.assign(memberConfig, data.member_options);
            }
            
            setupQuickEditPanel(); 
            
            Object.keys(data).forEach(key => {
                if (key.endsWith('_src')) {
                    const imgId = key.replace('_src', '');
                    const img = document.getElementById(imgId);
                    if (img) {
                       img.src = data[key];
                       img.dataset.originalSrc = data[imgId + '_original_src'];
                       img.dataset.annotations = data[imgId + '_annotations'] || '[]';
                       img.style.display = 'block';
                       const annotateBtn = img.closest('.photo-input-wrapper').querySelector('.annotate-btn');
                       if(annotateBtn) annotateBtn.style.display = 'inline-block';
                    }
                    return;
                }
                if (['patracdvr_rows', 'patracdvr_unassigned', 'time_events', 'me_list', 'etat_esprit_list', 'volume_list', 'vehicules_list', 'member_options'].includes(key)) return; 
                
                const el = document.getElementById(key);
                if (el) el.value = data[key];
            });

            (data.me_list || []).forEach(val => addMeField(val));
            (data.etat_esprit_list || []).forEach(val => addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'], val));
            (data.volume_list || []).forEach(val => addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'], val));
            (data.vehicules_list || []).forEach(val => addDynamicField('vehicules_container', val));
            (data.time_events || []).forEach(ev => addTimeEvent(ev.type, ev.hour, ev.description));
            initializePatracdvr(data);

            updateArticulationDisplay();
            return true; 
        } catch (e) { 
            console.error("Load error: Failed to parse or apply saved data. Clearing localStorage.", e);
            localStorage.removeItem('oiFormData');
            return false; 
        }
    }
    
    function initializePatracdvr(dataFromStorage) {
        unassignedContainer.innerHTML = '';
        patracdvrContainer.innerHTML = '';
        if (dataFromStorage && (dataFromStorage.patracdvr_rows?.length > 0 || dataFromStorage.patracdvr_unassigned?.length > 0)) {
            (dataFromStorage.patracdvr_unassigned || []).forEach(member => addPatracdvrMember(unassignedContainer, member));
            (dataFromStorage.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
        }
    }
    
    function loadMembersFromJson(configObject) {
        if (configObject.options) {
            Object.assign(memberConfig, configObject.options);
        }
        
        setupQuickEditPanel(); 
        updateEditModalSelects();

        const membersArray = configObject.members || [];
        unassignedContainer.innerHTML = ''; 
        patracdvrContainer.innerHTML = '';
        membersArray.forEach(memberData => addPatracdvrMember(unassignedContainer, memberData));
        saveFormData(); 
    }
    
    async function loadDefaultConfig() {
        try {
            const response = await fetch(DEFAULT_CONFIG_FILE);
            if (!response.ok) {
                throw new Error(`Failed to fetch default config: ${response.statusText}`);
            }
            const config = await response.json();
            
            if (config.options) {
                Object.assign(memberConfig, config.options);
            }
            
            if (config.members && Array.isArray(config.members)) {
                loadMembersFromJson(config); 
            } else {
                setupQuickEditPanel();
            }
        } catch (e) {
            console.warn(`[Config Warning] Could not load default config (${DEFAULT_CONFIG_FILE}). Using internal default.`, e);
            setupQuickEditPanel();
        }
    }

    // --- DRAG & DROP ---
    let draggedItem = null;

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function handleDragEnter(e) {
        e.preventDefault();
        const targetContainer = e.currentTarget;
        if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) {
            targetContainer.style.border = '2px dashed var(--accent-blue)';
        }
    }

    function handleDragOver(e) {
        e.preventDefault(); 
        const targetContainer = e.currentTarget;
        if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) {
            const afterElement = getDragAfterElement(targetContainer, e.clientY);
            if (afterElement == null) { 
                targetContainer.appendChild(draggedItem); 
            } else { 
                targetContainer.insertBefore(draggedItem, afterElement); 
            }
        }
    }

    function handleDragLeave(e) {
        e.currentTarget.style.border = '1px dashed var(--border-color)';
    }

    function handleDrop(e) {
        e.preventDefault();
        const targetContainer = e.currentTarget;
        targetContainer.style.border = '1px dashed var(--border-color)';

        if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) {
            targetContainer.appendChild(draggedItem);

            const isUnassignedZone = targetContainer.id === 'unassigned_members_container';
            
            if (isUnassignedZone) {
                draggedItem.dataset.cellule = 'Sans';
                draggedItem.dataset.fonction = 'Sans';
            } else if (draggedItem.dataset.cellule === 'Sans') {
                draggedItem.dataset.cellule = 'India 1';
            }
            
            updateMemberButtonVisuals(draggedItem);
            
            if (draggedItem.id === activeMemberId) {
                draggedItem.classList.remove('member-active');
                activeMemberId = null;
                if (window.innerWidth >= 768) {
                    document.getElementById('quickEditPanel').style.display = 'none';
                }
            }
            
            saveFormData();
            draggedItem = null;
        }
    }

    // --- TUTORIAL SYSTEM ---
    const tutorialSteps = [
        { text: "Bienvenue dans le générateur d'Ordre Initial...", selector: '.container', center: true },
        { text: "Cette barre de progression indique les différentes sections...", selector: '.wizard-progress' },
        { text: "Commencez par définir le contexte...", selector: '#date_op', step: 0 },
        { text: "Détaillez ici toutes les informations relatives à l'adversaire...", selector: '#adversary_photo_container', step: 1 },
        { text: "Renseignez les informations sur les unités amies...", selector: '#terrain_info', step: 2 },
        { text: "La mission principale de l'unité est pré-remplie...", selector: '#missions_psig', step: 3 },
        { text: "Définissez la chronologie de l'action...", selector: '#time_events_container', step: 4 },
        { text: "Décrivez l'articulation des équipes...", selector: '.collapsible-container:first-of-type', step: 5 },
        { text: "Gérez la composition des équipes en cliquant sur un membre...", selector: '#unassigned_members_container', step: 6 },
        { text: "Cette section permet d'ajouter des photos complémentaires...", selector: '.wizard-step:nth-of-type(8)', step: 7 },
        { text: "Spécifiez les conduites à tenir générales...", selector: '#cat_generales', step: 8 },
        { text: "Une fois le formulaire complété, vous pouvez prévisualiser...", selector: '#generatePdfBtn', step: 9 },
        { text: "Ce menu flottant offre un accès rapide...", selector: '#dockMenu' }
    ];
    
    let currentTutorialStep = 0;
    const tutorialPopup = document.getElementById('tutorial-popup');
    const popupText = document.getElementById('popup-text');
    const nextPopupBtn = document.getElementById('next-popup-btn');
    const closePopupBtn = tutorialPopup.querySelector('.close-btn');
    let currentHighlightedElement = null;

    function startTutorial() {
        if (tutorialPopup.style.display === 'flex') {
            hideTutorial();
            return;
        }
        goToStep(0);
        currentTutorialStep = 0;
        showTutorialStep(currentTutorialStep);
    }

    function showTutorialStep(stepIndex) {
        if (stepIndex >= tutorialSteps.length) {
            hideTutorial();
            return;
        }
        const step = tutorialSteps[stepIndex];
        if (step.step !== undefined && step.step !== currentStep) {
            goToStep(step.step);
            setTimeout(() => showTutorialStep(stepIndex), 600);
            return;
        }
        if (currentHighlightedElement) {
            currentHighlightedElement.classList.remove('highlight-element');
        }
        popupText.textContent = step.text;
        nextPopupBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Terminer' : 'Suivant';
        
        const targetElement = document.querySelector(step.selector);
        if (!targetElement) {
            console.warn(`Element non trouvé: ${step.selector}`);
            currentTutorialStep++;
            showTutorialStep(currentTutorialStep);
            return;
        }

        if (step.center) {
            tutorialPopup.style.top = '50%';
            tutorialPopup.style.left = '50%';
            tutorialPopup.style.transform = 'translate(-50%, -50%)';
        } else {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetElement.classList.add('highlight-element');
            currentHighlightedElement = targetElement;
            const rect = targetElement.getBoundingClientRect();
            const popupWidth = tutorialPopup.offsetWidth;
            const popupHeight = tutorialPopup.offsetHeight;
            let popupX = rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2);
            let popupY = rect.top + window.scrollY - popupHeight - 20;

            if (popupY < window.scrollY + 10) popupY = rect.bottom + window.scrollY + 20;
            if (popupX < 10) popupX = 10;
            if (popupX + popupWidth > window.innerWidth - 10) popupX = window.innerWidth - popupWidth - 10;

            tutorialPopup.style.top = `${popupY}px`;
            tutorialPopup.style.left = `${popupX}px`;
            tutorialPopup.style.transform = 'none';
        }
        tutorialPopup.style.display = 'flex';
    }

    function hideTutorial() {
        if (currentHighlightedElement) {
            currentHighlightedElement.classList.remove('highlight-element');
        }
        tutorialPopup.style.display = 'none';
    }
    nextPopupBtn.addEventListener('click', () => {
        currentTutorialStep++;
        showTutorialStep(currentTutorialStep);
    });
    closePopupBtn.addEventListener('click', hideTutorial);
    
    // --- LOGIQUE D'ANNOTATION ---
    const annotationModal = document.getElementById('annotationModal');
    const canvas = document.getElementById('annotationCanvas');
    const ctx = canvas.getContext('2d');
    const baseImage = new Image();
    let annotations = [], currentTool = 'move', isDrawing = false, isDragging = false, startX, startY;
    let currentAnnotation = null, selectedAnnotation = null;
    const rotationInput = document.getElementById('rotation_input');
    let isResizing = false;
    let resizeCorner = null; 
    const resizeThreshold = 15; 

    function setContextualTools(selection) {
        const contextualTools = document.getElementById('contextual_tools');
        if (selection) {
            contextualTools.classList.add('active');
            contextualTools.classList.toggle('location-selected', selection.type === 'location');
            rotationInput.value = Math.round((selection.rotation || 0) * 180 / Math.PI) % 360;
            if (rotationInput.value < 0) rotationInput.value += 360;
        } else {
            contextualTools.classList.remove('active');
        }
    }
    
    function updateAnnotationRotation() {
        if (selectedAnnotation) {
            const degrees = parseFloat(rotationInput.value) || 0;
            selectedAnnotation.rotation = degrees * Math.PI / 180;
            redrawCanvas();
        }
    }

    function setActiveTool(toolId) {
        currentTool = toolId;
        document.querySelectorAll('.tool-btn.active, .tool-controls.active').forEach(el => el.classList.remove('active'));
        document.getElementById(`tool_${toolId}`)?.classList.add('active');
        document.getElementById(`controls_${toolId}`)?.classList.add('active');
        canvas.style.cursor = toolId === 'move' ? 'default' : 'crosshair';
        selectedAnnotation = null;
        setContextualTools(null);
    }

    function openAnnotationModal(previewImgId) {
        const previewImg = document.getElementById(previewImgId);
        if (!previewImg || !previewImg.src) return;
        baseImage.onload = () => {
            canvas.width = baseImage.width;
            canvas.height = baseImage.height;
            annotations = JSON.parse(previewImg.dataset.annotations || '[]');
            setActiveTool('move');
            redrawCanvas();
            annotationModal.dataset.targetPreviewId = previewImgId;
            annotationModal.showModal();
        };
        baseImage.src = previewImg.dataset.originalSrc || previewImg.src;
    }

    function redrawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(baseImage, 0, 0);
        annotations.forEach(drawAnnotation);
        if (isDrawing && currentAnnotation) drawAnnotation(currentAnnotation);
        if (selectedAnnotation) drawSelectionBorder(selectedAnnotation);
    }

    function drawSelectionBorder(annotation) {
        ctx.save();
        const angle = annotation.rotation || 0;
        const [x, y, width, height] = getAnnotationBounds(annotation);
        const [centerX, centerY] = [x + width / 2, y + height / 2];

        ctx.translate(centerX, centerY);
        ctx.rotate(angle);
        
        ctx.setLineDash([5, 5]);
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 3;
        ctx.strokeRect(-width / 2, -height / 2, width, height);
        
        ctx.restore();

        if (currentTool === 'move' && annotation.type !== 'arrow') {
            const corners = [
                { x: x, y: y }, { x: x + width, y: y },
                { x: x + width, y: y + height }, { x: x, y: y + height }
            ];

            corners.forEach(corner => {
                const rotated = getRotatedPoint(corner.x, corner.y, centerX, centerY, -angle);
                ctx.beginPath();
                ctx.arc(rotated.x, rotated.y, 7, 0, 2 * Math.PI);
                ctx.fillStyle = 'white';
                ctx.fill();
                ctx.strokeStyle = getCssVarValue('--accent-blue');
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }
    }

    function getAnnotationBounds(annotation) {
        if (annotation.type === 'location') {
            return [annotation.x - annotation.radius, annotation.y - annotation.radius, annotation.radius * 2, annotation.radius * 2];
        }
        if (annotation.type === 'box') {
            return [annotation.x, annotation.y, annotation.width, annotation.height];
        }
        if (annotation.type === 'arrow') {
            const minX = Math.min(annotation.startX, annotation.endX);
            const minY = Math.min(annotation.startY, annotation.endY);
            return [minX - 10, minY - 10, Math.abs(annotation.endX - annotation.startX) + 20, Math.abs(annotation.endY - annotation.startY) + 20];
        }
        return [0, 0, 0, 0];
    }

    function drawAnnotation(annotation) {
        ctx.save();
        const [x, y, width, height] = getAnnotationBounds(annotation);
        const [centerX, centerY] = [x + width / 2, y + height / 2];
        
        if (annotation.rotation) {
            ctx.translate(centerX, centerY);
            ctx.rotate(annotation.rotation);
            ctx.translate(-centerX, -centerY);
        }

        switch (annotation.type) {
            case 'location':
                ctx.beginPath();
                ctx.arc(annotation.x, annotation.y, annotation.radius, 0, 2 * Math.PI);
                ctx.fillStyle = `rgba(91, 155, 213, ${annotation.opacity || 0.5})`;
                ctx.fill();
                ctx.strokeStyle = '#5b9bd5';
                ctx.lineWidth = 2;
                ctx.stroke();
                if (annotation.text) {
                    ctx.fillStyle = 'black';
                    ctx.font = `bold ${Math.max(12, annotation.radius / 2)}px Oswald`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(annotation.text, annotation.x, annotation.y);
                }
                break;
            case 'arrow':
                drawArrow(annotation.startX, annotation.startY, annotation.endX, annotation.endY, annotation.thickness || 5);
                break;
            case 'box':
                ctx.strokeStyle = '#c0392b';
                ctx.lineWidth = annotation.thickness || 5;
                ctx.strokeRect(annotation.x, annotation.y, annotation.width, annotation.height);
                break;
        }
        ctx.restore();
    }
    
    function drawArrow(fromx, fromy, tox, toy, lineWidth) {
        const dx = tox - fromx, dy = toy - fromy;
        if (dx === 0 && dy === 0) return;
        
        ctx.strokeStyle = '#c0392b';
        ctx.fillStyle = '#c0392b';
        ctx.lineWidth = lineWidth;
        
        const angle = Math.atan2(dy, dx);
        const headlen = Math.max(lineWidth * 3, 10);
        
        ctx.beginPath();
        ctx.moveTo(fromx, fromy);
        ctx.lineTo(tox, toy);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(tox, toy);
        ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 7), toy - headlen * Math.sin(angle - Math.PI / 7));
        ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 7), toy - headlen * Math.sin(angle + Math.PI / 7));
        ctx.closePath();
        ctx.fill();
    }

    function getEventPos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
        const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
        return {
            x: (clientX - rect.left) * (canvas.width / rect.width),
            y: (clientY - rect.top) * (canvas.height / rect.height)
        };
    }

    function getRotatedPoint(x, y, centerX, centerY, angle) {
        const cos = Math.cos(angle), sin = Math.sin(angle);
        const translatedX = x - centerX, translatedY = y - centerY;
        return {
            x: translatedX * cos - translatedY * sin + centerX,
            y: translatedX * sin + translatedY * cos + centerY
        };
    }
    
    function getAnnotationAtPosition(x, y) {
        return annotations.slice().reverse().find(annotation => {
            const angle = -(annotation.rotation || 0);
            const [annX, annY, annW, annH] = getAnnotationBounds(annotation);
            const [centerX, centerY] = [annX + annW / 2, annY + annH / 2];
            const rotatedPos = getRotatedPoint(x, y, centerX, centerY, angle);

            if (annotation.type === 'location') {
                return Math.hypot(rotatedPos.x - annotation.x, rotatedPos.y - annotation.y) <= annotation.radius;
            }
            if (annotation.type === 'box') {
                return rotatedPos.x >= annX && rotatedPos.x <= annX + annW && rotatedPos.y >= annY && rotatedPos.y <= annY + annH;
            }
            if (annotation.type === 'arrow') {
                // Simplified hit detection for arrows
                return Math.min(rotatedPos.x, x) < Math.max(annotation.startX, annotation.endX) && Math.max(rotatedPos.x, x) > Math.min(annotation.startX, annotation.endX);
            }
            return false;
        });
    }

    function handleDrawStart(e) {
        e.preventDefault();
        const pos = getEventPos(canvas, e);
        startX = pos.x;
        startY = pos.y;
        
        if (currentTool === 'move') {
            const clickedAnnotation = getAnnotationAtPosition(pos.x, pos.y);
            if (clickedAnnotation) {
                selectedAnnotation = clickedAnnotation;
                isDragging = true;
                dragOffsetX = startX - getAnnotationBounds(selectedAnnotation)[0];
                dragOffsetY = startY - getAnnotationBounds(selectedAnnotation)[1];
            } else {
                selectedAnnotation = null;
            }
            setContextualTools(selectedAnnotation);
        } else { 
            isDrawing = true;
            currentAnnotation = { type: currentTool, startX, startY, endX: startX, endY: startY, rotation: 0 };
        }
        redrawCanvas();
    }

    function handleDrawMove(e) {
        e.preventDefault();
        if (!isDrawing && !isDragging) return;
        const pos = getEventPos(canvas, e);
        
        if (isDragging && selectedAnnotation) {
            const dx = pos.x - startX, dy = pos.y - startY;
            if (selectedAnnotation.type === 'arrow') {
                selectedAnnotation.startX += dx;
                selectedAnnotation.startY += dy;
                selectedAnnotation.endX += dx;
                selectedAnnotation.endY += dy;
            } else {
                selectedAnnotation.x += dx;
                selectedAnnotation.y += dy;
            }
            startX = pos.x;
            startY = pos.y;
        } else if (isDrawing) {
            currentAnnotation.endX = pos.x;
            currentAnnotation.endY = pos.y;
        }
        redrawCanvas();
    }

    function handleDrawEnd(e) {
        e.preventDefault();
        if (isDrawing) {
            const final = { ...currentAnnotation };
            if (final.type === 'box') {
                final.x = Math.min(final.startX, final.endX);
                final.y = Math.min(final.startY, final.endY);
                final.width = Math.abs(final.startX - final.endX);
                final.height = Math.abs(final.startY - final.endY);
                final.thickness = document.getElementById('box_thickness').value;
                if (final.width > 5 && final.height > 5) annotations.push(final);
            } else if (final.type === 'arrow') {
                final.thickness = document.getElementById('arrow_thickness').value;
                if (Math.hypot(final.endX - final.startX, final.endY - final.startY) > 5) annotations.push(final);
            } else if (final.type === 'location') {
                final.x = final.startX;
                final.y = final.startY;
                final.radius = Math.hypot(final.endX - final.startX, final.endY - final.startY);
                final.text = document.getElementById('circle_text').value || 'Zone';
                final.opacity = document.getElementById('circle_opacity').value;
                if (final.radius > 5) annotations.push(final);
            }
            selectedAnnotation = annotations[annotations.length - 1];
            setContextualTools(selectedAnnotation);
        }
        isDrawing = false;
        isDragging = false;
        redrawCanvas();
        saveFormData();
    }
        
    // --- EVENT LISTENERS & INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (localStorage.getItem('theme') === 'light') { 
            document.body.classList.replace('dark-mode', 'light-mode'); 
            document.getElementById('darkModeIcon').textContent = 'clear_day'; 
        }
        if (localStorage.getItem('dockCollapsed') === 'true') { 
            document.getElementById('dockMenu').classList.add('collapsed'); 
        }

        if (!loadFormData()) {
            await loadDefaultConfig();
        }

        addPhotoInput('adversary_photo_container', true);
        showStep(currentStep); 
        
        document.querySelector('.container').addEventListener('click', (event) => {
            const header = event.target.closest('.collapsible-header');
            if (header) header.parentElement.classList.toggle('open');
        });

        const modal = document.getElementById('editMemberModal');
        const form = document.getElementById('editMemberForm');
        
        document.getElementById('modal_saveBtn').addEventListener('click', () => {
            const button = document.getElementById(form.dataset.editingButtonId);
            if (button) {
                button.dataset.trigramme = document.getElementById('modal_trigramme').value;
                Object.keys(memberConfig).forEach(key => {
                    const attrName = key.replace(/s$/, '');
                    const select = document.getElementById('modal_' + attrName);
                    if (select) button.dataset[attrName] = select.value;
                });
                updateMemberButtonVisuals(button);
                populateQuickEditPanel(button.id);
                saveFormData();
            }
            modal.close();
        });

        document.getElementById('modal_cancelBtn').addEventListener('click', () => modal.close());
        
        document.getElementById('modal_deleteBtn').addEventListener('click', () => {
            const button = document.getElementById(form.dataset.editingButtonId);
            if (!button) return;

            const isUnassigned = button.closest('#unassigned_members_container');
            const confirmationMessage = isUnassigned 
                ? `Vraiment SUPPRIMER DÉFINITIVEMENT ${button.dataset.trigramme || 'N/A'}?`
                : `Renvoyer ${button.dataset.trigramme || 'N/A'} en attente?`;

            if (confirm(confirmationMessage)) {
                if (isUnassigned) {
                    button.remove();
                } else {
                    button.dataset.cellule = 'Sans';
                    button.dataset.fonction = 'Sans';
                    updateMemberButtonVisuals(button);
                    unassignedContainer.appendChild(button);
                }
                saveFormData();
                modal.close();
                activeMemberId = null;
                document.getElementById('quickEditPanel').style.display = 'none';
            }
        });
        
        const dockMenu = document.getElementById('dockMenu');
        document.getElementById('dockToggleBtn').addEventListener('click', (e) => { 
            e.stopPropagation(); 
            dockMenu.classList.toggle('collapsed');
            localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed')); 
        });
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });
        document.getElementById('resetBtn').addEventListener('click', () => { 
            if (confirm("Réinitialiser tout le formulaire (y compris les membres) ?")) { 
                localStorage.removeItem('oiFormData');
                location.reload();
            }
        });
        document.getElementById('tutorialBtn').addEventListener('click', startTutorial);
        
        importJsonConfigBtn.addEventListener('click', () => jsonConfigInput.click());
        
        jsonConfigInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    if (config && (Array.isArray(config.members) || config.options)) {
                        loadMembersFromJson(config); 
                    } else { 
                        alert("Fichier JSON invalide."); 
                    }
                } catch (err) { 
                    alert("Erreur de lecture du JSON."); 
                    console.error(err); 
                }
            };
            reader.readAsText(file);
            event.target.value = null; 
        });
        
        resetPatracdvrBtn.addEventListener('click', () => { 
            if (confirm("Effacer TOUS les véhicules et membres du PATRACDVR ?")) { 
                patracdvrContainer.innerHTML = ''; 
                unassignedContainer.innerHTML = ''; 
                saveFormData(); 
            } 
        });
        
        const vehicleCreationContainer = document.getElementById('vehicle_creation_buttons');
        availableVehicles.forEach(vehicle => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'add-btn add-vehicle-btn';
            btn.textContent = `➕ ${vehicle}`;
            btn.addEventListener('click', () => addPatracdvrRow(vehicle));
            vehicleCreationContainer.insertBefore(btn, document.getElementById('addManualVehicleBtn'));
        });

        document.getElementById('addManualVehicleBtn').addEventListener('click', addManualVehicle);
        document.getElementById('addManualMemberBtn').addEventListener('click', addManualMember);

        document.querySelector('.wizard-step:has(#patracdvr_container)').addEventListener('click', handleMemberSelection);

        document.getElementById('quickEditPanel').addEventListener('click', (event) => {
            event.stopPropagation();
            const target = event.target;
            const quickEditButton = target.closest('.quick-edit-btn');
            const fullEditButton = target.closest('#fullEditBtn');

            if (quickEditButton && activeMemberId) {
                const activeMember = document.getElementById(activeMemberId);
                if (!activeMember) return;
                
                const { attribute, value } = quickEditButton.dataset;
                activeMember.dataset[attribute] = value;
                
                if (attribute === 'cellule' && value === 'Sans') activeMember.dataset.fonction = 'Sans';
                if (attribute === 'fonction' && value !== 'Sans' && activeMember.dataset.cellule === 'Sans') activeMember.dataset.cellule = 'India 1';
                
                updateMemberButtonVisuals(activeMember);
                quickEditButton.parentElement.querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
                quickEditButton.classList.add('selected');
                saveFormData();
            } else if (fullEditButton && activeMemberId) {
                openMemberModal(activeMemberId);
            }
        });

        const quickEditModal = document.getElementById('quickEditModal');
        document.getElementById('quick_modal_closeBtn').addEventListener('click', () => quickEditModal.close());
        quickEditModal.addEventListener('click', (event) => {
            const target = event.target.closest('.quick-edit-btn');
            if (!target || !activeMemberId) return;

            const activeMember = document.getElementById(activeMemberId);
            if (!activeMember) return;

            const { attribute, value } = target.dataset;
            activeMember.dataset[attribute] = value;
            
            if (attribute === 'cellule' && value === 'Sans') activeMember.dataset.fonction = 'Sans';
            if (attribute === 'fonction' && value !== 'Sans' && activeMember.dataset.cellule === 'Sans') activeMember.dataset.cellule = 'India 1';
            
            updateMemberButtonVisuals(activeMember);
            target.closest('.quick-edit-options').querySelectorAll('.selected').forEach(btn => btn.classList.remove('selected'));
            target.classList.add('selected');
            saveFormData();
        });

        canvas.addEventListener('mousedown', handleDrawStart);
        canvas.addEventListener('mousemove', handleDrawMove);
        canvas.addEventListener('mouseup', handleDrawEnd);
        canvas.addEventListener('mouseout', handleDrawEnd);
        canvas.addEventListener('touchstart', handleDrawStart, { passive: false });
        canvas.addEventListener('touchmove', handleDrawMove, { passive: false });
        canvas.addEventListener('touchend', handleDrawEnd);
        
        document.querySelectorAll('.toolbar-main-tools .tool-btn').forEach(btn => {
            btn.addEventListener('click', () => setActiveTool(btn.id.split('_')[1]));
        });
        document.getElementById('tool_reset').addEventListener('click', () => { 
            annotations = []; 
            selectedAnnotation = null; 
            setContextualTools(null); 
            redrawCanvas(); 
        });
        document.getElementById('annotation_cancel').addEventListener('click', () => annotationModal.close());
        document.getElementById('annotation_save').addEventListener('click', () => {
            const previewImg = document.getElementById(annotationModal.dataset.targetPreviewId);
            if(previewImg) {
                previewImg.src = canvas.toDataURL('image/png');
                previewImg.dataset.annotations = JSON.stringify(annotations);
            }
            saveFormData();
            annotationModal.close();
        });
        
        rotationInput.addEventListener('change', updateAnnotationRotation);

        document.getElementById('delete_btn').addEventListener('click', () => { 
            if(selectedAnnotation){ 
                annotations = annotations.filter(ann => ann !== selectedAnnotation);
                selectedAnnotation = null; 
                setContextualTools(null); 
                redrawCanvas(); 
            } 
        });
        document.getElementById('edit_text_btn').addEventListener('click', () => { 
            if(selectedAnnotation && selectedAnnotation.type === 'location'){ 
                const newText = prompt('Modifier texte:', selectedAnnotation.text); 
                if(newText !== null) { 
                    selectedAnnotation.text = newText;
                    redrawCanvas(); 
                } 
            } 
        });
        
        const importSessionBtn = document.getElementById('importSessionBtn');
        const exportSessionBtn = document.getElementById('exportSessionBtn');
        const sessionFileInput = document.getElementById('sessionFileInput');
        
        importSessionBtn.addEventListener('click', () => sessionFileInput.click());
        
        exportSessionBtn.addEventListener('click', () => {
            saveFormData();
            const dataString = localStorage.getItem('oiFormData');
            if (!dataString) {
                alert("Aucune donnée à exporter.");
                return;
            }
            const blob = new Blob([dataString], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = new Date().toISOString().slice(0, 10);
            link.download = `OI_Session_${date}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        });

        sessionFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    localStorage.setItem('oiFormData', e.target.result);
                    alert("Session importée. Rechargement...");
                    location.reload();
                } catch (err) {
                    alert("Fichier invalide ou corrompu.");
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        });
        
        retexReportBtn.addEventListener('click', () => {
            if (!APPS_SCRIPT_WEB_APP_URL.includes('macros/s')) {
                alert("L'URL du script d'analyse n'est pas configurée.");
                return;
            }
            const dateOp = document.getElementById('date_op').value;
            const nomAdversaire = document.getElementById('nom_adversaire').value;
            if (!dateOp || !nomAdversaire) {
                alert("Veuillez renseigner la date et le nom de l'adversaire.");
                return;
            }
            const oiId = `${dateOp}_${nomAdversaire.trim().replace(/\s+/g, '_')}`;
            const reportUrl = `${APPS_SCRIPT_WEB_APP_URL}?action=generateReport&oiId=${encodeURIComponent(oiId)}`;
            alert(`Demande du rapport pour : ${oiId}.`);
            window.open(reportUrl, '_blank');
        });

        document.addEventListener('dragstart', e => { 
            const target = e.target.closest('.draggable');
            if (target) { 
                draggedItem = target; 
                setTimeout(() => target.classList.add('dragging'), 0); 
            } 
        });

        document.addEventListener('dragend', () => { 
            if (draggedItem) { 
                draggedItem.classList.remove('dragging'); 
                draggedItem = null; 
            } 
        });

        document.querySelectorAll('.patracdvr-members-container, #unassigned_members_container, #time_events_container')
            .forEach(container => {
                container.addEventListener('dragenter', handleDragEnter);
                container.addEventListener('dragleave', handleDragLeave);
                container.addEventListener('dragover', handleDragOver);
                container.addEventListener('drop', handleDrop);
        });
    });
    
    // --- PDF GENERATION ---
    async function buildPdf() {
        // ... (The PDF generation code is lengthy and already functional, it remains unchanged)
        // For brevity, I am not re-displaying it, but it should be kept as is.
    }

    async function handlePdfAction(isPreview) {
        if (typeof PDFLib === 'undefined') { alert("Erreur: La bibliothèque PDF n'est pas encore chargée."); return; }
        const btn = isPreview ? previewBtn : generatePdfBtn;
        const originalText = btn.textContent;
        btn.textContent = 'Génération...'; btn.disabled = true;
        try {
            const result = await buildPdf();
            if (!result) { btn.textContent = originalText; btn.disabled = false; return; }
            const { pdfBytes, formData } = result;
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            if (isPreview) { window.open(url, '_blank'); } 
            else {
                const getVal = (id) => formData[id] || 'RAS';
                const link = document.createElement('a');
                link.href = url;
                link.download = `OI_${getVal('date_op').replace(/[\/\\?%*:|"<>]/g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        } catch (error) {
            console.error("Erreur critique lors de la génération du PDF:", error);
            alert("Une erreur critique est survenue. Consultez la console (F12).");
        } finally {
            btn.textContent = originalText; btn.disabled = false;
        }
    }

    previewBtn.addEventListener('click', () => handlePdfAction(true));
    generatePdfBtn.addEventListener('click', () => handlePdfAction(false));
</script>
</body>
</html>
