<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial</title>
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Arial', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 10px; color: var(--accent-blue); text-transform: uppercase; letter-spacing: 2px; font-weight: 400; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        h3 { color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; font-weight: 400; }
        .form-section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select {
            width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border-color);
            border-radius: 4px; box-sizing: border-box; font-size: 1em; background-color: var(--bg-interactive); color: var(--text-primary);
        }
        button {
            background-color: var(--accent-blue); color: white; padding: 12px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 16px; margin-top: 20px;
        }
        button.add-btn { background-color: #27ae60; padding: 5px 10px; font-size: 14px; margin-top: 5px; }
        button.remove-btn { background-color: #c0392b; padding: 5px 10px; font-size: 14px; margin-top: 5px; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .time-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .patracdvr-member-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Générateur d'Ordre Initial</h1>
    <button type="button" onclick="resetForm()">Réinitialiser le formulaire</button>

    <div class="form-section">
        <h2>1. SITUATION</h2>
        <label for="date_op">Date de l'opération :</label>
        <input type="text" id="date_op" placeholder="ex: 14/01/2025">
        <label for="situation_generale">1.1 Générale :</label>
        <textarea id="situation_generale" rows="4" placeholder="Décrivez les faits et l'enquête..."></textarea>
        <label for="situation_particuliere">1.2 Particulière :</label>
        <textarea id="situation_particuliere" rows="2" placeholder="ex: L'interpellation du mis en cause est programmée le 14/01/2025 à ANTIBES"></textarea>
    </div>

    <div class="form-section">
        <h2>1.3 ADVERSAIRE(S)</h2>
        <label for="nom_adversaire">Nom/Prénom :</label>
        <input type="text" id="nom_adversaire" placeholder="Nom/Prénom">
        <label for="domicile_adversaire">Domicile et Adresse de repli :</label>
        <textarea id="domicile_adversaire" rows="2" placeholder="Adresse complète..."></textarea>
        <div class="dynamic-list-item">
            <label for="date_naissance">Date de naissance :</label>
            <input type="date" id="date_naissance">
            <label for="lieu_naissance">Lieu de naissance :</label>
            <input type="text" id="lieu_naissance" placeholder="Ville">
        </div>
        <div class="dynamic-list-item">
            <label for="stature_adversaire">Stature :</label>
            <input type="text" id="stature_adversaire" placeholder="Taille (ex: 1.72m)">
            <label for="ethnie_adversaire">Ethnie :</label>
            <select id="ethnie_adversaire">
                <option value="Caucasien">Caucasien</option>
                <option value="Nord africain">Nord africain</option>
                <option value="Afro-antillais">Afro-antillais</option>
                <option value="Asiatique">Asiatique</option>
            </select>
        </div>
        <label for="signes_particuliers_adversaire">Signes particuliers :</label>
        <input type="text" id="signes_particuliers_adversaire" placeholder="Cicatrice, tatouage...">
        <label for="profession_adversaire">Profession :</label>
        <input type="text" id="profession_adversaire" placeholder="Profession">
        <label for="antecedents_adversaire">Antécédents :</label>
        <textarea id="antecedents_adversaire" rows="2" placeholder="TAJ: BT:"></textarea>
        <label>État d'esprit :</label>
        <div id="etat_esprit_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant'])">➕</button>
        <label for="attitude_adversaire">Attitude (Interpellations précédentes) :</label>
        <textarea id="attitude_adversaire" rows="2"></textarea>
        <label>Volume (Renfort) :</label>
        <div id="volume_adversaire_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕</button>
        <label for="substances_adversaire">Substances :</label>
        <input type="text" id="substances_adversaire" placeholder="Alcool/Drogues...">
        <label>Véhicules :</label>
        <div id="vehicules_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicField('vehicules_container', 'Immat modèle couleur')">➕</button>
        <label>Armes :</label>
        <div id="armes_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicField('armes_container', 'RAS')">➕</button>
        <label>Modes d'action possibles :</label>
        <textarea id="mode_action_me1" rows="1" placeholder="ME1 (le + probable) : Fuite..."></textarea>
        <textarea id="mode_action_me2" rows="1" placeholder="ME2 : Rébellion..."></textarea>
        <textarea id="mode_action_me3" rows="1" placeholder="ME3 : Retranchement..."></textarea>
        <label>Photos de l'adversaire :</label>
        <div id="adversaire_photos_container"></div>
        <button type="button" class="add-btn" onclick="addPhotoField('adversaire_photos_container', 'adversaire-photo-input')">➕</button>
    </div>

    <div class="form-section">
        <h2>1.4 ENVIRONNEMENT</h2>
        <label for="amies">Ami(e)s :</label>
        <input type="text" id="amies" placeholder="Équipes en soutien...">
        <label for="terrain_info">Terrain / Environnement :</label>
        <input type="text" id="terrain_info" placeholder="Météo / Relief / Milieu...">
        <label for="population">Population :</label>
        <input type="text" id="population" placeholder="Neutre">
        <label for="cadre_juridique">Cadre juridique :</label>
        <input type="text" id="cadre_juridique" placeholder="Préliminaire / Flag...">
    </div>

    <div class="form-section">
        <h2>2. MISSIONS du PSIG</h2>
        <textarea id="missions_psig" rows="4" placeholder="INTERPELLER L'OBJECTIF..."></textarea>
    </div>

    <div class="form-section">
        <h2>3. EXÉCUTION</h2>
        <label for="date_execution">Date d'exécution :</label>
        <input type="date" id="date_execution">
        <label for="heure_execution">Heure d'exécution :</label>
        <input type="time" id="heure_execution" value="06:00">
        <label>Type d'action :</label>
        <div id="type_action_container"></div>
        <button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('type_action_container', ['en force', 'en souplesse'])">➕</button>
    </div>

    <div class="form-section">
        <h2>4. ARTICULATION</h2>
        <label for="place_chef">Place du Chef :</label>
        <input type="text" id="place_chef" placeholder="En INDIA / Avec élément interpellation...">
        <h3>Temps d'opération (T0 - T5)</h3>
        <div id="time_events_container"></div>
        <button type="button" class="add-btn" onclick="addTimeEvent()">➕</button>
    </div>

    <div class="form-section">
        <h2>PATRACDVR</h2>
        <div id="patracdvr_container"></div>
        <button type="button" class="add-btn" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
    </div>
    
    <div class="form-section">
        <h2>Photos de l'opération</h2>
        <div id="operation_photos_container"></div>
        <button type="button" class="add-btn" onclick="addCustomPhotoField('operation_photos_container')">Ajouter une photo ➕</button>
    </div>

    <button id="generatePdf">Générer le PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script>
    const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];

    document.addEventListener('DOMContentLoaded', () => {
        ['etat_esprit_container', 'volume_adversaire_container', 'type_action_container'].forEach(id => addDynamicFieldWithSelect(id, []));
        addDynamicField('vehicules_container');
        addDynamicField('armes_container', 'RAS');
        addTimeEvent();
        addPatracdvrRow();
        addPhotoField('adversaire_photos_container');
        addCustomPhotoField('operation_photos_container', 'Cheminement');
    });

    function resetForm() {
        if (confirm('Voulez-vous vraiment réinitialiser le formulaire ?')) {
            localStorage.removeItem('oiFormData');
            location.reload();
        }
    }

    // --- Fonctions pour ajouter/gérer les champs dynamiques ---
    function addDynamicFieldWithSelect(containerId, options) {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        const selectId = `select_${containerId}_${Math.random()}`;
        const inputId = `input_${containerId}_${Math.random()}`;
        item.innerHTML = `<select id="${selectId}" class="dynamic-select"><option value="">Sélection</option>${options.map(o => `<option value="${o}">${o}</option>`).join('')}</select><input type="text" id="${inputId}" class="dynamic-input" placeholder="Ou personnalisé"><button class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
        container.appendChild(item);
    }
    function addDynamicField(containerId, value = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="text" class="dynamic-input" value="${value}"><button class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
        container.appendChild(item);
    }
    function addPhotoField(containerId) {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="file" data-label="Photo Adversaire" accept="image/*"><button class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
        container.appendChild(item);
    }
    function addCustomPhotoField(containerId, label = '') {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item';
        item.innerHTML = `<input type="text" placeholder="Légende" class="photo-label-input" value="${label}"><input type="file" class="photo-input" accept="image/*"><button class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
        container.appendChild(item);
    }
    function addPatracdvrRow() {
        const container = document.getElementById('patracdvr_container');
        const vehicleId = `v_${Date.now()}`;
        const row = document.createElement('div');
        row.className = 'form-section';
        row.innerHTML = `<h3>Véhicule</h3><div class="dynamic-list-item"><select class="patracdvr-vehicle-select">${availableVehicles.map(v => `<option value="${v}">${v}</option>`).join('')}</select><button class="remove-btn" onclick="this.closest('.form-section').remove()">❌</button></div><div id="members_${vehicleId}"></div><button class="add-btn" onclick="addPatracdvrMember('members_${vehicleId}')">➕ Personnel</button>`;
        container.appendChild(row);
        addPatracdvrMember(`members_${vehicleId}`);
    }
    function addPatracdvrMember(containerId) {
        const container = document.getElementById(containerId);
        const item = document.createElement('div');
        item.className = 'dynamic-list-item patracdvr-member-item';
        item.innerHTML = `<input type="text" class="trigramme-input" placeholder="Trigramme"><select class="equipement-select">${['PIE','EFFRAC','LBD','UMP','G36','IL','GENL','MP7'].map(o=>`<option value="${o}">${o}</option>`).join('')}</select><select class="fonction-select">${['Chef inter','Chef dispo','AO','Inter','DE'].map(o=>`<option value="${o}">${o}</option>`).join('')}</select><button class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
        container.appendChild(item);
    }
    function addTimeEvent() {
        const container = document.getElementById('time_events_container');
        const item = document.createElement('div');
        item.className = 'dynamic-list-item time-item';
        item.innerHTML = `<select class="time-type-select">${['T0','T1','T2','T3','T4','T5'].map(t=>`<option value="${t}">${t}</option>`).join('')}</select><input type="time" class="time-hour-input"><input type="text" class="time-description-input" placeholder="Description"><button class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
        container.appendChild(item);
    }

    // --- PDF GENERATION ---
    document.getElementById('generatePdf').addEventListener('click', async () => {
        try {
            const { jsPDF } = jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPos = margin;
            
            const getVal = (id) => document.getElementById(id)?.value.trim() || 'RAS';
            const getDynamicList = (containerId) => {
                const values = Array.from(document.querySelectorAll(`#${containerId} .dynamic-input`)).map(i => i.value || i.previousElementSibling.value).filter(Boolean);
                return values.length > 0 ? values.join(', ') : 'RAS';
            };

            const addHeaderAndFooter = (pageNumber, isLandscape = false) => {
                doc.setPage(pageNumber);
                const width = isLandscape ? pageHeight : pageWidth;
                const height = isLandscape ? pageWidth : pageHeight;
                doc.setFillColor(18, 18, 18).rect(0, 0, width, height, 'F');
                doc.setFontSize(10).setTextColor('#e0e0e0').text(`Page ${pageNumber}`, width - margin, height - 20);
            };
            
            doc.deletePage(1);
            doc.addPage('a4', 'landscape');
            const landscapeWidth = doc.internal.pageSize.getWidth(), landscapeHeight = doc.internal.pageSize.getHeight();
            const titleText = `Opération du ${getVal('date_op') || 'Date non spécifiée'}`;
            doc.setFontSize(70);
            const titleWidth = doc.getStringUnitWidth(titleText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
            if (titleWidth > landscapeWidth - margin * 4) doc.setFontSize((landscapeWidth - margin * 4) * doc.internal.scaleFactor / doc.getStringUnitWidth(titleText));
            doc.setTextColor('#5b9bd5').text(titleText, landscapeWidth / 2, landscapeHeight / 2, { align: 'center', baseline: 'middle' });

            const checkYPos = (space) => {
                if (yPos + space > pageHeight - margin) { doc.addPage('a4', 'portrait'); yPos = margin; return true; }
                return false;
            };
            const addSectionTitle = (title) => {
                doc.addPage('a4', 'portrait'); yPos = margin;
                doc.setFontSize(27).setFont('helvetica', 'bold').setTextColor('#5b9bd5');
                const splitTitle = doc.splitTextToSize(title, pageWidth - margin * 2);
                doc.text(splitTitle, margin, yPos); yPos += splitTitle.length * 27 + 15;
            };
            const addText = (text) => {
                if(!text || text.trim() === 'RAS') return;
                checkYPos(30);
                doc.setFontSize(12).setFont('helvetica', 'normal').setTextColor('#e0e0e0');
                const lines = doc.splitTextToSize(text, pageWidth - margin * 2);
                doc.text(lines, margin, yPos); yPos += lines.length * 15 + 10;
            };
            const tableConfig = {
                theme: 'grid', styles: { fontSize: 15, cellPadding: 5, textColor: [224, 224, 224], fillColor: [30, 30, 30] },
                headStyles: { fontSize: 22.5, fillColor: [42, 42, 42], textColor: [255, 255, 255], fontStyle: 'bold' },
                didDrawPage: (data) => { yPos = data.cursor.y; }, margin: { left: margin, right: margin }
            };
            const renderAutoTable = (config) => {
                checkYPos(60); doc.autoTable({ startY: yPos, ...tableConfig, ...config });
                yPos = doc.autoTable.previous.finalY + 20;
            };

            // --- SECTIONS ---
            addSectionTitle("1. SITUATION");
            addText(getVal('situation_generale'));
            addText(getVal('situation_particuliere'));
            
            renderAutoTable({
                head: [['ADVERSAIRE', 'DÉTAILS']],
                body: [
                    ['Nom/Prénom', getVal('nom_adversaire')],
                    ['Domicile', getVal('domicile_adversaire')],
                    ['Naissance', `${getVal('date_naissance')} à ${getVal('lieu_naissance')}`],
                    ['Description', `${getVal('stature_adversaire')} / ${getVal('ethnie_adversaire')} / ${getVal('signes_particuliers_adversaire')}`],
                    ['Profession', getVal('profession_adversaire')],
                    ['Antécédents', getVal('antecedents_adversaire')],
                    ['État d\'esprit', getDynamicList('etat_esprit_container')],
                    ['Attitude', getVal('attitude_adversaire')],
                    ['Volume', getDynamicList('volume_adversaire_container')],
                    ['Substances', getVal('substances_adversaire')],
                    ['Véhicules', getDynamicList('vehicules_container')],
                    ['Armes', getDynamicList('armes_container')],
                    ['Modes d\'action', `ME1: ${getVal('mode_action_me1')}\nME2: ${getVal('mode_action_me2')}\nME3: ${getVal('mode_action_me3')}`]
                ]
            });
            await addImagesFromContainer('adversaire_photos_container');
            
            renderAutoTable({ head: [['ENVIRONNEMENT', 'DÉTAILS']], body: [['Ami(e)s', getVal('amies')], ['Terrain', getVal('terrain_info')], ['Population', getVal('population')], ['Cadre juridique', getVal('cadre_juridique')]] });
            
            addSectionTitle("2. MISSIONS du PSIG"); addText(getVal('missions_psig'));
            
            addSectionTitle("3. EXÉCUTION");
            renderAutoTable({ body: [['Date', getVal('date_execution')], ['Heure', getVal('heure_execution')], ['Type d\'action', getDynamicList('type_action_container')]] });
            
            addSectionTitle("4. ARTICULATION"); addText(`Place du Chef: ${getVal('place_chef')}`);
            const timeEvents = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => [item.querySelector('.time-type-select').value, item.querySelector('.time-hour-input').value || 'RAS', item.querySelector('.time-description-input').value || 'RAS']);
            renderAutoTable({ head: [['Type', 'Heure', 'Description']], body: timeEvents });
            
            addSectionTitle("PATRACDVR");
            const patracdvrRows = Array.from(document.querySelectorAll('#patracdvr_container .form-section'));
            for(const row of patracdvrRows) {
                const vehicle = row.querySelector('.patracdvr-vehicle-select').value;
                const members = Array.from(row.querySelectorAll('.patracdvr-member-item')).map(item => [item.querySelector('.trigramme-input').value, item.querySelector('.equipement-select').value, item.querySelector('.fonction-select').value]).filter(m => m[0]);
                if (members.length > 0) {
                    renderAutoTable({ head: [[vehicle, 'Équipement', 'Fonction']], body: members });
                }
            }

            await addImagesFromContainer('operation_photos_container', true);
            
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                const pageInfo = doc.getPageInfo(i);
                const isLandscape = pageInfo.pageContext.mediaBox.topRight[0] > pageInfo.pageContext.mediaBox.bottomRight[1];
                addHeaderAndFooter(i, isLandscape);
            }
            
            const dateForFile = getVal('date_op').replace(/\//g, '-') || 'date';
            const nameForFile = getVal('nom_adversaire').replace(/ /g, '_') || 'OI';
            doc.save(`OI_${dateForFile}_${nameForFile}.pdf`);
        } catch (error) {
            console.error("Erreur PDF:", error); alert("Erreur lors de la génération du PDF. Vérifiez la console (F12).");
        }

        async function addImagesFromContainer(containerId, newPage = false) {
            const inputs = Array.from(document.querySelectorAll(`#${containerId} input[type="file"]`)).filter(i => i.files.length > 0);
            if (inputs.length === 0) return;
            if (newPage) addSectionTitle("Photos de l'opération");
            const imagePromises = inputs.map(input => {
                const label = input.parentElement.querySelector('.photo-label-input')?.value || input.dataset.label || 'Image';
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve({ src: e.target.result, label });
                    reader.readAsDataURL(input.files[0]);
                });
            });
            const images = await Promise.all(imagePromises);
            const drawImageRow = async (rowData) => {
                const padding = 10, availableWidth = pageWidth - margin * 2;
                const imageWidth = (availableWidth - (padding * (rowData.length - 1))) / rowData.length;
                let maxHeightInRow = 0;
                const processed = [];
                for (const data of rowData) {
                    const img = new Image(); img.src = data.src;
                    await new Promise(r => img.onload = r);
                    const imageHeight = imageWidth * (img.height / img.width);
                    maxHeightInRow = Math.max(maxHeightInRow, imageHeight);
                    processed.push({ img, ...data, width: imageWidth, height: imageHeight });
                }
                checkYPos(maxHeightInRow + 30);
                let xPos = margin;
                for (const p of processed) {
                    doc.addImage(p.img, 'JPEG', xPos, yPos, p.width, p.height);
                    doc.setFontSize(9).setTextColor('#95a5a6').text(p.label, xPos + p.width / 2, yPos + p.height + 15, { align: 'center' });
                    xPos += p.width + padding;
                }
                yPos += maxHeightInRow + 30;
            };
            for (let i = 0; i < images.length; i += 2) await drawImageRow(images.slice(i, i + 2));
        }
    });
</script>

</body>
</html>
