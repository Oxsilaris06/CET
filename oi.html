<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial - Wizard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; /* Espace pour le dock */ transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Saira Stencil One', sans-serif; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        h3 { color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; font-weight: 400; }

        .wizard-progress { display: flex; justify-content: space-between; margin-bottom: 25px; list-style-type: none; padding: 0; }
        .wizard-progress-step { flex: 1; text-align: center; font-size: 0.9em; color: var(--text-secondary); position: relative; }
        .wizard-progress-step:before { content: ''; position: absolute; top: 50%; left: -50%; width: 100%; height: 2px; background-color: var(--border-color); z-index: -1; }
        .wizard-progress-step:first-child:before { content: none; }
        .wizard-progress-step.active { color: var(--accent-blue); font-weight: 500; }
        .wizard-progress-step.active:before, .wizard-progress-step.completed:before { background-color: var(--accent-blue); }
        .wizard-progress-step.completed { color: var(--accent-blue); }

        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .wizard-nav { display: flex; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .wizard-nav-btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; transition: background-color 0.2s; }
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #nextBtn { background-color: var(--accent-blue); color: white; }
        #generatePdfBtn { background-color: #27ae60; color: white; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        .form-section { margin-bottom: 20px; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .dynamic-list-item > *:not(button) { flex-grow: 1; margin-bottom: 0; }
        button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
        button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        
        .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 10px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px 15px; }
        .collapsible-header h3 { margin: 0; font-size: 1.2em; }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible-container.open .collapsible-content { max-height: 1000px; padding-bottom: 15px; }
        .collapsible-header .material-icons { transition: transform 0.3s; }
        .collapsible-container.open .material-icons { transform: rotate(180deg); }

        .dock-menu {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 90%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            z-index: 1000;
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--border-color);
            border-radius: 20px 20px 0 0;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .dock-menu-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-container);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            text-decoration: none;
        }
        .dock-menu-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        @media (max-width: 600px) {
            body { padding: 5px; padding-bottom: 80px; }
            .container { padding: 15px; }
            h1 { font-size: 1.8em; }
            .wizard-progress-step { font-size: 0.6em; white-space: nowrap; word-break: keep-all; }
            .wizard-nav-btn { padding: 10px 15px; font-size: 1em; }
            .dynamic-list-item { flex-wrap: wrap; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <a href="index.html" class="dock-menu-item" title="Accueil">
            <span class="material-icons">home</span>
        </a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème">
            <span class="material-symbols-outlined" id="darkModeIcon">nightlight</span>
        </div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire">
            <span class="material-icons">refresh</span>
        </div>
    </div>

    <div class="container">
        <h1>Générateur d'Ordre Initial</h1>

        <ul class="wizard-progress">
            <li class="wizard-progress-step active">Situation</li>
            <li class="wizard-progress-step">Adversaire</li>
            <li class="wizard-progress-step">Environnement</li>
            <li class="wizard-progress-step">Mission</li>
            <li class="wizard-progress-step">Exécution</li>
            <li class="wizard-progress-step">Moyens</li>
            <li class="wizard-progress-step">Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step active">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'opération :</label><input type="text" id="date_op" placeholder="ex: 14/01/2025">
                    <label for="situation_generale">1.1 Générale :</label><textarea id="situation_generale" rows="5" placeholder="Décrivez les faits et l'enquête..."></textarea>
                    <label for="situation_particuliere">1.2 Particulière :</label><textarea id="situation_particuliere" rows="3" placeholder="ex: L'interpellation du mis en cause est programmée le..."></textarea>
                </div>

                <div class="wizard-step">
                    <h2>1.3 Adversaire</h2>
                    <label for="nom_adversaire">Nom/Prénom :</label><input type="text" id="nom_adversaire">
                    <label for="domicile_adversaire">Domicile :</label><textarea id="domicile_adversaire" rows="2"></textarea>
                    <div class="dynamic-list-item"><input type="date" id="date_naissance" aria-label="Date de naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
                    <div class="dynamic-list-item"><input type="text" id="stature_adversaire" placeholder="Stature (ex: 1.72m)"><select id="ethnie_adversaire"><option>Caucasien</option><option>Nord africain</option><option>Afro-antillais</option><option>Asiatique</option></select></div>
                    <label for="signes_particuliers_adversaire">Signes particuliers :</label><input type="text" id="signes_particuliers_adversaire">
                    <label for="profession_adversaire">Profession :</label><input type="text" id="profession_adversaire">
                    <label for="antecedents_adversaire">Antécédents :</label><textarea id="antecedents_adversaire" rows="2"></textarea>
                    <label>État d'esprit :</label><div id="etat_esprit_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant'])">➕</button>
                    <label for="attitude_adversaire">Attitude (connue) :</label><textarea id="attitude_adversaire" rows="2"></textarea>
                    <label>Volume (renfort potentiel) :</label><div id="volume_adversaire_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'])">➕</button>
                    <label for="substances_adversaire">Substances :</label><input type="text" id="substances_adversaire">
                    <label>Véhicules :</label><div id="vehicules_container"></div><button type="button" class="add-btn" onclick="addDynamicField('vehicules_container')">➕</button>
                    <label>Armes :</label><div id="armes_container"></div><button type="button" class="add-btn" onclick="addDynamicField('armes_container')">➕</button>
                    <label>Modes d'action possibles :</label>
                    <textarea id="mode_action_me1" rows="1" placeholder="ME1 (le + probable) : Fuite..."></textarea>
                    <textarea id="mode_action_me2" rows="1" placeholder="ME2 : Rébellion..."></textarea>
                    <textarea id="mode_action_me3" rows="1" placeholder="ME3 : Retranchement..."></textarea>
                </div>
                
                <div class="wizard-step">
                    <h2>1.4 Environnement</h2>
                     <label for="amies">Ami(e)s (Unités en soutien) :</label><input type="text" id="amies" placeholder="ex: BT locale, BR...">
                     <label for="terrain_info">Terrain / Météo :</label><input type="text" id="terrain_info" placeholder="ex: Pluie, Urbain dense...">
                     <label for="population">Population :</label><input type="text" id="population" placeholder="ex: Neutre, hostile...">
                     <label for="cadre_juridique">Cadre juridique :</label><input type="text" id="cadre_juridique" placeholder="ex: Préliminaire, flagrance...">
                </div>

                <div class="wizard-step">
                    <h2>2. Mission du PSIG</h2>
                    <textarea id="missions_psig" rows="8" placeholder="INTERPELLER L'OBJECTIF...\nPROCÉDER À LA PERQUISITION..."></textarea>
                </div>

                <div class="wizard-step">
                     <h2>3. Exécution</h2>
                     <label for="date_execution">Date d'exécution :</label><input type="date" id="date_execution">
                     <label for="heure_execution">Heure d'exécution (H) :</label><input type="time" id="heure_execution" value="06:00">
                     <label>Type d'action :</label><div id="type_action_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('type_action_container', ['en force', 'en souplesse'])">➕</button>
                     <h2 style="margin-top:30px;">4. Articulation</h2>
                     <label for="place_chef">Place du Chef :</label><input type="text" id="place_chef" placeholder="ex: Avec l'élément d'assaut...">
                     <h3>Chronologie de l'opération</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">Ajouter un temps ➕</button>
                </div>

                <div class="wizard-step">
                    <h2>Moyens Engagés (PATRACDVR)</h2>
                    <div id="patracdvr_container"></div>
                    <button type="button" class="add-btn" style="width:100%; padding:10px; margin-top:10px;" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
                </div>
                
                <div class="wizard-step">
                    <h2>Photos & Finalisation</h2>
                    <div class="form-section">
                        <h3>Photos de l'adversaire</h3>
                        <div id="adversaire_photos_container"></div>
                        <button type="button" class="add-btn" onclick="addPhotoField('adversaire_photos_container', 'adversaire-photo-input')">Ajouter ➕</button>
                    </div>
                    <div class="form-section">
                        <h3>Photos de l'opération (Lieux, cheminement...)</h3>
                        <div id="operation_photos_container"></div>
                        <button type="button" class="add-btn" onclick="addCustomPhotoField('operation_photos_container')">Ajouter ➕</button>
                    </div>
                    <p style="text-align:center; margin-top:30px; color: var(--text-secondary);">Vous êtes prêt. Cliquez sur "Générer le PDF" pour créer votre document.</p>
                </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button" onclick="changeStep(-1)">Précédent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button" onclick="changeStep(1)">Suivant</button>
            <button class="wizard-nav-btn" id="generatePdfBtn" type="button" style="display:none;">Générer le PDF 📄</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // --- WIZARD LOGIC & FORM MANAGEMENT (inchangé) ---
        let currentStep = 0;
        const steps = document.querySelectorAll(".wizard-step");
        const progressSteps = document.querySelectorAll(".wizard-progress-step");

        function showStep(n) {
            steps.forEach(step => step.classList.remove('active'));
            steps[n].classList.add('active');
            progressSteps.forEach((step, index) => {
                step.classList.toggle('active', index === n);
                step.classList.toggle('completed', index < n);
            });
            document.getElementById("prevBtn").style.display = n === 0 ? "none" : "inline-block";
            document.getElementById("nextBtn").style.display = n === (steps.length - 1) ? "none" : "inline-block";
            document.getElementById("generatePdfBtn").style.display = n === (steps.length - 1) ? "inline-block" : "none";
        }

        function changeStep(n) {
            saveFormData();
            currentStep = Math.max(0, Math.min(currentStep + n, steps.length - 1));
            showStep(currentStep);
        }
        
        const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Scénic', 'BT'];
        function saveFormData() {
            try {
                const data = {};
                document.querySelectorAll('#oi-form input, #oi-form textarea, #oi-form select').forEach(field => {
                    if (field.type !== 'file' && field.id) data[field.id] = field.value;
                });
                data.etat_esprit_list = Array.from(document.querySelectorAll(`#etat_esprit_container .dynamic-input`)).map(i => i.value);
                data.volume_list = Array.from(document.querySelectorAll(`#volume_adversaire_container .dynamic-input`)).map(i => i.value);
                data.type_action_list = Array.from(document.querySelectorAll(`#type_action_container .dynamic-input`)).map(i => i.value);
                data.vehicules_list = Array.from(document.querySelectorAll(`#vehicules_container .dynamic-input`)).map(i => i.value);
                data.armes_list = Array.from(document.querySelectorAll(`#armes_container .dynamic-input`)).map(i => i.value);
                data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .collapsible-container')).map(row => ({
                    vehicle: row.querySelector('.patracdvr-vehicle-select').value,
                    members: Array.from(row.querySelectorAll('.patracdvr-member-item')).map(item => ({
                        trigramme: item.querySelector('.trigramme-input').value,
                        equipement: item.querySelector('.equipement-select').value,
                        fonction: item.querySelector('.fonction-select').value
                    }))
                }));
                data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
                    type: item.querySelector('.time-type-select').value,
                    hour: item.querySelector('.time-hour-input').value,
                    description: item.querySelector('.time-description-input').value
                }));
                localStorage.setItem('oiFormData', JSON.stringify(data));
            } catch (e) { console.error("Save error:", e); }
        }

        function loadFormData() {
            const dataString = localStorage.getItem('oiFormData');
            if (!dataString) return;
            try {
                const data = JSON.parse(dataString);
                Object.keys(data).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && typeof data[key] === 'string') el.value = data[key];
                });
                (data.etat_esprit_list || []).forEach(val => addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant'], val));
                (data.volume_list || []).forEach(val => addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'], val));
                (data.type_action_list || []).forEach(val => addDynamicFieldWithSelect('type_action_container', ['en force', 'en souplesse'], val));
                (data.vehicules_list || []).forEach(val => addDynamicField('vehicules_container', val));
                (data.armes_list || []).forEach(val => addDynamicField('armes_container', val));
                (data.time_events || []).forEach(ev => addTimeEvent(ev.type, ev.hour, ev.description));
                (data.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
            } catch (e) { console.error("Load error:", e); }
        }
        
        function addDynamicFieldWithSelect(containerId, options, value = '') {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            const selectId = `select_${containerId}_${Math.random()}`;
            const inputId = `input_${containerId}_${Math.random()}`;
            item.innerHTML = `<select id="${selectId}" onchange="document.getElementById('${inputId}').value = this.value; saveFormData();"><option value="">Sélection</option>${options.map(o => `<option value="${o}" ${o === value ? 'selected':''}>${o}</option>`).join('')}</select><input type="text" id="${inputId}" class="dynamic-input" placeholder="Ou personnalisé" value="${value}" oninput="document.getElementById('${selectId}').value = ''; saveFormData();"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        function addDynamicField(containerId, value = '') {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<input type="text" class="dynamic-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        function addPhotoField(containerId) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<input type="file" data-label="Photo Adversaire" accept="image/*"><button type="button" class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
            container.appendChild(item);
        }
        function addCustomPhotoField(containerId) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item';
            item.innerHTML = `<input type="text" placeholder="Légende" class="photo-label-input"><input type="file" class="photo-input" accept="image/*"><button type="button" class="remove-btn" onclick="this.parentElement.remove()">❌</button>`;
            container.appendChild(item);
        }
        function addPatracdvrRow(vehicle, members = []) {
            const container = document.getElementById('patracdvr_container');
            const vehicleId = `v_${Date.now()}`;
            const row = document.createElement('div');
            row.className = 'collapsible-container';
            row.innerHTML = `<div class="collapsible-header"><h3>Véhicule</h3><span class="material-icons">expand_more</span></div><div class="collapsible-content"><div class="dynamic-list-item"><select class="patracdvr-vehicle-select" onchange="saveFormData()">${availableVehicles.map(v => `<option value="${v}" ${v === vehicle ? 'selected':''}>${v}</option>`).join('')}</select><button type="button" class="remove-btn" onclick="this.closest('.collapsible-container').remove(); saveFormData();">❌</button></div><div id="patracdvr_members_${vehicleId}"></div><button type="button" class="add-btn" onclick="addPatracdvrMember('${vehicleId}')">➕ Personnel</button></div>`;
            container.appendChild(row);
            if (members.length > 0) members.forEach(m => addPatracdvrMember(vehicleId, m.trigramme, m.equipement, m.fonction));
            else addPatracdvrMember(vehicleId);
            row.querySelector('.collapsible-header').addEventListener('click', (e) => e.currentTarget.parentElement.classList.toggle('open'));
        }
        function addPatracdvrMember(vehicleId, t = '', e = 'PIE', f = 'Inter') {
            const container = document.getElementById(`patracdvr_members_${vehicleId}`);
            const item = document.createElement('div');
            item.className = 'dynamic-list-item patracdvr-member-item';
            item.innerHTML = `<input type="text" class="trigramme-input" placeholder="Trigramme" value="${t}" oninput="saveFormData()"><select class="equipement-select" onchange="saveFormData()">${['PIE','EFFRAC','LBD','UMP','G36','IL','GENL','MP7'].map(o=>`<option value="${o}" ${o===e?'selected':''}>${o}</option>`).join('')}</select><select class="fonction-select" onchange="saveFormData()">${['Chef inter','Chef dispo','AO','Inter','DE'].map(o=>`<option value="${o}" ${o===f?'selected':''}>${o}</option>`).join('')}</select><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }
        function addTimeEvent(type='T0', hour='', desc='') {
            const container = document.getElementById('time_events_container');
            const item = document.createElement('div');
            item.className = 'dynamic-list-item time-item';
            item.innerHTML = `<select class="time-type-select" onchange="saveFormData()">${['T0','T1','T2','T3','T4','T5'].map(t=>`<option value="${t}" ${t===type?'selected':''}>${t}</option>`).join('')}</select><input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()"><input type="text" class="time-description-input" placeholder="Description" value="${desc}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">❌</button>`;
            container.appendChild(item);
        }

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const body = document.body;
            body.classList.toggle('light-mode'); body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm("Voulez-vous vraiment réinitialiser tout le formulaire ?")) {
                localStorage.removeItem('oiFormData');
                location.reload();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                document.getElementById('darkModeIcon').textContent = 'clear_day';
            } else {
                 document.getElementById('darkModeIcon').textContent = 'nightlight';
            }
            showStep(currentStep);
            loadFormData();
        });
        
        // --- NOUVELLE IMPLEMENTATION PDF AVEC PDF-LIB ---
        document.getElementById('generatePdfBtn').addEventListener('click', async () => {
            try {
                // Initialisation
                const { PDFDocument, StandardFonts, rgb } = PDFLib;
                const pdfDoc = await PDFDocument.create();
                const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                
                // Collecte des données
                saveFormData();
                const formDataString = localStorage.getItem('oiFormData');
                if (!formDataString) { alert("Aucune donnée à générer."); return; }
                const formData = JSON.parse(formDataString);
                const getVal = (id) => formData[id] || 'RAS';

                // Couleurs
                const colors = {
                    background: rgb(30/255, 30/255, 30/255),
                    text: rgb(1, 1, 1),
                    label: rgb(220/255, 220/255, 220/255),
                    accent: rgb(91/255, 155/255, 213/255),
                    tableHeader: rgb(42/255, 42/255, 42/255),
                    tableFill: rgb(40/255, 40/255, 40/255)
                };

                // Contexte de rendu
                let currentPage = pdfDoc.addPage();
                const { width, height } = currentPage.getSize();
                const margin = 40;
                let y = height - margin;

                // --- Fonctions utilitaires de rendu pour PDF-LIB ---

                const addDarkBackground = () => currentPage.drawRectangle({ x: 0, y: 0, width, height, color: colors.background });
                
                const checkY = (spaceNeeded) => {
                    if (y - spaceNeeded < margin) {
                        currentPage = pdfDoc.addPage();
                        addDarkBackground();
                        y = height - margin;
                    }
                };

                const drawSectionTitle = (text) => {
                    checkY(40);
                    y -= 35;
                    currentPage.drawText(text, { x: margin, y: y, font: helveticaBoldFont, size: 18, color: colors.accent });
                };

                const drawLabeledText = (label, value) => {
                    const labelText = `${label}: `;
                    const labelWidth = helveticaBoldFont.widthOfTextAtSize(labelText, 14);
                    const valueLines = wrapText(value, helveticaFont, 14, width - margin * 2 - labelWidth);
                    const totalHeight = valueLines.length * 15 + 10;
                    checkY(totalHeight);
                    
                    y -= 15;
                    currentPage.drawText(labelText, { x: margin, y: y, font: helveticaBoldFont, size: 14, color: colors.label });
                    
                    valueLines.forEach((line, index) => {
                         currentPage.drawText(line, { x: margin + labelWidth, y: y - (index * 15), font: helveticaFont, size: 14, color: colors.text });
                    });
                    y -= totalHeight - 15;
                };

                const wrapText = (text, font, size, maxWidth) => {
                    const words = text.replace(/\n/g, ' \n ').split(' ');
                    const lines = [];
                    let currentLine = '';
                    for (const word of words) {
                        if (word === '\n') {
                            lines.push(currentLine);
                            currentLine = '';
                            continue;
                        }
                        const lineWithWord = currentLine === '' ? word : `${currentLine} ${word}`;
                        const lineWidth = font.widthOfTextAtSize(lineWithWord, size);
                        if (lineWidth > maxWidth) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine = lineWithWord;
                        }
                    }
                    lines.push(currentLine);
                    return lines;
                };

                const drawTable = (headers, rows, columnWidths, style) => {
                    const rowPadding = 5;
                    const availableWidth = width - margin * 2;
                    
                    const calculatedWidths = columnWidths 
                        ? columnWidths.map(w => w * availableWidth)
                        : Array(headers.length).fill(availableWidth / headers.length);
                    
                    const wrappedHeaders = headers.map((h, i) => wrapText(h, style.headFont, style.headSize, calculatedWidths[i] - rowPadding * 2));
                    const headerHeight = Math.max(...wrappedHeaders.map(lines => lines.length)) * style.headSize + rowPadding * 2;
                    
                    checkY(headerHeight);
                    y -= headerHeight;
                    
                    headers.forEach((_, i) => {
                        const x = margin + calculatedWidths.slice(0, i).reduce((a, b) => a + b, 0);
                        currentPage.drawRectangle({ x, y, width: calculatedWidths[i], height: headerHeight, color: colors.tableHeader });
                        wrappedHeaders[i].forEach((line, lineIndex) => {
                            const textY = y + headerHeight - rowPadding - style.headSize - (lineIndex * style.headSize);
                            currentPage.drawText(line, { x: x + rowPadding, y: textY, font: style.headFont, size: style.headSize, color: colors.text });
                        });
                    });

                    rows.forEach(row => {
                        const wrappedRow = row.map((cell, i) => wrapText(String(cell), style.bodyFont, style.bodySize, calculatedWidths[i] - rowPadding * 2));
                        const rowHeight = Math.max(...wrappedRow.map(lines => lines.length)) * style.bodySize + rowPadding * 2;
                        
                        checkY(rowHeight);
                        y -= rowHeight;
                        
                        row.forEach((_, i) => {
                            const x = margin + calculatedWidths.slice(0, i).reduce((a, b) => a + b, 0);
                            currentPage.drawRectangle({ x, y, width: calculatedWidths[i], height: rowHeight, color: colors.tableFill });
                             currentPage.drawRectangle({ x, y, width: calculatedWidths[i], height: rowHeight, borderColor: colors.background, borderWidth: 0.5 });
                            wrappedRow[i].forEach((line, lineIndex) => {
                                const textY = y + rowHeight - rowPadding - style.bodySize - (lineIndex * style.bodySize);
                                currentPage.drawText(line, { x: x + rowPadding, y: textY, font: style.bodyFont, size: style.bodySize, color: colors.text });
                            });
                        });
                    });
                };
                
                // --- Construction du PDF ---

                addDarkBackground();
                
                // Page de titre
                const title = 'ORDRE INITIAL';
                const dateTitle = `Opération du ${getVal('date_op') || 'N/A'}`;
                const titleWidth = helveticaBoldFont.widthOfTextAtSize(title, 40);
                const dateTitleWidth = helveticaFont.widthOfTextAtSize(dateTitle, 20);
                currentPage.drawText(title, { x: width / 2 - titleWidth / 2, y: height / 2, font: helveticaBoldFont, size: 40, color: colors.accent });
                currentPage.drawText(dateTitle, { x: width / 2 - dateTitleWidth / 2, y: height / 2 - 40, font: helveticaFont, size: 20, color: colors.text });

                currentPage = pdfDoc.addPage();
                addDarkBackground();
                y = height - margin;

                // Sections
                drawSectionTitle("1. SITUATION");
                drawLabeledText("1.1 Générale", getVal('situation_generale'));
                drawLabeledText("1.2 Particulière", getVal('situation_particuliere'));

                drawSectionTitle("1.3 ADVERSAIRE & 1.4 ENVIRONNEMENT");
                drawTable(['Catégorie', 'Détails'], [
                        ['Nom/Prénom', getVal('nom_adversaire')], ['Domicile', getVal('domicile_adversaire')],
                        ['Naissance', `${getVal('date_naissance')} à ${getVal('lieu_naissance')}`],
                        ['Description', [getVal('stature_adversaire'), getVal('ethnie_adversaire'), getVal('signes_particuliers_adversaire')].filter(Boolean).join(' / ') || 'RAS'],
                        ['Profession', getVal('profession_adversaire')],['Antécédents', getVal('antecedents_adversaire')],
                        ['État d\'esprit', (formData.etat_esprit_list || []).join(', ') || 'RAS'],
                        ['Attitude', getVal('attitude_adversaire')], ['Volume (renfort)', (formData.volume_list || []).join(', ') || 'RAS'],
                        ['Substances', getVal('substances_adversaire')], ['Véhicules', (formData.vehicules_list || []).join(', ') || 'RAS'],
                        ['Armes', (formData.armes_list || []).join(', ') || 'RAS'],
                        ['Modes d\'action', `ME1: ${getVal('mode_action_me1')}\nME2: ${getVal('mode_action_me2')}\nME3: ${getVal('mode_action_me3')}`],
                        ['Ami(e)s (soutien)', getVal('amies')], ['Terrain / Météo', getVal('terrain_info')],
                        ['Population', getVal('population')], ['Cadre juridique', getVal('cadre_juridique')]
                    ], [0.3, 0.7], { headFont: helveticaBoldFont, headSize: 15, bodyFont: helveticaFont, bodySize: 14 });
                
                y-= 20;
                drawSectionTitle("2. MISSION");
                drawLabeledText("Mission principale", getVal('missions_psig'));
                
                checkY(200); // Espace pour la prochaine section
                drawSectionTitle("3. EXÉCUTION & 4. ARTICULATION");
                drawLabeledText("Date/Heure/Action", `Date: ${getVal('date_execution')} | Heure: ${getVal('heure_execution')} | Type: ${(formData.type_action_list || []).join(', ') || 'RAS'}`);
                drawLabeledText("Place du Chef", getVal('place_chef'));
                y -= 10;
                drawTable(
                    ['Type', 'Heure', 'Description'], 
                    (formData.time_events || []).map(e => [e.type, e.hour || 'N/A', e.description || 'N/A']), 
                    [0.15, 0.2, 0.65], 
                    { headFont: helveticaBoldFont, headSize: 14, bodyFont: helveticaFont, bodySize: 13 }
                );

                y-= 20;
                drawSectionTitle("5. MOYENS ENGAGÉS (PATRACDVR)");
                (formData.patracdvr_rows || []).forEach(row => {
                    const members = row.members.filter(m => m.trigramme);
                    if (members.length > 0) {
                        y -= 10;
                        drawTable(
                            [`Véhicule: ${row.vehicle}`, 'Équipement', 'Fonction'], 
                            members.map(m => [m.trigramme, m.equipement, m.fonction]), 
                            [0.33, 0.33, 0.34], 
                            { headFont: helveticaBoldFont, headSize: 14, bodyFont: helveticaFont, bodySize: 13 }
                        );
                    }
                });
                
                // Sauvegarde
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `OI_${getVal('date_op').replace(/[\/\\?%*:|"<>]/g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
                link.click();

            } catch (error) {
                console.error("Erreur critique lors de la génération du PDF:", error);
                alert("Une erreur critique est survenue. Consultez la console (F12).");
            }
        });
    </script>
</body>
</html>
