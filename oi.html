<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur d'Ordre Initial - Wizard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
            --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
            --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
        }
        body.light-mode {
            --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
            --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
            --border-color: #dee2e6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 15px; padding-bottom: 80px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px 30px; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 2.5em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Saira Stencil One', sans-serif; }
        h2 { color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; font-weight: 400; }
        h3 { color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; font-weight: 400; }
        .wizard-progress { display: flex; justify-content: space-between; margin-bottom: 25px; list-style-type: none; padding: 0; }
        .wizard-progress-step { flex: 1; text-align: center; font-size: 0.8em; color: var(--text-secondary); position: relative; }
        .wizard-progress-step:before { content: ''; position: absolute; top: 50%; left: -50%; width: 100%; height: 2px; background-color: var(--border-color); z-index: -1; }
        .wizard-progress-step:first-child:before { content: none; }
        .wizard-progress-step.active { color: var(--accent-blue); font-weight: 500; }
        .wizard-progress-step.active:before, .wizard-progress-step.completed:before { background-color: var(--accent-blue); }
        .wizard-progress-step.completed { color: var(--accent-blue); }
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .wizard-nav { display: flex; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .wizard-nav-btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; transition: background-color 0.2s; }
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #nextBtn { background-color: var(--accent-blue); color: white; }
        #generatePdfBtn { background-color: #27ae60; color: white; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input[type="text"], input[type="date"], input[type="time"], textarea, select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; }
        .form-section { margin-bottom: 20px; }
        .dynamic-list-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .dynamic-list-item > *:not(button) { flex-grow: 1; margin-bottom: 0; }
        button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
        button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 10px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 10px 15px; }
        .collapsible-header h3 { margin: 0; font-size: 1.2em; }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible-container.open .collapsible-content { max-height: 1000px; padding-bottom: 15px; }
        .collapsible-header .material-icons { transition: transform 0.3s; }
        .collapsible-container.open .material-icons { transform: rotate(180deg); }
        .dock-menu {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            max-width: 90%;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            z-index: 1000;
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--border-color);
            border-radius: 20px 20px 0 0;
            backdrop-filter: blur(10px);
        }
        .dock-menu-item {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-container);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.2s;
            text-decoration: none;
        }
        .dock-menu-item:hover { transform: scale(1.1); box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="dark-mode">

    <div class="dock-menu" id="dockMenu">
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-icons">home</span></a>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le thème"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="Réinitialiser le formulaire"><span class="material-icons">refresh</span></div>
    </div>

    <div class="container">
        <h1>Générateur d'Ordre Initial</h1>
        
        <ul class="wizard-progress">
            <li class="wizard-progress-step active">Situation</li>
            <li class="wizard-progress-step">Adversaire</li>
            <li class="wizard-progress-step">Environnement</li>
            <li class="wizard-progress-step">Mission</li>
            <li class="wizard-progress-step">Exécution</li>
            <li class="wizard-progress-step">Articulation</li>
            <li class="wizard-progress-step">PATRACDVR</li>
            <li class="wizard-progress-step">Photos</li>
            <li class="wizard-progress-step">Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step active">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'opération :</label><input type="text" id="date_op">
                    <label for="situation_generale">1.1 Générale :</label><textarea id="situation_generale" rows="5"></textarea>
                    <label for="situation_particuliere">1.2 Particulière :</label><textarea id="situation_particuliere" rows="3"></textarea>
                </div>

                <div class="wizard-step">
                    <h2>1.3 Adversaire</h2>
                    <label for="nom_adversaire">Nom/Prénom :</label><input type="text" id="nom_adversaire">
                    <label for="domicile_adversaire">Domicile :</label><textarea id="domicile_adversaire" rows="2"></textarea>
                    <div class="dynamic-list-item"><input type="date" id="date_naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
                    <label for="signes_particuliers">Signes particuliers :</label><input type="text" id="signes_particuliers">
                    <label>Attitude (connue) :</label><textarea id="attitude_adversaire" rows="2"></textarea>
                    <label>Armes connues :</label><input type="text" id="armes_connues">
                </div>
                
                <div class="wizard-step">
                    <h2>1.4 Environnement</h2>
                     <label>Ami(e)s (Unités en soutien) :</label><input type="text" id="amies">
                     <label>Terrain / Météo :</label><input type="text" id="terrain_info">
                     <label>Population :</label><input type="text" id="population">
                     <label>Cadre juridique :</label><input type="text" id="cadre_juridique">
                </div>

                <div class="wizard-step">
                    <h2>2. Mission du PSIG</h2>
                    <textarea id="missions_psig" rows="8"></textarea>
                </div>

                <div class="wizard-step">
                     <h2>3. Exécution</h2>
                     <label>Phrase d'action (Je veux...) :</label><input type="text" id="phrase_action">
                     <label>Action en force / souplesse :</label><input type="text" id="type_action">
                     <h3>Chronologie</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">➕</button>
                     <h3>Hypothèses</h3>
                     <label>H1 (Target présente LE1):</label><input type="text" id="hypothese_h1">
                     <label>H2 (Target présente LE2):</label><input type="text" id="hypothese_h2">
                     <label>H3 (Target absente):</label><input type="text" id="hypothese_h3">
                </div>

                <div class="wizard-step">
                     <h2>4. Articulation</h2>
                     <label>Place du Chef :</label><input type="text" id="place_chef">
                     <h3>Équipe Appui - Observation</h3>
                     <label>Composition :</label><input type="text" id="equipe_ao_composition">
                     <label>Mission :</label><input type="text" id="equipe_ao_mission">
                     <h3>Équipe INDIA</h3>
                     <label>Composition :</label><input type="text" id="equipe_india_composition">
                     <label>Mission :</label><input type="text" id="equipe_india_mission">
                </div>
                
                <div class="wizard-step">
                    <h2>5. PATRACDVR</h2>
                    <div id="patracdvr_container"></div>
                    <button type="button" class="add-btn" style="width:100%;" onclick="addPatracdvrRow()">Ajouter un véhicule ➕</button>
                </div>

                <div class="wizard-step">
                    <h2>Photos</h2>
                    <p>Chargez les photos pour les pages correspondantes du PDF.</p>
                    <div class="form-section">
                        <label>Photo: Transport PSIG vers PR</label><input id="photo_transport_pr" type="file" class="photo-input">
                        <label>Photo: Transport PR vers Domicile</label><input id="photo_transport_domicile" type="file" class="photo-input">
                        <label>Photo: Emplacement AO 1&2</label><input id="photo_emplacement_ao" type="file" class="photo-input">
                        <label>Photo: Itinéraire Extérieur India</label><input id="photo_itineraire_exterieur" type="file" class="photo-input">
                        <label>Photo: Itinéraire Intérieur India</label><input id="photo_itineraire_interieur" type="file" class="photo-input">
                        <label>Photo: Cellule Effraction</label><input id="photo_cellule_effraction" type="file" class="photo-input">
                    </div>
                </div>
                
                <div class="wizard-step">
                    <h2>Finalisation</h2>
                    <p style="text-align:center; margin-top:30px; color: var(--text-secondary);">Tous les champs sont remplis. Vous pouvez maintenant générer le document.</p>
                </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button" onclick="changeStep(-1)">Précédent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button" onclick="changeStep(1)">Suivant</button>
            <button class="wizard-nav-btn" id="generatePdfBtn" type="button" style="display:none;">Générer le PDF 📄</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script>
        // --- GESTION DU WIZARD ET DU FORMULAIRE (STABLE) ---
        let currentStep = 0;
        const steps = document.querySelectorAll(".wizard-step");
        const progressSteps = document.querySelectorAll(".wizard-progress-step");
        function showStep(n) { /* ... inchangé ... */ }
        function changeStep(n) { /* ... inchangé ... */ }
        function saveFormData() { /* ... inchangé ... */ }
        function loadFormData() { /* ... inchangé ... */ }
        function addTimeEvent() { /* ... inchangé ... */ }
        function addPatracdvrRow() { /* ... inchangé ... */ }
        // ... (Toutes les fonctions de gestion du formulaire sont ici, inchangées)

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const body = document.body;
            body.classList.toggle('light-mode');
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                document.getElementById('darkModeIcon').textContent = 'clear_day';
            } else {
                 document.body.classList.remove('light-mode');
                 document.body.classList.add('dark-mode');
                 document.getElementById('darkModeIcon').textContent = 'nightlight';
            }
            showStep(currentStep);
            loadFormData();
        });
        
        // --- IMPLEMENTATION PDF PDF-LIB (TEMPLATE FIXE) ---

        async function buildPdf() {
            const { PDFDocument, StandardFonts, rgb, PageSizes } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            saveFormData();
            const formDataString = localStorage.getItem('oiFormData');
            if (!formDataString) { alert("Aucune donnée à générer."); return null; }
            const formData = JSON.parse(formDataString);
            const getVal = (id) => formData[id] || '';

            const context = {
                pdfDoc, helveticaFont, helveticaBoldFont,
                currentPage: null, y: 0,
                pageWidth: 0, pageHeight: 0, margin: 40,
                colors: {
                    background: rgb(30/255, 30/255, 30/255),
                    text: rgb(1, 1, 1),
                    accent: rgb(91/255, 155/255, 213/255),
                }
            };

            const addNewPage = (orientation = 'portrait') => {
                const pageSize = orientation === 'landscape' ? [PageSizes.A4[1], PageSizes.A4[0]] : PageSizes.A4;
                context.currentPage = context.pdfDoc.addPage(pageSize);
                const { width, height } = context.currentPage.getSize();
                context.pageWidth = width; context.pageHeight = height;
                context.y = height - context.margin;
                context.currentPage.drawRectangle({ x: 0, y: 0, width, height, color: context.colors.background });
            };

            const drawText = (text, options) => {
                const { font = helveticaFont, size = 12, color = context.colors.text, x = context.margin, y = context.y, maxWidth } = options;
                const lines = wrapText(text, font, size, maxWidth || context.pageWidth - context.margin * 2 - (x - context.margin));
                lines.forEach(line => {
                    context.currentPage.drawText(line, { x, y: context.y, font, size, color });
                    context.y -= (size + 4);
                });
            };

            const wrapText = (text, font, size, maxWidth) => { /* ... inchangé ... */ };
            
            const drawImagePage = async (inputId, title) => {
                const input = document.getElementById(inputId);
                if (!input || input.files.length === 0) return;
                
                addNewPage('landscape');
                const file = input.files[0];
                const imageBytes = await file.arrayBuffer();
                const image = await (file.type === 'image/jpeg' ? pdfDoc.embedJpg(imageBytes) : pdfDoc.embedPng(imageBytes));
                
                const pageW = context.pageWidth; const pageH = context.pageHeight;
                const paddedW = pageW - context.margin * 2; const paddedH = pageH - context.margin * 2;
                const scaled = image.scaleToFit(paddedW, paddedH);
                
                const x = (pageW - scaled.width) / 2;
                const y = (pageH - scaled.height) / 2;
                
                context.currentPage.drawImage(image, { x, y, width: scaled.width, height: scaled.height });
                drawText(title, { x: context.margin, y: context.margin - 15, size: 14, font: helveticaBoldFont });
            };

            // --- Construction du PDF (selon le template) ---

            // Page 1: Titre
            addNewPage('portrait');
            drawText(`OPÉRATION DE POLICE JUDICIAIRE DU ${getVal('date_op') || '(DATE)'}`, { 
                x: context.pageWidth / 2 - 200, y: context.pageHeight / 2, size: 24, font: helveticaBoldFont 
            });

            // Page 2: Situation
            addNewPage('portrait');
            drawText("1/ SITUATION", { size: 18, font: helveticaBoldFont });
            context.y -= 20;
            drawText("11/ Générale :", { size: 14, font: helveticaBoldFont });
            drawText(getVal('situation_generale'), { size: 12, x: context.margin + 15 });
            context.y -= 20;
            drawText("12/ Particulière :", { size: 14, font: helveticaBoldFont });
            drawText(getVal('situation_particuliere'), { size: 12, x: context.margin + 15 });

            // Page 3: Adversaire
            addNewPage('portrait');
            drawText("13/ Adversaire(s)", { size: 18, font: helveticaBoldFont });
            context.y -= 15;
            drawText(`Nom/Prénom: ${getVal('nom_adversaire')}`, { size: 12 });
            drawText(`Domicile: ${getVal('domicile_adversaire')}`, { size: 12 });
            drawText(`Date/Lieu de naissance: ${getVal('date_naissance')} à ${getVal('lieu_naissance')}`, { size: 12 });
            drawText(`Signes particuliers: ${getVal('signes_particuliers')}`, { size: 12 });
            drawText(`Attitude: ${getVal('attitude_adversaire')}`, { size: 12 });
            drawText(`Armes: ${getVal('armes_connues')}`, { size: 12 });

            // Page 4: Environnement
            addNewPage('portrait');
            drawText(`14/ Ami(e)s: ${getVal('amies')}`, { size: 12, font: helveticaBoldFont });
            drawText(`15/ Terrain / Environnement: ${getVal('terrain_info')}`, { size: 12, font: helveticaBoldFont });
            drawText(`16/ Population: ${getVal('population')}`, { size: 12, font: helveticaBoldFont });
            drawText(`17/ Cadre juridique: ${getVal('cadre_juridique')}`, { size: 12, font: helveticaBoldFont });

            // Page 5: Missions & Exécution
            addNewPage('portrait');
            drawText("2/ MISSIONS du PSIG", { size: 18, font: helveticaBoldFont });
            drawText(getVal('missions_psig'), { size: 12, x: context.margin + 15 });
            context.y -= 20;
            drawText("3/ EXÉCUTION", { size: 18, font: helveticaBoldFont });
            drawText(`Je veux, le ${getVal('date_op')} à partir 06H00, pour une action ${getVal('type_action')}, investir le domicile...`, { size: 12, x: context.margin + 15 });
            context.y -= 15;
            (formData.time_events || []).forEach(e => {
                drawText(`- ${e.type} (${e.hour || 'N/A'}): ${e.description || 'N/A'}`, { size: 12, x: context.margin + 15 });
            });
            context.y -= 15;
            drawText(`H1 (Target présente LE1): ${getVal('hypothese_h1')}`, { size: 12, x: context.margin + 15 });
            drawText(`H2 (Target présente LE2): ${getVal('hypothese_h2')}`, { size: 12, x: context.margin + 15 });
            drawText(`H3 (Target absente): ${getVal('hypothese_h3')}`, { size: 12, x: context.margin + 15 });

            // Page 6: Articulation
            addNewPage('portrait');
            drawText("ARTICULATION", { size: 18, font: helveticaBoldFont });
            context.y -= 15;
            drawText("ÉQUIPE Appui - Observation", { size: 14, font: helveticaBoldFont });
            drawText(`Composition: ${getVal('equipe_ao_composition')}`, { size: 12, x: context.margin + 15 });
            drawText(`Mission: ${getVal('equipe_ao_mission')}`, { size: 12, x: context.margin + 15 });
            context.y -= 15;
            drawText("ÉQUIPE INDIA", { size: 14, font: helveticaBoldFont });
            drawText(`Composition: ${getVal('equipe_india_composition')}`, { size: 12, x: context.margin + 15 });
            drawText(`Mission: ${getVal('equipe_india_mission')}`, { size: 12, x: context.margin + 15 });
            context.y -= 20;
            drawText(`Place du Chef: ${getVal('place_chef')}`, { size: 14, font: helveticaBoldFont });

            // Page 7: PATRACDVR
            addNewPage('portrait');
            drawText("REPARTITION PATRACDVR", { size: 18, font: helveticaBoldFont });
            context.y -= 15;
            (formData.patracdvr_rows || []).forEach(row => {
                drawText(`Véhicule: ${row.vehicle}`, { size: 14, font: helveticaBoldFont });
                 (row.members || []).forEach(m => {
                    if(m.trigramme) drawText(`- ${m.trigramme} (${m.fonction} / ${m.equipement})`, { size: 12, x: context.margin + 15 });
                });
                context.y -= 10;
            });
            
            // Pages Photos
            await drawImagePage('photo_transport_pr', 'Transport PSIG vers PR');
            await drawImagePage('photo_transport_domicile', 'Transport PR vers domicile target');
            await drawImagePage('photo_emplacement_ao', 'Emplacement AO 1&2');
            await drawImagePage('photo_itineraire_exterieur', 'Itinéraire exterieur India');
            await drawImagePage('photo_itineraire_interieur', 'Itinéraire interieur India');
            await drawImagePage('photo_cellule_effraction', 'Cellule effraction India');

            // Page Finale
            addNewPage('portrait');
            const finalText = "Avez-vous des questions?";
            const finalTextWidth = helveticaBoldFont.widthOfTextAtSize(finalText, 36);
            context.currentPage.drawText(finalText, { x: context.pageWidth / 2 - finalTextWidth / 2, y: context.pageHeight / 2, font: helveticaBoldFont, size: 36, color: context.colors.accent });

            const pdfBytes = await pdfDoc.save();
            return { pdfBytes, formData };
        }

        document.getElementById('generatePdfBtn').addEventListener('click', async () => { /* ... inchangé ... */ });
    </script>
</body>
</html>
