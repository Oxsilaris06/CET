<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF--8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>G√©n√©rateur d'OI</title><link rel="icon" href="favicon.ico" sizes="any" type="image/png"><link rel="icon" href="favicon.ico" type="image/svg+xml"><link rel="apple-touch-icon" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root { --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a; --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444; --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b; --success-green: #27ae60; }
        body.light-mode { --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa; --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0; --border-color: #dee2e6; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 10px; padding-bottom: 90px; transition: background-color 0.3s, color 0.3s; }
        .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h1 { font-size: 1.8em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
        h2 { font-size: 1.4em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
        h3 { font-size: 1.1em; color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; }
        h4 { font-size: 1.0em; color: var(--text-secondary); margin-top: 10px; margin-bottom: 5px; }
        .wizard-progress { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-bottom: 25px; list-style-type: none; padding: 0; }
        .wizard-progress-step { flex-grow: 1; padding: 8px 6px; text-align: center; font-size: 0.7em; color: var(--text-secondary); background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; min-width: 50px; }
        @media (min-width: 600px) { .wizard-progress-step { font-size: 0.85em; padding: 8px 12px; } }
        .wizard-progress-step:hover { background-color: var(--bg-body); }
        .wizard-progress-step.completed { border-color: var(--accent-blue); color: var(--accent-blue); }
        .wizard-progress-step.active { color: white; background-color: var(--accent-blue); border-color: var(--accent-blue); font-weight: 500; }
        .wizard-step { display: none; animation: fadeIn 0.5s; }
        .wizard-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .wizard-nav { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; gap: 10px; }
        .wizard-nav-btn { flex-grow: 1; padding: 14px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; min-height: 48px;}
        #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #nextBtn { background-color: var(--accent-blue); color: white; }
        #previewBtn { background-color: #6c757d; color: white; }
        #retexReportBtn { background-color: #008080; color: white; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
        input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1.1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; min-height: 48px;}
        textarea { min-height: 120px; }
        .dynamic-list-item { display: flex; flex-direction: column; align-items: stretch; gap: 10px; margin-bottom: 10px; }
        .dynamic-list-item > *:not(button) { flex-grow: 1; margin-bottom: 0; min-height: 48px; }
        @media (min-width: 480px) { .wizard-step .dynamic-list-item:has(#date_naissance) { flex-direction: row; } .wizard-step .dynamic-list-item:has(#date_naissance) input { width: auto; } }
        button.add-btn, button.remove-btn { min-height: 44px; }
        button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
        button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; padding: 5px 0; border-bottom: 1px dashed var(--border-color); }
        .chip-btn { background-color: var(--bg-interactive); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-family: 'Oswald', sans-serif; font-size: 0.9em; flex-shrink: 0; }
        .chip-btn.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .chip-btn:hover:not(.selected) { background-color: var(--bg-body); }
        .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; }
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 15px; }
        .collapsible-header h3 { margin: 0; font-size: 1.2em; }
        .collapsible-header .material-symbols-outlined { transition: transform 0.3s; }
        .collapsible-container.open .collapsible-header .material-symbols-outlined { transform: rotate(180deg); }
        .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .collapsible-container.open .collapsible-content { max-height: 4000px; padding-top: 10px; padding-bottom: 15px; }
        .articulation-composition-display p { margin-bottom: 5px; }
        .articulation-composition-display strong { color: var(--accent-blue); }
        .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
        .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
        .dock-menu-item:hover { transform: scale(1.1); }
        .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; border: none; background-color: transparent; }
        .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
        #dockToggleBtn .material-symbols-outlined { transition: transform 0.3s ease; }
        .dock-menu.collapsed #dockToggleBtn .material-symbols-outlined { transform: rotate(180deg); }
        .photo-input, #sessionFileInput, #jsonConfigInput { display: none; }
        .file-upload-label { background-color: var(--accent-blue); color: white !important; padding: 10px 14px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-family: 'Oswald', sans-serif; font-weight: normal; display: inline-block; text-align: center; flex-shrink: 0; }
        .file-upload-label:hover { background-color: var(--accent-hover); }
        .file-name-display { color: var(--text-secondary); font-style: italic; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .image-preview { max-width: 150px; max-height: 100px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); }
        .draggable { cursor: grab; user-select: none; }
        .draggable.dragging { opacity: 0.5; cursor: grabbing; }
        #patracdvr_container, #unassigned_members_container { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; min-height: 70px; border: 1px dashed var(--border-color); border-radius: 5px; align-content: flex-start; }
        .patracdvr-members-container, #unassigned_members_container { transition: border-color 0.2s; }
        .patracdvr-member-btn { background-color: var(--bg-body); border: 2px solid var(--border-color); color: var(--text-primary); padding: 8px 12px; border-radius: 5px; text-align: center; font-family: 'Oswald', sans-serif; cursor: pointer; transition: all 0.2s; min-height: 56px; display: flex; flex-direction: column; justify-content: center; }
        .patracdvr-member-btn:hover { border-color: var(--accent-hover); }
        .patracdvr-member-btn.member-active { border-color: var(--accent-blue); box-shadow: 0 0 8px var(--accent-blue); }
        .patracdvr-member-btn .trigramme { font-weight: bold; }
        .patracdvr-member-btn .fonction { font-size: 0.8em; color: var(--text-secondary); display: block; }
        .patracdvr-vehicle-row { position: relative; display: flex; flex-direction: column; gap: 8px; padding: 8px; padding-top: 28px; border: 1px solid var(--border-color); background-color: var(--bg-body); border-radius: 5px; min-height: 56px; min-width: 100px; width: auto; align-items: flex-start; justify-content: flex-start; }
        .patracdvr-vehicle-row .patracdvr-members-container { border: 1px dashed var(--border-color); border-radius: 4px; min-height: 40px; width: 100%; padding: 5px; display: flex; flex-wrap: wrap; gap: 5px; align-content: flex-start; }
        .vehicle-header { position: absolute; top: 4px; left: 8px; right: 8px; display: flex; justify-content: space-between; align-items: center; }
        .vehicle-name { font-size: 0.9em; font-weight: bold; color: var(--accent-blue); }
        .vehicle-header .remove-btn { padding: 2px 5px; min-height: unset; font-size: 12px; }
        #vehicle_creation_buttons { display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 5px; }
        .add-vehicle-btn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #editMemberModal, #quickEditModal, #settingsModal { color: var(--text-primary); background: var(--bg-container); width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; margin: 0; border: none; border-radius: 0; padding: 15px; }
        #editMemberModal::backdrop, #quickEditModal::backdrop, #settingsModal::backdrop { background: rgba(0, 0, 0, 0.85); }
        #editMemberModal #editMemberForm, #quickEditModal .modal-form, #settingsModal .modal-form { display: flex; flex-direction: column; height: 100%; }
        #editMemberModal .modal-content, #quickEditModal .modal-content, #settingsModal .modal-content { flex: 1 1 auto; overflow-y: auto; padding: 0 5px; }
        #editMemberModal .modal-actions, #quickEditModal .modal-actions, #settingsModal .modal-actions { flex-shrink: 0; display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        #editMemberModal .modal-actions button, #quickEditModal .modal-actions button, #settingsModal .modal-actions button { flex: 1; }
        #modal_cancelBtn, #quick_modal_closeBtn, #settings_closeBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
        #modal_deleteBtn { background-color: var(--danger-red); color: white; }
        #settings_saveBtn { background-color: var(--success-green); color: white; }
        #quickEditPanel { display: none; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 20px; background-color: var(--bg-body); }
        #quickEditPanel h4 { margin-top: 0; }
        #quickEditPanel h4 #selectedMemberTrigramme { color: var(--accent-blue); }
        .quick-edit-content .quick-edit-tab-panel { display: none; }
        .quick-edit-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .quick-edit-btn { background-color: var(--bg-interactive); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 0.9em; transition: all 0.2s; }
        .quick-edit-btn:hover { border-color: var(--accent-hover); color: var(--text-primary); }
        .quick-edit-btn.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        #quickEditModal .quick-edit-category { margin-bottom: 20px; }
        #quickEditModal .quick-edit-category h5 { font-size: 1.1em; color: var(--text-secondary); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        #annotationModal { width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; background: var(--bg-container); color: var(--text-primary); border: none; border-radius: 0; padding: 0; overflow: hidden; }
        #annotationModal::backdrop { background: rgba(0,0,0,0.85); }
        .annotation-wrapper { display: flex; flex-direction: column; height: 100%; }
        .annotation-toolbar { order: 2; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: var(--bg-body); border-top: 1px solid var(--border-color); flex-shrink: 0; }
        .toolbar-main-tools, .toolbar-contextual-tools { display: flex; flex-wrap: nowrap; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .toolbar-main-tools::-webkit-scrollbar, .toolbar-contextual-tools::-webkit-scrollbar { height: 4px; }
        .toolbar-main-tools::-webkit-scrollbar-thumb, .toolbar-contextual-tools::-webkit-scrollbar-thumb { background: var(--border-color); }
        .tool-btn { padding: 10px; font-family: 'Oswald', sans-serif; border: 1px solid var(--border-color); background: var(--bg-interactive); color: var(--text-primary); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 4px; flex-shrink: 0; min-width: 80px; }
        .tool-btn .material-symbols-outlined { font-size: 28px; }
        .tool-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        .tool-controls, #contextual_tools { display: none; }
        .tool-controls.active, #contextual_tools.active { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 4px; overflow-x: auto; max-width: 100%; }
        .tool-controls label { margin-bottom: 0; }
        .tool-controls input { margin-bottom: 0; padding: 8px; max-width: 150px; }
        #edit_text_btn { display: none; }
        #contextual_tools.active.location-selected #edit_text_btn { display: flex; }
        .annotation-actions { display: flex; justify-content: space-around; gap: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); margin-top: 10px;}
        .annotation-actions button { flex: 1; justify-content: center; }
        .annotation-canvas-container { order: 1; flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; padding: 5px; overflow: auto; min-height: 0; }
        #annotationCanvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        .retex-section { display: flex; flex-direction: column; border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; margin-top: 20px; }
        .retex-actions { display: flex; gap: 10px; margin-top: 15px; }
        .retex-status { margin-top: 10px; font-style: italic; color: var(--text-secondary); }
        .retex-output-content { border: 1px dashed var(--border-color); padding: 15px; border-radius: 5px; margin-top: 20px; min-height: 200px; white-space: pre-wrap; font-family: monospace; overflow-x: auto; }
        .retex-output-content h3 { color: var(--accent-blue); }
        .retex-output-content h4 { color: var(--accent-blue); border-bottom: 1px solid var(--border-color); margin-top: 10px; }
        .retex-output-content ul { list-style-type: disc; padding-left: 20px; }
        .retex-output-content p, .retex-output-content li { margin-bottom: 5px; }
        #presentationModal { width: 95vw; max-width: 1200px; height: 95vh; background: var(--bg-body); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 20px; overflow: hidden; }
        #presentationModal::backdrop { background: rgba(0, 0, 0, 0.85); }
        #presentation-content { height: calc(100% - 60px); overflow-y: auto; padding-right: 15px; }
        #presentation-content h2 { color: var(--accent-blue); font-size: 1.8em; border-bottom: 2px solid var(--accent-blue); padding-bottom: 5px; }
        #presentation-content h3 { color: var(--accent-blue); font-size: 1.3em; margin-top: 15px; margin-bottom: 10px; }
        #presentation-content p { margin-bottom: 8px; padding-left: 15px; }
        #presentation-content strong { color: var(--danger-red); }
        #presentation-content table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 20px; }
        #presentation-content th { background-color: var(--accent-blue); color: white; padding: 10px; border: 1px solid var(--text-primary); text-align: left; }
        #presentation-content td { padding: 10px; border: 1px solid var(--text-secondary); vertical-align: top; background-color: var(--bg-interactive); }
        #presentation-content img { max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        #presentation-content .image-container { text-align: center; margin: 20px 0; border: 1px solid var(--accent-blue); padding: 10px; background-color: var(--bg-container); }
        .modal-actions-pdf { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; flex-shrink: 0; }
        .modal-actions-pdf button { width: auto; }
        .modal-actions-pdf #downloadPdfBtn { flex: 1; max-width: 250px; background-color: var(--success-green); }
        .coherence-alert { background-color: #331f1f; color: #c0392b; border: 1px solid #c0392b; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; }
        .coherence-alert .material-symbols-outlined { margin-right: 10px; font-size: 24px; }
        @media (min-width: 768px) { body { padding: 15px; padding-bottom: 80px; } .dynamic-list-item { flex-direction: row; } #editMemberModal, #quickEditModal, #settingsModal { width: 90%; max-width: 500px; height: auto; max-height: 90vh; margin: auto; border: 1px solid var(--border-color); border-radius: 8px; } #quickEditPanel { display: block; } .wizard-nav { flex-wrap: nowrap; } .wizard-nav-btn { width: auto; margin-top: 0; } #annotationModal { width: 95vw; max-width: 1400px; height: 95vh; border: 1px solid var(--border-color); border-radius: 8px;} .annotation-wrapper { flex-direction: row; } .annotation-toolbar { order: 1; flex-direction: column; width: 250px; border-top: none; border-right: 1px solid var(--border-color); } .toolbar-main-tools, .toolbar-contextual-tools { flex-direction: column; overflow-x: hidden; } .tool-btn { flex-direction: row; justify-content: flex-start; min-width: unset; } .tool-controls.active, #contextual_tools.active { overflow-x: hidden; max-width: none; } .annotation-actions { flex-direction: column; margin-top: auto; padding-top: 20px; } .annotation-actions button { justify-content: flex-start; } .annotation-canvas-container { order: 2; padding: 10px; } .quick-edit-tabs { display: none; } .quick-edit-content .quick-edit-tab-panel.active { display: block !important; } .quick-edit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } .quick-edit-content h5 { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; } }
        .tutorial-popup { position: absolute; background: var(--bg-container); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.35); z-index: 1001; width: 300px; display: none; flex-direction: column; gap: 10px; }
        .tutorial-popup p { margin-bottom: 0; }
        .tutorial-popup button { background-color: var(--accent-blue); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-family: 'Oswald', sans-serif; text-transform: uppercase; }
        .tutorial-popup .close-btn { position: absolute; top: 5px; right: 10px; font-size: 20px; cursor: pointer; color: var(--text-secondary); }
        .highlight-element { box-shadow: 0 0 0 5px var(--accent-blue) !important; transition: box-shadow 0.3s ease-in-out; position: relative; z-index: 1002; }
        @media (max-width: 600px) { .dock-menu:not(.collapsed) { width: 95%; padding: 5px; gap: 5px; justify-content: center; display: flex; flex-wrap: wrap; } .dock-menu:not(.collapsed) .dock-menu-item { width: 45px; height: 45px; font-size: 24px; } }
    </style>
</head>
<body class="dark-mode">

    <dialog id="presentationModal">
        <div id="presentation-content"></div>
        <div class="modal-actions-pdf">
            <button id="downloadPdfBtn" type="button" class="wizard-nav-btn">T√©l√©charger le PDF üìÑ</button>
            <button id="closePresentationModalBtn" type="button" class="wizard-nav-btn" style="background-color: var(--danger-red); color: white;">Fermer</button>
        </div>
    </dialog>
    <div class="dock-menu" id="dockMenu">
        <div class="dock-menu-item" id="dockToggleBtn" title="R√©duire"><span class="material-symbols-outlined">expand_more</span></div>
        <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-symbols-outlined">home</span></a>
        <div class="dock-menu-item" id="importSessionBtn" title="Importer une session"><span class="material-symbols-outlined">file_upload</span></div>
        <div class="dock-menu-item" id="exportSessionBtn" title="Exporter la session"><span class="material-symbols-outlined">file_download</span></div>
        <div class="dock-menu-item" id="settingsBtn" title="Param√®tres"><span class="material-symbols-outlined">settings</span></div>
        <div class="dock-menu-item" id="darkModeToggle" title="Changer le th√®me"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
        <div class="dock-menu-item" id="resetBtn" title="R√©initialiser le formulaire"><span class="material-symbols-outlined">refresh</span></div>
        <div class="dock-menu-item" id="tutorialBtn" title="Lancer le tutoriel"><span class="material-symbols-outlined">school</span></div>
    </div>
    <input type="file" id="sessionFileInput" accept=".json" />
    <input type="file" id="jsonConfigInput" accept=".json"/>
    <dialog id="settingsModal">
        <div class="modal-form">
            <h3>Param√®tres de l'application</h3>
            <div class="modal-content">
                <h4>Cl√© API Google Gemini</h4>
                <p>Pour l'analyse des rapports RETEX, vous devez fournir une cl√© API personnelle de Google Gemini. L'analyse est effectu√©e directement depuis votre navigateur.</p>
                <label for="geminiApiKey">Cl√© API:</label>
                <input type="password" id="geminiApiKey" placeholder="Saisissez votre cl√© d'API">
                <p style="margin-top: 15px;">**Note Importante:** Apr√®s la sauvegarde, votre cl√© sera stock√©e **uniquement dans votre navigateur** pour des raisons de s√©curit√© et de confidentialit√©.</p>
            </div>
            <div class="modal-actions">
                <button type="button" id="settings_closeBtn">Fermer</button>
                <button type="button" id="settings_saveBtn">Sauvegarder</button>
            </div>
        </div>
    </dialog>

    <div id="tutorial-popup" class="tutorial-popup">
        <span class="close-btn">&times;</span>
        <p id="popup-text"></p>
        <button id="next-popup-btn">Suivant</button>
    </div>

    <dialog id="editMemberModal">
        <form id="editMemberForm" onsubmit="return false;">
            <h3>√âditer le membre</h3>
            <div class="modal-content">
                <label for="modal_trigramme">Trigramme:</label><input type="text" id="modal_trigramme" placeholder="Trigramme">
                <label for="modal_fonction">Fonction:</label><select id="modal_fonction"></select>
                <label for="modal_cellule">Cellule:</label><select id="modal_cellule"></select>
                <label for="modal_armement">Armement:</label><select id="modal_armement"></select>
                <label for="modal_equipement">√âquipement 1:</label><select id="modal_equipement"></select>
                <label for="modal_equipement2">√âquipement 2:</label><select id="modal_equipement2"></select>
                <label for="modal_tenue">Tenue:</label><select id="modal_tenue"></select>
                <label for="modal_gpb">GPB:</label><select id="modal_gpb"></select>
            </div>
            <div class="modal-actions">
                <button type="button" id="modal_deleteBtn" class="remove-btn">Renvoyer en Attente</button>
                <button type="button" id="modal_cancelBtn">Annuler</button>
                <button type="submit" id="modal_saveBtn" class="add-btn">Sauvegarder</button>
            </div>
        </form>
    </dialog>

    <dialog id="quickEditModal">
        <div class="modal-form">
            <h3 id="quick_modal_title">√âdition rapide</h3>
            <div id="quick_modal_content" class="modal-content"></div>
            <div class="modal-actions">
                <button type="button" id="quick_modal_closeBtn">Fermer</button>
            </div>
        </div>
    </dialog>

    <dialog id="annotationModal">
        <div class="annotation-wrapper">
            <div class="annotation-toolbar">
                 <div id="contextual_tools">
                     <div class="toolbar-contextual-tools">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                            <label for="rotation_input" style="font-size: 0.8em; margin:0;">Rotation (Degr√©s)</label>
                            <input type="number" id="rotation_input" min="0" max="360" step="1" value="0" style="max-width: 80px; text-align: center; padding: 5px; height: 35px; margin: 0;" onchange="updateAnnotationRotation()">
                        </div>
                        <button id="edit_text_btn" class="tool-btn"><span class="material-symbols-outlined">edit</span>Texte</button>
                         <button id="delete_btn" class="tool-btn" style="background-color: var(--danger-red); color: white;"><span class="material-symbols-outlined">delete</span>Supprimer</button>
                     </div>
                 </div>
                 <div class="toolbar-main-tools">
                     <button id="tool_move" class="tool-btn active"><span class="material-symbols-outlined">open_with</span>D√©placer</button>
                     <button id="tool_location" class="tool-btn"><span class="material-symbols-outlined">place</span>Emplacement</button>
                     <button id="tool_arrow" class="tool-btn"><span class="material-symbols-outlined">arrow_right_alt</span>D√©signer</button>
                     <button id="tool_box" class="tool-btn"><span class="material-symbols-outlined">crop_square</span>Encadrer</button>
                 </div>
                 <div id="controls_location" class="tool-controls">
                     <label for="circle_text">Texte:</label><input type="text" id="circle_text" value="Zone">
                     <label for="circle_opacity">Transparence:</label><input type="range" id="circle_opacity" min="0.1" max="1" step="0.1" value="0.5">
                 </div>
                 <div id="controls_arrow" class="tool-controls">
                     <label for="arrow_thickness">√âpaisseur:</label><input type="range" id="arrow_thickness" min="1" max="25" step="1" value="5">
                 </div>
                 <div id="controls_box" class="tool-controls">
                     <label for="box_thickness">√âpaisseur:</label><input type="range" id="box_thickness" min="1" max="20" step="1" value="5">
                 </div>
                 <div class="annotation-actions">
                     <button id="tool_reset" class="tool-btn"><span class="material-symbols-outlined">delete_sweep</span>Effacer tout</button>
                     <button id="annotation_cancel" class="tool-btn">Annuler</button>
                     <button id="annotation_save" class="tool-btn" style="background-color: #27ae60; color: white;"><span class="material-symbols-outlined">save</span>Sauvegarder</button>
                 </div>
            </div>
            <div class="annotation-canvas-container">
                <canvas id="annotationCanvas"></canvas>
            </div>
        </div>
    </dialog>

    <div class="container">
        <h1>G√©n√©rateur d'OI</h1>
        <ul class="wizard-progress">
            <li class="wizard-progress-step" onclick="goToStep(0)">1. Situation</li>
            <li class="wizard-progress-step" onclick="goToStep(1)">2. Adversaire</li>
            <li class="wizard-progress-step" onclick="goToStep(2)">3. Environnement</li>
            <li class="wizard-progress-step" onclick="goToStep(3)">4. Mission</li>
            <li class="wizard-progress-step" onclick="goToStep(4)">5. Ex√©cution</li>
            <li class="wizard-progress-step" onclick="goToStep(5)">6. Articulation</li>
            <li class="wizard-progress-step" onclick="goToStep(6)">7. PATRACDVR</li>
            <li class="wizard-progress-step" onclick="goToStep(7)">8. Photos</li>
            <li class="wizard-progress-step" onclick="goToStep(8)">9. CAT</li>
            <li class="wizard-progress-step" onclick="goToStep(9)">10. Finalisation</li>
        </ul>

        <form id="oi-form">
            <div class="wizard-content">
                <div class="wizard-step">
                    <h2>1. Situation</h2>
                    <label for="date_op">Date de l'op√©ration:</label><input type="date" id="date_op">
                    <label for="situation_generale">1.1 G√©n√©rale:</label><textarea id="situation_generale"></textarea>
                    <label for="situation_particuliere">1.2 Particuli√®re:</label><textarea id="situation_particuliere"></textarea>
                </div>

                <div class="wizard-step">
                    <h2>2. Adversaire</h2>
                    <label>Photo principale de l'adversaire:</label>
                    <div id="adversary_photo_container"></div>
                    <label for="nom_adversaire">Nom/Pr√©nom:</label><input type="text" id="nom_adversaire">
                    <label for="domicile_adversaire">Domicile:</label><textarea id="domicile_adversaire" rows="2"></textarea>
                    <label>Moyens Employ√©s (ME):</label><div id="me_container"></div><button type="button" class="add-btn" onclick="addMeField()">‚ûï ME</button>
                    <h3>Informations TO</h3>
                    <h4>Date et lieu de naissance:</h4>
                    <div class="dynamic-list-item"><input type="date" id="date_naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
                    <div class="dynamic-list-item"><input type="text" id="stature_adversaire" placeholder="Stature"><select id="ethnie_adversaire"><option>Caucasien</option><option>Nord africain</option><option>Afro-antillais</option><option>Asiatique</option></select></div>
                    <label for="signes_particuliers">Signes particuliers:</label><input type="text" id="signes_particuliers">
                    <label for="profession_adversaire">Profession:</label><input type="text" id="profession_adversaire">
                    <label for="antecedents_adversaire">Ant√©c√©dents:</label><textarea id="antecedents_adversaire" rows="2"></textarea>
                    <label>√âtat d'esprit:</label>
                    <div id="etat_esprit_container" class="chip-container" data-options='["Serein", "Hostile", "Conciliant", "Sur ses gardes"]'></div>
                    <label for="attitude_adversaire">Attitude (connue):</label><textarea id="attitude_adversaire" rows="2"></textarea>
                    <label>Volume (renfort potentiel):</label>
                    <div id="volume_adversaire_container" class="chip-container" data-options='["Seul", "Famille", "BO", "Conjointe", "2-3", "4+"]'></div>
                    <h3>Photos des renforts potentiels</h3>
                    <div id="renforts_photo_container"></div>
                    <button type="button" class="add-btn" onclick="addPhotoInput('renforts_photo_container')">Ajouter Photo Renfort ‚ûï</button>
                    <h3 style="margin-top: 20px;">Photos suppl√©mentaires de l'adversaire</h3>
                    <div id="adversary_extra_photos_container"></div>
                    <button type="button" class="add-btn" onclick="addPhotoInput('adversary_extra_photos_container')">Ajouter Photo Adversaire ‚ûï</button>
                    <label for="substances_adversaire">Substances:</label><input type="text" id="substances_adversaire">
                    <label>V√©hicules:</label><div id="vehicules_container"></div><button type="button" class="add-btn" onclick="addDynamicField('vehicules_container')">‚ûï</button>
                    <label for="armes_connues">Armes connues:</label><input type="text" id="armes_connues">
                </div>

                <div class="wizard-step">
                    <h2>3. Environnement</h2>
                     <label>Ami(e)s (Unit√©s en soutien):</label><input type="text" id="amies">
                     <label>Terrain / M√©t√©o:</label><input type="text" id="terrain_info">
                     <label>Population:</label><input type="text" id="population">
                     <label for="cadre_juridique">Cadre juridique:</label><input type="text" id="cadre_juridique">
                </div>

                <div class="wizard-step">
                    <h2>4. Mission du PSIG</h2>
                    <textarea id="missions_psig" rows="8">

INTERPELLER L'OBJECTIF.

ASSISTER LORS DE LA PERQUISITION.

CONDUITE AU LIEU DE GAV.</textarea>
                </div>

                <div class="wizard-step">
                     <h2>5. Ex√©cution</h2>
                     <label for="date_execution">Date d'ex√©cution:</label><input type="date" id="date_execution">
                     <label for="heure_execution">Heure d'ex√©cution (H):</label><input type="time" id="heure_execution" value="06:00">
                     <label for="type_action">Type d'action:</label><input type="text" id="type_action">
                     <h3>Chronologie</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">‚ûï</button>
                     <h3>Hypoth√®ses</h3>
                     <label for="hypothese_h1">H1:</label><input type="text" id="hypothese_h1" value="Target pr√©sente LE1">
                     <label for="hypothese_h2">H2:</label><input type="text" id="hypothese_h2" value="Target pr√©sente LE2">
                     <label for="hypothese_h3">H3:</label><input type="text" id="hypothese_h3" value="Target absente LE 1 et 2">
                </div>

                <div class="wizard-step">
                     <h2>6. Articulation (MOIPC/ZMSPCP)</h2>
                     <label for="place_chef">Place du Chef (G√©n√©rale):</label><input type="text" id="place_chef">
                     <div class="collapsible-container">
                          <div class="collapsible-header"><h3>√âquipe INDIA (INTER)</h3><span class="material-symbols-outlined">expand_more</span></div>
                          <div class="collapsible-content">
                                 <label for="india_mission">Mission:</label><textarea id="india_mission" rows="3">RECONNA√éTRE LE DOMICILE EN VUE D'APPR√âHENDER L'OBJECTIF</textarea>
                                 <h3>Composition</h3>
                                 <div id="india_composition_display" class="articulation-composition-display">
                                     <p><i>La composition sera affich√©e ici apr√®s configuration dans l'onglet PATRACDVR.</i></p>
                                 </div>
                                 <label for="india_objectif">Objectif:</label><input type="text" id="india_objectif">
                                 <label for="india_itineraire">Itin√©raire:</label><textarea id="india_itineraire" rows="3"></textarea>
                                 <h3>Photos - Itin√©raire</h3>
                                 <h4>Itin√©raire Ext√©rieur</h4>
                                 <div id="photo_container_itineraire_exterieur"></div>
                                 <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_exterieur')">Ajouter Photo ‚ûï</button>
                                 <h4>Itin√©raire Int√©rieur</h4>
                                 <div id="photo_container_itineraire_interieur"></div>
                                 <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_interieur')">Ajouter Photo ‚ûï</button>
                                 <label for="india_points_particuliers">Points Particuliers:</label><textarea id="india_points_particuliers" rows="3"></textarea>
                                 <label for="india_cat">Conduite √† Tenir:</label><textarea id="india_cat" rows="6">- Si d√©cel√©, dynamiser jusqu'au domicile.
- Si pr√©sence tierce personne lors de la progression, contr√¥ler.
- Si fuite, CR direction fuite + interpellation.
- Si r√©bellion, usage du strict niveau de force n√©cessaire.
- Si retranchement, CR + r√©articulation pour fixer l'adversaire.</textarea>
                          </div>
                     </div>
                     <div class="collapsible-container">
                          <div class="collapsible-header"><h3>√âquipe Appui/Observation (AO) - ZMSPCP</h3><span class="material-symbols-outlined">expand_more</span></div>
                          <div class="collapsible-content">
                                 <h3>Composition</h3>
                                 <div id="ao_composition_display" class="articulation-composition-display">
                                     <p><i>La composition sera affich√©e ici apr√®s configuration dans l'onglet PATRACDVR.</i></p>
                                 </div>
                                 <label for="ao_zone_installation">Zone d'installation (Z):</label><textarea id="ao_zone_installation" rows="3"></textarea>
                                 <h3>Photos - Zone d'installation</h3>
                                 <h4>Bapt√™me terrain</h4>
                                 <div id="photo_container_bapteme_terrain"></div>
                                 <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_bapteme_terrain')">Ajouter Photo ‚ûï</button>
                                 <h4>Emplacement AO</h4>
                                 <div id="photo_container_emplacement_ao"></div>
                                 <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_emplacement_ao')">Ajouter Photo ‚ûï</button>
                                 <label for="ao_mission">Mission (M):</label><textarea id="ao_mission" rows="3">BOUCLER - SURVEILLER - INTERDIRE TOUTE FUITE</textarea>
                                 <label for="ao_secteur_surveillance">Secteur de surveillance (S):</label><textarea id="ao_secteur_surveillance" rows="3"></textarea>
                                 <label for="ao_points_particuliers">Points Particuliers (P):</label><textarea id="ao_points_particuliers" rows="3"></textarea>
                                 <label for="ao_cat">Conduite √† Tenir (C):</label><textarea id="ao_cat" rows="6">- Compte rendu de mise en place.
- Renseigner r√©guli√®rement.
- Si d√©cel√©, CR.
- Si fuite, CR direction fuite + interpellation si rapport de force favorable.
- Si r√©bellion, usage du strict minimum de force n√©cessaire.
- Si retranchement, CR + r√©articulation pour fixer l'adversaire.</textarea>
                                 <label for="ao_place_chef">Place du Chef (P):</label><input type="text" id="ao_place_chef">
                          </div>
                     </div>
                </div>

                <div class="wizard-step">
                    <h2>7. PATRACDVR</h2>
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px;">
                        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px;">
                            <button type="button" id="importDefaultConfigBtn" class="add-btn" style="background-color: var(--accent-blue); flex-grow: 1;">Charger Config par D√©faut ‚öôÔ∏è</button>
                            <button type="button" id="importJsonConfigBtn" class="add-btn" style="background-color: var(--success-green); flex-grow: 1;">Importer Configuration Membres (.json) üì§</button>
                            <button type="button" id="resetPatracdvrBtn" class="remove-btn" style="flex-grow: 1;">R√©initialiser PATRACDVR</button>
                        </div>
                    </div>

                    <div id="quickEditPanel">
                        <h4>Membre: <span id="selectedMemberTrigramme">Aucun</span>
                            <button type="button" id="fullEditBtn" class="add-btn" style="font-size: 0.8em; padding: 5px 8px; margin-left: 15px;">√âdition Compl√®te</button>
                        </h4>
                        <div class="quick-edit-content"></div>
                    </div>

                    <h4 style="margin-top: 20px;">Ajouter un v√©hicule ou un membre</h4>
                    <div id="vehicle_creation_buttons">
                        <button type="button" class="add-btn add-vehicle-btn" id="addManualVehicleBtn">‚ûï V√©hicule Manuel</button>
                        <button type="button" class="add-btn add-vehicle-btn" id="addManualMemberBtn">‚ûï Membre Manuel</button>
                        </div>

                    <h4 style="margin-top: 20px;">Composition des v√©hicules</h4>
                    <div id="patracdvr_container"></div>

                    <h4 style="margin-top: 20px;">Personnel √† attribuer</h4>
                    <div id="unassigned_members_container"></div>
                </div>

                <div class="wizard-step">
                    <h2>8. Photos</h2>
                    <p>Ajoutez des photos compl√©mentaires pour le PDF.</p>
                    <div class="form-section">
                        <h3>Transport PSIG vers PR</h3>
                        <div id="photo_container_transport_pr"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_pr')">Ajouter Photo ‚ûï</button>
                    </div>
                     <div class="form-section">
                        <h3>Transport PR vers Domicile</h3>
                        <div id="photo_container_transport_domicile"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_domicile')">Ajouter Photo ‚ûï</button>
                    </div>
                    <div class="form-section">
                        <h3>Cellule Effraction</h3>
                        <div id="photo_container_cellule_effraction"></div>
                        <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_cellule_effraction')">Ajouter Photo ‚ûï</button>
                    </div>
                </div>

                <div class="wizard-step">
                    <h2>9. Conduites √† tenir</h2>
                    <h3>G√©n√©rales</h3>
                    <textarea id="cat_generales" rows="6">- Si r√©bellion, user du strict niveau de force n√©cessaire
- Si retranch√©, alerter en mesure de se r√©-articuler
- Si tente de fuir, alerter en mesure de jalonner/interpeller
- UDA : Article L435-1 du CSI + l√©gitime d√©fense</textarea>
                    <h3>NO GO</h3>
                    <textarea id="no_go" rows="3" placeholder="Saisir les conditions de d√©sengagement..."></textarea>
                    <h3>Liaison</h3>
                    <textarea id="cat_liaison" rows="4">TOM:
DIR:
Gestuelle et visuelle entre les √©l√©ments INDIA</textarea>
                </div>

                <div class="wizard-step">
                    <h2>10. Finalisation</h2>
                    <p style="text-align:center;">V√©rifiez les points de coh√©rence avant de g√©n√©rer l'Ordre Initial.</p>
                    <div style="border: 1px solid var(--border-color); padding: 15px; border-radius: 5px; margin-top: 20px;">
                        <h3>V√©rification des Donn√©es Critiques</h3>
                        <div id="coherence_alerts_container">
                             <div class="coherence-alert" style="color:var(--text-secondary); background-color:var(--bg-interactive);"><span class="material-symbols-outlined">info</span> Cliquez sur "Aper√ßu" pour lancer la v√©rification de coh√©rence.</div>
                        </div>
                        <div id="recap_finalisation" style="margin-top: 15px;"></div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                        <button class="wizard-nav-btn" id="previewBtn" type="button">Aper√ßu (Mode Pr√©sentation) üîé</button>
                        </div>
                    <div class="retex-section">
                        <h3>Lien vers RETEX</h3>
                        <p>Utilisez ce bouton pour afficher la page vers la plateforme interne de compte-rendu d'op√©ration.</p>
                        <div class="retex-actions">
                            <button id="retexReportBtn" class="wizard-nav-btn" type="button" style="background-color: #008080;">Page Retex üß†</button>
                        </div>
                    </div>
                    <div class="retex-section" style="margin-top: 10px;">
                        <h3>üß† Analyse RETEX par IA (Fichiers locaux)</h3>
                        <p>S√©lectionnez les fichiers JSON des comptes-rendus √† analyser localement (N√©cessite Cl√© API Gemini).</p>
                        <div class="retex-file-selector">
                            <label for="retexFileInput" class="file-upload-label" style="background-color: var(--accent-blue);"><span class="material-symbols-outlined">upload_file</span> Choisir des fichiers</label>
                            <input type="file" id="retexFileInput" accept=".json" multiple style="display: none;">
                            <span id="retexFileNames" class="file-name-display" style="color: var(--text-secondary);">Aucun fichier s√©lectionn√©</span>
                        </div>
                        <div class="retex-actions">
                             <button id="launchRetexAnalysisBtn" class="add-btn" type="button">Lancer l'Analyse</button>
                            <button id="generateRetexPdfBtn" class="wizard-nav-btn" style="display: none; background-color: var(--success-green);">G√©n√©rer le PDF du rapport</button>
                        </div>
                        <p id="retex_status" class="retex-status"></p>
                        <div id="retex_output" class="retex-output-content" style="display: none;"></div>
                    </div>
                    </div>
            </div>
        </form>

        <div class="wizard-nav">
            <button class="wizard-nav-btn" id="prevBtn" type="button">Pr√©c√©dent</button>
            <button class="wizard-nav-btn" id="nextBtn" type="button">Suivant</button>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script>
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent";
        const RETEX_BASE_URL = "https://oxsilaris06.github.io/Praxis/retex.html";
        const DEFAULT_CONFIG_FILE = 'members_config.json';
        let memberConfig = {
            fonctions: ['Chef inter', 'Chef dispo', 'Chef AO', 'Effrac', 'DE', 'Sans'],
            cellules: ['AO1', 'AO2', 'AO3', 'AO4', 'AO5', 'AO6', 'India 1', 'India 2', 'India 3', 'India 4', 'India 5', 'Sans'],
            armements: ['Sans', 'UMP9', 'G36', 'PIE', 'LBD40', 'FAP'],
            equipements: ['Sans', 'BBAL', 'GENL', 'EFFRAC', 'MP7', 'IL'],
            equipements2: ['Sans', '√âchelle', 'Stop stick', 'Lacry', 'Cale'],
            tenues: ['UBAS', '4S', 'Bleu', 'Treillis', 'Civil'],
            gpbs: ['GPBL', 'GPBPD', 'Sans']
        };
        const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'Sc√©nic', 'BT'];
        let activeMemberId = null, currentStep = 0, visitedSteps = new Set();
        const [steps, progressSteps] = [Array.from(document.querySelectorAll(".wizard-step")), Array.from(document.querySelectorAll(".wizard-progress-step"))];
        const [prevBtn, nextBtn, previewBtn, retexReportBtn] = [document.getElementById('prevBtn'), document.getElementById('nextBtn'), document.getElementById('previewBtn'), document.getElementById('retexReportBtn')];
        const [retexStatus, retexOutput, patracdvrContainer, unassignedContainer] = [document.getElementById('retex_status'), document.getElementById('retex_output'), document.getElementById('patracdvr_container'), document.getElementById('unassigned_members_container')];
        const [jsonConfigInput, resetPatracdvrBtn, importJsonConfigBtn, importDefaultConfigBtn] = [document.getElementById('jsonConfigInput'), document.getElementById('resetPatracdvrBtn'), document.getElementById('importJsonConfigBtn'), document.getElementById('importDefaultConfigBtn')];
        const [retexFileInput, retexFileNames, presentationModal, downloadPdfBtn, coherenceAlertsContainer, recapFinalisation] = [document.getElementById('retexFileInput'), document.getElementById('retexFileNames'), document.getElementById('presentationModal'), document.getElementById('downloadPdfBtn'), document.getElementById('coherence_alerts_container'), document.getElementById('recap_finalisation')];
        const [tempCanvas, tempCtx] = [document.createElement('canvas'), document.createElement('canvas').getContext('2d')];
        const [tutorialPopup, popupText, nextPopupBtn, closePopupBtn] = [document.getElementById('tutorial-popup'), document.getElementById('popup-text'), document.getElementById('next-popup-btn'), document.getElementById('tutorial-popup').querySelector('.close-btn')];
        let currentHighlightedElement = null, currentTutorialStep = 0;
        const tutorialSteps = [{ text: "Bienvenue dans le g√©n√©rateur d'Ordre Initial. Ce guide vous assistera dans la cr√©ation de votre document op√©rationnel.", selector: '.container', center: true }, { text: "Cette barre de progression indique les diff√©rentes sections de l'O.I. Vous pouvez cliquer sur une √©tape pour y naviguer directement.", selector: '.wizard-progress' }, { text: "Commencez par d√©finir le contexte g√©n√©ral et particulier de l'op√©ration, ainsi que sa date.", selector: '#date_op', step: 0 }, { text: "D√©taillez ici toutes les informations relatives √† l'adversaire. Notez l'utilisation des boutons 'Chip' pour la saisie rapide de l'√©tat d'esprit et du volume.", selector: '#adversary_photo_container', step: 1 }, { text: "Renseignez les informations sur les unit√©s amies, le terrain, la m√©t√©o, la population et le cadre juridique de l'intervention.", selector: '#terrain_info', step: 2 }, { text: "La mission principale de l'unit√© est pr√©-remplie dans cette section. Vous pouvez la modifier si n√©cessaire.", selector: '#missions_psig', step: 3 }, { text: "D√©finissez la chronologie de l'action. Vous pouvez ajouter des √©v√©nements et les r√©organiser par glisser-d√©poser.", selector: '#time_events_container', step: 4 }, { text: "D√©crivez l'articulation des √©quipes. La composition est d√©sormais automatiquement import√©e depuis l'onglet PATRACDVR.", selector: '.collapsible-container:first-of-type', step: 5 }, { text: "G√©rez la composition des √©quipes en cliquant sur un membre pour ouvrir le panneau d'√©dition rapide. Les changements seront visibles dans l'onglet Articulation.", selector: '#unassigned_members_container', step: 6 }, { text: "Cette section permet d'ajouter des photos compl√©mentaires (transport, effraction...) qui seront incluses dans le document final.", selector: '.wizard-step:nth-of-type(8)', step: 7 }, { text: "Sp√©cifiez les conduites √† tenir g√©n√©rales, les conditions de d√©sengagement (NO GO), et les proc√©dures de liaison.", selector: '#cat_generales', step: 8 }, { text: "Une fois le formulaire compl√©t√©, cette √©tape affichera les alertes de coh√©rence sur votre composition. Cliquez ensuite ici pour visualiser le document (Mode Pr√©sentation) et le t√©l√©charger au format PDF.", selector: '#previewBtn', step: 9 }, { text: "Ce menu flottant offre un acc√®s rapide aux fonctions globales: sauvegarder (exporter) ou charger (importer) une session, changer le th√®me, r√©initialiser le formulaire, ou relancer ce tutoriel.", selector: '#dockMenu' }];
        
        const goToStep = n => {
            if (n >= 0 && n < steps.length) {
                visitedSteps.add(currentStep); saveFormData(); currentStep = n;
                if (n === 6 && activeMemberId) { const oldActive = document.getElementById(activeMemberId); if (oldActive) oldActive.classList.remove('member-active'); activeMemberId = null; if (window.innerWidth >= 768) document.getElementById('quickEditPanel').style.display = 'none'; }
                steps.forEach((step, index) => step.classList.toggle('active', index === n));
                progressSteps.forEach((pStep, index) => { pStep.classList.toggle('active', index === n); pStep.classList.toggle('completed', visitedSteps.has(index) && index !== n); });
                prevBtn.style.display = n === 0 ? "none" : "inline-block";
                const isLastStep = n === (steps.length - 1); nextBtn.style.display = isLastStep ? "none" : "inline-block";
                previewBtn.style.display = retexReportBtn.style.display = isLastStep ? "inline-block" : "none";
                if (isLastStep) checkCoherence();
            }
        };
        const changeStep = n => goToStep(currentStep + n);
        prevBtn.addEventListener('click', () => changeStep(-1)); nextBtn.addEventListener('click', () => changeStep(1));
        progressSteps.forEach((p, i) => p.addEventListener('click', () => goToStep(i)));

        const handleFileChange = (input, spanId, previewId) => {
            const [fileNameSpan, previewImg, annotateBtn] = [document.getElementById(spanId), document.getElementById(previewId), input.parentElement.querySelector('.annotate-btn')];
            if (input.files.length > 0) {
                fileNameSpan.textContent = input.files[0].name;
                const reader = new FileReader();
                reader.onload = e => {
                    previewImg.src = e.target.result; previewImg.dataset.originalSrc = e.target.result; previewImg.dataset.annotations = '[]';
                    previewImg.style.display = 'block'; if (annotateBtn) annotateBtn.style.display = 'inline-block'; saveFormData();
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                fileNameSpan.textContent = 'Aucun fichier'; previewImg.src = ''; previewImg.dataset.originalSrc = ''; previewImg.dataset.annotations = '[]';
                previewImg.style.display = 'none'; if (annotateBtn) annotateBtn.style.display = 'none'; saveFormData();
            }
        };
        const addPhotoInput = (containerId, isSingle = false) => {
            const container = document.getElementById(containerId);
            if (isSingle) container.innerHTML = '';
            const uniqueId = `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, previewId = `preview_${uniqueId}`;
            const itemWrapper = document.createElement('div'); itemWrapper.className = 'photo-input-wrapper';
            itemWrapper.innerHTML = `<div class="dynamic-list-item"><input type="file" id="${uniqueId}" class="photo-input" accept="image/png, image/jpeg" onchange="handleFileChange(this, 'span_${uniqueId}', '${previewId}')"><label for="${uniqueId}" class="file-upload-label">Choisir une photo</label><span id="span_${uniqueId}" class="file-name-display">Aucun fichier</span><button type="button" class="add-btn annotate-btn" style="display:none; margin-left:5px; background-color: var(--accent-blue);" onclick="openAnnotationModal('${previewId}')">Annoter</button>${!isSingle ? '<button type="button" class="remove-btn" onclick="this.closest(\'.photo-input-wrapper\').remove(); saveFormData();">‚ùå</button>' : ''}</div><img id="${previewId}" class="image-preview" style="display:none;" alt="Aper√ßu"/>`;
            container.appendChild(itemWrapper);
        };
        const addDynamicField = (containerId, value = '') => {
            const container = document.getElementById(containerId);
            const item = document.createElement('div'); item.className = 'dynamic-list-item';
            item.innerHTML = `<input type="text" class="dynamic-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">‚ùå</button>`;
            container.appendChild(item);
        };
        const getChipData = containerId => Array.from(document.getElementById(containerId).querySelectorAll('.chip-btn.selected')).map(btn => btn.textContent);
        const updateChipData = containerId => {}; 
        const initChipContainer = (containerId, selectedValues = []) => {
            const container = document.getElementById(containerId); container.innerHTML = '';
            const options = JSON.parse(container.dataset.options || '[]');
            options.forEach(option => {
                const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'chip-btn'; btn.textContent = option;
                if (selectedValues.includes(option)) btn.classList.add('selected');
                btn.addEventListener('click', function() { this.classList.toggle('selected'); updateChipData(containerId); saveFormData(); });
                container.appendChild(btn);
            });
            const customInput = document.createElement('input'); customInput.type = 'text'; customInput.placeholder = 'Ajouter personnalis√© (entr√©e)';
            customInput.onkeydown = function(event) {
                if (event.key === 'Enter' && this.value.trim()) {
                    event.preventDefault(); const customValue = this.value.trim();
                    if (!options.includes(customValue) && !getChipData(containerId).includes(customValue)) {
                         const newBtn = document.createElement('button'); newBtn.type = 'button'; newBtn.className = 'chip-btn selected';
                         newBtn.textContent = customValue; newBtn.addEventListener('click', btn.onclick);
                         container.insertBefore(newBtn, this);
                    }
                    this.value = ''; updateChipData(containerId); saveFormData();
                }
            };
            customInput.style.cssText = 'flex-basis: 150px; flex-grow: 0; min-height: 40px; padding: 8px 12px;';
            container.appendChild(customInput);
        };
        const addMeField = (value = '') => {
            const container = document.getElementById('me_container'); if (container.children.length >= 3) return;
            const item = document.createElement('div'); item.className = 'dynamic-list-item';
            item.innerHTML = `<label>ME${container.children.length + 1}:</label><input type="text" class="me-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">‚ùå</button>`;
            container.appendChild(item);
        };
        const addTimeEvent = (type_from_load, hour_from_load = '', desc_from_load) => {
            const container = document.getElementById('time_events_container');
            let type, hour = hour_from_load, desc;
            if (type_from_load !== undefined) { type = type_from_load; desc = desc_from_load; } 
            else {
                const prefilledData = [{ type: 'T0', desc: 'Rasso PSIG' }, { type: 'T1', desc: 'D√©part PR' }, { type: 'T2', desc: 'D√©part LE' }, { type: 'T3', desc: 'MEP TERMIN√â' }, { type: 'T4', desc: 'TOP ACTION' }];
                const defaultValues = prefilledData[container.children.length] || { type: `T${container.children.length}`, desc: ''};
                [type, desc] = [defaultValues.type, defaultValues.desc];
            }
            const item = document.createElement('div'); item.className = 'dynamic-list-item time-item draggable';
            item.id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`; item.setAttribute('draggable', 'true');
            const optionsHtml = ['T0','T1','T2','T3','T4','T5'].map(t => `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`).join('');
            item.innerHTML = `<select class="time-type-select" onchange="saveFormData()">${optionsHtml}</select><input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()"><input type="text" class="time-description-input" placeholder="Description" value="${desc || ''}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">‚ùå</button>`;
            container.appendChild(item);
        };
        const updateMemberButtonVisuals = btn => {
            const { trigramme = 'N/A', fonction = '', cellule = '' } = btn.dataset;
            const [cellDisplay, functionDisplay] = [cellule !== 'Sans' ? cellule : '', fonction !== 'Sans' ? ` / ${fonction}` : ''];
            btn.innerHTML = btn.closest('#unassigned_members_container') ? `<span class="trigramme">${trigramme}</span>` : `<span class="trigramme">${trigramme}</span><span class="fonction">${cellDisplay}${cellDisplay && functionDisplay ? '' : ''}${functionDisplay}</span>`;
        };
        const addPatracdvrMember = (containerElement, data = {}) => {
            if (!containerElement) return;
            const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'patracdvr-member-btn draggable';
            btn.id = `member_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`; btn.setAttribute('draggable', 'true');
            const memberData = { trigramme: 'N/A', fonction: 'Sans', cellule: 'India 1', armement: 'Sans', equipement: 'Sans', equipement2: 'Sans', tenue: 'UBAS', gpb: 'GPBL', ...data };
            Object.keys(memberData).forEach(key => btn.dataset[key] = memberData[key]);
            updateMemberButtonVisuals(btn); containerElement.appendChild(btn);
        };
        const addPatracdvrRow = (vehicleName, members = []) => {
            const container = document.getElementById('patracdvr_container');
            if (container.querySelector(`[data-vehicle-name="${vehicleName}"]`)) { alert(`Le v√©hicule "${vehicleName}" existe d√©j√†.`); return; }
            const row = document.createElement('div'); row.className = 'patracdvr-vehicle-row'; row.dataset.vehicleName = vehicleName;
            row.innerHTML = `<div class="vehicle-header"><span class="vehicle-name">${vehicleName}</span><button type="button" class="remove-btn" title="Supprimer le v√©hicule">‚ùå</button></div><div class="patracdvr-members-container"></div>`;
            container.appendChild(row);
            const membersContainer = row.querySelector('.patracdvr-members-container');
            row.querySelector('.remove-btn').addEventListener('click', () => {
                if (confirm(`Voulez-vous vraiment supprimer le v√©hicule "${vehicleName}" et d√©sattribuer ses membres ?`)) {
                    membersContainer.querySelectorAll('.patracdvr-member-btn').forEach(memberBtn => { memberBtn.dataset.cellule = 'Sans'; memberBtn.dataset.fonction = 'Sans'; updateMemberButtonVisuals(memberBtn); unassignedContainer.appendChild(memberBtn); });
                    row.remove(); saveFormData();
                }
            });
            ['dragenter', 'dragleave', 'dragover', 'drop'].forEach(evt => membersContainer.addEventListener(evt, eval(`handle${evt[4].toUpperCase() + evt.slice(5)}`)));
            members.forEach(memberData => addPatracdvrMember(membersContainer, memberData)); saveFormData();
        };
        const addManualVehicle = () => { let vehicleName = prompt("Veuillez saisir le nom du nouveau v√©hicule (ex: VW-Golf, VTC):"); if (vehicleName?.trim().length) addPatracdvrRow(vehicleName.trim()); };
        const addManualMember = () => {
            let trigramme = prompt("Veuillez saisir le trigramme du nouveau membre (ex: ABC):");
            if (!trigramme) return; trigramme = trigramme.trim().toUpperCase();
            if (document.querySelector(`.patracdvr-member-btn[data-trigramme="${trigramme}"]`)) { alert(`Le membre avec le trigramme "${trigramme}" existe d√©j√†.`); return; }
            if (trigramme.length >= 2 && trigramme.length <= 4) { addPatracdvrMember(unassignedContainer, { trigramme, cellule: 'Sans', fonction: 'Sans' }); handleMemberSelection({ target: unassignedContainer.lastChild }); saveFormData(); } else { alert("Le trigramme doit contenir entre 2 et 4 caract√®res."); }
        };
        const updateArticulationDisplay = () => {
            const [indiaContainer, aoContainer, members] = [document.getElementById('india_composition_display'), document.getElementById('ao_composition_display'), Array.from(document.querySelectorAll('.patracdvr-member-btn'))];
            const [indiaMembersByCell, aoMembersByCell] = [{}, {}];
            members.forEach(btn => {
                const { trigramme, cellule } = btn.dataset;
                if (!trigramme || !cellule || cellule.toLowerCase() === 'sans') return;
                const target = cellule.toLowerCase().startsWith('india') ? indiaMembersByCell : (cellule.toLowerCase().startsWith('ao') ? aoMembersByCell : null);
                if (target) target[cellule] = [...(target[cellule] || []), trigramme];
            });
            const naturalSort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
            const formatHtml = (cells, prefix) => {
                let html = '';
                Object.keys(cells).sort(naturalSort).forEach(cell => { html += `<p><strong>${cell}:</strong> ${cells[cell].join(', ')}</p>`; });
                return html || `<p><i>Aucun membre assign√© aux cellules ${prefix}.</i></p>`;
            };
            indiaContainer.innerHTML = formatHtml(indiaMembersByCell, 'India'); aoContainer.innerHTML = formatHtml(aoMembersByCell, 'AO');
        };
        const quickEditMapping = { 'Cellule': { key: 'cellules', attribute: 'cellule' }, 'Fonction': { key: 'fonctions', attribute: 'fonction' }, 'Armement': { key: 'armements', attribute: 'armement' }, '√âquip. 1': { key: 'equipements', attribute: 'equipement' }, '√âquip. 2': { key: 'equipements2', attribute: 'equipement2' }, 'Tenue': { key: 'tenues', attribute: 'tenue' }, 'GPB': { key: 'gpbs', attribute: 'gpb' } };
        const setupQuickEditPanel = () => {
            const container = document.querySelector('#quickEditPanel .quick-edit-content'); container.innerHTML = '';
            for (const [title, config] of Object.entries(quickEditMapping)) {
                const panel = document.createElement('div'); panel.className = 'quick-edit-tab-panel active';
                panel.innerHTML = `<h5>${title}</h5><div class="quick-edit-options">${(memberConfig[config.key] || []).map(option => `<button type="button" class="quick-edit-btn" data-attribute="${config.attribute}" data-value="${option}">${option}</button>`).join('')}</div>`;
                container.appendChild(panel);
            }
        };
        const populateQuickEditPanel = memberId => {
            const member = document.getElementById(memberId); if (!member) return;
            document.getElementById('selectedMemberTrigramme').textContent = member.dataset.trigramme || 'N/A';
            document.querySelectorAll('#quickEditPanel .quick-edit-btn').forEach(btn => { btn.classList.toggle('selected', member.dataset[btn.dataset.attribute] === btn.dataset.value); });
        };
        const handleMemberSelection = event => {
            const clickedButton = event.target.closest('.patracdvr-member-btn');
            if (!clickedButton) return;
            if (activeMemberId === clickedButton.id) { clickedButton.classList.remove('member-active'); activeMemberId = null; document.getElementById('quickEditPanel').style.display = 'none'; return; }
            if (activeMemberId) { const oldActive = document.getElementById(activeMemberId); if (oldActive) oldActive.classList.remove('member-active'); }
            activeMemberId = clickedButton.id; clickedButton.classList.add('member-active');
            if (window.innerWidth < 768) openQuickEditModal(activeMemberId);
            else { populateQuickEditPanel(activeMemberId); document.getElementById('quickEditPanel').style.display = 'block'; }
        };
        const openQuickEditModal = memberId => {
            const modal = document.getElementById('quickEditModal'), content = document.getElementById('quick_modal_content'), member = document.getElementById(memberId);
            if (!member) return;
            document.getElementById('quick_modal_title').textContent = `√âdition Rapide: ${member.dataset.trigramme || 'N/A'}`; content.innerHTML = '';
            for (const [category, config] of Object.entries(quickEditMapping)) {
                if (!memberConfig[config.key]?.length) continue;
                const categoryDiv = document.createElement('div'); categoryDiv.className = 'quick-edit-category';
                categoryDiv.innerHTML = `<h5>${category}</h5><div class="quick-edit-options">${(memberConfig[config.key] || []).map(option => `<button type="button" class="quick-edit-btn ${member.dataset[config.attribute] === option ? 'selected' : ''}" data-attribute="${config.attribute}" data-value="${option}">${option}</button>`).join('')}</div>`;
                content.appendChild(categoryDiv);
            }
            modal.showModal();
        };
        const openMemberModal = buttonId => {
            const [modal, form, button, deleteBtn] = [document.getElementById('editMemberModal'), document.getElementById('editMemberForm'), document.getElementById(buttonId), document.getElementById('modal_deleteBtn')];
            if (!button) return; form.dataset.editingButtonId = buttonId;
            const isUnassigned = button.closest('#unassigned_members_container');
            deleteBtn.textContent = isUnassigned ? 'Supprimer D√©finitivement' : 'Renvoyer en Attente'; deleteBtn.style.backgroundColor = isUnassigned ? '#FF0000' : 'var(--danger-red)';
            document.getElementById('modal_trigramme').value = button.dataset.trigramme;
            for (const key in memberConfig) {
                const attrName = key.replace(/s$/, ''); const select = document.getElementById('modal_' + attrName);
                if (select) { select.innerHTML = memberConfig[key].map(option => `<option value="${option}" ${option === button.dataset[attrName] ? 'selected' : ''}>${option}</option>`).join(''); select.value = button.dataset[attrName]; }
            }
            modal.showModal();
        };
        const saveFormData = () => {
            try {
                const data = {};
                document.querySelectorAll('#oi-form input:not([type="file"]), #oi-form textarea, #oi-form select').forEach(field => { if (field.id) data[field.id] = field.value; });
                document.querySelectorAll('.image-preview').forEach(img => {
                    if (img.id && img.src.startsWith('data:image')) {
                        data[img.id + '_src'] = img.src; data[img.id + '_original_src'] = img.dataset.originalSrc;
                        data[img.id + '_annotations'] = img.dataset.annotations || '[]';
                    }
                });
                data.me_list = Array.from(document.querySelectorAll('#me_container .me-input')).map(i => i.value).filter(Boolean);
                data.etat_esprit_list = getChipData('etat_esprit_container'); data.volume_list = getChipData('volume_adversaire_container');
                data.vehicules_list = Array.from(document.querySelectorAll(`#vehicules_container .dynamic-input`)).map(i => i.value).filter(Boolean);
                data.patracdvr_unassigned = Array.from(unassignedContainer.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }));
                data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .patracdvr-vehicle-row')).map(row => ({
                    vehicle: row.dataset.vehicleName, members: Array.from(row.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }))
                }));
                data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
                    type: item.querySelector('.time-type-select').value, hour: item.querySelector('.time-hour-input').value,
                    description: item.querySelector('.time-description-input').value
                }));
                try { localStorage.setItem('oiFormData', JSON.stringify(data)); }
                catch (e) {
                    if (e.name === 'QuotaExceededError' || e.name === 'DOMException') {
                        if (localStorage.getItem('quotaAlertShown') !== 'true') { alert("Alerte: Espace de stockage (5Mo) atteint. Les donn√©es textuelles sont sauvegard√©es, mais les images ont √©t√© retir√©es de la sauvegarde locale pour √©viter l'erreur. Veuillez exporter la session si vous souhaitez conserver les images pour la prochaine fois."); localStorage.setItem('quotaAlertShown', 'true'); }
                        Object.keys(data).filter(key => key.endsWith('_src')).forEach(key => { delete data[key]; delete data[key.replace('_src', '') + '_original_src']; delete data[key.replace('_src', '') + '_annotations']; });
                        localStorage.setItem('oiFormData', JSON.stringify(data));
                    } else { throw e; }
                }
                updateArticulationDisplay();
            } catch (e) { console.error("Save error:", e); }
        };
        const initializePatracdvr = dataFromStorage => {
            unassignedContainer.innerHTML = ''; patracdvrContainer.innerHTML = '';
            if (dataFromStorage && (dataFromStorage.patracdvr_rows?.length > 0 || dataFromStorage.patracdvr_unassigned?.length > 0)) {
                (dataFromStorage.patracdvr_unassigned || []).forEach(member => addPatracdvrMember(unassignedContainer, member));
                (dataFromStorage.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
            }
        };
        const loadFormData = () => {
            const dataString = localStorage.getItem('oiFormData');
            if (!dataString) return false;
            try {
                const data = JSON.parse(dataString);
                document.querySelectorAll('.photo-input-wrapper').forEach(wrapper => {
                    const [previewImg, annotateBtn, span] = [wrapper.querySelector('.image-preview'), wrapper.querySelector('.annotate-btn'), wrapper.querySelector('.file-name-display')];
                    const [srcKey, originalSrcKey, annotationsKey] = [previewImg.id + '_src', previewImg.id + '_original_src', previewImg.id + '_annotations'];
                    if (data[srcKey]) {
                        previewImg.src = data[srcKey]; previewImg.dataset.originalSrc = data[originalSrcKey];
                        previewImg.dataset.annotations = data[annotationsKey] || '[]'; previewImg.style.display = 'block';
                        if (annotateBtn) annotateBtn.style.display = 'inline-block';
                        if (span) span.textContent = 'Image charg√©e';
                    }
                });
                Object.keys(data).forEach(key => {
                    if (key.endsWith('_src') || key.endsWith('_original_src') || key.endsWith('_annotations') || ['patracdvr_rows', 'patracdvr_unassigned', 'time_events', 'me_list', 'etat_esprit_list', 'volume_list', 'vehicules_list'].includes(key)) return;
                    const el = document.getElementById(key);
                    if (el && !Array.isArray(data[key]) && typeof data[key] !== 'object') el.value = data[key];
                });
                document.getElementById('me_container').innerHTML = ''; document.getElementById('vehicules_container').innerHTML = ''; document.getElementById('time_events_container').innerHTML = '';
                (data.me_list || []).forEach(val => addMeField(val));
                initChipContainer('etat_esprit_container', data.etat_esprit_list || []); initChipContainer('volume_adversaire_container', data.volume_list || []);
                (data.vehicules_list || []).forEach(val => addDynamicField('vehicules_container', val));
                (data.time_events || []).forEach(ev => addTimeEvent(ev.type, ev.hour, ev.description));
                initializePatracdvr(data); updateArticulationDisplay(); return true;
            } catch (e) { console.error("Load error:", e); return false; }
        };
        const loadConfigObject = config => {
            if (config.options) { Object.assign(memberConfig, config.options); setupQuickEditPanel(); const form = document.getElementById('editMemberForm'); if (form.dataset.editingButtonId) openMemberModal(form.dataset.editingButtonId); }
            if (config.members && Array.isArray(config.members)) { unassignedContainer.innerHTML = ''; patracdvrContainer.innerHTML = ''; config.members.forEach(memberData => addPatracdvrMember(unassignedContainer, { cellule: memberData.cellule || 'Sans', fonction: memberData.fonction || 'Sans', ...memberData })); }
            saveFormData();
        };
        const loadDefaultConfig = async () => {
            try { const response = await fetch(DEFAULT_CONFIG_FILE); if (response.status !== 404) { loadConfigObject(await response.json()); } }
            catch (e) { console.warn(`[Config Info] Impossible de charger la configuration par d√©faut (${DEFAULT_CONFIG_FILE}). Utilisation de la configuration interne.`, e); setupQuickEditPanel(); }
        };
        let draggedItem = null;
        const getDragAfterElement = (container, y) => {
            const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
            return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2; return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest; }, { offset: Number.NEGATIVE_INFINITY }).element;
        };
        const handleDragEnter = e => { e.preventDefault(); e.currentTarget.style.border = '2px dashed var(--accent-blue)'; };
        const handleDragOver = e => { e.preventDefault(); const targetContainer = e.currentTarget; if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) { const afterElement = getDragAfterElement(targetContainer, e.clientY); targetContainer.insertBefore(draggedItem, afterElement); } };
        const handleDragLeave = e => { e.currentTarget.style.border = '1px dashed var(--border-color)'; };
        const handleDrop = e => {
            e.preventDefault(); const targetContainer = e.currentTarget; targetContainer.style.border = '1px dashed var(--border-color)';
            if (!draggedItem || !draggedItem.classList.contains('patracdvr-member-btn')) return;
            targetContainer.appendChild(draggedItem);
            const isUnassignedZone = targetContainer.id === 'unassigned_members_container';
            draggedItem.dataset.cellule = isUnassignedZone ? 'Sans' : (draggedItem.dataset.cellule === 'Sans' ? 'India 1' : draggedItem.dataset.cellule);
            draggedItem.dataset.fonction = isUnassignedZone ? 'Sans' : draggedItem.dataset.fonction;
            updateMemberButtonVisuals(draggedItem);
            if (draggedItem.id === activeMemberId) { draggedItem.classList.remove('member-active'); activeMemberId = null; if (window.innerWidth >= 768) document.getElementById('quickEditPanel').style.display = 'none'; }
            saveFormData(); draggedItem = null;
        };
        const startTutorial = () => { if (tutorialPopup.style.display === 'flex') { hideTutorial(); return; } goToStep(0); currentTutorialStep = 0; showTutorialStep(currentTutorialStep); };
        const showTutorialStep = stepIndex => {
            if (stepIndex >= tutorialSteps.length) { hideTutorial(); return; }
            const step = tutorialSteps[stepIndex];
            if (step.step !== undefined && step.step !== currentStep) { goToStep(step.step); setTimeout(() => showTutorialStep(stepIndex), 600); return; }
            if (currentHighlightedElement) { currentHighlightedElement.classList.remove('highlight-element'); }
            popupText.textContent = step.text; nextPopupBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Terminer' : 'Suivant';
            if (step.center) { tutorialPopup.style.cssText = 'top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex;'; currentHighlightedElement = null; return; }
            const targetElement = document.querySelector(step.selector);
            if (!targetElement) { console.warn(`Element non trouv√©: ${step.selector}`); currentTutorialStep++; showTutorialStep(currentTutorialStep); return; }
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetElement.classList.add('highlight-element'); currentHighlightedElement = targetElement;
            const rect = targetElement.getBoundingClientRect(); const [popupWidth, popupHeight] = [tutorialPopup.offsetWidth, tutorialPopup.offsetHeight];
            let [popupX, popupY] = [rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2), rect.top + window.scrollY - popupHeight - 20];
            if (popupY < window.scrollY + 10) { popupY = rect.bottom + window.scrollY + 20; }
            if (popupX < 10) popupX = 10;
            if (popupX + popupWidth > window.innerWidth - 10) { popupX = window.innerWidth - popupWidth - 10; }
            tutorialPopup.style.cssText = `top: ${popupY}px; left: ${popupX}px; transform: none; display: flex;`;
        };
        const hideTutorial = () => { if (currentHighlightedElement) { currentHighlightedElement.classList.remove('highlight-element'); } tutorialPopup.style.display = 'none'; };
        nextPopupBtn.addEventListener('click', () => { currentTutorialStep++; showTutorialStep(currentTutorialStep); });
        closePopupBtn.addEventListener('click', hideTutorial);
        
        const [canvas, ctx] = [document.getElementById('annotationCanvas'), document.getElementById('annotationCanvas').getContext('2d')];
        const baseImage = new Image();
        let annotations = [], currentTool = 'move', isDrawing = false, startX, startY, currentAnnotation = null, selectedAnnotation = null, isMovingAnnotation = false;
        const rotationInput = document.getElementById('rotation_input');

        const setContextualTools = selection => {
            const contextualTools = document.getElementById('contextual_tools');
            if (selection) { contextualTools.classList.add('active'); contextualTools.classList.toggle('location-selected', selection.type === 'location'); rotationInput.value = Math.round((selection.rotation || 0) * 180 / Math.PI) % 360; if (rotationInput.value < 0) rotationInput.value = 360 + parseInt(rotationInput.value); }
            else { contextualTools.classList.remove('active'); }
        };
        const updateAnnotationRotation = () => { if (selectedAnnotation) { selectedAnnotation.rotation = (parseFloat(rotationInput.value) || 0) * Math.PI / 180; redrawCanvas(); saveFormData(); } };
        const setActiveTool = toolId => {
            currentTool = toolId;
            document.querySelectorAll('.tool-btn.active, .tool-controls.active').forEach(el => el.classList.remove('active'));
            document.getElementById(`tool_${toolId}`)?.classList.add('active');
            document.getElementById(`controls_${toolId}`)?.classList.add('active');
            canvas.style.cursor = toolId === 'move' ? 'grab' : 'crosshair';
            selectedAnnotation = null; setContextualTools(null);
        };
        const openAnnotationModal = previewImgId => {
            const previewImg = document.getElementById(previewImgId);
            if (!previewImg || !previewImg.dataset.originalSrc) return;
            baseImage.onload = () => { canvas.width = baseImage.width; canvas.height = baseImage.height; annotations = JSON.parse(previewImg.dataset.annotations || '[]'); setActiveTool('move'); redrawCanvas(); annotationModal.dataset.targetPreviewId = previewImgId; annotationModal.showModal(); };
            baseImage.src = previewImg.dataset.originalSrc;
        };
        const redrawCanvas = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(baseImage, 0, 0); annotations.forEach(drawAnnotation);
            if (isDrawing && currentAnnotation) drawAnnotation(currentAnnotation);
            if (selectedAnnotation) drawSelectionBorder(selectedAnnotation);
        };
        const drawSelectionBorder = annotation => {
            ctx.save(); ctx.setLineDash([5, 5]); ctx.strokeStyle = 'white'; ctx.lineWidth = 3;
            let [x, y, width, height, centerX, centerY] = [0, 0, 0, 0, 0, 0]; const { type, rotation = 0 } = annotation;
            if (type === 'location') { x = annotation.x - annotation.radius; y = annotation.y - annotation.radius; width = annotation.radius * 2; height = annotation.radius * 2; centerX = annotation.x; centerY = annotation.y; }
            else if (type === 'box') { x = annotation.x; y = annotation.y; width = annotation.width; height = annotation.height; centerX = annotation.x + annotation.width / 2; centerY = annotation.y + annotation.height / 2; }
            else if (type === 'arrow') { const [minX, minY, maxX, maxY] = [Math.min(annotation.startX, annotation.endX), Math.min(annotation.startY, annotation.endY), Math.max(annotation.startX, annotation.endX), Math.max(annotation.startY, annotation.endY)]; x = minX - 10; y = minY - 10; width = maxX - minX + 20; height = maxY - minY + 20; centerX = (annotation.startX + annotation.endX) / 2; centerY = (annotation.startY + annotation.endY) / 2; }
            if (rotation) { ctx.translate(centerX, centerY); ctx.rotate(rotation); ctx.translate(-centerX, -centerY); }
            ctx.strokeRect(x, y, width, height); ctx.restore();
        };
        const drawAnnotation = annotation => {
            ctx.save();
            let [centerX, centerY] = [0, 0]; const { type, rotation = 0 } = annotation;
            if (type === 'location') { centerX = annotation.x; centerY = annotation.y; }
            else if (type === 'box') { centerX = annotation.x + annotation.width / 2; centerY = annotation.y + annotation.height / 2; }
            else if (type === 'arrow') { centerX = (annotation.startX + annotation.endX) / 2; centerY = (annotation.startY + annotation.endY) / 2; }
            if (rotation) { ctx.translate(centerX, centerY); ctx.rotate(rotation); ctx.translate(-centerX, -centerY); }
            if (type === 'location') {
                const radius = annotation.radius || 0; if (radius < 2) { ctx.restore(); return; }
                ctx.beginPath(); ctx.arc(annotation.x, annotation.y, radius, 0, 2 * Math.PI);
                ctx.fillStyle = `rgba(91, 155, 213, ${annotation.opacity || 0.5})`; ctx.fill();
                ctx.strokeStyle = '#5b9bd5'; ctx.lineWidth = 2; ctx.stroke();
                if (annotation.text) { ctx.fillStyle = 'black'; ctx.font = `bold ${Math.max(12, radius / 2)}px Oswald`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(annotation.text, annotation.x, annotation.y); }
            } else if (type === 'arrow') {
                const [fromx, fromy, tox, toy, lineWidth] = [annotation.startX, annotation.startY, annotation.endX, annotation.endY, annotation.thickness || 5];
                if (fromx !== tox || fromy !== toy) {
                    ctx.strokeStyle = '#c0392b'; ctx.fillStyle = '#c0392b'; ctx.lineWidth = lineWidth;
                    const [dx, dy] = [tox - fromx, toy - fromy]; const angle = Math.atan2(dy, dx);
                    const headlen = Math.max(lineWidth * 3, 10); const arrowLength = Math.sqrt(dx * dx + dy * dy);
                    const [lineToX, lineToY] = [tox - (headlen * 0.7) * Math.cos(angle), toy - (headlen * 0.7) * Math.sin(angle)];
                    if (arrowLength >= headlen * 1.5) {
                        ctx.beginPath(); ctx.moveTo(fromx, fromy); ctx.lineTo(lineToX, lineToY); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(tox, toy);
                        ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 7), toy - headlen * Math.sin(angle - Math.PI / 7));
                        ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 7), toy - headlen * Math.sin(angle + Math.PI / 7));
                        ctx.closePath(); ctx.fill();
                    } else { ctx.beginPath(); ctx.moveTo(fromx, fromy); ctx.lineTo(tox, toy); ctx.stroke(); }
                }
            } else if (type === 'box') { ctx.strokeStyle = '#c0392b'; ctx.lineWidth = annotation.thickness || 5; ctx.strokeRect(annotation.x, annotation.y, annotation.width, annotation.height); }
            ctx.restore();
        };
        const drawArrow = (fromx, fromy, tox, toy, lineWidth) => {
             if (fromx === tox && fromy === toy) return; ctx.strokeStyle = '#c0392b'; ctx.fillStyle = '#c0392b'; ctx.lineWidth = lineWidth; const dx = tox - fromx; const dy = toy - fromy; const angle = Math.atan2(dy, dx); const headlen = Math.max(lineWidth * 3, 10); const arrowLength = Math.sqrt(dx * dx + dy * dy); const lineToX = tox - (headlen * 0.7) * Math.cos(angle); const lineToY = toy - (headlen * 0.7) * Math.sin(angle); if (arrowLength < headlen * 1.5) { ctx.beginPath(); ctx.moveTo(fromx, fromy); ctx.lineTo(tox, toy); ctx.stroke(); return; } ctx.beginPath(); ctx.moveTo(fromx, fromy); ctx.lineTo(lineToX, lineToY); ctx.stroke(); ctx.beginPath(); ctx.moveTo(tox, toy); ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 7), toy - headlen * Math.sin(angle - Math.PI / 7)); ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 7), toy - headlen * Math.sin(angle + Math.PI / 7)); ctx.closePath(); ctx.fill();
        };
        const getEventPos = (canvas, evt) => {
            const rect = canvas.getBoundingClientRect(); const [clientX, clientY] = [evt.touches ? evt.touches[0].clientX : evt.clientX, evt.touches ? evt.touches[0].clientY : evt.clientY];
            const [scaleX, scaleY] = [canvas.width / rect.width, canvas.height / rect.height];
            return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
        };
        const getRotatedPoint = (x, y, centerX, centerY, angle) => {
            const [cos, sin, translatedX, translatedY] = [Math.cos(-angle), Math.sin(-angle), x - centerX, y - centerY];
            return { x: translatedX * cos - translatedY * sin + centerX, y: translatedX * sin + translatedY * cos + centerY };
        };
        const getAnnotationAtPosition = (x, y) => {
            for (let i = annotations.length - 1; i >= 0; i--) {
                const annotation = annotations[i]; const angle = annotation.rotation || 0;
                let [centerX, centerY] = [0, 0];
                if (annotation.type === 'location') { centerX = annotation.x; centerY = annotation.y; } else if (annotation.type === 'box') { centerX = annotation.x + annotation.width / 2; centerY = annotation.y + annotation.height / 2; } else if (annotation.type === 'arrow') { centerX = (annotation.startX + annotation.endX) / 2; centerY = (annotation.startY + annotation.endY) / 2; }
                const { x: testX, y: testY } = getRotatedPoint(x, y, centerX, centerY, angle); const tolerance = 15; let isInside = false;
                if (annotation.type === 'location') isInside = Math.sqrt(Math.pow(testX - annotation.x, 2) + Math.pow(testY - annotation.y, 2)) <= annotation.radius + tolerance / 2;
                else if (annotation.type === 'box') isInside = testX >= annotation.x - tolerance && testX <= annotation.x + annotation.width + tolerance && testY >= annotation.y - tolerance && testY <= annotation.y + annotation.height + tolerance;
                else if (annotation.type === 'arrow') {
                    const [dx, dy] = [annotation.endX - annotation.startX, annotation.endY - annotation.startY]; const lenSq = dx * dx + dy * dy; if (lenSq === 0) continue;
                    const t = ((testX - annotation.startX) * dx + (testY - annotation.startY) * dy) / lenSq;
                    if (t >= 0 && t <= 1) isInside = Math.pow(testX - (annotation.startX + t * dx), 2) + Math.pow(testY - (annotation.startY + t * dy), 2) <= Math.pow((annotation.thickness || 5) + tolerance, 2);
                }
                if (isInside) return annotation;
            }
            return null;
        };
        let [startXAnnotation, startYAnnotation] = [0, 0];
        const handleDrawStart = e => {
            e.preventDefault(); const pos = getEventPos(canvas, e); startXAnnotation = pos.x; startYAnnotation = pos.y;
            if (currentTool === 'move') {
                selectedAnnotation = getAnnotationAtPosition(pos.x, pos.y); setContextualTools(selectedAnnotation);
                if (selectedAnnotation) { isMovingAnnotation = true; document.body.style.overflow = 'hidden'; redrawCanvas(); }
            } else { isDrawing = true; selectedAnnotation = null; setContextualTools(null); currentAnnotation = { type: currentTool, startX: startXAnnotation, startY: startYAnnotation, endX: startXAnnotation, endY: startYAnnotation, rotation: 0 }; }
        };
        const handleDrawMove = e => {
            e.preventDefault(); if (!isDrawing && !isMovingAnnotation) return; const pos = getEventPos(canvas, e);
            if (isMovingAnnotation && selectedAnnotation) {
                const [deltaX, deltaY] = [pos.x - startXAnnotation, pos.y - startYAnnotation];
                if (selectedAnnotation.type === 'arrow') { selectedAnnotation.startX += deltaX; selectedAnnotation.startY += deltaY; selectedAnnotation.endX += deltaX; selectedAnnotation.endY += deltaY; }
                else { selectedAnnotation.x += deltaX; selectedAnnotation.y += deltaY; }
                startXAnnotation = pos.x; startYAnnotation = pos.y; redrawCanvas();
            } else if (isDrawing && currentAnnotation) { currentAnnotation.endX = pos.x; currentAnnotation.endY = pos.y; redrawCanvas(); }
        };
        const handleDrawEnd = e => {
            e.preventDefault(); document.body.style.overflow = '';
            if (isMovingAnnotation) { isMovingAnnotation = false; redrawCanvas(); saveFormData(); }
            else if (isDrawing) {
                isDrawing = false; const final = { ...currentAnnotation };
                if (final.type === 'box') { final.x = Math.min(final.startX, final.endX); final.y = Math.min(final.startY, final.endY); final.width = Math.abs(final.startX - final.endX); final.height = Math.abs(final.startY - final.endY); final.thickness = document.getElementById('box_thickness').value; if (final.width < 5 || final.height < 5) return; }
                else if (final.type === 'arrow') { final.thickness = document.getElementById('arrow_thickness').value; if (Math.abs(final.startX - final.endX) < 5 && Math.abs(final.startY - final.endY) < 5) return; }
                else if (final.type === 'location') { final.x = final.startX; final.y = final.startY; final.radius = Math.sqrt(Math.pow(final.endX - final.startX, 2) + Math.pow(final.endY - final.startY, 2)); final.text = document.getElementById('circle_text').value || 'Zone'; final.opacity = document.getElementById('circle_opacity').value; if (final.radius < 5) return; }
                annotations.push(final); currentAnnotation = null; selectedAnnotation = final; setContextualTools(selectedAnnotation); redrawCanvas(); saveFormData();
            }
        };
        const drawAnnotationOnContext = (context, canvasWidth, canvasHeight, annotation) => {
            context.save();
            let [centerX, centerY] = [0, 0]; const { type, rotation = 0 } = annotation;
            if (type === 'location') { centerX = annotation.x; centerY = annotation.y; } else if (type === 'box') { centerX = annotation.x + annotation.width / 2; centerY = annotation.y + annotation.height / 2; } else if (type === 'arrow') { centerX = (annotation.startX + annotation.endX) / 2; centerY = (annotation.startY + annotation.endY) / 2; }
            if (rotation) { context.translate(centerX, centerY); context.rotate(rotation); context.translate(-centerX, -centerY); }
            if (type === 'location') {
                const radius = annotation.radius || 0; if (radius < 2) { context.restore(); return; }
                context.beginPath(); context.arc(annotation.x, annotation.y, radius, 0, 2 * Math.PI);
                context.fillStyle = `rgba(91, 155, 213, ${annotation.opacity || 0.5})`; context.fill();
                context.strokeStyle = '#5b9bd5'; context.lineWidth = 2; context.stroke();
                if (annotation.text) { context.fillStyle = 'black'; context.font = `bold ${Math.max(12, radius / 2)}px Oswald`; context.textAlign = 'center'; context.textBaseline = 'middle'; context.fillText(annotation.text, annotation.x, annotation.y); }
            } else if (type === 'arrow') {
                const drawArrowLocal = (fromx, fromy, tox, toy, lineWidth) => {
                     if (fromx === tox && fromy === toy) return; context.strokeStyle = '#c0392b'; context.fillStyle = '#c0392b'; context.lineWidth = lineWidth;
                     const headlen = Math.max(lineWidth * 3, 10); const [dx, dy] = [tox - fromx, toy - fromy]; const angle = Math.atan2(dy, dx);
                     const [lineToX, lineToY] = [tox - (headlen * 0.7) * Math.cos(angle), toy - (headlen * 0.7) * Math.sin(angle)];
                     context.beginPath(); context.moveTo(fromx, fromy); context.lineTo(lineToX, lineToY); context.stroke();
                     context.beginPath(); context.moveTo(tox, toy);
                     context.lineTo(tox - headlen * Math.cos(angle - Math.PI / 7), toy - headlen * Math.sin(angle - Math.PI / 7));
                     context.lineTo(tox - headlen * Math.cos(angle + Math.PI / 7), toy - headlen * Math.sin(angle + Math.PI / 7));
                     context.closePath(); context.fill();
                };
                drawArrowLocal(annotation.startX, annotation.startY, annotation.endX, annotation.endY, annotation.thickness || 5);
            } else if (type === 'box') { context.strokeStyle = '#c0392b'; context.lineWidth = annotation.thickness || 5; context.strokeRect(annotation.x, annotation.y, annotation.width, annotation.height); }
            context.restore();
        };
        const createAnnotatedImageBlob = (originalSrc, annotationsData) => new Promise((resolve, reject) => {
            const img = new Image(); img.crossOrigin = 'anonymous'; img.src = originalSrc;
            img.onload = () => {
                tempCanvas.width = img.width; tempCanvas.height = img.height; tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height); tempCtx.drawImage(img, 0, 0);
                annotationsData.forEach(annotation => drawAnnotationOnContext(tempCtx, img.width, img.height, annotation));
                tempCanvas.toBlob(blob => {
                    if (blob) { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.readAsArrayBuffer(blob); }
                    else { reject(new Error('La conversion de l\'image annot√©e en Blob a √©chou√©.')); }
                }, 'image/jpeg', 0.9);
            };
            img.onerror = e => reject(new Error(`Impossible de charger l\'image de base pour l\'annotation: ${e.message}`));
        });
        const checkCoherence = () => {
            const formData = JSON.parse(localStorage.getItem('oiFormData') || '{}'); const getVal = id => formData[id] || '';
            const alerts = []; const members = (formData.patracdvr_rows || []).flatMap(row => row.members);
            const allAssignedMembers = members.filter(m => m.cellule && m.cellule.toLowerCase() !== 'sans');
            const [indiaMembers, aoMembers] = [allAssignedMembers.filter(m => m.cellule.toLowerCase().startsWith('india')), allAssignedMembers.filter(m => m.cellule.toLowerCase().startsWith('ao'))];
            if (!getVal('date_op')) alerts.push("La **Date de l'op√©ration** est manquante.");
            if (!getVal('nom_adversaire')) alerts.push("Le **Nom de l'adversaire** est manquant. (Onglet 2)");
            allAssignedMembers.forEach(m => {
                if (m.armement === 'Sans' && m.fonction !== 'Sans') alerts.push(`Membre **${m.trigramme}** est assign√© mais n'a **AUCUN armement principal**. (Cellule: ${m.cellule})`);
                if (m.fonction.toLowerCase() === 'effrac' && m.equipement !== 'EFFRAC') alerts.push(`Le membre **${m.trigramme}** (Effrac) n'a **PAS l'√©quipement EFFRAC** s√©lectionn√©.`);
            });
            const chefInter = allAssignedMembers.find(m => m.fonction === 'Chef inter');
            if (chefInter && !chefInter.cellule.toLowerCase().startsWith('india')) alerts.push(`Le **Chef inter** (${chefInter.trigramme}) est assign√© √† la cellule **${chefInter.cellule}** au lieu d'India.`);
            if (!formData.time_events || formData.time_events.length < 3) alerts.push(`La **Chronologie** (T0, T1, T4...) est incompl√®te. Au moins 3 √©tapes sont recommand√©es. (Onglet 5)`);
            else if (!formData.time_events.find(e => e.type === 'T4')) alerts.push("Le **TOP ACTION (T4)** n'est pas d√©fini dans la chronologie.");
            const unassignedCount = (formData.patracdvr_unassigned || []).length;
            if (unassignedCount > 0) alerts.push(`**${unassignedCount} membres** ne sont **PAS assign√©s** √† un v√©hicule/√©quipe.`);
            coherenceAlertsContainer.innerHTML = '';
            alerts.forEach(t => { const div = document.createElement('div'); div.className = 'coherence-alert'; div.innerHTML = `<span class="material-symbols-outlined">warning</span> ${t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}`; coherenceAlertsContainer.appendChild(div); });
            if (!alerts.length) coherenceAlertsContainer.innerHTML = `<div class="coherence-alert" style="background-color: var(--success-green); color: white;"><span class="material-symbols-outlined">check_circle</span> Aucune incoh√©rence majeure d√©tect√©e. Pr√™t √† g√©n√©rer.</div>`;
            recapFinalisation.innerHTML = `<h4>Synth√®se des √âl√©ments Cl√©s :</h4><ul><li>**Op√©ration** du ${getVal('date_op') || 'N/A'} - H: ${getVal('heure_execution') || 'N/A'}</li><li>**Objectif** : ${getVal('nom_adversaire') || 'N/A'} (${getVal('domicile_adversaire').split('\n')[0] || 'N/A'})</li><li>**√âquipe INDIA** : ${indiaMembers.map(m => m.trigramme).join(', ') || 'N/A'}</li><li>**√âquipe AO** : ${aoMembers.map(m => m.trigramme).join(', ') || 'N/A'}</li><li>**Hypoth√®ses** : H1 (${getVal('hypothese_h1').substring(0, 30)}...)</li></ul>`;
            return !alerts.length;
        };
        const generateGeminiAnalysis = async reports => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) { retexStatus.textContent = "Erreur: Cl√© API Gemini non configur√©e. Allez dans Param√®tres."; return null; }
            const formattedReports = reports.map(r => JSON.stringify(r, null, 2)).join('\n\n--- Rapport suivant ---\n\n');
            const prompt = `Tu es un analyste tactique de la Gendarmerie Fran√ßaise. Ton r√¥le est de synth√©tiser des rapports de retour d'exp√©rience (RETEX) suite √† des op√©rations de police judiciaire. L'objectif est de produire une analyse impartiale et objective, en te basant uniquement sur les faits rapport√©s, sans √©mettre de jugement personnel.\n**T√¢che:** Prends en compte les comptes-rendus RETEX fournis ci-dessous. Identifie les points cl√©s et les enseignements √† tirer de l'op√©ration. Classe et structure ta synth√®se en trois sections principales, chacune avec des sous-sections claires: 1.  **Points Forts:** (Coordination, Mat√©riel/√âquipement, Tactique) 2.  **Points Faibles:** (Communication, Pr√©paration, Ex√©cution) 3.  **Axe d'Am√©lioration:** (Formation, Proc√©dure, √âquipement).\n**Contenu des rapports RETEX:** ${formattedReports}\n**Format de la r√©ponse:** Utilise le format Markdown pour ta r√©ponse. Respecte scrupuleusement les en-t√™tes et sous-en-t√™tes demand√©s. Ne te base que sur les informations que je te donne et ne sp√©cule pas sur des √©l√©ments ext√©rieurs. S'il n'y a pas d'informations pour une section, √©cris "RAS" (Rien √Ä Signaler). Reste professionnel et factuel. N'utilise pas de phrases trop longues. Commence ta r√©ponse par "### Rapport d'Analyse Op√©rationnelle".`;
            try {
                retexStatus.textContent = "Analyse en cours par l'IA...";
                const response = await fetch(GEMINI_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-goog-api-key': apiKey }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                if (!response.ok) { throw new Error(`Erreur API: ${response.status} - ${JSON.stringify(await response.json())}`); }
                const textOutput = (await response.json())?.candidates?.[0]?.content?.parts?.[0]?.text;
                retexStatus.textContent = "Analyse termin√©e."; return textOutput ? marked.parse(textOutput) : "<p>Aucune r√©ponse significative de l'IA.</p>";
            } catch (error) { retexStatus.textContent = `Erreur: ${error.message}`; console.error("Erreur lors de la g√©n√©ration de l'analyse:", error); return null; }
        };
        const generateRetexPdf = async () => {
            if (typeof window.jspdf === 'undefined' || typeof window.html2canvas === 'undefined') { alert("Erreur: Les biblioth√®ques de g√©n√©ration PDF ne sont pas charg√©es."); return; }
            const btn = document.getElementById('generateRetexPdfBtn'); const originalText = btn.textContent; btn.textContent = 'G√©n√©ration PDF en cours...'; btn.disabled = true;
            try {
                const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'pt', 'a4', true); const content = document.getElementById('retex_output');
                const originalDisplay = content.style.display; content.style.display = 'block';
                const canvas = await html2canvas(content, { scale: 2, logging: false, useCORS: true }); content.style.display = originalDisplay;
                const [imgData, imgWidth, pageHeight] = [canvas.toDataURL('image/jpeg', 1.0), 550, 842];
                const imgHeight = canvas.height * imgWidth / canvas.width; let heightLeft = imgHeight; let position = 0; const margin = 20;
                doc.addImage(imgData, 'JPEG', margin, margin, imgWidth, imgHeight); heightLeft -= pageHeight;
                while (heightLeft >= 0) { position = heightLeft - imgHeight; doc.addPage(); doc.addImage(imgData, 'JPEG', margin, position + margin, imgWidth, imgHeight); heightLeft -= pageHeight; }
                doc.save('Rapport_Retex.pdf'); retexStatus.textContent = 'Rapport PDF g√©n√©r√© et t√©l√©charg√©.';
            } catch (error) { console.error("Erreur lors de la g√©n√©ration du PDF RETEX:", error); alert("Une erreur est survenue lors de la g√©n√©ration du PDF du rapport. Consultez la console (F12)."); }
            finally { btn.textContent = originalText; btn.disabled = false; }
        };
        const getAdversaryImageInfo = formData => {
            const mainPhotoWrapper = document.querySelector('#adversary_photo_container .photo-input-wrapper');
            if (mainPhotoWrapper) {
                const previewImg = mainPhotoWrapper.querySelector('.image-preview'); const previewId = previewImg?.id;
                if (previewId && formData[previewId + '_original_src']) return { imageSource: formData[previewId + '_src'], originalSrc: formData[previewId + '_original_src'], annotationsJson: formData[previewId + '_annotations'] || '[]' };
            }
            return null;
        };
        const processImage = (imageSrc, originalSrc, annotationsJson, maxWidth = 1280, quality = 0.85) => new Promise((resolve, reject) => {
            const annotations = JSON.parse(annotationsJson || '[]');
            if (annotations.length > 0 && originalSrc) { createAnnotatedImageBlob(originalSrc, annotations).then(resolve).catch(reject); }
            else {
                const img = new Image(); img.crossOrigin = 'anonymous'; let srcToLoad = imageSrc || originalSrc;
                if (!srcToLoad || !srcToLoad.startsWith('data:image')) { return reject(new Error('Source d\'image invalide ou manquante.')); }
                img.src = srcToLoad;
                img.onload = () => {
                    const [canvas, ctx] = [document.createElement('canvas'), document.createElement('canvas').getContext('2d')]; let { width, height } = img;
                    if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                    canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(blob => {
                        if (!blob) return reject(new Error('La conversion de l\'image a √©chou√©.'));
                        blob.arrayBuffer().then(resolve).catch(reject);
                    }, 'image/jpeg', quality);
                };
                img.onerror = (err) => { reject(new Error(`Impossible de charger l'image: ${err.message}`)); };
            }
        });
        const buildPdf = async () => {
            const { PDFDocument, StandardFonts, rgb, PageSizes } = PDFLib; const pdfDoc = await PDFDocument.create(); let helveticaFont, helveticaBoldFont;
            try { helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica); helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold); }
            catch (e) { helveticaFont = helveticaBoldFont = { widthOfTextAtSize: (text, size) => text.length * size / 2 }; }
            saveFormData(); const formData = JSON.parse(localStorage.getItem('oiFormData') || '{}'); if (!formData) { alert("Aucune donn√©e √† g√©n√©rer."); return null; }
            const [getVal, isDarkMode] = [id => formData[id] || '', document.body.classList.contains('dark-mode')];
            const context = { pdfDoc, helveticaFont, helveticaBoldFont, currentPage: null, y: 0, pageWidth: 0, pageHeight: 0, margin: 40, colors: isDarkMode ? { background: rgb(30 / 255, 30 / 255, 30 / 255), text: rgb(1, 1, 1), accent: rgb(91 / 255, 155 / 255, 213 / 255), danger: rgb(192 / 255, 57 / 255, 43 / 255) } : { background: rgb(1, 1, 1), text: rgb(0, 0, 0), accent: rgb(0, 51 / 255, 160 / 255), danger: rgb(192 / 255, 57 / 255, 43 / 255) } };
            let backgroundImage = null; try { const bgImageBytes = await fetch('Fd.png').then(res => res.arrayBuffer()); backgroundImage = await pdfDoc.embedPng(bgImageBytes); } catch (e) { console.warn("L'image de fond 'Fd.png' n'a pas pu √™tre charg√©e.", e); }
            const addNewPage = () => { context.currentPage = context.pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]); const { width, height } = context.currentPage.getSize(); context.pageWidth = width; context.pageHeight = height; context.y = height - context.margin; context.currentPage.drawRectangle({ x: 0, y: 0, width, height, color: context.colors.background }); };
            const checkY = (spaceNeeded) => { if (context.y - spaceNeeded < context.margin) { addNewPage(); return true; } return false; };
            const drawTitle = (text) => { checkY(30); context.currentPage.drawText(text, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 18, color: context.colors.accent }); context.y -= 30; };
            const drawSubTitle = (text) => { if (checkY(25)) { context.y -= 10; } context.currentPage.drawText(text, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 14, color: context.colors.accent }); context.y -= 25; };
            const wrapText = (text, font, size, maxWidth) => { const words = String(text || '').replace(/\n/g, ' \n ').split(' '); let lines = []; let currentLine = ''; for (const word of words) { if (word === '\n') { lines.push(currentLine); currentLine = ''; continue; } const lineWithWord = currentLine === '' ? word : `${currentLine} ${word}`; if (font.widthOfTextAtSize(lineWithWord, size) > maxWidth && currentLine !== '') { lines.push(currentLine); currentLine = word; } else { currentLine = lineWithWord; } } lines.push(currentLine); return lines; };
            const drawWrappedText = (text, options = {}) => {
                const { font = helveticaFont, size = 12, color = context.colors.text, x = context.margin + 15 } = options; const maxWidth = context.pageWidth - x - context.margin;
                const lines = wrapText(text, font, size, maxWidth); const totalHeight = lines.length * (size + 4);
                if (checkY(totalHeight + 10)) { context.y -= (size + 4); }
                lines.forEach((line, index) => { context.currentPage.drawText(line, { x, y: context.y - (index * (size + 4)), font, size, color }); }); context.y -= (totalHeight + 10);
            };
            const drawTable = (headers, rows, columnWidths, startX) => {
                let currentY = context.y; const [rowPadding, headerFontSize, contentFontSize] = [5, 10, 10];
                const drawRow = (rowData, isHeader) => {
                    const font = isHeader ? helveticaBoldFont : helveticaFont; const size = isHeader ? headerFontSize : contentFontSize;
                    const cellContents = rowData.map((text, i) => wrapText(text, font, size, columnWidths[i] - 2 * rowPadding));
                    const maxLines = Math.max(...cellContents.map(lines => lines.length));
                    const rowHeight = maxLines * (size + 2) + 2 * rowPadding;
                    if (currentY - rowHeight < context.margin) { addNewPage(); currentY = context.y; drawRow(headers, true); }
                    currentY -= rowHeight; let currentX = startX;
                    rowData.forEach((_, i) => {
                        context.currentPage.drawRectangle({ x: currentX, y: currentY, width: columnWidths[i], height: rowHeight, borderColor: context.colors.accent, borderWidth: 0.5 });
                        cellContents[i].forEach((line, lineIndex) => { context.currentPage.drawText(line, { x: currentX + rowPadding, y: currentY + rowHeight - rowPadding - (lineIndex + 1) * (size + 2) + 2, font, size, color: context.colors.text }); });
                        currentX += columnWidths[i];
                    });
                };
                drawRow(headers, true); rows.forEach(row => drawRow(row, false)); context.y = currentY - 20;
            };
            const drawImagesFromContainer = async (containerId, title) => {
                const wrappers = document.querySelectorAll(`#${containerId} .photo-input-wrapper`);
                for (let i = 0; i < wrappers.length; i++) {
                    const wrapper = wrappers[i]; const previewImg = wrapper.querySelector('.image-preview');
                    if (!previewImg || !previewImg.dataset.originalSrc) continue;
                    addNewPage();
                    try {
                        const [imageSrc, originalSrc, annotationsJson] = [previewImg.src, previewImg.dataset.originalSrc, previewImg.dataset.annotations];
                        const imageBytes = await processImage(imageSrc, originalSrc, annotationsJson); const image = await pdfDoc.embedJpg(imageBytes);
                        const { width, height } = context.currentPage.getSize(); const [paddedW, paddedH] = [width - context.margin * 2, height - context.margin * 2 - 30];
                        const scaled = image.scaleToFit(paddedW, paddedH);
                        const [x, y] = [(width - scaled.width) / 2, (height - scaled.height) / 2 + 15];
                        context.currentPage.drawImage(image, { x, y, width: scaled.width, height: scaled.height });
                        const finalTitle = wrappers.length > 1 ? `${title} (${i + 1})` : title;
                        const textWidth = helveticaBoldFont.widthOfTextAtSize(finalTitle, 14);
                        context.currentPage.drawText(finalTitle, { x: width / 2 - textWidth / 2, y: y - 20, font: helveticaBoldFont, size: 14, color: context.colors.text });
                    } catch (e) { drawTitle("Erreur d'image"); drawWrappedText(`Impossible de charger une image.\n\nErreur: ${e.message}`); }
                }
            };
            const getCompositionData = (teamPrefix) => {
                const [membersByCell, allMembers] = [{}, (formData.patracdvr_rows || []).flatMap(row => row.members)];
                allMembers.forEach(member => {
                    if (member.cellule?.toLowerCase().startsWith(teamPrefix)) { membersByCell[member.cellule] = [...(membersByCell[member.cellule] || []), member.trigramme].filter(Boolean); }
                });
                const naturalSort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                return Object.keys(membersByCell).sort(naturalSort).map(cell => ({ cell, members: membersByCell[cell] }));
            };
            const drawCompositionList = (compositionData) => {
                const [fontSize, lineHeight] = [12, 16]; if (checkY(lineHeight)) { context.y -= 10; } let currentX = context.margin + 15;
                const [cellStyle, trigrammeStyle, separatorStyle] = [{ font: helveticaBoldFont, color: context.colors.danger, size: fontSize }, { font: helveticaBoldFont, color: context.colors.text, size: fontSize }, { font: helveticaFont, color: context.colors.text, size: fontSize }];
                compositionData.forEach((group, groupIndex) => {
                    const [cellShortName, groupParts] = [group.cell.toUpperCase().replace('INDIA ', 'I').replace('AO', 'AO'), []];
                    groupParts.push({ text: cellShortName, style: cellStyle }); groupParts.push({ text: ' : ', style: separatorStyle });
                    group.members.forEach((member, memberIndex) => { groupParts.push({ text: member, style: trigrammeStyle }); if (memberIndex < group.members.length - 1) { groupParts.push({ text: ' - ', style: separatorStyle }); } });
                    if (groupIndex < compositionData.length - 1) { groupParts.push({ text: '    ', style: separatorStyle }); }
                    for (const part of groupParts) {
                        const partWidth = part.style.font.widthOfTextAtSize(part.text, part.style.size);
                        if (currentX + partWidth > context.pageWidth - context.margin) { context.y -= lineHeight; currentX = context.margin + 15; if (checkY(lineHeight)) { context.y -= 10; } }
                        context.currentPage.drawText(part.text, { x: currentX, y: context.y, ...part.style }); currentX += partWidth;
                    }
                }); context.y -= (lineHeight + 10);
            };
            const pdfCreationLogic = async () => {
                addNewPage();
                if (backgroundImage) { context.currentPage.drawImage(backgroundImage, { x: 0, y: 0, width: context.pageWidth, height: context.pageHeight }); }
                const [mainTitle, dateTitle] = ["OP√âRATION DE POLICE JUDICIAIRE", `DU ${getVal('date_op') || '(DATE)'}`];
                const [titleWidth, dateTitleWidth] = [helveticaBoldFont.widthOfTextAtSize(mainTitle, 24), helveticaBoldFont.widthOfTextAtSize(dateTitle, 18)];
                context.currentPage.drawText(mainTitle, { x: context.pageWidth / 2 - titleWidth / 2, y: context.pageHeight / 2 + 10, font: helveticaBoldFont, size: 24, color: context.colors.accent });
                context.currentPage.drawText(dateTitle, { x: context.pageWidth / 2 - dateTitleWidth / 2, y: context.pageHeight / 2 - 20, font: helveticaBoldFont, size: 18, color: context.colors.text });
                addNewPage(); drawTitle("1. SITUATION"); drawSubTitle("1.1 Situation G√©n√©rale"); drawWrappedText(getVal('situation_generale'), { size: 14 }); drawSubTitle("1.2 Situation Particuli√®re"); drawWrappedText(getVal('situation_particuliere'), { size: 14 });
                addNewPage(); drawTitle("2. ADVERSAIRE");
                const [imageInfo, photoBoxWidth, photoBoxHeight, photoBoxX, photoBoxMargin, topY] = [getAdversaryImageInfo(formData), 200, 220, context.pageWidth - context.margin - 200, 10, context.y];
                let [isImagePresent, tableStartX, tableMaxWidth, photoBottomY, tableBottomY] = [imageInfo !== null, context.margin, context.pageWidth - context.margin * 2, topY, topY];
                if (isImagePresent) { tableMaxWidth = photoBoxX - tableStartX - photoBoxMargin; }
                const [adversaireHeaders, meText] = [["Information", "D√©tail"], (formData.me_list || []).map((me, i) => `ME${i + 1}: ${me}`).join(' | ')];
                const adversaireRows = [['Nom/Pr√©nom', getVal('nom_adversaire')], ['Domicile', getVal('domicile_adversaire')], ['Naissance', `${getVal('date_naissance')} √† ${getVal('lieu_naissance')}`], ['Description', `${getVal('stature_adversaire')} / ${getVal('ethnie_adversaire')}`], ['Signes particuliers', getVal('signes_particuliers')], ['Profession', getVal('profession_adversaire')], ['Ant√©c√©dents', getVal('antecedents_adversaire')], ['√âtat d\'esprit', (formData.etat_esprit_list || []).join(', ')], ['Attitude', getVal('attitude_adversaire')], ['Volume (renfort)', (formData.volume_list || []).join(', ')], ['Substances', getVal('substances_adversaire')], ['V√©hicules', (formData.vehicules_list || []).join(', ')], ['Armes', getVal('armes_connues')], ['Moyens Employ√©s', meText], ].filter(row => row[1] && String(row[1]).trim() !== '√†');
                if (isImagePresent) {
                    const { imageSource, originalSrc, annotationsJson } = imageInfo; const frameY = topY - photoBoxHeight;
                    try {
                        const imageBytes = await processImage(imageSource, originalSrc, annotationsJson); const image = await pdfDoc.embedJpg(imageBytes);
                        const scaled = image.scaleToFit(photoBoxWidth - 10, photoBoxHeight - 30); const imageY = frameY + (photoBoxHeight - scaled.height) / 2;
                        if (frameY >= context.margin) {
                            context.currentPage.drawRectangle({ x: photoBoxX, y: frameY, width: photoBoxWidth, height: photoBoxHeight, borderColor: context.colors.accent, borderWidth: 1 });
                            context.currentPage.drawImage(image, { x: photoBoxX + (photoBoxWidth - scaled.width) / 2, y: imageY, width: scaled.width, height: scaled.height });
                            const [photoTitle, titleWidth] = ["Photo de l'objectif", helveticaFont.widthOfTextAtSize("Photo de l'objectif", 10)];
                            context.currentPage.drawText(photoTitle, { x: photoBoxX + (photoBoxWidth - titleWidth) / 2, y: frameY + 5, font: helveticaFont, size: 10, color: context.colors.text }); photoBottomY = frameY;
                        } else { isImagePresent = false; }
                    } catch (e) { const frameY = topY - photoBoxHeight; if (frameY >= context.margin) { context.currentPage.drawRectangle({ x: photoBoxX, y: frameY, width: photoBoxWidth, height: photoBoxHeight, borderColor: context.colors.danger, borderWidth: 1 }); photoBottomY = frameY; isImagePresent = false; } }
                }
                if (adversaireRows.length > 0) { context.y = topY; drawTable(adversaireHeaders, adversaireRows, [150, tableMaxWidth - 150], tableStartX); tableBottomY = context.y; } else { tableBottomY = topY; }
                context.y = Math.min(tableBottomY, photoBottomY) - 20;
                await drawImagesFromContainer('adversary_extra_photos_container', 'Photo Suppl√©mentaire - Adversaire'); await drawImagesFromContainer('renforts_photo_container', 'Photo - Renfort Potentiel');
                addNewPage(); drawTitle("3. ENVIRONNEMENT"); drawSubTitle("Ami(e)s (soutien)"); drawWrappedText(getVal('amies'), { size: 14 }); drawSubTitle("Terrain / M√©t√©o"); drawWrappedText(getVal('terrain_info'), { size: 14 }); drawSubTitle("Population"); drawWrappedText(getVal('population'), { size: 14 }); drawSubTitle("Cadre juridique"); drawWrappedText(getVal('cadre_juridique'), { size: 14 });
                addNewPage(); drawTitle("4. MISSION"); drawWrappedText(getVal('missions_psig'), { font: helveticaBoldFont, size: 30, color: context.colors.danger, x: context.margin });
                await drawImagesFromContainer('photo_container_transport_pr', 'Transport PSIG vers PR'); await drawImagesFromContainer('photo_container_transport_domicile', 'Transport PR vers Domicile'); await drawImagesFromContainer('photo_container_bapteme_terrain', 'Bapt√™me terrain');
                addNewPage(); drawTitle("5. EX√âUTION");
                const execText = `En vue d'appr√©hender le mis en cause et emp√™cher la d√©perdition des preuves,\nJe veux, le ${getVal('date_execution') || '(date)'} √† partir de ${getVal('heure_execution') || '(heure)'}, pour une action ${getVal('type_action') || '(type d\'action)'} investir le domicile\npr√©sum√© de ${getVal('nom_adversaire') || '(nom de l\'adversaire)'} apr√®s avoir boucl√© celui-ci.`;
                drawWrappedText(execText, { size: 16, x: context.margin }); drawSubTitle("Chronologie des temps");
                const [chronoHeaders, chronoRows] = [["Type", "Heure", "Description"], (formData.time_events || []).map(e => [e.type || 'N/A', e.hour || 'N/A', e.description || 'N/A'])];
                drawTable(chronoHeaders, chronoRows, [80, 120, 550], context.margin); drawSubTitle("Hypoth√®ses");
                drawWrappedText(`H1: ${getVal('hypothese_h1')}\nH2: ${getVal('hypothese_h2')}\nH3: ${getVal('hypothese_h3')}`, { size: 14, font: helveticaBoldFont, color: context.colors.danger });
                addNewPage(); drawTitle("6. ARTICULATION"); drawWrappedText(`Place du Chef (G√©n√©rale): ${getVal('place_chef')}`, { size: 14, x: context.margin });
                drawSubTitle("√âquipe INDIA (INTER)"); drawSubTitle("Composition:"); drawCompositionList(getCompositionData('india')); drawSubTitle("Mission:"); drawWrappedText(getVal('india_mission')); drawSubTitle("Objectif:"); drawWrappedText(getVal('india_objectif')); drawSubTitle("Itin√©raire:"); drawWrappedText(getVal('india_itineraire')); drawSubTitle("Points Particuliers:"); drawWrappedText(getVal('india_points_particuliers')); drawSubTitle("Conduite √† Tenir:"); drawWrappedText(getVal('india_cat'));
                await drawImagesFromContainer('photo_container_itineraire_exterieur', 'Itin√©raire Ext√©rieur India'); await drawImagesFromContainer('photo_container_itineraire_interieur', 'Itin√©raire Int√©rieur India'); await drawImagesFromContainer('photo_container_cellule_effraction', 'Cellule Effraction');
                addNewPage(); drawTitle("6. ARTICULATION (Suite)"); drawSubTitle("√âquipe Appui/Observation (AO) - ZMSPCP"); drawSubTitle("Composition:"); drawCompositionList(getCompositionData('ao')); drawSubTitle("Zone d'installation (Z):"); drawWrappedText(getVal('ao_zone_installation')); drawSubTitle("Mission (M):"); drawWrappedText(getVal('ao_mission')); drawSubTitle("Secteur de surveillance (S):"); drawWrappedText(getVal('ao_secteur_surveillance')); drawSubTitle("Points Particuliers (P):"); drawWrappedText(getVal('ao_points_particuliers')); drawSubTitle("Place du Chef (P):"); drawWrappedText(getVal('ao_place_chef')); drawSubTitle("Conduite √† Tenir (C):"); drawWrappedText(getVal('ao_cat'));
                await drawImagesFromContainer('photo_container_emplacement_ao', 'Emplacement AO');
                addNewPage(); drawTitle("7. PATRACDVR");
                const patracHeaders = ["Trigramme", "Fonction", "Cellule", "Armement", "√âquip. 1", "√âquip. 2", "Tenue", "GPB"];
                for (const row of (formData.patracdvr_rows || [])) { if (row.vehicle && row.members.length > 0) { drawSubTitle(`V√©hicule: ${row.vehicle}`); const patracRows = row.members.filter(m => m.trigramme).map(m => [m.trigramme, m.fonction, m.cellule, m.armement, m.equipement, m.equipement2, m.tenue, m.gpb]); if (patracRows.length > 0) { drawTable(patracHeaders, patracRows, [80, 90, 90, 90, 90, 90, 80, 80], context.margin); } } }
                addNewPage(); drawTitle("9. Conduites √† tenir"); drawSubTitle("G√©n√©rales"); drawWrappedText(getVal('cat_generales'), { x: context.margin, font: helveticaBoldFont });
                const noGoText = getVal('no_go'); if (noGoText) { drawSubTitle("NO GO"); drawWrappedText(noGoText, { x: context.margin, font: helveticaBoldFont, size: 14.4, color: context.colors.danger }); }
                drawSubTitle("Liaison"); drawWrappedText(getVal('cat_liaison'), { x: context.margin, font: helveticaBoldFont });
                const [dateOp, nomAdversaire] = [getVal('date_op'), getVal('nom_adversaire')];
                if (dateOp && nomAdversaire) {
                    const safeAdversaireName = nomAdversaire.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, ''); const oiId = `${dateOp}_${safeAdversaireName}`;
                    const retexUrl = `${RETEX_BASE_URL}?oiId=${encodeURIComponent(oiId)}`; addNewPage();
                    const operationTitle = getVal('nom_adversaire') || 'OPERATION'; drawTitle(`RETEX: ${operationTitle.toUpperCase()}`);
                    drawWrappedText("Chaque membre ayant particip√© √† l'op√©ration est tenu de remplir le formulaire de Retour d'Exp√©rience (Retex) en utilisant le lien ci-dessous.", { size: 14, x: context.margin });
                    context.y -= 40; context.currentPage.drawText(retexUrl, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 14, color: context.colors.accent, A: { URI: retexUrl } }); context.y -= 20;
                }
                addNewPage(); if (backgroundImage) { context.currentPage.drawImage(backgroundImage, { x: 0, y: 0, width: context.pageWidth, height: context.pageHeight }); }
                const [finalText, finalTextWidth] = ["Avez vous des questions?", helveticaBoldFont.widthOfTextAtSize("Avez vous des questions?", 48)];
                context.currentPage.drawText(finalText, { x: context.pageWidth / 2 - finalTextWidth / 2, y: context.pageHeight / 2, font: helveticaBoldFont, size: 48, color: context.colors.accent });
            };
            await pdfCreationLogic();
            return { pdfBytes: await pdfDoc.save(), formData };
        };
        const buildPresentationHtml = async () => {
            saveFormData(); const formData = JSON.parse(localStorage.getItem('oiFormData') || '{}'); if (!formData) { return "<h2>Aucune donn√©e √† pr√©senter.</h2>"; }
            const [getVal, isDarkMode] = [id => formData[id] || '', document.body.classList.contains('dark-mode')];
            const [accentColor, primaryText, secondaryText, dangerColor] = [isDarkMode ? '#5b9bd5' : '#0033a0', isDarkMode ? '#e0e0e0' : '#212529', isDarkMode ? '#95a5a6' : '#6c757d', '#c0392b'];
            const wrapHtml = (text, tag = 'p', style = {}) => `<${tag} style="${Object.entries(style).map(([k, v]) => `${k}:${v}`).join(';')}">${String(text || '').replace(/\*\*/g, '').replace(/\n/g, '<br>')}</${tag}>`;
            const [drawTitleHtml, drawSubTitleHtml, drawTextHtml] = [
                text => wrapHtml(text, 'h2', { 'color': accentColor, 'font-size': '1.8em', 'margin-top': '20px', 'padding-bottom': '5px', 'border-bottom': `2px solid ${accentColor}` }),
                text => wrapHtml(text, 'h3', { 'color': accentColor, 'font-size': '1.3em', 'margin-top': '15px', 'margin-bottom': '10px' }),
                (text, bold = false, color = primaryText, size = '1.1em', indent = '15px') => wrapHtml(text, 'p', { 'font-weight': bold ? '500' : '400', 'color': color, 'font-size': size, 'margin-bottom': '8px', 'padding-left': indent, 'white-space': 'pre-wrap' })
            ];
            const drawTableHtml = (headers, rows) => {
                let table = `<table style="width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 20px;"><thead style="background-color: ${accentColor}; color: white;"><tr>`;
                headers.forEach(h => { table += `<th style="padding: 10px; border: 1px solid ${primaryText}; text-align: left;">${h}</th>`; }); table += `</tr></thead><tbody>`;
                rows.forEach(row => { table += `<tr style="background-color: ${isDarkMode ? '#2a2a2a' : '#f8f9fa'};">`; row.forEach(cell => { table += `<td style="padding: 10px; border: 1px solid ${secondaryText}; vertical-align: top;">${String(cell || '').replace(/\*\*/g, '').replace(/\n/g, '<br>')}</td>`; }); table += `</tr>`; });
                return table + `</tbody></table>`;
            };
            const drawImageHtml = async (id, title) => {
                let imageHtml = ''; const wrappers = document.querySelectorAll(`#${id} .photo-input-wrapper`);
                for (let i = 0; i < wrappers.length; i++) {
                    const [wrapper, previewImg] = [wrappers[i], wrappers[i].querySelector('.image-preview')]; if (!previewImg?.dataset.originalSrc) continue;
                    const [originalSrc, annotations] = [previewImg.dataset.originalSrc, JSON.parse(previewImg.dataset.annotations || '[]')]; let dataSrcToDisplay = originalSrc;
                    if (annotations.length > 0) { try { dataSrcToDisplay = `data:image/jpeg;base64,${btoa(new Uint8Array(await createAnnotatedImageBlob(originalSrc, annotations)).reduce((data, byte) => data + String.fromCharCode(byte), ''))}`; } catch (e) { console.error(`Erreur de g√©n√©ration d'image annot√©e pour ${title} (index ${i}):`, e); dataSrcToDisplay = originalSrc; } }
                    const finalTitle = wrappers.length > 1 ? `${title} (${i + 1})` : title;
                    imageHtml += `<div class="image-container" style="text-align: center; margin: 20px 0; border: 1px solid ${accentColor}; padding: 10px; background-color: ${isDarkMode ? '#1e1e1e' : '#ffffff'};"><h4 style="color: ${accentColor}; margin-bottom: 10px; font-size: 1.1em;">${finalTitle}</h4><img src="${dataSrcToDisplay}" alt="${finalTitle}" style="max-width: 100%; height: auto; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,${isDarkMode ? 0.4 : 0.1});"></div>`;
                }
                return imageHtml;
            };
            const getCompositionHtml = (teamPrefix) => {
                const [membersByCell, allMembers] = [{}, (formData.patracdvr_rows || []).flatMap(row => row.members)];
                allMembers.forEach(member => { if (member.cellule?.toLowerCase().startsWith(teamPrefix)) { membersByCell[member.cellule] = [...(membersByCell[member.cellule] || []), `<span style="color: ${primaryText};">${member.trigramme}</span>` + (member.fonction && member.fonction !== 'Sans' ? ` (${member.fonction})` : '')]; } });
                const naturalSort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                let compositionHtml = '<div style="padding-left: 15px; margin-bottom: 15px;">';
                Object.keys(membersByCell).sort(naturalSort).forEach(cell => { compositionHtml += `<p style="margin-bottom: 5px;"><strong style="color: ${dangerColor}; font-size: 1.1em;">${cell.toUpperCase()}</strong> : ${membersByCell[cell].join(', ')}</p>`; });
                return Object.keys(membersByCell).length > 0 ? compositionHtml + '</div>' : drawTextHtml('Aucun membre assign√©.', false, secondaryText);
            };
            let htmlContent = `<div style="font-family: 'Oswald', sans-serif; color: ${primaryText};">`;
            htmlContent += drawTitleHtml(`Ordre Initial - ${getVal('nom_adversaire') || 'OP√âRATION'}`); htmlContent += drawTextHtml(`Date de l'op√©ration : ${getVal('date_op') || 'N/A'}`, true, primaryText, '1.2em', '0');
            htmlContent += drawTitleHtml("1. SITUATION"); htmlContent += drawSubTitleHtml("1.1 Situation G√©n√©rale"); htmlContent += drawTextHtml(getVal('situation_generale')); htmlContent += drawSubTitleHtml("1.2 Situation Particuli√®re"); htmlContent += drawTextHtml(getVal('situation_particuliere'));
            htmlContent += drawTitleHtml("2. ADVERSAIRE"); htmlContent += await drawImageHtml('adversary_photo_container', "Photo de l'objectif");
            const [meText, adversaireRows] = [(formData.me_list || []).map((me, i) => `ME${i + 1}: ${me}`).join(' | '), [['Nom/Pr√©nom', getVal('nom_adversaire')], ['Domicile', getVal('domicile_adversaire')], ['Naissance', `${getVal('date_naissance')} √† ${getVal('lieu_naissance')}`], ['Description', `${getVal('stature_adversaire')} / ${getVal('ethnie_adversaire')}`], ['Signes particuliers', getVal('signes_particuliers')], ['Profession', getVal('profession_adversaire')], ['Ant√©c√©dents', getVal('antecedents_adversaire')], ['√âtat d\'esprit', (formData.etat_esprit_list || []).join(', ')], ['Attitude (connue)', getVal('attitude_adversaire')], ['Volume (renfort)', (formData.volume_list || []).join(', ')], ['Substances', getVal('substances_adversaire')], ['V√©hicules', (formData.vehicules_list || []).join(', ')], ['Armes connues', getVal('armes_connues')], ['Moyens Employ√©s', meText], ].filter(row => row[1] && String(row[1]).trim() !== '√†')];
            htmlContent += adversaireRows.length > 0 ? drawTableHtml(["Information", "D√©tail"], adversaireRows) : drawTextHtml("Aucune information d√©taill√©e sur l'adversaire.");
            htmlContent += await drawImageHtml('adversary_extra_photos_container', 'Photo Suppl√©mentaire - Adversaire'); htmlContent += await drawImageHtml('renforts_photo_container', 'Photo - Renfort Potentiel');
            htmlContent += drawTitleHtml("3. ENVIRONNEMENT"); htmlContent += drawSubTitleHtml("Ami(e)s (soutien)"); htmlContent += drawTextHtml(getVal('amies')); htmlContent += drawSubTitleHtml("Terrain / M√©t√©o"); htmlContent += drawTextHtml(getVal('terrain_info')); htmlContent += drawSubTitleHtml("Population"); htmlContent += drawTextHtml(getVal('population')); htmlContent += drawSubTitleHtml("Cadre juridique"); htmlContent += drawTextHtml(getVal('cadre_juridique'));
            htmlContent += drawTitleHtml("4. MISSION DU PSIG"); htmlContent += drawTextHtml(getVal('missions_psig'), true, dangerColor, '1.6em', '0');
            htmlContent += drawTitleHtml("5. EX√âCUTION");
            htmlContent += wrapHtml(`En vue d'appr√©hender le mis en cause et emp√™cher la d√©perdition des preuves,<br>Je veux, le ${getVal('date_execution') || '(date)'} √† partir de ${getVal('heure_execution') || '(heure)'}, pour une action ${getVal('type_action') || '(type d\'action)'} investir le domicile<br>pr√©sum√© de ${getVal('nom_adversaire') || '(nom de l\'adversaire)'} apr√®s avoir boucl√© celui-ci.`, 'p', { 'font-size': '1.4em', 'margin-bottom': '15px', 'padding-left': '0' });
            htmlContent += drawSubTitleHtml("Chronologie des temps");
            htmlContent += drawTableHtml(["Type", "Heure", "Description"], (formData.time_events || []).map(e => [e.type || 'N/A', e.hour || 'N/A', e.description || 'N/A']));
            htmlContent += drawSubTitleHtml("Hypoth√®ses");
            htmlContent += drawTextHtml(`<span style="color: ${dangerColor}; font-weight: bold;">H1</span>: ${getVal('hypothese_h1')}<br><span style="color: ${dangerColor}; font-weight: bold;">H2</span>: ${getVal('hypothese_h2')}<br><span style="color: ${dangerColor}; font-weight: bold;">H3</span>: ${getVal('hypothese_h3')}`, true, primaryText, '1.2em');
            htmlContent += await drawImageHtml('photo_container_transport_pr', 'Transport PSIG vers PR'); htmlContent += await drawImageHtml('photo_container_transport_domicile', 'Transport PR vers Domicile'); htmlContent += await drawImageHtml('photo_container_bapteme_terrain', 'Bapt√™me terrain');
            htmlContent += drawTitleHtml("6. ARTICULATION (MOIPC/ZMSPCP)"); htmlContent += drawTextHtml(`Place du Chef (G√©n√©rale): ${getVal('place_chef')}`, true, primaryText, '1.2em', '0');
            htmlContent += drawSubTitleHtml(`<span style="color: ${accentColor}; font-weight: bold;">√âquipe INDIA (INTER)</span>`);
            htmlContent += wrapHtml('<strong style="color: ' + accentColor + ';">Composition:</strong>', 'h4', { 'padding-left': '15px', 'margin-top': '10px', 'font-size': '1.1em' }); htmlContent += getCompositionHtml('india');
            htmlContent += `<p style="padding-left:15px; margin-bottom: 8px;"><span style="color: ${dangerColor}; font-weight: bold;">M</span>ission : ${getVal('india_mission')}<br><span style="color: ${dangerColor}; font-weight: bold;">O</span>bjectif : ${getVal('india_objectif')}<br><span style="color: ${dangerColor}; font-weight: bold;">I</span>tin√©raire : ${getVal('india_itineraire')}<br><span style="color: ${dangerColor}; font-weight: bold;">P</span>oints Particuliers : ${getVal('india_points_particuliers')}<br><span style="color: ${dangerColor}; font-weight: bold;">C</span>onduite √† Tenir : ${getVal('india_cat')}</p>`;
            htmlContent += await drawImageHtml('photo_container_itineraire_exterieur', 'Itin√©raire Ext√©rieur India'); htmlContent += await drawImageHtml('photo_container_itineraire_interieur', 'Itin√©raire Int√©rieur India'); htmlContent += await drawImageHtml('photo_container_cellule_effraction', 'Cellule Effraction');
            htmlContent += drawTitleHtml("6. ARTICULATION (Suite)"); htmlContent += drawSubTitleHtml(`<span style="color: ${accentColor}; font-weight: bold;">√âquipe Appui/Observation (AO) - ZMSPCP</span>`);
            htmlContent += wrapHtml('<strong style="color: ' + accentColor + ';">Composition:</strong>', 'h4', { 'padding-left': '15px', 'margin-top': '10px', 'font-size': '1.1em' }); htmlContent += getCompositionHtml('ao');
            htmlContent += `<p style="padding-left:15px; margin-bottom: 8px;"><span style="color: ${dangerColor}; font-weight: bold;">Z</span>one d'installation : ${getVal('ao_zone_installation')}<br><span style="color: ${dangerColor}; font-weight: bold;">M</span>ission : ${getVal('ao_mission')}<br><span style="color: ${dangerColor}; font-weight: bold;">S</span>ecteur de surveillance : ${getVal('ao_secteur_surveillance')}<br><span style="color: ${dangerColor}; font-weight: bold;">P</span>oints Particuliers : ${getVal('ao_points_particuliers')}<br><span style="color: ${dangerColor}; font-weight: bold;">C</span>onduite √† Tenir : ${getVal('ao_cat')}<br><span style="color: ${dangerColor}; font-weight: bold;">P</span>lace du Chef : ${getVal('ao_place_chef')}</p>`;
            htmlContent += await drawImageHtml('photo_container_emplacement_ao', 'Emplacement AO');
            htmlContent += drawTitleHtml("7. PATRACDVR (D√©tail de la Composition)");
            const patracHeaders = ["Trigramme", "Fonction", "Cellule", "Armement", "√âquip. 1", "√âquip. 2", "Tenue", "GPB"];
            for (const row of (formData.patracdvr_rows || [])) { if (row.vehicle && row.members.length > 0) { htmlContent += drawSubTitleHtml(`V√©hicule: ${row.vehicle}`); htmlContent += drawTableHtml(patracHeaders, row.members.filter(m => m.trigramme).map(m => [m.trigramme, m.fonction, m.cellule, m.armement, m.equipement, m.equipement2, m.tenue, m.gpb])); } }
            htmlContent += drawTitleHtml("9. CONDUITES √Ä TENIR"); htmlContent += drawSubTitleHtml("G√©n√©rales"); htmlContent += drawTextHtml(getVal('cat_generales'), true);
            const noGoText = getVal('no_go'); if (noGoText) { htmlContent += drawSubTitleHtml("NO GO"); htmlContent += drawTextHtml(noGoText, true, dangerColor, '1.2em'); }
            htmlContent += drawSubTitleHtml("Liaison"); htmlContent += drawTextHtml(getVal('cat_liaison'), true);
            const [dateOp, nomAdversaire] = [getVal('date_op'), getVal('nom_adversaire')];
            if (dateOp && nomAdversaire) { const retexUrl = `${RETEX_BASE_URL}?oiId=${encodeURIComponent(`${dateOp}_${nomAdversaire.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '')}`)}`; htmlContent += drawTitleHtml("LIEN RETEX"); htmlContent += drawTextHtml("Lien d'acc√®s au formulaire de Retour d'Exp√©rience:", false); htmlContent += wrapHtml(`<a href="${retexUrl}" target="_blank" style="color: ${accentColor}; font-weight: bold; font-size: 1.1em; text-decoration: none;">${retexUrl}</a>`, 'p', { 'padding-left': '15px' }); }
            return htmlContent + `</div>`;
        };
    </script>
</body>
</html>
