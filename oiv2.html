<!DOCTYPE html>
<html lang="fr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Praxis</title>
Â  Â  <link rel="icon" href="maskable_icon(2).png" sizes="any" type="image/png">
Â  Â  <link rel="icon" href="maskable_icon(2).png" type="image/svg+xml">
Â  Â  <link rel="apple-touch-icon" href="maskable_icon(2).png">
Â  Â  <link rel="manifest" href="site.webmanifest">
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-body: #121212; --bg-container: #1e1e1e; --bg-interactive: #2a2a2a;
Â  Â  Â  Â  Â  Â  --text-primary: #e0e0e0; --text-secondary: #95a5a6; --border-color: #444444;
Â  Â  Â  Â  Â  Â  --accent-blue: #5b9bd5; --accent-hover: #4a7aa5; --danger-red: #c0392b;
Â  Â  Â  Â  Â  Â  --success-green: #27ae60;
Â  Â  Â  Â  }
Â  Â  Â  Â  body.light-mode {
Â  Â  Â  Â  Â  Â  --bg-body: #f0f2f5; --bg-container: #ffffff; --bg-interactive: #f8f9fa;
Â  Â  Â  Â  Â  Â  --text-primary: #212529; --text-secondary: #6c757d; --accent-blue: #0033a0;
Â  Â  Â  Â  Â  Â  --border-color: #dee2e6;
Â  Â  Â  Â  }
Â  Â  Â  Â  * { box-sizing: border-box; margin: 0; padding: 0; }
Â  Â  Â  Â  html { font-size: 16px; }
Â  Â  Â  Â  body { font-family: 'Oswald', sans-serif; background-color: var(--bg-body); color: var(--text-primary); line-height: 1.6; padding: 10px; padding-bottom: 90px; transition: background-color 0.3s, color 0.3s; }
Â  Â  Â  Â  .container { width: 100%; max-width: 800px; margin: auto; background: var(--bg-container); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
Â  Â  Â  Â  h1 { font-size: 1.8em; margin-bottom: 20px; color: var(--accent-blue); font-family: 'Oswald', sans-serif; font-weight: 500; text-align: center; }
Â  Â  Â  Â  h2 { font-size: 1.4em; color: var(--accent-blue); border-bottom: 2px solid var(--accent-blue); padding-bottom: 10px; margin-top: 20px; }
Â  Â  Â  Â  h3 { font-size: 1.1em; color: var(--text-primary); margin-top: 15px; margin-bottom: 10px; }
Â  Â  Â  Â  h4 { font-size: 1.0em; color: var(--text-secondary); margin-top: 10px; margin-bottom: 5px; }
Â  Â  Â  Â  
Â  Â  Â  Â  .wizard-progress {Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 25px; list-style-type: none; padding: 0;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .wizard-progress-step {
Â  Â  Â  Â  Â  Â  flex-grow: 1; padding: 8px 12px; text-align: center; font-size: 0.85em;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary); background-color: var(--bg-interactive);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, color 0.2s, border-color 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .wizard-progress-step:hover { background-color: var(--bg-body); }
Â  Â  Â  Â  .wizard-progress-step.completed { border-color: var(--accent-blue); color: var(--accent-blue); }
Â  Â  Â  Â  .wizard-progress-step.active {
Â  Â  Â  Â  Â  Â  color: white; background-color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  border-color: var(--accent-blue); font-weight: 500;
Â  Â  Â  Â  }
Â  Â  Â  Â  .wizard-step { display: none; animation: fadeIn 0.5s; }
Â  Â  Â  Â  .wizard-step.active { display: block; }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  Â  Â  .wizard-nav { display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px; gap: 10px; }
Â  Â  Â  Â  .wizard-nav-btn { flex-grow: 1; padding: 14px 20px; border: none; border-radius: 5px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 1.1em; min-height: 48px;}

Â  Â  Â  Â  #prevBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
Â  Â  Â  Â  #nextBtn { background-color: var(--accent-blue); color: white; }
Â  Â  Â  Â  #previewBtn { background-color: #6c757d; color: white; }
Â  Â  Â  Â  #generatePdfBtn { background-color: #27ae60; color: white; }
Â  Â  Â  Â  #retexReportBtn { background-color: #008080; color: white; }
Â  Â  Â  Â  label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-secondary); }
Â  Â  Â  Â  input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1.1rem; background-color: var(--bg-interactive); color: var(--text-primary); font-family: 'Oswald', sans-serif; min-height: 48px;}
Â  Â  Â  Â  textarea { min-height: 120px; }
Â  Â  Â  Â  
Â  Â  Â  Â  .dynamic-list-item {Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; align-items: stretch;
Â  Â  Â  Â  Â  Â  gap: 10px; margin-bottom: 10px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Correction pour amÃ©liorer la lisibilitÃ© du formulaire sur mobile */
Â  Â  Â  Â  .dynamic-list-item > *:not(button) {Â 
Â  Â  Â  Â  Â  Â  flex-grow: 1;Â 
Â  Â  Â  Â  Â  Â  margin-bottom: 0;Â 
Â  Â  Â  Â  Â  Â  min-height: 48px; /* Assure que les inputs et selects sont de bonne taille */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Forcer le retour Ã  la ligne pour chaque input sur mobile */
Â  Â  Â  Â  .wizard-step .dynamic-list-item:has(#date_naissance) input {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  @media (min-width: 480px) {
Â  Â  Â  Â  Â  Â  .wizard-step .dynamic-list-item:has(#date_naissance) {
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: row;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .wizard-step .dynamic-list-item:has(#date_naissance) input {
Â  Â  Â  Â  Â  Â  Â  Â  width: auto;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  button.add-btn, button.remove-btn { min-height: 44px; }
Â  Â  Â  Â  
Â  Â  Â  Â  button.add-btn { background-color: #27ae60; color: white; border: none; border-radius: 4px; padding: 8px 12px; margin-top: 5px; cursor: pointer; }
Â  Â  Â  Â  button.remove-btn { background-color: var(--danger-red); color: white; border: none; border-radius: 4px; padding: 5px 10px; font-size: 14px; cursor: pointer; }
Â  Â  Â  Â  .collapsible-container { background-color: var(--bg-interactive); border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 15px; }
Â  Â  Â  Â  .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 15px; }
Â  Â  Â  Â  .collapsible-header h3 { margin: 0; font-size: 1.2em; }
Â  Â  Â  Â  .collapsible-header .material-symbols-outlined { transition: transform 0.3s; }
Â  Â  Â  Â  .collapsible-container.open .collapsible-header .material-symbols-outlined { transform: rotate(180deg); }
Â  Â  Â  Â  .collapsible-content { padding: 0 15px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
Â  Â  Â  Â  .collapsible-container.open .collapsible-content { max-height: 4000px; padding-top: 10px; padding-bottom: 15px; }
Â  Â  Â  Â  /* Style for articulation display */
Â  Â  Â  Â  .articulation-composition-display p { margin-bottom: 5px; }
Â  Â  Â  Â  .articulation-composition-display strong { color: var(--accent-blue); }

Â  Â  Â  Â  .dock-menu { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; padding: 10px; z-index: 1000; background-color: rgba(30, 30, 30, 0.7); border: 1px solid var(--border-color); border-radius: 35px; backdrop-filter: blur(10px); transition: all 0.3s ease-in-out; }
Â  Â  Â  Â  .dock-menu-item { display: flex; align-items: center; justify-content: center; background-color: var(--bg-container); color: var(--text-primary); border: 11px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; font-size: 28px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.2s; text-decoration: none; flex-shrink: 0; }
Â  Â  Â  Â  .dock-menu-item:hover { transform: scale(1.1); }
Â  Â  Â  Â  .dock-menu.collapsed { width: 55px; height: 55px; padding: 5px; border-radius: 50%; border: none; background-color: transparent; }
Â  Â  Â  Â  .dock-menu.collapsed .dock-menu-item:not(#dockToggleBtn) { opacity: 0; width: 0; margin-left: -10px; visibility: hidden; }
Â  Â  Â  Â  #dockToggleBtn .material-symbols-outlined { transition: transform 0.3s ease; }
Â  Â  Â  Â  .dock-menu.collapsed #dockToggleBtn .material-symbols-outlined { transform: rotate(180deg); }
Â  Â  Â  Â  .photo-input, #sessionFileInput, #jsonConfigInput { display: none; }
Â  Â  Â  Â  .file-upload-label { background-color: var(--accent-blue); color: white !important; padding: 10px 14px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s; font-family: 'Oswald', sans-serif; font-weight: normal; display: inline-block; text-align: center; flex-shrink: 0; }
Â  Â  Â  Â  .file-upload-label:hover { background-color: var(--accent-hover); }
Â  Â  Â  Â  .file-name-display { color: var(--text-secondary); font-style: italic; margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
Â  Â  Â  Â  .image-preview { max-width: 150px; max-height: 100px; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color); }
Â  Â  Â  Â  .draggable { cursor: grab; user-select: none; }
Â  Â  Â  Â  .draggable.dragging { opacity: 0.5; cursor: grabbing; }
Â  Â  Â  Â  
Â  Â  Â  Â  /* --- STYLES PATRACDVR (Mobile First) --- */
Â  Â  Â  Â  #patracdvr_container, #unassigned_members_container {Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; min-height: 70px;Â 
Â  Â  Â  Â  Â  Â  border: 1px dashed var(--border-color); border-radius: 5px; align-content: flex-start;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Style pour indiquer une zone de dÃ©pÃ´t active */
Â  Â  Â  Â  .patracdvr-members-container, #unassigned_members_container {
Â  Â  Â  Â  Â  Â  transition: border-color 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .patracdvr-member-btn {Â 
Â  Â  Â  Â  Â  Â  background-color: var(--bg-body); border: 2px solid var(--border-color); color: var(--text-primary);Â 
Â  Â  Â  Â  Â  Â  padding: 8px 12px; border-radius: 5px; text-align: center; font-family: 'Oswald', sans-serif;Â 
Â  Â  Â  Â  Â  Â  cursor: pointer; transition: all 0.2s; min-height: 56px; display: flex; flex-direction: column; justify-content: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .patracdvr-member-btn:hover { border-color: var(--accent-hover); }
Â  Â  Â  Â  .patracdvr-member-btn.member-active { border-color: var(--accent-blue); box-shadow: 0 0 8px var(--accent-blue); }
Â  Â  Â  Â  .patracdvr-member-btn .trigramme { font-weight: bold; }
Â  Â  Â  Â  .patracdvr-member-btn .fonction { font-size: 0.8em; color: var(--text-secondary); display: block; }
Â  Â  Â  Â  
Â  Â  Â  Â  .patracdvr-vehicle-row {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  Â  Â  padding-top: 28px; /* Espace pour le nom et le bouton */
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  Â  Â  background-color: var(--bg-body);
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  min-height: 56px; /* Hauteur de base, comme un bouton membre */
Â  Â  Â  Â  Â  Â  min-width: 100px; /* Largeur de base */
Â  Â  Â  Â  Â  Â  width: auto; /* S'adapte au contenu */
Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  Â  Â  justify-content: flex-start;
Â  Â  Â  Â  }
Â  Â  Â  Â  .patracdvr-vehicle-row .patracdvr-members-container {
Â  Â  Â  Â  Â  Â  border: 1px dashed var(--border-color);
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  min-height: 40px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  Â  Â  align-content: flex-start;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vehicle-header {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 4px;
Â  Â  Â  Â  Â  Â  left: 8px;
Â  Â  Â  Â  Â  Â  right: 8px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .vehicle-name {
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: var(--accent-blue);
Â  Â  Â  Â  }
Â  Â  Â  Â  .vehicle-header .remove-btn {
Â  Â  Â  Â  Â  Â  padding: 2px 5px;
Â  Â  Â  Â  Â  Â  min-height: unset;
Â  Â  Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #vehicle_creation_buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px dashed var(--border-color); border-radius: 5px; }
Â  Â  Â  Â  .add-vehicle-btn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
Â  Â  Â  Â  
Â  Â  Â  Â  #editMemberModal, #quickEditModal, #settingsModal { color: var(--text-primary); background: var(--bg-container); width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; margin: 0; border: none; border-radius: 0; padding: 15px; }
Â  Â  Â  Â  #editMemberModal::backdrop, #quickEditModal::backdrop, #settingsModal::backdrop { background: rgba(0, 0, 0, 0.85); }
Â  Â  Â  Â  #editMemberModal #editMemberForm, #quickEditModal .modal-form, #settingsModal .modal-form { display: flex; flex-direction: column; height: 100%; }
Â  Â  Â  Â  #editMemberModal .modal-content, #quickEditModal .modal-content, #settingsModal .modal-content { flex: 1 1 auto; overflow-y: auto; padding: 0 5px; }
Â  Â  Â  Â  #editMemberModal .modal-actions, #quickEditModal .modal-actions, #settingsModal .modal-actions { flex-shrink: 0; display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
Â  Â  Â  Â  #editMemberModal .modal-actions button, #quickEditModal .modal-actions button, #settingsModal .modal-actions button { flex: 1; }
Â  Â  Â  Â  #modal_cancelBtn, #quick_modal_closeBtn, #settings_closeBtn { background-color: var(--bg-interactive); color: var(--text-primary); border: 1px solid var(--border-color); }
Â  Â  Â  Â  #modal_deleteBtn { background-color: var(--danger-red); color: white; }
Â  Â  Â  Â  #settings_saveBtn { background-color: var(--success-green); color: white; }

Â  Â  Â  Â  /* --- STYLES PANNEAU D'Ã‰DITION RAPIDE --- */
Â  Â  Â  Â  #quickEditPanel { display: none; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 20px; background-color: var(--bg-body); }
Â  Â  Â  Â  #quickEditPanel h4 { margin-top: 0; }
Â  Â  Â  Â  #quickEditPanel h4 #selectedMemberTrigramme { color: var(--accent-blue); }
Â  Â  Â  Â  .quick-edit-content .quick-edit-tab-panel { display: none; }
Â  Â  Â  Â  .quick-edit-options { display: flex; flex-wrap: wrap; gap: 8px; }
Â  Â  Â  Â  .quick-edit-btn { background-color: var(--bg-interactive); border: 1px solid var(--border-color); color: var(--text-secondary); padding: 6px 10px; border-radius: 4px; cursor: pointer; font-family: 'Oswald', sans-serif; font-size: 0.9em; transition: all 0.2s; }
Â  Â  Â  Â  .quick-edit-btn:hover { border-color: var(--accent-hover); color: var(--text-primary); }
Â  Â  Â  Â  .quick-edit-btn.selected { background-color: var(--accent-blue); color: white; border-color: var(--accent-blue); }
Â  Â  Â  Â  #quickEditModal .quick-edit-category { margin-bottom: 20px; }
Â  Â  Â  Â  #quickEditModal .quick-edit-category h5 { font-size: 1.1em; color: var(--text-secondary); margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }

Â  Â  Â  Â  /* --- STYLES ANNOTATION --- */
Â  Â  Â  Â  #annotationModal { width: 100vw; max-width: 100vw; height: 100vh; max-height: 100vh; background: var(--bg-container); color: var(--text-primary); border: none; border-radius: 0; padding: 0; overflow: hidden; }
Â  Â  Â  Â  #annotationModal::backdrop { background: rgba(0,0,0,0.85); }
Â  Â  Â  Â  .annotation-wrapper { display: flex; flex-direction: column; height: 100%; }
Â  Â  Â  Â  /* Correction: Optimisation de l'agencement de la barre d'outils pour mobile */
Â  Â  Â  Â  .annotation-toolbar { order: 2; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: var(--bg-body); border-top: 1px solid var(--border-color); flex-shrink: 0; }
Â  Â  Â  Â  .toolbar-main-tools, .toolbar-contextual-tools {Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-wrap: nowrap; /* EmpÃªche le retour Ã  la ligne pour le dÃ©filement horizontal */
Â  Â  Â  Â  Â  Â  gap: 10px;Â 
Â  Â  Â  Â  Â  Â  overflow-x: auto; /* Permet le dÃ©filement horizontal */
Â  Â  Â  Â  Â  Â  padding-bottom: 5px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .toolbar-main-tools::-webkit-scrollbar, .toolbar-contextual-tools::-webkit-scrollbar { height: 4px; }
Â  Â  Â  Â  .toolbar-main-tools::-webkit-scrollbar-thumb, .toolbar-contextual-tools::-webkit-scrollbar-thumb { background: var(--border-color); }
Â  Â  Â  Â  .tool-btn {Â 
Â  Â  Â  Â  Â  Â  padding: 10px; font-family: 'Oswald', sans-serif; border: 1px solid var(--border-color);Â 
Â  Â  Â  Â  Â  Â  background: var(--bg-interactive); color: var(--text-primary); cursor: pointer; border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 4px;Â 
Â  Â  Â  Â  Â  Â  flex-shrink: 0; min-width: 80px; /* AugmentÃ© lÃ©gÃ¨rement pour un meilleur clic */
Â  Â  Â  Â  }
Â  Â  Â  Â  .tool-btn .material-symbols-outlined { font-size: 28px; }
Â  Â  Â  Â  .tool-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
Â  Â  Â  Â  .tool-controls, #contextual_tools { display: none; }
Â  Â  Â  Â  .tool-controls.active, #contextual_tools.active {Â 
Â  Â  Â  Â  Â  Â  display: flex; flex-wrap: wrap; align-items: center; gap: 10px; padding: 10px;Â 
Â  Â  Â  Â  Â  Â  border: 1px dashed var(--border-color); border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  /* Correction: Assure le dÃ©filement sur mobile si les contrÃ´les prennent trop de place */
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tool-controls label { margin-bottom: 0; }
Â  Â  Â  Â  .tool-controls input { margin-bottom: 0; padding: 8px; max-width: 150px; } /* Limite la largeur de l'input */
Â  Â  Â  Â  #edit_text_btn { display: none; }
Â  Â  Â  Â  #contextual_tools.active.location-selected #edit_text_btn { display: flex; }
Â  Â  Â  Â  .annotation-actions { display: flex; justify-content: space-around; gap: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); margin-top: 10px;}
Â  Â  Â  Â  .annotation-actions button { flex: 1; justify-content: center; }
Â  Â  Â  Â  .annotation-canvas-container { order: 1; flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; padding: 5px; overflow: auto; min-height: 0; }
Â  Â  Â  Â  #annotationCanvas { max-width: 100%; max-height: 100%; object-fit: contain; }
Â  Â  Â  Â  .retex-section {
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--border-color); padding: 15px; border-radius: 5px;
Â  Â  Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .retex-actions {
Â  Â  Â  Â  Â  Â  display: flex; gap: 10px; margin-top: 15px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .retex-status {
Â  Â  Â  Â  Â  Â  margin-top: 10px; font-style: italic; color: var(--text-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .retex-output-content {
Â  Â  Â  Â  Â  Â  border: 1px dashed var(--border-color); padding: 15px; border-radius: 5px;
Â  Â  Â  Â  Â  Â  margin-top: 20px; min-height: 200px;
Â  Â  Â  Â  Â  Â  white-space: pre-wrap;
Â  Â  Â  Â  Â  Â  font-family: monospace;
Â  Â  Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  }
Â  Â  Â  Â  .retex-output-content h3 { color: var(--accent-blue); }
Â  Â  Â  Â  
Â  Â  Â  Â  .retex-output-content h4 { color: var(--accent-blue); border-bottom: 1px solid var(--border-color); margin-top: 10px; }
Â  Â  Â  Â  .retex-output-content ul { list-style-type: disc; padding-left: 20px; }
Â  Â  Â  Â  .retex-output-content p, .retex-output-content li { margin-bottom: 5px; }

Â  Â  Â  Â  @media (min-width: 768px) {
Â  Â  Â  Â  Â  Â  body { padding: 15px; padding-bottom: 80px; }
Â  Â  Â  Â  Â  Â  .dynamic-list-item { flex-direction: row; }
Â  Â  Â  Â  Â  Â  #editMemberModal, #quickEditModal, #settingsModal { width: 90%; max-width: 500px; height: auto; max-height: 90vh; margin: auto; border: 1px solid var(--border-color); border-radius: 8px; }
Â  Â  Â  Â  Â  Â  #quickEditPanel { display: block; }
Â  Â  Â  Â  Â  Â  .wizard-nav { flex-wrap: nowrap; }
Â  Â  Â  Â  Â  Â  .wizard-nav-btn { width: auto; margin-top: 0; }
Â  Â  Â  Â  Â  Â  #annotationModal { width: 95vw; max-width: 1400px; height: 95vh; border: 1px solid var(--border-color); border-radius: 8px;}
Â  Â  Â  Â  Â  Â  .annotation-wrapper { flex-direction: row; }
Â  Â  Â  Â  Â  Â  .annotation-toolbar { order: 1; flex-direction: column; width: 250px; border-top: none; border-right: 1px solid var(--border-color); }
Â  Â  Â  Â  Â  Â  .toolbar-main-tools, .toolbar-contextual-tools { flex-direction: column; overflow-x: hidden; }
Â  Â  Â  Â  Â  Â  .tool-btn { flex-direction: row; justify-content: flex-start; min-width: unset; }
Â  Â  Â  Â  Â  Â  /* RÃ©initialisation des contrÃ´les d'outils pour desktop */
Â  Â  Â  Â  Â  Â  .tool-controls.active, #contextual_tools.active {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â overflow-x: hidden;
Â  Â  Â  Â  Â  Â  Â  Â  Â max-width: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .annotation-actions { flex-direction: column; margin-top: auto; padding-top: 20px; }
Â  Â  Â  Â  Â  Â  .annotation-actions button { justify-content: flex-start; }
Â  Â  Â  Â  Â  Â  .annotation-canvas-container { order: 2; padding: 10px; }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  /* Styles desktop pour le panneau d'Ã©dition */
Â  Â  Â  Â  Â  Â  .quick-edit-tabs { display: none; } /* On cache les onglets */
Â  Â  Â  Â  Â  Â  .quick-edit-content .quick-edit-tab-panel.active { display: block !important; } /* On affiche tous les panneaux */
Â  Â  Â  Â  Â  Â  .quick-edit-content { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
Â  Â  Â  Â  Â  Â  .quick-edit-content h5 { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- STYLES DU TUTORIEL --- */
Â  Â  Â  Â  .tutorial-popup { position: absolute; background: var(--bg-container); color: var(--text-primary); border: 1px solid var(--accent-blue); border-radius: 8px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.35); z-index: 1001; width: 300px; display: none; flex-direction: column; gap: 10px; }
Â  Â  Â  Â  .tutorial-popup p { margin-bottom: 0; }
Â  Â  Â  Â  .tutorial-popup button { background-color: var(--accent-blue); color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-family: 'Oswald', sans-serif; text-transform: uppercase; }
Â  Â  Â  Â  .tutorial-popup .close-btn { position: absolute; top: 5px; right: 10px; font-size: 20px; cursor: pointer; color: var(--text-secondary); }
Â  Â  Â  Â  .highlight-element { box-shadow: 0 0 0 5px var(--accent-blue) !important; transition: box-shadow 0.3s ease-in-out; position: relative; z-index: 1002; }

Â  Â  Â  Â  //* --- MEDIA QUERY POUR MOBILE --- */
@media (max-width: 600px) {
Â  Â  .dock-menu:not(.collapsed) {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
Â  Â  Â  Â  gap: 5px;Â 
Â  Â  Â  Â  padding: 5px;Â 
Â  Â  Â  Â  width: 95%;Â 
Â  Â  Â  Â  border: 1px solid var(--border-color);
Â  Â  Â  Â  background-color: rgba(30, 30, 30, 0.7);
Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  }
Â  Â  .dock-menu:not(.collapsed) .dock-menu-item {
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  height: 45px;Â 
Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  margin: 0;Â 
Â  Â  }
}
Â  Â  </style>
</head>
<body class="dark-mode">

Â  Â  <div class="dock-menu" id="dockMenu">
Â  Â  Â  Â  <div class="dock-menu-item" id="dockToggleBtn" title="RÃ©duire"><span class="material-symbols-outlined">expand_more</span></div>
Â  Â  Â  Â  <a href="index.html" class="dock-menu-item" title="Accueil"><span class="material-symbols-outlined">home</span></a>
Â  Â  Â  Â  <div class="dock-menu-item" id="importSessionBtn" title="Importer une session"><span class="material-symbols-outlined">file_upload</span></div>
Â  Â  Â  Â  <div class="dock-menu-item" id="exportSessionBtn" title="Exporter la session"><span class="material-symbols-outlined">file_download</span></div>
Â  Â  Â  Â  <div class="dock-menu-item" id="settingsBtn" title="ParamÃ¨tres"><span class="material-symbols-outlined">settings</span></div>
Â  Â  Â  Â  <div class="dock-menu-item" id="darkModeToggle" title="Changer le thÃ¨me"><span class="material-symbols-outlined" id="darkModeIcon">nightlight</span></div>
Â  Â  Â  Â  <div class="dock-menu-item" id="resetBtn" title="RÃ©initialiser le formulaire"><span class="material-symbols-outlined">refresh</span></div>
Â  Â  Â  Â  <div class="dock-menu-item" id="tutorialBtn" title="Lancer le tutoriel"><span class="material-symbols-outlined">school</span></div>
Â  Â  </div>
Â  Â  <input type="file" id="sessionFileInput" accept=".json" />
Â  Â  <input type="file" id="jsonConfigInput" accept=".json"/>Â 
Â  Â  <dialog id="settingsModal">
Â  Â  Â  Â  <div class="modal-form">
Â  Â  Â  Â  Â  Â  <h3>ParamÃ¨tres de l'application</h3>
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h4>ClÃ© API Google Gemini</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Pour l'analyse des rapports RETEX, vous devez fournir une clÃ© API personnelle de Google Gemini. L'analyse est effectuÃ©e directement depuis votre navigateur.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="geminiApiKey">ClÃ© API:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="geminiApiKey" placeholder="Saisissez votre clÃ© d'API">
Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-top: 15px;">**Note Importante:** AprÃ¨s la sauvegarde, votre clÃ© sera stockÃ©e **uniquement dans votre navigateur** pour des raisons de sÃ©curitÃ© et de confidentialitÃ©.</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="settings_closeBtn">Fermer</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="settings_saveBtn">Sauvegarder</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </dialog>

Â  Â  <div id="tutorial-popup" class="tutorial-popup">
Â  Â  Â  Â  <span class="close-btn">&times;</span>
Â  Â  Â  Â  <p id="popup-text"></p>
Â  Â  Â  Â  <button id="next-popup-btn">Suivant</button>
Â  Â  </div>

Â  Â  <dialog id="editMemberModal">
Â  Â  Â  Â  <form id="editMemberForm" onsubmit="return false;">
Â  Â  Â  Â  Â  Â  <h3>Ã‰diter le membre</h3>
Â  Â  Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_trigramme">Trigramme:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="modal_trigramme" placeholder="Trigramme">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_fonction">Fonction:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_fonction"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_cellule">Cellule:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_cellule"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_armement">Armement:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_armement"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_equipement">Ã‰quipement 1:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_equipement"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_equipement2">Ã‰quipement 2:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_equipement2"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_tenue">Tenue:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_tenue"></select>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="modal_gpb">GPB:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modal_gpb"></select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="modal_deleteBtn" class="remove-btn">Renvoyer en Attente</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="modal_cancelBtn">Annuler</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="modal_saveBtn" class="add-btn">Sauvegarder</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>
Â  Â  </dialog>
Â  Â  
Â  Â  <dialog id="quickEditModal">
Â  Â  Â  Â  <div class="modal-form">
Â  Â  Â  Â  Â  Â  <h3 id="quick_modal_title">Ã‰dition rapide</h3>
Â  Â  Â  Â  Â  Â  <div id="quick_modal_content" class="modal-content"></div>
Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="quick_modal_closeBtn">Fermer</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </dialog>

Â  Â  <dialog id="annotationModal">
Â  Â  Â  Â  <div class="annotation-wrapper">
Â  Â  Â  Â  Â  Â  <div class="annotation-toolbar">
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="contextual_tools">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="toolbar-contextual-tools">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="rotation_input" style="font-size: 0.8em; margin:0;">Rotation (DegrÃ©s)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="rotation_input" min="0" max="360" step="1" value="0" style="max-width: 80px; text-align: center; padding: 5px; height: 35px; margin: 0;" onchange="updateAnnotationRotation()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="edit_text_btn" class="tool-btn"><span class="material-symbols-outlined">edit</span>Texte</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="delete_btn" class="tool-btn" style="background-color: var(--danger-red); color: white;"><span class="material-symbols-outlined">delete</span>Supprimer</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="toolbar-main-tools">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="tool_move" class="tool-btn active"><span class="material-symbols-outlined">open_with</span>DÃ©placer</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="tool_location" class="tool-btn"><span class="material-symbols-outlined">place</span>Emplacement</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="tool_arrow" class="tool-btn"><span class="material-symbols-outlined">arrow_right_alt</span>DÃ©signer</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="tool_box" class="tool-btn"><span class="material-symbols-outlined">crop_square</span>Encadrer</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="controls_location" class="tool-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="circle_text">Texte:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="text" id="circle_text" value="Zone">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="circle_opacity">Transparence:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="range" id="circle_opacity" min="0.1" max="1" step="0.1" value="0.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="controls_arrow" class="tool-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="arrow_thickness">Ã‰paisseur:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="range" id="arrow_thickness" min="1" max="25" step="1" value="5">
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="controls_box" class="tool-controls">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="box_thickness">Ã‰paisseur:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="range" id="box_thickness" min="1" max="20" step="1" value="5">
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="annotation-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="tool_reset" class="tool-btn"><span class="material-symbols-outlined">delete_sweep</span>Effacer tout</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="annotation_cancel" class="tool-btn">Annuler</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="annotation_save" class="tool-btn" style="background-color: #27ae60; color: white;"><span class="material-symbols-outlined">save</span>Sauvegarder</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="annotation-canvas-container">
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="annotationCanvas"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </dialog>

Â  Â  <div class="container">
Â  Â  Â  Â  <h1>Praxis</h1>
Â  Â  Â  Â  
Â  Â  Â  Â  <ul class="wizard-progress">
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(0)">Situation</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(1)">Adversaire</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(2)">Environnement</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(3)">Mission</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(4)">ExÃ©cution</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(5)">Articulation</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(6)">PATRACDVR</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(7)">Photos</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(8)">CAT</li>
Â  Â  Â  Â  Â  Â  <li class="wizard-progress-step" onclick="goToStep(9)">Finalisation</li>
Â  Â  Â  Â  </ul>

Â  Â  Â  Â  <form id="oi-form">
Â  Â  Â  Â  Â  Â  <div class="wizard-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>1. Situation</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="date_op">Date de l'opÃ©ration:</label><input type="date" id="date_op">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="situation_generale">1.1 GÃ©nÃ©rale:</label><textarea id="situation_generale"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="situation_particuliere">1.2 ParticuliÃ¨re:</label><textarea id="situation_particuliere"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>1.3 Adversaire</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Photo principale de l'adversaire:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="adversary_photo_container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="adversary_info_container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="nom_adversaire">Nom/PrÃ©nom:</label><input type="text" id="nom_adversaire">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="domicile_adversaire">Domicile:</label><textarea id="domicile_adversaire" rows="2"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Moyens EmployÃ©s:</label><div id="me_container"></div><button type="button" class="add-btn" onclick="addMeField()">â• ME</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Informations TO</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Date et lieu de naissance:</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dynamic-list-item"><input type="date" id="date_naissance"><input type="text" id="lieu_naissance" placeholder="Lieu de naissance"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dynamic-list-item"><input type="text" id="stature_adversaire" placeholder="Stature"><select id="ethnie_adversaire"><option>Caucasien</option><option>Nord africain</option><option>Afro-antillais</option><option>Asiatique</option></select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="signes_particuliers">Signes particuliers:</label><input type="text" id="signes_particuliers">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="profession_adversaire">Profession:</label><input type="text" id="profession_adversaire">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="antecedents_adversaire">AntÃ©cÃ©dents:</label><textarea id="antecedents_adversaire" rows="2"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Ã‰tat d'esprit:</label><div id="etat_esprit_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'])">â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="attitude_adversaire">Attitude (connue):</label><textarea id="attitude_adversaire" rows="2"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Volume (renfort potentiel):</label><div id="volume_adversaire_container"></div><button type="button" class="add-btn" onclick="addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'])">â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Photos des renforts potentiels</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="renforts_photo_container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn" onclick="addPhotoInput('renforts_photo_container')">Ajouter Photo Renfort â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin-top: 20px;">Photos supplÃ©mentaires de l'adversaire</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="adversary_extra_photos_container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn" onclick="addPhotoInput('adversary_extra_photos_container')">Ajouter Photo Adversaire â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="substances_adversaire">Substances:</label><input type="text" id="substances_adversaire">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>VÃ©hicules:</label><div id="vehicules_container"></div><button type="button" class="add-btn" onclick="addDynamicField('vehicules_container')">â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="armes_connues">Armes connues:</label><input type="text" id="armes_connues">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>1.4 Environnement</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label>Ami(e)s (UnitÃ©s en soutien):</label><input type="text" id="amies">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label>Terrain / MÃ©tÃ©o:</label><input type="text" id="terrain_info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label>Population:</label><input type="text" id="population">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="cadre_juridique">Cadre juridique:</label><input type="text" id="cadre_juridique">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>2. Mission du PSIG</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="missions_psig" rows="8">

INTERPELLER L'OBJECTIF.

ASSISTER LORS DE LA PERQUISITION.

CONDUITE AU LIEU DE GAV.</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h2>3. ExÃ©cution</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="date_execution">Date d'exÃ©cution:</label><input type="date" id="date_execution">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="heure_execution">Heure d'exÃ©cution (H):</label><input type="time" id="heure_execution" value="06:00">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="type_action">Type d'action:</label><input type="text" id="type_action">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Chronologie</h3><div id="time_events_container"></div><button type="button" class="add-btn" onclick="addTimeEvent()">â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>HypothÃ¨ses</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="hypothese_h1">H1:</label><input type="text" id="hypothese_h1" value="Target prÃ©sente LE1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="hypothese_h2">H2:</label><input type="text" id="hypothese_h2" value="Target prÃ©sente LE2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="hypothese_h3">H3:</label><input type="text" id="hypothese_h3" value="Target absente LE 1 et 2">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h2>4. Articulation (MOIPC/ZMSPCP)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="place_chef">Place du Chef (GÃ©nÃ©rale):</label><input type="text" id="place_chef">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="collapsible-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="collapsible-header"><h3>Ã‰quipe INDIA (INTER)</h3><span class="material-symbols-outlined">expand_more</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="collapsible-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="india_mission">Mission:</label><textarea id="india_mission" rows="3">RECONNAÃTRE LE DOMICILE EN VUE D'APPRÃ‰HENDER L'OBJECTIF</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Composition</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="india_composition_display" class="articulation-composition-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><i>La composition sera affichÃ©e ici aprÃ¨s configuration dans l'onglet PATRACDVR.</i></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="india_objectif">Objectif:</label><input type="text" id="india_objectif">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="india_itineraire">ItinÃ©raire:</label><textarea id="india_itineraire" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Photos - ItinÃ©raire</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>ItinÃ©raire ExtÃ©rieur</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="photo_container_itineraire_exterieur"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_exterieur')">Ajouter Photo â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>ItinÃ©raire IntÃ©rieur</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="photo_container_itineraire_interieur"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_itineraire_interieur')">Ajouter Photo â•</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="india_points_particuliers">Points Particuliers:</label><textarea id="india_points_particuliers" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="india_cat">Conduite Ã  Tenir:</label><textarea id="india_cat" rows="6">- Si dÃ©celÃ©, dynamiser jusqu'au domicile.
- Si prÃ©sence tierce personne lors de la progression, contrÃ´ler.
- Si fuite, CR direction fuite + interpellation.
- Si rÃ©bellion, usage du strict niveau de force nÃ©cessaire.
- Si retranchement, CR + rÃ©articulation pour fixer l'adversaire.</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="collapsible-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="collapsible-header"><h3>Ã‰quipe Appui/Observation (AO) - ZMSPCP</h3><span class="material-symbols-outlined">expand_more</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="collapsible-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Composition</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="ao_composition_display" class="articulation-composition-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><i>La composition sera affichÃ©e ici aprÃ¨s configuration dans l'onglet PATRACDVR.</i></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="ao_zone_installation">Zone d'installation (Z):</label><textarea id="ao_zone_installation" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3>Photos - Zone d'installation</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>BaptÃªme terrain</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="photo_container_bapteme_terrain"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_bapteme_terrain')">Ajouter Photo â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4>Emplacement AO</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="photo_container_emplacement_ao"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_emplacement_ao')">Ajouter Photo â•</button>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="ao_mission">Mission (M):</label><textarea id="ao_mission" rows="3">BOUCLER - SURVEILLER - INTERDIRE TOUTE FUITE</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="ao_secteur_surveillance">Secteur de surveillance (S):</label><textarea id="ao_secteur_surveillance" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="ao_points_particuliers">Points Particuliers (P):</label><textarea id="ao_points_particuliers" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="ao_cat">Conduite Ã  Tenir (C):</label><textarea id="ao_cat" rows="6">- Compte rendu de mise en place.
- Renseigner rÃ©guliÃ¨rement.
- Si dÃ©celÃ©, CR.
- Si fuite, CR direction fuite + interpellation si rapport de force favorable.
- Si rÃ©bellion, usage du strict minimum de force nÃ©cessaire.
- Si retranchement, CR + rÃ©articulation pour fixer l'adversaire.</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="ao_place_chef">Place du Chef (P):</label><input type="text" id="ao_place_chef">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>5. PATRACDVR</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="importDefaultConfigBtn" class="add-btn" style="background-color: var(--accent-blue); flex-grow: 1;">Charger Config par DÃ©faut âš™ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="importJsonConfigBtn" class="add-btn" style="background-color: var(--success-green); flex-grow: 1;">Importer Configuration Membres (.json) ğŸ“¤</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="resetPatracdvrBtn" class="remove-btn" style="flex-grow: 1;">RÃ©initialiser PATRACDVR</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="quickEditPanel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Membre: <span id="selectedMemberTrigramme">Aucun</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="fullEditBtn" class="add-btn" style="font-size: 0.8em; padding: 5px 8px; margin-left: 15px;">Ã‰dition ComplÃ¨te</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="quick-edit-content"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top: 20px;">Ajouter un vÃ©hicule ou un membre</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="vehicle_creation_buttons">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn add-vehicle-btn" id="addManualVehicleBtn">â• VÃ©hicule Manuel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn add-vehicle-btn" id="addManualMemberBtn">â• Membre Manuel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top: 20px;">Composition des vÃ©hicules</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="patracdvr_container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 style="margin-top: 20px;">Personnel Ã  attribuer</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="unassigned_members_container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Photos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Ajoutez des photos complÃ©mentaires pour le PDF.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Transport PSIG vers PR</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="photo_container_transport_pr"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_pr')">Ajouter Photo â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Transport PR vers Domicile</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="photo_container_transport_domicile"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_transport_domicile')">Ajouter Photo â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Cellule Effraction</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="photo_container_cellule_effraction"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn" onclick="addPhotoInput('photo_container_cellule_effraction')">Ajouter Photo â•</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Conduites Ã  tenir</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>GÃ©nÃ©rales</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="cat_generales" rows="6">- Si rÃ©bellion, user du strict niveau de force nÃ©cessaire
- Si retranchÃ©, alerter en mesure de se rÃ©-articuler
- Si tente de fuir, alerter en mesure de jalonner/interpeller
- UDA : Article L435-1 du CSI + lÃ©gitime dÃ©fense</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>NO GO</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="no_go" rows="3" placeholder="Saisir les conditions de dÃ©sengagement..."></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>Liaison</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="cat_liaison" rows="4">TOM:Â 
DIR:Â 
Gestuelle et visuelle entre les Ã©lÃ©ments INDIA</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="wizard-step">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2>Finalisation</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="text-align:center;">Vous Ãªtes prÃªt. Cliquez sur "AperÃ§u" pour vÃ©rifier ou "GÃ©nÃ©rer le PDF" pour crÃ©er votre document.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="wizard-nav-btn" id="previewBtn" type="button">AperÃ§u ğŸ”</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="wizard-nav-btn" id="generatePdfBtn" type="button">GÃ©nÃ©rer le PDF ğŸ“„</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="retex-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ”— Rapport RETEX (Lien)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Utilisez ce bouton pour gÃ©nÃ©rer le lien vers la plateforme externe de compte-rendu d'opÃ©ration.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="retex-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="retexReportBtn" class="wizard-nav-btn" type="button" style="background-color: #008080;">Consulter Rapport RETEX ğŸ§ </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="retex-section" style="margin-top: 10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>ğŸ§  Analyse RETEX par IA (Fichiers locaux)</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>SÃ©lectionnez les fichiers JSON des comptes-rendus Ã  analyser localement (NÃ©cessite ClÃ© API Gemini).</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="retex-file-selector">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="retexFileInput" class="file-upload-label" style="background-color: var(--accent-blue);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="material-symbols-outlined">upload_file</span> Choisir des fichiers
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="retexFileInput" accept=".json" multiple style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="retexFileNames" class="file-name-display" style="color: var(--text-secondary);">Aucun fichier sÃ©lectionnÃ©</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="retex-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="launchRetexAnalysisBtn" class="add-btn">Lancer l'Analyse</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="generateRetexPdfBtn" class="wizard-nav-btn" style="display: none; background-color: var(--success-green);">GÃ©nÃ©rer le PDF du rapport</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="retex_status" class="retex-status"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="retex_output" class="retex-output-content" style="display: none;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </form>

Â  Â  Â  Â  <div class="wizard-nav">
Â  Â  Â  Â  Â  Â  <button class="wizard-nav-btn" id="prevBtn" type="button">PrÃ©cÃ©dent</button>
Â  Â  Â  Â  Â  Â  <button class="wizard-nav-btn" id="nextBtn" type="button">Suivant</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/marked@4.0.10/marked.min.js"></script>
Â  Â  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
Â  Â  <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
Â  Â  <script>
Â  Â  Â  Â  // --- NOUVELLE CONFIGURATION & VARIABLES GLOBALES ---
Â  Â  Â  Â  const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent";
Â  Â  Â  Â  const RETEX_BASE_URL = "https://oxsilaris06.github.io/Praxis/retex.html";
Â  Â  Â  Â  const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyF0CJ_B9U4Izn6ieZG4lfIq23oScE6cFvd1SoUXvVUBRqk_Ce1R8TJpRRnuamcdJH-/exec";
Â  Â  Â  Â  const DEFAULT_CONFIG_FILE = 'members_config.json'; // Fichier de configuration par dÃ©faut
Â  Â  Â  Â  
Â  Â  Â  Â  // --- GLOBAL CONFIG (Par dÃ©faut, sera Ã©crasÃ© par le JSON) ---
Â  Â  Â  Â  let memberConfig = {
Â  Â  Â  Â  Â  Â  fonctions: ['Chef inter', 'Chef dispo','Chef AO','Effrac', 'DE', 'Sans'],
Â  Â  Â  Â  Â  Â  cellules: ['AO1','AO2','AO3','AO4','AO5','AO6','India 1','India 2','India 3','India 4','India 5', 'Sans'],
Â  Â  Â  Â  Â  Â  armements: ['Sans', 'UMP9', 'G36', 'PIE', 'LBD40', 'FAP'],
Â  Â  Â  Â  Â  Â  equipements: ['Sans', 'BBAL', 'GENL', 'EFFRAC', 'MP7', 'IL'],
Â  Â  Â  Â  Â  Â  equipements2: ['Sans', 'Ã‰chelle', 'Stop stick', 'Lacry', 'Cale'],
Â  Â  Â  Â  Â  Â  tenues: ['UBAS', '4S', 'Bleu', 'Treillis', 'Civil'],
Â  Â  Â  Â  Â  Â  gpbs: ['GPBL', 'GPBPD','Sans']
Â  Â  Â  Â  };
Â  Â  Â  Â  const availableVehicles = ['Sharan', 'Kodiaq', '5008', 'ScÃ©nic', 'BT'];
Â  Â  Â  Â  
Â  Â  Â  Â  // --- GLOBAL STATE ---
Â  Â  Â  Â  let activeMemberId = null;

Â  Â  Â  Â  // --- WIZARD & FORM MANAGEMENT ---
Â  Â  Â  Â  let currentStep = 0;
Â  Â  Â  Â  let visitedSteps = new Set();
Â  Â  Â  Â  const steps = Array.from(document.querySelectorAll(".wizard-step"));
Â  Â  Â  Â  const progressSteps = Array.from(document.querySelectorAll(".wizard-progress-step"));
Â  Â  Â  Â  const prevBtn = document.getElementById('prevBtn');
Â  Â  Â  Â  const nextBtn = document.getElementById('nextBtn');
Â  Â  Â  Â  const previewBtn = document.getElementById('previewBtn');
Â  Â  Â  Â  const generatePdfBtn = document.getElementById('generatePdfBtn');
Â  Â  Â  Â  const retexReportBtn = document.getElementById('retexReportBtn');
Â  Â  Â  Â  const retexStatus = document.getElementById('retex_status');
Â  Â  Â  Â  const retexOutput = document.getElementById('retex_output');
Â  Â  Â  Â  const launchRetexAnalysisBtn = document.getElementById('launchRetexAnalysisBtn');
Â  Â  Â  Â  const generateRetexPdfBtn = document.getElementById('generateRetexPdfBtn');
Â  Â  Â  Â  const patracdvrContainer = document.getElementById('patracdvr_container');
Â  Â  Â  Â  const unassignedContainer = document.getElementById('unassigned_members_container');
Â  Â  Â  Â  const jsonConfigInput = document.getElementById('jsonConfigInput');
Â  Â  Â  Â  const resetPatracdvrBtn = document.getElementById('resetPatracdvrBtn');
Â  Â  Â  Â  const importJsonConfigBtn = document.getElementById('importJsonConfigBtn');
Â  Â  Â  Â  const importDefaultConfigBtn = document.getElementById('importDefaultConfigBtn');
Â  Â  Â  Â  
Â  Â  Â  Â  const retexFileInput = document.getElementById('retexFileInput');
Â  Â  Â  Â  const retexFileNames = document.getElementById('retexFileNames');

Â  Â  Â  Â  // DÃ©claration du canvas temporaire pour la gÃ©nÃ©ration PDF
Â  Â  Â  Â  const tempCanvas = document.createElement('canvas');
Â  Â  Â  Â  const tempCtx = tempCanvas.getContext('2d');


Â  Â  Â  Â  function showStep(n) {
Â  Â  Â  Â  Â  Â  steps.forEach((step, index) => step.classList.toggle('active', index === n));
Â  Â  Â  Â  Â  Â  progressSteps.forEach((pStep, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  pStep.classList.toggle('active', index === n);
Â  Â  Â  Â  Â  Â  Â  Â  if(visitedSteps.has(index) && index !== n) pStep.classList.add('completed');
Â  Â  Â  Â  Â  Â  Â  Â  else pStep.classList.remove('completed');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  prevBtn.style.display = n === 0 ? "none" : "inline-block";
Â  Â  Â  Â  Â  Â  const isLastStep = n === (steps.length - 1);
Â  Â  Â  Â  Â  Â  nextBtn.style.display = isLastStep ? "none" : "inline-block";
Â  Â  Â  Â  Â  Â  if (isLastStep) {
Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  Â  Â  generatePdfBtn.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  Â  Â  retexReportBtn.style.display = "inline-block";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  generatePdfBtn.style.display = "none";
Â  Â  Â  Â  Â  Â  Â  Â  retexReportBtn.style.display = "none";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function goToStep(n) {
Â  Â  Â  Â  Â  Â  if (n >= 0 && n < steps.length) {
Â  Â  Â  Â  Â  Â  Â  Â  visitedSteps.add(currentStep);
Â  Â  Â  Â  Â  Â  Â  Â  saveFormData();
Â  Â  Â  Â  Â  Â  Â  Â  currentStep = n;

Â  Â  Â  Â  Â  Â  Â  Â  if (n === 6) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (activeMemberId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const oldActive = document.getElementById(activeMemberId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (oldActive) oldActive.classList.remove('member-active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeMemberId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth >= 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('quickEditPanel').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  showStep(n);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function changeStep(n) { goToStep(currentStep + n); }
Â  Â  Â  Â  prevBtn.addEventListener('click', () => changeStep(-1));
Â  Â  Â  Â  nextBtn.addEventListener('click', () => changeStep(1));
Â  Â  Â  Â  
Â  Â  Â  Â  // --- DYNAMIC FIELD & PHOTO MANAGEMENT ---
Â  Â  Â  Â  function addPhotoInput(containerId, isSingle = false) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  if (isSingle) container.innerHTML = '';
Â  Â  Â  Â  Â  Â  const itemWrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  itemWrapper.className = 'photo-input-wrapper';
Â  Â  Â  Â  Â  Â  // Fix pour l'ID de la photo principale pour la retrouver facilement
Â  Â  Â  Â  Â  Â  const uniqueId = isSingle ? 'photo_adversary_main' : `photo_${Date.now()}_${Math.random()}`;
Â  Â  Â  Â  Â  Â  const previewId = `preview_${uniqueId}`;
Â  Â  Â  Â  Â  Â  itemWrapper.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="dynamic-list-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="${uniqueId}" class="photo-input" accept="image/png, image/jpeg" onchange="handleFileChange(this, 'span_${uniqueId}', '${previewId}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="${uniqueId}" class="file-upload-label">Choisir une photo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="span_${uniqueId}" class="file-name-display">Aucun fichier</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="add-btn annotate-btn" style="display:none; margin-left:5px; background-color: var(--accent-blue);" onclick="openAnnotationModal('${previewId}')">Annoter</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${!isSingle ? '<button type="button" class="remove-btn" onclick="this.closest(\'.photo-input-wrapper\').remove(); saveFormData();">âŒ</button>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <img id="${previewId}" class="image-preview" style="display:none;" alt="AperÃ§u"/>`;
Â  Â  Â  Â  Â  Â  container.appendChild(itemWrapper);
Â  Â  Â  Â  }
Â  Â  Â  Â  function handleFileChange(input, spanId, previewId) {
Â  Â  Â  Â  Â  Â  const fileNameSpan = document.getElementById(spanId);
Â  Â  Â  Â  Â  Â  const previewImg = document.getElementById(previewId);
Â  Â  Â  Â  Â  Â  const annotateBtn = input.parentElement.querySelector('.annotate-btn');

Â  Â  Â  Â  Â  Â  if (input.files.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  fileNameSpan.textContent = input.files[0].name;
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = e => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.dataset.originalSrc = e.target.result; // Stocke la source non annotÃ©e
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.dataset.annotations = '[]'; // RÃ©initialise les annotations
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (annotateBtn) annotateBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveFormData(); // Sauvegarder aprÃ¨s le chargement du fichier
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(input.files[0]);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  fileNameSpan.textContent = 'Aucun fichier';
Â  Â  Â  Â  Â  Â  Â  Â  previewImg.src = '';
Â  Â  Â  Â  Â  Â  Â  Â  previewImg.dataset.originalSrc = '';
Â  Â  Â  Â  Â  Â  Â  Â  previewImg.dataset.annotations = '[]';
Â  Â  Â  Â  Â  Â  Â  Â  previewImg.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (annotateBtn) annotateBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  saveFormData(); // Sauvegarder si on vide le champ
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function addDynamicField(containerId, value = '') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'dynamic-list-item';
Â  Â  Â  Â  Â  Â  item.innerHTML = `<input type="text" class="dynamic-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">âŒ</button>`;
Â  Â  Â  Â  Â  Â  container.appendChild(item);
Â  Â  Â  Â  }
Â  Â  Â  Â  function addDynamicFieldWithSelect(containerId, options, value = '') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'dynamic-list-item';
Â  Â  Â  Â  Â  Â  const selectId = `select_${containerId}_${Math.random().toString(36).substr(2, 9)}`;
Â  Â  Â  Â  Â  Â  const inputId = `input_${containerId}_${Math.random().toString(36).substr(2, 9)}`;
Â  Â  Â  Â  Â  Â  item.innerHTML = `<select id="${selectId}" onchange="document.getElementById('${inputId}').value = this.value; saveFormData();"><option value="">SÃ©lection</option>${options.map(o => `<option value="${o}" ${o === value ? 'selected':''}>${o}</option>`).join('')}</select><input type="text" id="${inputId}" class="dynamic-input" placeholder="Ou personnalisÃ©" value="${value}" oninput="document.getElementById('${selectId}').value = ''; saveFormData();"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">âŒ</button>`;
Â  Â  Â  Â  Â  Â  container.appendChild(item);
Â  Â  Â  Â  }
Â  Â  Â  Â  function addMeField(value = '') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('me_container');
Â  Â  Â  Â  Â  Â  if (container.children.length >= 3) return;
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'dynamic-list-item';
Â  Â  Â  Â  Â  Â  item.innerHTML = `<label>ME${container.children.length + 1}:</label><input type="text" class="me-input" value="${value}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">âŒ</button>`;
Â  Â  Â  Â  Â  Â  container.appendChild(item);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function addTimeEvent(type_from_load, hour_from_load = '', desc_from_load) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('time_events_container');
Â  Â  Â  Â  Â  Â  const isLoadingFromFile = type_from_load !== undefined;

Â  Â  Â  Â  Â  Â  let type, hour = hour_from_load, desc;

Â  Â  Â  Â  Â  Â  if (isLoadingFromFile) {
Â  Â  Â  Â  Â  Â  Â  Â  type = type_from_load;
Â  Â  Â  Â  Â  Â  Â  Â  desc = desc_from_load;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const currentEventCount = container.children.length;
Â  Â  Â  Â  Â  Â  Â  Â  const prefilledData = [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { type: 'T0', desc: 'Rasso PSIG' }, { type: 'T1', desc: 'DÃ©part PR' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { type: 'T2', desc: 'DÃ©part LE' }, { type: 'T3', desc: 'MEP TERMINÃ‰' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { type: 'T4', desc: 'TOP ACTION' },
Â  Â  Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â  Â  Â  const defaultValues = prefilledData[currentEventCount] || { type: `T${currentEventCount}`, desc: ''};
Â  Â  Â  Â  Â  Â  Â  Â  type = defaultValues.type;
Â  Â  Â  Â  Â  Â  Â  Â  desc = defaultValues.desc;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'dynamic-list-item time-item draggable';
Â  Â  Â  Â  Â  Â  item.id = `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
Â  Â  Â  Â  Â  Â  item.setAttribute('draggable', 'true');
Â  Â  Â  Â  Â  Â  const optionsHtml = ['T0','T1','T2','T3','T4','T5'].map(t =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  `<option value="${t}" ${t === type ? 'selected' : ''}>${t}</option>`
Â  Â  Â  Â  Â  Â  ).join('');
Â  Â  Â  Â  Â  Â  item.innerHTML = `<select class="time-type-select" onchange="saveFormData()">${optionsHtml}</select><input type="time" class="time-hour-input" value="${hour}" onchange="saveFormData()"><input type="text" class="time-description-input" placeholder="Description" value="${desc || ''}" oninput="saveFormData()"><button type="button" class="remove-btn" onclick="this.parentElement.remove(); saveFormData();">âŒ</button>`;
Â  Â  Â  Â  Â  Â  container.appendChild(item);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PATRACDVR & MEMBER MANAGEMENT ---
Â  Â  Â  Â  function addPatracdvrRow(vehicleName, members = []) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('patracdvr_container');
Â  Â  Â  Â  Â  Â  // VÃ©rifie si un vÃ©hicule avec ce nom existe dÃ©jÃ 
Â  Â  Â  Â  Â  Â  if (container.querySelector(`[data-vehicle-name="${vehicleName}"]`)) {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Le vÃ©hicule "${vehicleName}" existe dÃ©jÃ . Veuillez choisir un nom unique.`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const row = document.createElement('div');
Â  Â  Â  Â  Â  Â  row.className = 'patracdvr-vehicle-row';
Â  Â  Â  Â  Â  Â  row.dataset.vehicleName = vehicleName;

Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="vehicle-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="vehicle-name">${vehicleName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="remove-btn" title="Supprimer le vÃ©hicule">âŒ</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="patracdvr-members-container"></div>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  container.appendChild(row);

Â  Â  Â  Â  Â  Â  const membersContainer = row.querySelector('.patracdvr-members-container');
Â  Â  Â  Â  Â  Â  row.querySelector('.remove-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const confirmation = confirm(`Voulez-vous vraiment supprimer le vÃ©hicule "${vehicleName}" et dÃ©sattribuer ses membres ?`);
Â  Â  Â  Â  Â  Â  Â  Â  if (confirmation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  membersContainer.querySelectorAll('.patracdvr-member-btn').forEach(memberBtn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  memberBtn.dataset.cellule = 'Sans';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  memberBtn.dataset.fonction = 'Sans';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMemberButtonVisuals(memberBtn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unassignedContainer.appendChild(memberBtn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.remove();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveFormData();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Attacher les gestionnaires de drag and drop au nouveau conteneur de membres
Â  Â  Â  Â  Â  Â  membersContainer.addEventListener('dragenter', handleDragEnter);
Â  Â  Â  Â  Â  Â  membersContainer.addEventListener('dragleave', handleDragLeave);
Â  Â  Â  Â  Â  Â  membersContainer.addEventListener('dragover', handleDragOver);
Â  Â  Â  Â  Â  Â  membersContainer.addEventListener('drop', handleDrop);

Â  Â  Â  Â  Â  Â  members.forEach(memberData => addPatracdvrMember(membersContainer, memberData));
Â  Â  Â  Â  Â  Â  saveFormData();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- NOUVELLE FONCTION : Ajout de vÃ©hicule manuel ---
Â  Â  Â  Â  function addManualVehicle() {
Â  Â  Â  Â  Â  Â  let vehicleName = prompt("Veuillez saisir le nom du nouveau vÃ©hicule (ex: VW-Golf, VTC):");
Â  Â  Â  Â  Â  Â  if (vehicleName) {
Â  Â  Â  Â  Â  Â  Â  Â  vehicleName = vehicleName.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (vehicleName.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addPatracdvrRow(vehicleName);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- NOUVELLE FONCTION : Ajout de membre manuel ---
Â  Â  Â  Â  function addManualMember() {
Â  Â  Â  Â  Â  Â  let trigramme = prompt("Veuillez saisir le trigramme du nouveau membre (ex: ABC):");
Â  Â  Â  Â  Â  Â  if (trigramme) {
Â  Â  Â  Â  Â  Â  Â  Â  trigramme = trigramme.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  Â  Â  // VÃ©rifier si un membre avec ce trigramme existe dÃ©jÃ 
Â  Â  Â  Â  Â  Â  Â  Â  const existingMember = document.querySelector(`.patracdvr-member-btn[data-trigramme="${trigramme}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (existingMember) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`Le membre avec le trigramme "${trigramme}" existe dÃ©jÃ . Veuillez en choisir un autre.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (trigramme.length >= 2 && trigramme.length <= 4) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CrÃ©e le nouveau membre
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addPatracdvrMember(unassignedContainer, { trigramme: trigramme, cellule: 'Sans', fonction: 'Sans' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // SÃ©lectionne le nouveau membre pour Ã©dition rapide
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newMemberBtn = unassignedContainer.lastChild;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newMemberBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleMemberSelection({ target: newMemberBtn });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveFormData();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Le trigramme doit contenir entre 2 et 4 caractÃ¨res.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function addPatracdvrMember(containerElement, data = {}) {
Â  Â  Â  Â  Â  Â  if (!containerElement) return;
Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  btn.type = 'button';
Â  Â  Â  Â  Â  Â  btn.className = 'patracdvr-member-btn draggable';
Â  Â  Â  Â  Â  Â  btn.id = `member_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
Â  Â  Â  Â  Â  Â  btn.setAttribute('draggable', 'true');
Â  Â  Â  Â  Â  Â  const memberData = {
Â  Â  Â  Â  Â  Â  Â  Â  trigramme: 'N/A', fonction: 'Sans', cellule: 'India 1', armement: 'Sans',
Â  Â  Â  Â  Â  Â  Â  Â  equipement: 'Sans', equipement2: 'Sans',
Â  Â  Â  Â  Â  Â  Â  Â  tenue: 'UBAS', gpb: 'GPBL', ...data
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Object.keys(memberData).forEach(key => btn.dataset[key] = memberData[key]);
Â  Â  Â  Â  Â  Â  updateMemberButtonVisuals(btn);
Â  Â  Â  Â  Â  Â  containerElement.appendChild(btn);
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateMemberButtonVisuals(btn) {
Â  Â  Â  Â  Â  Â  const trigramme = btn.dataset.trigramme || 'N/A';
Â  Â  Â  Â  Â  Â  const fonction = btn.dataset.fonction || '';
Â  Â  Â  Â  Â  Â  const cellule = btn.dataset.cellule || '';
Â  Â  Â  Â  Â  Â  // Si la cellule est "Sans", on affiche juste la fonction (ou rien si "Sans")
Â  Â  Â  Â  Â  Â  const cellDisplay = cellule !== 'Sans' ? cellule : '';
Â  Â  Â  Â  Â  Â  const functionDisplay = fonction !== 'Sans' ? ` / ${fonction}` : '';
Â  Â  Â  Â  Â  Â  const separation = (cellDisplay && functionDisplay) ? '' : ''; // Si la cellule est Sans, on vire le /
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  btn.innerHTML = `<span class="trigramme">${trigramme}</span><span class="fonction">${cellDisplay}${separation}${functionDisplay}</span>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Si le membre est dans la zone non assignÃ©e, on affiche uniquement le trigramme
Â  Â  Â  Â  Â  Â  if (btn.closest('#unassigned_members_container')) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = `<span class="trigramme">${trigramme}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function openMemberModal(buttonId) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('editMemberModal');
Â  Â  Â  Â  Â  Â  const form = document.getElementById('editMemberForm');
Â  Â  Â  Â  Â  Â  const button = document.getElementById(buttonId);
Â  Â  Â  Â  Â  Â  const deleteBtn = document.getElementById('modal_deleteBtn');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!button) return;
Â  Â  Â  Â  Â  Â  form.dataset.editingButtonId = buttonId;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Logique de modification du bouton de suppression/renvoi en attente/suppression dÃ©finitive
Â  Â  Â  Â  Â  Â  const isUnassigned = button.closest('#unassigned_members_container');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (isUnassigned) {
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.textContent = 'Supprimer DÃ©finitivement';
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.style.backgroundColor = '#FF0000'; // Rouge vif pour la suppression dÃ©finitive
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.textContent = 'Renvoyer en Attente';
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtn.style.backgroundColor = 'var(--danger-red)'; // Rouge normal
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('modal_trigramme').value = button.dataset.trigramme;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Logique de peuplement des selects Ã  partir de memberConfig
Â  Â  Â  Â  Â  Â  for (const key in memberConfig) {
Â  Â  Â  Â  Â  Â  Â  Â  const attrName = key.replace(/s$/, ''); // ex: fonctions -> fonction
Â  Â  Â  Â  Â  Â  Â  Â  const selectId = 'modal_' + attrName;
Â  Â  Â  Â  Â  Â  Â  Â  const select = document.getElementById(selectId);
Â  Â  Â  Â  Â  Â  Â  Â  if (select) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.innerHTML = memberConfig[key].map(option => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selected = (button.dataset[attrName] === option) ? 'selected' : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<option value="${option}" ${selected}>${option}</option>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Correction: Assurez-vous que la valeur est correctement sÃ©lectionnÃ©e si elle existe
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  select.value = button.dataset[attrName];
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  modal.showModal();
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- NOUVELLE FONCTION: Mise Ã  jour de l'affichage de l'articulation ---
Â  Â  Â  Â  function updateArticulationDisplay() {
Â  Â  Â  Â  Â  Â  const indiaContainer = document.getElementById('india_composition_display');
Â  Â  Â  Â  Â  Â  const aoContainer = document.getElementById('ao_composition_display');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const indiaMembersByCell = {};
Â  Â  Â  Â  Â  Â  const aoMembersByCell = {};

Â  Â  Â  Â  Â  Â  document.querySelectorAll('.patracdvr-member-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  const trigramme = btn.dataset.trigramme;
Â  Â  Â  Â  Â  Â  Â  Â  const cellule = btn.dataset.cellule;
Â  Â  Â  Â  Â  Â  Â  Â  if (!trigramme || !cellule || cellule.toLowerCase() === 'sans') return;

Â  Â  Â  Â  Â  Â  Â  Â  if (cellule.toLowerCase().startsWith('india')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!indiaMembersByCell[cellule]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indiaMembersByCell[cellule] = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  indiaMembersByCell[cellule].push(trigramme);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (cellule.toLowerCase().startsWith('ao')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!aoMembersByCell[cellule]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aoMembersByCell[cellule] = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aoMembersByCell[cellule].push(trigramme);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const naturalSort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let indiaHtml = '';
Â  Â  Â  Â  Â  Â  const sortedIndiaKeys = Object.keys(indiaMembersByCell).sort(naturalSort);
Â  Â  Â  Â  Â  Â  sortedIndiaKeys.forEach(cell => {
Â  Â  Â  Â  Â  Â  Â  Â  indiaHtml += `<p><strong>${cell}:</strong> ${indiaMembersByCell[cell].join(', ')}</p>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  indiaContainer.innerHTML = indiaHtml || `<p><i>Aucun membre assignÃ© aux cellules India.</i></p>`;

Â  Â  Â  Â  Â  Â  let aoHtml = '';
Â  Â  Â  Â  Â  Â  const sortedAoKeys = Object.keys(aoMembersByCell).sort(naturalSort);
Â  Â  Â  Â  Â  Â  sortedAoKeys.forEach(cell => {
Â  Â  Â  Â  Â  Â  Â  Â  aoHtml += `<p><strong>${cell}:</strong> ${aoMembersByCell[cell].join(', ')}</p>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  aoContainer.innerHTML = aoHtml || `<p><i>Aucun membre assignÃ© aux cellules AO.</i></p>`;
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- PANNEAU D'Ã‰DITION RAPIDE & MODALE LOGIC ---
Â  Â  Â  Â  // La logique d'initialisation du panneau est rendue dynamique pour supporter les changements de config
Â  Â  Â  Â  function setupQuickEditPanel() {
Â  Â  Â  Â  Â  Â  const contentContainer = document.querySelector('#quickEditPanel .quick-edit-content');
Â  Â  Â  Â  Â  Â  contentContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  for (const key in memberConfig) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!memberConfig.hasOwnProperty(key) || !Array.isArray(memberConfig[key])) continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  const attributeName = key.replace(/s$/, ''); // ex: fonctions -> fonction
Â  Â  Â  Â  Â  Â  Â  Â  const title = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1'); // ex: equipements2 -> Ã‰quipements2
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const tabPanel = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  tabPanel.className = 'quick-edit-tab-panel active';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const panelTitle = document.createElement('h5');
Â  Â  Â  Â  Â  Â  Â  Â  panelTitle.textContent = title;
Â  Â  Â  Â  Â  Â  Â  Â  tabPanel.appendChild(panelTitle);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const optionsContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  optionsContainer.className = 'quick-edit-options';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  memberConfig[key].forEach(option => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.type = 'button';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.className = 'quick-edit-btn';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = option;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.dataset.attribute = attributeName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.dataset.value = option;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  optionsContainer.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  tabPanel.appendChild(optionsContainer);
Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.appendChild(tabPanel);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function handleMemberSelection(event) {
Â  Â  Â  Â  Â  Â  const clickedButton = event.target.closest('.patracdvr-member-btn');
Â  Â  Â  Â  Â  Â  if (!clickedButton) return;

Â  Â  Â  Â  Â  Â  if (activeMemberId === clickedButton.id) {
Â  Â  Â  Â  Â  Â  Â  Â  clickedButton.classList.remove('member-active');
Â  Â  Â  Â  Â  Â  Â  Â  activeMemberId = null;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('quickEditPanel').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (activeMemberId) {
Â  Â  Â  Â  Â  Â  Â  Â  const oldActive = document.getElementById(activeMemberId);
Â  Â  Â  Â  Â  Â  Â  Â  if (oldActive) oldActive.classList.remove('member-active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  activeMemberId = clickedButton.id;
Â  Â  Â  Â  Â  Â  clickedButton.classList.add('member-active');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (window.innerWidth < 768) {
Â  Â  Â  Â  Â  Â  Â  Â  openQuickEditModal(activeMemberId);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  populateQuickEditPanel(activeMemberId);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('quickEditPanel').style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function populateQuickEditPanel(memberId) {
Â  Â  Â  Â  Â  Â  const member = document.getElementById(memberId);
Â  Â  Â  Â  Â  Â  if (!member) return;
Â  Â  Â  Â  Â  Â  document.getElementById('selectedMemberTrigramme').textContent = member.dataset.trigramme || 'N/A';
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#quickEditPanel .quick-edit-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  const attribute = btn.dataset.attribute;
Â  Â  Â  Â  Â  Â  Â  Â  const value = btn.dataset.value;
Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.toggle('selected', member.dataset[attribute] === value);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function openQuickEditModal(memberId) {
Â  Â  Â  Â  Â  Â  const modal = document.getElementById('quickEditModal');
Â  Â  Â  Â  Â  Â  const title = document.getElementById('quick_modal_title');
Â  Â  Â  Â  Â  Â  const content = document.getElementById('quick_modal_content');
Â  Â  Â  Â  Â  Â  const member = document.getElementById(memberId);

Â  Â  Â  Â  Â  Â  if (!member) return;

Â  Â  Â  Â  Â  Â  title.textContent = `Ã‰dition Rapide: ${member.dataset.trigramme || 'N/A'}`;
Â  Â  Â  Â  Â  Â  content.innerHTML = '';

Â  Â  Â  Â  Â  Â  for (const key in memberConfig) {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!memberConfig.hasOwnProperty(key) || !Array.isArray(memberConfig[key])) continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  const attributeName = key.replace(/s$/, '');Â 
Â  Â  Â  Â  Â  Â  Â  Â  const categoryTitleText = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');Â 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const categoryDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  categoryDiv.className = 'quick-edit-category';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const categoryTitle = document.createElement('h5');
Â  Â  Â  Â  Â  Â  Â  Â  categoryTitle.textContent = categoryTitleText;
Â  Â  Â  Â  Â  Â  Â  Â  categoryDiv.appendChild(categoryTitle);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const optionsContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  optionsContainer.className = 'quick-edit-options';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  memberConfig[key].forEach(option => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.type = 'button';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.className = 'quick-edit-btn';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = option;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.dataset.attribute = attributeName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.dataset.value = option;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (member.dataset[attributeName] === option) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  optionsContainer.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  categoryDiv.appendChild(optionsContainer);
Â  Â  Â  Â  Â  Â  Â  Â  content.appendChild(categoryDiv);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  modal.showModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- DATA PERSISTENCE (SAVE/LOAD) ---
Â  Â  Â  Â  function saveFormData() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = {};
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('#oi-form input:not([type="file"]), #oi-form textarea, #oi-form select').forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (field.id) data[field.id] = field.value;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Collecte des donnÃ©es, y compris les images et leurs annotations
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.image-preview').forEach(img => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(img.id && img.src.startsWith('data:image')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data[img.id + '_src'] = img.src; // La source actuelle (annotÃ©e ou non)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data[img.id + '_original_src'] = img.dataset.originalSrc; // La source non annotÃ©e
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data[img.id + '_annotations'] = img.dataset.annotations || '[]'; // Les annotations JSON
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  data.me_list = Array.from(document.querySelectorAll('#me_container .me-input')).map(i => i.value).filter(Boolean);
Â  Â  Â  Â  Â  Â  Â  Â  data.etat_esprit_list = Array.from(document.querySelectorAll(`#etat_esprit_container .dynamic-input`)).map(i => i.value).filter(Boolean);
Â  Â  Â  Â  Â  Â  Â  Â  data.volume_list = Array.from(document.querySelectorAll(`#volume_adversaire_container .dynamic-input`)).map(i => i.value).filter(Boolean);
Â  Â  Â  Â  Â  Â  Â  Â  data.vehicules_list = Array.from(document.querySelectorAll(`#vehicules_container .dynamic-input`)).map(i => i.value).filter(Boolean);
Â  Â  Â  Â  Â  Â  Â  Â  data.patracdvr_unassigned = Array.from(unassignedContainer.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }));
Â  Â  Â  Â  Â  Â  Â  Â  data.patracdvr_rows = Array.from(document.querySelectorAll('#patracdvr_container .patracdvr-vehicle-row')).map(row => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vehicle: row.dataset.vehicleName,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  members: Array.from(row.querySelectorAll('.patracdvr-member-btn')).map(btn => ({ ...btn.dataset }))
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  data.time_events = Array.from(document.querySelectorAll('#time_events_container .time-item')).map(item => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: item.querySelector('.time-type-select').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hour: item.querySelector('.time-hour-input').value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: item.querySelector('.time-description-input').value
Â  Â  Â  Â  Â  Â  Â  Â  }));

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Tente la premiÃ¨re sauvegarde (avec images)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('oiFormData', JSON.stringify(data));
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.name === 'QuotaExceededError' || e.name === 'DOMException') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- DÃ‰BUT DE LA CORRECTION POUR L'ALERTE UNIQUE ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (localStorage.getItem('quotaAlertShown') !== 'true') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("Alerte: Espace de stockage (5Mo) atteint. Les donnÃ©es textuelles sont sauvegardÃ©es, mais les images ont Ã©tÃ© retirÃ©es de la sauvegarde locale pour Ã©viter l'erreur. Veuillez exporter la session si vous souhaitez conserver les images pour la prochaine fois.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('quotaAlertShown', 'true');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- FIN DE LA CORRECTION POUR L'ALERTE UNIQUE ---

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Suppression des images dans l'objet de sauvegarde
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(data).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key.endsWith('_src')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete data[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete data[key.replace('_src', '') + '_original_src'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  delete data[key.replace('_src', '') + '_annotations'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Tente une seconde sauvegarde (sans images)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('oiFormData', JSON.stringify(data));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw e; // Relaie d'autres erreurs
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  updateArticulationDisplay();
Â  Â  Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Save error:", e);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadFormData() {
Â  Â  Â  Â  Â  Â  const dataString = localStorage.getItem('oiFormData');
Â  Â  Â  Â  Â  Â  if (!dataString) {
Â  Â  Â  Â  Â  Â  Â  Â  return false; // Indique qu'aucune donnÃ©e n'a Ã©tÃ© chargÃ©e
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = JSON.parse(dataString);
Â  Â  Â  Â  Â  Â  Â  Â  // Retrouver les wrappers photo et appliquer les donnÃ©es stockÃ©es
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.photo-input-wrapper').forEach(wrapper => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const previewImg = wrapper.querySelector('.image-preview');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = wrapper.querySelector('.photo-input');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const span = wrapper.querySelector('.file-name-display');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const annotateBtn = wrapper.querySelector('.annotate-btn');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const srcKey = previewImg.id + '_src';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalSrcKey = previewImg.id + '_original_src';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const annotationsKey = previewImg.id + '_annotations';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data[srcKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.src = data[srcKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.dataset.originalSrc = data[originalSrcKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.dataset.annotations = data[annotationsKey] || '[]';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewImg.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (annotateBtn) annotateBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (span) span.textContent = 'Image chargÃ©e'; // Le nom original du fichier est perdu ici
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Object.keys(data).forEach(key => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key.endsWith('_src') || key.endsWith('_original_src') || key.endsWith('_annotations')) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (['patracdvr_rows', 'patracdvr_unassigned', 'time_events', 'me_list', 'etat_esprit_list', 'volume_list', 'vehicules_list'].includes(key)) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(key);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (el && !Array.isArray(data[key]) && typeof data[key] !== 'object') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  el.value = data[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  // Suppression et recrÃ©ation pour Ã©viter les doublons lors du rechargement
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('me_container').innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('etat_esprit_container').innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('volume_adversaire_container').innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('vehicules_container').innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('time_events_container').innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  (data.me_list || []).forEach(val => addMeField(val));
Â  Â  Â  Â  Â  Â  Â  Â  (data.etat_esprit_list || []).forEach(val => addDynamicFieldWithSelect('etat_esprit_container', ['Serein', 'Hostile', 'Conciliant', 'Sur ses gardes'], val));
Â  Â  Â  Â  Â  Â  Â  Â  (data.volume_list || []).forEach(val => addDynamicFieldWithSelect('volume_adversaire_container', ['Seul', 'Famille', 'BO', 'Conjointe'], val));
Â  Â  Â  Â  Â  Â  Â  Â  (data.vehicules_list || []).forEach(val => addDynamicField('vehicules_container', val));
Â  Â  Â  Â  Â  Â  Â  Â  (data.time_events || []).forEach(ev => addTimeEvent(ev.type, ev.hour, ev.description));
Â  Â  Â  Â  Â  Â  Â  Â  initializePatracdvr(data);

Â  Â  Â  Â  Â  Â  Â  Â  updateArticulationDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  return true; // Indique que les donnÃ©es ont Ã©tÃ© chargÃ©es
Â  Â  Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Load error:", e);Â 
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  function initializePatracdvr(dataFromStorage) {
Â  Â  Â  Â  Â  Â  unassignedContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  patracdvrContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (dataFromStorage && (dataFromStorage.patracdvr_rows?.length > 0 || dataFromStorage.patracdvr_unassigned?.length > 0)) {
Â  Â  Â  Â  Â  Â  Â  Â  (dataFromStorage.patracdvr_unassigned || []).forEach(member => addPatracdvrMember(unassignedContainer, member));
Â  Â  Â  Â  Â  Â  Â  Â  (dataFromStorage.patracdvr_rows || []).forEach(row => addPatracdvrRow(row.vehicle, row.members));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // Fonction unique pour charger les membres et les options depuis un objet config
Â  Â  Â  Â  function loadConfigObject(config) {
Â  Â  Â  Â  Â  Â  if (config.options) {
Â  Â  Â  Â  Â  Â  Â  Â  // Met Ã  jour la configuration globale
Â  Â  Â  Â  Â  Â  Â  Â  Object.assign(memberConfig, config.options);
Â  Â  Â  Â  Â  Â  Â  Â  setupQuickEditPanel();Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Assurez-vous que les selects d'Ã©dition complÃ¨te sont Ã©galement mis Ã  jour
Â  Â  Â  Â  Â  Â  Â  Â  const modal = document.getElementById('editMemberModal');Â 
Â  Â  Â  Â  Â  Â  Â  Â  const form = document.getElementById('editMemberForm');
Â  Â  Â  Â  Â  Â  Â  Â  if (form.dataset.editingButtonId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openMemberModal(form.dataset.editingButtonId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (config.members && Array.isArray(config.members)) {
Â  Â  Â  Â  Â  Â  Â  Â  unassignedContainer.innerHTML = '';Â 
Â  Â  Â  Â  Â  Â  Â  Â  patracdvrContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  config.members.forEach(memberData => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const defaultData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cellule: memberData.cellule || 'Sans',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fonction: memberData.fonction || 'Sans',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...memberData
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addPatracdvrMember(unassignedContainer, defaultData);Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  saveFormData();Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // Fonction pour charger la config par dÃ©faut depuis le fichier
Â  Â  Â  Â  async function loadDefaultConfig() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(DEFAULT_CONFIG_FILE);
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Ã‰chec du chargement de ${DEFAULT_CONFIG_FILE}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const config = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  loadConfigObject(config);
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`[Config Info] Impossible de charger la configuration par dÃ©faut (${DEFAULT_CONFIG_FILE}). Utilisation de la configuration interne.`, e);
Â  Â  Â  Â  Â  Â  Â  Â  setupQuickEditPanel(); // Au moins initialiser le panneau avec la config par dÃ©faut interne
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- DRAG & DROP ---
Â  Â  Â  Â  let draggedItem = null;

Â  Â  Â  Â  function getDragAfterElement(container, y) {
Â  Â  Â  Â  Â  Â  const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
Â  Â  Â  Â  Â  Â  return draggableElements.reduce((closest, child) => {
Â  Â  Â  Â  Â  Â  Â  Â  const box = child.getBoundingClientRect(); const offset = y - box.top - box.height / 2;
Â  Â  Â  Â  Â  Â  Â  Â  if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else { return closest; }
Â  Â  Â  Â  Â  Â  }, { offset: Number.NEGATIVE_INFINITY }).element;
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDragEnter(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const targetContainer = e.currentTarget;
Â  Â  Â  Â  Â  Â  if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  targetContainer.style.border = '2px dashed var(--accent-blue)';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDragOver(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();Â 
Â  Â  Â  Â  Â  Â  const targetContainer = e.currentTarget;
Â  Â  Â  Â  Â  Â  if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  const afterElement = getDragAfterElement(targetContainer, e.clientY);
Â  Â  Â  Â  Â  Â  Â  Â  if (afterElement == null) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetContainer.appendChild(draggedItem);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  targetContainer.insertBefore(draggedItem, afterElement);Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDragLeave(e) {
Â  Â  Â  Â  Â  Â  e.currentTarget.style.border = '1px dashed var(--border-color)';
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDrop(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const targetContainer = e.currentTarget;
Â  Â  Â  Â  Â  Â  targetContainer.style.border = '1px dashed var(--border-color)';

Â  Â  Â  Â  Â  Â  if (draggedItem && draggedItem.classList.contains('patracdvr-member-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  // DÃ©place l'Ã©lÃ©ment (dÃ©jÃ  fait par handleDragOver, mais on le fait ici pour confirmer)
Â  Â  Â  Â  Â  Â  Â  Â  targetContainer.appendChild(draggedItem);

Â  Â  Â  Â  Â  Â  Â  Â  // DÃ©termine si le membre est dans un vÃ©hicule ou dans la zone non assignÃ©e
Â  Â  Â  Â  Â  Â  Â  Â  const isUnassignedZone = targetContainer.id === 'unassigned_members_container';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Met Ã  jour l'attribut de cellule de l'Ã©lÃ©ment dÃ©placÃ©
Â  Â  Â  Â  Â  Â  Â  Â  if (isUnassignedZone) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  draggedItem.dataset.cellule = 'Sans';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  draggedItem.dataset.fonction = 'Sans';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Si le membre est dÃ©posÃ© dans un vÃ©hicule
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (draggedItem.dataset.cellule === 'Sans') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â draggedItem.dataset.cellule = 'India 1'; // Valeur par dÃ©faut si non dÃ©finie
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  updateMemberButtonVisuals(draggedItem);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // RÃ©initialise l'Ã©tat actif et l'affichage rapide si l'Ã©lÃ©ment dÃ©placÃ© Ã©tait sÃ©lectionnÃ©
Â  Â  Â  Â  Â  Â  Â  Â  if (draggedItem.id === activeMemberId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  draggedItem.classList.remove('member-active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeMemberId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (window.innerWidth >= 768) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('quickEditPanel').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  saveFormData();
Â  Â  Â  Â  Â  Â  Â  Â  draggedItem = null; // RÃ©initialiser aprÃ¨s le dÃ©pÃ´t
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- FIN DRAG & DROP ---

Â  Â  Â  Â  // --- TUTORIAL SYSTEM ---
Â  Â  Â  Â  const tutorialSteps = [
Â  Â  Â  Â  Â  Â  { text: "Bienvenue dans le gÃ©nÃ©rateur d'Ordre Initial. Ce guide vous assistera dans la crÃ©ation de votre document opÃ©rationnel.", selector: '.container', center: true },
Â  Â  Â  Â  Â  Â  { text: "Cette barre de progression indique les diffÃ©rentes sections de l'O.I. Vous pouvez cliquer sur une Ã©tape pour y naviguer directement.", selector: '.wizard-progress' },
Â  Â  Â  Â  Â  Â  { text: "Commencez par dÃ©finir le contexte gÃ©nÃ©ral et particulier de l'opÃ©ration, ainsi que sa date.", selector: '#date_op', step: 0 },
Â  Â  Â  Â  Â  Â  { text: "DÃ©taillez ici toutes les informations relatives Ã  l'adversaire. Chargez une photo, et le bouton 'Annoter' apparaÃ®tra pour y ajouter des indications visuelles.", selector: '#adversary_photo_container', step: 1 },
Â  Â  Â  Â  Â  Â  { text: "Renseignez les informations sur les unitÃ©s amies, le terrain, la mÃ©tÃ©o, la population et le cadre juridique de l'intervention.", selector: '#terrain_info', step: 2 },
Â  Â  Â  Â  Â  Â  { text: "La mission principale de l'unitÃ© est prÃ©-remplie dans cette section. Vous pouvez la modifier si nÃ©cessaire.", selector: '#missions_psig', step: 3 },
Â  Â  Â  Â  Â  Â  { text: "DÃ©finissez la chronologie de l'action. Vous pouvez ajouter des Ã©vÃ©nements et les rÃ©organiser par glisser-dÃ©poser.", selector: '#time_events_container', step: 4 },
Â  Â  Â  Â  Â  Â  { text: "DÃ©crivez l'articulation des Ã©quipes. La composition est dÃ©sormais automatiquement importÃ©e depuis l'onglet PATRACDVR.", selector: '.collapsible-container:first-of-type', step: 5 },
Â  Â  Â  Â  Â  Â  { text: "GÃ©rez la composition des Ã©quipes en cliquant sur un membre pour ouvrir le panneau d'Ã©dition rapide. Les changements seront visibles dans l'onglet Articulation.", selector: '#unassigned_members_container', step: 6 },
Â  Â  Â  Â  Â  Â  { text: "Cette section permet d'ajouter des photos complÃ©mentaires (transport, effraction...) qui seront incluses dans le document final.", selector: '.wizard-step:nth-of-type(8)', step: 7 },
Â  Â  Â  Â  Â  Â  { text: "SpÃ©cifiez les conduites Ã  tenir gÃ©nÃ©rales, les conditions de dÃ©sengagement (NO GO), et les procÃ©dures de liaison.", selector: '#cat_generales', step: 8 },
Â  Â  Â  Â  Â  Â  { text: "Une fois le formulaire complÃ©tÃ©, vous pouvez prÃ©visualiser le document, gÃ©nÃ©rer le PDF final, ou lancer une analyse de comptes-rendus.", selector: '#generatePdfBtn', step: 9 },
Â  Â  Â  Â  Â  Â  { text: "Ce menu flottant offre un accÃ¨s rapide aux fonctions globales: sauvegarder (exporter) ou charger (importer) une session, changer le thÃ¨me, rÃ©initialiser le formulaire, ou relancer ce tutoriel.", selector: '#dockMenu' }
Â  Â  Â  Â  ];
Â  Â  Â  Â  
Â  Â  Â  Â  let currentTutorialStep = 0;
Â  Â  Â  Â  const tutorialPopup = document.getElementById('tutorial-popup'); const popupText = document.getElementById('popup-text');
Â  Â  Â  Â  const nextPopupBtn = document.getElementById('next-popup-btn'); const closePopupBtn = tutorialPopup.querySelector('.close-btn');
Â  Â  Â  Â  let currentHighlightedElement = null;
Â  Â  Â  Â  function startTutorial() { if (tutorialPopup.style.display === 'flex') { hideTutorial(); return; } goToStep(0); currentTutorialStep = 0; showTutorialStep(currentTutorialStep); }
Â  Â  Â  Â  function showTutorialStep(stepIndex) {
Â  Â  Â  Â  Â  Â  if (stepIndex >= tutorialSteps.length) { hideTutorial(); return; }
Â  Â  Â  Â  Â  Â  const step = tutorialSteps[stepIndex];
Â  Â  Â  Â  Â  Â  if (step.step !== undefined && step.step !== currentStep) { goToStep(step.step); setTimeout(() => showTutorialStep(stepIndex), 600); return; }
Â  Â  Â  Â  Â  Â  if (currentHighlightedElement) { currentHighlightedElement.classList.remove('highlight-element'); }
Â  Â  Â  Â  Â  Â  popupText.textContent = step.text; nextPopupBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Terminer' : 'Suivant';
Â  Â  Â  Â  Â  Â  if (step.center) {
Â  Â  Â  Â  Â  Â  Â  Â  tutorialPopup.style.top = '50%'; tutorialPopup.style.left = '50%'; tutorialPopup.style.transform = 'translate(-50%, -50%)';
Â  Â  Â  Â  Â  Â  Â  Â  tutorialPopup.style.display = 'flex'; currentHighlightedElement = null; return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const targetElement = document.querySelector(step.selector);
Â  Â  Â  Â  Â  Â  if (!targetElement) { console.warn(`Element non trouvÃ©: ${step.selector}`); currentTutorialStep++; showTutorialStep(currentTutorialStep); return; }
Â  Â  Â  Â  Â  Â  targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
Â  Â  Â  Â  Â  Â  targetElement.classList.add('highlight-element'); currentHighlightedElement = targetElement;
Â  Â  Â  Â  Â  Â  const rect = targetElement.getBoundingClientRect(); const popupWidth = tutorialPopup.offsetWidth; const popupHeight = tutorialPopup.offsetHeight;
Â  Â  Â  Â  Â  Â  let popupX = rect.left + window.scrollX + (rect.width / 2) - (popupWidth / 2);
Â  Â  Â  Â  Â  Â  let popupY = rect.top + window.scrollY - popupHeight - 20;
Â  Â  Â  Â  Â  Â  if (popupY < window.scrollY + 10) { popupY = rect.bottom + window.scrollY + 20; }
Â  Â  Â  Â  Â  Â  if (popupX < 10) popupX = 10;
Â  Â  Â  Â  Â  Â  if (popupX + popupWidth > window.innerWidth - 10) { popupX = window.innerWidth - popupWidth - 10; }
Â  Â  Â  Â  Â  Â  tutorialPopup.style.top = `${popupY}px`; tutorialPopup.style.left = `${popupX}px`;
Â  Â  Â  Â  Â  Â  tutorialPopup.style.transform = 'none'; tutorialPopup.style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â  function hideTutorial() { if (currentHighlightedElement) { currentHighlightedElement.classList.remove('highlight-element'); } tutorialPopup.style.display = 'none'; }
Â  Â  Â  Â  nextPopupBtn.addEventListener('click', () => { currentTutorialStep++; showTutorialStep(currentTutorialStep); });
Â  Â  Â  Â  closePopupBtn.addEventListener('click', hideTutorial);
Â  Â  Â  Â  
Â  Â  Â  Â  // --- LOGIQUE D'ANNOTATION ---
Â  Â  Â  Â  const annotationModal = document.getElementById('annotationModal');
Â  Â  Â  Â  const canvas = document.getElementById('annotationCanvas');
Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  const baseImage = new Image();
Â  Â  Â  Â  let annotations = [], currentTool = 'move', isDrawing = false, isDragging = false, startX, startY;
Â  Â  Â  Â  let currentAnnotation = null, selectedAnnotation = null, dragOffsetX, dragOffsetY;
Â  Â  Â  Â  const rotationInput = document.getElementById('rotation_input');
Â  Â  Â  Â  // Ajout d'une variable de redimensionnement/dÃ©placement (uniquement drag sur mobile)
Â  Â  Â  Â  let isMovingAnnotation = false;

Â  Â  Â  Â  function setContextualTools(selection) {
Â  Â  Â  Â  Â  Â  const contextualTools = document.getElementById('contextual_tools');
Â  Â  Â  Â  Â  Â  if (selection) {
Â  Â  Â  Â  Â  Â  Â  Â  contextualTools.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  contextualTools.classList.toggle('location-selected', selection.type === 'location');
Â  Â  Â  Â  Â  Â  Â  Â  rotationInput.value = Math.round((selection.rotation || 0) * 180 / Math.PI) % 360;
Â  Â  Â  Â  Â  Â  Â  Â  if (rotationInput.value < 0) rotationInput.value = 360 + parseInt(rotationInput.value);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  contextualTools.classList.remove('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function updateAnnotationRotation() {
Â  Â  Â  Â  Â  Â  if (selectedAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  const degrees = parseFloat(rotationInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.rotation = degrees * Math.PI / 180;
Â  Â  Â  Â  Â  Â  Â  Â  redrawCanvas();
Â  Â  Â  Â  Â  Â  Â  Â  saveFormData(); // Sauvegarder la rotation
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function setActiveTool(toolId) {
Â  Â  Â  Â  Â  Â  currentTool = toolId;
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tool-btn.active, .tool-controls.active').forEach(el => el.classList.remove('active'));
Â  Â  Â  Â  Â  Â  const toolButton = document.getElementById(`tool_${toolId}`);
Â  Â  Â  Â  Â  Â  if (toolButton) toolButton.classList.add('active');
Â  Â  Â  Â  Â  Â  const toolControls = document.getElementById(`controls_${toolId}`);
Â  Â  Â  Â  Â  Â  if (toolControls) toolControls.classList.add('active');
Â  Â  Â  Â  Â  Â  canvas.style.cursor = toolId === 'move' ? 'grab' : 'crosshair'; // Cursor grab pour le dÃ©placement
Â  Â  Â  Â  Â  Â  selectedAnnotation = null;
Â  Â  Â  Â  Â  Â  setContextualTools(null);
Â  Â  Â  Â  }

Â  Â  Â  Â  function openAnnotationModal(previewImgId) {
Â  Â  Â  Â  Â  Â  const previewImg = document.getElementById(previewImgId);
Â  Â  Â  Â  Â  Â  if (!previewImg || !previewImg.dataset.originalSrc) return;
Â  Â  Â  Â  Â  Â  baseImage.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = baseImage.width;
Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = baseImage.height;
Â  Â  Â  Â  Â  Â  Â  Â  // S'assurer de la prÃ©sence des annotations, sinon crÃ©er un tableau vide
Â  Â  Â  Â  Â  Â  Â  Â  annotations = JSON.parse(previewImg.dataset.annotations || '[]');
Â  Â  Â  Â  Â  Â  Â  Â  setActiveTool('move');
Â  Â  Â  Â  Â  Â  Â  Â  redrawCanvas();
Â  Â  Â  Â  Â  Â  Â  Â  annotationModal.dataset.targetPreviewId = previewImgId;
Â  Â  Â  Â  Â  Â  Â  Â  annotationModal.showModal();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  baseImage.src = previewImg.dataset.originalSrc; // Charge TOUJOURS l'image originale
Â  Â  Â  Â  }

Â  Â  Â  Â  function redrawCanvas() {
Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);
Â  Â  Â  Â  Â  Â  ctx.drawImage(baseImage, 0, 0);
Â  Â  Â  Â  Â  Â  annotations.forEach(drawAnnotation);
Â  Â  Â  Â  Â  Â  if (isDrawing && currentAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  drawAnnotation(currentAnnotation);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (selectedAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  drawSelectionBorder(selectedAnnotation);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawSelectionBorder(annotation) {
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.setLineDash([5, 5]);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = 'white';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  let centerX, centerY;
Â  Â  Â  Â  Â  Â  let x, y, width, height;

Â  Â  Â  Â  Â  Â  if (annotation.type === 'location') {
Â  Â  Â  Â  Â  Â  Â  Â  x = annotation.x - annotation.radius;
Â  Â  Â  Â  Â  Â  Â  Â  y = annotation.y - annotation.radius;
Â  Â  Â  Â  Â  Â  Â  Â  width = annotation.radius * 2;
Â  Â  Â  Â  Â  Â  Â  Â  height = annotation.radius * 2;
Â  Â  Â  Â  Â  Â  Â  Â  centerX = annotation.x;
Â  Â  Â  Â  Â  Â  Â  Â  centerY = annotation.y;
Â  Â  Â  Â  Â  Â  } else if (annotation.type === 'box') {
Â  Â  Â  Â  Â  Â  Â  Â  x = annotation.x;
Â  Â  Â  Â  Â  Â  Â  Â  y = annotation.y;
Â  Â  Â  Â  Â  Â  Â  Â  width = annotation.width;
Â  Â  Â  Â  Â  Â  Â  Â  height = annotation.height;
Â  Â  Â  Â  Â  Â  Â  Â  centerX = annotation.x + annotation.width / 2;
Â  Â  Â  Â  Â  Â  Â  Â  centerY = annotation.y + annotation.height / 2;
Â  Â  Â  Â  Â  Â  } else if (annotation.type === 'arrow') {
Â  Â  Â  Â  Â  Â  Â  Â  const minX = Math.min(annotation.startX, annotation.endX);
Â  Â  Â  Â  Â  Â  Â  Â  const minY = Math.min(annotation.startY, annotation.endY);
Â  Â  Â  Â  Â  Â  Â  Â  const maxX = Math.max(annotation.startX, annotation.endX);
Â  Â  Â  Â  Â  Â  Â  Â  const maxY = Math.max(annotation.startY, annotation.endY);
Â  Â  Â  Â  Â  Â  Â  Â  // On met une marge pour faciliter la sÃ©lection
Â  Â  Â  Â  Â  Â  Â  Â  x = minX - 10;
Â  Â  Â  Â  Â  Â  Â  Â  y = minY - 10;
Â  Â  Â  Â  Â  Â  Â  Â  width = maxX - minX + 20;
Â  Â  Â  Â  Â  Â  Â  Â  height = maxY - minY + 20;
Â  Â  Â  Â  Â  Â  Â  Â  centerX = (annotation.startX + annotation.endX) / 2;
Â  Â  Â  Â  Â  Â  Â  Â  centerY = (annotation.startY + annotation.endY) / 2;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (annotation.rotation) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.translate(centerX, centerY);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.rotate(annotation.rotation);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.translate(-centerX, -centerY);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  ctx.strokeRect(x, y, width, height);
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawAnnotation(annotation) {
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  let centerX, centerY;
Â  Â  Â  Â  Â  Â  if (annotation.type === 'location') {
Â  Â  Â  Â  Â  Â  Â  Â  centerX = annotation.x;
Â  Â  Â  Â  Â  Â  Â  Â  centerY = annotation.y;
Â  Â  Â  Â  Â  Â  } else if (annotation.type === 'box') {
Â  Â  Â  Â  Â  Â  Â  Â  centerX = annotation.x + annotation.width / 2;
Â  Â  Â  Â  Â  Â  Â  Â  centerY = annotation.y + annotation.height / 2;
Â  Â  Â  Â  Â  Â  } else if (annotation.type === 'arrow') {
Â  Â  Â  Â  Â  Â  Â  Â  centerX = (annotation.startX + annotation.endX) / 2;
Â  Â  Â  Â  Â  Â  Â  Â  centerY = (annotation.startY + annotation.endY) / 2;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (annotation.rotation) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.translate(centerX, centerY);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.rotate(annotation.rotation);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.translate(-centerX, -centerY);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  switch (annotation.type) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'location': {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const radius = annotation.radius || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (radius < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.arc(annotation.x, annotation.y, radius, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = `rgba(91, 155, 213, ${annotation.opacity || 0.5})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#5b9bd5';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (annotation.text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = 'black';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.font = `bold ${Math.max(12, radius / 2)}px Oswald`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText(annotation.text, annotation.x, annotation.y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  case 'arrow': {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawArrow(annotation.startX, annotation.startY, annotation.endX, annotation.endY, annotation.thickness || 5);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  case 'box': {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#c0392b';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = annotation.thickness || 5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeRect(annotation.x, annotation.y, annotation.width, annotation.height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Fonction corrigÃ©e pour le dessin de la flÃ¨che
Â  Â  Â  Â  function drawArrow(fromx, fromy, tox, toy, lineWidth) {
Â  Â  Â  Â  Â  Â  if (fromx === tox && fromy === toy) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#c0392b';
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#c0392b';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = lineWidth;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const dx = tox - fromx;
Â  Â  Â  Â  Â  Â  const dy = toy - fromy;
Â  Â  Â  Â  Â  Â  const angle = Math.atan2(dy, dx);
Â  Â  Â  Â  Â  Â  const headlen = Math.max(lineWidth * 3, 10); // Taille de la tÃªte de flÃ¨che
Â  Â  Â  Â  Â  Â  const arrowLength = Math.sqrt(dx * dx + dy * dy);

Â  Â  Â  Â  Â  Â  // On s'assure que la ligne s'arrÃªte un peu avant la pointe pour qu'elle ne dÃ©passe pas
Â  Â  Â  Â  Â  Â  const lineToX = tox - (headlen * 0.7) * Math.cos(angle);
Â  Â  Â  Â  Â  Â  const lineToY = toy - (headlen * 0.7) * Math.sin(angle);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Si la flÃ¨che est trop courte pour la tÃªte
Â  Â  Â  Â  Â  Â  if (arrowLength < headlen * 1.5) {
Â  Â  Â  Â  Â  Â  Â  Â  // Simplification pour les flÃ¨ches trÃ¨s courtes, dessiner une simple ligne Ã©paisse
Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(fromx, fromy);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineTo(tox, toy);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Dessin de la ligne
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(fromx, fromy);
Â  Â  Â  Â  Â  Â  ctx.lineTo(lineToX, lineToY);
Â  Â  Â  Â  Â  Â  ctx.stroke();

Â  Â  Â  Â  Â  Â  // Dessin de la tÃªte de flÃ¨che
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(tox, toy);
Â  Â  Â  Â  Â  Â  ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 7), toy - headlen * Math.sin(angle - Math.PI / 7));
Â  Â  Â  Â  Â  Â  ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 7), toy - headlen * Math.sin(angle + Math.PI / 7));
Â  Â  Â  Â  Â  Â  ctx.closePath();
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  }

Â  Â  Â  Â  function getEventPos(canvas, evt) {
Â  Â  Â  Â  Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
Â  Â  Â  Â  Â  Â  const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
Â  Â  Â  Â  Â  Â  const scaleX = canvas.width / rect.width;
Â  Â  Â  Â  Â  Â  const scaleY = canvas.height / rect.height;
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  x: (clientX - rect.left) * scaleX,
Â  Â  Â  Â  Â  Â  Â  Â  y: (clientY - rect.top) * scaleY
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // Fonction utilitaire pour la rotation inverse
Â  Â  Â  Â  function getRotatedPoint(x, y, centerX, centerY, angle) {
Â  Â  Â  Â  Â  Â  const cos = Math.cos(-angle);
Â  Â  Â  Â  Â  Â  const sin = Math.sin(-angle);
Â  Â  Â  Â  Â  Â  const translatedX = x - centerX;
Â  Â  Â  Â  Â  Â  const translatedY = y - centerY;
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  x: translatedX * cos - translatedY * sin + centerX,
Â  Â  Â  Â  Â  Â  Â  Â  y: translatedX * sin + translatedY * cos + centerY
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  function getAnnotationAtPosition(x, y) {
Â  Â  Â  Â  Â  Â  for (let i = annotations.length - 1; i >= 0; i--) {
Â  Â  Â  Â  Â  Â  Â  Â  const annotation = annotations[i];
Â  Â  Â  Â  Â  Â  Â  Â  const angle = annotation.rotation || 0;
Â  Â  Â  Â  Â  Â  Â  Â  let centerX, centerY;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (annotation.type === 'location') { centerX = annotation.x; centerY = annotation.y; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (annotation.type === 'box') { centerX = annotation.x + annotation.width / 2; centerY = annotation.y + annotation.height / 2; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (annotation.type === 'arrow') { centerX = (annotation.startX + annotation.endX) / 2; centerY = (annotation.startY + annotation.endY) / 2; }

Â  Â  Â  Â  Â  Â  Â  Â  // Inverse la rotation de la position du clic
Â  Â  Â  Â  Â  Â  Â  Â  const rotatedPos = getRotatedPoint(x, y, centerX, centerY, angle);
Â  Â  Â  Â  Â  Â  Â  Â  const testX = rotatedPos.x;
Â  Â  Â  Â  Â  Â  Â  Â  const testY = rotatedPos.y;

Â  Â  Â  Â  Â  Â  Â  Â  const tolerance = 15;
Â  Â  Â  Â  Â  Â  Â  Â  let isInside = false;

Â  Â  Â  Â  Â  Â  Â  Â  switch (annotation.type) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'location':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isInside = Math.sqrt(Math.pow(testX - annotation.x, 2) + Math.pow(testY - annotation.y, 2)) <= annotation.radius + tolerance / 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'box':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isInside = testX >= annotation.x - tolerance && testX <= annotation.x + annotation.width + tolerance &&
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  testY >= annotation.y - tolerance && testY <= annotation.y + annotation.height + tolerance;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'arrow':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dx = annotation.endX - annotation.startX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dy = annotation.endY - annotation.startY;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lenSq = dx * dx + dy * dy;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (lenSq === 0) break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const t = ((testX - annotation.startX) * dx + (testY - annotation.startY) * dy) / lenSq;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const projX = annotation.startX + t * dx;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const projY = annotation.startY + t * dy;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (t >= 0 && t <= 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isInside = Math.pow(testX - projX, 2) + Math.pow(testY - projY, 2) <= Math.pow(annotation.thickness + tolerance, 2);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (isInside) return annotation;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDrawStart(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const pos = getEventPos(canvas, e);
Â  Â  Â  Â  Â  Â  startX = pos.x;
Â  Â  Â  Â  Â  Â  startY = pos.y;
Â  Â  Â  Â  Â  Â  if (currentTool === 'move') {
Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation = getAnnotationAtPosition(pos.x, pos.y);
Â  Â  Â  Â  Â  Â  Â  Â  setContextualTools(selectedAnnotation);
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isMovingAnnotation = true; // Renommage pour clarifier : on est en mode dÃ©placement/modification.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.style.overflow = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  redrawCanvas(); // Redraw with border
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  isDrawing = true;
Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation = null;
Â  Â  Â  Â  Â  Â  Â  Â  setContextualTools(null);
Â  Â  Â  Â  Â  Â  Â  Â  currentAnnotation = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: currentTool,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startX: startX,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startY: startY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endX: startX,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endY: startY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rotation: 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDrawMove(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  if (!isDrawing && !isMovingAnnotation) return; // Utilise isMovingAnnotation
Â  Â  Â  Â  Â  Â  const pos = getEventPos(canvas, e);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (isMovingAnnotation && selectedAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  // Logique de dÃ©placement (simplifiÃ© pour le mobile : on bouge tout)
Â  Â  Â  Â  Â  Â  Â  Â  const deltaX = pos.x - startX;
Â  Â  Â  Â  Â  Â  Â  Â  const deltaY = pos.y - startY;

Â  Â  Â  Â  Â  Â  Â  Â  if (selectedAnnotation.type === 'arrow') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.startX += deltaX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.startY += deltaY;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.endX += deltaX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.endY += deltaY;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Pour Location et Box, on dÃ©place x et y
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.x += deltaX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation.y += deltaY;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Met Ã  jour la position de dÃ©part pour le prochain mouvement
Â  Â  Â  Â  Â  Â  Â  Â  startX = pos.x;
Â  Â  Â  Â  Â  Â  Â  Â  startY = pos.y;
Â  Â  Â  Â  Â  Â  Â  Â  redrawCanvas();

Â  Â  Â  Â  Â  Â  } else if (isDrawing && currentAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  currentAnnotation.endX = pos.x;
Â  Â  Â  Â  Â  Â  Â  Â  currentAnnotation.endY = pos.y;
Â  Â  Â  Â  Â  Â  Â  Â  redrawCanvas();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleDrawEnd(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  document.body.style.overflow = '';
Â  Â  Â  Â  Â  Â  if (isMovingAnnotation) {
Â  Â  Â  Â  Â  Â  Â  Â  isMovingAnnotation = false;
Â  Â  Â  Â  Â  Â  Â  Â  redrawCanvas();Â 
Â  Â  Â  Â  Â  Â  Â  Â  saveFormData(); // Sauvegarde aprÃ¨s le dÃ©placement
Â  Â  Â  Â  Â  Â  } else if (isDrawing) {
Â  Â  Â  Â  Â  Â  Â  Â  isDrawing = false;
Â  Â  Â  Â  Â  Â  Â  Â  const final = { ...currentAnnotation };
Â  Â  Â  Â  Â  Â  Â  Â  if (final.type === 'box') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.x = Math.min(final.startX, final.endX);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.y = Math.min(final.startY, final.endY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.width = Math.abs(final.startX - final.endX);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.height = Math.abs(final.startY - final.endY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.thickness = document.getElementById('box_thickness').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (final.width < 5 || final.height < 5) return;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (final.type === 'arrow') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.thickness = document.getElementById('arrow_thickness').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Math.abs(final.startX - final.endX) < 5 && Math.abs(final.startY - final.endY) < 5) return;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (final.type === 'location') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.x = final.startX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.y = final.startY;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.radius = Math.sqrt(Math.pow(final.endX - final.startX, 2) + Math.pow(final.endY - final.startY, 2));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.text = document.getElementById('circle_text').value || 'Zone';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final.opacity = document.getElementById('circle_opacity').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (final.radius < 5) return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  annotations.push(final);
Â  Â  Â  Â  Â  Â  Â  Â  currentAnnotation = null;
Â  Â  Â  Â  Â  Â  Â  Â  selectedAnnotation = final; // SÃ©lectionne la nouvelle annotation aprÃ¨s la crÃ©ation
Â  Â  Â  Â  Â  Â  Â  Â  setContextualTools(selectedAnnotation);
                redrawCanvas();
                saveFormData(); // Sauvegarde aprÃ¨s la crÃ©ation
            }
        }
        
        // --- LOGIQUE CRITIQUE DE GÃ‰NÃ‰RATION D'IMAGE ANNOTÃ‰E POUR PDF ---
        /**
         * Re-gÃ©nÃ¨re l'image avec toutes ses annotations et la retourne comme un Blob.
         * @param {string} originalSrc L'URL de l'image de base non annotÃ©e (dataURL).
         * @param {Array} annotationsData L'array d'objets d'annotation.
         * @returns {Promise<Blob>} Le Blob de l'image annotÃ©e.
         */
        function createAnnotatedImageBlob(originalSrc, annotationsData) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous'; 
                img.src = originalSrc;
                
                img.onload = () => {
                    tempCanvas.width = img.width;
                    tempCanvas.height = img.height;
                    tempCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                    tempCtx.drawImage(img, 0, 0);

                    // Dessin des annotations sur le canvas temporaire
                    annotationsData.forEach(annotation => drawAnnotationOnContext(tempCtx, img.width, img.height, annotation));

                    // Conversion du canvas en Blob
                    tempCanvas.toBlob(blob => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error('La conversion de l\'image annotÃ©e en Blob a Ã©chouÃ©.'));
                        }
                    }, 'image/jpeg', 0.9); // Utilise JPEG pour rÃ©duire la taille du PDF
                };
                img.onerror = () => reject(new Error('Impossible de charger l\'image de base pour l\'annotation.'));
            });
        }
        
        /**
         * Fonction de dessin d'annotation rÃ©utilisable (pour le canvas normal et le canvas temporaire PDF).
         * @param {CanvasRenderingContext2D} context Le contexte de dessin.
         * @param {number} canvasWidth Largeur du canvas.
         * @param {number} canvasHeight Hauteur du canvas.
         * @param {Object} annotation L'objet d'annotation.
         */
        function drawAnnotationOnContext(context, canvasWidth, canvasHeight, annotation) {
            context.save();
            let centerX, centerY;
            if (annotation.type === 'location') {
                centerX = annotation.x;
                centerY = annotation.y;
            } else if (annotation.type === 'box') {
                centerX = annotation.x + annotation.width / 2;
                centerY = annotation.y + annotation.height / 2;
            } else if (annotation.type === 'arrow') {
                centerX = (annotation.startX + annotation.endX) / 2;
                centerY = (annotation.startY + annotation.endY) / 2;
            }
            
            if (annotation.rotation) {
                context.translate(centerX, centerY);
                context.rotate(annotation.rotation);
                context.translate(-centerX, -centerY);
            }

            switch (annotation.type) {
                case 'location': {
                    const radius = annotation.radius || 0;
                    if (radius < 2) { context.restore(); return; }
                    context.beginPath(); context.arc(annotation.x, annotation.y, radius, 0, 2 * Math.PI);
                    context.fillStyle = `rgba(91, 155, 213, ${annotation.opacity || 0.5})`; context.fill();
                    context.strokeStyle = '#5b9bd5'; context.lineWidth = 2; context.stroke();
                    if (annotation.text) {
                        context.fillStyle = 'black'; context.font = `bold ${Math.max(12, radius / 2)}px Oswald`;
                        context.textAlign = 'center'; context.textBaseline = 'middle';
                        context.fillText(annotation.text, annotation.x, annotation.y);
                    }
                    break;
                }
                case 'arrow': {
                    // Utilise une version locale et simplifiÃ©e de drawArrow pour le contexte PDF
                    const drawArrowLocal = (fromx, fromy, tox, toy, lineWidth) => {
                         if (fromx === tox && fromy === toy) return;
                         context.strokeStyle = '#c0392b'; context.fillStyle = '#c0392b'; context.lineWidth = lineWidth;
                         const headlen = Math.max(lineWidth * 3, 10); 
                         const dx = tox - fromx; const dy = toy - fromy;
                         const angle = Math.atan2(dy, dx);
                         const lineToX = tox - (headlen * 0.7) * Math.cos(angle);
                         const lineToY = toy - (headlen * 0.7) * Math.sin(angle);
                         
                         context.beginPath(); context.moveTo(fromx, fromy); context.lineTo(lineToX, lineToY); context.stroke();
                         context.beginPath(); context.moveTo(tox, toy);
                         context.lineTo(tox - headlen * Math.cos(angle - Math.PI / 7), toy - headlen * Math.sin(angle - Math.PI / 7));
                         context.lineTo(tox - headlen * Math.cos(angle + Math.PI / 7), toy - headlen * Math.sin(angle + Math.PI / 7));
                         context.closePath(); context.fill();
                    };
                    drawArrowLocal(annotation.startX, annotation.startY, annotation.endX, annotation.endY, annotation.thickness || 5);
                    break;
                }
                case 'box': {
                    context.strokeStyle = '#c0392b'; context.lineWidth = annotation.thickness || 5;
                    context.strokeRect(annotation.x, annotation.y, annotation.width, annotation.height);
                    break;
                }
            }
            context.restore();
        }
        
        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // 1. Initialiser le champ photo (avant le chargement des donnÃ©es)
            if (document.querySelectorAll('#adversary_photo_container .photo-input-wrapper').length === 0) {
                 addPhotoInput('adversary_photo_container', true); 
            }
            
            // 2. Charger les donnÃ©es locales ou la config par dÃ©faut
            const isLocalDataLoaded = loadFormData();
            if (!isLocalDataLoaded) {
                 await loadDefaultConfig();
            }

            // 3. Initialiser l'UI (Quick Edit, etc.) aprÃ¨s le chargement des options
            setupQuickEditPanel(); 

            document.querySelector('.container').addEventListener('click', (event) => {
                const header = event.target.closest('.collapsible-header');
                if (header) { const container = header.parentElement; if (container && container.classList.contains('collapsible-container')) { container.classList.toggle('open'); } }
            });
            const modal = document.getElementById('editMemberModal'); const form = document.getElementById('editMemberForm');
            document.getElementById('modal_saveBtn').addEventListener('click', () => {
                const buttonId = form.dataset.editingButtonId; const button = document.getElementById(buttonId);
                if (button) {
                    button.dataset.trigramme = document.getElementById('modal_trigramme').value;
                    
                    for (const key in memberConfig) {
                        const attrName = key.replace(/s$/, '');
                        const selectId = 'modal_' + attrName;
                        const select = document.getElementById(selectId);
                        if (select) {
                            button.dataset[attrName] = select.value;
                        }
                    }
                    
                    updateMemberButtonVisuals(button);
                    populateQuickEditPanel(buttonId);
                    saveFormData();
                }
                modal.close();
            });
            document.getElementById('modal_cancelBtn').addEventListener('click', () => modal.close());
            
            // Logique de renvoi en attente / suppression dÃ©finitive
            document.getElementById('modal_deleteBtn').addEventListener('click', () => {
                const buttonId = form.dataset.editingButtonId; const button = document.getElementById(buttonId);
                const isUnassigned = button.closest('#unassigned_members_container');

                if (!button) return;

                if (isUnassigned) {
                    // Si dans 'Personnel Ã  attribuer', on supprime dÃ©finitivement
                    if(confirm(`Voulez-vous vraiment SUPPRIMER DÃ‰FINITIVEMENT le membre ${button.dataset.trigramme || 'N/A'}? Cette action est irrÃ©versible.`)) {
                        button.remove(); 
                        saveFormData(); 
                        modal.close(); 
                        activeMemberId = null;
                        document.getElementById('quickEditPanel').style.display = 'none';
                    }
                } else {
                    // Si dans un vÃ©hicule, on renvoie dans 'Personnel Ã  attribuer'
                    if(confirm(`Voulez-vous renvoyer le membre ${button.dataset.trigramme || 'N/A'} dans la section "Personnel Ã  attribuer"?`)) {
                        button.dataset.cellule = 'Sans'; // On rÃ©initialise sa cellule
                        button.dataset.fonction = 'Sans'; // On rÃ©initialise sa fonction
                        updateMemberButtonVisuals(button);
                        unassignedContainer.appendChild(button);
                        saveFormData(); 
                        modal.close(); 
                        activeMemberId = null;
                        document.getElementById('quickEditPanel').style.display = 'none';
                    }
                }
            });
            
            const dockMenu = document.getElementById('dockMenu'); const dockToggleBtn = document.getElementById('dockToggleBtn');
            dockToggleBtn.addEventListener('click', (event) => { event.stopPropagation(); dockMenu.classList.toggle('collapsed'); localStorage.setItem('dockCollapsed', dockMenu.classList.contains('collapsed')); });
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.body.classList.toggle('light-mode'); document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                document.getElementById('darkModeIcon').textContent = isDarkMode ? 'nightlight' : 'clear_day';
            });
            document.getElementById('settingsBtn').addEventListener('click', () => {
                const settingsModal = document.getElementById('settingsModal');
                document.getElementById('geminiApiKey').value = localStorage.getItem('geminiApiKey') || '';
                settingsModal.showModal();
            });
            document.getElementById('settings_closeBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').close();
            });
            document.getElementById('settings_saveBtn').addEventListener('click', () => {
                const apiKey = document.getElementById('geminiApiKey').value;
                if (apiKey) {
                    localStorage.setItem('geminiApiKey', apiKey);
                    alert("ClÃ© API sauvegardÃ©e.");
                    document.getElementById('settingsModal').close();
                } else {
                    alert("Veuillez saisir une clÃ© API.");
                }
            });
            document.getElementById('resetBtn').addEventListener('click', () => { 
                if (confirm("Voulez-vous vraiment rÃ©initialiser tout le formulaire?")) { 
                    localStorage.removeItem('oiFormData'); 
                    // Supprime le drapeau d'alerte pour qu'il s'affiche Ã  nouveau si l'erreur se reproduit
                    localStorage.removeItem('quotaAlertShown'); 
                    location.reload(); 
                } 
            });
            document.getElementById('tutorialBtn').addEventListener('click', startTutorial);
            
            // Nouveau gestionnaire d'Ã©vÃ©nement pour le bouton d'import JSON
            importJsonConfigBtn.addEventListener('click', () => {
                 jsonConfigInput.click();
            });
            
            jsonConfigInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) { return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const config = JSON.parse(e.target.result);
                        if (config && (Array.isArray(config.members) || config.options)) {
                            // Supprime les donnÃ©es existantes avant de charger la nouvelle config
                            patracdvrContainer.innerHTML = ''; 
                            loadConfigObject(config); 
                        }
                        else { alert("Le fichier JSON est invalide ou ne contient pas de tableau 'members' ou d'objet 'options'."); }
                    } catch (err) { alert("Erreur de lecture du JSON."); console.error(err); }
                };
                reader.readAsText(file);
                // RÃ©initialise l'input pour permettre l'import du mÃªme fichier si besoin
                event.target.value = null; 
            });

            // --- NOUVEAU: Chargement de la config par dÃ©faut sur clic ---
            importDefaultConfigBtn.addEventListener('click', () => {
                if(confirm("Ceci va remplacer la configuration PATRACDVR et les options d'Ã©quipement actuelles. Continuer?")) {
                    loadDefaultConfig();
                }
            });
            
            // --- Logique RETEX originale (GÃ©nÃ©ration de lien externe) ---
            retexReportBtn.addEventListener('click', () => {
                 const dateOp = document.getElementById('date_op').value;
                 const nomAdversaire = document.getElementById('nom_adversaire').value;
                 if (!dateOp || !nomAdversaire) {
                    alert("Veuillez renseigner la date de l'opÃ©ration et le nom de l'adversaire pour crÃ©er le lien RETEX.");
                    return;
                 }
                 const safeAdversaireName = nomAdversaire.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                 const oiId = `${dateOp}_${safeAdversaireName}`;
                 const retexUrl = `${RETEX_BASE_URL}?oiId=${encodeURIComponent(oiId)}`;
                 window.open(retexUrl, '_blank');
            });
            // --- Fin Logique RETEX originale ---
            
            resetPatracdvrBtn.addEventListener('click', () => { 
                if (confirm("Voulez-vous vraiment effacer TOUS les vÃ©hicules et membres du PATRACDVR et vider la sauvegarde locale des membres ?")) { 
                    patracdvrContainer.innerHTML = ''; 
                    unassignedContainer.innerHTML = ''; 
                    localStorage.removeItem('oiFormData'); // Assurez-vous d'effacer les donnÃ©es du stockage local
                    saveFormData(); 
                    alert("PATRACDVR rÃ©initialisÃ©. La prochaine fois, une configuration par dÃ©faut sera chargÃ©e (si disponible).");
                } 
            });
            
            const vehicleCreationContainer = document.getElementById('vehicle_creation_buttons');
            availableVehicles.forEach(vehicle => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'add-btn add-vehicle-btn';
                btn.textContent = `â• ${vehicle}`;
                btn.addEventListener('click', () => addPatracdvrRow(vehicle));
                vehicleCreationContainer.insertBefore(btn, document.getElementById('addManualVehicleBtn'));
            });

            // Ajout des Ã©couteurs d'Ã©vÃ©nements pour les nouveaux boutons manuels
            document.getElementById('addManualVehicleBtn').addEventListener('click', addManualVehicle);
            document.getElementById('addManualMemberBtn').addEventListener('click', addManualMember);

            document.querySelector('.wizard-step:has(#patracdvr_container)').addEventListener('click', handleMemberSelection);

            document.getElementById('quickEditPanel').addEventListener('click', (event) => {
                event.stopPropagation();
                const target = event.target;
                const quickEditButton = target.closest('.quick-edit-btn');
                const fullEditButton = target.closest('#fullEditBtn');

                if (quickEditButton && activeMemberId) {
                    const activeMember = document.getElementById(activeMemberId);
                    if (!activeMember) return;
                    const attribute = quickEditButton.dataset.attribute;
                    const value = quickEditButton.dataset.value;
                    activeMember.dataset[attribute] = value;
                    
                    // Si on change la cellule, mettre Ã  jour la fonction si on passe Ã  "Sans" ou vice-versa
                    if (attribute === 'cellule' && value === 'Sans') {
                        activeMember.dataset.fonction = 'Sans';
                    }
                    if (attribute === 'fonction' && value !== 'Sans' && activeMember.dataset.cellule === 'Sans') {
                        activeMember.dataset.cellule = 'India 1'; // Assure une cellule par dÃ©faut si on donne une fonction
                    }
                    
                    updateMemberButtonVisuals(activeMember);
                    const group = quickEditButton.parentElement;
                    group.querySelectorAll('.quick-edit-btn').forEach(btn => btn.classList.remove('selected'));
                    quickEditButton.classList.add('selected');
                    saveFormData();
                } else if (fullEditButton && activeMemberId) {
                    openMemberModal(activeMemberId);
                }
            });

            const quickEditModal = document.getElementById('quickEditModal');
            document.getElementById('quick_modal_closeBtn').addEventListener('click', () => quickEditModal.close());
            quickEditModal.addEventListener('click', (event) => {
                const target = event.target.closest('.quick-edit-btn');
                if (!target || !activeMemberId) return;

                const activeMember = document.getElementById(activeMemberId);
                if (!activeMember) return;

                const attribute = target.dataset.attribute;
                const value = target.dataset.value;

                activeMember.dataset[attribute] = value;
                
                // Logique de mise Ã  jour de la cellule/fonction
                if (attribute === 'cellule' && value === 'Sans') {
                    activeMember.dataset.fonction = 'Sans';
                }
                if (attribute === 'fonction' && value !== 'Sans' && activeMember.dataset.cellule === 'Sans') {
                    activeMember.dataset.cellule = 'India 1';
                }
                
                updateMemberButtonVisuals(activeMember);
                
                const group = target.closest('.quick-edit-options');
                if(group) {
                    group.querySelectorAll('.quick-edit-btn').forEach(btn => btn.classList.remove('selected'));
                }
                target.classList.add('selected');

                saveFormData();
            });


            canvas.addEventListener('mousedown', handleDrawStart); canvas.addEventListener('mousemove', handleDrawMove);
            canvas.addEventListener('mouseup', handleDrawEnd); canvas.addEventListener('mouseout', handleDrawEnd);
            // Correction: Utiliser { passive: false } pour empÃªcher le dÃ©filement pendant le dessin/dÃ©placement sur mobile
            canvas.addEventListener('touchstart', handleDrawStart, { passive: false }); 
            canvas.addEventListener('touchmove', handleDrawMove, { passive: false });
            canvas.addEventListener('touchend', handleDrawEnd);
            
            document.querySelectorAll('.toolbar-main-tools .tool-btn').forEach(btn => {
                btn.addEventListener('click', () => { const toolId = btn.id.split('_')[1]; if (['move', 'location', 'arrow', 'box'].includes(toolId)) setActiveTool(toolId); });
            });
            document.getElementById('tool_reset').addEventListener('click', () => { annotations = []; selectedAnnotation = null; setContextualTools(null); redrawCanvas(); saveFormData();});
            document.getElementById('annotation_cancel').addEventListener('click', () => annotationModal.close());
            document.getElementById('annotation_save').addEventListener('click', () => {
                const targetId = annotationModal.dataset.targetPreviewId; const previewImg = document.getElementById(targetId);
                if(previewImg) {
                    // La source affichÃ©e reste la derniÃ¨re image annotÃ©e (ou l'originale si pas d'annotation)
                    // Mais on sauvegarde les annotations dans le dataset
                    previewImg.dataset.annotations = JSON.stringify(annotations);
                }
                // NOTE: La source du previewImg n'est plus mise Ã  jour ici car l'image annotÃ©e sera re-gÃ©nÃ©rÃ©e DANS buildPdf.
                saveFormData(); annotationModal.close();
            });
            
            // Ã‰vÃ©nement pour la rotation libre
            rotationInput.addEventListener('change', updateAnnotationRotation);

            document.getElementById('delete_btn').addEventListener('click', () => { if(selectedAnnotation){ annotations = annotations.filter(ann => ann !== selectedAnnotation); selectedAnnotation = null; setContextualTools(null); redrawCanvas(); saveFormData(); } });
            document.getElementById('edit_text_btn').addEventListener('click', () => { if(selectedAnnotation && selectedAnnotation.type === 'location'){ const newText = prompt('Modifier texte:', selectedAnnotation.text); if(newText !== null){ selectedAnnotation.text = newText; redrawCanvas(); saveFormData(); } } });
            
            const importSessionBtn = document.getElementById('importSessionBtn');
            const exportSessionBtn = document.getElementById('exportSessionBtn');
            const sessionFileInput = document.getElementById('sessionFileInput');
            importSessionBtn.addEventListener('click', () => sessionFileInput.click());
            exportSessionBtn.addEventListener('click', () => {
                saveFormData();
                const dataString = localStorage.getItem('oiFormData');
                if (!dataString) { alert("Aucune donnÃ©e Ã  exporter."); return; }
                const blob = new Blob([dataString], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                link.download = `OI_Session_${date}.json`;
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
            });
            sessionFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonContent = e.target.result;
                        JSON.parse(jsonContent);
                        localStorage.setItem('oiFormData', jsonContent);
                        alert("Session importÃ©e avec succÃ¨s. Rechargement de la page.");
                        location.reload();
                    } catch (err) {
                        alert("Fichier invalide ou corrompu.");
                    }
                };
                reader.readAsText(file);
                event.target.value = null;
            });

            // --- GESTION DU DRAG AND DROP GLOBALE ---
            document.addEventListener('dragstart', e => { 
                const target = e.target.closest('.patracdvr-member-btn, .time-item');
                if (target && target.classList.contains('draggable')) { 
                    draggedItem = target; 
                    // Stocke l'ID ou toute info nÃ©cessaire pour identifier le membre
                    e.dataTransfer.setData('text/plain', target.id);
                    setTimeout(() => target.classList.add('dragging'), 0); 
                } 
            });

            document.addEventListener('dragend', () => { 
                if (draggedItem) { 
                    draggedItem.classList.remove('dragging'); 
                    draggedItem = null; 
                    // La sauvegarde se fait dans handleDrop
                } 
            });

            // Cibler les conteneurs de dÃ©pÃ´t (Ã  la fois les zones de vÃ©hicule et la zone non assignÃ©e)
            const dropContainers = document.querySelectorAll('.patracdvr-members-container, #unassigned_members_container');
            dropContainers.forEach(container => {
                container.addEventListener('dragenter', handleDragEnter);
                container.addEventListener('dragleave', handleDragLeave);
                container.addEventListener('dragover', handleDragOver); // Pour le tri visuel
                container.addEventListener('drop', handleDrop);
            });

            // Logique de dragover pour les Ã©vÃ©nements temporels (gestion du tri Ã  l'intÃ©rieur)
            document.addEventListener('dragover', e => {
                e.preventDefault();
                const targetContainer = e.target.closest('#time_events_container');
                if (targetContainer && draggedItem && draggedItem.classList.contains('time-item')) {
                    const afterElement = getDragAfterElement(targetContainer, e.clientY);
                    if (afterElement == null) { targetContainer.appendChild(draggedItem); } 
                    else { targetContainer.insertBefore(draggedItem, afterElement); }
                }
            });
            // --- FIN GESTION DRAG AND DROP GLOBALE ---

            if (localStorage.getItem('theme') === 'light') { document.body.classList.replace('dark-mode', 'light-mode'); document.getElementById('darkModeIcon').textContent = 'clear_day'; }
            if (localStorage.getItem('dockCollapsed') === 'true') { dockMenu.classList.add('collapsed'); }
            
            showStep(currentStep);
        });
        
        // --- PDF GENERATION ---
        async function buildPdf() {
            const { PDFDocument, StandardFonts, rgb, PageSizes } = PDFLib;
            const pdfDoc = await PDFDocument.create();
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBoldFont = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            saveFormData();
            const formDataString = localStorage.getItem('oiFormData');
            if (!formDataString) { alert("Aucune donnÃ©e Ã  gÃ©nÃ©rer."); return null; }
            const formData = JSON.parse(formDataString);
            const getVal = (id) => formData[id] || '';
            const isDarkMode = document.body.classList.contains('dark-mode');
            const context = {
                pdfDoc, helveticaFont, helveticaBoldFont,
                currentPage: null, y: 0, pageWidth: 0, pageHeight: 0, margin: 40,
                colors: isDarkMode ? { background: rgb(30/255, 30/255, 30/255), text: rgb(1, 1, 1), accent: rgb(91/255, 155/255, 213/255) } : { background: rgb(1, 1, 1), text: rgb(0, 0, 0), accent: rgb(0, 51/255, 160/255) }
            };
            let backgroundImage = null;
            try {
                const bgImageUrl = 'Fd.png';
                // Assurez-vous que l'URL 'Fd.png' est accessible
                const bgImageBytes = await fetch(bgImageUrl).then(res => res.arrayBuffer());
                backgroundImage = await pdfDoc.embedPng(bgImageBytes);
            } catch (e) { console.warn("L'image de fond 'Fd.png' n'a pas pu Ãªtre chargÃ©e.", e); }
            
            const addNewPage = () => {
                context.currentPage = context.pdfDoc.addPage([PageSizes.A4[1], PageSizes.A4[0]]);
                const { width, height } = context.currentPage.getSize();
                context.pageWidth = width; context.pageHeight = height; context.y = height - context.margin;
                context.currentPage.drawRectangle({ x: 0, y: 0, width, height, color: context.colors.background });
            };
            const checkY = (spaceNeeded) => { if (context.y - spaceNeeded < context.margin) { addNewPage(); return true; } return false; };
            const drawTitle = (text) => { checkY(30); context.currentPage.drawText(text, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 18, color: context.colors.accent }); context.y -= 30; };
            const drawSubTitle = (text) => { if (checkY(25)) { context.y -= 10; } context.currentPage.drawText(text, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 14, color: context.colors.accent }); context.y -= 25; };
            const wrapText = (text, font, size, maxWidth) => {
                const words = String(text || '').replace(/\n/g, ' \n ').split(' ');
                let lines = []; let currentLine = '';
                for (const word of words) {
                    if (word === '\n') { lines.push(currentLine); currentLine = ''; continue; }
                    const lineWithWord = currentLine === '' ? word : `${currentLine} ${word}`;
                    if (font.widthOfTextAtSize(lineWithWord, size) > maxWidth && currentLine !== '') { lines.push(currentLine); currentLine = word; } 
                    else { currentLine = lineWithWord; }
                }
                lines.push(currentLine); return lines;
            };
            const drawWrappedText = (text, options = {}) => {
                const { font = helveticaFont, size = 12, color = context.colors.text, x = context.margin + 15 } = options;
                const maxWidth = context.pageWidth - x - context.margin;
                const lines = wrapText(text, font, size, maxWidth);
                const totalHeight = lines.length * (size + 4);
                if (checkY(totalHeight + 10)) { context.y -= (size + 4); }
                lines.forEach((line, index) => { context.currentPage.drawText(line, { x, y: context.y - (index * (size + 4)), font, size, color }); });
                context.y -= (totalHeight + 10);
            };
            // Fonction modifiÃ©e pour inclure la position de dÃ©part X
            const drawTable = (headers, rows, columnWidths, startX) => {
                let currentY = context.y; const rowPadding = 5; const headerFontSize = 10; const contentFontSize = 10;
                const drawRow = (rowData, isHeader) => {
                    const font = isHeader ? helveticaBoldFont : helveticaFont; const size = isHeader ? headerFontSize : contentFontSize;
                    const cellContents = rowData.map((text, i) => wrapText(text, font, size, columnWidths[i] - 2 * rowPadding));
                    const maxLines = Math.max(...cellContents.map(lines => lines.length));
                    const rowHeight = maxLines * (size + 2) + 2 * rowPadding;
                    if (currentY - rowHeight < context.margin) { addNewPage(); currentY = context.y; drawRow(headers, true); }
                    currentY -= rowHeight; let currentX = startX;
                    rowData.forEach((_, i) => {
                        context.currentPage.drawRectangle({ x: currentX, y: currentY, width: columnWidths[i], height: rowHeight, borderColor: context.colors.accent, borderWidth: 0.5 });
                        const lines = cellContents[i];
                        lines.forEach((line, lineIndex) => { context.currentPage.drawText(line, { x: currentX + rowPadding, y: currentY + rowHeight - rowPadding - (lineIndex + 1) * (size + 2) + 2, font, size, color: context.colors.text }); });
                        currentX += columnWidths[i];
                    });
                };
                drawRow(headers, true); rows.forEach(row => drawRow(row, false)); context.y = currentY - 20;
            };
            
            // Fonction unifiÃ©e pour l'image, gÃ¨re l'image de base OU l'image annotÃ©e
            const processImage = async (imageSrc, originalSrc, annotationsJson, maxWidth = 1280, quality = 0.85) => {
                const annotations = JSON.parse(annotationsJson || '[]');
                
                if (annotations.length > 0 && originalSrc) {
                    // Si annotations, recrÃ©er l'image annotÃ©e via le canvas temporaire
                    const blob = await createAnnotatedImageBlob(originalSrc, annotations);
                    return blob.arrayBuffer();
                } else {
                    // Sinon, traiter l'image de base (ou la derniÃ¨re source)
                    return new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous'; 
                        
                        let srcToLoad = imageSrc || originalSrc; // Priorise imageSrc s'il y a une dataURL de chargÃ©e.
                        if (!srcToLoad || !srcToLoad.startsWith('data:image')) {
                             return reject(new Error('Source d\'image invalide ou manquante.'));
                        }
                        img.src = srcToLoad;

                        img.onload = () => {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            let { width, height } = img;
                            if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                            canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob(blob => {
                                if (!blob) return reject(new Error('La conversion de l\'image a Ã©chouÃ©.'));
                                blob.arrayBuffer().then(resolve).catch(reject);
                            }, 'image/jpeg', quality);
                        };
                        img.onerror = (err) => { reject(new Error(`Impossible de charger l'image: ${err.message}`)); };
                    });
                }
            };

            const drawImagesFromContainer = async (containerId, title) => {
                const wrappers = document.querySelectorAll(`#${containerId} .photo-input-wrapper`);
                for (let i = 0; i < wrappers.length; i++) {
                    const wrapper = wrappers[i];
                    const previewImg = wrapper.querySelector('.image-preview');
                    if (!previewImg || !previewImg.dataset.originalSrc) continue;

                    addNewPage();
                    try {
                        const imageSrc = previewImg.src;
                        const originalSrc = previewImg.dataset.originalSrc;
                        const annotationsJson = previewImg.dataset.annotations;

                        const imageBytes = await processImage(imageSrc, originalSrc, annotationsJson);
                        const image = await pdfDoc.embedJpg(imageBytes);
                        
                        const { width, height } = context.currentPage.getSize();
                        const paddedW = width - context.margin * 2; const paddedH = height - context.margin * 2 - 30;
                        const scaled = image.scaleToFit(paddedW, paddedH);
                        const x = (width - scaled.width) / 2; const y = (height - scaled.height) / 2 + 15;
                        context.currentPage.drawImage(image, { x, y, width: scaled.width, height: scaled.height });
                        const finalTitle = wrappers.length > 1 ? `${title} (${i+1})` : title;
                        const textWidth = helveticaBoldFont.widthOfTextAtSize(finalTitle, 14);
                        context.currentPage.drawText(finalTitle, { x: width / 2 - textWidth / 2, y: y - 20, font: helveticaBoldFont, size: 14, color: context.colors.text });
                    } catch (e) {
                        console.error(`Erreur d'intÃ©gration de l'image pour: ${title}`, e);
                        drawTitle("Erreur d'image"); drawWrappedText(`Impossible de charger une image.\n\nErreur: ${e.message}`);
                    }
                }
            };
            
            // --- NOUVELLES FONCTIONS POUR LA COMPOSITION STYLISÃ‰E ---
            const getCompositionData = (teamPrefix) => {
                const membersByCell = {};
                const allMembers = (formData.patracdvr_rows || []).flatMap(row => row.members);
                
                allMembers.forEach(member => {
                    if (member.cellule && member.cellule.toLowerCase().startsWith(teamPrefix)) {
                        if (!membersByCell[member.cellule]) membersByCell[member.cellule] = [];
                        membersByCell[member.cellule].push(member.trigramme);
                    }
                });

                const naturalSort = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                const sortedKeys = Object.keys(membersByCell).sort(naturalSort);
                
                return sortedKeys.map(cell => ({ cell: cell, members: membersByCell[cell] }));
            };

            const drawCompositionList = (compositionData) => {
                const fontSize = 12;
                const lineHeight = fontSize + 4;
                if (checkY(lineHeight)) { context.y -= 10; }

                let currentX = context.margin + 15;
                const cellStyle = { font: helveticaBoldFont, color: rgb(1, 0, 0), size: fontSize };
                const trigrammeStyle = { font: helveticaBoldFont, color: context.colors.text, size: fontSize };
                const separatorStyle = { font: helveticaFont, color: context.colors.text, size: fontSize };
                
                compositionData.forEach((group, groupIndex) => {
                    const cellShortName = group.cell.toLowerCase().replace('india ', 'I').replace('ao', 'AO').toUpperCase();
                    
                    const groupParts = [];
                    groupParts.push({ text: cellShortName, style: cellStyle });
                    groupParts.push({ text: ' : ', style: separatorStyle });
                    group.members.forEach((member, memberIndex) => {
                        groupParts.push({ text: member, style: trigrammeStyle });
                        if (memberIndex < group.members.length - 1) {
                            groupParts.push({ text: ' - ', style: separatorStyle });
                        }
                    });
                     if (groupIndex < compositionData.length - 1) {
                        groupParts.push({ text: '    ', style: separatorStyle });
                    }

                    for(const part of groupParts) {
                        const partWidth = part.style.font.widthOfTextAtSize(part.text, part.style.size);
                        if (currentX + partWidth > context.pageWidth - context.margin) {
                            context.y -= lineHeight;
                            currentX = context.margin + 15;
                            if (checkY(lineHeight)) { context.y -= 10; }
                        }
                        context.currentPage.drawText(part.text, { x: currentX, y: context.y, ...part.style });
                        currentX += partWidth;
                    }
                });
                context.y -= (lineHeight + 10);
            };


            const pdfCreationLogic = async () => {
                addNewPage();
                if (backgroundImage) { context.currentPage.drawImage(backgroundImage, { x: 0, y: 0, width: context.pageWidth, height: context.pageHeight }); }
                const mainTitle = "OPÃ‰RATION DE POLICE JUDICIAIRE";
                const dateTitle = `DU ${getVal('date_op') || '(DATE)'}`;
                const titleWidth = helveticaBoldFont.widthOfTextAtSize(mainTitle, 24);
                const dateTitleWidth = helveticaBoldFont.widthOfTextAtSize(dateTitle, 18);
                context.currentPage.drawText(mainTitle, { x: context.pageWidth / 2 - titleWidth / 2, y: context.pageHeight / 2 + 10, font: helveticaBoldFont, size: 24, color: context.colors.accent });
                context.currentPage.drawText(dateTitle, { x: context.pageWidth / 2 - dateTitleWidth / 2, y: context.pageHeight / 2 - 20, font: helveticaBoldFont, size: 18, color: context.colors.text });

                addNewPage();
                drawTitle("1. SITUATION");
                drawSubTitle("1.1 Situation GÃ©nÃ©rale"); drawWrappedText(getVal('situation_generale'), { size: 14 });
                drawSubTitle("1.2 Situation ParticuliÃ¨re"); drawWrappedText(getVal('situation_particuliere'), { size: 14 });
                
                addNewPage();
                drawTitle("1.3 ADVERSAIRE");
      
                // --- DÃ‰BUT DE LA LOGIQUE D'AJOUT DE LA PHOTO DE L'ADVERSAIRE ---
                const initialAdversaireY = context.y;
                const photoBoxWidth = 200;
                const photoBoxHeight = 220;
                const photoBoxX = context.pageWidth - context.margin - photoBoxWidth;
                const photoBoxY = initialAdversaireY - photoBoxHeight;
                
                let imageKey = null;
                let imageSource = null;
                let originalSrc = null;
                let annotationsJson = '[]';
                
                // Cherche l'image principale de l'adversaire
                const allPhotoKeys = Object.keys(formData).filter(k => k.startsWith('preview_photo_'));
                const mainPhotoKey = allPhotoKeys.find(k => document.getElementById(k.replace('_src', ''))?.closest('#adversary_photo_container'));
                
                if (mainPhotoKey) {
                    imageKey = mainPhotoKey;
                    imageSource = formData[mainPhotoKey];
                    originalSrc = formData[mainPhotoKey.replace('_src', '') + '_original_src'];
                    annotationsJson = formData[mainPhotoKey.replace('_src', '') + '_annotations'];
                }

                const adversaireHeaders = ["Information", "DÃ©tail"];
                const meText = (formData.me_list || []).map((me, i) => `ME${i+1}: ${me}`).join(' | ');
                const adversaireRows = [
                    ['Nom/PrÃ©nom', getVal('nom_adversaire')], ['Domicile', getVal('domicile_adversaire')],
                    ['Naissance', `${getVal('date_naissance')} Ã  ${getVal('lieu_naissance')}`],
                    ['Description', `${getVal('stature_adversaire')} / ${getVal('ethnie_adversaire')}`],
                    ['Signes particuliers', getVal('signes_particuliers')], ['Profession', getVal('profession_adversaire')],
                    ['AntÃ©cÃ©dents', getVal('antecedents_adversaire')], ['Ã‰tat d\'esprit', (formData.etat_esprit_list || []).join(', ')],
                    ['Attitude', getVal('attitude_adversaire')], ['Volume (renfort)', (formData.volume_list || []).join(', ')],
                    ['Substances', getVal('substances_adversaire')], ['VÃ©hicules', (formData.vehicules_list || []).join(', ')],
                    ['Armes', getVal('armes_connues')], ['Moyens EmployÃ©s', meText],
                ].filter(row => row[1] && String(row[1]).trim() !== 'Ã '); // Filtration pour enlever les lignes vides

                const maxTableWidth = imageSource ? photoBoxX - context.margin - 10 : context.pageWidth - context.margin * 2;
                
                let tableBottomY;

                if (adversaireRows.length > 0) {
                    drawTable(adversaireHeaders, adversaireRows, [150, maxTableWidth - 150], context.margin);
                    tableBottomY = context.y;
                } else {
                    tableBottomY = initialAdversaireY - 20; // Si pas de tableau, on laisse de la place
                    context.y = tableBottomY;
                }
                
                let photoBottomY = tableBottomY;

                if (imageSource && originalSrc) { // Image de base prÃ©sente
                    try {
                        const imageBytes = await processImage(imageSource, originalSrc, annotationsJson);
                        const image = await pdfDoc.embedJpg(imageBytes);
                        
                        // Calcul de la taille de l'image
                        const scaled = image.scaleToFit(photoBoxWidth - 10, initialAdversaireY - context.margin - 30); // RÃ©duit un peu plus la hauteur
                        const frameY = initialAdversaireY - photoBoxHeight;
                        const imageY = frameY + (photoBoxHeight - scaled.height) / 2; // Centrage vertical de l'image dans le cadre

                        if(frameY >= context.margin) {
                            context.currentPage.drawRectangle({
                                x: photoBoxX, y: frameY, width: photoBoxWidth, height: photoBoxHeight,
                                borderColor: context.colors.accent, borderWidth: 1
                            });
                            context.currentPage.drawImage(image, {
                                x: photoBoxX + (photoBoxWidth - scaled.width) / 2,
                                y: imageY,
                                width: scaled.width, height: scaled.height
                            });
                            const photoTitle = "Photo de l'objectif";
                            const titleWidth = helveticaFont.widthOfTextAtSize(photoTitle, 10);
                            context.currentPage.drawText(photoTitle, {
                                x: photoBoxX + (photoBoxWidth - titleWidth) / 2,
                                y: frameY + 5,
                                font: helveticaFont, size: 10, color: context.colors.text
                            });
                            photoBottomY = frameY;
                        }
                    } catch (e) {
                         console.error("Ã‰chec du traitement de la photo de l'adversaire (annotÃ©e ou non):", e);
                        // En cas d'erreur ou d'absence d'image, afficher un cadre simple
                        context.currentPage.drawRectangle({
                            x: photoBoxX, y: photoBoxY, width: photoBoxWidth, height: photoBoxHeight,
                            borderColor: context.colors.accent, borderWidth: 1
                        });
                        const photoText = "PHOTO INDISPONIBLE";
                        const textWidth = helveticaBoldFont.widthOfTextAtSize(photoText, 12);
                        context.currentPage.drawText(photoText, {
                            x: photoBoxX + (photoBoxWidth - textWidth) / 2,
                            y: photoBoxY + (photoBoxHeight / 2) - 6,
                            font: helveticaBoldFont, size: 12, color: context.colors.text
                        });
                        photoBottomY = photoBoxY;
                    }
                }
                
                // On s'assure que le contenu suivant commence sous l'Ã©lÃ©ment le plus bas (tableau ou photo)
                context.y = Math.min(tableBottomY, photoBottomY) - 20;

                // --- FIN DE LA LOGIQUE D'AJOUT DE LA PHOTO ---
                
                await drawImagesFromContainer('adversary_extra_photos_container', 'Photo SupplÃ©mentaire - Adversaire');
                await drawImagesFromContainer('renforts_photo_container', 'Photo - Renfort Potentiel');

                addNewPage();
                drawTitle("1.4 ENVIRONNEMENT");
                drawSubTitle("Ami(e)s (soutien)"); drawWrappedText(getVal('amies'), { size: 14 });
                drawSubTitle("Terrain / MÃ©tÃ©o"); drawWrappedText(getVal('terrain_info'), { size: 14 });
                drawSubTitle("Population"); drawWrappedText(getVal('population'), { size: 14 });
                drawSubTitle("Cadre juridique"); drawWrappedText(getVal('cadre_juridique'), { size: 14 });
                
                addNewPage();
                drawTitle("2. MISSION");
                drawWrappedText(getVal('missions_psig'), { font: helveticaBoldFont, size: 30, x: context.margin });
                
                await drawImagesFromContainer('photo_container_transport_pr', 'Transport PSIG vers PR');
                await drawImagesFromContainer('photo_container_transport_domicile', 'Transport PR vers Domicile');
                await drawImagesFromContainer('photo_container_bapteme_terrain', 'BaptÃªme terrain');

                addNewPage();
                drawTitle("3. EXÃ‰UTION");
                const execText = `En vue d'apprÃ©hender le mis en cause et empÃªcher la dÃ©perdition des preuves,\nJe veux, le ${getVal('date_execution') || '(date)'} Ã  partir de ${getVal('heure_execution') || '(heure)'}, pour une action ${getVal('type_action') || '(type d\'action)'} investir le domicile\nprÃ©sumÃ© de ${getVal('nom_adversaire') || '(nom de l\'adversaire)'} aprÃ¨s avoir bouclÃ© celui-ci.`;
                drawWrappedText(execText, { size: 16, x: context.margin, lineHeight: 8 });
                drawSubTitle("Chronologie des temps");
                const chronoHeaders = ["Type", "Heure", "Description"];
                const chronoRows = (formData.time_events || []).map(e => [e.type || 'N/A', e.hour || 'N/A', e.description || 'N/A']);
                drawTable(chronoHeaders, chronoRows, [80, 120, 550], context.margin);
                drawSubTitle("HypothÃ¨ses");
                drawWrappedText(`H1: ${getVal('hypothese_h1')}\nH2: ${getVal('hypothese_h2')}\nH3: ${getVal('hypothese_h3')}`, { size: 14 });

                addNewPage();
                drawTitle("4. ARTICULATION");
                drawWrappedText(`Place du Chef (GÃ©nÃ©rale): ${getVal('place_chef')}`, { size: 14, x: context.margin });
                drawSubTitle("Ã‰quipe INDIA (INTER)"); 
                drawSubTitle("Composition:"); drawCompositionList(getCompositionData('india'));
                drawSubTitle("Mission:"); drawWrappedText(getVal('india_mission'));
                drawSubTitle("Objectif:"); drawWrappedText(getVal('india_objectif')); drawSubTitle("ItinÃ©raire:");
                drawWrappedText(getVal('india_itineraire')); drawSubTitle("Points Particuliers:"); drawWrappedText(getVal('india_points_particuliers'));
                drawSubTitle("Conduite Ã  Tenir:"); drawWrappedText(getVal('india_cat'));
                
                await drawImagesFromContainer('photo_container_itineraire_exterieur', 'ItinÃ©raire ExtÃ©rieur India');
                await drawImagesFromContainer('photo_container_itineraire_interieur', 'ItinÃ©raire IntÃ©rieur India');
                await drawImagesFromContainer('photo_container_cellule_effraction', 'Cellule Effraction');
                
                addNewPage();
                drawTitle("4. ARTICULATION (Suite)");
                drawSubTitle("Ã‰quipe Appui/Observation (AO) - ZMSPCP"); 
                drawSubTitle("Composition:"); drawCompositionList(getCompositionData('ao'));
                drawSubTitle("Zone d'installation (Z):");
                drawWrappedText(getVal('ao_zone_installation')); drawSubTitle("Mission (M):"); drawWrappedText(getVal('ao_mission'));
                drawSubTitle("Secteur de surveillance (S):"); drawWrappedText(getVal('ao_secteur_surveillance'));
                drawSubTitle("Points Particuliers (P):"); drawWrappedText(getVal('ao_points_particuliers'));
                drawSubTitle("Place du Chef (P):"); drawWrappedText(getVal('ao_place_chef'));
                drawSubTitle("Conduite Ã  Tenir (C):"); drawWrappedText(getVal('ao_cat'));

                await drawImagesFromContainer('photo_container_emplacement_ao', 'Emplacement AO');
                
                addNewPage();
                drawTitle("5. PATRACDVR");
                const patracHeaders = ["Trigramme", "Fonction", "Cellule", "Armement", "Ã‰quip. 1", "Ã‰quip. 2", "Tenue", "GPB"];
                for (const row of (formData.patracdvr_rows || [])) {
                    if(row.vehicle && row.members && row.members.length > 0) {
                        drawSubTitle(`VÃ©hicule: ${row.vehicle}`);
                        const patracRows = row.members.filter(m => m.trigramme).map(m => [m.trigramme, m.fonction, m.cellule, m.armement, m.equipement, m.equipement2, m.tenue, m.gpb]);
                        if (patracRows.length > 0) { drawTable(patracHeaders, patracRows, [80, 90, 90, 90, 90, 90, 80, 80], context.margin); }
                    }
                }
                
                addNewPage();
                drawTitle("Conduites Ã  tenir");
                drawSubTitle("GÃ©nÃ©rales"); drawWrappedText(getVal('cat_generales'), {x: context.margin, font: helveticaBoldFont});
                const noGoText = getVal('no_go');
                if (noGoText) {
                    drawSubTitle("NO GO");
                    drawWrappedText(noGoText, { x: context.margin, font: helveticaBoldFont, size: 14.4, color: rgb(1, 0.2, 0.2) });
                }
                drawSubTitle("Liaison"); drawWrappedText(getVal('cat_liaison'), {x: context.margin, font: helveticaBoldFont});

                // --- AJOUT DE LA LOGIQUE DE LIEN RETEX DANS LE PDF ---
                const dateOp = getVal('date_op');
                const nomAdversaire = getVal('nom_adversaire');
                if (dateOp && nomAdversaire) {
                    // CrÃ©ation de l'identifiant unique de l'opÃ©ration
                    const safeAdversaireName = nomAdversaire.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                    const oiId = `${dateOp}_${safeAdversaireName}`;
                    const retexUrl = `${RETEX_BASE_URL}?oiId=${encodeURIComponent(oiId)}`;

                    addNewPage();
                    const operationTitle = getVal('nom_adversaire') || 'OPERATION';
                    drawTitle(`RETEX: ${operationTitle.toUpperCase()}`);
                    drawWrappedText("Chaque membre ayant participÃ© Ã  l'opÃ©ration est tenu de remplir le formulaire de Retour d'ExpÃ©rience (Retex) en utilisant le lien ci-dessous.", { size: 14, x: context.margin });
                    context.y -= 40;
                    context.currentPage.drawText(retexUrl, { x: context.margin, y: context.y, font: helveticaBoldFont, size: 14, color: context.colors.accent, A: { URI: retexUrl } });
                    context.y -= 20;
                }
                // --- FIN DE L'AJOUT ---
                
                addNewPage();
                if (backgroundImage) { context.currentPage.drawImage(backgroundImage, { x: 0, y: 0, width: context.pageWidth, height: context.pageHeight }); }
                const finalText = "Avez vous des questions?";
                const finalTextWidth = helveticaBoldFont.widthOfTextAtSize(finalText, 48);
                context.currentPage.drawText(finalText, { x: context.pageWidth / 2 - finalTextWidth / 2, y: context.pageHeight / 2, font: helveticaBoldFont, size: 48, color: context.colors.accent });
            };

            await pdfCreationLogic();
            const pdfBytes = await pdfDoc.save();
            return { pdfBytes, formData };
        }

        async function handlePdfAction(isPreview) {
            if (typeof PDFLib === 'undefined') { alert("Erreur: La bibliothÃ¨que PDF n'est pas encore chargÃ©e."); return; }
            const btn = isPreview ? previewBtn : generatePdfBtn;
            const originalText = btn.textContent;
            btn.textContent = 'GÃ©nÃ©ration...'; btn.disabled = true;
            try {
                const result = await buildPdf();
                if (!result) { btn.textContent = originalText; btn.disabled = false; return; }
                const { pdfBytes, formData } = result;
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                if (isPreview) { window.open(url, '_blank'); } 
                else {
                    const getVal = (id) => formData[id] || 'RAS';
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `OI_${getVal('date_op').replace(/[\/\\?%*:|"<>]/g, '-')}_${getVal('nom_adversaire').replace(/ /g, '_')}.pdf`;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                }
            } catch (error) {
                console.error("Erreur critique lors de la gÃ©nÃ©ration du PDF:", error);
                alert("Une erreur critique est survenue. Consultez la console (F12).");
            } finally {
                btn.textContent = originalText; btn.disabled = false;
            }
        }

        previewBtn.addEventListener('click', () => handlePdfAction(true));
        generatePdfBtn.addEventListener('click', () => handlePdfAction(false));
        
        // --- NOUVELLE LOGIQUE RETEX PAR IA ---
        async function generateGeminiAnalysis(reports) {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                retexStatus.textContent = "Erreur: ClÃ© API Gemini non configurÃ©e. Allez dans ParamÃ¨tres.";
                return null;
            }
            
            // Convertir les objets JSON en une chaÃ®ne de caractÃ¨res lisible pour l'IA
            const formattedReports = reports.map(report => JSON.stringify(report, null, 2)).join('\n\n--- Rapport suivant ---\n\n');

            const prompt = `
            Tu es un analyste tactique de la Gendarmerie FranÃ§aise.
            Ton rÃ´le est de synthÃ©tiser des rapports de retour d'expÃ©rience (RETEX) suite Ã  des opÃ©rations de police judiciaire.
            L'objectif est de produire une analyse impartiale et objective, en te basant uniquement sur les faits rapportÃ©s, sans Ã©mettre de jugement personnel.

            **TÃ¢che:**
            Prends en compte les comptes-rendus RETEX fournis ci-dessous.
            Identifie les points clÃ©s et les enseignements Ã  tirer de l'opÃ©ration.
            Classe et structure ta synthÃ¨se en trois sections principales, chacune avec des sous-sections claires:
            1.  **Points Forts:** Ce qui a bien fonctionnÃ©.
                * Coordination:
                * MatÃ©riel/Ã‰quipement:
                * Tactique:
            2.  **Points Faibles:** Ce qui a posÃ© problÃ¨me.
                * Communication:
                * PrÃ©paration:
                * ExÃ©cution:
            3.  **Axe d'AmÃ©lioration:** Recommandations concrÃ¨tes et concises pour de futures opÃ©rations.
                * Formation:
                * ProcÃ©dure:
                * Ã‰quipement:

            **Contenu des rapports RETEX:**
            ${formattedReports}

            **Format de la rÃ©ponse:**
            Utilise le format Markdown pour ta rÃ©ponse. Respecte scrupuleusement les en-tÃªtes et sous-en-tÃªtes demandÃ©s.
            Ne te base que sur les informations que je te donne et ne spÃ©cule pas sur des Ã©lÃ©ments extÃ©rieurs.
            S'il n'y a pas d'informations pour une section, Ã©cris "RAS" (Rien Ã€ Signaler).
            Reste professionnel et factuel. N'utilise pas de phrases trop longues.
            Commence ta rÃ©ponse par "### Rapport d'Analyse OpÃ©rationnelle".
            `;

            try {
                retexStatus.textContent = "Analyse en cours par l'IA...";
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-goog-api-key': apiKey
                    },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erreur API: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                const textOutput = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (textOutput) {
                    retexStatus.textContent = "Analyse terminÃ©e.";
                    return marked.parse(textOutput);
                } else {
                    retexStatus.textContent = "Analyse terminÃ©e, mais aucune rÃ©ponse significative n'a Ã©tÃ© reÃ§ue.";
                    return "<p>Aucune rÃ©ponse significative de l'IA.</p>";
                }
            } catch (error) {
                console.error("Erreur lors de la gÃ©nÃ©ration de l'analyse:", error);
                retexStatus.textContent = `Erreur: ${error.message}`;
                return null;
            }
        }

        async function generateRetexPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4', true);
            const content = document.getElementById('retex_output');
            const originalDisplay = content.style.display;
            content.style.display = 'block';

            doc.html(content, {
                callback: function (doc) {
                    doc.save('Rapport_Retex.pdf');
                },
                x: 20,
                y: 20,
                width: 550, // a4 width is 595.28 (595.28 - 40 margin)
                windowWidth: 800,
            });
             content.style.display = originalDisplay; // RÃ©tablit l'affichage original
        }

        retexFileInput.addEventListener('change', () => {
            const files = retexFileInput.files;
            if (files.length > 0) {
                const fileNames = Array.from(files).map(file => file.name).join(', ');
                retexFileNames.textContent = `${files.length} fichier(s) sÃ©lectionnÃ©(s): ${fileNames}`;
            } else {
                retexFileNames.textContent = 'Aucun fichier sÃ©lectionnÃ©';
            }
        });

        launchRetexAnalysisBtn.addEventListener('click', async (event) => {
            // EmpÃªche le comportement par dÃ©faut de l'Ã©vÃ©nement click (soumission du formulaire)
            event.preventDefault(); 
            
            const files = retexFileInput.files;
            if (files.length === 0) {
                retexStatus.textContent = "Veuillez sÃ©lectionner au moins un fichier JSON.";
                return;
            }
            retexOutput.innerHTML = '';
            generateRetexPdfBtn.style.display = 'none';
            retexStatus.textContent = 'Analyse des fichiers en cours...';

            let allReports = [];
            const promises = [];
            
            for (const file of files) {
                promises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            allReports.push(jsonData);
                            resolve();
                        } catch (error) {
                            console.error(`Erreur de lecture du fichier ${file.name}:`, error);
                            reject(`Erreur de lecture du fichier ${file.name}`);
                        }
                    };
                    reader.onerror = (e) => reject(`Erreur de lecture du fichier ${file.name}`);
                    reader.readAsText(file);
                }));
            }

            try {
                await Promise.all(promises);

                if (allReports.length > 0) {
                    const htmlOutput = await generateGeminiAnalysis(allReports);
                    retexOutput.innerHTML = htmlOutput || "Impossible de gÃ©nÃ©rer le rapport.";
                    retexOutput.style.display = 'block';
                    if (htmlOutput) {
                        generateRetexPdfBtn.style.display = 'inline-block';
                    }
                } else {
                    retexOutput.innerHTML = "<p>Aucun rapport valide n'a pu Ãªtre lu.</p>";
                }
            } catch (error) {
                retexStatus.textContent = `Erreur: ${error}`;
                console.error(error);
            }
        });

        generateRetexPdfBtn.addEventListener('click', generateRetexPdf);
    </script>
</body>
</html>
