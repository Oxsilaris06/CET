<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HUB INSTRUCTION</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Saira+Stencil+One&family=Oswald:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="apple-touch-icon-180x180.png" sizes="180x180">
    <link rel="icon" type="image/png" href="android-icon-192x192.png" sizes="192x192">

    <style>
        /* RESET & BASE */
        :root {
            --hub-bg: #050505;
            --hub-border: #333;
            --hub-accent: #3b82f6;
            --hub-text: #e4e4e7;
            --header-height: 70px;
            
            /* Variables Modal */
            --bg-container: rgba(18, 18, 18, 0.95);
            --text-primary: #e0e0e0;
            --accent-blue: #5b9bd5;
            --border-color: #333333;
            --bg-interactive: #1a1a1a;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            background-color: var(--hub-bg);
            color: var(--hub-text);
            font-family: 'Chakra Petch', sans-serif;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* Support hauteur dynamique mobile */
        }

        /* HEADER NAVIGATION */
        header {
            flex: 0 0 auto; /* Ne rétrécit pas, garde sa hauteur */
            height: var(--header-height);
            background: rgba(10, 10, 10, 0.95);
            border-bottom: 1px solid var(--hub-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 100;
            position: relative;
            
            /* CORRECTION: Transition sur la marge pour recalculer l'espace */
            transition: margin-top 0.3s ease-in-out;
            will-change: margin-top;
        }

        /* L'état caché tire le header vers le haut, libérant l'espace dessous */
        header.hidden {
            margin-top: calc(var(--header-height) * -1);
            /* Plus de transform ici, car transform ne libère pas l'espace */
        }

        .brand {
            font-family: 'Saira Stencil One';
            font-size: 1.5rem;
            color: #fff;
            letter-spacing: 2px;
            display: flex; align-items: center; gap: 10px;
            white-space: nowrap;
            margin-right: 20px;
        }
        .brand span.accent { color: var(--hub-accent); }

        .nav-container {
            display: flex; gap: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 5px 0;
            align-items: center;
            height: 100%;
        }
        .nav-container::-webkit-scrollbar { display: none; }

        /* BOUTONS NAV */
        .nav-btn {
            background: #111;
            border: 1px solid var(--hub-border);
            color: #888;
            padding: 0.5rem 1rem;
            height: 40px;
            border-radius: 4px;
            font-family: 'Chakra Petch', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex; align-items: center; gap: 8px;
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            border-color: var(--hub-accent);
            color: #fff;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        .nav-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--hub-accent);
            color: var(--hub-accent);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        .secured-nav { display: none; }

        #lockBtn {
            border-color: #d32f2f;
            color: #d32f2f;
        }
        #lockBtn:hover {
            background: rgba(211, 47, 47, 0.15);
            box-shadow: 0 0 10px rgba(211, 47, 47, 0.3);
        }

        /* IFRAME CONTAINER - CORRIGÉ */
        .iframe-wrapper {
            flex: 1; /* Raccourci pour flex: 1 1 0% - Force à prendre TOUT l'espace restant */
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .presentation-frame {
            flex: 1; /* L'iframe grandit aussi pour remplir le wrapper */
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* BOUTONS FLOTTANTS */
        .fullscreen-btn {
            position: fixed;
            bottom: 30px; right: 30px;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid var(--hub-accent);
            color: var(--hub-accent);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 1000;
            transition: transform 0.2s;
            backdrop-filter: blur(5px);
        }
        .fullscreen-btn:hover {
            background: var(--hub-accent);
            color: #000;
            transform: scale(1.1);
        }

        /* MOBILE HINTS */
        .swipe-hint {
            display: none;
            position: fixed;
            top: 20%; 
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 999;
            pointer-events: none;
            border: 1px solid var(--hub-accent);
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .swipe-hint.show { opacity: 1; animation: fadeOutHint 4s forwards; }
        
        @keyframes fadeOutHint {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* ZONE TRIGGER */
        .header-trigger {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 20px; 
            z-index: 90; 
            display: none; 
        }

        /* LOGIN MODAL */
        .login-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; justify-content: center; align-items: center;
            z-index: 2000;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .login-modal.active { display: flex; opacity: 1; }

        .login-box {
            background-color: var(--bg-container);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            width: 90%; max-width: 400px;
        }
        .login-box legend { color: var(--text-primary); font-family: 'Oswald', sans-serif; font-size: 1.5rem; margin-bottom: 20px; text-transform: uppercase;}
        .login-box label { display: block; text-align: left; margin-bottom: 5px; color: #ccc; font-family: 'Oswald'; }
        .login-box input, .login-box select { width: 100%; padding: 10px; margin-bottom: 20px; background: #222; border: 1px solid #444; color: #fff; }
        .action-button { width: 100%; padding: 12px; background: var(--accent-blue); color: #fff; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .back-icon { margin-top: 15px; cursor: pointer; color: #888; }
        .back-icon:hover { color: #fff; }

        /* --- MEDIA QUERIES --- */

        /* 1. MOBILE & TABLETTE */
        @media (max-width: 1024px) {
            :root { --header-height: auto; }
            
            header { 
                flex-direction: column; 
                align-items: stretch;
                padding: 10px; 
                gap: 10px;
                /* Sur mobile, on doit forcer une hauteur auto qui sera calculée */
                height: auto;
            }
            
            /* Pour mobile, le calcul de la marge négative est un peu plus complexe si la hauteur est auto.
               On utilise une grande valeur sûre ou du JS si nécessaire, mais ici un max-height transitionné fonctionne aussi.
               Pour simplifier, on garde la logique JS qui va ajouter une classe ou gérer le scroll. */
            
            /* Ajustement de la classe hidden pour le mobile spécifiquement si la hauteur varie */
            header.hidden {
                margin-top: -150px; /* Valeur arbitraire suffisante pour cacher le menu mobile */
            }

            .brand { justify-content: center; margin-right: 0; }
            .nav-container { padding-bottom: 5px; }
            .nav-btn { font-size: 0.8rem; padding: 0 12px; height: 36px; }
            
            .fullscreen-btn { 
                top: 10px; right: 10px; bottom: auto; 
                width: 40px; height: 40px;
                opacity: 0.8;
                background: rgba(0,0,0,0.8);
                border: none;
            }
            .header-trigger { display: block; }
        }

        /* 2. TV / GRANDS ÉCRANS */
        @media (min-width: 1920px) {
            :root { --header-height: 90px; }
            html, body { font-size: 18px; }
            .brand { font-size: 2.5rem; }
            .nav-btn { font-size: 1.2rem; height: 60px; padding: 0 30px; }
            .login-box { max-width: 600px; padding: 60px; }
            .login-box input, .action-button { font-size: 1.5rem; padding: 20px; }
        }

    </style>
</head>
<body>

    <div class="header-trigger" id="headerTrigger"></div>

    <header id="mainHeader">
        <div class="brand">
            <span class="material-symbols-outlined" style="font-size: 1.2em; margin-right: 10px;">hub</span>
            HUB<span class="accent">INSTRUCTION</span>
        </div>
        
        <div class="nav-container">
            <button class="nav-btn active" onclick="loadPres('adi1.html', this)">
                <span class="material-symbols-outlined">description</span> OI
            </button>
            <button class="nav-btn" onclick="loadPres('adi3.html', this)">
                <span class="material-symbols-outlined">headset_mic</span> COM TAC
            </button>
            <button class="nav-btn" onclick="loadPres('adi2.html', this)">
                <span class="material-symbols-outlined">computer</span> PC TAC
            </button>
            <button class="nav-btn" onclick="loadPres('adi4.html', this)">
                <span class="material-symbols-outlined">checklist</span> CHECKLIST
            </button>
            <button class="nav-btn" onclick="loadPres('airsoft.html', this)">
                <span class="material-symbols-outlined">adjust</span> AIRSOFT
            </button>
            
            <button class="nav-btn secured-nav" onclick="loadPres('reco.html', this)">
                <span class="material-symbols-outlined">visibility</span> RECO
            </button>
            <button class="nav-btn secured-nav" onclick="loadPres('effrac.html', this)">
                <span class="material-symbols-outlined">lock_open</span> EFFRAC
            </button>

            <button class="nav-btn" id="lockBtn" onclick="openLoginModal()">
                <span class="material-symbols-outlined">lock</span> ACCÈS RESTREINT
            </button>

            <button class="nav-btn" onclick="loadPres('optiques.html', this)">
                <span class="material-symbols-outlined">center_focus_strong</span> OPTIQUES
            </button>

            <button class="nav-btn" onclick="window.location.href='index.html'" style="margin-left: auto; border-color: #666;">
                <span class="material-symbols-outlined">home</span> RETOUR
            </button>
        </div>
    </header>

    <div class="swipe-hint" id="swipeHint">
        <span class="material-symbols-outlined">touch_app</span>
        Swipe pour naviguer
    </div>

    <!-- Le Wrapper Flex qui remplit l'espace -->
    <div class="iframe-wrapper">
        <iframe id="mainFrame" class="presentation-frame" src="adi1.html" title="Zone de Présentation" allowfullscreen></iframe>
    </div>

    <button class="fullscreen-btn" id="fsBtn" onclick="toggleFullScreen()">
        <span class="material-symbols-outlined" id="fsIcon">fullscreen</span>
    </button>

    <div id="loginModal" class="login-modal">
        <div class="login-box">
            <fieldset style="border:none; padding:0; margin:0;">
                <legend>Accès Sécurisé</legend>
                <div class="item-selector">
                    <label for="member-select">Nom du membre</label>
                    <select id="member-select"><option value="">Chargement...</option></select>
                </div>
                <div class="item-selector">
                    <label for="password-input">Mot de passe</label>
                    <input type="password" id="password-input" placeholder="••••">
                </div>
                <button onclick="validateLogin()" class="action-button">Valider</button>
                <div style="text-align: center;">
                    <span class="material-icons back-icon" onclick="closeLoginModal()">arrow_back</span>
                </div>
                <div id="loginMessage" style="margin-top:15px; color:#ff6b6b; min-height:1.2em;"></div>
            </fieldset>
        </div>
    </div>

    <script>
        const frame = document.getElementById('mainFrame');
        const header = document.getElementById('mainHeader');
        
        // --- 1. Navigation & Iframe ---
        function loadPres(filename, btnElement) {
            if (frame.getAttribute('src') === filename) return;

            frame.style.opacity = '0';
            if (btnElement) {
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                btnElement.classList.add('active');
            }

            setTimeout(() => {
                frame.src = filename;
                frame.onload = function() {
                    frame.style.opacity = '1';
                    frame.contentWindow.focus();
                    injectMobileStyles(frame); 
                    setupFrameTouchEvents(frame);
                    window.scrollTo(0, 1);
                };
            }, 200);
        }

        // --- 2. Fix Mobile ---
        function injectMobileStyles(iframe) {
            if (window.innerWidth <= 1024) {
                try {
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    if(doc.getElementById('hub-mobile-fix')) return;
                    const style = doc.createElement('style');
                    style.id = 'hub-mobile-fix';
                    style.textContent = `
                        body { overflow-x: hidden; }
                        .navigation, .slide-footer { display: none !important; }
                        .slide-container, .reveal { 
                            height: 100vh !important; 
                            width: 100vw !important;
                            padding: 0 !important;
                        }
                    `;
                    doc.head.appendChild(style);
                } catch (e) {}
            }
        }

        // --- 3. Plein Écran & UI ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                if(document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if(document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const icon = document.getElementById('fsIcon');
            if (document.fullscreenElement) {
                icon.textContent = 'fullscreen_exit';
            } else {
                icon.textContent = 'fullscreen';
                header.classList.remove('hidden');
            }
        });

        // --- 4. Touch & Auto-Hide (Optimisé) ---
        let startY = 0;
        let startX = 0;

        document.addEventListener('touchstart', e => { startY = e.touches[0].clientY; }, {passive: true});
        document.addEventListener('touchend', e => {
            // Zone de détection en haut pour réafficher
            if (startY < 50) header.classList.remove('hidden');
        }, {passive: true});

        const trigger = document.getElementById('headerTrigger');
        trigger.addEventListener('click', () => header.classList.remove('hidden'));
        trigger.addEventListener('mouseover', () => header.classList.remove('hidden'));

        function setupFrameTouchEvents(iframe) {
            try {
                const doc = iframe.contentDocument || iframe.contentWindow.document;
                
                doc.addEventListener('touchstart', e => {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }, {passive: true});

                doc.addEventListener('touchend', e => {
                    const endX = e.changedTouches[0].clientX;
                    const endY = e.changedTouches[0].clientY;
                    const diffX = startX - endX;
                    const diffY = startY - endY;

                    // Navigation Slides (Horizontal)
                    if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                        const win = iframe.contentWindow;
                        win.document.dispatchEvent(new KeyboardEvent('keydown', {'key': diffX > 0 ? 'ArrowRight' : 'ArrowLeft', 'keyCode': diffX > 0 ? 39 : 37}));
                    }
                    
                    // Gestion Header (Vertical)
                    // Swipe vers le bas depuis le haut -> Afficher
                    if (diffY < -50 && startY < 100) {
                        header.classList.remove('hidden');
                    }
                    // Swipe vers le haut -> Cacher
                    if (diffY > 50) {
                        header.classList.add('hidden');
                    }
                }, {passive: true});
                
                // Hint Mobile
                if(window.innerWidth < 1024 && !sessionStorage.getItem('hintShown')) {
                     const hint = document.getElementById('swipeHint');
                     hint.style.display = 'flex';
                     setTimeout(() => hint.classList.add('show'), 100);
                     sessionStorage.setItem('hintShown', 'true');
                }
            } catch (e) {}
        }

        // --- 5. Auth Logic ---
        let backendUrl = "";
        let allMembers = [];
        const loginModal = document.getElementById('loginModal');
        const memberSelect = document.getElementById('member-select');
        const passwordInput = document.getElementById('password-input');
        const loginMessage = document.getElementById('loginMessage');

        window.onload = async function() {
            try {
                const res = await fetch('all.json');
                if(res.ok) {
                    const cfg = await res.json();
                    backendUrl = cfg.backendUrl || '';
                }
            } catch(e) {}
            if(frame.contentWindow) frame.onload();
        };

        window.openLoginModal = async function() {
            loginModal.classList.add('active');
            loginMessage.innerText = '';
            
            if (allMembers.length === 0 && backendUrl) {
                try {
                    const url = new URL(backendUrl);
                    url.searchParams.append('action', 'getMembers');
                    const res = await fetch(url);
                    const data = await res.json();
                    allMembers = data.map(m => m.trim());
                    memberSelect.innerHTML = '<option value="">Choisir un membre</option>';
                    allMembers.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = m;
                        memberSelect.appendChild(opt);
                    });
                } catch (e) { loginMessage.innerText = "Erreur réseau"; }
            } else if (!backendUrl) { memberSelect.innerHTML = '<option>Config Manquante</option>'; }
        };

        window.closeLoginModal = function() { loginModal.classList.remove('active'); };

        window.validateLogin = async function() {
            if(!memberSelect.value || !passwordInput.value) {
                loginMessage.innerText = "Champs requis";
                return;
            }
            loginMessage.innerText = "Connexion...";
            try {
                const url = new URL(backendUrl);
                url.searchParams.append('action', 'authenticate');
                url.searchParams.append('member', memberSelect.value);
                url.searchParams.append('password', passwordInput.value);
                const res = await fetch(url);
                const json = await res.json();
                
                if(json.result === 'success') {
                    document.querySelectorAll('.secured-nav').forEach(el => {
                        el.style.display = 'inline-flex';
                        el.style.animation = 'fadeHint 1s';
                    });
                    document.getElementById('lockBtn').style.display = 'none';
                    closeLoginModal();
                } else { loginMessage.innerText = "Mot de passe erroné"; }
            } catch(e) { loginMessage.innerText = "Erreur technique"; }
        };

        loginModal.addEventListener('click', (e) => {
            if(e.target === loginModal) closeLoginModal();
        });

    </script>
</body>
</html>
