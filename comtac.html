<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>COM TAC v3.4 // FULL SPEC</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- External Libs -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --c-bg: #050505;
            --c-surface: #121214;
            --c-surface-light: #1e1e24;
            --c-progression: #3b82f6;   /* Bleu */
            --c-contact: #ef4444;       /* Rouge */
            --c-clear: #22c55e;         /* Vert */
            --c-appui: #eab308;         /* Jaune */
            --c-text: #e0e0e0;
            --c-text-dim: #6b7280;
            --f-ui: 'Chakra Petch', sans-serif;
            --f-mono: 'JetBrains Mono', monospace;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }

        body {
            font-family: var(--f-ui); background-color: var(--c-bg); color: var(--c-text);
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        /* --- ANIMATIONS --- */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); border-color: var(--c-contact); background: rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); border-color: var(--c-contact); background: rgba(239, 68, 68, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); border-color: var(--c-contact); background: rgba(239, 68, 68, 0.1); }
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* --- HEADER --- */
        header {
            padding: 0 20px; height: 60px; background: rgba(5, 5, 5, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 50;
        }
        .brand { font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; display: flex; gap: 8px; }
        .brand span { color: var(--c-progression); }
        
        .map-toggle {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;
            display: flex; align-items: center; gap: 5px; color: var(--c-text);
        }
        .map-toggle.active { background: var(--c-progression); color: black; border-color: var(--c-progression); }

        /* --- VIEWS --- */
        .view {
            position: absolute; inset: 0; top: 60px; /* Header height */
            display: flex; flex-direction: column; background: var(--c-bg);
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 1;
        }
        .view.active { opacity: 1; pointer-events: all; z-index: 10; }

        /* --- MAP VIEW --- */
        #view-map { background: #111; }
        #map-container { width: 100%; height: 100%; z-index: 1; }
        
        /* Tactical Markers CSS */
        .tac-marker { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); will-change: transform; }
        .tac-arrow {
            width: 0; height: 0; 
            border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-bottom: 20px solid var(--c-progression);
            filter: drop-shadow(0 0 4px var(--c-progression));
        }
        .tac-label {
            position: absolute; top: 22px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 2px 6px;
            font-family: var(--f-mono); font-size: 10px; border-radius: 4px; white-space: nowrap;
            border: 1px solid var(--c-progression); pointer-events: none; font-weight: bold;
        }
        
        .status-CONTACT .tac-arrow { border-bottom-color: var(--c-contact); filter: drop-shadow(0 0 10px red); }
        .status-CONTACT .tac-label { border-color: var(--c-contact); color: var(--c-contact); }
        .status-CLEAR .tac-arrow { border-bottom-color: var(--c-clear); }
        .status-APPUI .tac-arrow { border-bottom-color: var(--c-appui); }

        /* --- OPS GRID --- */
        .grid-container {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            padding: 15px; padding-bottom: 180px; overflow-y: auto; align-content: start;
        }

        .op-card {
            background: var(--c-surface); border: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius); padding: 12px; display: flex; flex-direction: column; gap: 6px;
            min-height: 120px; position: relative; transition: all 0.2s;
        }
        .op-card.is-me { background: #1e1e24; border-color: rgba(255,255,255,0.2); }
        
        .op-card[data-status="CONTACT"] { animation: pulse-red 1s infinite; }
        .op-card[data-status="CONTACT"] .status-display { color: var(--c-contact); font-weight: 900; }
        .op-card[data-status="PROGRESSION"] { border-color: var(--c-progression); }
        .op-card[data-status="PROGRESSION"] .status-display { color: var(--c-progression); }
        .op-card[data-status="CLEAR"] { border-color: var(--c-clear); }
        .op-card[data-status="CLEAR"] .status-display { color: var(--c-clear); }
        .op-card[data-status="APPUI"] { border-color: var(--c-appui); }
        .op-card[data-status="APPUI"] .status-display { color: var(--c-appui); }

        .op-header { display: flex; justify-content: space-between; align-items: center; }
        .op-id { font-family: var(--f-mono); font-weight: 800; font-size: 1.1rem; color: white; letter-spacing: -0.5px; }
        .op-role { font-size: 0.65rem; font-weight: 700; background: #333; padding: 2px 6px; border-radius: 4px; color: #aaa; }
        .is-host .op-role { background: var(--c-appui); color: black; }
        
        .status-display { font-size: 0.8rem; font-weight: 600; min-height: 1.2em; letter-spacing: 1px; }
        .op-stats { display: flex; gap: 10px; font-size: 0.7rem; color: var(--c-text-dim); margin-top: auto; }
        .mini-viz { height: 4px; width: 100%; background: #333; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .mini-viz-bar { height: 100%; width: 0%; background: var(--c-clear); transition: width 0.1s; }

        /* --- HUD --- */
        .hud-panel {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
            background: rgba(10, 10, 12, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1); padding: 15px 20px 30px;
            border-radius: 24px 24px 0 0;
        }
        
        .status-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .status-chip {
            padding: 8px 14px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; white-space: nowrap;
            border: 1px solid rgba(255,255,255,0.1); color: var(--c-text-dim); background: rgba(255,255,255,0.05); cursor: pointer;
        }
        .status-chip.active { background: var(--c-progression); color: black; border-color: transparent; }
        .status-chip[data-s="CONTACT"].active { background: var(--c-contact); color: white; border-color: var(--c-contact); animation: blink 1s infinite; }
        .status-chip[data-s="CLEAR"].active { background: var(--c-clear); color: black; border-color: var(--c-clear); }
        .status-chip[data-s="APPUI"].active { background: var(--c-appui); color: black; border-color: var(--c-appui); }

        .ptt-row { display: flex; justify-content: center; align-items: center; position: relative; height: 80px; }
        #pttBtn {
            width: 75px; height: 75px; border-radius: 24px; background: #222; border: 2px solid #444; color: #666;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: 0.1s; cursor: pointer;
        }
        #pttBtn.active { background: var(--c-progression); color: white; border-color: white; transform: scale(0.95); }
        #pttBtn.mode-vox { border-color: var(--c-clear); color: var(--c-clear); background: rgba(34, 197, 94, 0.1); }
        #pttBtn.mode-vox.active { background: var(--c-clear); color: black; }
        
        .hud-btn {
            position: absolute; width: 45px; height: 45px; border-radius: 50%; cursor: pointer;
            background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; color: #888;
        }
        .hud-btn.left { left: 20px; } .hud-btn.right { right: 20px; }

        /* --- LOGIN & MENU --- */
        .hero-input {
            background: transparent; border: none; border-bottom: 2px solid #333; width: 100%;
            font-size: 2rem; font-family: var(--f-mono); text-align: center; color: white; padding: 10px;
        }
        .menu-btn {
            width: 100%; padding: 18px; margin-bottom: 12px; background: var(--c-surface); cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius); color: white;
            font-weight: 600; text-align: left; display: flex; align-items: center; gap: 15px;
        }

        /* --- OVERLAYS --- */
        #qr-overlay, #scanner-overlay {
            position: fixed; inset: 0; background: black; z-index: 5000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .close-btn { position: absolute; top: 20px; right: 20px; padding: 10px; background: #333; border-radius: 50%; color: white; z-index: 5001; cursor: pointer; }
        
        /* Scanner Fix */
        #reader { width: 100%; height: 100%; background:black; }
        
        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #222; border: 1px solid var(--c-progression); color: var(--c-progression);
            padding: 10px 20px; border-radius: 30px; font-size: 0.8rem; z-index: 9999; display: none;
        }
        
        .leaflet-container { background: #151515; }
        .leaflet-control-attribution { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="brand"><span class="material-symbols-outlined">satellite_alt</span> COM<span>TAC</span></div>
        <div class="map-toggle" id="viewToggleBtn" onclick="toggleMapView()">
            <span class="material-symbols-outlined">map</span> CARTE
        </div>
    </header>

    <div id="toast" class="toast">SystÃ¨me PrÃªt</div>

    <!-- OVERLAYS -->
    <div id="scanner-overlay">
        <div class="close-btn" onclick="stopScanner()">âœ•</div>
        <div id="reader"></div>
        <div style="position:absolute; bottom:50px; color:white; font-size:0.8rem; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:10px;">Visez le QR Code</div>
    </div>
    
    <div id="qr-overlay"><div class="close-btn" onclick="closeQR()">âœ•</div><div style="background:white;padding:20px;border-radius:10px;text-align:center"><div id="qrcode-target"></div><p style="color:black;margin:10px 0 0;">ID SÃ‰CURISÃ‰</p></div></div>

    <!-- LOGIN -->
    <div id="view-login" class="view active" style="justify-content: center; padding: 20px; z-index: 200;">
        <div style="text-align: center; margin-bottom: 40px;">
            <span class="material-symbols-outlined" style="font-size: 4rem; color: var(--c-progression);">fingerprint</span>
            <h2>IDENTIFICATION</h2>
        </div>
        <input type="text" id="callsignInput" class="hero-input" placeholder="CALLSIGN" maxlength="8">
        <button class="menu-btn" onclick="login()" style="margin-top: 20px; justify-content: center; background: var(--c-progression); border:none;">CONNEXION</button>
    </div>

    <!-- MENU -->
    <div id="view-menu" class="view" style="padding: 20px; z-index: 150;">
        <h3 style="color: var(--c-text-dim);">DÃ‰PLOIEMENT</h3>
        <button class="menu-btn" onclick="createFreq()"><span class="material-symbols-outlined">add_circle</span> CRÃ‰ER FRÃ‰QUENCE (HOST)</button>
        <button class="menu-btn" onclick="startScanner()"><span class="material-symbols-outlined">qr_code_scanner</span> SCANNER QR</button>
        <div style="display:flex; gap:10px;">
            <input type="text" id="joinIdInput" placeholder="ID MANUEL..." style="flex:1; background:var(--c-surface); border:1px solid #333; color:white; padding:15px; border-radius:16px;">
            <button onclick="joinFreq()" style="width:60px; background:var(--c-surface); border:1px solid #333; border-radius:16px; color:white;">âžœ</button>
        </div>
    </div>

    <!-- OPS -->
    <div id="view-ops" class="view">
        <div class="grid-container" id="usersGrid"></div>
    </div>

    <!-- MAP -->
    <div id="view-map" class="view">
        <div id="map-container"></div>
    </div>

    <!-- HUD -->
    <div class="hud-panel" id="hudPanel" style="display:none;">
        <div class="status-bar">
            <div class="status-chip" onclick="setStatus('PROGRESSION')" data-s="PROGRESSION">PROGRESSION</div>
            <div class="status-chip" onclick="setStatus('CONTACT')" data-s="CONTACT">CONTACT</div>
            <div class="status-chip" onclick="setStatus('CLEAR')" data-s="CLEAR">CLEAR</div>
            <div class="status-chip" onclick="setStatus('APPUI')" data-s="APPUI">EN APPUI</div>
        </div>
        <div class="ptt-row">
            <div class="hud-btn left" onclick="toggleVox()"><span class="material-symbols-outlined" id="voxIcon">mic_none</span></div>
            <div id="pttBtn"><span class="material-symbols-outlined">mic</span></div>
            <div class="hud-btn right" onclick="showQR()"><span class="material-symbols-outlined">qr_code_2</span></div>
        </div>
        <div style="text-align:center; font-size:0.7rem; color:#666; margin-top:-5px;">
            <span id="freqDisplay">ID: ...</span> | <span id="gpsStatus" onclick="initMap()">GPS OFF</span>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const APP = { key: 'comtac_v3_4_full', peerConfig: { debug: 1 } };
        let state = { me: { id: null, callsign: '', status: 'CLEAR', lat: 0, lng: 0, head: 0, isTx: false }, isHost: false, audio: { stream: null, mode: 'ptt' }, peers: {}, map: null, geoId: null };

        // --- OFFLINE MAPS ---
        const DB_NAME = 'ComTac_Maps_v3'; const DB_STORE = 'tiles';
        const OfflineMaps = {
            db: null,
            init: async () => { return new Promise((res, rej) => { const req = indexedDB.open(DB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(DB_STORE, { keyPath: 'key' }); req.onsuccess = e => { OfflineMaps.db = e.target.result; res(); }; req.onerror = e => rej(e); }); },
            getTile: async (key) => { return new Promise(res => { const tx = OfflineMaps.db.transaction(DB_STORE, 'readonly'); const req = tx.objectStore(DB_STORE).get(key); req.onsuccess = () => res(req.result ? req.result.blob : null); req.onerror = () => res(null); }); },
            saveTile: (key, blob) => { const tx = OfflineMaps.db.transaction(DB_STORE, 'readwrite'); tx.objectStore(DB_STORE).put({ key, blob }); }
        };
        const OfflineLayer = L.TileLayer.extend({
            createTile: function(coords, done) {
                const tile = document.createElement('img'); const url = this.getTileUrl(coords); const key = `${coords.z}/${coords.x}/${coords.y}`;
                if(OfflineMaps.db) { OfflineMaps.getTile(key).then(blob => { if(blob) { tile.src = URL.createObjectURL(blob); done(null, tile); } else { fetch(url).then(res => res.blob()).then(blob => { OfflineMaps.saveTile(key, blob); tile.src = URL.createObjectURL(blob); done(null, tile); }).catch(() => { tile.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; done(null, tile); }); } }); } else { tile.src = url; done(null, tile); }
                return tile;
            }
        });

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            await OfflineMaps.init();
            const saved = localStorage.getItem(APP.key);
            if(saved) {
                const s = JSON.parse(saved); state.me.callsign = s.callsign;
                if(s.freq) { await login(true); initAudio().then(() => { if(s.host) createFreq(s.freq); else joinFreq(s.freq); }); }
                else { document.getElementById('callsignInput').value = s.callsign; }
            }
            if('mediaSession' in navigator) setupMediaSession();
        });

        async function login(skip = false) {
            if(!skip) { const val = document.getElementById('callsignInput').value.trim().toUpperCase(); if(val.length < 2) return toast("ID invalide", true); state.me.callsign = val; }
            if(!skip) await initAudio();
            saveSession(); showView('view-menu');
        }
        function saveSession(freq = null) { localStorage.setItem(APP.key, JSON.stringify({ callsign: state.me.callsign, freq: freq, host: state.isHost })); }

        function showView(id) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'view-ops' || id === 'view-map') document.getElementById('hudPanel').style.display = 'block';
            else document.getElementById('hudPanel').style.display = 'none';
            if(id === 'view-map' && state.map) setTimeout(() => state.map.invalidateSize(), 200);
        }

        function toggleMapView() {
            const btn = document.getElementById('viewToggleBtn');
            if(document.getElementById('view-map').classList.contains('active')) { showView('view-ops'); btn.classList.remove('active'); } 
            else { showView('view-map'); btn.classList.add('active'); if(!state.map) initMap(); }
        }

        // --- GPS ---
        function initMap() {
            state.map = L.map('map-container', { zoomControl: false }).setView([48.85, 2.35], 13);
            new OfflineLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 }).addTo(state.map);
            startGPS();
        }

        function startGPS() {
            if(!('geolocation' in navigator)) { document.getElementById('gpsStatus').innerText = "GPS N/A"; return; }
            const gpsOpts = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
            state.geoId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, heading, accuracy } = pos.coords;
                    state.me.lat = latitude; state.me.lng = longitude;
                    if(heading !== null && !isNaN(heading)) state.me.head = heading;
                    const statEl = document.getElementById('gpsStatus');
                    statEl.innerText = `GPS: Â±${Math.floor(accuracy)}m`; statEl.style.color = accuracy < 20 ? '#22c55e' : '#eab308';
                    updatePeerOnMap(state.me.id, state.me); broadcastState();
                },
                (err) => { document.getElementById('gpsStatus').innerText = "GPS ERR"; document.getElementById('gpsStatus').style.color = '#ef4444'; }, gpsOpts
            );
        }

        function updatePeerOnMap(id, user) {
            if(!state.map || !user.lat) return;
            if(!state.peers[id]) state.peers[id] = { data: user };
            const p = state.peers[id];
            const iconHtml = `<div class="tac-marker status-${user.status||'CLEAR'}" style="transform: rotate(${user.head||0}deg);"><div class="tac-arrow"></div></div><div class="tac-label">${user.callsign}</div>`;
            const icon = L.divIcon({ className: 'custom', html: iconHtml, iconSize: [40, 40], iconAnchor: [20, 20] });
            if(p.marker) { p.marker.setLatLng([user.lat, user.lng]); p.marker.setIcon(icon); } else { p.marker = L.marker([user.lat, user.lng], { icon: icon }).addTo(state.map); }
            if(!p.trailData) p.trailData = [];
            const last = p.trailData[p.trailData.length-1];
            if(!last || Math.sqrt(Math.pow(last[0]-user.lat, 2) + Math.pow(last[1]-user.lng, 2)) > 0.00005) {
                p.trailData.push([user.lat, user.lng]); if(p.trailData.length > 20) p.trailData.shift();
                if(p.trail) p.trail.setLatLngs(p.trailData); else p.trail = L.polyline(p.trailData, { color: user.id===state.me.id?'#3b82f6':'#22c55e', weight:2, dashArray:'5,5', opacity:0.6 }).addTo(state.map);
            }
        }

        // --- COMMS ---
        function initPeer(id=null) {
            const peer = new Peer(id, APP.peerConfig);
            peer.on('open', pid => {
                state.me.id = pid; document.getElementById('freqDisplay').innerText = `ID: ${pid}`;
                if(state.isHost) { startHeartbeat(); updateGrid(); }
                saveSession(pid); showView('view-ops');
                if('wakeLock' in navigator) navigator.wakeLock.request('screen').then(w => state.wakeLock = w);
            });
            peer.on('connection', conn => setupConn(conn));
            peer.on('call', call => { call.answer(state.audio.stream); call.on('stream', playAudio); });
            peer.on('error', err => { if(err.type === 'unavailable-id') { state.peer = new Peer(null, APP.peerConfig); initPeer(); return; } toast("Erreur: " + err.type, true); });
            peer.on('disconnected', () => { peer.reconnect(); });
            return peer;
        }

        function createFreq(id=null) { state.isHost = true; state.me.role = 'HOST'; if(state.peer) state.peer.destroy(); state.peer = initPeer(id); }
        function joinFreq(id) { 
            if(!id) id = document.getElementById('joinIdInput').value;
            state.isHost = false; if(state.peer) state.peer.destroy(); state.peer = initPeer();
            const conn = state.peer.connect(id, { metadata: state.me });
            conn.on('open', () => { setupConn(conn); state.peer.call(id, state.audio.stream).on('stream', playAudio); });
        }

        function setupConn(conn) {
            conn.on('data', d => { if(d.t === 'STATE') handleUpdate(d.p); if(d.t === 'SYNC') d.l.forEach(u => handleUpdate(u)); });
            conn.on('open', () => { if(!state.peers[conn.peer]) state.peers[conn.peer] = {}; state.peers[conn.peer].conn = conn; broadcastState(); });
        }

        function broadcastState() {
            const p = { ...state.me }; Object.values(state.peers).forEach(peer => { if(peer.conn && peer.conn.open) peer.conn.send({ t: 'STATE', p: p }); });
            if(state.isHost) updateGrid();
        }

        function handleUpdate(user) {
            if(user.id === state.me.id) return;
            if(!state.peers[user.id]) state.peers[user.id] = {};
            state.peers[user.id].data = user;
            updateGrid(); updatePeerOnMap(user.id, user);
        }

        function startHeartbeat() {
            setInterval(() => {
                if(!state.isHost) return;
                const list = Object.values(state.peers).map(p => p.data).filter(d => d); list.push(state.me);
                Object.values(state.peers).forEach(p => { if(p.conn) p.conn.send({ t: 'SYNC', l: list }); });
            }, 2000);
        }

        // --- AUDIO ---
        async function initAudio() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.audio.stream = s;
                const AudioContext = window.AudioContext || window.webkitAudioContext; state.audio.context = new AudioContext();
                const src = state.audio.context.createMediaStreamSource(s);
                const filter = state.audio.context.createBiquadFilter(); filter.type = "highpass"; filter.frequency.value = 300;
                const comp = state.audio.context.createDynamicsCompressor();
                src.connect(filter); filter.connect(comp);
                const dst = state.audio.context.createMediaStreamDestination(); comp.connect(dst);
                state.audio.processedStream = dst.stream; 
                s.getAudioTracks().forEach(t => t.enabled = false);
                return true;
            } catch(e) { toast("Micro bloquÃ©", true); return false; }
        }
        function playAudio(s) { const a = new Audio(); a.srcObject = s; a.play(); }

        // --- UI ---
        function updateGrid() {
            const grid = document.getElementById('usersGrid'); grid.innerHTML = '';
            const all = [{...state.me, isMe: true}].concat(Object.values(state.peers).map(p => p.data).filter(d => d));
            all.forEach(u => {
                const div = document.createElement('div');
                div.className = 'op-card ' + (u.isMe?'is-me':'');
                if(u.isTx) div.style.borderColor = '#22c55e';
                if(u.status) div.setAttribute('data-status', u.status);
                let batC = '#aaa'; if(u.battery<20) batC='#ef4444';
                div.innerHTML = `<div class="op-header"><span class="op-role">${u.role||'OPR'}</span>${u.isTx?'<span style="color:#22c55e">ðŸ”Š</span>':''}</div><div class="op-id">${u.callsign}</div><div class="status-display" style="color:var(--c-${u.status?u.status.toLowerCase():'text'})">${u.status||''}</div><div class="op-stats"><div style="color:${batC}">ðŸ”‹ ${u.battery||'?'}%</div></div><div class="mini-viz"><div class="mini-viz-bar" style="width:${u.isTx?'100%':'0%'}"></div></div>`;
                grid.appendChild(div);
            });
        }

        function setStatus(s) { 
            state.me.status = s; broadcastState(); updateGrid();
            document.querySelectorAll('.status-chip').forEach(el => el.classList.remove('active'));
            const chip = document.querySelector(`.status-chip[data-s="${s}"]`); if(chip) chip.classList.add('active');
        }

        const btn = document.getElementById('pttBtn');
        const tx = (on) => {
            state.me.isTx = on; state.audio.stream.getAudioTracks().forEach(t => t.enabled = on);
            if(on) { btn.classList.add('active'); if(navigator.vibrate) navigator.vibrate(30); } else btn.classList.remove('active');
            broadcastState(); updateGrid();
        };
        btn.onmousedown = () => tx(true); btn.onmouseup = () => tx(false);
        btn.ontouchstart = (e) => { e.preventDefault(); tx(true); }; btn.ontouchend = (e) => { e.preventDefault(); tx(false); };
        
        function toggleVox() {
            state.audio.mode = state.audio.mode === 'ptt' ? 'vox' : 'ptt';
            document.getElementById('voxIcon').innerText = state.audio.mode === 'vox' ? 'mic' : 'mic_none';
            if(state.audio.mode === 'vox') { 
                document.getElementById('pttBtn').classList.add('mode-vox');
                tx(true); 
            } else { 
                document.getElementById('pttBtn').classList.remove('mode-vox');
                tx(false); 
            }
        }

        function setupMediaSession() {
            navigator.mediaSession.metadata = new MediaMetadata({ title: 'ComTac', artist: 'Secure Link' });
            navigator.mediaSession.setActionHandler('play', () => tx(!state.me.isTx));
            navigator.mediaSession.setActionHandler('pause', () => tx(!state.me.isTx));
        }

        // --- UTILS & QR ---
        function toast(m, e) { const t = document.getElementById('toast'); t.innerText = m; t.style.borderColor = e?'red':'#22c55e'; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }
        function showQR() { if(!state.me.id) return; new QRCode(document.getElementById("qrcode-target"), {text:state.me.id,width:150,height:150}); document.getElementById('qr-overlay').style.display='flex'; }
        function closeQR() { document.getElementById('qr-overlay').style.display='none'; document.getElementById('qrcode-target').innerHTML=''; }
        
        let qrScanner = null;
        function startScanner() { 
            document.getElementById('scanner-overlay').style.display='flex';
            if(qrScanner) { try { qrScanner.clear(); } catch(e){} }
            qrScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            qrScanner.start({facingMode:"environment"}, config, t => { 
                stopScanner(); document.getElementById('joinIdInput').value = t; joinFreq(t); 
            }).catch(err => { 
                console.error(err); stopScanner(); toast("Erreur CamÃ©ra", true); 
            });
        }
        function stopScanner() { 
            if(qrScanner) { qrScanner.stop().then(() => { qrScanner.clear(); document.getElementById('scanner-overlay').style.display='none'; }).catch(() => document.getElementById('scanner-overlay').style.display='none'); } 
            else document.getElementById('scanner-overlay').style.display='none';
        }
    </script>
</body>
</html>

