<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="description" content="ComTac Tactical Web Interface V14.2">
    
    <title>COM TAC v14.2 ULTIMATE</title>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Chakra+Petch:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    
    <!-- DEPENDENCIES -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <!-- STYLES (REACT NATIVE ZINC THEME) -->
    <style>
        :root {
            --bg: #000000;
            --surface: #09090b;
            --surface-light: #18181b;
            --surface-lighter: #27272a;
            --border: #3f3f46;
            
            --blue: #3b82f6;
            --blue-dim: rgba(59, 130, 246, 0.2);
            --red: #ef4444;
            --red-dim: rgba(239, 68, 68, 0.2);
            --green: #22c55e;
            --green-dim: rgba(34, 197, 94, 0.2);
            --yellow: #eab308;
            --purple: #a855f7;
            
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            
            --font-ui: 'Chakra Petch', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 60px;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; width: 100%; overflow: hidden; background: var(--bg); color: var(--text-main); font-family: var(--font-ui); }

        /* AUDIO VISUALIZER BACKGROUND */
        #viz-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0.3; mix-blend-mode: screen;
        }

        /* LAYOUT COMPONENTS */
        .view {
            position: absolute; inset: 0; display: none; flex-direction: column;
            padding-top: calc(var(--header-height) + var(--safe-top));
            background: var(--bg); z-index: 10; opacity: 0; transition: opacity 0.3s ease;
        }
        .view.active { display: flex; opacity: 1; }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0; height: calc(var(--header-height) + var(--safe-top));
            padding-top: var(--safe-top); background: rgba(9, 9, 11, 0.95);
            border-bottom: 1px solid var(--border); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between; padding-inline: 20px;
            z-index: 100;
        }
        .brand { font-family: var(--font-ui); font-weight: 800; font-size: 1.25rem; letter-spacing: 2px; }
        .brand span { color: var(--blue); }
        .header-actions { display: flex; gap: 16px; }
        .icon-btn { color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
        .icon-btn:hover { color: white; }
        .icon-btn.danger { color: var(--red); }

        /* UI ELEMENTS */
        .btn {
            height: 56px; border-radius: 12px; border: 1px solid var(--border);
            background: var(--surface-light); color: white;
            font-family: var(--font-ui); font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.98); filter: brightness(0.9); }
        .btn.primary { background: var(--blue); border-color: var(--blue); box-shadow: 0 0 15px var(--blue-dim); }
        .btn.danger { background: var(--red); border-color: var(--red); box-shadow: 0 0 15px var(--red-dim); }
        .btn.purple { background: var(--purple); border-color: var(--purple); }
        .btn.ghost { background: transparent; border-color: transparent; color: var(--text-muted); }

        .input-group { margin-bottom: 20px; width: 100%; }
        .input-label { display: block; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; text-transform: uppercase; }
        .input-field {
            width: 100%; height: 56px; background: var(--surface-light);
            border: 1px solid var(--border); border-radius: 12px;
            color: white; font-family: var(--font-mono); font-size: 1.1rem; text-align: center;
            outline: none; transition: border-color 0.2s;
        }
        .input-field:focus { border-color: var(--blue); }

        /* MAP */
        #map-wrapper { flex: 1; position: relative; background: #000; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .map-overlay-controls {
            position: absolute; top: 20px; right: 20px; z-index: 500;
            display: flex; flex-direction: column; gap: 10px;
        }
        .ctrl-btn {
            width: 44px; height: 44px; border-radius: 22px;
            background: rgba(24, 24, 27, 0.9); border: 1px solid var(--border);
            color: var(--text-muted); display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .ctrl-btn.active { background: var(--blue); color: white; border-color: var(--blue); }
        .ctrl-btn.alert { background: var(--red); color: white; animation: flash 1s infinite; }

        /* OPS GRID */
        .ops-grid {
            padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px;
            overflow-y: auto; padding-bottom: 140px; /* Space for HUD */
            position: relative; z-index: 2;
        }
        .op-card {
            background: rgba(24, 24, 27, 0.8); border: 1px solid var(--border);
            border-radius: 12px; padding: 12px; position: relative;
            backdrop-filter: blur(5px); transition: all 0.2s;
        }
        .op-card.me { background: rgba(59, 130, 246, 0.1); border-color: var(--blue-dim); }
        .op-card.talking { border-color: var(--green); box-shadow: 0 0 15px var(--green-dim); }
        
        .op-role { font-size: 0.65rem; font-weight: 800; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 4px; }
        .op-callsign { font-family: var(--font-mono); font-size: 1.25rem; font-weight: 700; color: white; margin-bottom: 2px; }
        .op-status { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .op-meta { font-size: 0.7rem; color: var(--text-muted); margin-top: 8px; display: flex; justify-content: space-between; }
        
        .viz-bar { height: 3px; background: var(--surface-lighter); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .viz-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.05s; }

        /* HUD (Bottom Bar) */
        #hud {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(9, 9, 11, 0.95); border-top: 1px solid var(--border);
            padding: 12px 20px calc(12px + var(--safe-bottom));
            z-index: 800; display: none; backdrop-filter: blur(10px);
        }
        .status-scroller {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; margin-bottom: 8px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .status-scroller::-webkit-scrollbar { display: none; }
        
        .status-chip {
            padding: 6px 12px; border-radius: 8px; font-size: 0.7rem; font-weight: 700; white-space: nowrap;
            background: var(--surface-light); border: 1px solid var(--border); color: var(--text-muted);
            cursor: pointer;
        }
        .status-chip.active { color: white; border-color: transparent; }
        /* Dynamic Status Colors via JS, mapped here for ref */
        
        .ptt-controls { display: flex; align-items: center; justify-content: center; gap: 24px; }
        .round-btn {
            width: 48px; height: 48px; border-radius: 50%; background: var(--surface-light);
            border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); cursor: pointer;
        }
        .ptt-big-btn {
            width: 72px; height: 72px; border-radius: 24px;
            background: var(--surface-light); border: 2px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; color: var(--text-muted); cursor: pointer;
            transition: all 0.1s;
        }
        .ptt-big-btn.active { background: var(--blue); color: white; border-color: white; box-shadow: 0 0 20px var(--blue-dim); transform: scale(0.95); }
        .ptt-big-btn.vox { border-color: var(--green); color: var(--green); background: rgba(34, 197, 94, 0.1); }
        .ptt-big-btn.vox.tx { background: var(--green); color: black; }

        .hud-info { text-align: center; margin-top: 8px; font-size: 0.65rem; color: #52525b; font-family: var(--font-mono); }

        /* MODALS */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 24px; padding: 24px; width: 100%; max-width: 400px;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }
        .modal-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 20px; color: white; letter-spacing: 1px; }

        /* BANNERS */
        .sys-banner {
            position: fixed; top: calc(var(--header-height) + var(--safe-top)); left: 0; right: 0;
            padding: 8px; text-align: center; font-weight: 700; font-size: 0.75rem; letter-spacing: 1px;
            z-index: 900; display: none; animation: flash 2s infinite;
        }
        .sys-banner.red { background: var(--red); color: white; }
        .sys-banner.purple { background: var(--purple); color: white; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        /* TOAST */
        #toast {
            position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: var(--surface-light); color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; font-size: 0.85rem; z-index: 3000; display: none;
            border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            white-space: nowrap;
        }

        /* MARKERS */
        .tac-marker { position: relative; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; }
        .tac-cone { position: absolute; inset: 0; transition: transform 0.2s linear; }
        .tac-dot {
            width: 24px; height: 24px; border-radius: 50%; background: var(--blue);
            border: 2px solid white; z-index: 2; position: relative;
            display: flex; justify-content: center; align-items: center;
            font-family: var(--font-mono); font-size: 8px; font-weight: 900; color: white;
            text-shadow: 0 1px 2px black;
        }
    </style>
</head>
<body>

    <!-- VISUALIZER CANVAS (Background) -->
    <canvas id="viz-canvas"></canvas>

    <!-- NOTIFICATIONS -->
    <div id="banner-silence" class="sys-banner red">SILENCE RADIO ACTIF</div>
    <div id="banner-private" class="sys-banner purple">CANAL PRIV√â S√âCURIS√â</div>
    <div id="toast">Info</div>

    <!-- HEADER -->
    <header>
        <div class="brand">COM<span>TAC</span> v14.2</div>
        <div class="header-actions">
            <span class="material-symbols-outlined icon-btn" onclick="App.setView('settings')">settings</span>
            <span class="material-symbols-outlined icon-btn danger" onclick="App.logout()">power_settings_new</span>
        </div>
    </header>

    <!-- 1. VIEW: LOGIN -->
    <div id="view-login" class="view active" style="justify-content: center; align-items: center; padding: 40px;">
        <span class="material-symbols-outlined" style="font-size: 64px; color: var(--blue); margin-bottom: 24px;">fingerprint</span>
        <h2 style="margin-bottom: 40px; letter-spacing: 4px; font-weight: 800;">IDENTIFICATION</h2>
        
        <div class="input-group">
            <input type="text" id="login-trigram" class="input-field" placeholder="TRIGRAMME" maxlength="6" style="text-transform:uppercase;">
        </div>
        
        <div class="btn primary" style="width: 100%;" onclick="App.login()">CONNEXION</div>
        <div style="margin-top: 20px; font-size: 0.75rem; color: var(--text-muted);">Version Ultimate Web Build 14.2.0</div>
    </div>

    <!-- 2. VIEW: MENU -->
    <div id="view-menu" class="view" style="padding: 24px;">
        <div class="input-label">D√âPLOIEMENT</div>
        <div class="btn" style="justify-content: flex-start; margin-bottom: 24px; padding: 20px;" onclick="NetService.hostSession()">
            <span class="material-symbols-outlined" style="color: var(--blue); font-size: 32px;">add_circle</span>
            <div style="text-align: left;">
                <div style="color: white; font-size: 1.1rem; line-height: 1.2;">CR√âER SALON</div>
                <div style="color: var(--text-muted); font-size: 0.75rem; font-weight: 500; text-transform: none;">H√¥te / Chef de groupe</div>
            </div>
        </div>

        <div style="height: 1px; background: var(--border); margin-bottom: 24px;"></div>

        <div class="input-label">REJOINDRE</div>
        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <div class="btn" style="flex: 1;" onclick="QRService.scan()">
                <span class="material-symbols-outlined">qr_code_scanner</span> SCAN
            </div>
        </div>
        <div class="input-group">
            <input type="text" id="menu-join-id" class="input-field" placeholder="ID CANAL..." style="text-align: left; padding-left: 20px;">
        </div>
        <div class="btn" onclick="NetService.joinSession()">REJOINDRE MANUELLEMENT</div>
    </div>

    <!-- 3. VIEW: OPS (GRID) -->
    <div id="view-ops" class="view">
        <div id="ops-grid" class="ops-grid">
            <!-- Injected by JS -->
        </div>
    </div>

    <!-- 4. VIEW: MAP -->
    <div id="view-map" class="view">
        <div id="map-wrapper">
            <div class="map-overlay-controls">
                <div class="ctrl-btn" onclick="MapService.toggleLayer()"><span class="material-symbols-outlined">layers</span></div>
                <div class="ctrl-btn" id="btn-trails" onclick="MapService.toggleTrails()"><span class="material-symbols-outlined">timeline</span></div>
                <div class="ctrl-btn" id="btn-ping" onclick="App.togglePingMode()"><span class="material-symbols-outlined">ads_click</span></div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- 5. VIEW: SETTINGS -->
    <div id="view-settings" class="view" style="padding: 24px;">
        <h2 class="modal-title" style="text-align: left;">CONFIGURATION</h2>
        
        <div class="input-group">
            <label class="input-label">Identit√© (Trigramme)</label>
            <input type="text" id="settings-trigram" class="input-field" style="text-align: left; padding-left: 20px; text-transform:uppercase;" onblur="ConfigService.updateTrigram()">
        </div>

        <div class="input-group">
            <label class="input-label">Couleur tactique</label>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <div class="round-btn" style="background: #3b82f6;" onclick="ConfigService.setColor('#3b82f6')"></div>
                <div class="round-btn" style="background: #ef4444;" onclick="ConfigService.setColor('#ef4444')"></div>
                <div class="round-btn" style="background: #22c55e;" onclick="ConfigService.setColor('#22c55e')"></div>
                <div class="round-btn" style="background: #eab308;" onclick="ConfigService.setColor('#eab308')"></div>
                <div class="round-btn" style="background: #a855f7;" onclick="ConfigService.setColor('#a855f7')"></div>
            </div>
        </div>

        <div class="input-group">
            <label class="input-label">Pr√©cision GPS / Batterie</label>
            <div style="display: flex; gap: 10px;">
                <div class="btn" style="flex:1; height: 44px; font-size: 0.8rem;" onclick="ConfigService.setGps(2000)">HAUTE (2s)</div>
                <div class="btn" style="flex:1; height: 44px; font-size: 0.8rem;" onclick="ConfigService.setGps(10000)">ECO (10s)</div>
            </div>
        </div>
        
        <div class="input-group" style="margin-top: 30px;">
             <label class="input-label">Cache Carte (Offline)</label>
             <div class="btn ghost" style="border: 1px solid var(--border);" onclick="DBService.clearCache()">VIDER LE CACHE LOCAL</div>
        </div>

        <div class="btn" style="margin-top: 20px;" onclick="App.setView('menu')">RETOUR MENU</div>
    </div>

    <!-- HUD BOTTOM BAR -->
    <div id="hud">
        <div class="status-scroller" id="status-bar">
            <!-- Dynamic Chips -->
            <div id="btn-private-exit" class="status-chip" style="background: var(--purple); color: white; display: none;" onclick="App.leavePrivate()">QUITTER PRIV√â</div>
            <div id="btn-silence-host" class="status-chip" style="background: var(--red); color: white; display: none;" onclick="App.toggleSilence()">SILENCE</div>
            
            <div class="status-chip" onclick="App.setStatus('PROGRESSION')" data-status="PROGRESSION">PROGRESSION</div>
            <div class="status-chip" onclick="App.setStatus('CONTACT')" data-status="CONTACT">CONTACT</div>
            <div class="status-chip" onclick="App.setStatus('CLEAR')" data-status="CLEAR">CLEAR</div>
            <div class="status-chip" onclick="App.setStatus('APPUI')" data-status="APPUI">APPUI</div>
            <div class="status-chip" onclick="App.setStatus('BUSY')" data-status="BUSY">BUSY</div>
        </div>

        <div class="ptt-controls">
            <div class="round-btn" onclick="AudioService.toggleVox()">
                <span id="icon-vox" class="material-symbols-outlined">mic_none</span>
            </div>
            <div id="ptt-btn" class="ptt-big-btn">
                <span class="material-symbols-outlined">mic</span>
            </div>
            <div class="round-btn" onclick="App.toggleMap()">
                <span id="icon-view-toggle" class="material-symbols-outlined">map</span>
            </div>
        </div>
        <div class="hud-info">
            <span id="hud-id" onclick="App.copyID()">ID: --</span> ‚Ä¢ <span id="hud-gps">GPS: WAIT</span> ‚Ä¢ <span id="hud-peers">0 OPR</span>
        </div>
    </div>

    <!-- MODAL: OPERATOR ACTION -->
    <div id="modal-operator" class="modal-backdrop" onclick="if(event.target === this) this.style.display='none'">
        <div class="modal-card">
            <div class="input-label">ACTION OP√âRATEUR</div>
            <h2 id="modal-op-callsign" style="color: white; font-size: 2rem; margin-bottom: 5px;">UNK</h2>
            <div id="modal-op-id" style="color: var(--text-muted); font-family: var(--font-mono); font-size: 0.8rem; margin-bottom: 24px;">ID: ...</div>

            <div style="background: var(--surface-light); padding: 16px; border-radius: 12px; margin-bottom: 24px; display: flex; align-items: center;">
                <div id="modal-op-status-color" style="width: 48px; height: 48px; border-radius: 10px; background: var(--green); margin-right: 16px;"></div>
                <div style="text-align: left;">
                    <div id="modal-op-status-text" style="font-weight: 800; color: white; font-size: 1.1rem;">CLEAR</div>
                    <div id="modal-op-bat" style="font-size: 0.8rem; color: var(--text-muted);">Batterie: --%</div>
                </div>
            </div>

            <div class="btn purple" onclick="App.initiatePrivateCall()" style="margin-bottom: 12px;">
                <span class="material-symbols-outlined">lock</span> APPEL PRIV√â
            </div>
            
            <div id="btn-kick" class="btn danger" style="margin-bottom: 12px; display: none;" onclick="App.kickUser()">
                <span class="material-symbols-outlined">block</span> BANNIR
            </div>

            <div class="btn ghost" onclick="document.getElementById('modal-operator').style.display='none'">FERMER</div>
        </div>
    </div>

    <!-- MODAL: CONSENT -->
    <div id="modal-consent" class="modal-backdrop" style="background: black;">
        <div class="modal-card" style="text-align: left;">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                <span class="material-symbols-outlined" style="color: var(--blue);">security</span>
                <span style="font-weight: 800; font-size: 1.1rem; color: white;">PROTOCOLE DE S√âCURIT√â</span>
            </div>
            
            <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin-bottom: 20px;">
                Initialisation des syst√®mes tactiques. L'acc√®s aux capteurs mat√©riels est requis pour le fonctionnement op√©rationnel :
            </p>

            <div style="margin-bottom: 12px;">
                <div style="color: white; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                    <span class="material-symbols-outlined" style="color: var(--red); font-size: 18px;">location_on</span> GPS
                </div>
                <div style="color: var(--text-muted); font-size: 0.8rem; margin-left: 26px;">Positionnement tactique sur carte.</div>
            </div>

            <div style="margin-bottom: 24px;">
                <div style="color: white; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                    <span class="material-symbols-outlined" style="color: var(--green); font-size: 18px;">mic</span> AUDIO COMMS
                </div>
                <div style="color: var(--text-muted); font-size: 0.8rem; margin-left: 26px;">VoIP P2P & Analyse spectrale.</div>
            </div>

            <div class="btn primary" onclick="App.acceptConsent()">INITIALISER SYST√àMES</div>
        </div>
    </div>

    <!-- MODAL: SCANNER -->
    <div id="modal-scanner" class="modal-backdrop">
        <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div id="qr-reader" style="width: 300px; height: 300px; border: 2px solid var(--blue); border-radius: 12px; overflow: hidden;"></div>
            <div class="btn" style="margin-top: 24px; width: 200px;" onclick="QRService.stop()">ANNULER</div>
        </div>
    </div>

    <!-- JAVASCRIPT CORE -->
    <script>
        // --- CONSTANTES & UTILS ---
        const CONSTANTS = {
            STATUS_COLORS: { 'CLEAR': '#22c55e', 'CONTACT': '#ef4444', 'BUSY': '#a855f7', 'APPUI': '#eab308', 'PROGRESSION': '#3b82f6' },
            PEER_CONFIG: { debug: 1, config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] } }
        };
        const Utils = {
            id: () => Math.random().toString(36).substring(2, 10).toUpperCase(),
            sleep: (ms) => new Promise(r => setTimeout(r, ms)),
            now: () => Date.now()
        };

        // --- SERVICE BASE DE DONN√âES (CACHE CARTE OFFLINE) ---
        const DBService = {
            db: null,
            init: async () => {
                return new Promise((resolve) => {
                    const request = indexedDB.open("ComTacDB", 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains("tiles")) db.createObjectStore("tiles");
                    };
                    request.onsuccess = (e) => { DBService.db = e.target.result; resolve(); };
                    request.onerror = (e) => { console.error("DB Error", e); resolve(); };
                });
            },
            saveTile: (key, blob) => {
                if (!DBService.db) return;
                const tx = DBService.db.transaction(["tiles"], "readwrite");
                tx.objectStore("tiles").put(blob, key);
            },
            getTile: async (key) => {
                if (!DBService.db) return null;
                return new Promise((resolve) => {
                    const tx = DBService.db.transaction(["tiles"], "readonly");
                    const req = tx.objectStore("tiles").get(key);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => resolve(null);
                });
            },
            clearCache: () => {
                if (!DBService.db) return;
                const tx = DBService.db.transaction(["tiles"], "readwrite");
                tx.objectStore("tiles").clear();
                App.toast("Cache carte vid√©");
            }
        };

        // --- SERVICE CONFIGURATION ---
        const ConfigService = {
            settings: { username: 'OPR', color: '#3b82f6', gpsInterval: 5000, theme: 'dark' },
            load: () => {
                const s = localStorage.getItem('comtac_settings');
                if (s) ConfigService.settings = { ...ConfigService.settings, ...JSON.parse(s) };
                // Update UI
                document.getElementById('settings-trigram').value = ConfigService.settings.username;
                document.getElementById('login-trigram').value = ConfigService.settings.username;
            },
            save: () => localStorage.setItem('comtac_settings', JSON.stringify(ConfigService.settings)),
            updateTrigram: () => {
                const val = document.getElementById('settings-trigram').value.trim().toUpperCase();
                if (val.length >= 2) {
                    ConfigService.settings.username = val;
                    App.user.callsign = val;
                    ConfigService.save();
                    NetService.broadcast();
                }
            },
            setColor: (hex) => {
                ConfigService.settings.color = hex;
                ConfigService.save();
                MapService.refreshMap();
                App.toast("Couleur tactique mise √† jour");
            },
            setGps: (val) => {
                ConfigService.settings.gpsInterval = val;
                ConfigService.save();
                MapService.restartGPS();
                App.toast(`Intervalle GPS: ${val/1000}s`);
            }
        };

        // --- SERVICE AUDIO & DSP (PROCESSING) ---
        const AudioService = {
            ctx: null, stream: null, 
            nodes: { input: null, compressor: null, gate: null, analyser: null, dest: null },
            vad: { active: false, timer: null, threshold: 0.02 },
            mode: 'ptt', // 'ptt' or 'vox'

            init: async () => {
                try {
                    const AC = window.AudioContext || window.webkitAudioContext;
                    AudioService.ctx = new AC();
                    
                    // Contraintes strictes pour audio vocal
                    const constraints = { 
                        audio: { 
                            echoCancellation: true, noiseSuppression: true, autoGainControl: true,
                            latency: 0, channelCount: 1 
                        } 
                    };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    AudioService.setupDSP(stream);
                    return true;
                } catch(e) { console.error("Audio Init Fail", e); App.toast("Erreur Micro: " + e.message); return false; }
            },

            setupDSP: (stream) => {
                const ctx = AudioService.ctx;
                const source = ctx.createMediaStreamSource(stream);
                
                // 1. Filtre Passe-Haut (Coupe bruits sourds)
                const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 120;
                
                // 2. Filtre Pr√©sence (Boost voix 2-4kHz)
                const presence = ctx.createBiquadFilter(); presence.type = 'peaking'; presence.frequency.value = 2500; presence.gain.value = 4;
                
                // 3. Compresseur (Nivelle le volume)
                const comp = ctx.createDynamicsCompressor(); 
                comp.threshold.value = -24; comp.knee.value = 30; comp.ratio.value = 12; comp.attack.value = 0.003; comp.release.value = 0.25;

                // 4. Noise Gate (Mute si trop bas)
                const gate = ctx.createGain(); gate.gain.value = 0;

                // 5. Analyser (Pour VAD et Visualiseur)
                const analyser = ctx.createAnalyser(); analyser.fftSize = 256;

                // 6. Destination WebRTC
                const dest = ctx.createMediaStreamDestination();

                // Chainage
                source.connect(hp);
                hp.connect(presence);
                presence.connect(comp);
                comp.connect(gate); // Le gate contr√¥le la sortie vers le stream
                gate.connect(dest);
                
                // Branchement Analyser AVANT le gate pour que le VAD fonctionne m√™me 'mut√©'
                comp.connect(analyser);

                AudioService.nodes = { input: source, compressor: comp, gate: gate, analyser: analyser, dest: dest };
                AudioService.stream = dest.stream;

                // D√©marrage des boucles
                AudioService.startVADLoop();
                VizService.start(analyser);
            },

            startVADLoop: () => {
                const buffer = new Uint8Array(AudioService.nodes.analyser.frequencyBinCount);
                setInterval(() => {
                    if (AudioService.mode !== 'vox' || App.user.isTxRequest) return; // Ignore VAD if PTT pressed or PTT mode

                    AudioService.nodes.analyser.getByteTimeDomainData(buffer);
                    let sum = 0;
                    for(let i=0; i<buffer.length; i++) { const x = (buffer[i]-128)/128; sum += x*x; }
                    const rms = Math.sqrt(sum/buffer.length);

                    if (rms > AudioService.vad.threshold) {
                        if (!AudioService.vad.active) AudioService.tx(true);
                        AudioService.vad.active = true;
                        if (AudioService.vad.timer) clearTimeout(AudioService.vad.timer);
                        AudioService.vad.timer = setTimeout(() => {
                            AudioService.vad.active = false;
                            AudioService.tx(false);
                        }, 800); // 800ms hold time
                    }
                }, 50);
            },

            tx: (state) => {
                // R√®gles de priorit√©
                if (App.silenceActive && !App.isHost) state = false; // Silence impos√©
                if (state === App.user.isTx) return;

                App.user.isTx = state;
                const now = AudioService.ctx.currentTime;
                
                // Ouverture/Fermeture Gate
                if (state) AudioService.nodes.gate.gain.setTargetAtTime(1, now, 0.01);
                else AudioService.nodes.gate.gain.setTargetAtTime(0, now, 0.1);

                // UI Feedback
                const btn = document.getElementById('ptt-btn');
                if (state) btn.classList.add('active'); else btn.classList.remove('active');
                if (AudioService.mode === 'vox') {
                    if(state) btn.classList.add('tx'); else btn.classList.remove('tx');
                }

                // Broadcast state
                NetService.broadcast({ type: 'UPDATE', user: App.user });
                App.renderGrid();
            },

            toggleVox: () => {
                AudioService.mode = AudioService.mode === 'ptt' ? 'vox' : 'ptt';
                const on = AudioService.mode === 'vox';
                document.getElementById('icon-vox').innerText = on ? 'mic' : 'mic_none';
                document.getElementById('ptt-btn').classList.toggle('vox', on);
                App.toast(on ? "VOX ACTIV√â (Seuil Auto)" : "MODE PTT MANUEL");
            }
        };

        // --- SERVICE VISUALISATION (CANVAS) ---
        const VizService = {
            canvas: document.getElementById('viz-canvas'),
            ctx: null, analyser: null, running: false,
            init: () => {
                VizService.ctx = VizService.canvas.getContext('2d');
                VizService.resize();
                window.addEventListener('resize', VizService.resize);
            },
            resize: () => {
                VizService.canvas.width = window.innerWidth;
                VizService.canvas.height = window.innerHeight;
            },
            start: (analyser) => {
                VizService.analyser = analyser;
                if(!VizService.running) { VizService.running = true; VizService.loop(); }
            },
            loop: () => {
                if(!VizService.running) return;
                requestAnimationFrame(VizService.loop);
                
                const w = VizService.canvas.width;
                const h = VizService.canvas.height;
                const ctx = VizService.ctx;
                const bufferLength = VizService.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                VizService.analyser.getByteFrequencyData(dataArray);

                ctx.clearRect(0, 0, w, h);
                ctx.lineWidth = 2;
                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--blue');
                ctx.beginPath();

                const sliceWidth = w * 1.0 / bufferLength;
                let x = 0;

                for(let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = (h - (v * h/4)) - h/2; // Onde en bas d'√©cran

                    if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                    x += sliceWidth;
                }
                ctx.stroke();
            }
        };

        // --- SERVICE CARTE (LEAFLET + OFFLINE) ---
        const MapService = {
            map: null, layer: null, markers: {}, trails: {}, pings: {}, watchId: null,
            mode: 'dark', showTrails: true,

            init: async () => {
                if (MapService.map) return;
                await DBService.init();

                MapService.map = L.map('map', { 
                    zoomControl: false, attributionControl: false, 
                    minZoom: 4, maxZoom: 18 
                }).setView([46.603354, 1.888334], 6); // France center default

                MapService.loadLayer();
                MapService.map.on('click', (e) => { if(App.pingMode) App.sendPing(e.latlng); });
            },

            // Custom Layer qui check DB puis Network
            loadLayer: () => {
                if(MapService.layer) MapService.map.removeLayer(MapService.layer);
                
                const url = MapService.mode === 'dark' 
                    ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                    : 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';

                // Impl√©mentation Offline Tile Layer
                const OfflineLayer = L.TileLayer.extend({
                    createTile: function(coords, done) {
                        const tile = document.createElement('img');
                        const url = this.getTileUrl(coords);
                        const key = `${coords.z}_${coords.x}_${coords.y}_${MapService.mode}`;

                        DBService.getTile(key).then(blob => {
                            if (blob) {
                                tile.src = URL.createObjectURL(blob);
                                done(null, tile);
                            } else {
                                tile.src = url;
                                // Fetch & Cache en background
                                fetch(url).then(res => res.blob()).then(blob => {
                                    DBService.saveTile(key, blob);
                                }).catch(() => {}); // Silent fail
                                
                                L.DomEvent.on(tile, 'load', L.Util.bind(this._tileOnLoad, this, done, tile));
                                L.DomEvent.on(tile, 'error', L.Util.bind(this._tileOnError, this, done, tile));
                            }
                        });
                        return tile;
                    }
                });

                MapService.layer = new OfflineLayer(url, { subdomains: 'abcd' }).addTo(MapService.map);
            },

            toggleLayer: () => {
                MapService.mode = MapService.mode === 'dark' ? 'sat' : 'dark';
                MapService.loadLayer();
            },

            toggleTrails: () => {
                MapService.showTrails = !MapService.showTrails;
                document.getElementById('btn-trails').classList.toggle('active', MapService.showTrails);
                Object.values(MapService.trails).forEach(t => t.setStyle({ opacity: MapService.showTrails ? 0.6 : 0 }));
            },

            restartGPS: () => {
                if (MapService.watchId) navigator.geolocation.clearWatch(MapService.watchId);
                const opts = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };
                
                MapService.watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude, heading, speed } = pos.coords;
                        App.user.lat = latitude; App.user.lng = longitude;
                        if(speed > 1) App.user.head = heading || 0;
                        
                        document.getElementById('hud-gps').innerText = "GPS: OK";
                        document.getElementById('hud-gps').style.color = "var(--green)";
                        MapService.updateMarker(App.user);
                        NetService.broadcast(); // Send position
                    },
                    (err) => {
                        document.getElementById('hud-gps').innerText = "GPS: NO";
                        document.getElementById('hud-gps').style.color = "var(--red)";
                    },
                    opts
                );
            },

            updateMarker: (u) => {
                if(!MapService.map || !u.lat) return;
                
                let color = CONSTANTS.STATUS_COLORS[u.status] || ConfigService.settings.color;
                if (u.id === App.user.id) color = ConfigService.settings.color;

                const coneSvg = `<svg viewBox="0 0 100 100" width="80" height="80" style="overflow:visible;"><path d="M50 50 L10 0 A60 60 0 0 1 90 0 Z" fill="${color}" fill-opacity="0.2" stroke="${color}" stroke-width="1" stroke-opacity="0.5" /></svg>`;
                const html = `<div class="tac-marker"><div class="tac-cone" style="transform: rotate(${u.head||0}deg);">${coneSvg}</div><div class="tac-dot" style="background:${color}; border-color: ${u.isTx ? '#22c55e' : 'white'}">${u.callsign.substring(0,3)}</div></div>`;
                const icon = L.divIcon({ className: 'c-icon', html: html, iconSize: [80, 80], iconAnchor: [40, 40] });

                if (MapService.markers[u.id]) {
                    MapService.markers[u.id].setLatLng([u.lat, u.lng]).setIcon(icon).setZIndexOffset(u.id === App.user.id ? 1000 : 500);
                } else {
                    MapService.markers[u.id] = L.marker([u.lat, u.lng], { icon: icon, zIndexOffset: u.id === App.user.id ? 1000 : 500 }).addTo(MapService.map);
                }

                if (!MapService.trails[u.id]) MapService.trails[u.id] = L.polyline([], { color: color, weight: 2, dashArray: '4,4', opacity: MapService.showTrails ? 0.6 : 0 }).addTo(MapService.map);
                MapService.trails[u.id].addLatLng([u.lat, u.lng]);
            },

            addPing: (p) => {
                if(!MapService.map) return;
                const icon = L.divIcon({ className: '', html: `<div style="text-align:center;"><div style="font-size:30px;">üìç</div><span style="background:var(--red);color:white;padding:2px 4px;border-radius:4px;font-size:10px;font-weight:bold;">${p.msg}</span></div>`, iconSize: [100,60], iconAnchor: [50,50] });
                const m = L.marker([p.lat, p.lng], { icon: icon }).addTo(MapService.map);
                setTimeout(() => MapService.map.removeLayer(m), 10000); // Auto remove 10s
                App.toast(`PING: ${p.msg} par ${p.sender}`);
            },
            
            refreshMap: () => {
                MapService.updateMarker(App.user);
                Object.values(App.peers).forEach(p => MapService.updateMarker(p.data));
            }
        };

        // --- SERVICE R√âSEAU ROBUSTE (P2P + HANDLERS) ---
        const NetService = {
            peer: null, hostId: null, connRetry: 0,
            
            hostSession: () => {
                App.isHost = true; App.user.role = 'HOST';
                NetService.initPeer();
            },

            joinSession: (id) => {
                const tid = id || document.getElementById('menu-join-id').value.trim().toUpperCase();
                if (!tid) return App.toast("ID Invalide");
                App.isHost = false; NetService.hostId = tid;
                NetService.initPeer();
            },

            initPeer: () => {
                const myId = App.isHost ? Utils.id() : null; // Host gets deterministic ID logic or random
                NetService.peer = new Peer(myId, CONSTANTS.PEER_CONFIG);

                NetService.peer.on('open', (pid) => {
                    App.user.id = pid;
                    App.setView('ops');
                    document.getElementById('hud-id').innerText = `ID: ${pid}`;
                    VizService.init(); // Start viz once in app
                    
                    if (App.isHost) {
                        App.toast(`SALON INITIALIS√â: ${pid}`);
                        document.getElementById('btn-silence-host').style.display = 'block';
                        document.getElementById('btn-kick').style.display = 'flex';
                        NetService.startHostHeartbeat();
                    } else {
                        NetService.connectToHost();
                    }
                });

                NetService.peer.on('error', (err) => {
                    console.error("Peer Err", err);
                    if (err.type === 'peer-unavailable') App.toast("H√¥te introuvable / HLL");
                    else App.toast(`Err Net: ${err.type}`);
                });

                // RECEPTION APPELS (AUDIO)
                NetService.peer.on('call', (call) => {
                    call.answer(AudioService.stream); // Answer with my DSP stream
                    call.on('stream', (remoteStream) => {
                        const audio = new Audio();
                        audio.srcObject = remoteStream;
                        audio.play().catch(e => console.log("Autoplay blocked", e));
                    });
                });

                // RECEPTION DATA
                NetService.peer.on('connection', NetService.handleConnection);
            },

            connectToHost: () => {
                if(!NetService.hostId) return;
                const conn = NetService.peer.connect(NetService.hostId);
                
                conn.on('open', () => {
                    conn.send({ type: 'FULL', user: App.user }); // Handshake
                    NetService.peer.call(NetService.hostId, AudioService.stream); // Call Host
                    App.toast("Connect√© au QG");
                    document.getElementById('hud-peers').style.color = 'var(--green)';
                });
                
                conn.on('close', () => {
                    App.toast("Perte connexion H√¥te. Reconnexion...");
                    document.getElementById('hud-peers').style.color = 'var(--red)';
                    setTimeout(NetService.connectToHost, 3000); // Retry logic
                });

                NetService.handleConnection(conn);
            },

            handleConnection: (conn) => {
                if (!App.peers[conn.peer]) App.peers[conn.peer] = { conn: conn, data: {} };
                
                conn.on('data', (d) => {
                    switch(d.type) {
                        case 'FULL': 
                        case 'UPDATE': 
                            NetService.updatePeer(d.user);
                            if(App.isHost) NetService.broadcast(d); // Relay (Mesh logic via Star)
                            break;
                        case 'SYNC':
                            if(d.list) d.list.forEach(u => NetService.updatePeer(u));
                            if(d.silence !== undefined) App.setSilence(d.silence);
                            break;
                        case 'PING':
                            MapService.addPing(d.ping);
                            if(App.isHost) NetService.broadcast(d);
                            break;
                        case 'SILENCE':
                            App.setSilence(d.state);
                            if(App.isHost) NetService.broadcast(d);
                            break;
                        case 'KICK':
                            if(!App.isHost) App.logout(true);
                            break;
                        case 'PRIVATE_REQ':
                            if(confirm(`APPEL PRIV√â ENTRANT: ${App.peers[d.from]?.data?.callsign || d.from} ?`)) {
                                conn.send({ type: 'PRIVATE_ACK', from: App.user.id });
                                App.enterPrivate(d.from, true);
                            }
                            break;
                        case 'PRIVATE_ACK':
                            App.enterPrivate(d.from, true);
                            break;
                        case 'PRIVATE_END':
                            App.leavePrivate(false);
                            break;
                    }
                });

                // Host Sync Logic on new connection
                if (App.isHost && conn.open) {
                    const list = Object.values(App.peers).map(p => p.data); list.push(App.user);
                    conn.send({ type: 'SYNC', list: list, silence: App.silenceActive });
                }
            },

            updatePeer: (u) => {
                if (u.id === App.user.id) return;
                if (!App.peers[u.id]) App.peers[u.id] = { data: {} };
                App.peers[u.id].data = { ...App.peers[u.id].data, ...u };
                App.renderGrid(); MapService.updateMarker(u);
                
                // Update Peer Count UI
                const count = Object.keys(App.peers).length + 1;
                document.getElementById('hud-peers').innerText = `${count} OPR`;
            },

            broadcast: (msg) => {
                Object.values(App.peers).forEach(p => { 
                    if(p.conn && p.conn.open) p.conn.send(msg); 
                });
            },

            startHostHeartbeat: () => {
                setInterval(() => {
                    if(!App.isHost) return;
                    const list = Object.values(App.peers).map(p => p.data); list.push(App.user);
                    NetService.broadcast({ type: 'SYNC', list: list });
                }, 5000); // Sync full state every 5s
            }
        };

        // --- SERVICE QR CODE ---
        const QRService = {
            scanner: null,
            scan: () => {
                document.getElementById('modal-scanner').style.display = 'flex';
                QRService.scanner = new Html5Qrcode("qr-reader");
                QRService.scanner.start({ facingMode: "environment" }, { fps: 10 }, (txt) => {
                    QRService.stop();
                    NetService.joinSession(txt);
                });
            },
            stop: () => {
                if(QRService.scanner) QRService.scanner.stop().then(() => {
                   document.getElementById('modal-scanner').style.display = 'none';
                });
            }
        };

        // --- APP MAIN CONTROLLER ---
        const App = {
            user: { id: null, callsign: 'OPR', role: 'OPR', status: 'CLEAR', lat: 0, lng: 0, head: 0, bat: 100, isTx: false },
            peers: {}, isHost: false, pingMode: false, silenceActive: false, privatePeerId: null, selectedOpId: null,

            init: async () => {
                ConfigService.load();
                
                // Check Battery
                if(navigator.getBattery) navigator.getBattery().then(b => {
                    const upd = () => { App.user.bat = Math.floor(b.level * 100); NetService.broadcast({type:'UPDATE', user:App.user}); };
                    upd(); b.addEventListener('levelchange', upd);
                });

                // Init Services
                await MapService.init();

                // Check Consent
                if(!localStorage.getItem('comtac_consent')) document.getElementById('modal-consent').style.display = 'flex';

                // PTT Bindings
                const ptt = document.getElementById('ptt-btn');
                const start = (e) => { e.preventDefault(); App.user.isTxRequest = true; AudioService.tx(true); };
                const end = (e) => { e.preventDefault(); App.user.isTxRequest = false; AudioService.tx(false); };
                ['mousedown', 'touchstart'].forEach(e => ptt.addEventListener(e, start));
                ['mouseup', 'mouseleave', 'touchend'].forEach(e => ptt.addEventListener(e, end));
            },

            acceptConsent: async () => {
                localStorage.setItem('comtac_consent', 'true');
                document.getElementById('modal-consent').style.display = 'none';
                await AudioService.init();
            },

            login: () => {
                const tri = document.getElementById('login-trigram').value.trim();
                if(tri.length < 2) return App.toast("Trigramme requis");
                ConfigService.updateTrigram();
                App.setView('menu');
                MapService.restartGPS();
            },

            setView: (id) => {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-' + id).classList.add('active');
                
                // HUD Logic
                const hud = document.getElementById('hud');
                if(id === 'ops' || id === 'map') {
                    hud.style.display = 'block';
                    if(id === 'map') setTimeout(() => MapService.map.invalidateSize(), 200);
                } else hud.style.display = 'none';
            },

            toggleMap: () => {
                const isMap = document.getElementById('view-map').classList.contains('active');
                App.setView(isMap ? 'ops' : 'map');
            },

            renderGrid: () => {
                const grid = document.getElementById('ops-grid');
                grid.innerHTML = '';
                
                const list = [{...App.user, isMe: true}].concat(Object.values(App.peers).map(p => p.data).filter(d => d.id));
                
                list.forEach(u => {
                    const div = document.createElement('div');
                    div.className = `op-card ${u.isMe ? 'me' : ''} ${u.isTx ? 'talking' : ''}`;
                    
                    const color = CONSTANTS.STATUS_COLORS[u.status] || '#fff';
                    
                    div.innerHTML = `
                        <div class="op-header"><span class="op-role">${u.role}</span></div>
                        <div class="op-callsign">${u.callsign}</div>
                        <div class="op-status" style="color:${color}">${u.status}</div>
                        <div class="op-meta">
                            <span>BAT ${u.bat}%</span>
                            ${u.isTx ? '<span style="color:var(--green)">TX ON</span>' : ''}
                        </div>
                        <div class="viz-bar"><div class="viz-fill" style="width:${u.isTx ? '100%' : '0%'}"></div></div>
                    `;
                    
                    if(!u.isMe) div.onclick = () => App.openOpModal(u);
                    grid.appendChild(div);
                });
            },

            openOpModal: (u) => {
                App.selectedOpId = u.id;
                document.getElementById('modal-op-callsign').innerText = u.callsign;
                document.getElementById('modal-op-id').innerText = u.id;
                document.getElementById('modal-op-status-text').innerText = u.status;
                document.getElementById('modal-op-status-color').style.background = CONSTANTS.STATUS_COLORS[u.status];
                document.getElementById('modal-operator').style.display = 'flex';
            },

            setStatus: (s) => {
                App.user.status = s;
                // Update Chip UI
                document.querySelectorAll('.status-chip').forEach(c => {
                    c.classList.toggle('active', c.dataset.status === s);
                    if(c.dataset.status === s) {
                       c.style.background = CONSTANTS.STATUS_COLORS[s];
                       c.style.color = 'white';
                    } else if(c.dataset.status) {
                       c.style.background = 'var(--surface-light)';
                       c.style.color = 'var(--text-muted)';
                    }
                });
                NetService.broadcast(); App.renderGrid();
            },

            toggleSilence: () => {
                if(!App.isHost) return;
                App.setSilence(!App.silenceActive);
                NetService.broadcast({ type: 'SILENCE', state: App.silenceActive });
            },

            setSilence: (state) => {
                App.silenceActive = state;
                document.getElementById('banner-silence').style.display = state ? 'block' : 'none';
                document.getElementById('btn-silence-host').style.display = App.isHost ? 'block' : 'none';
                document.getElementById('btn-silence-host').style.opacity = state ? '1' : '0.5';
                if(state && !App.isHost) AudioService.tx(false); // Force Mute
            },

            initiatePrivateCall: () => {
                if(App.selectedOpId && App.peers[App.selectedOpId]) {
                    App.peers[App.selectedOpId].conn.send({ type: 'PRIVATE_REQ', from: App.user.id });
                    App.toast("Demande Priv√©e Envoy√©e");
                }
                document.getElementById('modal-operator').style.display = 'none';
            },

            enterPrivate: (peerId, call) => {
                App.privatePeerId = peerId;
                document.getElementById('banner-private').style.display = 'block';
                document.getElementById('btn-private-exit').style.display = 'block';
                document.body.style.border = '2px solid var(--purple)';
                if(call) NetService.peer.call(peerId, AudioService.stream);
            },

            leavePrivate: (notify=true) => {
                if(notify && App.privatePeerId && App.peers[App.privatePeerId]) {
                    App.peers[App.privatePeerId].conn.send({ type: 'PRIVATE_END' });
                }
                App.privatePeerId = null;
                document.getElementById('banner-private').style.display = 'none';
                document.getElementById('btn-private-exit').style.display = 'none';
                document.body.style.border = 'none';
            },

            kickUser: () => {
                if(App.selectedOpId && App.peers[App.selectedOpId]) {
                    App.peers[App.selectedOpId].conn.send({ type: 'KICK' });
                    delete App.peers[App.selectedOpId];
                    App.renderGrid();
                }
                document.getElementById('modal-operator').style.display = 'none';
            },

            logout: (force) => {
                if(force) alert("CONNEXION TERMIN√âE PAR L'H√îTE");
                location.reload();
            },

            togglePingMode: () => {
                App.pingMode = !App.pingMode;
                document.getElementById('btn-ping').classList.toggle('alert', App.pingMode);
                App.toast(App.pingMode ? "CLIQUEZ SUR LA CARTE" : "MODE PING D√âSACTIV√â");
            },

            sendPing: (ll) => {
                const msg = prompt("Message du PING:", "ENNEMI");
                if(msg) {
                    const p = { id: Date.now(), lat: ll.lat, lng: ll.lng, msg: msg, sender: App.user.callsign };
                    MapService.addPing(p);
                    NetService.broadcast({ type: 'PING', ping: p });
                    App.togglePingMode();
                }
            },

            copyID: () => { navigator.clipboard.writeText(App.user.id); App.toast("ID Copi√© dans le presse-papier"); },
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            }
        };

        window.onload = App.init;
    </script>
</body>
</html>
