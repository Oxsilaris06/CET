<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Communication Tactique & Tracking BFT">
    <title>COM TAC v4.0 // MIL-SPEC</title>
    
    <!-- FONTS: Lecture rapide et technique -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Chakra+Petch:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- ICONS: Material Symbols -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    <!-- MAP: Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- LIBS EXTERNES (Chargement CDN stable) -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- 1. DESIGN SYSTEM TACTIQUE --- */
        :root {
            /* Palette Sombre Tactique */
            --bg-body: #050505;
            --bg-surface: #121214;
            --bg-surface-active: #1e1e24;
            --border-dim: rgba(255, 255, 255, 0.1);
            
            /* Code Couleurs OTAN/Standard */
            --color-blue: #3b82f6;   /* Ami / Progression */
            --color-red: #ef4444;    /* Hostile / Contact */
            --color-green: #22c55e;  /* SÃ©curisÃ© / Clear */
            --color-yellow: #eab308; /* Attention / Appui */
            --color-text: #e0e0e0;
            --color-muted: #6b7280;
            
            /* UI Metrics */
            --font-ui: 'Chakra Petch', sans-serif;
            --font-data: 'JetBrains Mono', monospace;
            --radius-md: 12px;
            --radius-lg: 24px;
            --header-height: 60px;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; touch-action: manipulation; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg-body);
            color: var(--color-text);
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- 2. HEADER & NAVIGATION --- */
        header {
            height: var(--header-height);
            padding: 0 16px;
            background: rgba(5, 5, 5, 0.95);
            border-bottom: 1px solid var(--border-dim);
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .brand {
            font-weight: 700; font-size: 1.1rem; letter-spacing: 1px;
            display: flex; align-items: center; gap: 8px;
        }
        .brand span { color: var(--color-blue); }

        .header-actions { display: flex; gap: 10px; }

        .nav-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-dim);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .nav-btn.active { background: var(--color-blue); color: black; border-color: var(--color-blue); }
        .nav-btn.danger { color: var(--color-red); border-color: rgba(239, 68, 68, 0.3); }
        .nav-btn.danger:active { background: var(--color-red); color: white; }

        /* --- 3. GESTION DES VUES --- */
        .view-container {
            position: relative;
            flex: 1;
            width: 100%;
            overflow: hidden;
        }

        .view {
            position: absolute; inset: 0;
            background: var(--bg-body);
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.25s ease-in-out;
            z-index: 1;
        }
        .view.active { opacity: 1; pointer-events: all; z-index: 10; }

        /* --- 4. MAP & TRACKING (BFT) --- */
        #map-container { width: 100%; height: 100%; background: #111; }
        
        /* Personnalisation Leaflet */
        .leaflet-container { background: #0b0b0b; font-family: var(--font-data); }
        .leaflet-control-attribution { display: none; } /* Mode tactique Ã©purÃ© */

        /* Marqueurs Tactiques CSS */
        .tac-marker-wrapper { transition: transform 0.5s linear; will-change: transform; }
        .tac-arrow {
            width: 0; height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid var(--color-blue);
            filter: drop-shadow(0 0 4px var(--color-blue));
        }
        .tac-label {
            position: absolute; top: 24px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white;
            padding: 2px 6px; border-radius: 4px;
            font-family: var(--font-data); font-size: 10px; font-weight: bold;
            white-space: nowrap; border: 1px solid var(--color-blue);
        }

        /* Ã‰tats des marqueurs */
        .status-CONTACT .tac-arrow { border-bottom-color: var(--color-red); filter: drop-shadow(0 0 10px red); }
        .status-CONTACT .tac-label { border-color: var(--color-red); color: var(--color-red); }
        .status-CLEAR .tac-arrow { border-bottom-color: var(--color-green); }
        .status-APPUI .tac-arrow { border-bottom-color: var(--color-yellow); }

        /* --- 5. GRILLE OPÃ‰RATEURS (OPS) --- */
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 colonnes forcÃ©es mobile */
            gap: 12px;
            padding: 16px;
            padding-bottom: 200px; /* Espace pour le HUD */
            overflow-y: auto;
            align-content: start;
        }

        .op-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-dim);
            border-radius: var(--radius-md);
            padding: 12px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 110px;
            position: relative;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .op-card.is-me { background: var(--bg-surface-active); border-color: rgba(255,255,255,0.2); }
        
        /* Alertes Visuelles */
        @keyframes pulse-alert {
            0% { background: rgba(239, 68, 68, 0.1); border-color: var(--color-red); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { background: rgba(239, 68, 68, 0.25); border-color: var(--color-red); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { background: rgba(239, 68, 68, 0.1); border-color: var(--color-red); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .op-card[data-status="CONTACT"] { animation: pulse-alert 1.5s infinite; }

        .op-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .op-role { font-size: 0.65rem; font-weight: 700; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; color: #aaa; }
        .op-role.host { background: var(--color-yellow); color: black; }
        
        .op-callsign { font-family: var(--font-data); font-size: 1.1rem; font-weight: 800; color: white; letter-spacing: -0.5px; }
        .op-status-text { font-size: 0.8rem; font-weight: 600; letter-spacing: 1px; min-height: 1.2em; margin-top: 4px; }
        
        .op-footer { display: flex; align-items: center; gap: 8px; margin-top: auto; padding-top: 8px; font-size: 0.75rem; color: var(--color-muted); }
        
        /* Mini Visualizer */
        .op-viz { height: 4px; width: 100%; background: #222; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .op-viz-bar { height: 100%; width: 0%; background: var(--color-green); transition: width 0.1s linear; }

        /* --- 6. HUD DE COMMANDEMENT --- */
        .hud-wrapper {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: rgba(10, 10, 12, 0.95);
            backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-dim);
            border-radius: 24px 24px 0 0;
            padding: 15px 20px 30px 20px;
            z-index: 200;
            display: none; /* MasquÃ© par dÃ©faut */
            box-shadow: 0 -10px 40px rgba(0,0,0,0.6);
        }

        /* Status Quick Actions */
        .status-scroll {
            display: flex; gap: 8px; overflow-x: auto; 
            padding-bottom: 12px; margin-bottom: 10px;
            scrollbar-width: none; -ms-overflow-style: none;
        }
        .status-scroll::-webkit-scrollbar { display: none; }

        .status-chip {
            padding: 8px 16px; border-radius: 8px;
            font-size: 0.75rem; font-weight: 700; white-space: nowrap;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-dim);
            color: var(--color-muted); cursor: pointer; transition: all 0.2s;
        }
        /* Active States */
        .status-chip[data-val="PROGRESSION"].active { background: var(--color-blue); color: black; border-color: var(--color-blue); }
        .status-chip[data-val="CONTACT"].active { background: var(--color-red); color: white; border-color: var(--color-red); animation: blink 1s infinite; }
        .status-chip[data-val="CLEAR"].active { background: var(--color-green); color: black; border-color: var(--color-green); }
        .status-chip[data-val="APPUI"].active { background: var(--color-yellow); color: black; border-color: var(--color-yellow); }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* PTT Control Cluster */
        .ptt-cluster {
            display: flex; align-items: center; justify-content: center;
            position: relative; height: 90px;
        }

        #pttBtn {
            width: 80px; height: 80px;
            border-radius: 24px;
            background: #222; border: 2px solid #333;
            color: #666;
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        #pttBtn.active {
            transform: scale(0.95);
            background: var(--color-blue); color: white; border-color: white;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
        }
        #pttBtn.vox-mode { border-color: var(--color-green); color: var(--color-green); background: rgba(34, 197, 94, 0.1); }
        #pttBtn.vox-mode.active { background: var(--color-green); color: black; }

        .side-btn {
            position: absolute;
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            color: var(--color-muted); cursor: pointer;
        }
        .side-btn.left { left: 20px; }
        .side-btn.right { right: 20px; }

        .info-bar { text-align: center; font-size: 0.7rem; color: #555; margin-top: 5px; }

        /* --- 7. MENUS & INPUTS --- */
        .centered-layout {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; padding: 20px; text-align: center;
        }

        .hero-input {
            background: transparent; border: none; border-bottom: 2px solid #333;
            width: 100%; font-size: 2rem; font-family: var(--font-data);
            color: white; text-align: center; padding: 10px; margin: 30px 0;
            border-radius: 0;
        }
        
        .action-btn {
            width: 100%; padding: 18px; margin-bottom: 12px;
            background: var(--bg-surface); border: 1px solid var(--border-dim);
            border-radius: var(--radius-md); color: white;
            font-weight: 600; text-align: left;
            display: flex; align-items: center; gap: 15px; font-size: 1rem;
            cursor: pointer;
        }
        .action-btn:active { background: var(--bg-surface-active); border-color: var(--color-blue); }

        .join-row { display: flex; gap: 10px; width: 100%; margin-bottom: 20px; }
        .join-input {
            flex: 1; background: var(--bg-surface); border: 1px solid var(--border-dim);
            color: white; padding: 15px; border-radius: var(--radius-md);
            font-family: var(--font-data); font-size: 0.9rem;
        }

        /* --- 8. OVERLAYS (Scanner, QR, Toast) --- */
        .overlay {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .close-fab {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255,255,255,0.2); color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 5001;
        }

        #qr-target { background: white; padding: 20px; border-radius: 12px; }
        #reader { width: 100%; height: 100%; background: black; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1a1a1a; border: 1px solid var(--color-blue); color: var(--color-blue);
            padding: 10px 24px; border-radius: 30px; font-weight: 600; font-size: 0.85rem;
            z-index: 9999; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

    <!-- UI STRUCTURE -->
    <header>
        <div class="brand">
            <span class="material-symbols-outlined">satellite_alt</span> COM<span>TAC</span>
        </div>
        <div class="header-actions">
            <button class="nav-btn" id="mapToggleBtn" onclick="App.toggleMap()">
                <span class="material-symbols-outlined">map</span> CARTE
            </button>
            <button class="nav-btn danger" id="quitBtn" onclick="App.leaveSession(true)" style="display:none;">
                <span class="material-symbols-outlined">logout</span>
            </button>
        </div>
    </header>

    <div id="toast" class="toast">SystÃ¨me PrÃªt</div>

    <!-- SCANNER OVERLAY -->
    <div id="overlay-scanner" class="overlay">
        <div class="close-fab" onclick="QR.stopScanner()">âœ•</div>
        <div id="reader"></div>
        <div style="position: absolute; bottom: 50px; color: #aaa; font-size: 0.8rem; background: rgba(0,0,0,0.6); padding: 5px 12px; border-radius: 20px;">
            Visez le QR Code de l'hÃ´te
        </div>
    </div>

    <!-- QR GENERATOR OVERLAY -->
    <div id="overlay-qr" class="overlay" style="background: rgba(0,0,0,0.95);">
        <div class="close-fab" onclick="QR.hideGen()">âœ•</div>
        <div style="text-align: center;">
            <div id="qr-target"></div>
            <div style="margin-top: 20px; font-family: var(--font-data); color: var(--color-blue); font-size: 1.2rem;" id="qr-code-text">...</div>
            <p style="color: #666; font-size: 0.8rem;">ID SÃ‰CURISÃ‰</p>
        </div>
    </div>

    <!-- VIEW 1: LOGIN -->
    <div id="view-login" class="view active">
        <div class="centered-layout">
            <span class="material-symbols-outlined" style="font-size: 4rem; color: var(--color-blue); margin-bottom: 20px;">fingerprint</span>
            <h2 style="color:white; margin-bottom: 10px;">IDENTIFICATION</h2>
            <p style="color: var(--color-muted); font-size: 0.9rem;">Entrez votre indicatif opÃ©rationnel</p>
            
            <input type="text" id="callsignInput" class="hero-input" placeholder="CALLSIGN" maxlength="8" autocomplete="off">
            
            <button class="action-btn" onclick="App.login()" style="justify-content: center; background: var(--color-blue); border:none; margin-top: 20px;">
                CONNEXION
            </button>
        </div>
    </div>

    <!-- VIEW 2: MENU -->
    <div id="view-menu" class="view">
        <div class="centered-layout" style="justify-content: flex-start; padding-top: 40px;">
            <h3 style="color: var(--color-muted); width: 100%; text-align: left; margin-bottom: 20px;">DÃ‰PLOIEMENT</h3>
            
            <button class="action-btn" onclick="Comms.create()">
                <span class="material-symbols-outlined">add_circle</span>
                <div>
                    <div>CrÃ©er FrÃ©quence</div>
                    <div style="font-size: 0.7rem; color: var(--color-muted); font-weight: 400;">Devenir HÃ´te (Squad Leader)</div>
                </div>
            </button>
            
            <button class="action-btn" onclick="QR.startScanner()">
                <span class="material-symbols-outlined">qr_code_scanner</span>
                <div>
                    <div>Scanner QR</div>
                    <div style="font-size: 0.7rem; color: var(--color-muted); font-weight: 400;">Rejoindre via CamÃ©ra</div>
                </div>
            </button>

            <div style="width: 100%; margin-top: 30px; border-top: 1px solid var(--border-dim); padding-top: 20px;">
                <div style="text-align: left; color: var(--color-muted); font-size: 0.8rem; margin-bottom: 10px;">REJOINDRE MANUELLEMENT</div>
                <div class="join-row">
                    <input type="text" id="joinIdInput" class="join-input" placeholder="ID CANAL...">
                    <button onclick="navigator.clipboard.readText().then(t => document.getElementById('joinIdInput').value = t)" style="width: 50px; background: var(--bg-surface); border: 1px solid var(--border-dim); border-radius: var(--radius-md); color: white; cursor: pointer;">
                        <span class="material-symbols-outlined">content_paste</span>
                    </button>
                </div>
                <button class="action-btn" onclick="Comms.join()" style="justify-content: center; background: rgba(255,255,255,0.05);">
                    REJOINDRE
                </button>
            </div>
        </div>
    </div>

    <!-- VIEW 3: OPS (GRILLE) -->
    <div id="view-ops" class="view">
        <div id="usersGrid" class="grid-layout"></div>
    </div>

    <!-- VIEW 4: MAP (BFT) -->
    <div id="view-map" class="view">
        <div id="map-container"></div>
    </div>

    <!-- HUD TACTIQUE (Fixe en bas) -->
    <div id="hud" class="hud-wrapper">
        <!-- Status Bar -->
        <div class="status-scroll">
            <div class="status-chip" onclick="App.setStatus('PROGRESSION')" data-val="PROGRESSION">PROGRESSION</div>
            <div class="status-chip" onclick="App.setStatus('CONTACT')" data-val="CONTACT">CONTACT</div>
            <div class="status-chip" onclick="App.setStatus('CLEAR')" data-val="CLEAR">CLEAR</div>
            <div class="status-chip" onclick="App.setStatus('APPUI')" data-val="APPUI">EN APPUI</div>
        </div>

        <!-- Controls -->
        <div class="ptt-cluster">
            <div class="side-btn left" onclick="Audio.toggleVox()">
                <span class="material-symbols-outlined" id="voxIcon">mic_none</span>
            </div>
            
            <div id="pttBtn">
                <span class="material-symbols-outlined">mic</span>
            </div>
            
            <div class="side-btn right" onclick="QR.showGen()">
                <span class="material-symbols-outlined">qr_code_2</span>
            </div>
        </div>

        <div class="info-bar">
            <span id="freqDisplay" style="cursor: pointer;" onclick="App.copyID()">ID: ...</span> | <span id="gpsDisplay" onclick="Map.init()">GPS OFF</span>
        </div>
    </div>

    <!-- LOGIQUE JAVASCRIPT -->
    <script>
        /**
         * COMTAC v4.0 - MODULE JAVASCRIPT
         * Structure:
         * 1. DB (IndexedDB pour Maps Offline)
         * 2. App (Gestion UI, Session, Logique Globale)
         * 3. Audio (WebAudio, PTT, DSP)
         * 4. Map (Leaflet, GPS, Markers)
         * 5. Comms (PeerJS, Data Sync)
         * 6. QR (Scanner, Generator)
         */

        const CONF = {
            sessionKey: 'comtac_v4_session',
            peerConfig: { debug: 1 } // Utilisez un serveur STUN/TURN ici pour la prod
        };

        // --- 1. DATABASE (OFFLINE MAPS) ---
        const DB = {
            name: 'ComTac_DB_v4',
            store: 'tiles',
            db: null,
            init: async () => {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(DB.name, 1);
                    req.onupgradeneeded = e => e.target.result.createObjectStore(DB.store, { keyPath: 'key' });
                    req.onsuccess = e => { DB.db = e.target.result; resolve(); };
                    req.onerror = e => reject(e);
                });
            },
            putTile: (key, blob) => {
                if(!DB.db) return;
                const tx = DB.db.transaction(DB.store, 'readwrite');
                tx.objectStore(DB.store).put({ key, blob });
            },
            getTile: async (key) => {
                if(!DB.db) return null;
                return new Promise(resolve => {
                    const tx = DB.db.transaction(DB.store, 'readonly');
                    const req = tx.objectStore(DB.store).get(key);
                    req.onsuccess = () => resolve(req.result ? req.result.blob : null);
                    req.onerror = () => resolve(null);
                });
            }
        };

        // Custom Leaflet Layer for Caching
        const OfflineLayer = L.TileLayer.extend({
            createTile: function(coords, done) {
                const tile = document.createElement('img');
                const url = this.getTileUrl(coords);
                const key = `${coords.z}_${coords.x}_${coords.y}`;

                DB.getTile(key).then(blob => {
                    if (blob) {
                        // Cache Hit
                        tile.src = URL.createObjectURL(blob);
                        done(null, tile);
                    } else {
                        // Cache Miss -> Fetch
                        fetch(url).then(res => res.blob()).then(blob => {
                            DB.putTile(key, blob);
                            tile.src = URL.createObjectURL(blob);
                            done(null, tile);
                        }).catch(err => {
                            // Offline & No Cache -> Transparent fallback
                            tile.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                            done(null, tile);
                        });
                    }
                });
                return tile;
            }
        });

        // --- 2. APP CONTROLLER ---
        const App = {
            state: {
                me: { id: null, callsign: '', role: 'OPR', status: 'CLEAR', lat: 0, lng: 0, head: 0, bat: null, isTx: false },
                peers: {}, // { id: { data: UserData, conn: DataConn, call: MediaConn } }
                isHost: false,
                wakeLock: null
            },

            init: async () => {
                await DB.init();
                App.checkSession();
                App.initBattery();
                
                // PTT Listeners
                const btn = document.getElementById('pttBtn');
                const start = (e) => { if(e.cancelable) e.preventDefault(); Audio.tx(true); };
                const end = (e) => { if(e.cancelable) e.preventDefault(); Audio.tx(false); };
                
                btn.addEventListener('mousedown', start);
                btn.addEventListener('mouseup', end);
                btn.addEventListener('mouseleave', end);
                btn.addEventListener('touchstart', start);
                btn.addEventListener('touchend', end);
            },

            checkSession: () => {
                const saved = localStorage.getItem(CONF.sessionKey);
                if(saved) {
                    const s = JSON.parse(saved);
                    App.state.me.callsign = s.callsign;
                    if(s.freq) {
                        // Auto-reconnect flow
                        App.login(true).then(() => {
                            if(s.isHost) Comms.create(s.freq);
                            else Comms.join(s.freq);
                        });
                    } else {
                        document.getElementById('callsignInput').value = s.callsign;
                    }
                }
            },

            login: async (skipUI = false) => {
                if(!skipUI) {
                    const val = document.getElementById('callsignInput').value.trim().toUpperCase();
                    if(val.length < 2) return App.toast("Indicatif invalide", true);
                    App.state.me.callsign = val;
                }
                
                // Audio init requires user interaction
                const audioOk = await Audio.init();
                if(!audioOk && !skipUI) return;

                App.saveSession();
                App.switchView('view-menu');
                if('wakeLock' in navigator) navigator.wakeLock.request('screen').then(w => App.state.wakeLock = w);
            },

            saveSession: (freq = null) => {
                localStorage.setItem(CONF.sessionKey, JSON.stringify({
                    callsign: App.state.me.callsign,
                    freq: freq,
                    isHost: App.state.isHost
                }));
            },

            leaveSession: (full = false) => {
                if(Comms.peer) Comms.peer.destroy();
                if(full) {
                    localStorage.removeItem(CONF.sessionKey);
                    location.reload();
                }
            },

            switchView: (id) => {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                
                // HUD Visibility
                const hud = document.getElementById('hud');
                const quit = document.getElementById('quitBtn');
                
                if(id === 'view-ops' || id === 'view-map') {
                    hud.style.display = 'block';
                    quit.style.display = 'flex';
                } else {
                    hud.style.display = 'none';
                    quit.style.display = 'none';
                }

                // Map resize trigger
                if(id === 'view-map' && Map.instance) setTimeout(() => Map.instance.invalidateSize(), 200);
            },

            toggleMap: () => {
                const mapBtn = document.getElementById('mapToggleBtn');
                const isMap = document.getElementById('view-map').classList.contains('active');
                
                if(isMap) {
                    App.switchView('view-ops');
                    mapBtn.classList.remove('active');
                } else {
                    App.switchView('view-map');
                    mapBtn.classList.add('active');
                    if(!Map.instance) Map.init();
                }
            },

            setStatus: (status) => {
                App.state.me.status = status;
                
                // UI Update Local
                document.querySelectorAll('.status-chip').forEach(el => el.classList.remove('active'));
                const chip = document.querySelector(`.status-chip[data-val="${status}"]`);
                if(chip) chip.classList.add('active');
                
                Comms.broadcast();
                App.renderGrid();
                Map.updateUser(App.state.me.id, App.state.me);
            },

            renderGrid: () => {
                const grid = document.getElementById('usersGrid');
                grid.innerHTML = '';
                
                // Merge self + peers
                const all = [{...App.state.me, isMe: true}].concat(
                    Object.values(App.state.peers).map(p => p.data).filter(d => d)
                );

                all.forEach(u => {
                    const el = document.createElement('div');
                    el.className = `op-card ${u.isMe ? 'is-me' : ''}`;
                    if(u.status === 'CONTACT') el.setAttribute('data-status', 'CONTACT');
                    if(u.isTx) el.style.borderColor = 'var(--color-green)';

                    // Battery UI
                    let batHtml = '<span style="color:#444">N/A</span>';
                    if(u.bat !== null) {
                        let c = '#aaa';
                        if(u.bat < 30) c = 'var(--color-red)';
                        else if(u.bat < 60) c = 'var(--color-yellow)';
                        batHtml = `<span style="color:${c}">ðŸ”‹ ${u.bat}%</span>`;
                    }

                    // Status Color
                    let sColor = 'var(--color-text)';
                    if(u.status === 'CONTACT') sColor = 'var(--color-red)';
                    if(u.status === 'PROGRESSION') sColor = 'var(--color-blue)';
                    if(u.status === 'CLEAR') sColor = 'var(--color-green)';
                    if(u.status === 'APPUI') sColor = 'var(--color-yellow)';

                    el.innerHTML = `
                        <div class="op-header">
                            <span class="op-role ${u.role === 'HOST' ? 'host' : ''}">${u.role}</span>
                            ${u.isTx ? '<span class="material-symbols-outlined" style="color:var(--color-green); font-size:1rem;">graphic_eq</span>' : ''}
                        </div>
                        <div class="op-callsign">${u.callsign}</div>
                        <div class="op-status-text" style="color:${sColor}">${u.status}</div>
                        <div class="op-footer">
                            ${batHtml}
                        </div>
                        <div class="op-viz"><div class="op-viz-bar" style="width:${u.isTx ? '100%' : '0%'}"></div></div>
                    `;
                    grid.appendChild(el);
                });
            },

            initBattery: () => {
                if('getBattery' in navigator) {
                    navigator.getBattery().then(b => {
                        App.state.me.bat = Math.floor(b.level * 100);
                        b.addEventListener('levelchange', () => {
                            App.state.me.bat = Math.floor(b.level * 100);
                            Comms.broadcast();
                        });
                    });
                }
            },

            toast: (msg, err = false) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.borderColor = err ? 'var(--color-red)' : 'var(--color-blue)';
                t.style.color = err ? 'var(--color-red)' : 'var(--color-blue)';
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            },

            copyID: () => {
                if(App.state.me.id) {
                    navigator.clipboard.writeText(App.state.me.id);
                    App.toast("ID CopiÃ©");
                }
            }
        };

        // --- 3. AUDIO ENGINE ---
        const Audio = {
            ctx: null,
            stream: null,
            mode: 'ptt', // ptt | vox
            
            init: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: {
                        echoCancellation: true, noiseSuppression: true, autoGainControl: true
                    }});
                    Audio.stream = stream;
                    
                    // WebAudio Context for DSP
                    const Ctx = window.AudioContext || window.webkitAudioContext;
                    Audio.ctx = new Ctx();
                    
                    // Chain: Source -> Filter -> Compressor -> Dest
                    const src = Audio.ctx.createMediaStreamSource(stream);
                    const filter = Audio.ctx.createBiquadFilter(); 
                    filter.type = 'highpass'; filter.frequency.value = 300; // Radio effect
                    
                    const comp = Audio.ctx.createDynamicsCompressor();
                    comp.threshold.value = -20;
                    comp.knee.value = 40;
                    
                    const dst = Audio.ctx.createMediaStreamDestination();
                    
                    src.connect(filter);
                    filter.connect(comp);
                    comp.connect(dst);
                    
                    // Note: PeerJS sends the original stream usually, but we could send dst.stream
                    // For stability in v4 single file, we manipulate tracks of original stream
                    Audio.tx(false); // Mute initially
                    
                    // Headset Support
                    if('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({ title: 'ComTac', artist: 'Secure Link' });
                        navigator.mediaSession.setActionHandler('play', () => Audio.toggleHeadset());
                        navigator.mediaSession.setActionHandler('pause', () => Audio.toggleHeadset());
                    }

                    return true;
                } catch(e) {
                    console.error(e);
                    App.toast("Microphone Requis", true);
                    return false;
                }
            },

            tx: (active) => {
                if(Audio.mode === 'ptt' || (Audio.mode === 'vox' && active === true)) {
                    Audio.stream.getAudioTracks().forEach(t => t.enabled = active);
                    App.state.me.isTx = active;
                    
                    const btn = document.getElementById('pttBtn');
                    if(active) {
                        btn.classList.add('active');
                        if(navigator.vibrate) navigator.vibrate(30);
                    } else {
                        if(Audio.mode !== 'vox') btn.classList.remove('active');
                    }
                    
                    Comms.broadcast();
                    App.renderGrid();
                }
            },

            toggleVox: () => {
                Audio.mode = Audio.mode === 'ptt' ? 'vox' : 'ptt';
                const icon = document.getElementById('voxIcon');
                const btn = document.getElementById('pttBtn');
                
                if(Audio.mode === 'vox') {
                    icon.innerText = 'mic';
                    btn.classList.add('vox-mode');
                    Audio.tx(true); // Open mic
                } else {
                    icon.innerText = 'mic_none';
                    btn.classList.remove('vox-mode');
                    Audio.tx(false); // Close mic
                }
            },

            toggleHeadset: () => {
                if(Audio.mode === 'ptt') {
                    // Toggle logic for headset click
                    const newState = !App.state.me.isTx;
                    Audio.tx(newState);
                }
            },

            playRemote: (stream) => {
                const el = new Audio();
                el.srcObject = stream;
                el.play().catch(e => console.log("Autoplay block", e));
            }
        };

        // --- 4. MAP & GPS ---
        const Map = {
            instance: null,
            geoId: null,
            
            init: () => {
                Map.instance = L.map('map-container', { zoomControl: false }).setView([48.85, 2.35], 13);
                
                // Add Offline Layer
                // CartoDB Dark Matter (Public, simple, good contrast)
                new OfflineLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    subdomains: 'abcd', maxZoom: 19
                }).addTo(Map.instance);

                Map.startGPS();
            },

            startGPS: () => {
                if(!('geolocation' in navigator)) {
                    document.getElementById('gpsDisplay').innerText = "GPS N/A";
                    return;
                }

                const options = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };
                
                Map.geoId = navigator.geolocation.watchPosition(
                    pos => {
                        const { latitude, longitude, heading, accuracy } = pos.coords;
                        App.state.me.lat = latitude;
                        App.state.me.lng = longitude;
                        if(heading && !isNaN(heading)) App.state.me.head = heading;
                        
                        // Update UI
                        const gpsTxt = document.getElementById('gpsDisplay');
                        gpsTxt.innerText = `GPS Â±${Math.floor(accuracy)}m`;
                        gpsTxt.style.color = accuracy < 20 ? 'var(--color-green)' : 'var(--color-yellow)';

                        Map.updateUser(App.state.me.id, App.state.me);
                        Comms.broadcast();
                    },
                    err => {
                        console.warn("GPS Err", err);
                        const gpsTxt = document.getElementById('gpsDisplay');
                        gpsTxt.innerText = "GPS ERR";
                        gpsTxt.style.color = 'var(--color-red)';
                    },
                    options
                );
            },

            updateUser: (id, data) => {
                if(!Map.instance || !data.lat) return;
                
                // Logic to manage markers
                // Check if peer object exists in map context (attach to App.state.peers)
                // For self, we need a separate handle or check id
                
                let storage = (id === App.state.me.id) ? Map : App.state.peers[id];
                if(!storage) return;

                const iconHtml = `
                    <div class="tac-marker-wrapper status-${data.status}" style="transform: rotate(${data.head || 0}deg);">
                        <div class="tac-arrow"></div>
                    </div>
                    <div class="tac-label status-${data.status}">${data.callsign}</div>
                `;
                
                const icon = L.divIcon({ className: 'custom', html: iconHtml, iconSize: [40, 40], iconAnchor: [20, 20] });

                if(storage.marker) {
                    storage.marker.setLatLng([data.lat, data.lng]);
                    storage.marker.setIcon(icon);
                } else {
                    storage.marker = L.marker([data.lat, data.lng], { icon: icon }).addTo(Map.instance);
                }

                // Trail Logic (Breadcrumbs)
                if(!storage.trailPts) storage.trailPts = [];
                const last = storage.trailPts[storage.trailPts.length-1];
                
                // Add point if moved > 5m
                const moved = !last || Math.sqrt(Math.pow(last[0]-data.lat, 2) + Math.pow(last[1]-data.lng, 2)) > 0.00005;
                
                if(moved) {
                    storage.trailPts.push([data.lat, data.lng]);
                    if(storage.trailPts.length > 30) storage.trailPts.shift(); // Keep last 30
                    
                    if(storage.trail) {
                        storage.trail.setLatLngs(storage.trailPts);
                    } else {
                        const color = (id === App.state.me.id) ? '#3b82f6' : '#22c55e';
                        storage.trail = L.polyline(storage.trailPts, { color: color, weight: 2, dashArray: '4,8', opacity: 0.6 }).addTo(Map.instance);
                    }
                }
            }
        };

        // --- 5. COMMS (PEERJS) ---
        const Comms = {
            peer: null,
            
            initPeer: (id = null) => {
                const peer = new Peer(id, CONF.peerConfig);
                
                peer.on('open', pid => {
                    App.state.me.id = pid;
                    document.getElementById('freqDisplay').innerText = `ID: ${pid}`;
                    
                    if(App.state.isHost) {
                        App.state.me.role = 'HOST';
                        Comms.startHeartbeat();
                        App.renderGrid();
                    }
                    
                    App.saveSession(pid);
                    App.switchView('view-ops');
                });

                peer.on('connection', conn => Comms.handleConn(conn));
                peer.on('call', call => {
                    call.answer(Audio.stream);
                    call.on('stream', s => Audio.playRemote(s));
                });

                peer.on('error', err => {
                    console.error(err);
                    if(err.type === 'unavailable-id') {
                        // ID Taken (Ghost Host), generate new
                        if(App.state.isHost) {
                            Comms.peer.destroy();
                            Comms.initPeer(null); 
                        } else {
                            App.toast("FrÃ©quence indisponible", true);
                        }
                    } else {
                        App.toast("Erreur RÃ©seau", true);
                    }
                });

                peer.on('disconnected', () => peer.reconnect());
                return peer;
            },

            create: (restoreId = null) => {
                App.state.isHost = true;
                Comms.peer = Comms.initPeer(restoreId);
            },

            join: (id = null) => {
                if(!id) id = document.getElementById('joinIdInput').value.trim();
                if(!id) return App.toast("ID requis", true);
                
                App.state.isHost = false;
                Comms.peer = Comms.initPeer();
                
                // Connect Data
                const conn = Comms.peer.connect(id, { metadata: App.state.me });
                conn.on('open', () => {
                    Comms.handleConn(conn);
                    // Connect Audio
                    const call = Comms.peer.call(id, Audio.stream);
                    call.on('stream', s => Audio.playRemote(s));
                });
            },

            handleConn: (conn) => {
                conn.on('data', data => {
                    if(data.t === 'STATE') Comms.handleUpdate(data.p);
                    if(data.t === 'SYNC') data.l.forEach(u => Comms.handleUpdate(u));
                });

                conn.on('open', () => {
                    if(!App.state.peers[conn.peer]) App.state.peers[conn.peer] = {};
                    App.state.peers[conn.peer].conn = conn;
                    Comms.broadcast();
                });

                conn.on('close', () => {
                    delete App.state.peers[conn.peer];
                    App.renderGrid();
                });
            },

            broadcast: () => {
                const payload = { ...App.state.me };
                Object.values(App.state.peers).forEach(p => {
                    if(p.conn && p.conn.open) p.conn.send({ t: 'STATE', p: payload });
                });
                if(App.state.isHost) App.renderGrid();
            },

            handleUpdate: (user) => {
                if(user.id === App.state.me.id) return;
                
                if(!App.state.peers[user.id]) App.state.peers[user.id] = {};
                App.state.peers[user.id].data = user;
                
                App.renderGrid();
                Map.updateUser(user.id, user);
            },

            startHeartbeat: () => {
                setInterval(() => {
                    if(!App.state.isHost) return;
                    // Gather all users
                    const list = Object.values(App.state.peers).map(p => p.data).filter(d => d);
                    list.push(App.state.me);
                    // Broadcast Sync
                    Object.values(App.state.peers).forEach(p => {
                        if(p.conn && p.conn.open) p.conn.send({ t: 'SYNC', l: list });
                    });
                }, 2000);
            }
        };

        // --- 6. QR CODE ENGINE ---
        const QR = {
            scanner: null,
            
            showGen: () => {
                if(!App.state.me.id) return;
                const target = document.getElementById('qr-target');
                target.innerHTML = '';
                new QRCode(target, { text: App.state.me.id, width: 200, height: 200 });
                document.getElementById('qr-code-text').innerText = App.state.me.id;
                document.getElementById('overlay-qr').style.display = 'flex';
            },
            hideGen: () => {
                document.getElementById('overlay-qr').style.display = 'none';
            },

            startScanner: () => {
                const overlay = document.getElementById('overlay-scanner');
                overlay.style.display = 'flex';
                
                if(QR.scanner) { QR.stopScanner(); }
                
                QR.scanner = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                QR.scanner.start({ facingMode: "environment" }, config, 
                    decodedText => {
                        QR.stopScanner();
                        document.getElementById('joinIdInput').value = decodedText;
                        Comms.join(decodedText);
                        App.toast("QR Code ScannÃ©");
                    },
                    err => {
                        // Ignore frame errors
                    }
                ).catch(err => {
                    console.error(err);
                    QR.stopScanner();
                    App.toast("Erreur CamÃ©ra (HTTPS?)", true);
                });
            },

            stopScanner: () => {
                const overlay = document.getElementById('overlay-scanner');
                if(QR.scanner) {
                    QR.scanner.stop().then(() => {
                        QR.scanner.clear();
                        overlay.style.display = 'none';
                    }).catch(() => {
                        overlay.style.display = 'none';
                    });
                } else {
                    overlay.style.display = 'none';
                }
            }
        };

        // Init App on load
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>

