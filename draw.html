<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Designer Appartement - Mobile First</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/two.js/0.8.7/two.min.js"></script>
    <style>
        /* RESET MOBILE FIRST */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8f9fa;
            color: #1a1a1a;
            line-height: 1.5;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* CONTAINER PRINCIPAL */
        .mobile-container {
            max-width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER OPTIMIS√â MOBILE */
        .app-header {
            background: linear(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.25rem;
        }

        .app-header p {
            font-size: 0.9rem;
            text-align: center;
            opacity: 0.9;
        }

        /* BARRE D'OUTILS TOUCH-FRIENDLY */
        .toolbar-mobile {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 96px;
            z-index: 90;
        }

        .tool-btn-mobile {
            padding: 0.8rem 0.5rem;
            border: none;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            min-height: 60px;
            touch-action: manipulation;
        }

        .tool-btn-mobile:active {
            transform: scale(0.95);
            background: #f8f9fa;
        }

        .tool-btn-mobile.active {
            background: #007bff;
            color: white;
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .tool-icon {
            font-size: 1.2rem;
        }

        /* CANVAS OPTIMIS√â TACTILE */
        .canvas-mobile-container {
            flex: 1;
            background: white;
            margin: 0;
            padding: 1rem;
            position: relative;
            min-height: 50vh;
        }

        #drawing-area {
            width: 100%;
            height: 400px;
            background: #fafafa;
            border: 2px dashed #dee2e6;
            border-radius: 16px;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        /* INDICATEUR VISUEL POUR LE DESSIN */
        .drawing-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,123,255,0.1);
            color: #007bff;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drawing-indicator.show {
            opacity: 1;
        }

        /* PANEL PROPRI√âT√âS MOBILE */
        .properties-mobile {
            background: white;
            border-top: 2px solid #e9ecef;
            padding: 1.5rem 1rem;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            max-height: 70vh;
            overflow-y: auto;
        }

        .properties-mobile.open {
            transform: translateY(0);
        }

        .properties-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .close-panel {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* FORMULAIRES MOBILE */
        .form-group-mobile {
            margin-bottom: 1.2rem;
        }

        .form-group-mobile label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        .form-input-mobile {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.2s ease;
        }

        .form-input-mobile:focus {
            border-color: #007bff;
            outline: none;
        }

        /* LISTE DES PI√àCES MOBILE */
        .rooms-list-mobile {
            margin-top: 1.5rem;
        }

        .rooms-list-mobile h3 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .room-item-mobile {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 0.8rem;
            border-left: 4px solid #007bff;
        }

        .room-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .room-info small {
            color: #666;
            font-size: 0.8rem;
        }

        .room-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* BOUTONS PRIMAIRE MOBILE */
        .btn-primary-mobile {
            width: 100%;
            padding: 1rem;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .btn-primary-mobile:active {
            transform: scale(0.98);
            background: #0056b3;
        }

        /* OVERLAY PLEIN √âCRAN SUR MOBILE */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 2rem;
            color: white;
            text-align: center;
        }

        .overlay-content {
            background: white;
            color: #333;
            padding: 2rem;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
        }

        .overlay-content h2 {
            margin-bottom: 1rem;
            color: #007bff;
        }

        .overlay-content ol {
            text-align: left;
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .overlay-content li {
            margin-bottom: 0.8rem;
        }

        /* ANIMATIONS POUR LE MOBILE */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* MEDIA QUERIES POUR TABLETTE */
        @media (min-width: 768px) {
            html {
                font-size: 18px;
            }
            
            .toolbar-mobile {
                grid-template-columns: repeat(4, 1fr);
                gap: 1rem;
                padding: 1.5rem;
            }
            
            .tool-btn-mobile {
                padding: 1rem 0.5rem;
                font-size: 0.85rem;
                min-height: 70px;
            }
            
            #drawing-area {
                height: 500px;
            }
            
            .properties-mobile {
                max-width: 400px;
                right: 2rem;
                bottom: 2rem;
                left: auto;
                border-radius: 16px;
                border-top: none;
            }
        }

        /* MEDIA QUERIES POUR DESKTOP */
        @media (min-width: 1024px) {
            .mobile-container {
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .toolbar-mobile {
                grid-template-columns: repeat(4, 1fr);
                gap: 1.5rem;
                padding: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- HEADER MOBILE -->
        <header class="app-header">
            <h1>üè† Designer Appartement</h1>
            <p>Cr√©ez votre plan - Optimis√© mobile & tactile</p>
        </header>

        <!-- BARRE D'OUTILS TACTILE -->
        <div class="toolbar-mobile">
            <button class="tool-btn-mobile active" data-tool="draw">
                <span class="tool-icon">‚¨ú</span>
                <span>Dessiner</span>
            </button>
            <button class="tool-btn-mobile" data-tool="select">
                <span class="tool-icon">‚úã</span>
                <span>S√©lectionner</span>
            </button>
            <button class="tool-btn-mobile" data-tool="move">
                <span class="tool-icon">üì§</span>
                <span>D√©placer</span>
            </button>
            <button class="tool-btn-mobile" data-tool="delete">
                <span class="tool-icon">üóëÔ∏è</span>
                <span>Supprimer</span>
            </button>
        </div>

        <!-- ZONE DE DESSIN TACTILE -->
        <div class="canvas-mobile-container">
            <div id="drawing-area"></div>
            <div class="drawing-indicator" id="drawing-indicator">
                üëÜ Maintenez et glissez pour dessiner
            </div>
        </div>

        <!-- BOUTON POUR OUVRIR LES PROPRI√âT√âS -->
        <button class="btn-primary-mobile" id="open-properties">
            ‚öôÔ∏è Ouvrir les propri√©t√©s
        </button>

        <!-- PANEL PROPRI√âT√âS MOBILE -->
        <div class="properties-mobile" id="properties-panel">
            <div class="properties-header">
                <h3>üìê Propri√©t√©s</h3>
                <button class="close-panel" id="close-properties">√ó</button>
            </div>
            
            <div class="form-group-mobile">
                <label for="room-name-mobile">Nom de la pi√®ce:</label>
                <input type="text" id="room-name-mobile" class="form-input-mobile" placeholder="Salon, Chambre..." value="Salon">
            </div>
            
            <div class="form-group-mobile">
                <label for="room-color-mobile">Couleur:</label>
                <input type="color" id="room-color-mobile" class="form-input-mobile" value="#FFE4E1" style="height: 50px;">
            </div>

            <div class="form-group-mobile">
                <label for="room-width-mobile">Largeur (m):</label>
                <input type="number" id="room-width-mobile" class="form-input-mobile" value="4" min="1" step="0.1">
            </div>

            <div class="form-group-mobile">
                <label for="room-height-mobile">Longueur (m):</label>
                <input type="number" id="room-height-mobile" class="form-input-mobile" value="3" min="1" step="0.1">
            </div>

            <button class="btn-primary-mobile" id="apply-properties-mobile">
                üíæ Appliquer
            </button>

            <div class="rooms-list-mobile">
                <h3>üè† Vos pi√®ces</h3>
                <div id="rooms-container-mobile">
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Aucune pi√®ce cr√©√©e
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY D'INSTRUCTIONS AU PREMIER CHARGEMENT -->
    <div class="mobile-overlay" id="welcome-overlay">
        <div class="overlay-content">
            <h2>üëã Bienvenue !</h2>
            <p><strong>Comment dessiner sur mobile :</strong></p>
            <ol>
                <li>Appuyez sur <strong>"Dessiner"</strong></li>
                <li><strong>Maintenez appuy√©</strong> sur l'√©cran</li>
                <li><strong>Glissez</strong> pour former un rectangle</li>
                <li>Rel√¢chez pour cr√©er la pi√®ce</li>
            </ol>
            <p><small>üí° Conseil : Utilisez deux doigts pour zoomer/d√©zoomer</small></p>
            <button class="btn-primary-mobile pulse" id="start-drawing">
                Commencer √† dessiner !
            </button>
        </div>
    </div>

    <script>
        // √âchelle pour conversion m√®tres/pixels
        const SCALE = 50;
        
        // Variables d'√©tat
        let currentTool = 'draw';
        let selectedShape = null;
        let isDrawing = false;
        let startX, startY;
        let currentRect = null;
        let rooms = [];
        let roomCounter = 1;
        let two;

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            showWelcomeOverlay();
        });

        function initializeApp() {
            const drawingArea = document.getElementById('drawing-area');
            two = new Two({
                width: drawingArea.clientWidth,
                height: drawingArea.clientHeight,
                type: Two.Types.svg
            }).appendTo(drawingArea);

            // Ajustement responsive
            window.addEventListener('resize', function() {
                two.width = drawingArea.clientWidth;
                two.height = drawingArea.clientHeight;
                two.update();
            });
        }

        function setupEventListeners() {
            // Gestion des outils tactiles
            document.querySelectorAll('.tool-btn-mobile').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTool(this.dataset.tool);
                });
            });

            // Panel propri√©t√©s
            document.getElementById('open-properties').addEventListener('click', openPropertiesPanel);
            document.getElementById('close-properties').addEventListener('click', closePropertiesPanel);
            document.getElementById('apply-properties-mobile').addEventListener('click', applyProperties);

            // Overlay de bienvenue
            document.getElementById('start-drawing').addEventListener('click', hideWelcomeOverlay);

            // √âv√©nements tactiles pour le dessin
            const drawingArea = document.getElementById('drawing-area');
            
            // Touch events
            drawingArea.addEventListener('touchstart', handleTouchStart, { passive: false });
            drawingArea.addEventListener('touchmove', handleTouchMove, { passive: false });
            drawingArea.addEventListener('touchend', handleTouchEnd);

            // Mouse events pour compatibilit√©
            drawingArea.addEventListener('mousedown', handleMouseStart);
            drawingArea.addEventListener('mousemove', handleMouseMove);
            drawingArea.addEventListener('mouseup', handleMouseEnd);
        }

        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) { // Un seul doigt pour dessiner
                const touch = e.touches[0];
                const rect = drawingArea.getBoundingClientRect();
                startX = touch.clientX - rect.left;
                startY = touch.clientY - rect.top;
                
                if (currentTool === 'draw') {
                    startDrawing(startX, startY);
                } else {
                    handleSelection(startX, startY);
                }
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1 && isDrawing) {
                const touch = e.touches[0];
                const rect = drawingArea.getBoundingClientRect();
                const currentX = touch.clientX - rect.left;
                const currentY = touch.clientY - rect.top;
                
                updateDrawing(currentX, currentY);
            }
        }

        function handleTouchEnd(e) {
            if (isDrawing) {
                finishDrawing();
            }
        }

        function handleMouseStart(e) {
            const rect = drawingArea.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            
            if (currentTool === 'draw') {
                startDrawing(startX, startY);
            } else {
                handleSelection(startX, startY);
            }
        }

        function handleMouseMove(e) {
            if (isDrawing) {
                const rect = drawingArea.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                updateDrawing(currentX, currentY);
            }
        }

        function handleMouseEnd() {
            if (isDrawing) {
                finishDrawing();
            }
        }

        function startDrawing(x, y) {
            if (currentTool !== 'draw') return;

            isDrawing = true;
            startX = x;
            startY = y;
            
            // Afficher l'indicateur visuel
            const indicator = document.getElementById('drawing-indicator');
            indicator.classList.add('show');
            
            // Cr√©er le rectangle temporaire
            currentRect = two.makeRectangle(x, y, 1, 1);
            currentRect.fill = document.getElementById('room-color-mobile').value + '80';
            currentRect.stroke = '#333';
            currentRect.linewidth = 3;
            
            two.update();
        }

        function updateDrawing(currentX, currentY) {
            if (!isDrawing || !currentRect) return;

            const width = currentX - startX;
            const height = currentY - startY;
            
            currentRect.translation.x = startX + width / 2;
            currentRect.translation.y = startY + height / 2;
            currentRect.width = Math.abs(width);
            currentRect.height = Math.abs(height);
            
            two.update();
        }

        function finishDrawing() {
            if (!isDrawing || !currentRect) return;

            isDrawing = false;
            document.getElementById('drawing-indicator').classList.remove('show');

            // Validation taille minimale
            if (currentRect.width < 20 || currentRect.height < 20) {
                two.remove(currentRect);
                two.update();
                showToast('Pi√®ce trop petite !', 'error');
                return;
            }

            createRoomFromShape(currentRect);
            currentRect = null;
            openPropertiesPanel(); // Ouvrir automatiquement le panel
        }

        function createRoomFromShape(shape) {
            const roomName = document.getElementById('room-name-mobile').value || `Pi√®ce ${roomCounter++}`;
            const roomColor = document.getElementById('room-color-mobile').value;
            
            shape.fill = roomColor;
            
            // Ajouter le texte
            const text = two.makeText(roomName, shape.translation.x, shape.translation.y);
            text.size = 16;
            text.fill = '#1a1a1a';
            text.weight = 'bold';
            
            const roomData = {
                id: 'room_' + Date.now(),
                name: roomName,
                rect: shape,
                text: text,
                width: shape.width / SCALE,
                height: shape.height / SCALE,
                color: roomColor
            };
            
            shape.roomData = roomData;
            text.roomData = roomData;
            
            rooms.push(roomData);
            updateRoomList();
            showToast(`‚úÖ ${roomName} cr√©√©e !`);
        }

        function handleSelection(x, y) {
            // R√©initialiser s√©lection pr√©c√©dente
            if (selectedShape) {
                selectedShape.stroke = '#333';
                selectedShape.linewidth = 2;
            }

            selectedShape = null;

            // Chercher une forme sous le point
            two.scene.children.forEach(child => {
                if (child.roomData && isPointInShape(x, y, child)) {
                    selectedShape = child;
                }
            });

            if (selectedShape) {
                if (currentTool === 'delete') {
                    deleteSelectedShape();
                } else {
                    selectShapeForEditing();
                }
            }
        }

        function deleteSelectedShape() {
            const roomData = selectedShape.roomData;
            two.remove(roomData.rect);
            two.remove(roomData.text);
            rooms = rooms.filter(r => r.id !== roomData.id);
            updateRoomList();
            two.update();
            showToast(`üóëÔ∏è ${roomData.name} supprim√©e`);
            selectedShape = null;
        }

        function selectShapeForEditing() {
            selectedShape.stroke = '#007bff';
            selectedShape.linewidth = 4;
            two.update();
            
            const roomData = selectedShape.roomData;
            document.getElementById('room-name-mobile').value = roomData.name;
            document.getElementById('room-color-mobile').value = roomData.color;
            document.getElementById('room-width-mobile').value = roomData.width.toFixed(1);
            document.getElementById('room-height-mobile').value = roomData.height.toFixed(1);
            
            openPropertiesPanel();
        }

        function isPointInShape(x, y, shape) {
            if (shape.roomData) {
                const room = shape.roomData;
                const rect = room.rect;
                const halfWidth = rect.width / 2;
                const halfHeight = rect.height / 2;
                
                return x >= rect.translation.x - halfWidth &&
                       x <= rect.translation.x + halfWidth &&
                       y >= rect.translation.y - halfHeight &&
                       y <= rect.translation.y + halfHeight;
            }
            return false;
        }

        function switchTool(tool) {
            currentTool = tool;
            
            // Mise √† jour UI
            document.querySelectorAll('.tool-btn-mobile').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Feedback visuel
            const toolNames = {
                draw: 'Dessin',
                select: 'S√©lection',
                move: 'D√©placement',
                delete: 'Suppression'
            };
            
            showToast(`Mode ${toolNames[tool]} activ√©`);
        }

        function openPropertiesPanel() {
            document.getElementById('properties-panel').classList.add('open');
        }

        function closePropertiesPanel() {
            document.getElementById('properties-panel').classList.remove('open');
        }

        function applyProperties() {
            if (selectedShape && selectedShape.roomData) {
                const roomData = selectedShape.roomData;
                
                roomData.name = document.getElementById('room-name-mobile').value;
                roomData.text.value = roomData.name;
                
                const newWidth = parseFloat(document.getElementById('room-width-mobile').value) * SCALE;
                const newHeight = parseFloat(document.getElementById('room-height-mobile').value) * SCALE;
                
                roomData.rect.width = newWidth;
                roomData.rect.height = newHeight;
                roomData.width = newWidth / SCALE;
                roomData.height = newHeight / SCALE;
                
                roomData.rect.fill = document.getElementById('room-color-mobile').value;
                roomData.color = document.getElementById('room-color-mobile').value;
                
                two.update();
                updateRoomList();
                showToast('‚úÖ Modifications appliqu√©es');
            }
        }

        function updateRoomList() {
            const container = document.getElementById('rooms-container-mobile');
            
            if (rooms.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">Aucune pi√®ce cr√©√©e</div>';
                return;
            }
            
            container.innerHTML = rooms.map(room => `
                <div class="room-item-mobile" data-room-id="${room.id}">
                    <div class="room-info">
                        <h4>${room.name}</h4>
                        <small>${room.width.toFixed(1)}m √ó ${room.height.toFixed(1)}m</small>
                    </div>
                    <div class="room-color" style="background: ${room.color};"></div>
                </div>
            `).join('');
            
            // Rendre les pi√®ces cliquables
            container.querySelectorAll('.room-item-mobile').forEach((item, index) => {
                item.addEventListener('click', () => {
                    const room = rooms[index];
                    if (room && room.rect) {
                        if (selectedShape) {
                            selectedShape.stroke = '#333';
                            selectedShape.linewidth = 2;
                        }
                        selectedShape = room.rect;
                        selectShapeForEditing();
                    }
                });
            });
        }

        function showWelcomeOverlay() {
            document.getElementById('welcome-overlay').style.display = 'flex';
        }

        function hideWelcomeOverlay() {
            document.getElementById('welcome-overlay').style.display = 'none';
        }

        function showToast(message, type = 'success') {
            // Cr√©er un toast temporaire
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${type === 'error' ? '#dc3545' : '#28a745'};
                color: white;
                padding: 1rem 2rem;
                border-radius: 12px;
                font-weight: 600;
                z-index: 3000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // Emp√™cher le zoom avec deux doigts (optionnel)
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
    </script>
</body>
</html>
