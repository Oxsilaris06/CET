
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spectral Flow v6 - Ultra-Sync</title>
    <style>
        :root { --bg: #020617; --primary: #38bdf8; --success: #22c55e; --panel: #1e293b; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: #f1f5f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; }
        .card { background: var(--panel); border-radius: 20px; padding: 20px; border: 1px solid #334155; }
        #emitter-canvas { width: 100%; aspect-ratio: 1; background: #000; border-radius: 10px; margin-top: 15px; border: 2px solid #334155; image-rendering: pixelated; }
        .camera-box { position: relative; width: 100%; aspect-ratio: 1; border-radius: 10px; overflow: hidden; background: #000; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; }
        .guide { position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; border: 2px dashed rgba(255,255,255,0.2); pointer-events: none; display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); }
        .guide div { border: 0.1px solid rgba(255,255,255,0.05); }
        .status { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: bold; padding: 6px 12px; border-radius: 20px; background: #0f172a; width: fit-content; margin-bottom: 10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #475569; }
        .locked .dot { background: var(--success); box-shadow: 0 0 10px var(--success); }
        textarea { width: 100%; background: #020617; border: 1px solid #334155; color: var(--primary); border-radius: 8px; padding: 12px; font-family: monospace; box-sizing: border-box; }
        button { width: 100%; background: var(--primary); color: #020617; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .output { background: #020617; border-radius: 10px; padding: 15px; margin-top: 20px; border-left: 4px solid var(--success); min-height: 60px; font-family: monospace; font-size: 1.1rem; color: #fff; word-break: break-all; }
        .debug { font-size: 0.7rem; color: #64748b; margin-top: 10px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <h1 style="color: var(--primary); margin-bottom: 5px;">SPECTRAL <span style="font-weight: 300;">ULTRA-SYNC</span></h1>
    <p style="opacity: 0.5; margin-bottom: 25px;">V6 : Calibration par Header & Anti-Double Lecture</p>

    <div class="layout">
        <div class="card">
            <div class="status" id="eStatus"><div class="dot"></div> ÉMETTEUR PRÊT</div>
            <textarea id="msgInput">HELLO SPECTRAL V6</textarea>
            <button id="btnSend">TRANSMETTRE (SYNC ON)</button>
            <canvas id="emitter-canvas"></canvas>
        </div>

        <div class="card">
            <div class="status" id="rStatus"><div class="dot"></div> ATTENTE SIGNAL</div>
            <div class="camera-box">
                <video id="camera-feed" autoplay playsinline></video>
                <div class="guide" id="guideOverlay"></div>
            </div>
            <button id="btnCam" style="background: #475569; color: white;">ACTIVER RÉCEPTION</button>
            <div class="output" id="outMsg">---</div>
            <div class="debug">
                <span id="dbSync">Sync: Non</span>
                <span id="dbFreq">Freq: -- ms</span>
            </div>
        </div>
    </div>

<script>
    const GRID = 8;
    const HEADER = "10101010"; // Première ligne de calibration
    const FRAME_TIME = 200; // Plus lent pour la stabilité
    
    const eCanvas = document.getElementById('emitter-canvas');
    const eCtx = eCanvas.getContext('2d');
    const outMsg = document.getElementById('outMsg');
    const dbSync = document.getElementById('dbSync');

    let toggle = false;

    // --- EMETTEUR ---
    eCanvas.width = 400;
    eCanvas.height = 400;

    const draw = (data) => {
        const size = 400;
        const cellSize = size / GRID;
        eCtx.fillStyle = "black";
        eCtx.fillRect(0,0,size,size);

        // On dessine le motif de données
        for (let i = 0; i < GRID * GRID; i++) {
            const x = i % GRID;
            const y = Math.floor(i / GRID);
            let bit = data[i] || '0';
            
            // Forcer la première ligne (Header)
            if (y === 0) bit = HEADER[x];
            // Forcer le premier bit de la seconde ligne (Toggle bit)
            if (x === 0 && y === 1) bit = toggle ? "1" : "0";

            eCtx.fillStyle = bit === "1" ? "#FFFFFF" : "#0A0A0A";
            eCtx.fillRect(x * cellSize + 2, y * cellSize + 2, cellSize - 4, cellSize - 4);
        }
    };

    document.getElementById('btnSend').onclick = () => {
        const bin = document.getElementById('msgInput').value.split('').map(c => c.charCodeAt(0).toString(2).padStart(8, '0')).join('');
        // On ne peut envoyer que 55 bits de data par frame (64 - 8 header - 1 toggle)
        const DATA_PER_FRAME = 55;
        let packets = [];
        for (let i = 0; i < bin.length; i += DATA_PER_FRAME) {
            packets.push(bin.substring(i, i + DATA_PER_FRAME).padEnd(DATA_PER_FRAME, '0'));
        }

        let idx = 0;
        const timer = setInterval(() => {
            if (idx >= packets.length) {
                clearInterval(timer);
                draw("0".repeat(64));
                return;
            }
            toggle = !toggle; // Change à chaque frame
            // Reconstruit la frame : Header(8) + Toggle(1) + Data(55)
            const frameData = HEADER + (toggle ? "1" : "0") + packets[idx];
            draw(frameData);
            idx++;
        }, FRAME_TIME);
    };
    draw("0".repeat(64));

    // --- RÉCEPTEUR ---
    const video = document.getElementById('camera-feed');
    let active = false;
    document.getElementById('btnCam').onclick = async () => {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = s;
        active = true;
        loop();
    };

    const loop = () => {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d', { willReadFrequently: true });
        c.width = 80; c.height = 80;

        let lastToggle = null;
        let fullBin = "";

        const run = () => {
            if(!active) return;
            // Crop centre 60%
            ctx.drawImage(video, video.videoWidth*0.2, video.videoHeight*0.2, video.videoWidth*0.6, video.videoHeight*0.6, 0, 0, 80, 80);
            const img = ctx.getImageData(0,0,80,80).data;

            let frameBits = "";
            let maxB = 0, minB = 255;

            // 1. Analyse de grille
            for (let y = 0; y < GRID; y++) {
                for (let x = 0; x < GRID; x++) {
                    const px = x * 10 + 5; // Centre de la cellule
                    const py = y * 10 + 5;
                    const idx = (py * 80 + px) * 4;
                    const b = (img[idx] + img[idx+1] + img[idx+2]) / 3;
                    if(b > maxB) maxB = b; if(b < minB) minB = b;
                    frameBits += b > 130 ? "1" : "0"; // Seuil fixe mais avec header check
                }
            }

            // 2. Validation par Header
            const detectedHeader = frameBits.substring(0, 8);
            if (detectedHeader === HEADER) {
                dbSync.innerText = "Sync: OUI";
                document.getElementById('rStatus').classList.add('locked');
                
                const currentToggle = frameBits[8];
                if (currentToggle !== lastToggle) {
                    // Nouveau paquet !
                    const dataPart = frameBits.substring(9);
                    fullBin += dataPart;
                    lastToggle = currentToggle;
                    decode(fullBin);
                }
            } else {
                dbSync.innerText = "Sync: NON";
                document.getElementById('rStatus').classList.remove('locked');
            }

            requestAnimationFrame(run);
        };
        run();
    };

    const decode = (bin) => {
        let txt = "";
        for (let i = 0; i < bin.length; i += 8) {
            const byte = bin.substring(i, i + 8);
            if(byte.length === 8) {
                const char = String.fromCharCode(parseInt(byte, 2));
                // Filtrer les caractères valides
                if (/[ -~]/.test(char)) txt += char;
            }
        }
        outMsg.innerText = txt || "---";
    };

    // Guide visuel
    const g = document.getElementById('guideOverlay');
    for(let i=0; i<64; i++) g.appendChild(document.createElement('div'));
</script>
</body>
</html>

