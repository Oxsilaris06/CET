<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TACTICAL QR OPS</title>
    
    <!-- Fonts identiques à check.html -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Oswald:wght@300;400;500&family=Saira+Stencil+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    
    <!-- QR Code Generator Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- QR Code Scanner Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        /* --- THEME TACTICAL GLASS (Strict Check.html match) --- */
        :root {
            --bg-body: #050505;
            --bg-container: rgba(20, 25, 30, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --primary-accent: #00e5ff; /* Cyan plus vif */
            --text-main: #e0e0e0;
            --text-muted: #888;
            --success: #00ff41;
            --danger: #ff3333;
            --font-main: 'JetBrains Mono', monospace;
            --font-header: 'Saira Stencil One', cursive;
            --font-ui: 'Oswald', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 229, 255, 0.03) 0%, transparent 50%),
                linear-gradient(0deg, rgba(0,0,0,0.8) 0%, transparent 100%),
                linear-gradient(rgba(0, 229, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 229, 255, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            font-family: var(--font-main);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        /* --- UI FRAME --- */
        .tactical-frame {
            width: 100%;
            max-width: 650px;
            background: var(--bg-container);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: var(--glass-border);
            border-radius: 8px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }

        /* Scanlines Effect */
        .tactical-frame::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            z-index: 1;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Top Border Accent */
        .tactical-frame::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-accent), transparent);
            box-shadow: 0 0 10px var(--primary-accent);
        }

        /* --- HEADER --- */
        header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 229, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 10, 15, 0.6);
            position: relative;
            z-index: 2;
        }

        h1 {
            font-family: var(--font-header);
            font-size: 1.5rem;
            color: var(--primary-accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(0, 229, 255, 0.5);
            margin: 0;
        }

        /* --- TABS --- */
        .tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            background: rgba(0,0,0,0.2);
            z-index: 2;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .tab-btn:hover {
            color: var(--text-main);
            background: rgba(255,255,255,0.02);
        }

        .tab-btn.active {
            color: var(--primary-accent);
            background: rgba(0, 229, 255, 0.05);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 2px;
            background: var(--primary-accent);
            box-shadow: 0 0 8px var(--primary-accent);
        }

        /* --- CONTENT AREA --- */
        .content-area {
            padding: 20px;
            min-height: 450px;
            position: relative;
            z-index: 2;
        }

        .section {
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .section.active {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- INPUTS & BUTTONS --- */
        label {
            font-family: var(--font-ui);
            color: var(--primary-accent);
            font-size: 0.9rem;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 5px;
        }

        textarea {
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 229, 255, 0.2);
            color: var(--text-main);
            font-family: var(--font-main);
            font-size: 0.8rem;
            padding: 12px;
            resize: vertical;
            outline: none;
            border-radius: 2px;
            transition: border-color 0.3s;
        }

        textarea:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.1);
        }

        .btn {
            background: rgba(0, 229, 255, 0.05);
            border: 1px solid var(--primary-accent);
            color: var(--primary-accent);
            padding: 14px 20px;
            font-family: var(--font-ui);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            font-size: 1rem;
        }

        .btn:hover {
            background: var(--primary-accent);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
            background: rgba(255, 51, 51, 0.05);
        }
        .btn-danger:hover {
            background: var(--danger);
            color: white;
            box-shadow: 0 0 15px rgba(255, 51, 51, 0.4);
        }

        /* --- QR DISPLAY --- */
        #qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 25px;
            background: white; 
            border-radius: 4px;
            margin-top: 15px;
            align-self: center;
            opacity: 0.9;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            /* Ensure QR doesn't overflow visually */
            max-width: 100%;
            overflow: hidden;
        }

        #qrcode img {
            max-width: 100%;
            height: auto;
        }

        /* --- SCANNER --- */
        #reader {
            width: 100%;
            border: 1px solid rgba(0, 229, 255, 0.3);
            background: #000;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        /* Override HTML5-QRCode default styles */
        #reader__scan_region {
            background: rgba(0, 255, 65, 0.1) !important;
        }
        
        .scan-result-box {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--success);
            border-left: 4px solid var(--success);
            padding: 15px;
            font-family: var(--font-main);
            font-size: 0.85rem;
            color: var(--text-main);
            word-break: break-all;
            display: none;
            position: relative;
            margin-top: 15px;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.1);
        }

        .scan-result-box.visible {
            display: block;
            animation: fadeIn 0.3s;
        }

        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            border: none;
            color: var(--success);
            cursor: pointer;
            opacity: 0.7;
            padding: 5px;
        }
        .copy-btn:hover { opacity: 1; transform: scale(1.1); }

        .status-line {
            font-family: var(--font-main);
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            margin-top: 10px;
            text-transform: uppercase;
        }

        /* --- FOOTER --- */
        .system-footer {
            margin-top: 20px;
            text-align: center;
            font-family: var(--font-main);
            font-size: 0.65rem;
            color: rgba(0, 229, 255, 0.3);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- INFO BAR --- */
        .info-bar {
            background: rgba(0, 229, 255, 0.05);
            border-left: 2px solid var(--primary-accent);
            padding: 10px;
            font-size: 0.8rem;
            color: var(--primary-accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

    </style>
</head>
<body>

    <div class="tactical-frame">
        <header>
            <h1><span class="material-symbols-outlined" style="vertical-align: middle; font-size: 1.8rem;">qr_code_scanner</span> TACTICAL OPS</h1>
            <div style="font-family: var(--font-ui); font-size: 0.8rem; color: var(--success); display:flex; align-items:center; gap:5px;">
                <span style="width:8px; height:8px; background:var(--success); border-radius:50%; box-shadow:0 0 5px var(--success);"></span>
                ONLINE
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('generator')">GÉNÉRATEUR</button>
            <button class="tab-btn" onclick="switchTab('scanner')">SCANNER</button>
        </nav>

        <div class="content-area">
            
            <!-- SECTION GÉNÉRATEUR -->
            <div id="generator" class="section active">
                <div class="info-bar">
                    <span class="material-symbols-outlined" style="font-size:1.2rem;">info</span>
                    Le JSON sera automatiquement compressé (minifié) pour tenir dans le QR Code.
                </div>

                <label>DONNÉES VÉHICULE (JSON):</label>
                <textarea id="jsonInput" placeholder="Collez le JSON ici...">{
  "vehicule": "SHARAN (BANA)",
  "inventaire": {
    "Sac Médical Rouge": [
      "4 garrot tourniquet (sv)",
      "2 lunettes protection",
      "4 bandage Israëlien",
      "1 marqueur",
      "1 Pansement",
      "2 Easy ice",
      "8 lot gants vinyle",
      "2 Écharpe triangulaire",
      "1 Jesco",
      "1 Scotch 3M",
      "3 Bande extensible 3M",
      "9 Sérum phy",
      "1 Quikclot",
      "2 Pansement brûlures",
      "2 Cyalumes rouges",
      "3 pack de gaze (3 côtés)",
      "1 chlorhexidine",
      "1 Savon liquide",
      "(Brancard souple)"
    ],
    "Dossier Molle": [
      "Dépistage stup",
      "Lacry",
      "Jumelles",
      "Embout alcoo",
      "Ethylo + chargeur 12V",
      "Cahier PJ (fiche doc terrain + forcené)",
      "Rubalise",
      "1 Batteries externes CROSSCALL"
    ],
    "Sac Oscar": [
      "Sac MILTEC Wasp",
      "Tarp Woodland",
      "Jumelles 10x50",
      "Sécateur",
      "Pince coupante",
      "Filet de masquage",
      "Carnet imperméable",
      "Ghillie"
    ],
    "Lot Reco": [
      "Tenue Métropole",
      "Gilet Jaune Shneider Electric"
    ],
    "Lot INDIA": [
      "Bouclier balistique + Housse",
      "Claie de portage avec sangles",
      "Lampe BBAL",
      "Batterie BBAL",
      "Bouton bluetooth modifié BBAL"
    ],
    "DIVERS": [
      "1 Echelle télescopique",
      "Triangle",
      "Extincteur",
      "Kit forcené (feuilles)",
      "Rubalise",
      "TIS",
      "Tricoise",
      "Couverture anti feu"
    ],
    "INTERCEPTION": [
      "1 Kit stop stick avec housse"
    ]
  }
}</textarea>
                
                <button class="btn" onclick="generateQR()">
                    <span class="material-symbols-outlined">qr_code_2</span> GÉNÉRER (OPTIMISÉ)
                </button>

                <div id="qrcode-container">
                    <div id="qrcode"></div>
                </div>
                <div class="status-line" id="genStatus">EN ATTENTE D'ENTRÉE DONNÉES...</div>
            </div>

            <!-- SECTION SCANNER -->
            <div id="scanner" class="section">
                <div id="reader"></div>
                
                <div id="scanControls" style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="startScanBtn" class="btn" style="flex:1;" onclick="startScanner()">
                        <span class="material-symbols-outlined">videocam</span> ACTIVER CAMÉRA
                    </button>
                    <button id="stopScanBtn" class="btn btn-danger" style="flex:1; display:none;" onclick="stopScanner()">
                        <span class="material-symbols-outlined">videocam_off</span> ARRÊTER
                    </button>
                </div>

                <div id="scanResult" class="scan-result-box">
                    <button class="copy-btn" onclick="copyResult()" title="Copier">
                        <span class="material-symbols-outlined">content_copy</span>
                    </button>
                    <span style="display:block; font-size:0.7rem; color:var(--primary-accent); margin-bottom:5px; text-transform:uppercase;">Données récupérées:</span>
                    <div id="resultText"></div>
                </div>
            </div>

        </div>
    </div>

    <div class="system-footer">
        SYS.CORE.VER.3.1 // SECURE // TACTICAL GLASS UI
    </div>

    <script>
        // --- TABS LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

            document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'generator' && html5QrCode && html5QrCode.isScanning) {
                stopScanner();
            }
        }

        // --- GENERATOR LOGIC (OPTIMISÉ) ---
        let qrcodeObj = null;

        function generateQR() {
            const rawInput = document.getElementById('jsonInput').value;
            const container = document.getElementById('qrcode');
            const statusLine = document.getElementById('genStatus');
            
            container.innerHTML = "";

            if (!rawInput.trim()) {
                alert("Veuillez entrer des données JSON.");
                return;
            }

            // OPTIMISATION : Minification du JSON (suppression espaces/sauts de ligne)
            let optimizedData = rawInput;
            try {
                // Tenter de parser le JSON pour le re-stringifier proprement (minification)
                const jsonObject = JSON.parse(rawInput);
                optimizedData = JSON.stringify(jsonObject);
                console.log(`Taille originale: ${rawInput.length}, Taille optimisée: ${optimizedData.length}`);
            } catch (e) {
                console.warn("JSON invalide ou texte simple. Utilisation du texte brut mais nettoyé.");
                // Si ce n'est pas du JSON valide, on supprime juste les sauts de ligne multiples
                optimizedData = rawInput.replace(/\s+/g, ' ').trim();
            }

            // Génération avec Niveau de correction BAS (L) pour maximiser la capacité
            try {
                qrcodeObj = new QRCode(container, {
                    text: optimizedData,
                    width: 300,
                    height: 300,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L // L = Low (7%) permet le max de données
                });
                
                statusLine.innerHTML = `<span style="color:var(--success)">ENCODAGE TERMINÉ // TAILLE: ${optimizedData.length} chars</span>`;
                
            } catch (e) {
                console.error(e);
                statusLine.innerHTML = `<span style="color:var(--danger)">ERREUR: DONNÉES TROP VOLUMINEUSES (${optimizedData.length} chars)</span>`;
                alert("Erreur: Même après optimisation, le texte est trop long pour un seul QR Code. Essayez de réduire le contenu.");
            }
        }

        // --- SCANNER LOGIC ---
        let html5QrCode = null;

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`, decodedResult);
            
            const resultBox = document.getElementById('scanResult');
            const resultText = document.getElementById('resultText');
            
            // Affichage propre (si JSON, on peut le formater pour la lecture humaine si besoin, 
            // mais on garde le brut pour la copie)
            resultText.innerText = decodedText;
            resultBox.classList.add('visible');
            
            stopScanner(); 
            
            const startBtn = document.getElementById('startScanBtn');
            startBtn.innerHTML = '<span class="material-symbols-outlined">check_circle</span> SUCCÈS';
            startBtn.style.color = 'var(--success)';
            startBtn.style.borderColor = 'var(--success)';
            
            setTimeout(() => {
                if(!html5QrCode.isScanning) {
                    startBtn.innerHTML = '<span class="material-symbols-outlined">videocam</span> ACTIVER CAMÉRA';
                    startBtn.style.color = '';
                    startBtn.style.borderColor = '';
                }
            }, 3000);
        }

        function onScanFailure(error) {
            // Ignorer les erreurs de frame vide
        }

        function startScanner() {
            const resultBox = document.getElementById('scanResult');
            resultBox.classList.remove('visible');
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .then(() => {
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-flex';
            })
            .catch(err => {
                console.error("Error starting scanner", err);
                alert("Erreur accès caméra (vérifiez les permissions HTTPS): " + err);
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    document.getElementById('startScanBtn').style.display = 'inline-flex';
                    document.getElementById('stopScanBtn').style.display = 'none';
                    document.getElementById('reader').innerHTML = ""; 
                }).catch((err) => {
                    console.error("Stop failed", err);
                });
            }
        }

        function copyResult() {
            const text = document.getElementById('resultText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalColor = btn.style.color;
                btn.style.color = 'var(--text-main)';
                setTimeout(() => btn.style.color = originalColor, 500);
            }, () => {
                alert("Erreur copie.");
            });
        }
    </script>
</body>
</html>
